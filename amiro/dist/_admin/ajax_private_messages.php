<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       5823 xkqwtrkywzxxqkxzznuuqgtuwqmwinullimtunqupwpinzxzywyimqkyrnwlpknlkkmspnir
 */ ?><?php foreach(array(20129=>'DMnPJQ',20130=>"dqjqwT?UNmX|TmiqdTzig}SZtQ|IHSMfMQS{?zd?JZDt|WOQWK|tD?FRhi?WID|HGtMHnD?coqRq?IHSuJQ|nZIQ?=?'GrMvZtQ|IQDDZPQD'?zNs?nZIQ?=?'JZDt|YrHZSWZDt|IQDDZPQ|tD'?hRsqR?yb?MS?sqdw?jmimT?1",20131=>'ru',20132=>"dqjqwT?vZJuQ?FRhi?WID|HGtMHnD?coqRq?IHSuJQ|nZIQ?=?'GrMvZtQ|IQDDZPQD'?zNs?nZIQ?=?'JZDt|YrHZSWZDt|IQDDZPQ|tD'?hRsqR?yb?MS?sqdw?jmimT?1",20133=>"dqjqwT?UNmX|TmiqdTzig}SZtQ|IHSMfMQS{?zd?MnDtZJJ|tMIQ?FRhi?WID|HGtMHnD?coqRq?IHSuJQ|nZIQ?=?'WID'?zNs?nZIQ?=?'SY|vQrDMHn'?hRsqR?yb?SZtQ|IHSMfMQS?sqdw?jmimT?1",20134=>'MnDtZJJ|tMIQ',20135=>'DQrvMWQ',20136=>'1`1',20137=>'tMIQDtZIG',20138=>"'!?'",20139=>"sqjqTq?FRhi?WID|HGtMHnD?coqRq?IHSuJQ|nZIQ?=?'GrMvZtQ|IQDDZPQD'?zNs?nZIQ?=?'JZDt|YrHZSWZDt|IQDDZPQ|tD'",20140=>"mNdqRT?mNTh?WID|HGtMHnD?}IHSuJQ|nZIQ!?nZIQ!?vZJuQ!?SZtQ|IHSMfMQS!?YMP|vZJuQ{?VzjUqd?}'GrMvZtQ|IQDDZPQD'!?'JZDt|YrHZSWZDt|IQDDZPQ|tD'!?'",20141=>"'!?Nhc}{!?''{") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} $l1IIlL1 =-2; $oSess =admSession(); $userId =intval($oSess->Data['user']['id']); if($userId){ $l1IIlL1 =0; if($oSess->hostMode == I20129){ $l1IILlI =0; $db->query(I20130); if($record =$db->nextRecord()){ $l1IILlI =$record['last_check_ts']; }}if(($oSess->hostMode == I20129) && ($l1IILlI +15*60 <time()) && (mt_rand(0, mt_getrandmax()) <0.15 *mt_getrandmax())){ require_once $HOST_PATH .'_shared/code/const/init_simple.php'; $lang =isset($_GET['lang']) ?$_GET['lang'] :I20131; $l1IILll =0; $db->query(I20132); if($record =$db->nextRecord()){ $l1IILll =$record['value']; }if(!$l1IILll){ $db->query(I20133); if($record =$db->nextRecord()){ $l1IILll =$record[I20134]; }}$oHTTPRequest =new AMI_HTTPRequest( array( 'returnHeaders' => false, 'followLocation' => false ));$l1IILlL =mt_rand(0, mt_getrandmax()); $res =$oHTTPRequest->send( 'http://amiro.ru/ami_service.php', array( I20135 => 'private_messages', 'action' => 'get_local_sites_messages', 'ver' => I20136, 'cms' => $GLOBALS['CMS_VERSION'], 'domain' => $oSess->TlIT11I(), 'last_request' => $l1IILll, I20137 => time(), 'lang' => $lang, 'rnd1' => $l1IILlL, 'rnd2' => md5($l1IILlL .'nS7elJs32sd') ));if(!empty($res)){ $l1IILl1 =json_decode($res, true); if(is_array($l1IILl1) && sizeof($l1IILl1)){ $db->query("SELECT `id_member` FROM `cms_host_users` WHERE `sys_user` = 1 LIMIT 1"); if($record =$db->nextRecord()){ $sysUserId =intval($record['id_member']); }if($sysUserId){ $l1IILll =0; foreach($l1IILl1 as $aMessage){ $sql ="INSERT INTO cms_private_message_bodies (body) VALUES ('" .mysql_real_escape_string($aMessage['body']) ."')"; if($db->query($sql)){ $bodyId =intval(mysql_insert_id($db->_dbLink)); $db->query("INSERT INTO cms_private_messages (id_owner, id_sender, id_recipient, date_created, header, id_body, is_broadcast) VALUES ('" .$sysUserId ."', '" .$sysUserId ."', '" .$sysUserId ."', '" .mysql_real_escape_string($aMessage['date_created']) .I20138 .mysql_real_escape_string($aMessage['header']) .I20138 .$bodyId ."', '1')"); if($aMessage['date_created_ts'] >$l1IILll){ $l1IILll =$aMessage['date_created_ts']; }}}if($l1IILll){ $db->query(I20139); $db->query(I20140 .mysql_real_escape_string($l1IILll) .I20141); }}}}else{ $db->query(I20139); $db->query(I20140 .mysql_real_escape_string($l1IILll) .I20141); }}$db->query("SELECT COUNT(id) AS messages_num FROM cms_private_messages WHERE id_owner = '".$userId."' AND id_owner = id_recipient AND is_deleted = 0 AND is_read = 0"); if($record =$db->nextRecord()){ $l1IIlL1 =intval($record['messages_num']); }}