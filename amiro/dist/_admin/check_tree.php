<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       10088 xkqwlkgkxnrqlsyuqglwgxnslnrlsxxxlgtmmqggzmzwqzgmitnpkxzrsuugtqkxuktwpnir
 */ ?><?php foreach(array(20228=>"dqjqwT?MS?FRhi?",20229=>"MS",20230=>"'?zNs?JZnP='",20231=>'WI|MnM`GOG',20232=>"KY",20233=>"Менеджер?сайта",20234=>"WID|QD|WZtD",20235=>"nZIQ",20236=>"WID|GZPQD",20237=>"MnDtZJJQS|JZnPD",20238=>"vQr",20239=>"KY|WZt",20240=>"GIZnZPQr",20241=>"GZPQD",20242=>"nuI",20243=>"dqjqwT?MS!?",20244=>"`#~Y@#~fHnt@",20245=>"?coqRq?MS='",20246=>"{#Yr@",20247=>"#fHnt?WHJHr=rQS@") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} function ___creareTree($pid, $level =0) {global $l1IlILl, $table, $idParent, $currentLang, $maxLevel; $level++; $maxLevel =max($maxLevel, $level); $sql =I20228.$table." WHERE ".$idParent."='".$pid."' AND lang='".$currentLang."'"; $db =new DB_si; $db->query($sql); while($db->next_record()) {$l1IlILl[] =$db->Record[I20229]; ___creareTree($db->Record[I20229], $level); }}function ___drawTree($pid, $level =0, $l1IlILL =false) {global $l1IlILl, $table, $idParent, $currentLang, $maxLevel, $l1IlIL1; $level++; $content =""; $maxLevel =max($maxLevel, $level); $sql ="SELECT id, name FROM ".$table." WHERE ".$idParent."='".$pid.I20230.$currentLang."'"; $db =new DB_si; $db->query($sql); if($l1IlILL) {$l1IlIL1[$pid] =true; }$offset =str_repeat(" ", $level *2); while($db->next_record()) {$l1IlILl[] =$db->Record[I20229]; if($l1IlILL && isset($l1IlIL1[$db->Record[I20229]])) {$content .= $offset."<font color=red><i>".$db->Record["name"]."(пришли на элемент ".$db->Record[I20229].")</i></font><br>"; }else {$content .= $offset.$db->Record["name"]." (id=".$db->Record[I20229].")<br>"; $content .= ___drawTree($db->Record[I20229], $level, $l1IlILL); }}return $content; }require I20231; $ILlIlIl=1; require $GLOBALS['DEFAULT_INCLUDES_PATH'] .files_subpath. 'init.php'; ?>
<html>
<head>
<style>
TABLE TH, TABLE {border: 1px solid #ADADAD;}
TABLE TD {border-left: 1px solid #ADADAD; border-bottom: 1px solid #ADADAD;}
</style>
</head>
<body bgcolor="FFBA4A">
<h3><center>Проверка целостности таблиц, хранящих древовидные структуры</center></h3>
<?php  $aTypes =Array("eshop" => "Интернет-Магазин", I20232 => "База знаний", "portfolio" => "Портфолио", "pmanager" => I20233); if(!isset($_GET["type"])) {$type =""; }else {$type =$_GET["type"]; }switch($type) {case "eshop": $table =I20234; $idParent ="id_parent"; $IILL111 ="name"; break; case I20232: $table ="cms_kb_cats"; $idParent ="id_parent"; $IILL111 =I20235; break; case "portfolio": $table ="cms_po_cats"; $idParent ="id_parent"; $IILL111 =I20235; break; case "pmanager": $table =I20236; $idParent ="parent_id"; $IILL111 =I20235; break; default: $type =""; }if($type != "") {?>
<h4><center>Тип: <?php echo $aTypes[$type];?> (таблица: <?php echo $table;?>)</center></h4>
<?php  $l1IlI1I =$adm->Core->GetAOption(I20237); foreach($l1IlI1I as $currentLang) {$I1L1LLI =20000; if(isset($_GET["ver"]) && $_GET[I20238] == "38") {switch($type) {case "eshop": $aTmp =$Core->GetModOption("eshop_cat", "default_rootcat_ids"); break; case I20232: $aTmp =$Core->GetModOption(I20239, "default_rootcat_ids"); break; case "portfolio": $aTmp =$Core->GetModOption("portfolio_cat", "default_rootcat_ids"); break; case I20240: $aTmp =$Core->GetModOption("pages", "default_page_ids"); break; }}else {switch($type) {case "eshop": $aTmp =$Core->GetModProperty("eshop_cat", "default_rootcat_ids"); break; case I20232: $aTmp =$Core->GetModProperty(I20239, "default_rootcat_ids"); break; case "portfolio": $aTmp =$Core->GetModProperty("portfolio_cat", "default_rootcat_ids"); break; case I20240: $aTmp =$Core->GetModProperty(I20241, "default_page_ids"); break; }}$I1L1LLI =$aTmp[$currentLang]; $l1IlILl =Array($I1L1LLI); $sql ="SELECT count(*) AS num FROM ".$table." WHERE lang='".$currentLang."' "; $db->query($sql); $db->next_record(); $numCats =$db->Record[I20242]; ___creareTree($I1L1LLI); $l1IlI1l =Array(); $l1IlI1L =Array(); $l1IlI11 =Array(); $l1IllII =Array(); if(sizeof($l1IlILl) <$numCats) {$sql =I20228.$table." WHERE id NOT IN('".implode("','", $l1IlILl)."') AND lang='".$currentLang."' ORDER BY id ASC"; $db->query($sql); $db2 =new DB_si(); while($db->next_record()) {$id =$db->Record[I20229]; $lIILL11 =$id; if(isset($l1IlI1L[$id]) || isset($l1IllII[$id])) {continue; }$aIds =Array(); do {if(isset($l1IllII[$id])) {foreach($aIds as $key => $tmp) {$aIds[$key] =$l1IllII[$id]; }$l1IllII += $aIds; continue 2; }$sql =I20243.$idParent." FROM ".$table." WHERE id='".$id."'"; $db2->query($sql); if($db2->next_record()) {$aIds[$id] =true; $pid =$db2->Record[$idParent]; $lIILL11 =$db2->Record[I20229]; if(isset($l1IlI1L[$pid])) {foreach($aIds as $key => $tmp) {$aIds[$key] =$l1IlI1L[$pid]; }$l1IlI1L += $aIds; continue 2; }if(isset($aIds[$pid])) {$l1IlI1l[] =$pid; foreach($aIds as $key => $tmp) {$aIds[$key] =$pid; }$l1IlI1L += $aIds; $l1IlI1L[$pid] =$pid; $pid =-2; }else {$aIds[$lIILL11] =true; }}else {foreach($aIds as $key => $tmp) {$aIds[$key] =$lIILL11; }$l1IllII += $aIds; $l1IlI11[] =$lIILL11; $pid =-1; }$id =$pid; }while($pid >0); }$l1IllIl =sizeof($l1IlI11); $l1IllIL =sizeof($l1IlI1l); $l1IllI1 ="<font color=red><b>Обнаружено ошибок: ".($l1IllIl +$l1IllIL).I20244; $content =""; if($l1IllIl >0) {$content .= "<font color=red><b>Потерянные (висячие) ветки:</b></font>"; $l1IlllI ="<pre><b>Ветка №%d:</b><br>%s</pre>"; foreach($l1IlI11 as $index => $l1Illll) {$sql ="SELECT id, parent_id,  name FROM ".$table.I20245.$l1Illll.I20230.$currentLang."'"; $db->query($sql); while($db->next_record()) {$l1IlllL =$db->Record[I20235]." (id=".$db->Record[I20229].", pid=".$db->Record["parent_id"].I20246; $l1IlllL .= ___drawTree($db->Record[I20229]); $content .= sprintf($l1IlllI, $index+1, $l1IlllL );}}}if($l1IllIL >0) {$content .= "<font color=red><b>Циклические ветки:</b></font>"; $l1IlllI ="<pre><b>Ветка №%d:</b><br>%s</pre>"; foreach($l1IlI1l as $index => $l1Illl1) {$sql ="SELECT id, name FROM ".$table.I20245.$l1Illl1.I20230.$currentLang."'"; $db->query($sql); while($db->next_record()) {$l1IlllL =I20247.$db->Record[I20235]." (".$l1Illl1.")</font><br>"; $l1IlllL .= ___drawTree($db->Record[I20229], 0, true); $content .= sprintf($l1IlllI, $index+1, $l1IlllL );}}}}else {$l1IllI1 ="<font color=green><b>Ошибок не обнаружено.</b></font>"; }?>

        <h2>Язык данных: <?php echo $currentLang;?></h2><br>
        <?php echo $l1IllI1;?><br>
        Всего элементов: <?php echo $numCats;?>.<br>
        Максимальная глубина: <?php echo $maxLevel;?>.<br>
        <br><?php echo $content;?>
<?php  }}else {?>
Для проверки требуемого модуля, запустите скрипт с одним из параметров:<br>
<table border=0 cellspacing=5 style="border: 0 px;">
<?php  foreach($aTypes as $l1IllLI => $l1IllLl) {echo "<tr><td style=\"border: 0 px;\">type=".$l1IllLI."</td><td style=\"border: 0 px;\"> - ".$l1IllLl."</td></tr>"; }echo "</table>"; echo "Для запуска скрипта на версии 3.8, используйте параметр: ver=38<br>"; }?>
</body>
</html>