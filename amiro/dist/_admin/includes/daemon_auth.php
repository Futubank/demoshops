<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       7099 xkqwwnxipkpkngkisxwqrqwmrslkliwruwqrmimliryqtrxrtmylqlrizyzypxsnmmgnpnir
 */ ?><?php foreach(array(20825=>"\n",20826=>'SZQIHn|SHIZMn',20827=>'uDQr|GZDDCS',20828=>'urJ',20829=>'Dt',20830=>'IHSQ',20831=>'rHHt|SMr',20832=>'~',20833=>'60~',20834=>'wid|iHSuJQDdQttMnPD`GOG',20835=>'ZIM|SY',20836=>'sy|eu',20837=>'RqihTq|zssR',20838=>'uDQr',20839=>'rQDGHnDQ',20840=>'SZQIHn|uDQrnZIQ') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} error_reporting(E_ALL &~E_NOTICE &~E_USER_NOTICE); function TlITll1($msg, $level ='ERROR'){ die($level .":" .$msg .I20825); }$l1IlLII =isset($_GET['daemon_passwd']) ?$_GET['daemon_passwd'] :''; $domain =isset($_GET['daemon_domain']) ?addslashes($_GET[I20826]) :''; $username =isset($_GET['daemon_username']) ?addslashes($_GET['daemon_username']) :''; $passwd =isset($_GET[I20827]) ?addslashes($_GET[I20827]) :''; $IlLl1l1 =empty($_GET['sid']) ?'' :$_GET['sid']; $__url =empty($_GET[I20828]) ?'' :$_GET[I20828]; $oSess->Start(); $res =false; if($l1IlLII != ''){ if($l1IlLII != $DAEMON_PASSWORD){ TlITll1('10'); }$res =$oSess->TlIIT1l($_h, $domain); }elseif( 'auth_by_hash.php' == basename(TlITlll()) && $IlLl1l1 ){$l1I1I11 =TRUE; do{ $IlLl1l1 =call_user_func(I20829 .'r_r' .'ot13', $IlLl1l1); $IlLl1Ll =mb_substr($IlLl1l1, 0, 1); if(!preg_match('/^[0-9]$/', $IlLl1Ll)){ $l1I1I11 =FALSE; break; }if('shared' == $_h[I20830]){ $domain =isset($_GET['domain']) ?(string)$_GET['domain'] :''; $l1I1I11 ='' !== $domain; if(!$l1I1I11){ break; }$l1I1lII =$oSess->TlIITl1($domain); $l1I1I11 =is_array($l1I1lII); if(!$l1I1I11){ break; }$l1IlIIL =rtrim($_h[I20831], '/') .'/' .trim($l1I1lII[0]['home_dir'], '/') .I20832 .trim($_h['postfix'], I20832) .'/_local/'; require_once 'includes/readconf.php'; }}while(FALSE); if($l1I1I11){ require_once $CLASSES_PATH .'60/AMI_Service.php'; AMI_Service::addAutoloadPath($CLASSES_PATH); AMI_Service::addAutoloadPath($CLASSES_PATH .I20833); AMI::addResourceMapping(require($CLASSES_PATH .'60/resourceMapping.php')); $db =new CMS_simpleDb(); $db->connect(DB_Host, DB_User, DB_Password, DB_Database, TRUE); require_once $GLOBALS['CLASSES_PATH'] .I20834;; $l1I1lIl =new CMS_ModulesOptions(array('core_fast_adm')); if($l1I1lIl->getModParam('core_fast_adm', 'allow_edit_at_front')){ $_hash =mb_substr($IlLl1l1, 1, $IlLl1Ll); $IlLl1l1 =mb_substr($IlLl1l1, $IlLl1Ll +1); $IlLl1L1 =call_user_func(array('AMI', 'getSi' .'ngleton'), 'db', array(I20835 => $db)); $IlLl1LL =empty($_h['session_adm_no_ip_bind']) && empty($GLOBALS['CONFIG_INI']['session']['session_no_ip_bind']); $IlLl11I =call_user_func(array(I20836 .'ery', 'getSn' .'ippet'), "SELECT `id_member`, `data` " ."FROM `cms_sessions` " ."WHERE `id` = %s AND `expired` >= %s" .($IlLl1LL ?" AND `ip` = %s" :'') )->q($IlLl1l1) ->q(date('Y-m-d H:i:s')); if($IlLl1LL){ $IlLl11I->q($_SERVER[I20837]); }$IlLl11l =call_user_func(array($IlLl1L1, 'fetchR' .'ow'), $IlLl11I); if($IlLl11l){ $aData =@unserialize($IlLl11l['data']); $l1I1lIL =FALSE; foreach($aData as $key => $value){ if(preg_match('/^hash_([a-z]{2,3})?$/', $key)){ if($_hash === (string)@unserialize($value)){ $l1I1lIL =TRUE; $oQuery =DB_Query::getSnippet( "SELECT `username`, `password` " ."FROM `cms_members` " ."WHERE `id` = %s" )->plain($IlLl11l['id_member']); $IlLl11l =$IlLl1L1->fetchRow($oQuery); if($IlLl11l){ $l1I1lI1 =''; if($oSess->IsLoggedIn()){ $aUser =$oSess->GetVar(I20838); $l1I1lI1 =$aUser['username']; }$res =$l1I1lI1 === $IlLl11l['username']; if(!$res){ $oSess->TlIT1l1(TRUE); $res =$oSess->TlIIT11($domain, $IlLl11l['username'], $IlLl11l['password']); }if($res){ $oResponse =AMI::getSingleton(I20839); $oResponse->setType('HTML'); $oResponse->HTTP->setRedirect($ADMIN_PATH_WWW .$__url, 303); die; }}}break; }}}else{ }}unset($l1I1lIl); }if($res){ die('OK'); }unset($l1I1I11, $oDB, $oQuery, $aRec, $aData, $l1I1lIL, $l1I1lI1); }else{ $res =$oSess->TlIIT1l($_h, $domain, $username, $passwd); }if(!$res){ TlITll1('20 '); }unset( $username, $domain, $passwd, $l1IlLII, $DAEMON_PASSWORD, $res, $_GET['daemon_passwd'], $_GET[I20826], $_GET[I20840], $_GET[I20827], $l1I1llI, $l1I1lll );