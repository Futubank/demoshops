<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       88884 xkqwrnuyuwqwzsgzsspwprqnnmxryggtssmpwpmgmlyzyytigkmkqnpgpnpruxilwzzkpnir
 */ ?><?php foreach(array(21063=>"FUNw|mNwjUsqd|gzTo",21064=>'ZJJ|GZrQntD',21065=>"",21066=>"DOHC|uDQS|IHSuJQD",21067=>"fMrDt|IHSuJQ",21068=>'Drv|ZuSMt',21069=>'SHnt|DOHC|Mn|GI',21070=>'SMDZYJQS',21071=>"IHSuJQ",21072=>'ZSI',21073=>"MD|MnDtZJJQS",21074=>"WZGtMHn",21075=>"DGQW|IHSuJQ|YHSB",21076=>'',21077=>'MS|DMtQ',21078=>"~",21079=>"GZPQD",21080=>"|LD~trQQ`LD",21081=>"|WDD~trQQ`WDD",21082=>"SY|StMIQ",21083=>"MD|YHttHI",21084=>'QxGZnS',21085=>'JZBHut|MS',21086=>'|PrG|MSD',21087=>"MtQIMS",21088=>"HG|MtQIMS",21089=>"|DBD|rMPOt|r",21090=>"|DBD|rMPOt|S",21091=>'IHSMfMQS|tMIQ',21092=>"Drv|IuJtM|DMtQD",21093=>"fMnS|GZPQ",21094=>":'?hR?nZIQ?jmkq?':",21095=>":'?hR?IHSuJQ|nZIQ?jmkq?':",21096=>'?zNs?MS?NhT?mN?}',21097=>'fHunSgZPQDmSD',21098=>"nH|GZPQ|fHunS",21099=>"MS",21100=>"vQrDMHn|SQJQtQS",21101=>"WOZnPQ|vQrDMHn",21102=>"rQS",21103=>"'!?",21104=>"YJHWK|IZDK",21105=>"1",21106=>"YHSB='",21107=>"|DBD|rMPOt|C",21108=>"'",21109=>"JZB|f",21110=>"'?zNs?JZnP='",21111=>"uG",21112=>"GHDMtMHn",21113=>"'?",21114=>"SHCn",21115=>"'??zNs?JZnP='",21116=>"rQDQt|fHrI",21117=>"YHttHI",21118=>"GHDMtMHn='",21119=>"IHvQ",21120=>"!",21121=>"IHSuJQ|nZIQ",21122=>"DWrMGt|JMnK",21123=>"<<DGQW|IHSuJQ|YHSB<<",21124=>"ZJJ|GZrQntD='",21125=>"IHSuJQ|nZIQ='",21126=>"|YHSB='",21127=>"DY|SZtZ='",21128=>"GuYJMW='",21129=>"GZPQ|nHMnSQx",21130=>"JZnP",21131=>"coqRq?MS='",21132=>"HG|nQCGMS",21133=>"ZWtMHn",21134=>"GZrQntmS",21135=>"IHSuJQ|nZIQ=?'",21136=>"KQBCHrSD|PQnQrZtQ",21137=>"dqjqwT?nZIQ!?fMxQS|nZIQ!?IHSuJQ|nZIQ!?DWrMGt|JMnK!?GZrQnt|MS!?DY|SZtZ!?YJHWK|IZDK!OtIJ|OQZS|tZMJ!?",21138=>"JtMIQ",21139=>"nHnQ",21140=>"KQBCHrSD",21141=>'IHSuJQ|nZIQ',21142=>'GZPQD',21143=>"uDQS|vMrtuZJ|IHSuJQD",21144=>"JMnK",21145=>"|IHSuJQ|nZIQ",21146=>"OtIJ|tMtJQ",21147=>"OtIJ|SQDWrMGtMHn",21148=>'DJZDOQD',21149=>'SQDWrMGtMHn',21150=>"MtQI|ZutH|tMtJQ",21151=>"?=?'",21152=>"|YHSB",21153=>"|YHSB|GrHtQWtQS",21154=>"000",21155=>'DWrMGt|JMnK',21156=>'?~',21157=>'rQSMrQWtMHn|WHSQ',21158=>"SQDt|JMnK='",21159=>"0",21160=>"tGJ|ZSSHn='",21161=>"GZPQ|MS='",21162=>"vQrDMHn|SZtQ='",21163=>"!?",21164=>"'?zNs?MS?NhT?mN?}",21165=>"dqjqwT?",21166=>"|tBGQ",21167=>"JZDt|WOZnPQS='",21168=>"{",21169=>"PrG|ZGGJB",21170=>"PrG|uDQ|nHMnSQx",21171=>'!',21172=>"'!?'1'{",21173=>"{?zNs?JZnP='",21174=>"?zNs?MS?Mn?}",21175=>"'?coqRq?MS='",21176=>"dqjqwT?MS!?GZrQnt|MS!?nZIQ!?IHSuJQ|nZIQ?FRhi?WID|GZPQD?",21177=>"coqRq?MS?Mn?}",21178=>"GZrQnt|MS",21179=>"tMtJQ",21180=>"?OtIJ|tMtJQ='",21181=>"SQDWrMGtMHn",21182=>"ZSS",21183=>"GZrQZ|MS",21184=>"DY|SZtZ?=?'",21185=>"GZPQ|nHMnSQx='",21186=>'~',21187=>"zNs?GHDMtMHn?@?'",21188=>"DtZtuD|ZSS|fZMJ",21189=>'Hn',21190=>'m',21191=>'p',21192=>"frHnt|JMnK",21193=>'nHtmnDtZJJQSiHSmS',21194=>"JZB|YHSB|YHSB",21195=>"SQQG|JQvQJ",21196=>"ZSIMnjMnK",21197=>'<<DGQW|IHSuJQ|YHSB<<',21198=>"JZBHut",21199=>"YJHWK|nuIYQr",21200=>"JZB|YHSB|tBGQ",21201=>"|ZSS|DuY|ZJJHCQS",21202=>"YJHWK|YHSB",21203=>"ZSIMn|IQnu|WZGtMHn",21204=>'fMrDt|IHS|MS',21205=>"tQIGJZtQD~",21206=>"tQIGJZtQD~IHSuJQD~",21207=>"nZIQ",21208=>"MnDtZJJQS",21209=>"?DQJQWtQS",21210=>"tQIGJZtQD|MSD",21211=>'IHSuJQ',21212=>"IHS|JMDt",21213=>"tQIGJZtQD",21214=>"uDQr",21215=>"trQQ|GZPQ%vQr|rHC",21216=>"DtZtuD|IDPD",21217=>'ZJJHC|IuJtM|JZnP',21218=>'trMZJ|OZDO',21219=>"trQQ|GZPQ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} $ILlIlIl =1; $l1lIII1 =1; $l1lII1I =1; require_once $GLOBALS['DEFAULT_INCLUDES_PATH'] .files_subpath .'init.php'; require_once $GLOBALS[I21063] ."func_url.php"; require_once $GLOBALS[I21063] ."func_array.php"; $db2 =new DB_si(); function TlIT1TI($parentId){ global $db2; $sql ='select all_parents from cms_pages where id=' .intval($parentId); $db2->query($sql); $l1lII1l =''; if($db2->next_record()){ $l1lII1l =$db2->Record[I21064]; }$l1lII1l .= (!empty($l1lII1l) ?',' :'') .$parentId; return $l1lII1l; }function TlIT1Tl(&$Core, $l1lII1L ="admin_menu_caption", $ll1I1I1 ="->", $IlIlIl1 =I21065){ $aMenu =array(); $aFirstModule =array(); $unknown ="unknown"; $l1lII11 =&$Core->GetModule("pages"); $aNoShowOwners =$l1lII11->GetOption("dont_show_owners_in_list"); $bShowUsed =$l1lII11->GetOption(I21066); $bShowNotInstalledButActive =true; $vFirstModName =$l1lII11->GetOption(I21067); $modlist =&$Core->GetAllModules(); $useAuditModules =false; if($Core->IsInstalled('srv_audit')){ $mAuditModule =&$Core->GetModule(I21068); if($mAuditModule->GetOption('audit_front')){ $useAuditModules =true; }}$isMultiPageAllowed =$Core->issetAndTrueOption('multi_page_allowed'); $oDeclarator =AMI_ModDeclarator::getInstance(); foreach(array_keys($modlist) as $vModName){ $vMod =&$modlist[$vModName]; $isMultiPage =$vMod->IsInstalled() && $vMod->issetAndTrueOption('multi_page'); $vFrontAllowed =$vMod->IsFrontAllowed(); $vIsActive =($vModName == $IlIlIl1); $vItemData =array(); $isMultiPageMod =$vMod->IsPresentInPM() && !$vMod->IsVirtual() && !$vMod->issetAndTrueProperty('allow_double_in_pm'); if( (!($vMod->IsInstalled() && $vFrontAllowed) || (!$vIsActive && !$bShowUsed && $isMultiPageMod && !($isMultiPageAllowed && $isMultiPage) ))&& !($vFrontAllowed && $bShowNotInstalledButActive && $vIsActive) || $vMod->issetAndTrueProperty(I21069) || (!$vIsActive && preg_match('/^(eshop|portfolio|kb)_home$/', $vModName)) ){if($vMod->IsInstalled() && ($isMultiPage && $isMultiPageMod) && !$vMod->issetAndTrueProperty(I21069)){ if(!$Core->GetOption('allow_multi_lang')){ $vItemData['disabled'] =1; }}elseif(!$vMod->IsInstalled() && $vFrontAllowed && $oDeclarator->isRegistered($vModName)){ list($hyper, )=$oDeclarator->getHyperData($vModName); if('ami_multifeeds' !== $hyper){ continue; }$vItemData[I21070] =1; }else {continue; }}$vItemData["parent"] =$vMod->GetParentName(); if(!$useAuditModules && ($vItemData["parent"] == I21068 || $vModName == 'adv_campaign_types')){ continue; }$vItemData[I21071] =$vModName; $vItemData["caption"] =$GLOBALS[I21072]->GetModHeader($vMod, $l1lII1L, $unknown); $vItemData["owner"] =$vMod->GetOwnerName(); $vItemData["admin_link"] =$vMod->GetAdminLink(); $vItemData[I21073] =$vMod->IsInstalled(); if(!empty($vItemData["parent"])){ $tmpMod =&$modlist[$vItemData["parent"]]; if($tmpMod->IsInstalled() && $tmpMod->IsFrontAllowed()){ $tmpCaption =($tmpMod->issetOption($l1lII1L) ?$tmpMod->GetOption($l1lII1L) :$unknown); $vItemData[I21074] =$tmpCaption .$ll1I1I1 .$vItemData[I21074]; $vItemData["owner"] =$tmpMod->GetOwnerName(); }}if(!in_array($vItemData["owner"], $aNoShowOwners)){ $tmpName =$Core->OwnerGetData($vItemData["owner"], $l1lII1L); if(empty($tmpName)) $tmpName =$unknown; $vItemData[I21074] =$tmpName .$ll1I1I1 .$vItemData[I21074]; }if($vItemData[I21071] == $vFirstModName){ $aFirstModule[] =$vItemData; }else {$aMenu[] =$vItemData; }}if(count($aMenu) >1){ sortMultiArray($aMenu, I21074); }if(count($aFirstModule)){ array_unshift($aMenu, $aFirstModule[0]); }return $aMenu; }function TlIT1T1($I1ll1IL){ global $adm, $db; $aOptions =Array(); $template_blocks_number =$adm->PManager->GetProperty("template_blocks_number"); $sql ="SELECT sb_data FROM cms_pages WHERE lay_id='" .$I1ll1IL ."' AND block_mask='0' LIMIT 1"; $db->query($sql); while ($db->next_record()){ $aPageOptions =unserialize($db->Record["sb_data"]); if(is_array($aPageOptions)){ foreach($aPageOptions as $aPageOptionsKey => $aPageOptionsValue){ $specblock =mb_ereg_replace("(_[0-9]+)", I21065, $aPageOptionsKey); $sBlockNum =mb_substr($aPageOptionsKey, mb_strlen($specblock) +4, 3); if(($aPageOptionsKey != I21075) && ($sBlockNum != "000")){ $aOptions[$aPageOptionsKey] =$aPageOptionsValue; }}}}return $aOptions; }function TlIT1IT($l1lIlII){ global $db, $lang_data; $addon =I21076; $sql ="SELECT id_site, parea_id FROM cms_pages WHERE id='" .$l1lIlII ."' AND lang='" .$lang_data ."' AND hidden=0"; $db->query($sql); if($db->next_record()) $addon ="id_site='" .$db->Record[I21077] ."', parea_id='" .$db->Record['parea_id'] ."'"; return $addon; }function TlIT1II($module_name, $l1lIlIl, $l1lIlIL, $l1lIlI1, $l1lIllI, $l1lIlll){ global $adm; if(!empty($l1lIlI1)){ $l1lIlI1 =TlIT1I1(rtrim($l1lIlI1, "/")) .I21078; }if(!empty($l1lIlll)){ $l1lIlll =TlIT1I1(rtrim($l1lIlll, I21078)) .I21078; }if(isFullLink($l1lIlIL)){ $l1lIllL =$l1lIlIL; }else {$l1lIlIL =trim($l1lIlIL, I21078); if(mb_substr($l1lIlIL, 0, mb_strlen($l1lIlI1)) == $l1lIlI1){ if(mb_substr($l1lIlIL, mb_strlen($l1lIlI1)) == "page" .$l1lIlIl){ $l1lIllL =$l1lIlll ."page" .$l1lIllI; }else {$l1lIllL =$l1lIlll .mb_substr($l1lIlIL, mb_strlen($l1lIlI1)); $IIl1LII =$adm->TTTTll1($l1lIllL, $l1lIllI, true, false, false, I21065, 0, I21065, $module_name); if($IIl1LII <0){ $l1lIllL =TlIT1lT($l1lIllL, $l1lIllI); }}}else {if(mb_substr($l1lIlIL, mb_strrpos($l1lIlIL, I21078) +1) == "page" .$l1lIlIl){ $l1lIllL =mb_substr($l1lIlIL, 0, mb_strrpos($l1lIlIL, I21078) +1) ."page" .$l1lIllI; }else {$l1lIllL =$l1lIlIL; $IIl1LII =$adm->TTTTll1($l1lIllL, $l1lIllI, true, false, false, I21065, 0, I21065, $module_name); if($IIl1LII <0){ $l1lIllL =TlIT1lT($l1lIllL, $l1lIllI); }}}if($module_name == I21079 && !TlIT1Il($l1lIllL)){ $l1lIllL =$l1lIllL .I21078; }}return $l1lIllL; }function TlIT1Il($link){ global $adm; $res =false; $aExtensions =$adm->PManager->GetProperty("static_pages_extensions"); $IILlLll =mb_strrpos($link, "."); if(($IILlLll !== false) && in_array(mb_substr($link, $IILlLll +1), $aExtensions)){ $res =true; }return $res; }function TlIT1I1($link){ global $adm; $aExtensions =$adm->PManager->GetProperty("static_pages_extensions"); $IILlLll =mb_strrpos($link, "."); if(($IILlLll !== false) && in_array(mb_substr($link, $IILlLll +1), $aExtensions)){ $link =mb_substr($link, 0, $IILlLll); }return $link; }function TlIT1lT($link, $id){ global $adm; $ext =I21065; $aExtensions =$adm->PManager->GetProperty("static_pages_extensions"); $IILlLll =mb_strrpos($link, "."); if(($IILlLll !== false) && in_array(mb_substr($link, $IILlLll +1), $aExtensions)){ $ext =mb_substr($link, $IILlLll); $link =mb_substr($link, 0, $IILlLll) ."-" .$id .$ext; }else {$link =$link ."-" .$id; }return $link; }function unHtmlSpecialCharsCB($l1lIll1){ $trans_tbl =get_html_translation_table(HTML_ENTITIES); $trans_tbl =array_flip($trans_tbl); return $l1lIll1[1] .strtr($l1lIll1[2], $trans_tbl) .$l1lIll1[3]; }$Core->Cache->Debug =false; $template_blocks_number =$adm->PManager->GetProperty("template_blocks_number"); $l1lIlLI =false; $adm->InitMessages($adm->Gui->ParseLangFile("templates/lang/_pmanager_msgs.lng")); $ILl1I1I =$adm->Gui->lang; $adm->setLang($adm->lang_data); $l1lIlLl =$adm->Gui->ParseLangFile("templates/lang/_pmanager_msgs.lng"); if($adm->lang_data != "en" && empty($l1lIlLl["new_name"])){ $adm->setLang("en"); $l1lIlLl =$adm->Gui->ParseLangFile("templates/lang/_pmanager_msgs.lng"); }$adm->setLang($ILl1I1I); $adm->Gui->delStyle(); $adm->Gui->delScript(); $adm->Gui->delHtmlStyle(); $adm->Gui->delHtmlScript(); $adm->Gui->addScript("jsapi.php"); $adm->Gui->addScript($GLOBALS['CURRENT_SKIN_PATH'] ."_js/ami.admin.js"); $adm->Gui->addScript($GLOBALS['CURRENT_SKIN_PATH'] .I21080); $vGlobVars['site_id'] =$lllIIIL; $adm->Gui->addScript("mods_to_search_js.php?lang=" .$adm->lang); unset($vGlobVars['site_id']); $adm->Gui->addStyle($GLOBALS['CURRENT_SKIN_PATH'] .I21081); $adm->Gui->addBlock("tree_page", "templates/gettree.tpl"); $adm->Gui->addBlock("tree", "templates/tree/tree.html"); $tree =&Tree::getInstance($adm, true); $tree->lang_data =$lang_data; $tree->ll1Il1l =$adm->DFMT[I21082]; $tree->ll1IlIL =true; $tree->ll1IlI1 =$ROOT_PATH_WWW; $tree->ll1IlLL =false; $variables =array( "expand" => "0", "is_top" => "0", I21083 => "0", 'textareas' => I21076 );if( (!isset($adm->VarsGet['expand']) && !isset($adm->VarsPost['expand'])) || !empty($adm->VarsGet[I21084]) || !empty($adm->VarsPost[I21084]) ){$tree->ll1IlLL =true; $variables["expand"] ="1"; }$variables["reset_form"] =1; $llIIlII =empty($adm->Vars['layout_id']) ?0 :intval($adm->Vars[I21085]); $redirect_id =empty($adm->Vars['redirect_id']) ?0 :intval($adm->Vars['redirect_id']); if($redirect_id >0){ $adm->Vars["skip_search"] =1; $adm->VarsPost["skip_search"] =1; }$IIlLI1l =isset($adm->Vars[I21086]) && $adm->Vars[I21086] != I21076 ?str_replace(';', ',', trim($adm->Vars[I21086], ';')) :$adm->Vars['itemid']; $sql =I21065; if($adm->Vars[I21087] >0){ $lIIIlIL =intval($adm->Vars[I21087]); $sql ="SELECT id, sb_data " ."FROM cms_pages WHERE id='" .$lIIIlIL ."' AND lang='$lang_data'"; SetLocalCookie("pmanager_last_page_id", $lIIIlIL, time() +30 *24 *3600, $cms->AdminPathWWW); }if(!empty($adm->Vars["op_itemid"])){ $lIIIlIL =intval($adm->Vars[I21088]); $sql ="SELECT id, sb_data " ."FROM cms_pages WHERE id='" .$lIIIlIL ."' AND lang='$lang_data'"; }if($sql != I21065){ $db->query($sql); if($db->next_record()){ $l1lIlLL["_sys_right_r"] =!(isset($db->Record["_sys_right_r"]) && ($db->Record[I21089]) == 0); $l1lIlLL["_sys_right_w"] =!(isset($db->Record["_sys_right_w"]) && ($db->Record["_sys_right_w"]) == 0); $l1lIlLL["_sys_right_d"] =!(isset($db->Record[I21090]) && ($db->Record[I21090]) == 0); $aSBData =array(); if(isset($db->Record['sb_data'])){ $aSBData =unserialize($db->Record["sb_data"]); if(!is_array($aSBData)){ $aSBData =array(); }}$variables['page_mt'] =empty($aSBData['modified_time']) ?time() :$aSBData[I21091]; }}$l1lIlL1 =$adm->Core->GetOption('default_ids'); $l1lIl1I =$l1lIlL1[$lang_data]; if($adm->Core->IsInstalled("srv_multi_sites")){ $id_site =0; if($adm->Vars["id_site"] >0){ $id_site =$adm->Vars["id_site"]; }$adm->Core->SetModOption(I21092, "id", $id_site); }$variables['foundPageId'] =I21076; $variables['foundPagesIds'] =I21076; if($adm->Vars["action"] == I21093){ if(mb_strlen($l1lIl1l =$adm->Vars["search_url"]) >2){ $l1lIl1L ="SELECT id, name FROM cms_pages WHERE lang='" .$lang_data ."' AND hidden=0 AND (id='" .$l1lIl1l ."' OR script_link LIKE '%" .$l1lIl1l .I21094 .$l1lIl1l .I21095 .$l1lIl1l ."%')##_condition_addon_## ORDER BY position asc LIMIT 1"; $l1lIl11 =($adm->Vars['previousQuery'] == $adm->Vars['search_url']) && mb_strlen($adm->Vars['foundPagesIds']) ?I21096 .$adm->Vars['foundPagesIds'] .')' :I21076; $sql =str_replace('##_condition_addon_##', $l1lIl11, $l1lIl1L); $rs =&$db->select($sql); if(!$rs->nextRecord()){ $sql =str_replace('##_condition_addon_##', I21076, $l1lIl1L); }unset($rs); }else {$sql ="SELECT id, name FROM cms_pages WHERE lang='" .$lang_data ."' AND hidden=0 AND (script_link LIKE '%" .$l1lIl1l .I21094 .$l1lIl1l .I21095 .$l1lIl1l ."%') ORDER BY position asc LIMIT 1"; }$db->query($sql); if($db->next_record()){ $variables['foundPageId'] =$adm->Vars[I21087] =$db->Record["id"]; $variables[I21097] =$adm->Vars[I21097] .(mb_strlen($adm->Vars[I21097]) ?',' :I21076) .$variables['foundPageId']; $adm->AddStatusMsg("page_found", "blue"); }else {$adm->AddStatusMsg(I21098, "red"); }}$l1lILII =false; if($adm->Vars["action"] == "delete_version"){ $l1lILIl =$adm->Vars["page_version"]; $page_id =$adm->Vars[I21099]; $sql ="DELETE FROM cms_pages_ver WHERE id='" .$l1lILIl ."'"; $db->query($sql); $sql ="SELECT id FROM cms_pages_ver WHERE page_id='" .$page_id ."' ORDER BY version_date DESC LIMIT 1"; $db->query($sql); $adm->AddStatusMsg(I21100, "blue"); if($db->next_record()){ $adm->Vars["page_version"] =$db->Record[I21099]; $l1lILII =true; }}if(!empty($l1lIlLL["_sys_right_w"]) && ($adm->Vars["action"] == I21101 || $l1lILII)){ $l1lILIL =true; $l1lILIl =$adm->Vars["page_version"]; $sql ="SELECT * FROM cms_pages_ver WHERE id='" .$l1lILIl ."'"; $db->query($sql); if($db->next_record()){ $aVersion =array_map('addslashes', $db->Record); $sql ="SELECT * FROM cms_layouts WHERE id='" .$aVersion["lay_id"] ."'"; $db->query($sql); if($db->next_record()){ $aLayout =array_map('addslashes', $db->Record); }else {$adm->AddStatusMsg("version_lay_changed_fail", I21102); $l1lILIL =false; }$sql ="UPDATE cms_pages_ver SET is_active='0' WHERE page_id='" .$adm->Vars[I21087] ."'"; $db->query($sql); $l1lILI1 =I21065; if($l1lILIL){ $l1lILI1 .= "block_mask='" .$aVersion["block_mask"] .I21103 ."lay_id='" .$aVersion["lay_id"] .I21103; for ($i =1; $i <= $template_blocks_number; $i++){ $l1lILI1 .= "lay_f" .$i ."_body='" .(($aVersion[I21104] &(1 << ($i -1))) ?$aVersion["lay_f" .$i ."_body"] :$aLayout["lay_f" .$i ."_body"]) .I21103; }}$sql ="UPDATE cms_pages SET " ."name='" .$aVersion["name"] .I21103 .$l1lILI1 .Tree::TI11T11($aVersion) ."use_noindex='" .($aVersion["use_noindex"] == I21105 ?I21105 :"0") .I21103 ."page_noindex='" .($aVersion["page_noindex"] == I21105 ?I21105 :"0") .I21103 .I21106 .$aVersion["body"] ."' " ."WHERE id='" .$adm->Vars[I21099] ."'"; $db->query($sql); $sql ="UPDATE cms_pages_ver SET is_active='1' WHERE id='" .$l1lILIl ."'"; $db->query($sql); $adm->AddStatusMsg("version_changed", "blue"); }else {$adm->AddStatusMsg("version_not_changed", I21102); }}if(!empty($l1lIlLL[I21107]) && $adm->Vars["action"] == "reset_lay"){ $llIIlII =$adm->Vars["layout_id"]; $aOptions =TlIT1T1($llIIlII); $sql ="SELECT sb_data FROM cms_pages WHERE id='" .$adm->Vars[I21087] .I21108; $db->query($sql); if($db->next_record()){ $aPageOptions =unserialize($db->Record["sb_data"]); if(is_array($aPageOptions)){ $aOptions =array_merge($aPageOptions, $aOptions); }}$sql ="SELECT * FROM cms_layouts WHERE id='" .$llIIlII ."' AND lang='" .$lang_data ."' AND hidden=0"; $db->query($sql); if($db->next_record()){ $update_sql ="UPDATE cms_pages SET " ."block_mask='0', " ."last_changed='" .DateTools::toMysqlDate(time()) .I21103 ."sb_data='" .serialize($aOptions) .I21103 ."lay_id='" .$llIIlII .I21103; for ($i =1; $i <= $template_blocks_number; $i++){ $update_sql .= I21109 .$i ."_body='" .addslashes($db->Record[I21109 .$i ."_body"]) .I21108; if($i <$template_blocks_number) $update_sql .= ", "; }$sql =$update_sql ." WHERE id='" .$adm->Vars[I21087] .I21110 .$lang_data .I21108; $db->query($sql); $adm->AddStatusMsg("pages_status_lay_changed", "blue"); $applied_id =$adm->Vars[I21087]; }else {$adm->AddStatusMsg("pages_status_lay_changed_fail", I21102); }}if(!empty($l1lIlLL[I21107]) && ($adm->Vars["action"] == I21111 || $adm->Vars["action"] == "down")){ $sql ="SELECT position FROM cms_pages " ."WHERE id = '" .$adm->Vars[I21087] .I21110 .$lang_data .I21108; $db->query($sql); if($db->next_record()) $adm->Vars[I21112] =$db->Record[I21112]; if($adm->Vars["action"] == I21111){ $sql ="SELECT id, position FROM cms_pages " ."WHERE parent_id = '" .$adm->Vars["parentId"] .I21113 ."AND position < '" .$adm->Vars[I21112] ."'  AND lang='" .$lang_data .I21108 ."ORDER BY position DESC LIMIT 2"; }if($adm->Vars["action"] == I21114){ $sql ="SELECT id, position FROM cms_pages " ."WHERE parent_id = '" .$adm->Vars["parentId"] .I21113 ."AND position > '" .$adm->Vars[I21112] .I21115 .$lang_data .I21108 ."ORDER BY position ASC LIMIT 2"; }$db->query($sql); if($db->next_record()){ $l1lILlI =$adm->Vars[I21112]; $page_id =$db->Record[I21099]; $sql ="UPDATE cms_pages SET " ."position = '" .$db->Record[I21112] .I21113 ."WHERE id='" .$adm->Vars[I21087] .I21110 .$lang_data .I21108; $db->query($sql); $sql ="UPDATE cms_pages SET " ."position = '" .$l1lILlI .I21113 ."WHERE id='" .$page_id .I21110 .$lang_data .I21108; $db->query($sql); $adm->AddStatusMsg("status_order", "blue"); }$variables[I21116] =0; }if(!empty($l1lIlLL[I21107]) && ($adm->Vars["action"] == "top" || $adm->Vars["action"] == "bottom")){ $sql ="SELECT position FROM cms_pages " ."WHERE id = '" .$adm->Vars[I21087] .I21110 .$lang_data .I21108; $db->query($sql); if($db->next_record()) $adm->Vars[I21112] =$db->Record[I21112]; if($adm->Vars["action"] == "top"){ $sql ="SELECT id, position FROM cms_pages " ."WHERE parent_id = '" .$adm->Vars["parentId"] .I21113 ."AND position < '" .$adm->Vars[I21112] .I21110 .$lang_data .I21108 ."ORDER BY position DESC"; }if($adm->Vars["action"] == I21117){ $sql ="SELECT id, position FROM cms_pages " ."WHERE parent_id = '" .$adm->Vars["parentId"] .I21113 ."AND position > '" .$adm->Vars[I21112] .I21110 .$lang_data .I21108 ."ORDER BY position ASC"; }$db->query($sql); $IIl11lL =$adm->Vars[I21112]; $IIl11l1 =new DB_si; while ($db->next_record() && $db->Record[I21099] != $adm->Vars[I21087]){ $sql ="UPDATE cms_pages SET " ."position='" .$IIl11lL .I21113 ."WHERE id='" .$db->Record[I21099] .I21110 .$lang_data .I21108; $IIl11lL =$db->Record[I21112]; $IIl11l1->query($sql); }if($IIl11lL != $adm->Vars[I21112]){ $sql ="UPDATE cms_pages SET " .I21118 .$IIl11lL .I21113 ."WHERE id='" .$adm->Vars[I21087] .I21110 .$lang_data .I21108; $IIl11l1->query($sql); $adm->AddStatusMsg("status_order", "blue"); }$variables[I21116] =0; }if(!empty($l1lIlLL[I21107]) && ($adm->Vars["action"] == I21119)){ $itemId =$adm->Vars[I21088]; $l1lIlII =$adm->Vars["op_newpid"]; $l1lILll =$l1lIlII; $l1lILlL =false; while (($l1lILll != $itemId) && ($l1lILll >0)){ $sql ="SELECT parent_id FROM cms_pages " ."WHERE id='" .$l1lILll .I21108; $db->query($sql); if($db->next_record()) $l1lILll =$db->Record["parent_id"]; if($l1lILll == $itemId) $l1lILlL =true; }if(!$l1lILlL){ $sql ="UPDATE cms_pages SET " ."parent_id = '" .$l1lIlII .I21103 ."all_parents = '" .TlIT1TI($l1lIlII) .I21113 ."WHERE id='" .$itemId .I21108; $db->query($sql); if($adm->Core->IsInstalled('srv_multi_sites')){ $update =TlIT1IT($l1lIlII); $arr =array(); $tree->TI11Tll($itemId, I21099); $ids =I21065; while ($tree->TI11Tl1($arr)){ $ids .= I21120 .$arr[I21099]; }$ids =mb_substr($ids, 1); $sql ="UPDATE cms_pages SET " .$update ." WHERE id IN ($ids)"; $db->query($sql); }$adm->AddStatusMsg("status_move", "blue"); }else $adm->AddStatusMsg("status_move_fail_is_child", I21102); }function TlIT1lI($itemId, $l1lIlII, &$addon){ global $adm, $template_blocks_number; $IIl11l1 =new DB_si; $sql ="SELECT * from cms_pages " ."WHERE id='" .$itemId .I21108; $IIl11l1->query($sql); if(!$IIl11l1->next_record()){ return; }$IIl11l1->Record =array_map("addslashes", $IIl11l1->Record); $module_name =$IIl11l1->Record[I21121]; $page_body =$IIl11l1->Record["body"]; $oldParentId =$IIl11l1->Record["parent_id"]; $l1lIlIL =$IIl11l1->Record[I21122]; $l1lIlIl =$IIl11l1->Record[I21099]; if($module_name != I21079){ $IlLI11I =&$adm->Core->GetModule($module_name); if(!($IlLI11I->issetAndTrueOption("multi_page") && $adm->Core->issetAndTrueOption("multi_page_allowed"))){ $module_name =I21079; $page_body =str_replace(I21123, I21065, $page_body); }}$sql ="INSERT INTO cms_pages SET " ."parent_id='" .$l1lIlII .I21103 .I21124 .TlIT1TI($l1lIlII) .I21103 ."name='" .$IIl11l1->Record["name"] .I21103 .I21125 .$module_name .I21103 ."lay_id='" .$IIl11l1->Record["lay_id"] .I21103 .I21106 .$page_body .I21103; for ($i =1; $i <= $template_blocks_number; $i++){ $sql .= I21109 .$i .I21126 .$IIl11l1->Record[I21109 .$i ."_body"] .I21103; }$sql .= "removable = '1', " ."hidden = '0', " ."fixed_name = '0', " .I21127 .$IIl11l1->Record["sb_data"] ."'," ."block_mask='" .$IIl11l1->Record[I21104] ."'," .I21128 .$IIl11l1->Record["public"] .I21103 .Tree::TI11T11($IIl11l1->Record) ."use_noindex='" .$IIl11l1->Record["use_noindex"] .I21103 ."page_noindex='" .$IIl11l1->Record[I21129] .I21103 ."use_hreflang='" .$IIl11l1->Record["use_hreflang"] .I21103 ."last_changed='" .DateTools::toMysqlDate(time()) .I21103 ."lang='" .$IIl11l1->Record[I21130] .I21108; $sql .= $addon["multi_site_sql"]; $IIl11l1->query($sql); $l1lILl1 =$IIl11l1->lastInsertId(); $sql ="SELECT id, script_link from cms_pages " ."WHERE id='" .$oldParentId .I21108; $IIl11l1->query($sql); if($IIl11l1->next_record()){ $l1lIlI1 =$IIl11l1->Record[I21122]; }$sql ="SELECT id, parent_id, script_link from cms_pages " .I21131 .$l1lIlII .I21108; $IIl11l1->query($sql); $l1lIlll =I21065; if($IIl11l1->next_record() && $IIl11l1->Record["parent_id"] >0){ $l1lIlll =$IIl11l1->Record[I21122]; }$l1lIllL =TlIT1II($module_name, $l1lIlIl, $l1lIlIL, $l1lIlI1, $l1lILl1, $l1lIlll); $sql ="UPDATE cms_pages SET " ."position = '" .$l1lILl1 .I21103 ."script_link = '" .$l1lIllL .I21113 .I21131 .$l1lILl1 .I21108; $IIl11l1->query($sql); $sql ="SELECT id, script_link from cms_pages " ."WHERE parent_id='" .$itemId ."' ORDER BY position"; $IIl11l1->query($sql); while ($IIl11l1->next_record()){ TlIT1lI($IIl11l1->Record[I21099], $l1lILl1, $addon); }$adm->Vars[I21087] =$l1lILl1; }if(!empty($l1lIlLL[I21107]) && ($adm->Vars["action"] == "copy")){ $itemId =$adm->Vars[I21088]; $l1lIlII =$adm->Vars[I21132]; $l1lILll =$l1lIlII; $l1lILlL =false; while (($l1lILll != $itemId) && ($l1lILll >0)){ $sql ="SELECT parent_id FROM cms_pages " .I21131 .$l1lILll .I21108; $db->query($sql); if($db->next_record()) $l1lILll =$db->Record["parent_id"]; if($l1lILll == $itemId) $l1lILlL =true; }if(!$l1lILlL){ $addon["multi_site_sql"] =I21065; if($adm->Core->IsInstalled(I21092)){ $addon["multi_site_sql"] =I21120 .TlIT1IT($l1lIlII); }$sql ="SELECT script_link FROM cms_pages " .I21131 .$l1lIlII .I21108; $db->query($sql); if($db->next_record()){ $addon["new_parent_link"] =$db->Record[I21122]; }TlIT1lI($itemId, $l1lIlII, $addon); $adm->AddStatusMsg("status_copy", "blue"); }else {$adm->AddStatusMsg("status_copy_fail_is_child", I21102); }}$l1lILLI =0; if(!empty($l1lIlLL[I21107]) && $adm->Vars[I21087] >0 && $adm->Vars[I21133] == "apply"){ $l1lILLl =false; $l1lILLL =false; $name =$adm->VarsPost["name"]; $tpl_addon =isset($adm->VarsPost["tpl_addon"]) ?$adm->VarsPost["tpl_addon"] :I21076; $pid =intval($adm->VarsPost[I21134]); $lay_body_body =$adm->VarsPost["lay_body_body"]; $aOptions =TlIT1T1($adm->VarsPost["layout_id"]); $public =$adm->VarsPost["public"]; $l1lILL1 =$adm->VarsPost[I21122]; $l1lIL1I =I21065; if(isset($adm->VarsPost[I21121]) && !empty($adm->VarsPost[I21121])){ if($adm->VarsPost[I21121] == "redirect"){ $adm->VarsPost[I21121] =I21079; }if($adm->Core->IsFrontAllowed($adm->VarsPost[I21121])){ $l1lIL1I =I21135 .$adm->VarsPost[I21121] .I21103; }}if($pid == 0){ $public =1; $l1lILLI =1; }$IIILL1L =$adm->PManager->GetOption(I21136); $IIl11L1 =I21065; $IIl111I =I21065; if($IIILL1L != "none"){ $IIl11L1 .= " is_kw_manual, body, "; $IIl11L1 .= ($IIILL1L == "auto") ?" html_title, html_keywords, html_description, " :I21065; }$sql =I21137 .$IIl11L1 ."date_format(last_changed, '" .$tree->ll1Il1l ."') AS ltime " ."FROM cms_pages WHERE id='" .$adm->Vars[I21087] ."' AND lang='$lang_data'"; $db->query($sql); if($db->next_record() && ($l1lIlLL[I21107] == 1)){ $l1lIL1l =$db->Record[I21104]; $aSBData =unserialize($db->Record["sb_data"]); if(!is_array($aSBData)){ $aSBData =Array(); }if($adm->VarsPost[I21121] != $db->Record[I21121]){ unset($aSBData[I21075]); }if($adm->VarsPost["last_modified"] != $db->Record[I21138]){ $adm->AddStatusMsg("status_page_already_modified", I21102); }$fixed_name =$db->Record["fixed_name"]; $l1lIL1L =$db->Record[I21122]; $l1lIL11 =$db->Record["name"]; $pid =$db->Record["parent_id"]; $module_name =$db->Record[I21121]; if($IIILL1L != I21139){ $IIILL11 =$db->Record["is_kw_manual"]; if($IIILL1L == "auto"){ $IIIL1II =array( "title" => $db->Record["html_title"], I21140 => $db->Record["html_keywords"], "description" => $db->Record["html_description"] );}}}else {$l1lILLL =true; }if(!$l1lILLL){ $IIl1I1L =I21065; $l1lI1II ="page" .$adm->Vars[I21087]; $lL1L1l1 =$l1lILL1 =PrepareSublink($adm->VarsPost[I21122]); if($l1lILL1 != I21076 && $adm->VarsPost[I21141] == I21142 && mb_substr($adm->VarsPost['script_link'], -1) == '/'){ $l1lILL1 .= '/'; }$adm->VarsPost[I21122] =$l1lILL1; $l1lI1Il =(mb_substr($lL1L1l1, mb_strlen($lL1L1l1) -mb_strlen($l1lI1II)) == $l1lI1II); $IILlLll =mb_strrpos($lL1L1l1, I21078); $IILIIII =false; if(( empty($l1lILL1) && $pid >0) || (($l1lIL1L == $l1lILL1 )&& $l1lI1Il && ($name != $l1lIlLl["new_name"] ))){if(empty($l1lILL1) && $pid != $l1lIl1I){ $sql ="select script_link from cms_pages where id='" .$pid .I21108; $db->query($sql); if($db->next_record()){ $IIl1I1L =$db->Record[I21122]; }}else {if($IILlLll !== false){ $IIl1I1L =mb_substr($l1lILL1, 0, $IILlLll +1); }}$IIl1I1L =TlIT1I1($IIl1I1L); $forcedLink =I21065; $aVirtualLinks =$adm->Core->GetModProperty(I21079, "virtual_links"); $aUsedVirtualModules =$adm->Core->GetModOption(I21079, I21143); foreach($aVirtualLinks as $masterModuleName => $aVirtualModules){ if(isset($aVirtualModules[$adm->VarsPost[I21121]])){ if(in_array($adm->VarsPost[I21121], $aUsedVirtualModules)){ $forcedLink =$aVirtualModules[$adm->VarsPost[I21121]]; }break; }}$IIl1l11 =$adm->GenAutoLink($name, $IIl1I1L, ($lang_data == "ru") ?true :false, $forcedLink); $IIl1l11 =PrepareSublink($IIl1l11); if($redirect_id == 0){ $IIl1LII =$adm->TTTTll1($IIl1l11, $adm->Vars[I21087], true, false, false, I21065, 0, I21065, $adm->VarsPost[I21121]); if($IIl1LII <0){ $IIl1l11 =TlIT1lT($IIl1l11, $adm->Vars[I21087]); }}if($adm->VarsPost[I21121] == I21079 && !TlIT1Il($IIl1l11)){ $IIl1l11 .=I21078; }$IILIIII =true; $adm->VarsPost[I21122] =$IIl1l11; $adm->AddStatusMsg("status_apply_note_linkauto", "blue", I21065, I21065, array(I21144 => $IIl1l11)); }if(($redirect_id == 0) && !$IILIIII && ($l1lILL1 != $l1lIL1L )){if(!empty($l1lILL1) && !checkUrlSymbols($l1lILL1, $l1lI1IL)){ $adm->VarsPost[I21122] =$l1lIL1L; $l1lILL1 =$l1lIL1L; $adm->AddStatusMsg("status_apply_warn_link_symb", I21102); }else if(!isFullLink($l1lILL1)){ $IIl1LII =$adm->TTTTll1($l1lILL1, $adm->Vars[I21087], true, false, false, I21065, 0, I21065, $adm->VarsPost[I21121]); if($IIl1LII <0){ $adm->VarsPost[I21122] =$l1lIL1L; if($IIl1LII == -3){ $navData =$adm->TTIT1Tl(); $vMod =&$adm->Core->GetModule($navData[I21145]); $modName =$adm->GetModHeader($vMod); $adm->AddStatusMsg("status_apply_warn_virtual_link", I21102, I21065, I21065, Array(I21121 => I21108 .$modName .I21108)); }else {$adm->AddStatusMsg("status_apply_warn_link", I21102); }}}}if($redirect_id == 0){ $adm->VarsPost["html_title"] =removeSpecial($adm->VarsPost[I21146], "html"); $adm->VarsPost["html_keywords"] =removeSpecial($adm->VarsPost["html_keywords"], "html"); $adm->VarsPost[I21147] =removeSpecial($adm->VarsPost[I21147], "html"); if($IIILL1L != I21139){ $IIIL1Il =array(); foreach(array('html_title', 'html_keywords', 'html_description') as $field){ $adm->VarsPost[$field] =removeSpecial($adm->VarsPost[$field], I21148); }$IIIL1Il =array( 'title' => $adm->VarsPost['html_title'], 'keywords' => $adm->VarsPost['html_keywords'], I21149 => $adm->VarsPost['html_description'] );$adm->VarsPost[I21146] =htmlspecialchars($adm->VarsPost[I21146]); $vName =removeSpecial($name); $IIIL1IL =array(); if($adm->TTTT1Tl($IIILL1L, $IIILL11, $IIIL1II, $IIIL1Il, $IIIL1IL, $vName, $adm->VarsPost["lay_body_body"])){ $adm->VarsPost[I21146] =$IIIL1Il["title"]; $aVars =TlT1IlT($adm, $db, I21079, $adm->Vars[I21087], $adm->VarsPost[I21146]); $aVars["object_name"] =$aVars[I21150]; $adm->VarsPost[I21146] =TlT1IlI($adm, I21079, $aVars, $adm->VarsPost[I21146]); $adm->VarsPost["html_keywords"] =$IIIL1Il[I21140]; $adm->VarsPost[I21147] =$IIIL1Il["description"]; $adm->AddStatusMsg("status_apply_note_kwauto", "blue"); }$IIl111I =key($IIIL1IL) .I21151 .$IIIL1IL[key($IIIL1IL)] .I21103; }}$sql ="SELECT * FROM cms_layouts " .I21131 .$llIIlII .I21113 ."AND lang='" .$lang_data .I21108; $db->query($sql); if(!$db->next_record()){ $adm->AddStatusMsg("status_lay_not_found", I21102); $l1lILLL =true; }else {$l1lI1I1 =I21065; $l1lI1lI =I21065; $block_mask =0; $aPageSpecBlocks =Array(); $aLayoutSpecBlocks =Array(); $aForceOptions =Array(); for ($i =1; $i <= $template_blocks_number; $i++){ if($l1lI1I1 != I21065) $l1lI1I1 .= ", "; $l1lI1I1 .= I21109 .$i .I21126 .$adm->VarsPost[I21109 .$i .I21152] .I21108; if($adm->VarsPost[I21109 .$i ."_body_protected"] == I21105){ $block_mask =$block_mask |(1 << ($i -1)); }else if(($adm->VarsPost[I21109 .$i ."_body_modified"] != I21105) || ($l1lIL1l &(1 << ($i -1)))){ $adm->VarsPost[I21109 .$i .I21152] =addslashes($db->Record[I21109 .$i .I21152]); foreach($aOptions as $aOptionsKey => $aOptionsValue){ $specblock =mb_ereg_replace("(_[0-9]+)", I21065, $aOptionsKey); $sBlockNum =mb_substr($aOptionsKey, mb_strlen($specblock) +4, 3); $iBlockNum =intval($sBlockNum); if($iBlockNum == $i){ $aForceOptions[$aOptionsKey] =$aOptions[$aOptionsKey]; }}}if($adm->VarsPost[I21109 .$i ."_body_modified"] == I21105){ $l1lI1lI .= I21109 .$i .I21126 .$adm->VarsPost[I21109 .$i .I21152] .I21103; $l1lILLl =true; }else if($adm->VarsPost[I21109 .$i .I21153] != I21105){ $l1lI1lI .= I21109 .$i .I21126 .$adm->VarsPost[I21109 .$i .I21152] .I21103; }if(preg_match_all("/##(spec_.*?)##/i", $adm->VarsPost[I21109 .$i .I21152], $aSpecBlocks)){ if($adm->VarsPost[I21109 .$i .I21153] != I21105){ $aLayoutSpecBlocks =array_merge($aLayoutSpecBlocks, $aSpecBlocks[1]); }$aPageSpecBlocks =array_merge($aPageSpecBlocks, $aSpecBlocks[1]); }}if(preg_match_all("/##(spec_.*?)##/i", $adm->VarsPost["lay_body_body"], $aSpecBlocks)){ $aPageSpecBlocks =array_merge($aPageSpecBlocks, $aSpecBlocks[1]); }$aLayoutSpecBlocksRemove =Array(); $aPageSpecBlocksRemove =Array(); foreach($aSBData as $aSBDataKey => $aSBDataValue){ if(!in_array($aSBDataKey, $aPageSpecBlocks)){ $specblock =mb_ereg_replace("(_[0-9]+)", I21065, $aSBDataKey); $sSpecNum =mb_substr($aSBDataKey, mb_strlen($specblock) +1, 3); $sBlockNum =mb_substr($aSBDataKey, mb_strlen($specblock) +4, 3); if($sBlockNum == I21154){ $aPageSpecBlocksRemove[] =$aSBDataKey; }else {$iBlockNum =intval($sBlockNum); $bBlockProtected =($block_mask &(1 << ($iBlockNum -1))); if(!$bBlockProtected){ $aLayoutSpecBlocksRemove[] =$aSBDataKey; }else {$aPageSpecBlocksRemove[] =$aSBDataKey; }}unset($aSBData[$aSBDataKey]); }}}}$l1lI1ll =I21065; if(isset($aForceOptions) && is_array($aForceOptions)){ $aSBData =array_merge($aSBData, $aForceOptions); }if($fixed_name != I21105){ $l1lI1ll ="name='" .$name .I21103; }if($fixed_name == '1' || !empty($name) && !empty($adm->VarsPost['is_redirect'])){ $adm->VarsPost['script_link'] =trim($adm->VarsPost[I21155]); $adm->VarsPost['dest_link'] =trim($adm->VarsPost['dest_link']); if(rtrim($adm->VarsPost[I21155], ' /') == rtrim($adm->VarsPost['dest_link'], I21156)){ $adm->AddStatusMsg('status_equal_src_dest_links', 'red'); $l1lILLL =true; }}if(($fixed_name == I21105 || !empty($name)) && !$l1lILLL){ $l1lI1lL =empty($adm->VarsPost['is_redirect']) ?'NULL' :I21108 .(int) $adm->VarsPost[I21157] .I21108; $sql ="UPDATE cms_pages SET " .$l1lI1ll .$l1lIL1I ."script_link='" .$adm->VarsPost[I21122] .I21103 ."lay_id='$llIIlII', " ."redirect_id='$redirect_id', " ."body='$lay_body_body', " ."redirection_code=" .$l1lI1lL .", "; $sql .= $l1lI1lI; $sql .= I21158 .(empty($adm->VarsPost['is_redirect']) ?I21076 :$adm->VarsPost['dest_link']) .I21103; $sql .= I21128 .intval($public) .I21103 ."block_mask='" .$block_mask ."'," ."show_me_at_parent='" .$l1lILLI .I21103 .I21127 .addslashes(serialize($aSBData)) .I21103 ."last_changed='" .DateTools::toMysqlDate(time()) .I21103 .Tree::TI11T11($adm->VarsPost) ."use_noindex='" .(isset($adm->VarsPost["use_noindex"]) && $adm->VarsPost["use_noindex"] == I21105 ?I21105 :I21159) .I21103 ."page_noindex='" .(isset($adm->VarsPost[I21129]) && $adm->VarsPost[I21129] == I21105 ?I21105 :I21159) .I21103 ."use_hreflang='" .(isset($adm->VarsPost["page_use_hreflang"]) && $adm->VarsPost["page_use_hreflang"] == I21105 ?I21105 :I21159) .I21103 .I21160 .$tpl_addon .I21103 .$IIl111I ."lang='" .$lang_data .I21113 .I21131 .$adm->Vars[I21087] .I21108; if($db->query($sql)){ $applied_id =$adm->Vars[I21087]; $adm->AddStatusMsg("status_apply"); $sql ="UPDATE cms_pages_ver SET is_active='0' WHERE page_id='" .$adm->Vars[I21087] .I21108; $db->query($sql); $sql ="INSERT INTO cms_pages_ver SET " .I21161 .$adm->Vars[I21087] .I21103 ."is_active='1', " .$l1lI1ll .$l1lIL1I ."script_link='" .$adm->VarsPost[I21122] .I21103 ."body='$lay_body_body', " ."block_mask='" .$block_mask .I21103; $sql .= $l1lI1I1 .", "; $sql .= I21162 .DateTools::toMysqlDate(time()) .I21103 .Tree::TI11T11($adm->VarsPost) ."use_noindex='" .(isset($adm->VarsPost["use_noindex"]) && $adm->VarsPost["use_noindex"] == I21105 ?I21105 :I21159) .I21103 ."page_noindex='" .(isset($adm->VarsPost[I21129]) && $adm->VarsPost[I21129] == I21105 ?I21105 :I21159) .I21103 ."lay_id='$llIIlII'"; $db->query($sql); $l1lI1l1 =I21065; $sql ="SELECT id, version_date FROM cms_pages_ver WHERE page_id='" .$adm->Vars[I21087] ."' AND (version_date < (NOW() - INTERVAL 30 DAY)) ORDER BY version_date DESC LIMIT 1"; $db->query($sql); while ($db->next_record()){ if($l1lI1l1 != I21065){ $l1lI1l1 .= ", "; }$l1lI1l1 .= $db->Record[I21099]; }$sql ="SELECT id, MAX(id) as last_id, DATE_FORMAT(version_date,'%d') as day FROM cms_pages_ver WHERE page_id='" .$adm->Vars[I21087] ."' AND (version_date > (NOW() - INTERVAL 8 DAY)) AND (version_date < (NOW() - INTERVAL 1 DAY)) GROUP BY day"; $db->query($sql); while ($db->next_record()){ if($l1lI1l1 != I21065){ $l1lI1l1 .= I21163; }$l1lI1l1 .= $db->Record["last_id"]; }$sql ="SELECT id, version_date FROM cms_pages_ver WHERE page_id='" .$adm->Vars[I21087] ."' AND (version_date >= (NOW() - INTERVAL 1 DAY)) ORDER BY version_date DESC LIMIT 5"; $db->query($sql); while ($db->next_record()){ if($l1lI1l1 != I21065){ $l1lI1l1 .= I21163; }$l1lI1l1 .= $db->Record[I21099]; }$sql ="DELETE FROM cms_pages_ver WHERE page_id='" .$adm->Vars[I21087] .I21164 .$l1lI1l1 .")"; $db->query($sql, DBC_SYS_QUERY); $l1lIlLI =true; }else {$adm->AddStatusMsg("status_apply_fail", I21102); }}else {$adm->AddStatusMsg("status_apply_fail", I21102); }}if(( $redirect_id == 0 )&& $l1lIlLI){ if($l1lILLl){ $llIIlIl =I21065; $l1lI1LI =false; for ($i =1; $i <= $template_blocks_number; $i++){ if($llIIlIl != I21065) $llIIlIl .=I21163; $llIIlIl .= I21109 .$i ."_type"; }$sql =I21165 .$llIIlIl ." FROM cms_layouts " .I21131 .$llIIlII ."' AND lang='$lang_data'"; $db->query($sql); $db->next_record(); $aLayout =$db->Record; $db2 =new DB_si; $sql ="SELECT id, name, " .$llIIlIl ." FROM cms_layouts " ."WHERE lang='$lang_data'"; $db->query($sql); $l1lI1Ll =Array(); while ($db->next_record()){ $l1lILI1 =I21065; for ($i =1; $i <= $template_blocks_number; $i++) for ($j =1; $j <= $template_blocks_number; $j++){ if($adm->VarsPost[I21109 .$j ."_body_modified"] == I21105 && $adm->VarsPost[I21109 .$j .I21153] != I21105 && !empty($db->Record[I21109 .$i .I21166]) && !empty($aLayout[I21109 .$j .I21166]) && $db->Record[I21109 .$i .I21166] == $aLayout[I21109 .$j .I21166]){ if($l1lILI1 != I21065) $l1lILI1 .=I21163; $l1lILI1 .= I21109 .$i ."_body=IF( block_mask & ( 1 << (" .$i ."-1)),lay_f" .$i ."_body,'" .$adm->VarsPost[I21109 .$j .I21152] ."')"; }}if(empty($l1lILI1)) continue; $l1lI1Ll[] =$db->Record[I21099]; $l1lI1LI =true; $sql ="UPDATE cms_layouts SET "; $sql .= $l1lILI1; $sql .=" WHERE " ." id='" .$db->Record[I21099] .I21108 ." AND lang='$lang_data'" ." AND is_isolated='0'"; $db2->query($sql); $sql ="UPDATE cms_pages SET "; $sql .= I21167 .DateTools::toMysqlDate(time()) .I21103; $sql .= $l1lILI1; $sql .=" WHERE " ." lang='$lang_data'" ." AND lay_id='" .$db->Record[I21099] .I21108; $db2->query($sql); }if($l1lI1LI){ $adm->AddStatusMsg("pages_status_apply"); if(sizeof($aLayoutSpecBlocksRemove) >0){ $sql ="SELECT id, block_mask, sb_data FROM cms_pages WHERE lay_id in(" .implode($l1lI1Ll, I21120) .I21168; $db->query($sql); while ($db->next_record()){ foreach($aLayoutSpecBlocksRemove as $l1lI1LL => $l1lI1L1){ $specblock =mb_ereg_replace("(_[0-9]+)", I21065, $l1lI1L1); $sSpecNum =mb_substr($l1lI1L1, mb_strlen($specblock) +1, 3); $sBlockNum =mb_substr($l1lI1L1, mb_strlen($specblock) +4, 3); $iBlockNum =intval($sBlockNum); $bBlockProtected =($db->Record[I21104] &(1 << ($iBlockNum -1))); if(!$bBlockProtected){ $aSBData =unserialize($db->Record["sb_data"]); unset($aSBData[$l1lI1L1]); $sql ="UPDATE cms_pages SET sb_data='" .serialize($aSBData) ."' WHERE id='" .$db->Record[I21099] .I21108; $db2->query($sql); }}}}}}}if($adm->Vars[I21133] == I21169){ $sql =I21065; $aOptions =Array("grp_public", "grp_html_title_inherit", "grp_is_section", "grp_show_in_sitemap", "grp_show_me_at_parent", "grp_show_siblings", "grp_menu_main", "grp_menu_top", "grp_menu_bottom", I21170); $l1lIl1I =$adm->Core->GetOption('default_ids'); $l1lIl1I =$l1lIl1I[$adm->lang_data]; $l1lI11I =in_array($l1lIl1I, explode(',', $IIlLI1l)); foreach($aOptions as $key){ if(isset($adm->Vars[$key]) && $adm->Vars[$key] != I21076){ if($key == 'grp_public' && !$adm->Vars[$key] && $l1lI11I){ $IIlLI1l =explode(',', $IIlLI1l); unset($IIlLI1l[array_search($l1lIl1I, $IIlLI1l)]); $IIlLI1l =implode(I21171, $IIlLI1l); if($IIlLI1l == I21076){ break; }}if(!empty($sql)){ $sql .= I21163; }$sql .= mb_substr($key, 4) ."='" .$adm->Vars[$key] .I21108; }}if(isset($adm->Vars["grp_skip_search"])){ if(!empty($sql)){ $sql .= I21163; }$sql .= "skip_search=IF( redirect_id=0, '" .intval($adm->Vars["grp_skip_search"]) .I21172; }if(isset($adm->Vars["grp_page_noindex"])){ if(!empty($sql)){ $sql .= I21163; }$sql .= "page_noindex=IF( redirect_id=0, '" .intval($adm->Vars["grp_page_noindex"]) .I21172; }if(isset($adm->Vars["grp_is_printable"])){ if(!empty($sql)){ $sql .= I21163; }$sql .= "is_printable=IF( redirect_id=0, '" .intval($adm->Vars["grp_is_printable"]) ."', '0')"; }if(!empty($sql) && $IIlLI1l != I21076){ $sql ="UPDATE cms_pages SET " .$sql; $sql .= " WHERE id in (" .$IIlLI1l .I21173 .$lang_data .I21108; $db->query($sql); $adm->AddStatusMsg("group_options_apply"); }$llIIlII =$adm->Vars["grp_layout_id"]; if(!empty($llIIlII)){ $aOptions =TlIT1T1($llIIlII); $sql ="SELECT * FROM cms_layouts " .I21131 .$llIIlII .I21113 ."AND lang='" .$lang_data .I21108; $db->query($sql); if($db->next_record()){ $l1lI11l ="UPDATE cms_pages SET "; for ($i =1; $i <= $template_blocks_number; $i++){ $l1lI11l .= I21109 .$i .I21126 .addslashes($db->Record[I21109 .$i .I21152]) .I21103; }$l1lI11l .=" last_changed='" .DateTools::toMysqlDate(time()) .I21103 ." lay_id='" .$llIIlII .I21103 ." block_mask='0'"; $l1lI11l .=" WHERE " ." lang='$lang_data'"; $sql =$l1lI11l .I21174 .$IIlLI1l .") AND lay_id != '" .$llIIlII .I21108; $db->query($sql); $sql ="SELECT id, sb_data FROM cms_pages WHERE id in (" .$IIlLI1l .I21168; $db->query($sql); $db2 =new DB_SI; while ($db->next_record()){ $aPageOptions =unserialize($db->Record["sb_data"]); if(is_array($aPageOptions)){ $aOptions =array_merge($aPageOptions, $aOptions); }$sql ="UPDATE cms_pages SET sb_data='" .serialize($aOptions) .I21175 .$db->Record[I21099] .I21108; $db2->query($sql); }$adm->AddStatusMsg("group_layout_apply"); }else {$adm->AddStatusMsg("group_layout_apply_fail"); }}if(!empty($adm->Vars["grp_generate_link"]) && ($adm->Vars["grp_generate_link"] == I21105)){ $sql =I21176 .I21177 .$IIlLI1l .I21173 .$lang_data .I21108; $db->query($sql); $aPages =Array(); $l1lI11L =Array(); $llI11l1 =Array(); $l1lI111 =Array(); while ($db->next_record()){ if(($db->Record["parent_id"] >0) && ($db->Record[I21099] >0)){ $aPageIds[] =$db->Record[I21099]; $l1lI11L[] =$db->Record["parent_id"]; $llI11l1[] =$db->Record["name"]; $l1lI111[] =$db->Record[I21121]; }}$l1llIII =true; while ($l1llIII){ $l1llIII =false; foreach($l1lI11L as $key => $l1llIIl){ if(( $l1llIIl >0 )&& !in_array($l1llIIl, $aPageIds)){ $sql ="SELECT parent_id, script_link from cms_pages " .I21131 .$l1llIIl .I21108; $db->query($sql); $IIl1I1L =I21065; $name =$llI11l1[$key]; $module_name =$l1lI111[$key]; if($db->next_record() && $db->Record[I21178] >0){ $IIl1I1L =$db->Record[I21122]; }$IIl1I1L =TlIT1I1($IIl1I1L); $forcedLink =I21065; $aVirtualLinks =$adm->Core->GetModProperty(I21079, "virtual_links"); $aUsedVirtualModules =$adm->Core->GetModOption(I21079, I21143); foreach($aVirtualLinks as $masterModuleName => $aVirtualModules){ if(isset($aVirtualModules[$adm->VarsPost[I21121]])){ if(in_array($adm->VarsPost[I21121], $aUsedVirtualModules)){ $forcedLink =$aVirtualModules[$adm->VarsPost[I21121]]; }break; }}$IIl1l11 =$adm->GenAutoLink($name, $IIl1I1L, ($lang_data == "ru") ?true :false, $forcedLink); $IIl1l11 =PrepareSublink($IIl1l11); $IIl1LII =$adm->TTTTll1($IIl1l11, $aPageIds[$key], true, false, false, I21065, 0, I21065, $module_name); if($IIl1LII <0){ $IIl1l11 =TlIT1lT($IIl1l11, $aPageIds[$key]); }if($module_name == I21142 && $adm->Core->GetModOption('common_settings', 'slash_static_sublink') && !TlIT1Il($IIl1l11)){ $IIl1l11 .=I21078; }$sql ="UPDATE cms_pages SET " ."script_link = '" .$IIl1l11 .I21113 .I21131 .$aPageIds[$key] .I21113 ."AND lang='" .$lang_data .I21108; $db->query($sql); $aPageIds[$key] =0; $l1lI11L[$key] =0; $l1llIII =true; break; }}}$adm->AddStatusMsg("group_generate_link_apply"); }if(!empty($adm->Vars["grp_generate_keywords"]) && ($adm->Vars["grp_generate_keywords"] == I21105)){ $IIILL11 =0; $IIILL1L ="force"; $l1llIIL =I21065; if(!empty($adm->Vars["grp_generate_keywords_auto"]) && ($adm->Vars["grp_generate_keywords_auto"] == I21105)){ $l1llIIL =" AND is_kw_manual = '0'"; }$sql ="SELECT id, name, body FROM cms_pages " .I21177 .$IIlLI1l .I21173 .$lang_data .I21108 .$l1llIIL; $db->query($sql); $aPages =Array(); while ($db->next_record()){ $aPages[] =$db->Record; }foreach($aPages as $aPage){ $vId =$aPage[I21099]; $vName =$aPage["name"]; $IIILL1l =$aPage["body"]; $IIIL1II =array( "title" => I21065, I21140 => I21065, "description" => I21065 );$IIIL1Il =$IIIL1II; $IIIL1IL =array(); if($adm->TTTT1Tl($IIILL1L, $IIILL11, $IIIL1II, $IIIL1Il, $IIIL1IL, $vName, $IIILL1l)){ $IIl111I =key($IIIL1IL) .I21151 .$IIIL1IL[key($IIIL1IL)] .I21103; $aVars =TlT1IlT($adm, $db, I21079, $vId, removeSpecial($IIIL1Il[I21179], "html")); $aVars["object_name"] =$aVars["current_page_name"]; $lL1L1L1 =addslashes(TlT1IlI($adm, I21079, $aVars, $IIIL1Il[I21179])); $sql ="UPDATE cms_pages SET " .$IIl111I .I21180 .$lL1L1L1 ."'," ." html_keywords='" .$IIIL1Il[I21140] ."'," ." html_description='" .$IIIL1Il[I21181] .I21108 ." WHERE " ." id='" .$vId .I21108 ." AND lang='" .$lang_data .I21108; $db->query($sql); $adm->AddStatusMsg("group_generate_keywords_apply"); }}}}if(!empty($l1lIlLL[I21107]) && ($adm->Vars[I21133] == I21182)){ $pid =intval($adm->Vars[I21087]); $l1llII1 =intval($adm->Vars[I21134]); $current_id =intval($adm->Vars[I21099]); $name =$l1lIlLl["new_name"]; $lay_body_body =I21065; $l1lILL1 =I21065; $sql ="SELECT parent_id, id_site, parea_id, script_link FROM cms_pages WHERE id='" .$pid .I21110 .$lang_data ."' AND hidden=0"; $db->query($sql); $db->next_record(); $l1llIlI =I21065; if($db->Record[I21178] != 0){ $l1llIlI =trim($db->Record[I21122], I21078) .I21078; }if($adm->PManager->GetOption("allow_protected_pages")){ $l1llIll =intval($db->Record[I21183]); }$id_site =0; if($adm->Core->IsInstalled(I21092)){ if($adm->Vars["id_site"] >0){ $id_site =$adm->Vars["id_site"]; }else {$id_site =intval($db->Record["id_site"]); }}if(empty($adm->Vars[I21121]) || ($adm->Vars[I21121] == I21079) || !$adm->Core->IsFrontAllowed($adm->Vars[I21121])) $module_name =I21079; else {$module_name =$adm->Vars[I21121]; $lay_body_body =I21123; }if(empty($llIIlII) || $l1llII1 == 0) $sql ="SELECT * FROM cms_layouts WHERE lang='" .$lang_data ."' AND hidden=0 ORDER BY is_default DESC LIMIT 1"; else $sql ="SELECT * FROM cms_layouts WHERE id='" .$llIIlII .I21110 .$lang_data ."' AND hidden=0"; $l1llIlL =false; $db->query($sql); if($db->next_record()){ $llIIlII =$db->Record[I21099]; for ($i =1; $i <= $template_blocks_number; $i++) $adm->VarsPost[I21109 .$i .I21152] =jparse($db->Record[I21109 .$i .I21152]); $l1llIlL =true; }$aOptions =TlIT1T1($llIIlII); if($l1llIlL && !empty($name) && $pid >0){ $l1lILI1 =I21065; for ($i =1; $i <= $template_blocks_number; $i++) $l1lILI1 .= I21109 .$i .I21126 .$adm->VarsPost[I21109 .$i .I21152] .I21103; $sql ="INSERT INTO cms_pages SET " ."parent_id='$pid', " .I21124 .TlIT1TI($pid) .I21103 ."name='$name', " ."module_name = '$module_name'," ."lay_id='$llIIlII', " ."script_link='', " ."body='$lay_body_body', "; $sql .= $l1lILI1; if($adm->PManager->GetOption("allow_protected_pages")){ $sql .= "parea_id = '" .$l1llIll .I21103; }$sql .= "removable = '1', " ."hidden = '0', " ."fixed_name = '0', " .I21184 .serialize($aOptions) .I21103 ."public='1', " .I21167 .DateTools::toMysqlDate(time()) .I21103 .Tree::TI11T11($adm->VarsPost) ."use_noindex='" .(isset($adm->VarsPost["use_noindex"]) && $adm->VarsPost["use_noindex"] == I21105 ?I21105 :I21159) .I21103 .I21185 .(isset($adm->VarsPost[I21129]) && $adm->VarsPost[I21129] == I21105 ?I21105 :I21159) .I21103 ."use_hreflang='" .(isset($adm->VarsPost["page_use_hreflang"]) && $adm->VarsPost["page_use_hreflang"] == I21105 ?I21105 :I21159) .I21103 ."id_site='$id_site', " ."lang='$lang_data'"; $db->query($sql); $adm->Vars[I21087] =$db->lastInsertId(); $adm->AddStatusMsg("status_add"); $sql ="UPDATE cms_pages SET " ."script_link = '" .$l1llIlI ."page" .$adm->Vars[I21087] .($adm->Core->GetModOption('common_settings', 'slash_static_sublink') ?I21186 :I21076) .I21103 ."position = '" .$adm->Vars[I21087] .I21113 .I21131 .$adm->Vars[I21087] .I21108; $db->query($sql); if($pid != $current_id){ $sql ="SELECT position FROM cms_pages " .I21131 .$current_id .I21108; $db->query($sql); if($db->next_record()){ $position =$db->Record[I21112]; $sql ="SELECT id, position FROM cms_pages " ."WHERE parent_id='" .$pid .I21113 .I21187 .$position .I21113 ."ORDER BY position DESC"; $db->query($sql); $aPositions =Array(); while ($db->next_record()){ $aPositions[$db->Record[I21099]] =$db->Record[I21112]; $newPosition =$db->Record[I21112]; }foreach($aPositions as $key => $value){ $sql ="UPDATE cms_pages SET " ."position = '" .$newPosition .I21113 .I21131 .$key .I21108; $db->query($sql); $newPosition =$value; }}}$l1lIlLI =true; $variables["page_created"] =1; }else {$adm->AddStatusMsg(I21188, I21102); }}if(!empty($l1lIlLL[I21090]) && ($adm->Vars[I21087] >0 && $adm->Vars[I21133] == "del")){ $pid =0; $sql ="SELECT parent_id, removable,position, fixed_name FROM cms_pages WHERE id = '" .$adm->Vars[I21087] ."' AND lang='$lang_data'"; $db->query($sql); if($db->next_record()){ $pid =$db->Record[I21178]; $position =$db->Record[I21112]; }if(!empty($adm->Vars["selId"]) && ($adm->Vars["selId"] >0)){ $l1llIl1 =$adm->Vars[I21087]; }else {$l1llIl1 =$IIlLI1l; }$sql ="SELECT id, name, parent_id, removable, position, fixed_name FROM cms_pages WHERE id in (" .$l1llIl1 .") AND lang='$lang_data'"; $db->query($sql); $l1llILI =0; while ($db->next_record()){ if($db->num_rows() == 1){ $l1llILl =$db->Record["name"]; }if(($db->Record[I21178] == 0) || ($db->Record["removable"] != I21105)){ $adm->AddStatusMsg("status_del_fail2", I21102, I21065, $db->Record["name"]); }else {$tree->deletedModulesNames =array(); $c =$tree->TI1l11I($db->Record[I21099]); foreach($tree->deletedModulesNames as $moduleName){ $module =&$Core->GetModule($moduleName); if(is_object($module)){ $module->Ill1llI =false; }}unset($tree->deletedModulesNames); $l1llILI += $c; }}$sql ="SELECT id FROM cms_pages WHERE redirect_id in (" .$IIlLI1l .") AND lang='$lang_data'"; $db->query($sql); if($db->next_record()){ $sql ="UPDATE cms_pages SET redirect_id='0' WHERE redirect_id in (" .$IIlLI1l .") AND lang='$lang_data'"; $db->query($sql); $adm->AddStatusMsg("redirects_corrected"); }if($l1llILI == 1){ $adm->AddStatusMsg("status_del", I21139, I21065, $l1llILl); }else {$adm->AddStatusMsg("status_del_mul", I21139, I21065, $l1llILI); }$sql ="SELECT id FROM cms_pages " ."WHERE id = '" .$adm->Vars["selId"] .I21108; $db->query($sql); if($db->next_record()){ $adm->Vars[I21087] =$adm->Vars["selId"]; }elseif($position){ $sql ="SELECT id FROM cms_pages " ."WHERE parent_id = '" .$pid .I21113 ."AND position < '" .$position .I21115 .$lang_data .I21108 ."ORDER BY position DESC LIMIT 1"; $db->query($sql); if($db->next_record()){ $adm->Vars[I21087] =$db->Record[I21099]; }else {$adm->Vars[I21087] =$pid; }}}$id =$adm->Vars[I21087]; $lLLL1LI =$tree->getDefaultPageIds(); $NONE =false; if($id <1 || !$tree->TI1l1lI($id, $NONE)){ $id =$lLLL1LI[$adm->lang_data]; }$tree->TI11TT1($lLLL1LI[$adm->lang_data], $id, I21065); $variables["site_map"] =$tree->table; $tree->UseModLinks =true; $tree->UseScriptLinks =true; $tree->ForcePageIdWithScriptLinks =false; $l1llILL =$tree->ll1IlIL; $tree->ll1IlIL =FALSE; $l1llIL1 =$tree->TI11TIT($tree->selectedData[I21122]); $tree->ll1IlIL =$l1llILL; $l1llI1I =call_user_func('admSessi' .I21189); if( call_user_func( array($l1llI1I, 'getUs' .'erInfo'), 'ami_efa' )){$IlLlLII =call_user_func( array('AM' .I21190, 'getAccessRi' .'ghts'), $adm->Module->Name );if(in_array('edit', $IlLlLII['actions'])){ $lLLLIII =call_user_func( array($l1llI1I, I21191 .'etVar'), 'hash' );$l1llIL1 ='ami_str' .'ict.php?ami' .'_svc=ami_auth_access&ami_env=fast&sid=' .call_user_func( 'str_ro' .'t13', mb_strlen($lLLLIII) .$lLLLIII .$l1llI1I->TlIT11l() ).'&ami_is_cached=0&&ami_locale=' .$lang_data .'&url=' .rawurlencode($l1llIL1); }}unset($l1llI1I, $IlLlLII, $lLLLIII); if(!isFullLink($l1llIL1)){ $l1llIL1 =$ROOT_PATH_WWW .$l1llIL1; }$variables[I21192] =$l1llIL1; $lllIlLL =I21076; $variables[I21193] =I21076; if(!empty($tree->selectedData[I21121]) && $tree->selectedData[I21121] != 'core'){ $oModule =$adm->Core->GetModule($tree->selectedData[I21121]); if(!is_object($oModule)){ $variables[I21193] =$tree->selectedData[I21141]; $tree->selectedData[I21141] =I21142; $oModule =$adm->Core->GetModule(I21142); }if($oModule->IsAdminAllowed()){ $lllIlLL =$oModule->GetAdminLink(); }}$variables[I21099] =$tree->IILIlL1; $variables[I21134] =$tree->parentId; $variables["name"] =jparse(unhtmlentities($tree->ll1Illl)); $variables["title_name"] =jparse($adm->stripLine(unhtmlentities($tree->ll1Illl), 30)); $variables["body_js"] =jparse($tree->ll1IllL); $variables[I21194] =preg_replace_callback('/(\#\#)(.+?)(\#\#)/', 'unHtmlSpecialCharsCB', htmlspecialchars($tree->selectedLay_body_body)); $variables["body"] =$tree->ll1IllL; $variables["last_changed"] =$tree->ll1Ill1; $variables[I21195] =$tree->selectedDeepLevel; $variables["allowed_menu_level"] =$adm->PManager->GetOption("allowed_menu_level"); $variables[I21112] =$tree->selectedData[I21112]; $variables[I21122] =$tree->selectedData[I21122]; $variables["hasOptions"] ='1'; $variables[I21196] =$lllIlLL; if(I21076 !== $variables[I21193]){ $variables['lay_body_body'] =str_replace(I21197, I21076, $variables['lay_body_body']); }$l1lIlLL[I21089] =(isset($tree->selectedData[I21089]) && ($tree->selectedData[I21089] == 0)) ?false :true; $l1lIlLL[I21107] =(isset($tree->selectedData[I21107]) && ($tree->selectedData[I21107] == 0)) ?false :true; $l1lIlLL[I21090] =(isset($tree->selectedData[I21090]) && ($tree->selectedData[I21090] == 0)) ?false :true; $llIIlII =$tree->selectedData["lay_id"]; $sql ="SELECT id, position FROM cms_pages " ."WHERE parent_id = '" .$variables[I21134] .I21113 ."AND position < '" .$variables[I21112] .I21115 .$lang_data .I21108 ."ORDER BY position DESC LIMIT 1"; $db->query($sql); if($db->num_rows() == 0) $variables["is_top"] =I21105; $sql ="SELECT id, position FROM cms_pages " ."WHERE parent_id = '" .$variables[I21134] .I21113 .I21187 .$variables[I21112] .I21115 .$lang_data .I21108 ."ORDER BY position ASC LIMIT 1"; $db->query($sql); if($db->num_rows() == 0) $variables[I21083] =I21105; $sql ="SELECT *  FROM cms_layouts " .I21131 .$llIIlII ."' AND lang='$lang_data' AND hidden=0"; $db->query($sql); $l1llI1l =$db->next_record(); if(!$l1llI1l){ $sql ="SELECT *  FROM cms_layouts " ."WHERE is_default=1 AND lang='$lang_data' AND hidden=0"; $db->query($sql); $l1llI1l =$db->next_record(); }if($l1llI1l){ $l1llI1L =($l1lIlLL[I21107]) ?I21065 :"_read_only"; $adm->Gui->addText(I21198, $db->Record["lay_main_body"]); $l1llI11[I21194] =$db->Record["lay_body_type"]; for ($i =1; $i <= $template_blocks_number; $i++){ if(!empty($db->Record[I21109 .$i .I21166])){ $checked =($tree->selectedData[I21104] &(1 << ($i -1) )?I21105 :I21065); $l1llI11[I21109 .$i .I21152] =$adm->Gui->getAbs("tree_page:block_name" .$l1llI1L, Array("name" => $db->Record[I21109 .$i .I21166], I21199 => $i, "checked" => $checked)); }}$variables[I21198] =jparse($adm->Gui->get(I21198, $l1llI11)); $variables["layout_id"] =$db->Record[I21099]; $variables["layout_css"] =$ROOT_PATH_WWW .$CSS_FILES_PATH_HTTP .$db->Record["css_file"]; }$variables[I21200] =$l1llI11[I21194]; if(is_array($tree->selectedData)){ foreach($tree->selectedData as $name => $val){ if(in_array($name, array('html_title', 'html_keywords', 'html_description', 'html_head_tail'))){ $variables[$name] =htmlspecialchars($val); }else {$variables[$name] =jparse(unhtmlentities($val)); }}$variables[I21201] =1; if($tree->ll1ILI1){ if($tree->idSite != $variables["id_site"]){ $variables[I21201] =0; }}$variables[I21089] =(isset($tree->selectedData[I21089]) && ($tree->selectedData[I21089] == 0)) ?0 :1; $variables[I21107] =(isset($tree->selectedData[I21107]) && ($tree->selectedData[I21107] == 0)) ?0 :1; $variables[I21090] =(isset($tree->selectedData[I21090]) && ($tree->selectedData[I21090] == 0)) ?0 :1; $variables['blocks_bodies'] =I21076; for ($i =1; $i <= $template_blocks_number; $i++){ $protected =($tree->selectedData[I21104] &(1 << ($i -1) )?I21105 :I21065); $variables["textareas"] .= $adm->Gui->getAbs( "tree_page:block_body_textarea", array( I21199 => $i, I21202 => htmlspecialchars($tree->selectedData[I21109 .$i .I21152]) ));$variables["blocks_bodies"] .= $adm->Gui->getAbs( "tree_page:block_body", Array( "name" => jparse(unhtmlentities($db->Record[I21109 .$i .I21166])), I21199 => $i, "protected" => $protected ));}}$adm->IILlIl1 =TlIT1Tl($Core, I21203, $adm->Gui->getAbs("tree_page:mod_parent_splitter", I21065), $variables[I21121]); $variables["mod_list"] =I21065; $vOwners =&$adm->Core->GetOwnersList(); foreach($vOwners as $vName => $vData){ if($adm->Core->IsOwnerInstalled($vName)){ if(isset($vData['admin_link'])){ $lllIlLL =$vData['admin_link']; }elseif(isset($vData[I21204])){ $vMod =&$adm->Core->GetModule($vData[I21204]); $lllIlLL =$vMod->GetAdminLink(); }$variables[$vName .'_link'] =$lllIlLL; }}$l1lllII =Array(); $isMultiPageAllowed =$adm->Core->issetAndTrueOption("multi_page_allowed"); foreach($adm->IILlIl1 as $l1lllIl){ $IlLI11I =&$adm->Core->GetModule($l1lllIl[I21071]); if(is_object($IlLI11I) && $isMultiPageAllowed && $IlLI11I->issetAndTrueOption("multi_page")){ $l1lllII[] =$IlLI11I->Name; }}$l1lllIL =Array(); $l1lllI1 =Array(); $l1llllI =Array(); $l1lllll =$adm->Core->GetOption("reserved_tpl_addon_names"); $l1llllL =$adm->Gui->getTemplatesList($db, I21205, "*.tpl"); $l1llll1 =$adm->Gui->getTemplatesList($db, I21206, "*.tpl"); $l1llllL =array_merge($l1llllL, $l1llll1); $oDeclarator =AMI_ModDeclarator::getInstance(); for ($li =0; $li <sizeof($l1llllL); $li++){ $entry =mb_substr($l1llllL[$li]["name"], 0, -4); foreach($l1lllII as $ModName){ if($oDeclarator->isRegistered($ModName)){ if($l1llllL[$li][I21071] != $ModName){ continue; }}if($entry == $ModName){ $l1llllI[$ModName] =$l1llllL[$li][I21099]; }if(!isset($l1lllI1[$ModName])){ $l1lllI1[$ModName] =array(); }$l1lllLI =$ModName ."_"; if(mb_substr($entry, 0, mb_strlen($l1lllLI)) == $l1lllLI){ $tplName =mb_substr($entry, mb_strlen($l1lllLI)); if(!in_array($tplName, $l1lllll)){ $l1lllIL[$ModName][] =$tplName; $l1lllI1[$ModName][] =isset($l1llllL[$li][I21099]) ?$l1llllL[$li][I21099] :I21065; }}}}$i =0; foreach($adm->IILlIl1 as $l1lllIl){ $val =array(); $val[I21207] =$l1lllIl[I21071]; if($val[I21207] == I21079){ $val[I21179] =$l1lIlLl["static_page"]; }else {$val[I21179] =$l1lllIl[I21074]; }$val[I21179] =addslashes($val[I21179]); $val[I21208] =$l1lllIl[I21073]; $val[I21070] =(int) !empty($l1lllIl[I21070]); $val["num"] =$i; $ownerName =$l1lllIl["owner"]; if($l1lllIl[I21071] == $variables[I21121]){ $val["selected"] =I21209; if($ownerName != "pmanager" && $l1lllIl["admin_link"] != I21065 && $adm->Core->IsInstalled($l1lllIl[I21071])) $variables[$ownerName ."_link"] =$l1lllIl["admin_link"]; }$val[I21210] =I21108 .$l1llllI[$l1lllIl[I21211]] .I21108; if(isset($l1lllIL[$l1lllIl[I21211]]) && is_array($l1lllIL[$l1lllIl[I21211]])){ $val["templates"] =I21065; foreach($l1lllIL[$l1lllIl[I21071]] as $idx => $l1lllLl){ $val["templates"] .= ", '" .$l1lllLl .I21108; $val[I21210] .= ", '" .$l1lllI1[$l1lllIl[I21211]][$idx] .I21108; }}$variables[I21212] .= $adm->Gui->get("tree_page:mod_row", $val); $i++; }if($variables[I21134] >0){ $val[I21207] ="redirect"; $val[I21179] =addslashes($l1lIlLl["redirect"]); $val[I21208] =I21105; $val[I21070] =0; $val["num"] =$i; $val[I21213] =I21065; $variables[I21212] .= $adm->Gui->get("tree_page:mod_row", $val); }$variables[I21212] =$adm->Gui->getAbs("tree_page:mod_list", $variables); $sql ="SELECT id, page_id,  is_active, id_owner as user, date_format(version_date, '" .$tree->ll1Il1l ."') AS vdate  FROM cms_pages_ver WHERE page_id='" .$tree->IILIlL1 ."' ORDER BY version_date DESC"; $db->query($sql); unset($val); $val =array(); $i =0; $variables['ver_list'] =I21076; $adm->Core->TTlllTT($variables['init']); while ($db->next_record()){ $val[I21099] =$db->Record[I21099]; $val["date"] =$db->Record["vdate"]; $val[I21214] =$db->Record[I21214]; $val["is_active"] =$db->Record["is_active"]; $val["num"] =$i; $variables["ver_list"] .= $adm->Gui->get(I21215, $val); $i++; }$variables["ver_list"] =$adm->Gui->getAbs("tree_page:ver_list", "ver_list", $variables["ver_list"]); $variables[I21216] =jparse($adm->GetStatusMessages()); $variables["tree_action"] =isset($action) ?$action :I21076; $variables["init"] =$adm->Gui->header(); $variables["front_path"] =$ROOT_PATH_WWW; $variables["allow_multi_lang"] =$adm->Core->GetOption(I21217); if($adm->Core->GetOption("allow_ip_limits")){ $variables["VISIBLE_AREA"] =I21105; }if(!in_array($adm->Vars[I21133], array(I21139, "draw_selected"))){ Tree::TI11ITI(I21218, $GLOBALS['db']); }$Content =$adm->Gui->get(I21219, $variables); echo $Content; $conn->Out(); 