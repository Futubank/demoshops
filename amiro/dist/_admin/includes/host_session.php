<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       76758 xkqwwxirmtnylyiznuqkyykqrlkpxqymxuqrlypxkptyxzmyskxqpuwnxgnprnwqqusnpnir
 */ ?><?php foreach(array(21274=>"~",21275=>"DOZrQS",21276=>'zsimN|gzTo|ccc',21277=>'JHPMnTBGQ',21278=>"",21279=>'uDQr',21280=>'OHDt|SZtZ',21281=>'SY|fZMJ|tDtZIG',21282=>'"',21283=>'DOZrQS',21284=>'PQt',21285=>'gzTo|mNFh',21286=>'eUqRb|dTRmNp',21287=>"Qn",21288=>"'",21289=>"SZtZ",21290=>'ZSI|DQDD',21291=>'MG',21292=>"qIGtB?uDQr?DQDDMHn",21293=>'',21294=>"ZSIMn|DtZtuD!?DtZtuD|OMDtHrB!?ZSIMn|urJ!?MS|rQDQJJQr!JMWQnWQ|tBGQ?",21295=>"ZWtMvQ",21296=>"DtZtuD|SZtQ",21297=>"'?zNs?GZDDCHrS='",21298=>'DBD|uDQr',21299=>'vZJMS',21300=>'MS',21301=>"uDQr",21302=>"OHDt|SZtZ",21303=>'GJZMn',21304=>'ODMS',21305=>'~;*0+9Z+A&-$~',21306=>'`',21307=>"?200?hk",21308=>'DQJQWt',21309=>'SHIZMn',21310=>'YZDQnZIQ',21311=>'Z',21312=>"?imNUTq{!?",21313=>'SZtZ',21314=>'YZWKurJ',21315=>'ZSIMn|urJ',21316=>"WHIIQnt",21317=>"'?zNs?I`GZDDCHrS='",21318=>"DBD|uDQr",21319=>"SHIZMn",21320=>'ZSIMn') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} if($GLOBALS["BUILDER_VERSION"] <2){ class AdmSessionBase {public $lang; public $Data; public $sid; public $idMember; public $CookieName; public $Il1IlLL; public $expTime; public $l1llLl1; public $cookiePath; public $domain; public $wwwRoot; public $l1llLLI; public $l1llLLl; public $l1llLLL; public $hash; public $indexFile; public $ip; public $aCookies; public $hostMode; public $useCache; public $l1llLL1; public $l1llL1I =false; protected $l1llL1l =FALSE; function AdmSessionBase($lang) {$this->lang =$lang; $this->Data =Array(); $this->idMember =0; $this->CookieName ="host_session_".$lang; $this->expTime =5 *24 *60; $this->l1llLl1 =10; $this->cookiePath =I21274; $this->domain =""; $this->l1llLLI =false; $this->l1llLLl =10; $this->l1llLLL =5; $this->hash ='a208'; $this->indexFile ='index.php'; $this->ip =getenv("REMOTE_ADDR"); $this->aCookies =$_COOKIE; $this->hostMode =I21275; $this->l1llLL1 =300; $this->useCache =false; $this->sid =isset($this->aCookies[$this->CookieName]) ?addslashes($this->aCookies[$this->CookieName]) :''; if($this->sid !== '' && !preg_match('/^[0-9a-z]+$/', $this->sid)){ $this->sid =''; }$this->wwwRoot =$GLOBALS[I21276]; $cookiePath =$GLOBALS['ILlII1l']; $aUrl =parse_url($cookiePath); $this->domain =$aUrl["host"]; $this->cookiePath =$aUrl["path"]; }public function TlIT1l1($isHashed){ $this->l1llL1l =(bool)$isHashed; }function TlIT11T() {return md5(getenv("REMOTE_ADDR").time().rand(1000,9999).rand(1000,9999)); }function loginType() {return $this->GetVar(I21277); }function SetLocalCookie($cName, $cValue, $l1llL1L) {$domain =mb_strpos($this->domain,'.')===false ?'' :$this->domain; $domain =preg_replace('/^(www\.)/i', '', $domain); setcookie($cName, $cValue, time() +$l1llL1L, $this->cookiePath, $domain, false, true); }function Location($url) {if(empty($url)) {trigger_error("Session::Location: empty url", E_USER_WARNING); }ob_clean(); $SERVER_PROTOCOL =getenv("SERVER_PROTOCOL"); if($SERVER_PROTOCOL =="") {$SERVER_PROTOCOL ="HTTP/1.1"; }header($SERVER_PROTOCOL." 200 OK"); ?>
            <html><head><title></title></head>
            <body>
              <script type="text/javascript">
                function amiRedirect(){
                    window.location.href='<?php echo $url; ?>';
                }
                setTimeout('amiRedirect()', 200);
              </script>
              <!--
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              -->
              </body>
            </html>
            <?php  die; }function SetVar($name,$value,$store=false) {$this->Data[$name] =$value; if($store) {$this->_save(); }}function GetVar($name){ return isset($this->Data[$name]) ?$this->Data[$name] :null; }function IssetVar($name) {return !empty($this->Data[$name]); }function UnsetVar($name,$store=false) {unset($this->Data[$name]); if($store) {$this->_save(); }}function RequireLogin($l1llL11, $wantsurl =I21278){ if (!$this->IsLoggedIn()) {if($wantsurl != I21278) {$this->SetVar("wantsurl",$wantsurl,true); }$this->Location("$l1llL11"); }return true; }function IsLoggedIn(){ return isset($this->Data['user']) && !empty($this->Data['user']['valid']); }function GetUserInfo($name =I21278) {$res =I21278; if(empty($name)) {$res =$this->Data[I21279]; }else {$res =$this->Data[I21279][$name]; }return $res; }function TlIT11I() {return $this->Data[I21279]['host_data']['domain']; }function UserId() {return $this->Data[I21279]['host_data']['id']; }function ResellerId() {return $this->Data[I21279][I21280]['id_reseller']; }function logout($script ='') {$this->SetLocalCookie('is_logged_in', '', -1); if(!empty($script)) $this->Session->Location("$script"); }function TlIT11l() {return $this->sid; }function TlIT111() {return time()-intval($this->GetVar(I21281)); }function TlIITTT() {return $this->TlIT111() <$this->l1llLL1; }function TT1lT1T($type,$sql,$dbh){ if(!$dbh) {if($this->TlIITTT()) return false; if(!($dbh =TlITllI('get',false,!$this->useCache))) {$this->SetVar(I21281,time(),true); return false; }}$res =@mysql_query($sql, $dbh); if($type=='select'){ return $res; }if(!$res) return false; return @mysql_affected_rows($dbh); }function TlIITTI($sql,$dbh=false) {return $this->TT1lT1T('select',$sql,$dbh); }function TlIITTl($sql,$dbh=false) {return $this->TT1lT1T('exec',$sql,$dbh); }function expireUserSession($id) {if(!empty($id)) {$sql ='delete from cms_sessions where id = "' .$id .'"'; }else {return; }if($this->hostMode == 'shared') {$domain =$this->TlIT11I(); $l1ll1II =TlITllI('get', false, false); $res =$this->TlIITTI('select * from cms_sessions where id = "' .$id .I21282, $l1ll1II); if(@mysql_num_rows($res)) {$data =@mysql_fetch_array($res); $aUserData =unserialize($data['data']); if($aUserData[I21279][I21280]['domain'] === $domain) {$this->TlIITTl($sql, $l1ll1II); }}$this->TlIITTl($sql, TlITllI('get', $domain, false)); }else {$this->TlIITTl($sql); }}function getSessions() {$ret =array(); $sql ='select * from cms_sessions'; if($this->hostMode == I21283) {$domain =$this->TlIT11I(); $l1ll1Il =array(); $res =$this->TlIITTI($sql, TlITllI('get', false, false)); while($data =@mysql_fetch_array($res)) {$aUserData =unserialize($data['data']); if($aUserData[I21279][I21280]['domain'] === $domain) {$l1ll1Il[$data['id']] =$data; }}$res =$this->TlIITTI($sql, TlITllI(I21284, $domain, false)); while($data =@mysql_fetch_array($res)) {$ext =$l1ll1Il[$data['id']]; $ret[] =isset($ext) ?$ext :$data; if(isset($ext)) {unset($l1ll1Il[$data['id']]); }}foreach($l1ll1Il as $data) {$ret[] =$data; }}else {$res =$this->TlIITTI($sql); while($data =@mysql_fetch_array($res)) {$ret[] =$data; }}return $ret; }function TlIITT1() {if($this->hostMode!=I21283 || !$this->IsLoggedIn()) return; $domain =$this->TlIT11I(); $sql ="SELECT admin_url FROM cms_host_users WHERE domain_orig='$domain'"; $dbh =TlITllI(I21284,false,!$this->useCache); if(!$res =$this->TlIITTI($sql,$dbh)) return; $data =@mysql_fetch_array($res); if(empty($data['admin_url'])) return; if($data['admin_url']==$this->wwwRoot) return; $pi =pathinfo($_SERVER[I21285]); $script =$pi['basename']; if(mb_strpos($script,'.php')===false) $script =''; $url =$data['admin_url'].$script; if(!empty($_SERVER[I21286])) $url .= '?'.$_SERVER[I21286]; $this->Location($url); }function TIT1IlT($str,$var=null) {$fd =@fopen('/tmp/login.dbg','a'); fputs($fd,"$str: "); if($var!=null) {ob_start(); print_r($var); $IlLLLL1 =ob_get_contents(); ob_end_clean(); @fputs($fd,$IlLLLL1); }@fputs($fd,"\n"); @fclose($fd); }}class LoginSession extends AdmSessionBase {function LoginSession($lang=I21287) {$this->AdmSessionBase($lang); }function TTTIlIT($l1ll1IL=false) {if($l1ll1IL===false) $l1ll1IL =$this->sid; $sql ="REPLACE cms_sessions (id, expired, ip, data, id_member, short_expired) ". "VALUES ('".$l1ll1IL."', DATE_ADD(NOW(), INTERVAL ".$this->expTime." MINUTE), ". I21288.$this->ip."', '".addslashes(serialize($this->Data))."',".intval($this->idMember).", DATE_ADD(NOW(), INTERVAL ".$this->expTime." MINUTE))"; if(!$this->TlIITTl($sql)) {return false; }return true; }function TTTIlIl() {$sql ="SELECT data FROM cms_sessions WHERE id='$this->sid' " .($this->l1llL1I ?I21278 :" AND ip='$this->ip'"); if(!($res =$this->TlIITTI($sql))) {return false; }$data =mysql_fetch_array($res); $aData =@unserialize($data[I21289]); if(is_array($aData)) {$this->Data =$aData; return true; }return 0; }function TlIITIT() {$sql ="DELETE FROM cms_sessions WHERE id='".$this->sid.I21288; return $this->TlIITTl($sql); }function TlIITII() {$sql ="DELETE FROM cms_sessions WHERE expired<now() AND cart_expired < now()"; return $this->TlIITTl($sql); }function TlIITIl($sid=false) {if($sid===false) $sid =$this->sid; if(!isset($_SESSION['adm_sess'])) $_SESSION['adm_sess'] =array(); $sdata =$_SESSION[I21290][$sid]; $sdata['id_member'] =$this->idMember; $sdata['expires'] =time()+$this->expTime*60; $sdata['ip'] =$this->ip; $sdata['data'] =$this->Data; $_SESSION[I21290][$sid] =$sdata; }function TlIITI1() {$sdata =$_SESSION[I21290][$this->sid]; if(!is_array($sdata) || $sdata[I21291]!=$this->ip) return false; $this->Data =$sdata['data']; return true; }function TlIITlT() {unset($_SESSION[I21290][$this->sid]); return true; }function TTTIlII() {if($this->useCache) {if(!$this->TlIITI1()) return false; $this->TTTIlIT(); return true; }return $this->TTTIlIl(); }function _save($sid=false) {if($this->useCache) $this->TlIITIl($sid); $this->TTTIlIT($sid); return true; }function TlIITlI() {$this->TlIITIT(); if($this->useCache) $this->TlIITlT(); return true; }function TlIITll() {$this->TlIITII(); if($this->useCache) {$l1ll1I1 =&$_SESSION[I21290]; $time =time(); if(is_array($l1ll1I1)) {foreach(array_keys($l1ll1I1) as $sid) if($l1ll1I1[$sid]['expires']<$time) unset($l1ll1I1[$sid]); }}return true; }function Start($useCache=false) {$this->useCache =$useCache && ($this->hostMode==I21283); if(!isset($this->sid) || empty($this->sid)) {$this->sid =$this->TlIT11T(); }if(!$this->TTTIlII()) {$this->_save(); $this->SetLocalCookie($this->CookieName,$this->sid,$this->expTime*60); $this->TlIITll(); return true; }$l1ll1lI =$this->sid; if(!empty($this->Data[I21279]['hsid'])) {$this->sid =$this->Data[I21279]['hsid']; if(!$this->TTTIlII()) {$this->Stop(); die(I21292); }}if(isset($this->Data[I21279][I21280]['admin_url'])) {$this->Data[I21279][I21280]['admin_url'] =$this->wwwRoot; }if(!$this->IssetVar('hash')){ srand(); mt_srand(); $this->SetVar('hash', mt_rand(100000, 999999)); }$this->_save(); $this->TlIITll(); $this->SetLocalCookie($this->CookieName,$l1ll1lI,$this->expTime*60); return true; }function Stop() {if(!$this->TlIITlI()) return false; $this->sid =isset($this->aCookies[$this->CookieName]) ?addslashes($this->aCookies[$this->CookieName]) :I21293; if($this->sid !== I21293 && !preg_match('/^[0-9a-z]+$/', $this->sid)){ $this->sid =I21293; }if($this->TTTIlII()) {$backurl =$this->GetUserInfo('backurl'); unset($this->Data[I21279]['hsid']); unset($this->Data[I21279]['backurl']); $this->_save(); if(empty($backurl)) $backurl =$this->indexFile; $this->Location($backurl); }$this->SetLocalCookie($this->CookieName, I21293, -1); $this->sid =I21278; }function TlIITl1($domain) {if($this->hostMode == I21275) {$lL1LlII =$domain; $domain =addslashes(($this->l1llLLI)? TlT1III($domain): $domain); $l1ll1ll =false; $sql ="SELECT id, id_member,status, flags, username, domain, home_dir, ".((defined('SELECT_MAX_MBOXES') && SELECT_MAX_MBOXES === true) ?'max_mboxes AS iteration,' :I21293). I21294. "FROM cms_host_users WHERE domain='$domain'"; $res =$this->TlIITTI($sql); $host_data =@mysql_fetch_array($res); if(!is_array($host_data)) return false; $l1ll1ll =$host_data['admin_url']; if($l1ll1ll!=I21293 && $l1ll1ll!=$this->wwwRoot) {return $l1ll1ll; }if (($host_data["status"]!=I21295)||($host_data["admin_status"]!=I21295)){ $l1ll1lL =unserialize($host_data["status_history"]); foreach($l1ll1lL as $l1ll1l1=>$l1ll1LI){ $host_data["status_comment"] =$l1ll1LI["comment"]; $host_data[I21296] =$l1ll1l1; }}$dbh =TlITllI(I21284,$lL1LlII,!$this->useCache); }else {$dbh =false; $sql ="SELECT id, id_member,username,domain FROM cms_host_users WHERE sys_user=1"; $res =$this->TlIITTI($sql); $host_data =@mysql_fetch_array($res); if($host_data===false) return false; }return array($host_data,$dbh); }function TlIIT1T($domain,$username=false,$password=false,$tstamp=0,$hsid=I21293) {$l1ll1Ll =false; $aData =array(); $aData['sys_user'] =false; $l1ll1LL =$this->TlIITl1($domain); if(!is_array($l1ll1LL)) return $l1ll1LL; list($host_data,$dbh) =$l1ll1LL; $sql ="SELECT " ."m.id, m.username, m.firstname, m.lastname, m.email, m.phone, m.address1, m.address2, " ."m.city, m.state, m.zip, m.country, m.company, m.companyweb, m.nickname, ". "`edit_front_allowed` `ami_efa` " ."FROM cms_members m "; if($username===false && $password===false) {$sql .= ", cms_host_users u WHERE m.id=u.id_member AND u.sys_user=1"; }else {if(empty($hsid)) {$sql .= "WHERE username='" .addslashes($username) .I21297 .($this->l1llL1l ?$password :md5($password)) .I21288; }else {$sql .= "WHERE active=1 AND username='".addslashes($username).I21288. " AND md5(CONCAT(password,'".addslashes($this->hash)."',". I21288.addslashes($tstamp)."'))='".addslashes($hsid).I21288; }}$res =$this->TlIITTI($sql,$dbh); $aData =@mysql_fetch_array($res); if(!is_array($aData)) return false; $aData[I21298] =$aData['id']; if(is_array($host_data)) {$aData[I21280] =$host_data; unset($aData[I21280]['status_history']); if($this->l1llLLI){ $aData[I21280]['domain'] =TlT1III($aData[I21280]['domain']); }}$aData[I21299] =true; return $aData; }function TlIIT1I($l1ll1ll) {$script =TlITlll(); $script =preg_replace('/^.*?([^\/]+\.php)$/','$1',$script); $l1ll1L1 =empty($_SERVER[I21286]) ?I21293 :'?'.$_SERVER[I21286]; header("Location: $l1ll1ll$script$l1ll1L1", true, 301); exit; }function TlIIT1l(&$_h,$domain,$username=false,$password=false) {$this->sid =$this->TlIT11T(); $this->SetVar(I21277,'daemon'); $data =$this->TlIIT1T($domain,$username,$password); if($data===false) return false; if(!is_array($data)) $this->TlIIT1I($data); $this->idMember =$data[I21300]; $this->SetVar(I21279,$data); $_h["sys_user"] =$this->Data["user"]["sys_user"]; $_h["user_dir"] =$this->Data[I21301]["host_data"]["home_dir"].$_h["postfix"]; $_h["user_domain"] =$this->Data[I21301][I21302]["domain"]; $_h["user_name"] =$this->Data[I21301]["username"]; $_h["auth"] =true; return true; }function TlIIT11($domain,$username, $password, $tstamp =0, $hsid =I21293, $backurl=I21293) {$loginType =I21303; if(empty($password) && !empty($hsid)) {$loginType ='admin'; $tstamp =intval($tstamp); }$aData =$this->TlIIT1T($domain,$username,$password,$tstamp,$hsid); if(!is_array($aData)) return $aData; if($loginType=='admin') {$udata =$this->GetVar(I21279); $udata['hsid'] =$this->TlIT11T(); $udata['backurl'] =$backurl; $this->idMember =$udata[I21300]; $this->SetVar(I21279,$udata,true); $this->sid =$udata[I21304]; }$this->idMember =$aData[I21300]; $this->SetVar(I21279, $aData); $this->SetVar(I21277, $loginType); $this->_save(); $wantsurl =$this->GetVar('wantsurl'); if(!empty($wantsurl)) {$this->UnsetVar('wantsurl',true); $this->Location($wantsurl); }return true; }function TlIIITT($l1ll11I, $l1ll11l, $IIIII1L) {$status =($IIIII1L ?'success' :'fail'); $l1ll11L ="INSERT INTO cms_host_login_history (login, id_member, domain, date, status, ip) "."VALUES ('".addslashes($l1ll11I)."', '"; $l1ll111 ="', '".addslashes($l1ll11l)."',now(),'$status','".$this->ip."')"; $sql ="SELECT id FROM cms_members WHERE username='".addslashes($l1ll11I).I21288; if(!($res=$this->TlIITTI($sql))) return; $data =@mysql_fetch_array($res); $id =intval($data[I21300]); $this->TlIITTl($l1ll11L .$id .$l1ll111); if($this->hostMode == I21275 && ($l1lLIII=TlITllI(I21284,$l1ll11l,false))!==false) {$this->TlIITTI($sql,$l1lLIII); $data =@mysql_fetch_array($res); $id =intval($data[I21300]); $this->TlIITTl($l1ll11L .$id .$l1ll111, $l1lLIII); }}}}else{ class AdmSessionBase {public $lang; public $Data; public $sid; public $idMember; public $CookieName; public $Il1IlLL; public $expTime; public $l1llLl1; public $cookiePath; public $domain; public $wwwRoot; public $l1llLLl; public $l1llLLL; public $hash; public $indexFile; public $ip; public $aCookies; public $hostMode; public $useCache; public $l1llLL1; public $l1llL1I =false; protected $l1llL1l =FALSE; function AdmSessionBase($lang) {$this->lang =$lang; $this->Data =Array(); $this->idMember =0; $this->CookieName ="host_session_".$lang; $this->expTime =5 *24 *60; $this->l1llLl1 =10; $this->cookiePath =I21274; $this->domain =I21278; $this->l1llLLl =10; $this->l1llLLL =5; $this->hash ='a208'; $this->indexFile ='index.php'; $this->ip =getenv("REMOTE_ADDR"); $this->aCookies =$_COOKIE; $this->hostMode =I21275; $this->l1llLL1 =300; $this->useCache =false; $this->sid =isset($this->aCookies[$this->CookieName]) ?addslashes($this->aCookies[$this->CookieName]) :I21293; if($this->sid !== I21293 && !preg_match(I21305, $this->sid)){ $this->sid =I21293; }$this->wwwRoot =$GLOBALS[I21276]; $cookiePath =$GLOBALS['ILlII1l']; $aUrl =parse_url($cookiePath); $this->domain =$aUrl["host"]; $this->cookiePath =$aUrl["path"]; }public function TlIT1l1($isHashed){ $this->l1llL1l =(bool)$isHashed; }function TlIT11T() {return md5(getenv("REMOTE_ADDR").time().rand(1000,9999).rand(1000,9999)); }function loginType() {return $this->GetVar(I21277); }function SetLocalCookie($cName, $cValue, $l1llL1L) {$domain =mb_strpos($this->domain,I21306)===false ?I21293 :$this->domain; $domain =preg_replace('/^(www\.)/i', I21293, $domain); setcookie($cName, $cValue, time() +$l1llL1L, $this->cookiePath, $domain, false, true); }function Location($url) {if(empty($url)) {trigger_error("Session::Location: empty url", E_USER_WARNING); }ob_clean(); $SERVER_PROTOCOL =getenv("SERVER_PROTOCOL"); if($SERVER_PROTOCOL ==I21278) {$SERVER_PROTOCOL ="HTTP/1.1"; }header($SERVER_PROTOCOL.I21307); ?>
            <html><head><title></title></head>
            <body>
              <script type="text/javascript">
                function amiRedirect(){
                    window.location.href='<?php echo $url; ?>';
                }
                setTimeout('amiRedirect()', 200);
              </script>
              <!--
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              -->
              </body>
            </html>
            <?php  die; }function SetVar($name,$value,$store=false) {$this->Data[$name] =$value; if($store) {$this->_save(); }}function GetVar($name){ return isset($this->Data[$name]) ?$this->Data[$name] :null; }function IssetVar($name) {return !empty($this->Data[$name]); }function UnsetVar($name,$store=false) {unset($this->Data[$name]); if($store) {$this->_save(); }}function RequireLogin($l1llL11, $wantsurl =I21278){ if (!$this->IsLoggedIn()) {if($wantsurl != I21278) {$this->SetVar("wantsurl",$wantsurl,true); }$this->Location("$l1llL11"); }return true; }function IsLoggedIn(){ return isset($this->Data[I21279]) && !empty($this->Data[I21279][I21299]); }function GetUserInfo($name =I21278) {$res =I21278; if(empty($name)) {$res =$this->Data[I21279]; }else {$res =$this->Data[I21279][$name]; }return $res; }function TlIT11I() {return $this->Data[I21279][I21280]['domain']; }function UserId() {return $this->Data[I21279][I21280][I21300]; }function ResellerId() {return $this->Data[I21279]['id_reseller']; }function logout($script =I21293) {$this->SetLocalCookie('is_logged_in', I21293, -1); if(!empty($script)) $this->Session->Location("$script"); }function TlIT11l() {return $this->sid; }function TlIT111() {return time()-intval($this->GetVar(I21281)); }function TlIITTT() {return $this->TlIT111() <$this->l1llLL1; }function TT1lT1T($type,$sql,$dbh){ if(!$dbh) {if($this->TlIITTT()) return false; if(!($dbh =TlITllI(I21284,false,!$this->useCache))) {$this->SetVar(I21281,time(),true); return false; }}$res =@mysql_query($sql, $dbh); if($type==I21308) return $res; if(!$res) return false; return @mysql_affected_rows($dbh); }function TlIITTI($sql,$dbh=false) {return $this->TT1lT1T(I21308,$sql,$dbh); }function TlIITTl($sql,$dbh=false) {return $this->TT1lT1T('exec',$sql,$dbh); }function expireUserSession($id) {if(!empty($id)) {$sql ='delete from cms_sessions where id = "' .$id .I21282; }else {return; }if($this->hostMode == I21283) {$domain =$this->TlIT11I(); $l1ll1II =TlITllI(I21284, false, false); $res =$this->TlIITTI('select * from cms_sessions where id = "' .$id .I21282, $l1ll1II); if(@mysql_num_rows($res)) {$data =@mysql_fetch_array($res); $aUserData =unserialize($data['data']); if($aUserData[I21279][I21280][I21309] === $domain) {$this->TlIITTl($sql, $l1ll1II); }}$this->TlIITTl($sql, TlITllI(I21284, $domain, false)); }else {$this->TlIITTl($sql); }}function getSessions() {$ret =array(); $sql ='select * from cms_sessions'; if($this->hostMode == I21283) {$domain =$this->TlIT11I(); $l1ll1Il =array(); $res =$this->TlIITTI($sql, TlITllI(I21284, false, false)); while($data =@mysql_fetch_array($res)) {$aUserData =unserialize($data['data']); if($aUserData[I21279][I21280][I21309] === $domain) {$l1ll1Il[$data[I21300]] =$data; }}$res =$this->TlIITTI($sql, TlITllI(I21284, $domain, false)); while($data =@mysql_fetch_array($res)) {$ret[] =isset($l1ll1Il[$data[I21300]]) ?$l1ll1Il[$data[I21300]] :$data; }}else {$res =$this->TlIITTI($sql); while($data =@mysql_fetch_array($res)) {$ret[] =$data; }}return $ret; }function TlIITT1() {if($this->hostMode!=I21283 || !$this->IsLoggedIn()) return; $domain =$this->TlIT11I(); $sql ="SELECT c.admin_url FROM cms_hst_res_cms_inst c INNER JOIN cms_hst_res_vhost_inst v ON v.id=c.id_vhost WHERE v.domain='$domain'"; $dbh =TlITllI(I21284,false,!$this->useCache); if(!$res =$this->TlIITTI($sql,$dbh)) return; $data =@mysql_fetch_array($res); if(empty($data['admin_url'])) return; if($data['admin_url']==$this->wwwRoot) return; $pi =pathinfo($_SERVER[I21285]); $script =$pi[I21310]; if(mb_strpos($script,'.php')===false) $script =I21293; $url =$data['admin_url'].$script; if(!empty($_SERVER[I21286])) $url .= '?'.$_SERVER[I21286]; $this->Location($url); }function TIT1IlT($str,$var=null) {$fd =@fopen('/tmp/login.dbg',I21311); fputs($fd,"$str: "); if($var!=null) {ob_start(); print_r($var); $IlLLLL1 =ob_get_contents(); ob_end_clean(); @fputs($fd,$IlLLLL1); }@fputs($fd,"\n"); @fclose($fd); }}class LoginSession extends AdmSessionBase {function LoginSession($lang=I21287) {$this->AdmSessionBase($lang); }function TTTIlIT($l1ll1IL=false) {if($l1ll1IL===false) $l1ll1IL =$this->sid; $sql ="REPLACE cms_sessions (id, expired, ip, data, id_member, short_expired) ". "VALUES ('".$l1ll1IL."', DATE_ADD(NOW(), INTERVAL ".$this->expTime.I21312. I21288.$this->ip."', '".addslashes(serialize($this->Data))."',".intval($this->idMember).", DATE_ADD(NOW(), INTERVAL ".$this->expTime." MINUTE))"; if(!$this->TlIITTl($sql)) {return false; }return true; }function TTTIlIl() {$sql ="SELECT data FROM cms_sessions WHERE id='$this->sid' " .($this->l1llL1I ?I21278 :" AND ip='$this->ip'"); if(!($res =$this->TlIITTI($sql))) {return false; }$data =mysql_fetch_array($res); $aData =@unserialize($data[I21289]); if(is_array($aData)) {$this->Data =$aData; return true; }return 0; }function TlIITIT() {$sql ="DELETE FROM cms_sessions WHERE id='".$this->sid.I21288; return $this->TlIITTl($sql); }function TlIITII() {$sql ="DELETE FROM cms_sessions WHERE expired<now() AND cart_expired < now()"; return $this->TlIITTl($sql); }function TlIITIl($sid=false) {if($sid===false) $sid =$this->sid; if(!isset($_SESSION[I21290])) $_SESSION[I21290] =array(); $sdata =$_SESSION[I21290][$sid]; $sdata['id_member'] =$this->idMember; $sdata['expires'] =time()+$this->expTime*60; $sdata[I21291] =$this->ip; $sdata['data'] =$this->Data; $_SESSION[I21290][$sid] =$sdata; }function TlIITI1() {$sdata =$_SESSION[I21290][$this->sid]; if(!is_array($sdata) || $sdata[I21291]!=$this->ip) return false; $this->Data =$sdata[I21313]; return true; }function TlIITlT() {unset($_SESSION[I21290][$this->sid]); return true; }function TTTIlII() {if($this->useCache) {if(!$this->TlIITI1()) return false; $this->TTTIlIT(); return true; }return $this->TTTIlIl(); }function _save($sid=false) {if($this->useCache) $this->TlIITIl($sid); $this->TTTIlIT($sid); return true; }function TlIITlI() {$this->TlIITIT(); if($this->useCache) $this->TlIITlT(); return true; }function TlIITll() {$this->TlIITII(); if($this->useCache) {$l1ll1I1 =&$_SESSION[I21290]; $time =time(); if(is_array($l1ll1I1)) {foreach(array_keys($l1ll1I1) as $sid) if($l1ll1I1[$sid]['expires']<$time) unset($l1ll1I1[$sid]); }}return true; }function Start($useCache=false) {$this->useCache =$useCache && ($this->hostMode==I21283); if(!isset($this->sid) || empty($this->sid)) {$this->sid =$this->TlIT11T(); }if(!$this->TTTIlII()) {$this->_save(); $this->SetLocalCookie($this->CookieName,$this->sid,$this->expTime*60); $this->TlIITll(); return true; }$l1ll1lI =$this->sid; while(!empty($this->Data[I21279][I21304]) && $i++ <10) {$this->sid =$this->Data[I21279][I21304]; if(!$this->TTTIlII()) {$this->Stop(); die(I21292); }}if(isset($this->Data[I21279][I21280]['admin_url'])) {$this->Data[I21279][I21280]['admin_url'] =$this->wwwRoot; }srand(); mt_srand(); $this->SetVar('hash', mt_rand(100000, 999999)); $this->_save(); $this->TlIITll(); $this->SetLocalCookie($this->CookieName,$l1ll1lI,$this->expTime*60); return true; }function Stop() {if(!$this->TlIITlI()) return false; $this->sid =isset($this->aCookies[$this->CookieName]) ?addslashes($this->aCookies[$this->CookieName]) :I21293; if($this->sid !== I21293 && !preg_match(I21305, $this->sid)){ $this->sid =I21293; }$l1lLIIl =$this->sid; $l1lLIIL =false; while($this->TTTIlII() && $i++ <10) {$l1lLIIL =true; $l1lLIIl =$this->sid; $this->sid =$this->Data[I21279][I21304]; }if($l1lLIIL) {$this->sid =$l1lLIIl; $backurl =$this->GetUserInfo(I21314); unset($this->Data[I21279][I21304]); unset($this->Data[I21279][I21314]); $this->_save(); if(empty($backurl)) $backurl =$this->indexFile; $this->Location($backurl); }$this->SetLocalCookie($this->CookieName, I21293, -1); $this->sid =I21278; }function TlIITl1($domain) {$domain =strval($domain); if($this->hostMode == I21275) {if($domain == '_client_') {$dbh =false; $sql ="SELECT v.docroot as home_dir, /*v.id_reseller, */v.status, c.admin_status ".((defined('SELECT_MAX_MBOXES') && SELECT_MAX_MBOXES === true) ?',max_mboxes AS iteration ' :I21293)."FROM cms_hst_res_vhost_inst v INNER JOIN cms_hst_res_cms_inst c ON v.id=c.id_vhost WHERE is_sys=1 LIMIT 1"; $res =$this->TlIITTI($sql); $host_data =@mysql_fetch_array($res); if($host_data===false) return false; $host_data[I21309] =$domain; }else {$l1ll1ll =false; $sql ="SELECT v.status, v.domain, v.docroot as home_dir, ". "c.admin_status, v.status_history, c.admin_url/*, v.id_reseller*/ ". "FROM cms_hst_res_vhost_inst v ". "INNER JOIN cms_hst_res_cms_inst c ON v.id=c.id_vhost ". "WHERE v.domain='$domain'"; $res =$this->TlIITTI($sql); $host_data =@mysql_fetch_array($res); if(!is_array($host_data)) return false; $l1ll1ll =$host_data[I21315]; if($l1ll1ll!=I21293 && $l1ll1ll!=$this->wwwRoot) {return $l1ll1ll; }$dbh =TlITllI(I21284,$domain,!$this->useCache); }if (($host_data["status"]!=I21295)||($host_data["admin_status"]!=I21295)){ $l1ll1lL =unserialize($host_data["status_history"]); foreach($l1ll1lL as $l1ll1l1=>$l1ll1LI){ $host_data["status_comment"] =$l1ll1LI[I21316]; $host_data[I21296] =$l1ll1l1; }}}else {$dbh =false; $sql ="SELECT id_client FROM cms_hst_res_vhost_inst WHERE is_sys=1 LIMIT 1"; $res =$this->TlIITTI($sql); $host_data =@mysql_fetch_array($res); if($host_data===false) return false; }return array($host_data,$dbh); }function TlIIT1T($domain,$username=false,$password=false,$tstamp=0,$hsid=I21293) {$l1ll1Ll =false; $aData =array(); $aData[I21298] =false; $l1ll1LL =$this->TlIITl1($domain); if(!is_array($l1ll1LL)) return $l1ll1LL; list($host_data,$dbh) =$l1ll1LL; $fields ="m.id, m.username, m.nickname, m.firstname, m.lastname, m.email, m.phone, m.address1, m.address2,". "m.city, m.state, m.zip, m.country, m.company, m.companyweb, m.uid "; if($username===false && $password===false) {$join =", cms_hst_res_cms_inst ci WHERE m.id=ci.id_admin AND ci.is_sys=1"; }else {$fields .= ", c.id as id_client, r.id_member as id_reseller "; $join =" LEFT JOIN cms_hst_clients c ON m.id=c.id_member AND c.is_active=1 AND c.is_reseller=0 ". "LEFT JOIN cms_hst_clients r ON m.id=r.id_member AND r.is_active=1 AND r.is_reseller=1 ". "WHERE "; if(empty($hsid)) {$join .= "m.active=1 AND m.username='" .addslashes($username) .I21317 .($this->l1llL1l ?$password :md5($password)) .I21288; }else {$join .= "m.active=1 AND m.username='".addslashes($username).I21288. " AND md5(CONCAT(password,'".addslashes($this->hash)."',". I21288.addslashes($tstamp)."'))='".addslashes($hsid).I21288; }}$sql ="SELECT $fields FROM cms_members m $join"; $res =$this->TlIITTI($sql,$dbh); $aData =@mysql_fetch_array($res); if(!is_array($aData)) return false; $aData[I21298] =$aData[I21300]; if(is_array($host_data)) {$aData[I21280] =$host_data; }$aData[I21299] =true; return $aData; }function TlIIT1I($l1ll1ll) {$script =TlITlll(); $script =preg_replace('/^.*?([^\/]+\.php)$/','$1',$script); $l1ll1L1 =empty($_SERVER[I21286]) ?I21293 :'?'.$_SERVER[I21286]; header("Location: $l1ll1ll$script$l1ll1L1", true, 301); exit; }function TlIIT1l(&$_h,$domain,$username=false,$password=false) {$this->sid =$this->TlIT11T(); $this->SetVar(I21277,'daemon'); $data =$this->TlIIT1T($domain,$username,$password); if($data===false) return false; if(!is_array($data)) $this->TlIIT1I($data); $this->idMember =$data[I21300]; $this->SetVar(I21279,$data); $_h["sys_user"] =$this->Data[I21301][I21318]; $_h["user_dir"] =$this->Data[I21301][I21302]["home_dir"].$_h["postfix"]; $_h["user_domain"] =$this->Data[I21301][I21302][I21319]; $_h["user_name"] =$this->Data[I21301]["username"]; $_h["auth"] =true; return true; }function TlIIT11($domain,$username, $password, $tstamp =0, $hsid =I21293, $backurl=I21293) {$loginType =I21303; if(empty($password) && !empty($hsid)) {$loginType ='admin'; $tstamp =intval($tstamp); }$aData =$this->TlIIT1T($domain,$username,$password,$tstamp,$hsid); if(!is_array($aData)) return $aData; if($loginType==I21320) {$udata =$this->GetVar(I21279); $udata[I21304] =$this->TlIT11T(); $udata[I21314] =$backurl; $this->idMember =$udata[I21300]; $this->SetVar(I21279,$udata,true); $this->sid =$udata[I21304]; }$this->idMember =$aData[I21300]; $this->SetVar(I21279, $aData); $this->SetVar(I21277, $loginType); $this->_save(); $wantsurl =$this->GetVar('wantsurl'); if(!empty($wantsurl)) {$this->UnsetVar('wantsurl',true); $this->Location($wantsurl); }return true; }function TlIIITT($l1ll11I, $l1ll11l, $IIIII1L) {$status =($IIIII1L ?'success' :'fail'); $l1ll11L ="INSERT INTO cms_host_login_history (login, id_member, domain, date, status, ip) VALUES ('".addslashes($l1ll11I)."', '"; $l1ll111 ="', '".addslashes($l1ll11l)."',now(),'$status','".$this->ip."')"; $sql ="SELECT id FROM cms_members WHERE username='".addslashes($l1ll11I).I21288; if(!($res=$this->TlIITTI($sql))) return; $data =@mysql_fetch_array($res); $id =intval($data[I21300]); $this->TlIITTl($l1ll11L .$id .$l1ll111); if($this->hostMode == I21275 && ($l1lLIII=TlITllI(I21284,$l1ll11l,false))!==false) {$this->TlIITTI($sql,$l1lLIII); $data =@mysql_fetch_array($res); $id =intval($data[I21300]); $this->TlIITTl($l1ll11L .$id .$l1ll111, $l1lLIII); }}}}