<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       33172 xkqwgtsruxliguzztxspwlsrplrxqywuizgrkkslinwgqsgnguukgsnxrpklklkmiigwpnir
 */ ?><?php foreach(array(22650=>"IHSuJQD",22651=>'Qnv~ZDBnW50',22652=>'DQnSIZMJ',22653=>'DQnS|tH',22654=>'?DQJQWtQS',22655=>'YHSB|fHrIZt',22656=>'ZttZWO',22657=>'MS',22658=>"'",22659=>'~;}*;?@&-{~',22660=>'"',22661=>"DuYD|DQnS",22662=>"DQnS|HnJB|ZWtMvQ",22663=>"tHGMW|MS",22664=>"IQDDZPQ",22665=>'SHIZMn',22666=>"OMDtHrB",22667=>"fHrIZt",22668=>"iZMJQr`GOG",22669=>"",22670=>'J1jJmj1',22671=>"DrW=",22672=>"`",22673=>'tBGQ',22674=>"HrMPMnZJ",22675=>"Fmjqms",22676=>"ZttZWO|SZtZ",22677=>'OtIJ',22678=>"WHIGZnB|urJ",22679=>" ZWtMHn=SQJ",22680=>"DtZtuD|fZMJQS",22681=>'OHDt|uDQrD',22682=>'JHWZJ|DMtQD',22683=>'',22684=>':D',22685=>'YHSB',22686=>'JMWQnWQ|tBGQ',22687=>'OHDt|JMWQnWQ|tBGQ',22688=>"dqjqwT?MS?",22689=>"ZJJ",22690=>"IZx|DuYD|SMrQWt",22691=>'jhNp',22692=>"?+?hK\n",22693=>"QIZMJ",22694=>"DtZtuD|EuQuQ",22695=>'JZDtnZIQ',22696=>"DuYLQWt",22697=>"ftBGQ",22698=>"SZtQ",22699=>"YHSB",22700=>'ZWtMHn',22701=>'sqjqTq?FRhi?.',22702=>"MS",22703=>"WOQWKQS",22704=>"DuYD|DQnS|JMDt",22705=>"QSMt",22706=>"Ztt|MS",22707=>"IHSuJQ",22708=>'OHDt|tQDt|IZMJ',22709=>"dqjqwT?.JMWQnWQ|tBGQ.?",22710=>"FRhi?.",22711=>'OHDt|JMWQnWQ|tBGQ|',22712=>'JZnP',22713=>"ZttZWO|MIZPQD",22714=>"OMDtHrB|QnZYJQS",22715=>"|DQJQWtQS",22716=>'uDQrnZIQ',22717=>'JHWZJ|DMtQD|JZnP',22718=>"uSZtQfrHI",22719=>"GOG",22720=>"tHGMWD",22721=>"=",22722=>"DQJQWtQS",22723=>"coqRq?1?",22724=>'fJt|IHSuJQ|YHSB|HnJB',22725=>"fJt|IHSuJQ|YHSB|HnJB",22726=>'1',22727=>"Wnt",22728=>"truQ",22729=>"EuQuQ|",22730=>"fSZtQ",22731=>"DQnS|tH",22732=>'DtZtuD',22733=>"rHC2",22734=>"nZIQ",22735=>"ZWtMHnD",22736=>"JQPQnS",22737=>"JMDt|tZYJQ",22738=>"DuYD|DQnS|DuYfHrI",22739=>"OQZSQr",22740=>'CMStO') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} $lLIlIIl =I22650; require_once $GLOBALS['DEFAULT_INCLUDES_PATH'] .files_subpath. 'init.php'; AMI::getSingleton(I22651)->init("subs_send", $adm); $send_to ='active'; $bSend =isset($adm->Vars['action']) && $adm->Vars['action'] == I22652; $adm->IILlL1L =$adm->Gui->ParseLangFile('templates/lang/_subs_send_msgs.lng'); $adm->InitMessages($adm->IILlL1L); $l1LlIll =defined('AMI_PRIVATE_MESSAGE_BROADCAST_SERVICE_DOMAIN') && (AMI_PRIVATE_MESSAGE_BROADCAST_SERVICE_DOMAIN === $GLOBALS['ROOT_PATH_WWW']); if($l1LlIll && $bSend && !empty($adm->Vars['send_to']) && ($adm->Vars[I22653] == 3 || $adm->Vars[I22653] == 4)){ if($adm->Vars[I22653] == 3){ $form['host_users_selected'] =' selected'; $send_to ='host_users'; }else{ $form['local_sites_selected'] =I22654; $send_to ='local_sites'; }$adm->VarsPost['id_topic'] =0; $adm->Vars['history'] =$adm->VarsGet['history'] =1; $adm->Vars[I22655] =0; $adm->VarsPost['attach_images'] =$adm->VarsGet['attach_images'] =0; $adm->Vars['test'] =$adm->VarsGet['test'] =0; unset($_FILES[I22656]); }if($l1LlIll){ $sql ="SELECT h.`id_member`, m.`email`, m.`username` " ."FROM `cms_host_users` h " ."JOIN `cms_members` m ON m.`id` = h.`id_member` " ."WHERE h.`sys_user` = 1"; $db->query($sql); $lIlL1I1 =$db->nextRecord(); if(!$lIlL1I1){ $lIlL1I1 =array(I22657 => 0, 'email' => '', 'username' => ''); }}function prepareHtmlImages($l1LlIlL){ global $CUSTOM_PICTURES_PATH, $CUSTOM_PICTURES_HTTP_PATH, $ROOT_PATH_WWW, $adm; $l1LlIl1 =$l1LlIlL[1][mb_strlen($l1LlIlL[1]) -1]; if($l1LlIl1 != I22658 && $l1LlIl1 != '"'){ $l1LlIl1 =''; }$l1LlILI =''; if($l1LlIl1 == ''){ $l1LlILI =I22659; }else{ $l1LlILI ='/^(.+?)'.$l1LlIl1.'/'; }if(preg_match($l1LlILI, $l1LlIlL[2], $matches)){ $fName =$matches[1]; $l1LlILl =explode('/', $fName); $l1LlILl =$l1LlILl[sizeof($l1LlILl) -1]; $l1LlILL =$adm->ReadFileExtended($CUSTOM_PICTURES_PATH, trim($fName, '"'), $CUSTOM_PICTURES_HTTP_PATH .trim($fName, I22660), trim($l1LlILl, I22660)); if($l1LlILL['status'] != 'fail'){ $GLOBALS['l1LlIL1'][] =$l1LlILL; return $l1LlIlL[1].$CUSTOM_PICTURES_HTTP_PATH.$l1LlIlL[2]; }else{ return $l1LlIlL[1].$ROOT_PATH_WWW.$CUSTOM_PICTURES_HTTP_PATH.$l1LlIlL[2]; }}else{ return ''; }}$l1LlI1I =&$adm->Core->GetModule(I22661); $ll1IILL =&$adm->Core->GetModule("subscribe"); if($ll1IILL->GetOption("topics")) {$adm->Gui->addGlobalVars(Array("TOPICS" => "1")); }$only_active =$l1LlI1I->issetOption(I22662) && $l1LlI1I->GetOption(I22662); $adm->Gui->addGlobalVars(Array("ONLY_ACTIVE" => "0")); if($only_active) {$adm->Gui->addGlobalVars(Array("ONLY_ACTIVE" => "1")); }$l1LI11I =intval($adm->Vars[I22663]); $format =intval($adm->Vars["body_format"]); $test =intval($adm->Vars["test"]); $history =intval($adm->Vars["history"]); $subject =unhtmlentities($adm->VarsPost["subj"]); $message =$adm->VarsPost[I22664]; $l1LlI1l =intval($adm->VarsPost["send_to"]); $attach_images =intval($adm->VarsPost["attach_images"]); $l1LlI1L =$adm->VarsPost["test_mail"]; if($adm->Core->HostMode() &HOSTMODE_SHARED) {$oSess =admSession(); $userInfo =$oSess->GetUserInfo(); unset($oSess); $domain =$userInfo['host_data'][I22665]; if(isset($SUBS_FROM_REPLACE) and isset($SUBS_FROM_REPLACE[$domain])) $domain =$SUBS_FROM_REPLACE[$domain]; $l1LlI11 =$l1LlI1I->getOption('from_mbox')."@$domain"; }else {$l1LlI11 =$adm->Core->GetOption("company_robot_email"); }$id_topic =$l1LI11I; if(isset($adm->VarsPost["id_topic"])) $id_topic =$adm->VarsPost["id_topic"]; if(!isset($adm->VarsPost) || sizeof($adm->VarsPost)==0) {$history =1; $test =1; }if(isset($adm->VarsGet[I22666])) $history =intval($adm->VarsGet[I22666]); if(isset($adm->VarsGet["test"])) $test =intval($adm->VarsGet["test"]); if(isset($adm->VarsGet["attach_images"])) $attach_images =intval($adm->VarsGet["attach_images"]); if(isset($adm->VarsGet[I22667]) && !empty($adm->VarsGet[I22667])) $format =intval($adm->VarsGet[I22667]); $l1LllII =$l1LlI1I->GetOption("forbidden_attach"); if($bSend) {$subject =stripslashes($subject); $message =stripslashes($message); if($format) $l1LllIl ="plain"; else $l1LllIl ="html"; require_once($GLOBALS["CLASSES_PATH"].I22668); $oMail =new Mailer(); $l1LllIL =$l1LlI1I->GetOption('mailer_mode'); $params =array(); $oMail->SetMode($l1LllIL,$params); $oMail->RecipientAddress =""; $oMail->RecipientName =""; $oMail->SenderAddress =$l1LlI11; $oMail->SenderName =$adm->Core->GetOption("company_name"); $oMail->Subject =$subject; $oMail->Body =I22669; $oMail->CopyAddress =I22669; $oMail->BodyFormat =$l1LllIl; if($l1LllIl=="html"){ if(!$attach_images){ $GLOBALS['l1LlIL1'] =array(); if($send_to != 'host_users' && $send_to != 'local_sites'){ $message =preg_replace_callback('/(<img[^>]*?[^a-zA-Z\-]src\s*?=\s*?"?\'?)'.preg_quote($ROOT_PATH_WWW, '/').preg_quote($CUSTOM_PICTURES_HTTP_PATH, '/').'(.*?>)/si', 'prepareHtmlImages', $message); }$oMail->TIT111T($GLOBALS[I22670]); }else{ if($send_to != 'host_users' && $send_to != 'local_sites'){ $message =str_replace("src=\"".$CUSTOM_PICTURES_HTTP_PATH, "src=\"".$lLI1I1L, $message); $message =str_replace(I22671.$CUSTOM_PICTURES_HTTP_PATH, I22671.$lLI1I1L, $message); }}}$l1LllI1 =false; if(is_uploaded_file($_FILES[I22656]['tmp_name'])) {$fsize =@filesize($_FILES[I22656]['tmp_name']); if( $fsize >0 && $fsize <$adm->Core->GetOption("max_upload_size") ){$extension =mb_strtolower(mb_substr(strrchr($_FILES[I22656]['name'], I22672), 1)); $found =false; foreach($l1LllII as $key) {if($key == $extension) {$found =true; break; }}if(!$found) {$II11IIl[1] =$adm->ReadFileExtended(I22669, $_FILES[I22656]['tmp_name'], $_FILES[I22656]['name'], $_FILES[I22656]['name']); $II11IIl[1]["ftype"] =$_FILES[I22656][I22673]; $oMail->AddAttachments($II11IIl); $l1LllI1 =true; @unlink($_FILES[I22656]['tmp_name']); }else {$adm->AddStatusMsg("attach_warn","red"); }}}elseif ($adm->Vars["id"] >0) {$sql ="SELECT attach, attach_data, attach_type FROM cms_subs_sent WHERE id='".$adm->Vars["id"].I22658; $db->query($sql); if($db->next_record() && $db->Record["attach"]!=I22669) {$II11IIl[1]["friendly"] =$db->Record["attach"]; $II11IIl[1][I22674] =$db->Record["attach"]; $II11IIl[1]["filename"] =$db->Record["attach"]; $II11IIl[1]["fid"] =I22675.rand(10,99)."@".uniqid(I22669); $II11IIl[1]["ftype"] =$db->Record["attach_type"]; $II11IIl[1]["fbody"] =$db->Record[I22676]; $II11IIl[1]["fsize"] =sizeof($db->Record[I22676]); $II11IIl[1]["status"] ="ok"; $oMail->AddAttachments($II11IIl); }}$adm->Gui->addBlock("letter", $GLOBALS['LOCAL_FILES_REL_PATH']."_admin/templates/letters/_subscribe_letters_" .$lang_data .".tpl"); $blockName ='letter:'.(($l1LllIl=="html") ?I22677: 'plain'); $lIIlL1I =Array(I22664=>$message, "company_name"=>$adm->Core->GetOption("company_name"), "company_url"=>$adm->Core->GetOption(I22678), "company_email"=>$adm->Core->GetOption("company_email"), "unsubscribe_link"=>$ROOT_PATH_WWW.$adm->Core->GetModFrontLink('subscribe').I22679, );if($test) {$oMail->Body =$adm->Gui->get($blockName, $lIIlL1I); $oMail->Prepare(); if($oMail->TIT11ll()) {$adm->AddStatusMsg("status_attention", "red"); }$oMail->RecipientAddress =$l1LlI1L; if($oMail->Send()){ $adm->AddStatusMsg("status_test_email",I22669,I22669,I22669,Array("email"=>$oMail->RecipientAddress)); }else{ $adm->AddStatusMsg(I22680,"red",I22669,I22669,Array("email"=>$oMail->RecipientAddress)); }}else {if($send_to == 'host_users' || $send_to == 'local_sites'){ $l1LlllI =(($send_to == I22681) ?'cms_private_message_broadcasts' :'cms_private_message_local_sites'); $oDB =AMI::getSingleton('db'); if(($send_to == I22681 && empty($adm->Vars['send_host_test'])) || ($send_to == I22682 && empty($adm->Vars['send_local_test']))){ $oQuery =DB_Query::getInsertQuery( 'cms_subs_sent', array( 'lang' => $lang_data, 'topic' => I22683, 'subject' => $subject, 'message' => $message, I22653 => $send_to, 'attempts_left' => 0, 'date' => DB_Query::getSnippet(I22684)->plain('NOW()') ));$oDB->query($oQuery); $applied_id =$lid =$oDB->getInsertId(); $l1Lllll =array( 'date_created' => DB_Query::getSnippet(I22684)->plain('NOW()'), 'header' => $subject, I22685 => $message, I22686 => $adm->Vars[I22687], 'id_broadcast' => $applied_id );if($send_to == I22682){ $l1Lllll['lang'] =$adm->Vars['local_sites_lang']; }else{ $oDB =&DB_si::admInstance(); }$oQuery =DB_Query::getInsertQuery( $l1LlllI, $l1Lllll );if($send_to == I22682){ $oDB->query($oQuery); }else{ $oDB->query($oQuery->get()); }}elseif($lIlL1I1['id_member']){ if($send_to == I22682){ $oQuery =DB_Query::getSnippet( I22688 ."FROM cms_members " ."WHERE username = %s" )->q($adm->Vars['local_test_user']); $l1LlllL =AMI::getSingleton('db')->fetchRow($oQuery); }AMI_Registry::set('ami_allow_model_save', true); $modId ='private_messages'; $oTable =AMI::getResourceModel($modId .'/table'); $oItem =$oTable->getItem(); $oItem->id_owner =$lIlL1I1['id_member']; $oItem->id_sender =0; $oItem->id_recipient =($send_to == I22682) ?$l1LlllL[I22657] :$lIlL1I1['id_member']; $oItem->is_broadcast =1; $oItem->header =$subject; $oItem->b_body =$message; try{ $oItem->save(); PrivateMessages_EmailNotifier::send($oItem->getId()); }catch(AMI_ModTableItemException $e){ }unset($oItem, $oTable); }unset($oQuery, $oDB); if($send_to == I22681){ $adm->AddStatusMsg('status_host_users_broadcast_sent'); }else{ $adm->AddStatusMsg('status_local_sites_broadcast_sent'); }}else{ if($only_active) {$l1Llll1 ="csm.active=1"; $send_to ="active"; }else {switch($l1LlI1l) {case 0: $l1Llll1 ="1"; $send_to =I22689; break; case 2: $send_to ="inactive"; $l1Llll1 ="(csm.active=0 or cm.active=0)"; break; default: $send_to ="active"; $l1Llll1 ="(csm.active=1 and cm.active=1)"; break; }}$sql ="SELECT email, username, firstname, lastname ". "FROM cms_members cm, cms_subs_members csm ". "WHERE lang='$lang_data' AND $l1Llll1 AND csm.id_member=cm.id "; if($id_topic >0) {$sql .= "AND position(concat(';','".$id_topic."',';') IN csm.topics)>0 "; }$sql .= "ORDER BY date desc"; $db->query($sql); $l1LllLI =$db->num_rows(); $l1LllLl =($l1LllLI >$l1LlI1I->GetOption(I22690)) || (isset($adm->VarsPost["queue"])); if($l1LllLI >0) {$log ="Queued date: ".date($adm->DFMT["php"])."\nDetails:\n"; while($db->next_record()) {set_time_limit(30); $conn->SetBenchType(I22691); if(!$l1LllLl) {$oMail->RecipientAddress =$db->Record["email"]; $aData =$db->Record +$lIIlL1I; $oMail->Body =$adm->Gui->get($blockName, $aData); $oMail->Prepare(); if($oMail->Send()){ $adm->AddStatusMsg("status_sent",I22669,I22669,I22669,Array("email"=>$oMail->RecipientAddress)); $log .= $db->Record["email"].I22692; }else{ $adm->AddStatusMsg(I22680,"red",I22669,I22669,Array("email"=>$oMail->RecipientAddress)); $log .= $db->Record["email"]." - Fail\n"; }}else {$log .= $db->Record[I22693]." - Fail\n"; }}$log .= "End of details.\n"; if($history == 1) {if($id_topic >0) {$sql ="SELECT name FROM cms_subs_topic WHERE lang='$lang_data' AND id='$id_topic'"; $db->query($sql); $db->next_record(); $topic =$db->Record["name"]; }else {$topic =$adm->IILlL1L["all_topics"]; }if($l1LllLl) {$adm->AddStatusMsg(I22694); }$aData =array('username'=>'__username__','firstname'=>'__firstname__',I22695=>'__lastname__') +$lIIlL1I; $oMail->Body =$adm->Gui->get($blockName, $aData); $oMail->Prepare(); $asql =Array( "lang"=>$lang_data, "id_topic"=>$id_topic, "topic"=>$topic, I22696=>addslashes($subject), I22664=>addslashes($message), I22667=>$format, "attach_images"=>$attach_images, "attach"=>$II11IIl[1][I22674], I22676=>addslashes($II11IIl[1]["fbody"]), "attach_type"=>addslashes($II11IIl[1][I22697]), "send_to"=>$send_to, "attempts_left"=>$l1LlI1I->GetOption("attempts"), "log"=>$log, I22698=>"=|NOW()", "headers"=>addslashes("Subject: ".$oMail->TIT11lT($oMail->Subject)."\r\n".$oMail->GetHeaders()), I22699=>addslashes($oMail->_MailBody) );unset($II11IIl); unset($oMail); $sql =$db->GenInsertSQL("cms_subs_sent", $asql); unset($asql); $db->query($sql); $lid =$db->lastInsertId(); $applied_id =$lid; }}else {$adm->AddStatusMsg("no_subscribers","red"); }}}unset($adm->Vars["id"]); }if($adm->Vars[I22657] >0 && isset($adm->Vars[I22700]) && $adm->Vars[I22700] == 'del'){ $sql ="SELECT `id`, `send_to` FROM `cms_subs_sent` WHERE id = " .(int)$adm->Vars[I22657] ." AND (`send_to` = 'host_users' OR `send_to` = 'local_sites')"; $l1LllLL ='status_del'; $db->query($sql); while($db->next_record()){ if($db->Record[I22653] == I22681){ $oDB =&DB_si::admInstance(); $l1LlllI ='cms_private_message_broadcasts'; $oDB->query( DB_Query::getSnippet('DELETE FROM `'.$l1LlllI.'` WHERE `id_broadcast` = %s') ->q((int)$adm->Vars[I22657]) ->get() );}else{ $oDB =AMI::getSingleton('db'); $l1LlllI ='cms_private_message_local_sites'; $oDB->query( DB_Query::getSnippet(I22701.$l1LlllI.'` WHERE `id_broadcast` = %s') ->q((int)$adm->Vars[I22657]) );}if($db->Record[I22653] == I22681 && $oDB->affectedRows()){ $l1LllLL ='status_host_users_broadcast_deleted'; }elseif($oDB->getAffectedRows()){ $l1LllLL ='status_local_sites_broadcast_deleted'; }unset($oDB); }$sql ="DELETE FROM cms_subs_sent WHERE id='".$adm->Vars[I22702].I22658; $db->query($sql); $adm->AddStatusMsg($l1LllLL); unset ($adm->Vars[I22702]); }$form["action"] ="sendmail"; $form[I22666] =$history; $form["test"] =$test; $form["history_checked"] =($history) ?I22703 :I22669; $adm->Gui->addBlock("subs_send_form","templates/form.tpl"); $adm->Gui->addBlock("subs_send_subform", "templates/subs_send_form.tpl"); $adm->Gui->addBlock(I22704,"templates/subs_send_list.tpl"); $l1LllL1 =$adm->Gui->ParseLangFile("templates/lang/subs_send.lng"); if(isset($adm->Vars[I22702]) && $adm->Vars[I22702]>0 && isset($adm->Vars["action"]) && $adm->Vars["action"] == I22705) {$sql ="SELECT * FROM cms_subs_sent WHERE lang='$lang_data' AND id='".$adm->Vars[I22702].I22658; $db->query($sql); if($db->num_rows()){ $db->next_record(); $form[I22702] =$db->Record[I22702]; $attach_images =$db->Record["attach_images"]; $format =$db->Record[I22667]; $id_topic =$db->Record["id_topic"]; $subject =$db->Record[I22696]; $send_to =$db->Record["send_to"]; $message =$db->Record[I22664]; if($db->Record["attach"] != I22669) {$l1Lll1I[I22706] =$form[I22702]; $l1Lll1I["name"] =$db->Record["attach"]; $l1Lll1I[I22707] =I22661; $form["attach"] =$adm->Gui->get("subs_send_subform:attach", $l1Lll1I); }if($l1LlIll){ $form[I22708] =$lIlL1I1['email']; if($send_to == I22681 || $send_to == I22682){ $l1LlllI =(($send_to == I22681) ?'cms_private_message_broadcasts' :'cms_private_message_local_sites'); $oQuery =DB_Query::getSnippet( I22709 .(($send_to == I22682) ?', `lang`' :I22683) .I22710.$l1LlllI."` " ."WHERE `id_broadcast` = %s" )->q($form[I22657]); $l1Lllll =AMI::getSingleton('db')->fetchRow($oQuery); $l1Lll1l =$l1Lllll[I22686]; $form[I22711 .$l1Lll1l] =' selected="selected"'; $l1Lll1L =isset($l1Lllll[I22712]) ?$l1Lllll[I22712] :I22683; }}}}$form["tid"] =$l1LI11I; $form[I22696] =$adm->htmlchars($subject); $form[I22664] =$adm->htmlchars($message); foreach($l1LllII as $key) {$form["ext_check"] .= $adm->Gui->getAbs("subs_send_subform:ext_check",Array("ext"=>$key)); }if($attach_images){ $form[I22713] =I22703; }if($format){ $form[I22667] ="1"; $form["body_format"] =I22703; $form["editor_enable"] =I22669; $form[I22713] .= " disabled"; }if($test) {$form[I22714] ="disabled"; $form["testenable"] =I22703; }if(isset($l1LlI1L) && !empty($l1LlI1L)) $form["test_mail"] =$l1LlI1L; else $form["test_mail"] =$l1LlI11; $form[$send_to.I22715] ="selected"; $form[I22681] =$l1LlIll; if($l1LlIll){ $form[I22708] =$form['local_test_mail'] =$lIlL1I1['email']; $form['local_test_user'] =$lIlL1I1[I22716]; $sql ="SELECT `lang`, `name` FROM `cms_locales` WHERE `lang` = 'ru' OR `lang` = 'en' ORDER BY lang DESC"; $db->query($sql); while($db->next_record()){ $l1Lll11 =array(); $l1Lll11[I22657] =$db->Record[I22712]; $l1Lll11['name'] =$db->Record['name']; if(empty($l1Lll1L) && !empty($adm->Vars['local_sites_lang'])){ $l1Lll1L =$adm->Vars[I22717]; }$l1Lll11['selected'] =($l1Lll11[I22657] == $l1Lll1L) ?'selected' :I22683; $form["local_sites_langs_list"] .= $adm->Gui->get("subs_send_subform:local_sites_lang_row", $l1Lll11); }}$l1LlIII =$adm->TTITI1T(I22704); if(isset($applied_id) && $applied_id>0){ $result =DateTools::TT1lI11($udate, $adm->Vars[I22718], $adm->Vars["udateto"]); if($result !== false){ $adm->Vars["datefrom"] =date($adm->DFMT["php"], $adm->Vars[I22718]); $adm->Vars["dateto"] =date($adm->DFMT[I22719], $adm->Vars["udateto"]); $adm->Filter->UpdateField("datefrom", $adm->Vars[I22718]); $adm->Filter->UpdateField("dateto", $adm->Vars["udateto"]); }}if($ll1IILL->GetOption(I22720)){ $l1LI111 =&$adm->Core->GetModule("subs_topic"); $l1LI111->PushPager($adm->Pager); $l1LI111->InitPager($adm->Pager); $sql ="SELECT id, name FROM cms_subs_topic WHERE active=1 AND lang='$lang_data' ORDER BY ".$adm->Pager->TI1TTlT("name"); $db->query($sql); $aTopics =$adm->Filter->TITIl11($db, I22702, "name", 35); $aTopics =$adm->Filter->TITI1TT($aTopics, Array($adm->Words[I22689]=>0), 35); $adm->Filter->AddField(I22663, "select", $l1LI11I, I22669, I22721, "id_topic", $aTopics); $adm->Filter->MoveField(I22663, _MOVE_START); if($db->num_rows() >0) $db->seek(); while($db->next_record()) {$topic_form =Array(); $topic_form[I22702] =$db->Record[I22702]; $topic_form["name"] =$adm->stripLine(strip_tags($db->Record["name"]), 45); $topic_form["selected"] =($topic_form[I22702]==$id_topic) ?I22722 :I22669; $form["topics_list"] .= $adm->Gui->get("subs_send_subform:topic_row", $topic_form); }$l1LlIII["topics_list"] =$adm->Gui->get("subs_send_list:topics_list", $topics_list); $l1LI111->PopPager($adm->Pager); $l1LI111->TTlITlT(); if($l1LI11I==0) $adm->Filter->DisableFieldSQL(I22663); }$filter =I22723; $filter .= "AND lang='$lang_data' ".$adm->Filter->GetFilterSql(); $filter .= "ORDER BY ".$adm->Pager->TI1TTlT(I22698).", date desc, id asc "; $sql ="SELECT id FROM cms_subs_sent sh $filter "; $db->query($sql); $adm->Pager->MaxCount =$db->num_rows(); if(isset($applied_id) && $applied_id>0){ $adm->Pager->Position =$adm->Pager->TI1TT1l($db, I22702, $applied_id); }$adm->Pager->TI1TT1I(); $adm->Filter->UpdateField("offset", $adm->Pager->Position); if(!empty($adm->Vars[I22724])){ $adm->Filter->AddField(I22725, "hidden", I22726, I22683, I22669, I22669, I22669, 0, 0); }$lll1lII =$adm->Pager->GetPager(); $pager =$adm->Pager->GetPagerHtml( $lll1lII, "javascript:go_page('[START]');"); $sql ="SELECT csm.active, count(*) as cnt FROM cms_members cm INNER JOIN cms_subs_members csm ON csm.id_member=cm.id ". "WHERE lang='$lang_data' GROUP BY csm.active"; $db->query($sql); while($db->next_record()) {if($db->Record["active"]==1) {$l1LlLII =intval($db->Record["cnt"]); }else {$l1LlLIl =intval($db->Record[I22727]); }}$form["queue_all"] =(($l1LlLII +$l1LlLIl) >$l1LlI1I->GetOption(I22690)) ?"true" :"false"; $form["queue_active"] =($l1LlLII >$l1LlI1I->GetOption(I22690)) ?I22728 :"false"; $form["queue_inactive"] =($l1LlLIl >$l1LlI1I->GetOption(I22690)) ?I22728 :"false"; $form["queue_disabled"] =($form[I22729.$send_to] == I22728) ?"disabled" :I22669; if($adm->Pager->MaxCount>0){ $sql ="SELECT id, subject, topic, send_to, attach, attempts_left, date_format(sh.date,'".$adm->DFMT["db_dtime"]."') as fdate ". "FROM cms_subs_sent sh $filter ".$adm->Pager->TI1TTlI(); $db->query($sql); $i =1; while($db->next_record()) {$l1LlII1 =Array(); $lid =$db->Record[I22702]; $l1LlII1[I22702] =$db->Record[I22702]; $l1LlII1[I22698] =$db->Record[I22730]; $l1LlII1[I22696] =$adm->htmlchars($db->Record[I22696]); $l1LlII1["topic"] =$db->Record["topic"]; $l1LlII1["send_to"] =$l1LllL1[$db->Record["send_to"]]; if($db->Record[I22731] != I22681 && $db->Record[I22731] != I22682){ $l1LlII1['status'] =$l1LllL1[(($db->Record["attempts_left"]==0) ?'sent' :'queued')]; }else{ $l1LlII1[I22732] =$l1LllL1['status_saved']; }$links["act_id"] =$links["edit_id"] =$links["del_id"] =$lid; $style =I22733; if($i%2) $style="row1"; if($adm->Vars[I22702]>0 && $adm->Vars[I22702] == $lid) $style ="row3"; if($lid == $applied_id) $style ="row4"; if($db->Record["attach"] != I22669) {$l1Lll1I[I22706] =$lid; $l1Lll1I[I22734] =$db->Record["attach"]; $l1Lll1I[I22707] =I22661; $l1LlII1["attach"] =$adm->Gui->get("subs_send_list:attach",$l1Lll1I); }$actions =$adm->Gui->get("subs_send_list:icons_edit_del",$links); $l1LlII1[I22735] =$actions; $l1LlII1["style"] =$style; $l1LlIII["history_list"] .= $adm->Gui->get("subs_send_list:row",$l1LlII1); $i++; }$l1LlIII["legend"] .= $adm->Gui->getAbs("subs_send_list:leg_attach",I22669); $l1LlIII["legend"] .= $adm->Gui->getAbs("subs_send_list:leg_yellow",I22669); $l1LlIII["legend"] .= $adm->Gui->getAbs("subs_send_list:leg_blue",I22669); $l1LlIII[I22736] .= $adm->Gui->getAbs("subs_send_list:leg_edit",I22669); $l1LlIII[I22736] .= $adm->Gui->getAbs("subs_send_list:leg_del",I22669); $l1LlIII["pager"] =$pager; $html["list_table"] .= $adm->Gui->get(I22704,$l1LlIII); }else {$html[I22737] .= $adm->Gui->get("subs_send_list:empty",$l1LlIII); }$form["filter_hidden_fields"] =$adm->Filter->GetFieldsAsHidden(); $form["cancel"] =$adm->Gui->getAbs("subs_send_subform:cancel", I22669); $l1LlLIL =$adm->Gui->get(I22738, $form); $html["form"] .=$adm->Gui->getAbs("spacer",I22669); $html["form"] .= $adm->Gui->getAbs("subs_send_form",Array(I22739=>$adm->Words["sendsubs_form"],"content"=>$l1LlLIL,"form_align"=>"align=center", I22740 => '100%')); unset($adm->Filter); AMI::getSingleton(I22651)->finalize($adm, $l1LlI1I, $html); require $GLOBALS['DEFAULT_INCLUDES_PATH'] .'done.php'; 