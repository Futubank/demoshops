<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       19400 xkqwkwllxgnrulptipmsgpupgmnlsqgsmgmwuguzglwlwzrwwnszpggglqywsumpswulpnir
 */ ?><?php foreach(array(22887=>'MnMt`GOG',22888=>"CA|SQDMPnD",22889=>"Nh|ca|sqd|wzTd",22890=>"ZWtMHn",22891=>"OQZSQr",22892=>"coqRq?MS='",22893=>"YJuQ",22894=>"ZSS",22895=>"ZutOHr",22896=>"YHSB",22897=>"^",22898=>"WJZBHutD",22899=>"DtZtuD|ZSS",22900=>"ZGGJB",22901=>"WZtQPHrB",22902=>"MS",22903=>"WID|CA|SQDMPn|WZt",22904=>"IuJtMWZt",22905=>"DtZtuD|ZGGJB|fZMJ",22906=>"GuYJMDO",22907=>"'",22908=>"tQIGJZtQD~fHrI`tGJ",22909=>"SMDZYJQS",22910=>"SY",22911=>"fSZtQ",22912=>"fHJSQr|GZtO",22913=>"DQJQWtQS",22914=>"CA|SQDMPn|WZt",22915=>"",22916=>"nZIQ",22917=>"WZtQPHrMQD|JMDt",22918=>"uSZtQfrHI",22919=>"GOG",22920=>"WZt|MS",22921=>"WnZIQ",22922=>"GuY|MS",22923=>"SQD|JMDt%GuYJMW|Hn",22924=>"rHC3",22925=>"DtBJQ",22926=>"JQPQnS",22927=>"SQD|JMDt%JQP|QSMt",22928=>"JMDt|tZYJQ",22929=>"WHntQnt",22930=>"SQD|DuYfHrI",22931=>"ZJMPn=WQntQr") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} $lLIlIIl ="wizard"; require_once $GLOBALS['DEFAULT_INCLUDES_PATH'] .files_subpath. I22887; require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_file_system.php"); require_once $GLOBALS['CLASSES_PATH'] .'Layouts.php'; $l1Ll1Il =&$adm->Core->GetModule(I22888); $l1Ll1IL =&$adm->Core->GetModule("wz_design_layouts"); $adm->Gui->addGlobalVars(Array("NO_WZ_DES_CATS"=>"0")); if(!$l1Ll1Il->GetOption("multicat")){ $adm->Gui->addGlobalVars(Array(I22889=>"1")); }$adm->Words =$adm->Gui->ParseLangFile("templates/lang/wz_designs.lng"); $adm->InitMessages($adm->Gui->ParseLangFile("templates/lang/_wz_des_msgs.lng")); $Layout =new Layouts($adm, $lLI1Il1); $cid =intval($adm->Vars["cat_id"]); if($adm->Vars[I22890] == "update") {$sql ="SELECT id, header, folder_path FROM cms_wz_designs ". "WHERE lang='$lang_data'"; $db->query($sql); $l1Ll1I1=0; $l1Ll1lI=0; $I1lI1LL =Array(); while($db->next_record()) {$I1lI1LL[] =$db->Record; }foreach($I1lI1LL as $aLayout) {$lay_id =$aLayout["id"]; $l1Ll1ll =$aLayout["folder_path"]; $l1Ll1lL =$aLayout[I22891]; if($Layout->TIT11TI($l1Ll1ll, $lay_id)) {$l1Ll1IL->PushPager($adm->Pager); $l1Ll1IL->InitPager($adm->Pager); $clayouts =$Layout->TIT11TT($lay_id); $l1Ll1IL->PopPager($adm->Pager); $l1Ll1IL->TTlITlT(); $asql =Array( "date"=>"=|NOW()", "clayouts"=>$clayouts );$sql =$db->GenUpdateSQL("cms_wz_designs", $asql, I22892.$lay_id."'"); $db->query($sql); $l1Ll1I1++; }else{ $asql =Array( "public"=>0 );$sql =$db->GenUpdateSQL("cms_wz_designs", $asql, I22892.$lay_id."'"); $db->query($sql); $l1Ll1lI++; $adm->AddStatusMsg("status_update_lay_apply_fail", "red", "", "", $aLayout); }}$adm->AddStatusMsg("status_update_apply", I22893, "", $l1Ll1I1); if ($l1Ll1lI >0){ $adm->AddStatusMsg("status_update_apply_fail", "red", "", $l1Ll1lI); }}if($adm->Vars[I22890] == I22894) {$udate =DateTools::getCorrectUDate($adm->VarsPost["date"], $adm->DFMT["conf"]); $date =date($adm->DFMT["php"], $udate); $cat =$adm->VarsPost["category"]; $author =$adm->VarsPost[I22895]; $folder_path =basename($adm->VarsPost["folder_path"]); $body =$adm->VarsPost["body"]; $I1LIlII =$adm->VarsPost[I22891]; $public =$adm->VarsPost["public"]; $Layouts =array(); if (!is_array($cat)) {$cat =array(); }$catname =$adm->VarsPost["catname"]; if(!empty($catname)) {$sql ="SELECT id FROM cms_wz_design_cat WHERE name='".$catname."'"; $db->query($sql); $db->next_record(); $l1Ll1l1 =$db->Record["id"]; if(empty($l1Ll1l1)) {$asql =Array( "name"=>$catname, "public"=>1, I22896=>"", "lang"=>$lang_data );$sql =$db->GenInsertSQL("cms_wz_design_cat", $asql); $db->query($sql); $l1Ll1l1 =$db->lastInsertId(); }$cat[] =$l1Ll1l1; }if (is_array($cat) && sizeof($cat)) {$cat =array_unique($cat); $lL1IlIl =join(";", $cat); $lL1IlIl =I22897.$lL1IlIl.I22897; }if($Layout->TIT11TI($folder_path, 0, true) && !empty($I1LIlII)) {$asql =Array( "id_cat"=>$lL1IlIl, "date"=>DateTools::toMysqlDate($udate), "folder_path"=>$folder_path, I22896=>$body, I22895=>$author, "lang"=>$lang_data, I22891=>$I1LIlII, I22898=>0, "public"=>intval($public) );$sql =$db->GenInsertSQL("cms_wz_designs", $asql); $db->query($sql); $lid =$db->lastInsertId(); $l1Ll1IL->PushPager($adm->Pager); $l1Ll1IL->InitPager($adm->Pager); $clayouts =$Layout->TIT11TT($lid); $l1Ll1IL->PopPager($adm->Pager); $l1Ll1IL->TTlITlT(); $asql =Array( I22898=>$clayouts); $sql =$db->GenUpdateSQL("cms_wz_designs", $asql, I22892.$lid."'"); $db->query($sql); $applied_id =$lid; $adm->AddStatusMsg(I22899); }else{ $adm->AddStatusMsg("status_add_fail", "red"); }}if(isset($adm->Vars["id"]) && $adm->Vars["id"]>0 && $adm->Vars[I22890] == I22900 ){$udate =DateTools::getCorrectUDate($adm->VarsPost["date"], $adm->DFMT["conf"]); $date =date($adm->DFMT["php"], $udate); $author =$adm->VarsPost[I22895]; $folder_path =basename($adm->VarsPost["folder_path"]); $cat =$adm->VarsPost[I22901]; $body =$adm->VarsPost[I22896]; $I1LIlII =$adm->VarsPost[I22891]; $public =$adm->VarsPost["public"]; if (!is_array($cat)) {$cat =array(); }$catname =$adm->VarsPost["catname"]; if(!empty($catname)) {$sql ="SELECT id FROM cms_wz_design_cat WHERE name='".$catname."'"; $db->query($sql); $db->next_record(); $l1Ll1l1 =$db->Record[I22902]; if(empty($cat)) {$asql =Array( "name"=>$catname, "public"=>1, I22896=>"", "lang"=>$lang_data );$sql =$db->GenInsertSQL(I22903, $asql); $db->query($sql); $l1Ll1l1 =$db->lastInsertId(); }$cat[] =$l1Ll1l1; }if (is_array($cat) && sizeof($cat)) {$cat =array_unique($cat); $lL1IlIl =join(I22897, $cat); $lL1IlIl =I22897.$lL1IlIl.I22897; }if($Layout->TIT11TI($folder_path, $adm->Vars[I22902]) && !empty($I1LIlII)) {$l1Ll1IL->PushPager($adm->Pager); $l1Ll1IL->InitPager($adm->Pager); $clayouts =$Layout->TIT11TT($adm->Vars[I22902]); $l1Ll1IL->PopPager($adm->Pager); $l1Ll1IL->TTlITlT(); $asql =Array( "date"=>DateTools::toMysqlDate($udate), I22896=>$body, I22895=>$author, "folder_path"=>$folder_path, "lang"=>$lang_data, I22891=>$I1LIlII, I22898=>$clayouts, "public"=>intval($public) );if($l1Ll1Il->GetOption(I22904)){ $asql["id_cat"]=$lL1IlIl; }$sql =$db->GenUpdateSQL("cms_wz_designs", $asql, I22892.$adm->Vars[I22902]."'"); $db->query($sql); $applied_id =$adm->Vars[I22902]; $adm->AddStatusMsg("status_apply"); }else{ $adm->AddStatusMsg(I22905, "red"); }unset($adm->Vars[I22902]); }if(isset($adm->Vars[I22902]) && $adm->Vars[I22902]>0 && $adm->Vars[I22890] == "del") {$sql ="DELETE FROM cms_wz_designs WHERE id='".$adm->Vars[I22902]."'"; $db->query($sql); $sql ="delete from cms_wz_design_layouts where id_design='".$adm->Vars[I22902]."'"; $db->query($sql); $adm->AddStatusMsg("status_del"); unset($adm->Vars[I22902]); }if(isset($adm->Vars[I22902]) && $adm->Vars[I22902]>0 && $adm->Vars[I22890] == "publish") {$public="0"; if (isset($adm->VarsGet[I22906]) && $adm->VarsGet[I22906] == "on") $public="1"; $sql ="UPDATE cms_wz_designs SET public='".intval($public)."' WHERE id='".$adm->Vars[I22902].I22907; $db->query($sql); $applied_id =$adm->Vars[I22902]; $adm->AddStatusMsg("status_publish"); unset($adm->Vars[I22902]); }$adm->Gui->addBlock("des_list","templates/wz_des_list.tpl"); $adm->Gui->addBlock("des_form",I22908); $adm->Gui->addBlock("des_subform", "templates/wz_des_form.tpl"); $form["date"] =date($adm->DFMT["php"]); $form[I22900] =I22909; $form[I22890] =I22894; $form["public"] ="checked"; if(isset($adm->Vars[I22902]) && $adm->Vars[I22890] == "edit" && $adm->Vars[I22902]>0) {$sql ="SELECT *, DATE_FORMAT(date,'".$adm->DFMT[I22910]."') AS fdate FROM cms_wz_designs ". I22892.$adm->Vars[I22902]."' AND lang='$lang_data'"; $db->query($sql); if($db->next_record()) {$form[I22902] =$db->Record[I22902]; $form["public"] =""; $form["date"] =$db->Record[I22911]; if($db->Record["public"] == 1) $form["public"] ="checked"; $form[I22895] =$db->Record[I22895]; $form["folder_path"] =$db->Record[I22912]; $form[I22891] =$db->Record[I22891]; $form[I22896] =$adm->htmlchars($db->Record[I22896]); $form[I22894] =I22909; $form[I22890] =I22900; $form[I22900] =""; $l1LlL1l =$db->Record["id_cat"]; }}$l1Ll1LI =Array(); $sql ="SELECT folder_path FROM cms_wz_designs WHERE lang='$lang_data'"; $db->query($sql); while($db->next_record()) {$l1Ll1LI[] =$db->Record[I22912]; }$l1Ll1Ll =getDirFileList($lLI1Il1, "*", false, true); foreach ($l1Ll1Ll as $key => $value){ $vItem =Array(); $vItem["name"] =$value; if ($form[I22912] == $value ){$vItem[I22913] =I22913; }if (!in_array($value, $l1Ll1LI)){ $form["directories_list_new"] .= $adm->Gui->get("des_subform:directory_row_new", $vItem); }else{ $form["directories_list"] .= $adm->Gui->get("des_subform:directory_row", $vItem); }}if($l1Ll1Il->GetOption(I22904)){ $l1Ll1LL =&$adm->Core->GetModule(I22914); $l1Ll1LL->PushPager($adm->Pager); $l1Ll1LL->InitPager($adm->Pager); $sql ="SELECT id, name FROM cms_wz_design_cat WHERE lang='$lang_data' ORDER BY name"; $db->query($sql); $aCats =$adm->Filter->TITIl11($db, I22902, "name", 35); $aCats =$adm->Filter->TITI1TT($aCats, Array($adm->Words["all"]=>0), 35); $adm->Filter->AddField("cat_id", "select", $cid, I22915, "LIKE", "id_cat", $aCats); $adm->Filter->MoveField("cat_id", _MOVE_START); if($db->num_rows() >0) $db->seek(); while($db->next_record()) {$cat_form =Array(); $cat_form[I22902] =$db->Record[I22902]; $cat_form["name"] =$adm->stripLine($db->Record[I22916], 35); $cat_form[I22913] =($cat_form[I22902]==$l1LlL1l || (empty($l1LlL1l) && $cat_form[I22902]==$cid)) ?I22913 :I22915; $cat_form["checked"] =(($cat_form[I22902]==$l1LlL1l) || (mb_strpos($l1LlL1l, ';'.$cat_form[I22902].';') !== false) || (empty($l1LlL1l) && $cat_form[I22902]==$cid)) ?'checked="checked"' :I22915; $form[I22917] .= $adm->Gui->get("des_subform:category_row", $cat_form); }$l1Ll1L1["cat_list"] =$adm->Gui->get("des_list:categories_list",$l1LlL11); $l1Ll1LL->PopPager($adm->Pager); $l1Ll1LL->TTlITlT(); }$l1Ll1L1 =$adm->TTITI1T("des_list"); if(isset($applied_id) && $applied_id>0){ $result =DateTools::TT1lI11($udate, $adm->Vars[I22918], $adm->Vars["udateto"]); if($result !== false){ $adm->Vars["datefrom"] =date($adm->DFMT["php"], $adm->Vars[I22918]); $adm->Vars["dateto"] =date($adm->DFMT[I22919], $adm->Vars["udateto"]); $adm->Filter->UpdateField("datefrom", $adm->Vars[I22918]); $adm->Filter->UpdateField("dateto", $adm->Vars["udateto"]); }}if($cid==0 && $l1Ll1Il->GetOption(I22904)) $adm->Filter->DisableFieldSQL(I22920); $filter ="WHERE 1 "; $filter .="AND ds.lang='$lang_data' ".$adm->Filter->GetFilterSql(); $filter .= " GROUP BY ds.id "; $filter .= "ORDER BY ".$adm->Pager->TI1TTlT("date").", date desc, id desc "; $sql ="SELECT ds.id, ds.public, dc.name as cname ". "from cms_wz_designs as ds ". "left join cms_wz_design_cat as dc on dc.id=ds.id_cat ". "$filter"; $db->query($sql); $adm->Pager->MaxCount =$db->num_rows(); if(isset($applied_id) && $applied_id>0){ $adm->Pager->Position =$adm->Pager->TI1TT1l($db, I22902, $applied_id); }$adm->Pager->TI1TT1I(); $adm->Filter->UpdateField("offset", $adm->Pager->Position); $lll1lII =$adm->Pager->GetPager(); $pager =$adm->Pager->GetPagerHtml( $lll1lII, "javascript:go_page('[START]');" );if($adm->Pager->MaxCount>0){ $l1Ll11I =array(); $sql ="SELECT id, name FROM cms_wz_design_cat ORDER BY name"; $db->query($sql); while($db->next_record()) {$l1Ll11I[$db->Record[I22902]] =$db->Record[I22916]; }$sql ="SELECT ds.id AS id, ds.id_cat, ds.folder_path AS folder_path, ds.public AS public, header, author, date_format(date,'".$adm->DFMT[I22910]."') AS fdate, dc.name AS cname, clayouts ". "FROM cms_wz_designs AS ds ". "LEFT JOIN cms_wz_design_cat AS dc ON (dc.id=ds.id_cat OR ds.id_cat LIKE CONCAT('%;',dc.id,';%')) ". "$filter ".$adm->Pager->TI1TTlI(); $db->query($sql); $i=1; while($db->next_record()) {$lid =$db->Record[I22902]; $id_cat =$db->Record["id_cat"]; if (intval($id_cat)) {$l1Ll11l["cname"] =$adm->stripLine($db->Record["cname"], 35); }else {$l1Ll11l["cname"] =I22915; $l1Ll11L =explode(I22897, mb_substr($id_cat, 1, mb_strlen($id_cat)-2)); foreach($l1Ll11L as $l1Ll111) {if ($l1Ll11l[I22921]) $l1Ll11l[I22921] .= ", "; $l1Ll11l[I22921] .= $adm->stripLine($l1Ll11I[$l1Ll111], 35); }}$l1Ll11l["date"] =$db->Record[I22911]; $l1Ll11l[I22895] =$adm->stripLine($db->Record[I22895], 35); $l1Ll11l[I22891] =$adm->stripLine($db->Record[I22891], 35); $l1Ll11l[I22912] =$db->Record[I22912]; $l1Ll11l[I22898] =$db->Record[I22898]; $links["del_id"] =$links["edit_id"] =$links[I22922] =$links["arch_id"] =$lid; $links["view_link"] =$ROOT_PATH_WWW.$l1Ll1Il->GetFrontLink()."?faction=show_layouts&id=$lid"; if($db->Record["public"] == 1) $l1Ll11l["public"] =$adm->Gui->get(I22923,$links); else $l1Ll11l["public"] =$adm->Gui->get("des_list:public_off",$links); $style ="row2"; if($i%2) $style="row1"; if($adm->Vars[I22902]>0 && $adm->Vars[I22902] == $lid) $style =I22924; if($lid == $applied_id) $style ="row4"; $actions =$adm->Gui->get("des_list:icon_view_external",$links); $actions .= $adm->Gui->get("des_list:icons_edit_del",$links); $l1Ll11l["actions"] =$actions; $l1Ll11l[I22925] =$style; $l1Ll1L1["des_list"] .= $adm->Gui->get("des_list:row",$l1Ll11l); $i++; }$l1Ll1L1["legend"] =$adm->Gui->getAbs("des_list:published",I22915); $l1Ll1L1[I22926] .= $adm->Gui->getAbs("des_list:notpublished",I22915); $l1Ll1L1[I22926] .= $adm->Gui->getAbs("des_list:leg_yellow",I22915); $l1Ll1L1[I22926] .= $adm->Gui->getAbs("des_list:leg_blue",I22915); $l1Ll1L1[I22926] .= $adm->Gui->getAbs("des_list:leg_view",I22915); $l1Ll1L1[I22926] .= $adm->Gui->getAbs(I22927,I22915); $l1Ll1L1[I22926] .= $adm->Gui->getAbs("des_list:leg_del",I22915); $l1Ll1L1["pager"] =$pager; $html["list_table"] =$adm->Gui->get("des_list",$l1Ll1L1); }else {$html[I22928] =$adm->Gui->get("des_list:empty",$l1Ll1L1); $html[I22928] .= $adm->Gui->getAbs("spacer",I22915); }$html[I22928] .=$adm->Gui->getAbs("spacer",I22915); $form["cid"] =$cid; $form["filter_hidden_fields"] =$adm->Filter->GetFieldsAsHidden(); if($form[I22894] != I22909) {$l1Ll1L1 =$adm->Gui->get("des_subform", $form); $html["form"] =$adm->Gui->getAbs("des_form",Array(I22891=>$adm->Words["wz_designs_add"],I22929=>$l1Ll1L1,"form_align"=>"align=center")); }else {if($form[I22890] == I22900) {$form["cancel"] =$adm->Gui->getAbs("des_subform:cancel", I22915); }$l1Ll1L1 =$adm->Gui->get(I22930, $form); $html["form"] =$adm->Gui->getAbs("des_form",Array(I22891=>$adm->Words["wz_designs_apply"],I22929=>$l1Ll1L1,"form_align"=>I22931)); }require $GLOBALS['DEFAULT_INCLUDES_PATH'] .'done.php'; ?>