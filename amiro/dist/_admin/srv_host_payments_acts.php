<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       29212 xkqwizintppwzpksyzyxspkkymknyxsiwsnspyqtpsyrnyrywmzsxmtpwgwkuppiwigppnir
 */ ?><?php foreach(array(20462=>'WI|MnM`GOG',20463=>'wjzddqd|gzTo',20464=>'iHSuJQoHDtgZBIQntDgrHGD`GOG',20465=>'iHSuJQoHDtgZBIQntDsHWD`GOG',20466=>"QDOHG|WurrQnWB",20467=>"ВебСтолица",20468=>"SHW|nuI",20469=>"WurrQnWB|rZtQ",20470=>"DtZrt|nuI",20471=>"ZKt|DtZrt|nuI",20472=>"SHW|SZtQ",20473=>"GOG",20474=>"+1?BQZr?-?1?SZBD",20475=>"fMJtQr|tH|SZtQ",20476=>"fMJtQr|SHIZMn",20477=>"WHntrZWtHr|KGG",20478=>"Mnn",20479=>"GrHGD",20480=>"WHntrZWtHr|",20481=>"'?zNs?JMWQnWQ|tBGQ='GZMS'?",20482=>"MS",20483=>"WJMQnt|ZKt",20484=>"GQrMHS",20485=>"WOK|",20486=>"DQnS|",20487=>"",20488=>"QIZMJ",20489=>"GQrDHn",20490=>"WJMQnt|GZDDGHrt",20491=>"fMA|ZSSrQDD",20492=>"WJMQnt|fMH",20493=>"MnvHMWQ|MS",20494=>"GQrMHS|SZtQD",20495=>"SZtQ",20496=>"DtZrt|SZtQ",20497=>"WJMQnt|ZIHunt|rur",20498=>"EuZrtQr",20499=>"?-2?SZBD",20500=>"'?zNs?}",20501=>"?hR?",20502=>"GZBIQntD|MSD",20503=>"0",20504=>"tZx",20505=>"ZIHunt|",20506=>"ZIHunt",20507=>"GrMWQ|CMtO|tZx",20508=>"fHr|GQrMHS",20509=>"trZfMW",20510=>"GrMWQ",20511=>"SZtQ='",20512=>"tZx|vZJuQ",20513=>"'!?",20514=>"Qxt|MnfH?=?'",20515=>"{",20516=>"fHrI|ZWtMHn",20517=>"DQrvMWQ|nuI",20518=>"tHtZJ|tZx",20519=>"WJMQnt|tBGQ",20520=>"IZMJ|JZYQJD|JMDt",20521=>"IZMJ|rQGHrt|JMDt",20522=>"WOQWKQS",20523=>"WJMQnt|DQnS",20524=>"?",20525=>"wjzddqd|gzTo",20526=>"HrMPMnZJ",20527=>"HK",20528=>"nZIQ",20529=>"DQJf|WHGB",20530=>"WJMQntD|fHrIQS",20531=>"SHWuIQnt|JMDt",20532=>"fMJtQr|trZfMW",20533=>"fMJtQr") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} require I20462; require_once $GLOBALS['DEFAULT_INCLUDES_PATH'] .files_subpath. 'init.php'; set_time_limit(300); require_once $GLOBALS['CLASSES_PATH'] .'ValueSpelledOut.php'; require_once $GLOBALS[I20463] .I20464; require_once $GLOBALS[I20463] .I20465; require_once $GLOBALS[I20463] .'Eshop.php'; require_once $GLOBALS[I20463] .'EshopAdmin.php'; require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_format.php"); $lILlL1I =new ValueSpelledOut(); $l1LLIll =Array(); $oEshop =new EshopAdmin($adm, $l1LLIll); $oEshop->init(I20466); $l1LLIlL =round($oEshop->getCurrencyRate("RUR") /$oEshop->getCurrencyRate("USD") *1.01, 2); $l1LLIl1 =18; $Il1LL1l ="Счет-фактура.html"; $l1LLILI ="Д-"; $l1LLILl =I20467; $l1LLILL ="info@webstolica.ru"; $l1LLIL1 ="info@webstolica.ru"; $l1LLI1I =8; $l1LLI1l =20; $l1LLI1L ="Электронная версия счет-фактуры за услуги доступа к сайту"; $adm->Gui->addBlock("srv_host_payments_docs", "templates/srv_host_payments_acts.tpl"); $messages =$adm->Gui->parseLangfile("templates/lang/srv_host_payments_acts.lng"); $adm->InitMessages($messages); $l1LLI11 =$adm->Gui->getAbs("srv_host_payments_docs:page_splitter", ""); $sql ="SELECT doc_num FROM cms_host_payments_docs WHERE doc_type='2' ORDER BY date DESC LIMIT 1"; $db->query($sql); if ($db->next_record()){ $doc_num =$db->Record[I20468]+1; }else{ $doc_num =1; }if (sizeof($adm->VarsPost)==0){ $adm->VarsPost["filter_hosting"] ="1"; $adm->VarsPost["filter_trafic"] ="1"; }if (isset($adm->VarsPost[I20469]) && !empty($adm->VarsPost[I20469])){ $l1LLIlL =$adm->VarsPost[I20469]; }else{ $adm->VarsPost[I20469] =$l1LLIlL; }if (isset($adm->VarsPost["start_num"]) && !empty($adm->VarsPost["start_num"]) && (intval($adm->VarsPost["start_num"]) >$doc_num)){ $doc_num =$adm->VarsPost["start_num"]; }else{ $adm->VarsPost[I20470] =$doc_num; }if (!isset($adm->VarsPost["akt_start_num"]) || empty($adm->VarsPost["akt_start_num"])){ $adm->VarsPost["akt_start_num"] ="1"; $l1LLlII =$adm->VarsPost[I20471]; }if (!isset($adm->VarsPost["doc_date"]) || empty($adm->VarsPost["doc_date"])){ $adm->VarsPost["doc_date"] =date($adm->DFMT["php"]); $l1LLlIl =DateTools::getCorrectUDate($adm->VarsPost[I20472], $adm->DFMT["conf"]); $l1LLlIl =strtotime( "-1 day", mktime(0,0,0,date("m", $l1LLlIl),1,date("y", $l1LLlIl))); $l1LLlIL =$adm->VarsPost[I20472] =date($adm->DFMT[I20473], $l1LLlIl); }else{ $l1LLlIl =DateTools::getCorrectUDate($adm->VarsPost[I20472], $adm->DFMT["conf"]); $l1LLlIL =$adm->VarsPost[I20472] =date($adm->DFMT[I20473], $l1LLlIl); }if (!isset($adm->VarsPost["filter_from_date"]) || empty($adm->VarsPost["filter_from_date"])){ $adm->VarsPost["filter_from_date"] =date($adm->DFMT[I20473], strtotime(I20474, $l1LLlIl)); }$uDate =DateTools::getCorrectUDate($adm->VarsPost["filter_from_date"], $adm->DFMT["conf"]); $l1LLlI1 =DateTools::toMysqlDate($uDate); if (!isset($adm->VarsPost["filter_to_date"]) || empty($adm->VarsPost["filter_to_date"])){ $adm->VarsPost[I20475] =date($adm->DFMT[I20473], strtotime("+1 days", $l1LLlIl)); }$uDate =DateTools::getCorrectUDate($adm->VarsPost[I20475], $adm->DFMT["conf"]); if ($uDate >$l1LLlIl){ $adm->VarsPost[I20475] =date($adm->DFMT[I20473], strtotime("+1 days", $l1LLlIl)); $uDate =DateTools::getCorrectUDate($adm->VarsPost[I20475], $adm->DFMT["conf"]); }$l1LLllI =DateTools::toMysqlDate($uDate); $l1LLlll =$adm->VarsPost[I20476]; $lILlLII =Array(); $oSess =admSession(); $aUserInfo =$oSess->GetUserInfo(); unset($oSess); if (ModuleHostPaymentsProps::TII111I($lILlLIl["props"], 1)){ $lILlLII["contractor_name"] =$lILlLIl["props"]["name"]; $lILlLII[I20477] =$lILlLIl["props"]["kpp"]; $lILlLII["contractor_inn"] =$lILlLIl["props"][I20478]; $lILlLII["contractor_jur_address"] =$lILlLIl["props"]["address"]; $lILlLII["contractor_fiz_address"] =$lILlLIl[I20479]["fiz_address"]; $lILlLII["contractor_fio"] =$lILlLIl[I20479]["fio"]; }else{ trigger_error("Contractor data not found", E_USER_ERROR); }foreach($lILlLIl[I20479] as $lILLI1I => $lILLI1l){ $l1LLllL[I20480.$lILLI1I] =$lILLI1l; }$sql ="select id, domain_orig, ext_info FROM cms_host_users ". "WHERE id!='".$aUserInfo["host_data"]["id"].I20481; if (isset($l1LLlll) && !empty($l1LLlll)){ $sql .= "AND domain_orig LIKE '".$l1LLlll."%' "; }$sql .= "ORDER BY domain_orig ASC"; $db->query($sql); $lI1ll1I =Array(); while ($db->next_record()){ $lI1ll1I[$db->Record["id"]] =unserialize($db->Record["ext_info"]); $lI1ll1I[$db->Record[I20482]]["domain"] =$db->Record["domain_orig"]; }$domain =""; $l1LLll1 =0; $l1LLlLI =0; $l1LLlLl =0; $l1LLlLL =0; $IIl1lLI =new DB_SI; foreach($lI1ll1I as $l1LLlL1=>$l1LLl1I){ if (empty($l1LLl1I[I20479]["name"])) continue; $l1LLl1I[I20479][I20483]="1"; if (!isset($l1LLl1I[I20479]["period"]) || ($l1LLl1I[I20479]["period"]=="")){ $l1LLl1I[I20479][I20484] ="month"; }foreach($l1LLl1I[I20479] as $l1LLl1l => $l1LLl1L){ $l1LLl11["client_".$l1LLl1l] =$l1LLl1L; }$domain =$l1LLl1I["domain"]; $l1LLLII =isset($adm->VarsPost["chk_".$l1LLlL1]) && ($adm->VarsPost[I20485.$l1LLlL1]=="1"); $l1LLLIl =($l1LLl1I[I20479]["type"] != "person" )&& isset($adm->VarsPost["send_".$l1LLlL1]) && ($adm->VarsPost[I20486.$l1LLlL1]=="1"); $l1LLLIL =""; $l1LLLI1 =""; $l1LLLlI =true; $lILlLII["client_disabled"] =I20487; $lILlLII["client_check"] =I20487; $lILlLII["client_send"] =I20487; $lILlLII[I20468] =I20487; $lILlLII["akt_num"] =I20487; $lILlLII["hosting_price_with_tax"] =0; $lILlLII["trafic_price_with_tax"] =0; $lILlLII["total_price"] =0; $lILlLII["total_tax"] =0; $lILlLII["total_price_with_tax"] =0; $lILlLII[I20482] =$l1LLlL1; $lILlLII["domain"] =$domain; $lILlLII[I20488] =$l1LLl1I[I20479][I20488]; $lILlLII[I20484] =$messages["for_".$l1LLl1I[I20479][I20484]]; $lILlLII[I20472] =$l1LLlIL; $lILlLII["client_name"] =$l1LLl1I[I20479]["name"]; if ($l1LLl1I[I20479]["type"]==I20489){ $lILlLII["client_jur_address"] =$l1LLl1I[I20479]["fiz_address"]; $lILlLII["client_fiz_address"] =$l1LLl1I[I20479]["post_address"]; $lILlLII[I20490] =$l1LLl1I[I20479]["passport"]; }elseif ($l1LLl1I[I20479]["type"]=="ip"){ $lILlLII["client_jur_address"] =$l1LLl1I[I20479][I20491]; $lILlLII["client_fiz_address"] =$l1LLl1I[I20479][I20491]; $lILlLII[I20490] =I20487; }else{ $lILlLII["client_jur_address"] =$l1LLl1I[I20479]["address"]; $lILlLII["client_fiz_address"] =$l1LLl1I[I20479][I20491]; $lILlLII[I20490] =I20487; }$lILlLII["client_post_address"] =$l1LLl1I[I20479]["post_address"]; $lILlLII["client_inn"] =$l1LLl1I[I20479][I20478]; $lILlLII["client_kpp"] =$l1LLl1I[I20479]["kpp"]; $lILlLII[I20492] =$l1LLl1I[I20479]["fio"]; $sql ="select id, date, doc_num, SUM(amount) as amount from cms_host_payments_docs WHERE id_user='".$l1LLlL1."' AND doc_type='2' AND date='".DateTools::toMysqlDate(DateTools::getCorrectUDate($l1LLlIL, $adm->DFMT["conf"]))."' GROUP BY doc_num ORDER BY doc_num DESC LIMIT 1"; $db->query($sql); $l1LLLll =false; if ($db->next_record()){ $l1LLLlL =DateTools::toMysqlDate(strtotime($db->Record["date"])); $lILlLII["period_dates"] =date($adm->DFMT[I20473], strtotime($db->Record["date"])); if ($lILlLII["period_dates"] == $l1LLlIL){ $l1LLLll =true; $lILlLII[I20493] =$db->Record[I20482]; $lILlLII[I20468] =$l1LLILI.$db->Record[I20468]; $lILlLII["doc_num_int"] =$db->Record[I20468]; $lILlLII["amount"] =FormatNumber($db->Record["amount"], 2); $lILlLII["date"] =$lILlLII[I20494]; if ($l1LLl1I[I20479][I20483]=="1"){ $lILlLII["akt_num"] =$l1LLILI.$db->Record[I20468]; }}}else{ $l1LLLl1 =false; $sql ="select date from cms_host_payments_docs WHERE id_user='".$l1LLlL1."' AND doc_type='2' ORDER BY date DESC LIMIT 1"; $db->query($sql); if ($db->next_record()){ $l1LLLlL =DateTools::toMysqlDate(strtotime($db->Record[I20495])); $lILlLII[I20494] =date($adm->DFMT[I20473], strtotime($db->Record[I20495])); }else{ $sql ="select date, start_date from cms_host_payments_history WHERE id_user='".$l1LLlL1."' AND payment_type>100 ORDER BY date ASC LIMIT 1"; $db->query($sql); if ($db->next_record()){ if ($db->Record["start_date"]!="0000-00-00"){ $l1LLLlL =DateTools::toMysqlDate(strtotime($db->Record[I20496])); $lILlLII[I20494] =date($adm->DFMT[I20473], strtotime($db->Record[I20496])); }else{ $l1LLLlL =DateTools::toMysqlDate(strtotime($db->Record[I20495])); $lILlLII[I20494] =date($adm->DFMT[I20473], strtotime($db->Record[I20495])); }}else{ $l1LLLlL =$l1LLlI1; $lILlLII[I20494] =I20487; }}}$sql ="select amount_month from cms_host_payments WHERE id_user='".$l1LLlL1."'"; $db->query($sql); if ($db->next_record()){ $l1LLl1I["amount_month"] =$db->Record["amount_month"]; }if (floatval($l1LLl1I[I20479][I20497]) >0){ $lILlLII["client_monthly_payment"] =FormatNumber($l1LLl1I[I20479][I20497], 2); }else{ $lILlLII["client_monthly_payment"] =FormatNumber($l1LLl1I["amount_month"], 2); }$l1LLLLI =date($adm->DFMT[I20473], strtotime("+1 days", strtotime($l1LLLlL))); $l1LLLLl =date($adm->DFMT[I20473], $l1LLlIl); if (($l1LLl1I[I20479][I20484] == I20498) && (!in_array(date("m", $l1LLlIl), Array(12, 3, 6, 9)))){ $lILlLII["client_disabled"] ="disabled"; }$l1LLLLL ="-1 month"; $l1LLLL1 =DateTools::toMysqlDate(strtotime($l1LLLLL.I20499, $l1LLlIl)); $l1LLL1I =0; while (($l1LLLL1 >$l1LLLlL) && ($l1LLL1I <100)){ $l1LLLL1 =DateTools::toMysqlDate(strtotime($l1LLLLL, strtotime($l1LLLL1))); $l1LLL1I++; }$lILlLII["periods_number"] =$l1LLL1I; if (($l1LLl1I[I20479][I20484] == "year") && ($l1LLL1I <12)){ }if (!$l1LLLll){ $sql ="select ph1.id from cms_host_payments_history ph1 join cms_host_payments_history ph2 on ph1.id_payment=ph2.id ". "WHERE ph2.id_contractor='1' AND ph1.id_user='".$l1LLlL1.I20500.(($adm->VarsPost["filter_hosting"]=="1")?"ph1.payment_type='101'":"0").I20501.(($adm->VarsPost["filter_trafic"]=="1")?"ph1.payment_type='102'":"0").") AND ph2.payment_type='1' "; if (isset($l1LLLlL) && !empty($l1LLLlL)){ $sql .= "AND ph1.date > DATE_ADD('".$l1LLLlL."', INTERVAL 2 DAY) AND ph2.date < DATE_ADD('".DateTools::toMysqlDate($l1LLlIl)."', INTERVAL 0 DAY) "; }if (isset($l1LLllI) && !empty($l1LLllI)){ $sql .= "AND ph1.date < DATE_ADD('".$l1LLllI."', INTERVAL 1 DAY) "; }$db->query($sql); $lILlLII["payments_ids"] =I20487; while ($db->next_record()){ if (!empty($lILlLII["payments_ids"])){ $lILlLII["payments_ids"] .= ","; }$lILlLII[I20502] .= $db->Record[I20482]; }$sql ="select MIN(ph1.start_date) as start_date, MAX(ph1.end_date) as end_date, ph1.id_user, ph1.date, SUM(ph1.amount) as amount, SUM(ph1.amount*ph1.rate) as amount_rate, ph1.payment_type from cms_host_payments_history ph1 join cms_host_payments_history ph2 on ph1.id_payment=ph2.id ". "WHERE ph2.id_contractor='1' AND ph1.id_user='".$l1LLlL1.I20500.(($adm->VarsPost["filter_hosting"]=="1")?"ph1.payment_type='101'":"0").I20501.(($adm->VarsPost["filter_trafic"]=="1")?"ph1.payment_type='102'":I20503).") AND ph2.payment_type='1' "; if (isset($l1LLLlL) && !empty($l1LLLlL)){ $sql .= "AND ph1.date > DATE_ADD('".$l1LLLlL."', INTERVAL 2 DAY) AND ph2.date < DATE_ADD('".DateTools::toMysqlDate($l1LLlIl)."', INTERVAL 0 DAY) "; }if (isset($l1LLllI) && !empty($l1LLllI)){ $sql .= "AND ph1.date < DATE_ADD('".$l1LLllI."', INTERVAL 1 DAY) "; }$sql .= "GROUP BY ph1.payment_type"; $db->query($sql); $l1LLL1l =0; $lILlLII["total_manual_price_with_tax"] =I20487; while ($db->next_record()){ $payment_type =$db->Record["payment_type"]; $aRow =Array(); $aRow[I20504] =$l1LLIl1; $aRow["client_dog_no"] =$l1LLl1I[I20479]["client_dog_no"]; $l1LLLLI =date($adm->DFMT[I20473], strtotime($db->Record[I20496])); $l1LLLLl =date($adm->DFMT[I20473], strtotime($db->Record["end_date"])); if ($payment_type==101){ $lILlLII[I20494] =$l1LLLLI." - ".$l1LLLLl; }if (floatval($adm->VarsPost[I20505.$l1LLlL1]) >0 ){$price_value =round(floatval($adm->VarsPost[I20505.$l1LLlL1]), 2); $aRow["price_with_tax"] =round($price_value +$aRow["price_with_tax"], 2); $lILlLII["total_manual_price_with_tax"] =$adm->VarsPost[I20505.$l1LLlL1]; }else if(($db->Record["payment_type"]==101)&&(floatval($l1LLl1I[I20479][I20497])>0)){ $l1LLL1L =-$db->Record[I20506] /$l1LLl1I["amount_month"]; $price_value =round($l1LLl1I[I20479][I20497] *$l1LLL1L, 2); $aRow["price_with_tax"] =round($price_value, 2); }else{ $price_value =round(-$db->Record["amount_rate"], 2); $aRow["price_with_tax"] =round($price_value +$aRow[I20507], 2); }$aRow["price"] =round($price_value/(100+$l1LLIl1)*100, 2); $aRow["tax_value"] =round($price_value -round($price_value/(100+$l1LLIl1)*100, 2), 2); $aRow[I20494] =$l1LLLLI." - ".$l1LLLLl; if ($payment_type==101){ $lILlLII["hosting_price_with_tax"] =round(0+$lILlLII["hosting_price_with_tax"] +$aRow[I20507], 2); $aRow["service_description"] =$messages["hosting"]." ".$domain." ".$messages[I20508]." ".$aRow[I20494] ;}else{ $lILlLII["trafic_price_with_tax"] =round(0+$lILlLII["trafic_price_with_tax"] +$aRow[I20507], 2); $aRow["service_description"] =$messages[I20509]." ".$messages[I20508]." ".$aRow[I20494] ;}$lILlLII["total_price"] =round(0+$lILlLII["total_price"] +$aRow[I20510], 2); $lILlLII["total_tax"] =round(0+$lILlLII["total_tax"] +$aRow["tax_value"], 2); $lILlLII["total_price_with_tax"] =round(0+$lILlLII["total_price_with_tax"] +$aRow[I20507], 2); $lILlLII["total_price_with_tax_words"] =$lILlL1I->TlTTTll($lILlLII["total_price_with_tax"], $adm->lang); if ($aRow[I20507]>0){ $l1LLL1l++; if ($l1LLLII && ($adm->VarsPost["form_action"]=="check")){ $lILLI1L =array_merge($l1LLl11,$l1LLllL); $sql ="INSERT INTO cms_host_payments_docs SET ". "id_user='".$l1LLlL1."', ". "doc_type='2', ". "id_contractor='1', ". I20511.DateTools::toMysqlDate($l1LLlIl)."', ". "amount='".$aRow[I20507]."', ". "amount_tax='".$aRow[I20512]."', ". "payment_type='".$payment_type."', ". "doc_num='".$l1LLILI.$doc_num.I20513. "note='".$aRow["service_description"].I20513. "tmp='0', ". "modified_date=NOW(), ". I20514.addslashes(serialize($lILLI1L))."'"; $IIl1lLI->query($sql); if ($payment_type=='101'){ $l1LLL11 =$IIl1lLI->lastInsertId(); $sql ="UPDATE cms_host_payments_history SET id_invoice='".$l1LLL11."' WHERE id in (".$lILlLII[payments_ids].I20515; $IIl1lLI->query($sql); }$l1LLLll =true; $lILlLII[I20468] =$l1LLILI.$doc_num; $lILlLII["doc_num_int"] =$doc_num; $lILlLII[I20506] =FormatNumber($lILlLII["total_price_with_tax"], 2); $lILlLII[I20495] =date($adm->DFMT[I20473], $l1LLlIl); $adm->VarsPost[I20470] =$doc_num+1; }else{ $l1LLll1++; if ($l1LLl1I[I20479][I20483]=="1"){ $l1LL1II++; }}$aRow["service_num"] =$l1LLL1l; $aRow[I20507] =FormatNumber($aRow[I20507], 2); $aRow[I20510] =FormatNumber($aRow[I20510], 2); $aRow[I20512] =FormatNumber($aRow[I20512], 2); }}}else{ if ($l1LLLIl && (($adm->VarsPost[I20516]=="print") || ($adm->VarsPost[I20516]=="send")|| ($adm->VarsPost[I20516]=="print_labels"))) {$sql ="select * from cms_host_payments_docs WHERE id_user='".$l1LLlL1."' AND doc_type='2' AND doc_num='".$lILlLII["doc_num_int"]."'"; $db->query($sql); $l1LLL1l=0; while($db->next_record()){ $l1LLL1l++; $aRow =Array(); $aRow[I20504] =$l1LLIl1; $aRow["client_dog_no"] =$l1LLl1I[I20479]["client_dog_no"]; $aRow[I20517] =$l1LLL1l; $aRow[I20507] =FormatNumber($db->Record[I20506], 2); $aRow[I20510] =FormatNumber($db->Record[I20506] -$db->Record["amount_tax"], 2); $aRow[I20512] =FormatNumber($db->Record["amount_tax"], 2); $aRow["service_description"] =$db->Record["note"]; $l1LLLIL .= $adm->Gui->get("srv_host_payments_docs:doc_sf_row_".$adm->lang, $aRow); $lILlLII["total_price"] =round(0+$lILlLII["total_price"] +$db->Record[I20506] -$db->Record["amount_tax"], 2); $lILlLII["total_tax"] =round(0+$lILlLII[I20518] +$db->Record["amount_tax"], 2); $lILlLII["total_price_with_tax"] =round(0+$lILlLII["total_price_with_tax"] +$db->Record[I20506] ,2); $lILlLII["total_price_with_tax_words"] =$lILlL1I->TlTTTll($lILlLII["total_price_with_tax"], $adm->lang); $l1LLll1++; if ($l1LLl1I[I20479][I20483]=="1"){ $l1LLLI1 .= $adm->Gui->get("srv_host_payments_docs:doc_akt_row_".$adm->lang, $aRow); $l1LL1II++; }}}}$lILlLII["total_price"] =FormatNumber($lILlLII["total_price"]); $lILlLII[I20518] =FormatNumber($lILlLII[I20518]); $lILlLII["total_price_with_tax"] =FormatNumber($lILlLII["total_price_with_tax"]); if ($l1LLL1l >0 ){if ($l1LLLIl && ($adm->VarsPost[I20516]=="print_labels")){ $lILlLII["client_send"] ="checked"; if ($lILlLII[I20519] != "personal" && $lILlLII[I20519] != I20489){ $l1LLlLL += 1; $lILlLII["mail_number"] =$l1LLlLL; $l1LL1Il .= $adm->Gui->get("srv_host_payments_docs:mail_label_row_".$adm->lang, $lILlLII); if ($l1LLlLL%$l1LLI1I==0){ if (!empty($aHtml["mail_labels_list"])){ }$aHtml[I20520] .= $adm->Gui->getAbs("srv_host_payments_docs:mail_labels_list", Array("mail_labels_items"=>$l1LL1Il)); $l1LL1Il =I20487; }$lILlLII["mail_report_items"] .= $adm->Gui->get("srv_host_payments_docs:mail_report_row_".$adm->lang, $lILlLII); if ($l1LLlLL%$l1LLI1l==0){ if (!empty($aHtml[I20521])){ $aHtml[I20521] .= $l1LLI11; }$aHtml[I20521] .= $adm->Gui->get("srv_host_payments_docs:mail_report_list_".$adm->lang, $lILlLII); $lILlLII["mail_report_items"] =I20487; }}}if ($l1LLLII && (($adm->VarsPost[I20516]=="check") || ($adm->VarsPost[I20516]==I20487))){ $lILlLII["client_check"] =I20522; $lILlLII[I20468] =$l1LLILI.$doc_num; if ($l1LLl1I[I20479][I20483]=="1"){ $lILlLII["akt_num"] =$l1LLILI.$doc_num; if ($adm->VarsPost[I20516]==I20487){ $l1LLlLl++; }$l1LLlII++; }if ($adm->VarsPost[I20516]==I20487){ $l1LLlLI++; }$doc_num++; }if ($l1LLLIl && (($adm->VarsPost[I20516]=="send") || ($adm->VarsPost[I20516]=="print"))){ $lILlLII[I20523] =I20522; $lILlLII["doc_rows"] =$l1LLLIL; $lILlLII["akt_rows"] =$l1LLLI1; $lILlLII["self_copy"] =$messages["self_copy"].I20524.$lILlLII["client_name"]; $l1LL1IL =$adm->Gui->get("srv_host_payments_docs:doc_sf_body_".$adm->lang, $lILlLII); $l1LL1I1 =$adm->Gui->get("srv_host_payments_docs:doc_akt_body_".$adm->lang, $lILlLII); if ($l1LLLIl && $adm->VarsPost[I20516]=="send"){ require_once($GLOBALS[I20525]."Mailer.php"); $oMail =new Mailer(); $oMail->RecipientAddress =$l1LLl1I[I20479][I20488]; $oMail->RecipientName =$l1LLl1I[I20479]["name"]; $oMail->SenderAddress =$l1LLILL; $oMail->SenderName =$l1LLILl; $oMail->Subject ="[BILLING: ".$domain."] ".$l1LLI1L; $oMail->Body =$adm->Gui->get("srv_host_payments_docs:mail_body_".$adm->lang, $lILlLII); $oMail->BodyFormat ="plain"; $l1LL1IL =ModuleHostPaymentsDocs::TII1l11($adm, $lILlLII[I20493]); $II11IIl[1]["ftype"]="HTML"; $II11IIl[1]["friendly"] =$Il1LL1l; $II11IIl[1][I20526] =$Il1LL1l; $II11IIl[1]["filename"] =$Il1LL1l; $II11IIl[1]["fbody"] =$l1LL1IL; $II11IIl[1]["fsize"] =mb_strlen($l1LL1IL); $II11IIl[1]["status"] =I20527; $II11IIl[1]["fid"] ="FILEID".rand(10,99)."@".uniqid(I20487); $oMail->AddAttachments($II11IIl); if($oMail->Send()){ $adm->AddStatusMsg("status_sent",I20487,I20487,I20487,Array(I20488=>$l1LLl1I[I20479][I20528].I20524.$oMail->RecipientAddress)); $oMail->RecipientAddress =$l1LLIL1; $oMail->Send(); }else{ $adm->AddStatusMsg("status_failed","red",I20487,I20487,Array(I20488=>$oMail->RecipientAddress)); }}else{ if (!empty($l1LL1lI)){ $l1LL1lI .= $l1LLI11; }$l1LL1lI .= $l1LL1IL; if ($l1LLl1I[I20479]["type"]!=I20489){ if ($l1LLl1I[I20479][I20483]=="1"){ $l1LL1lI .= $l1LL1I1; }$l1LL1lI .= $l1LLI11; $lILlLII[I20529] =$messages[I20529].I20524.$lILlLII["contractor_name"]; $l1LL1lI .= $adm->Gui->get("srv_host_payments_docs:doc_sf_body_".$adm->lang, $lILlLII); if ($l1LLl1I[I20479][I20483]=="1"){ $l1LL1lI .= $l1LLI11; $l1LL1lI .= $adm->Gui->get("srv_host_payments_docs:doc_akt_body_".$adm->lang, $lILlLII); }}}}}if ($l1LLLll){ $l1LL1ll[I20530] .= $adm->Gui->get("srv_host_payments_docs:clients_formed_row", $lILlLII); }else if ($l1LLL1l >0){ if ($lILlLII["client_disabled"] == "disabled"){ $l1LL1ll["clients_".$l1LLl1I[I20479][I20484]] .= $adm->Gui->get("srv_host_payments_docs:clients_row", $lILlLII); }else{ $l1LL1ll["clients_".$l1LLl1I[I20479][I20484]] =$adm->Gui->get("srv_host_payments_docs:clients_row", $lILlLII).$l1LL1ll["clients_".$l1LLl1I[I20479][I20484]]; }}}if ($lILlLII["mail_report_items"] != I20487){ if (!empty($aHtml[I20521])){ $aHtml[I20521] .= $l1LLI11; }$aHtml[I20521] .= $adm->Gui->get("srv_host_payments_docs:mail_report_list", $lILlLII); $lILlLII["mail_report_items"] =I20487; }if ($aHtml[I20521] !=I20487){ $aHtml[I20521] .= $adm->Gui->get("srv_host_payments_docs:mail_report_list_end", $lILlLII); }if ($l1LL1Il != I20487){ if (!empty($aHtml[I20520])){ $aHtml[I20520] .= $l1LLI11; }$aHtml[I20520] .= $adm->Gui->getAbs("srv_host_payments_docs:mail_labels_list", Array("mail_labels_items"=>$l1LL1Il)); $l1LL1Il =I20487; }$aHtml[I20531] =$l1LL1lI; $aHtml["splitter"] =$l1LLI11; $aFilter =$adm->VarsPost; $aFilter =array_merge($aFilter, $l1LL1ll); $aFilter["filter_hosting"] =($adm->VarsPost["filter_hosting"]=="1")?I20522:I20487; $aFilter[I20532] =($adm->VarsPost[I20532]=="1")?I20522:I20487; $aFilter["sf_number"] =$l1LLll1; $aFilter["sf_formed_number"] =$l1LLlLI; $aFilter["akt_formed_number"] =$l1LLlLl; $aHtml[I20533] =$adm->Gui->get("srv_host_payments_docs:filter_".$adm->lang, $aFilter); $aHtml["status_messages"] =$adm->GetStatusMessages(); $aHtml['meta'] =$adm->Gui->getMeta('content-type'); $html =$adm->Gui->get("srv_host_payments_docs:body", $aHtml); echo $html; 