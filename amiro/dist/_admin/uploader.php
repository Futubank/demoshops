<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       5106 xkqwqmlslyswuknpxgwylrgytlsywintwtqxupgnniizqnmxmzlrsqsrirpzszpwypwspnir
 */ ?><?php foreach(array(20564=>'WI|MnM`GOG',20565=>'~|uGJHZSQr`JnP',20566=>'IZx|uGJHZS|DMAQ',20567=>'SQfZuJtD',20568=>'fMJQ',20569=>'`tIG',20570=>'|IZx|DMAQ|',20571=>'?MD?nHt?QxMDtD',20572=>"'!?'",20573=>"") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} $l1IIlLL =true; require I20564; $oDB =AMI::getSingleton('db'); $IlIlllL =AMI::getSingleton('env/cookie'); $IlIlllL->getVarsCookie(); $lang =$IlIlllL->get('user_lang'); $lngFile =realpath(dirname(__FILE__)) .'/skins/vanilla/' .AMI_iTemplate::LNG_MOD_PATH .I20565; $aLocale =AMI::getResource('env/template_sys')->parseLocale($lngFile, $lang); $demoMode =AMI::getOption('core', 'demo_mode'); $maxSize =AMI::getOption('core', I20566); if(!isset($maxSize) || ($maxSize <1)){ $maxSize =CMS_Base::ConvertToBytes(ini_get("upload_max_filesize")); }$error =false; $canUpload =true; $oUser =AMI::getSingleton('env/session')->getUserData(); if($oUser->getId()){ $tmpDir =(isset($CONFIG_INI['defaults']['upload_path'])) ?$CONFIG_INI[I20567]['upload_path'] :$GLOBALS['ROOT_PATH'] .'_mod_files/_upload/tmp'; echo '<html><body style="padding:0px; margin:0px;"><form action="uploader.php" method="POST" enctype="multipart/form-data"><input type="file" name="file" size="36" style="width: 310px;" onchange="window.frameElement.uploader.setLoading(); this.parentNode.submit();"/></form>'; $aFilesToDelete =$oDB->select(DB_Query::getSnippet("SELECT `filename_temp` FROM `cms_tmp_files` WHERE `date_expired` <= NOW()")); if(count($aFilesToDelete)){ foreach($aFilesToDelete as $aFile){ @unlink($tmpDir .'/' .$aFile['filename_temp']); }$oDB->query(DB_Query::getSnippet("DELETE FROM `cms_tmp_files` WHERE `date_expired` <= NOW()")); }if(isset($_FILES) && count($_FILES) && isset($_FILES['file'])){ $bUploaded =false; if(is_dir($tmpDir)){ $ext =get_file_ext($_FILES[I20568]['name']); $contetType =isset($_FILES[I20568]['type']) ?$_FILES[I20568]['type'] :'binary/octet-stream'; $tmpLocalFileName =uniqid() .time() .I20569; $tmpLocalName =$tmpDir .'/' .$tmpLocalFileName; $code =uniqid(); if($demoMode){ $error =$aLocale['upload_disabled_demo']; }if(!$demoMode && move_uploaded_file($_FILES[I20568]['tmp_name'], $tmpLocalName)){ if(file_exists($tmpLocalName) && (filesize($tmpLocalName) == $_FILES[I20568]['size'])){ chmod($tmpLocalName, 0666); $bOk =true; if(filesize($tmpLocalName) >$maxSize){ $error =str_replace(I20570, AMI_Lib_String::getBytesAsText($maxSize, $aLocale, 1), $aLocale['error_file_size_limit']); unlink($tmpLocalName); $bOk =false; }if($bOk){ $oDB->query( DB_Query::getSnippet("INSERT INTO `cms_tmp_files` SET `code` = %s, `filename_temp` = %s, `filename` = %s, `content_type` = %s, `date_expired` = DATE_ADD(NOW(), INTERVAL 1 HOUR)") ->q($code) ->q($tmpLocalFileName) ->q($_FILES[I20568]['name']) ->q($contetType) );$bUploaded =true; }}else {trigger_error('Temporary file '.$tmpLocalName.' is not exists or corrupted', E_USER_WARNING); }}else {trigger_error('Failed move '.$_FILES[I20568]['tmp_name'].' to '.$tmpLocalName, E_USER_WARNING); }}else {trigger_error('Temporary dir '.$tmpDir.I20571, E_USER_WARNING); }if($bUploaded){ $name =AMI_Lib_String::htmlChars($_FILES[I20568]['name']); $size =AMI_Lib_String::getBytesAsText($_FILES[I20568]['size'], $aLocale, 1); echo "<script>window.frameElement.uploader.setUploaded('" .$code ."', '" .$name .I20572 .$size ."');</script>"; }else{ echo "<script>window.frameElement.uploader.setError(" .($error ?("'" .$error ."'") :I20573) .");</script>"; }}echo "</body></html>"; }