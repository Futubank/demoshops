<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       39753 xkqwmzmqklynmirxumimysmimyxzyziwltzpswmslnxiuluzgriplpsnwsgpnglsyliupnir
 */ ?><?php foreach(array(331=>"Qn",332=>"WHnf",333=>":I~:S~:b",334=>'IHSuJQD',335=>'KY',336=>'WZGtMHn',337=>'DMSQ',338=>'IHSuJQ|JMnK',339=>'Qnv~tQIGJZtQ|DBD',340=>'|JHWZJ~|ZSIMn~tQIGJZtQD~JZnP~IHSuJQD~|IQnu`JnP',341=>'|JHWZJ~|ZSIMn~tQIGJZtQD~JZnP~IHSuJQD~|OQZSQrD`JnP',342=>'QDOHG|MtQI',343=>'%',344=>'ZJJ',345=>'HCnQr',346=>'MnDtZJJQS',347=>'JZnP',348=>'DuY',349=>'ZSIMn|IQnu|ZJJHCQS',350=>'rQDiHSQ',351=>'',352=>'GJPmS',353=>'GJuPMn|MS',354=>'JMnK',355=>'IHSuJQD|SZtZDQtD',356=>'IHSuJQD|WuDtHI|fMQJSD',357=>'MtQID',358=>'unKnHCn',359=>'PrG',360=>'?%',361=>'IZrKQr',362=>'vZr?ZiZMniHSuJQD?=?',363=>'^',364=>'vZr?Z60iHSuJQD?=?',365=>'"^',366=>'vZr?DrvhGtMHnDdQZrWOTOMDiHSuJQ?=?"',367=>'Drv|HGtMHnD|DQZrWO|tOMD|IHSuJQ',368=>'vZr?DrvhGtMHnDNHtmnDtZJJQS?=?"',369=>'Drv|HGtMHnD|nHt|MnDtZJJQS',370=>'GZrQnt',371=>"IHSuJQ",372=>"WZGtMHn",373=>"HGQnQS",374=>"DWrMGt",375=>"DGJMttQr|ZftQr",376=>"",377=>"+",378=>'SZtQ|fMQJS',379=>'IHSuJQ',380=>'+',381=>"ZSS|SZtQ|GrQfMx",382=>'wjzddqd|gzTo',383=>"~",384=>"IHSuJQ|nZIQ",385=>"DWrMGt|JMnK",386=>"|IHSuJQ|nZIQ",387=>"|frHnt|JMnK",388=>'IMn|KQBCHrS|JQnPtO',389=>'?',390=>"~*'\"&-~",391=>"?",392=>"`?",393=>"MD|KC|IZnuZJ",394=>"KQBCHrSD") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class Admin extends CMS_Base {public $IIIlLLl; public $Owner; public $ActivePage; public $ActiveScript; public $StatusMsgs; public $Messages; public $IIIlLLL; public $IIIlLL1; public $DFMT; public $Pager; public $Filter; public $IIIlL1I; public $frn; public $IIIlL1l =array(); public $IIIlL1L; public $IIIlL11 =false; function Admin(&$IIIl1II, $IIIl1Il ="") {parent::CMS_Base($IIIl1II, $IIIl1Il); $this->lang ="en"; $this->lang_data =I331; $this->IIIlLLl ="SoftImpression"; $this->Owner =false; $this->Side ="admin"; $this->ActivePage =""; $this->ActiveScript =""; $this->Filter =false; $this->StatusMsgs =Array(); $this->Messages =Array(); $this->DFMT =Array( I332 => "MM/DD/YYYY", "php" => "m/d/Y", "db" => I333 );$this->frn =false; if(isset($GLOBALS['CURRENT_SKIN_PATH'])){ $this->Gui->setSkinPath($GLOBALS['CURRENT_SKIN_PATH']); }$this->IIIlL1L =function_exists('customGenSublink'); }function fillModulesSelect($IIIl1IL =false, $IIIl1I1 =false){ if(AMI_Registry::exists('AMI/Runtime/modComponentPage')){ AMI_Registry::delete('AMI/Runtime/modComponentPage'); return; }global $adm; $IIIl1lI =array(); $oDeclarator =AMI_ModDeclarator::getInstance(); if(AMI_Registry::get('side') != 'adm'){ $IIIl1ll =array('pmanager', I334, 'eshop', I335, 'portfolio', 'services', 'plugins'); $IIIl1lL =$adm->Gui->ParseLangFile(AMI_Skin::getPath('templates/lang/_menu_owners.lng')); foreach($IIIl1ll as $vName){ $IIIl1lI[$vName] =array( I336 => $IIIl1lL[$vName], 'items' => array() );}}else{ $vOwners =&$adm->Core->GetOwnersList(); foreach ($vOwners as $vName => $vData){ if($vName == 'system'){ continue; }if($adm->Core->IsOwnerInstalled($vName)){ $IIIl1lI[$vName] =array( I336 => $vData["menu_name"], 'items' => array(), );}}}$isAdmin =(AMI_Registry::get(I337) == 'adm'); if(!$isAdmin){ $adm->Core->TTllT1T(); }$aAllModules =$adm->Core->GetAllModules(); $IIIl1l1 =array(); $IIIl1LI =array(); $aExt =array(); $aLinks =array(); foreach($aAllModules as $vModName => $vData){ $vMod =&$aAllModules[$vModName]; if($vMod->issetOption(I338)) {$modLink =$vMod->GetAOption(I338); $aLinks[isset($modLink['parent']) ?$modLink['parent'] :''][$vModName] =$modLink; }}$aModCaptions =AMI_Service_Adm::getModulesCaptions(array_keys($aAllModules), TRUE, array(), TRUE); if(!$isAdmin){ $oTpl =AMI::getResource(I339); $aOldCaptions =array('all' => $oTpl->parseLocale(AMI_Skin::getPath('templates/lang/_menu_all.lng'))); $aOldCaptions['all'] =$oTpl->parseLocale(I340) +$aOldCaptions['all']; $IIIl1Ll =$oTpl->parseLocale(I341); foreach($IIIl1Ll as $captionModId => $caption){ if(!in_array($captionModId, array(I342, 'eshop_discounts'))){ $IIIl1LL =mb_convert_case($aOldCaptions['all'][$captionModId], MB_CASE_LOWER, "UTF-8"); $IIIl1L1 =mb_convert_case($caption, MB_CASE_LOWER, "UTF-8"); $IIIl11I =($IIIl1LL != $IIIl1L1); if($IIIl11I || mb_strpos($caption, I343) !== FALSE){ $aOldCaptions['all'][$captionModId] =mb_convert_case($caption, MB_CASE_TITLE); }}}$aModCaptions =$aOldCaptions['all']; $this->Core->ModAllSetOption('admin_menu_caption', $aOldCaptions['all']); }else{ $aOldCaptions =array( I344 => $adm->Gui->ParseLangFile('templates/lang/_menu_all.lng') );}foreach($aAllModules as $modId => $oMod){ $IIIl11l =empty($aLinks[''][$modId]['owner']) ?false :$aLinks[''][$modId][I345]; $IIIl11L =$IIIl11l ?$IIIl11l :$oMod->GetOwnerName(); if(!isset($aOldCaptions[$IIIl11L]) && $isAdmin){ $aOldCaptions[$IIIl11L]['grp'] =$adm->Gui->ParseLangFile("templates/lang/_menu_".$IIIl11L.".lng"); $aOldCaptions[$IIIl11L]['sub'] =$adm->Gui->ParseLangFile("templates/lang/_menu_".$IIIl11L."_sub.lng"); }if(strpos($modId, 'plugin_') === 0){ if(AMI::issetAndTrueOption($modId, I346) == 1){ if(is_array(AMI::getOption($modId, 'admin_menu_caption'))){ $IIIl111 =AMI::getOption($modId, 'admin_menu_caption'); $aOldCaptions[I344][$modId] =$IIIl111[AMI_Registry::get(I347)]; }}}$IIILIII ='Unknown'; if(isset($aOldCaptions[I344][$modId]) || isset($aOldCaptions[$IIIl11L]['grp'][$modId]) || isset($aOldCaptions[$IIIl11L]['sub'][$modId])){ if(isset($aOldCaptions[I344][$modId])){ $IIILIII =$aOldCaptions[I344][$modId]; }if(isset($aOldCaptions[$IIIl11L]['sub'][$modId])){ $IIILIII =$aOldCaptions[$IIIl11L][I348][$modId]; if(isset($aOldCaptions[$IIIl11L]['grp'][$modId]) && ($aOldCaptions[$IIIl11L][I348][$modId] != $aOldCaptions[$IIIl11L]['grp'][$modId])){ $IIILIII =$aOldCaptions[$IIIl11L]['grp'][$modId] .' : ' .$IIILIII; }}}$IIILIIl =$oMod->issetOption(I349) ?$oMod->GetOption(I349) :true; if($isAdmin && $oDeclarator->isRegistered($modId)){ list($hyper, )=$oDeclarator->getHyperData($modId); if('ami_ext' == $hyper){ $parentId =$oDeclarator->getParent($modId); $aModInfo =AMI_Service::getModResourceInfo($parentId ?$parentId :$modId); if(isset($aModInfo['resMode']) && 'oldenv' != $aModInfo['resMode']){ $aExt[$modId] =$aModInfo[I350]; }}}if(!isset($IIIl1lI[$IIIl11L]) || !$oMod->IsInstalled() || $oMod->HaveParent()){ continue; }$IIILIIL =$oMod->IsAdminAllowed() && $IIILIIl; $isPlugin =0 === mb_strpos($modId, 'plugin_'); $isRegistered =$oDeclarator->isRegistered($modId) || $isPlugin; if(!$isRegistered && !$IIILIIL){ continue; }if(!isset($IIIl1lI[$IIIl11L]['items'][$modId])){ $caption =$isRegistered && $IIILIIL && !$isPlugin ?$aModCaptions[$modId] :$IIILIII; if($isAdmin && $isRegistered){ $IIILII1 =$adm->Core->issetModProperty($modId, 'spec_blocks') ?$adm->Core->getModProperty($modId, 'spec_blocks') :array(I351); if(sizeof($IIILII1)){ foreach($IIILII1 as $specblock){ $specblock =preg_replace( array('/^spec_small_/', '/^spec_/'), I351, $specblock );$IIIl1lI[$IIIl11L]['items'][$modId] =AMI_Service::getModResourceInfo($modId, $specblock); if($isPlugin){ $IIIl1lI[$IIIl11L]['items'][$modId] += array( I352 => AMI::getOption($modId, 'plugin_id'), 'icon' => AMI::getOption($modId, 'icon') );}break; }}else{ if($isPlugin && AMI::issetOption($modId, 'plugin_id') && AMI::getOption($modId, I353)){ $IIIl1lI[$IIIl11L]['items'][$modId] =AMI_Service::getModResourceInfo($modId); $IIIl1lI[$IIIl11L]['items'][$modId] += array( I352 => AMI::getOption($modId, I353), 'icon' => AMI::getOption($modId, 'icon') );}}}if($IIILIIL && strlen($caption)){ $IIILIlI =array( I336 => $caption, I354 => $oMod->GetAdminLink(), 'parentId' => I351 );$IIIl1lI[$IIIl11L]['items'][$modId] =isset($IIIl1lI[$IIIl11L]['items'][$modId]) ?$IIIl1lI[$IIIl11L]['items'][$modId] +$IIILIlI :$IIILIlI; if($IIIl1IL){ if(in_array($modId, array(I355, I356))){ $IIIl1lI[$IIIl11L][I357][$modId]['disabled'] =TRUE; $IIIl1lI[$IIIl11L][I357][$modId]['title'] =$this->MenuItemsAll['unavailable_functionality']; }}}}if($IIILIIL){ $IIIl1l1[] =$modId; if($isRegistered){ $IIIl1LI[] =$modId; }}if($IIILIIL && $oMod->TTlIIIl()){ $aChildren =&$oMod->GetSubModules(); foreach($aChildren as $childName => $IIILIll){ $IIIl11L =$IIILIll->GetOwnerName(); $IIILIIl =$IIILIll->issetOption(I349) ?$IIILIll->GetOption(I349) :true; if(!$IIILIll->IsInstalled() || !$IIILIll->IsAdminAllowed() || !$IIILIIl){ continue; }$isRegistered =$oDeclarator->isRegistered($childName); $caption =$isRegistered ?$aModCaptions[$childName] :$adm->GetModHeader($IIILIll, 'admin_page_header'); if(!strlen($caption) || I358 === $caption){ $IIILIII ='Unknown'; if(isset($aOldCaptions[I344][$childName]) || isset($aOldCaptions[$IIIl11L]['grp'][$childName]) || isset($aOldCaptions[$IIIl11L][I348][$childName])){ if(isset($aOldCaptions[I344][$childName])){ $IIILIII =$aOldCaptions[I344][$childName]; }if($isAdmin){ if(isset($aOldCaptions[$IIIl11L][I348][$childName])){ $IIILIII =$aOldCaptions[$IIIl11L][I348][$childName]; if(isset($aOldCaptions[$IIIl11L]['grp'][$childName]) && ($aOldCaptions[$IIIl11L][I348][$childName] != $aOldCaptions[$IIIl11L]['grp'][$childName])){ $IIILIII =$aOldCaptions[$IIIl11L][I359][$childName] .' : ' .$IIILIII; }}}else{ $IIILIII =$aOldCaptions[I344][$modId] .' : ' .$IIILIII; }}if($IIILIII){ $caption =$IIILIII; }}$modCaption =$this->TTTTlI1($aOldCaptions[I344][$modId]); $ownerName =$IIIl1lI[$IIIl11L][I336]; if(!$isAdmin && strlen($caption)){ $IIIl1LL =mb_convert_case($ownerName, MB_CASE_LOWER, "UTF-8"); $IIIl1L1 =mb_convert_case($modCaption, MB_CASE_LOWER, "UTF-8"); if(mb_strpos($IIIl1L1, $IIIl1LL) === 0){ $modCaption =mb_substr($modCaption, 0, mb_strpos($modCaption, I343)); }if(mb_strpos($modCaption, I343) !== FALSE){ $modCaption =mb_substr($modCaption, 0, mb_strrpos($modCaption, I343)); }$caption =mb_substr($caption, mb_strrpos($caption, I343)); $caption =trim($caption, I360); $caption =$modCaption .' : ' .$caption; }else{ if(mb_strpos($caption, I343) !== FALSE){ $IIILIlL =mb_convert_case($ownerName, MB_CASE_UPPER, "UTF-8"); $caption =str_replace($IIILIlL, $modCaption, $caption); }}if(strlen($caption)){ $caption =$this->TTTTlI1($caption); $IIIl1lI[$IIIl11L][I357][$childName] =array( I336 => $caption, I354 => $IIILIll->GetAdminLink(), 'parentId' => $modId )+AMI_Service::getModResourceInfo($childName); if( $isRegistered && ('cat' === AMI_ModDeclarator::getInstance()->getAttr($childName, I361, FALSE)) && $adm->Core->issetModOption($modId, 'use_categories') && !$adm->Core->GetModOption($modId, 'use_categories') ){$IIIl1lI[$IIIl11L][I357][$childName]['disabled'] =TRUE; $IIIl1lI[$IIIl11L][I357][$childName]['title'] =$this->MenuItemsAll['enable_category_functionality']; }}}}}foreach(array_keys($IIIl1lI) as $section){ if(empty($IIIl1lI[$section][I357])){ unset($IIIl1lI[$section]); }}if($IIIl1I1){ return array( 'aAllModData' => $IIIl1lI, );}$oGUI =AMI_Registry::get('oGUI'); $oGUI->addHtmlScript('var aAllModData = ' .json_encode($IIIl1lI) .';'); $oGUI->addHtmlScript(I362 .json_encode($IIIl1l1) .I363); $oGUI->addHtmlScript(I364 .json_encode($IIIl1LI) .I363); $oGUI->addHtmlScript('var aExtModes = ' .json_encode($aExt) .I363); $IIILIl1 =$oGUI->ParseLangFile("templates/lang/srv_options.lng"); $oGUI->addHtmlScript('var srvOptionsPopupTitle = "' .$IIILIl1['srv_options_popup_title'] .I365); $oGUI->addHtmlScript('var srvOptionsStratTypeModName = "' .$IIILIl1['srv_options_start_type_mod_name'] .I365); $oGUI->addHtmlScript('var srvOptionsStratTypeOptName = "' .$IIILIl1['srv_options_start_type_opt_name'] .I365); $oGUI->addHtmlScript('var srvOptionsNotFound = "' .$IIILIl1['srv_options_not_found'] .I365); $oGUI->addHtmlScript('var srvOptionsTooMuch = "' .$IIILIl1['srv_options_too_much'] .I365); $oGUI->addHtmlScript('var srvOptionsCountMsg1 = "' .$IIILIl1['srv_options_count_msg1'] .I365); $oGUI->addHtmlScript('var srvOptionsCountMsg2 = "' .$IIILIl1['srv_options_count_msg2'] .I365); $oGUI->addHtmlScript(I366 .$IIILIl1[I367] .I365); $oGUI->addHtmlScript('var srvOptionsSearchInDescriptions = "' .$IIILIl1['srv_options_searc_in_descriptions'] .I365); $oGUI->addHtmlScript('var srvOptionsSearchSettings = "' .$IIILIl1['srv_options_search_settings'] .I365); $oGUI->addHtmlScript(I368 .$IIILIl1[I369] .I365); }function TTTTlI1($caption){ $aCaptions =mb_split(' : ', $caption); foreach($aCaptions as $i => $caption){ $aCaptions[$i] =trim($caption); }$caption =I351; $caption =mb_strtoupper(mb_substr($aCaptions[0], 0, 1)) .mb_strtolower(mb_substr($aCaptions[0], 1)); if(isset($aCaptions[1])){ $caption .= ' : '; $caption .= (mb_strtoupper(mb_substr($aCaptions[1], 0, 1)) .mb_strtolower(mb_substr($aCaptions[1], 1))); }return $caption; }function TTTTllT($IIILILI =false, $aCaptions =false){ $aMenu =array(); $modlist =&$this->Core->GetAllModules(); $aLinks =array(); foreach($modlist as $vModName=>$vData){ $vMod =&$modlist[$vModName]; if($vMod->issetOption(I338)) {$modLink =$vMod->GetAOption(I338); $aLinks[isset($modLink['parent']) ?$modLink[I370] :I351][$vModName] =$modLink; }}foreach($modlist as $vModName=>$vData){ $vMod =&$modlist[$vModName]; $IIILILl =empty($aLinks[I351][$vModName][I345]) ?false :$aLinks[I351][$vModName][I345]; if(!( $vMod->IsInstalled() && $vMod->IsAdminAllowed() && ($vMod->issetOption(I349) ?$vMod->GetOption(I349) :true) && ($this->ActiveOwner == $vMod->GetOwnerName() && !$vMod->issetOption(I338) || $this->ActiveOwner == $IIILILl) )){continue; }$vItemData =array(); if($vMod->issetProperty("splitter_before") && $vMod->GetProperty("splitter_before")){ $vItemData[I371] ="-"; $aMenu[] =$vItemData; $vItemData[I371] =""; }$IIILILL =$vMod->GetOwnerName(); $vItemData[I371] =$vModName; $vItemData[I372] =($aCaptions !== false && isset($aCaptions["admin_menu_caption"][$IIILILL][$vModName]) ?$aCaptions["admin_menu_caption"][$IIILILL][$vModName] :$this->GetModHeader($vMod)); $vItemData["script"] =$vMod->GetAdminLink(); $vItemData["level"] =1; $vItemData[I373] =false; $vItemData["active"] =false; if($vMod->TTlIIIl() || !empty($aLinks[$vModName])){ $IIILIL1 =false; $IIILI1I =false; if (!empty($aLinks[$vModName])) {foreach ($aLinks[$vModName] as $IIILI1l => $IIILI1L) {if ($this->ActiveModule == $IIILI1l || $this->ActiveModule == $IIILI1L[I370]) {$IIILI1I =true; break; }}}if( $IIILILI || ($this->ActiveModule == $vModName) || ($vMod->GetModule($this->ActiveModule) !== false) || $IIILI1I){ $IIILIL1 =true; $vItemData[I373] =true; $aMenu[] =$vItemData; $vItemData["level"] ++; $vItemData[I373] =false; $vItemData[I372] =($aCaptions !== false && isset($aCaptions["admin_as_submenu_caption"][$IIILILL][$vModName]) ?$aCaptions["admin_as_submenu_caption"][$IIILILL][$vModName] :$vMod->GetOption("admin_as_submenu_caption")); $vItemData["active"] =($this->ActiveModule == $vModName); $aMenu[] =$vItemData; }if($IIILIL1){ $IIILI11 =&$vMod->GetSubModules(); if(isset($aLinks[$vModName]) && is_array($aLinks[$vModName])) {foreach($aLinks[$vModName] as $IIILlII => $IIILlIl) {$IIILI11[$IIILlII] =&$modlist[$IIILlII]; }}foreach($IIILI11 as $IIILlIL=>$IIILlI1){ $IIILllI =&$IIILI11[$IIILlIL]; $IIILILL =$IIILllI->GetOwnerName(); $IIILILl =isset($aLinks[$vModName][$IIILlIL])? $aLinks[$vModName][$IIILlIL][I345]: false; if(!( $IIILllI->IsInstalled() && $IIILllI->IsAdminAllowed() && ($IIILllI->issetOption(I349) ?$IIILllI->GetOption(I349) :true) && ($this->ActiveOwner == $IIILILL && empty($IIILILl) || $this->ActiveOwner == $IIILILl) )){continue; }$IIILlll =true; $IIILlI1 =array(); $IIILlI1[I371] =$IIILlIL; $IIILlI1[I372] =($aCaptions !== false && isset($aCaptions["admin_as_submenu_caption"][$IIILILL][$IIILlIL]) ?$aCaptions["admin_as_submenu_caption"][$IIILILL][$IIILlIL] :$IIILllI->GetOption("admin_as_submenu_caption")); if(is_array($IIILlI1[I372]) && $IIILlI1[I372][$this->lang]) {$IIILlI1[I372] =$IIILlI1[I372][$this->lang]; }$IIILlI1[I374] =$IIILllI->GetAdminLink(); $IIILlI1["level"] =2; $IIILlI1[I373] =false; $IIILlI1["active"] =($this->ActiveModule == $IIILlIL); $aMenu[] =$IIILlI1; }}elseif(!$IIILIL1 && ($this->ActiveModule != $vModName) ){$aMenu[] =$vItemData; }}else{ if($vMod->GetParentName()==""){ $vItemData["active"] =($this->ActiveModule == $vModName); $aMenu[] =$vItemData; }}if($vMod->issetProperty(I375) && $vMod->GetProperty(I375)){ $vItemData =array(); $vItemData[I371] ="-"; $aMenu[] =$vItemData; }}return $aMenu; }function GetOwnersCustomLang($IIILllL){ $res =$this->Gui->ParseLangFile(sprintf($IIILllL, "")); $aOwners =$this->Core->GetAOption("custom_owners"); foreach ($aOwners as $owner) {$aCustom =$this->Gui->ParseLangFile(sprintf($IIILllL, $owner."/")); if(is_array($aCustom)) {$res =array_merge($res, $aCustom); }}return $res; }function GenAutoLink($cName, $IIILll1=I376, $IIILlLI=false, $forceLink =I376, $IIILlLl =5, $IIILlLL =I351){ $res =I376; $splitter =I376; if($IIILll1!=I376 && $IIILll1[mb_strlen($IIILll1)-1]!="/"){ $splitter ="/"; }if($forceLink != I376) {$link =$forceLink; }else {require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_translit.php"); $link =$this->GenSublink(($IIILlLI)?cms_transliterate($cName, $this->lang_data):$cName, $IIILlLl, 64, $IIILlLL); }$res =$IIILll1.$splitter.$link; return $res; }function TTTTllI($cName, $cId, $IIILll1=I376, $IIILlLI=false) {$IIILlL1 =$this->GenAutoLink($cName, $IIILll1, $IIILlLI).I377.$cId; return $IIILlL1; }function GenSublink($cStr, $IIILlLl =5, $IIILl1I =64, $IIILlLL =I351){ if($this->IIIlL1L){ $res =customGenSublink($this->IIIlL1l +array( 'oCMS' => $this, 'name' => $cStr, 'max_words' => $IIILlLl, 'max_len' => $IIILl1I, I378 => $IIILlLL, I379 => $this->Module->Name, 'id' => isset($this->Module->id) ?$this->Module->id :0 ));if(!is_null($res)){ return $res; }}$res =I351; $cStr =mb_strtolower(unhtmlentities($cStr, true)); $cStr =preg_replace('/[^0-9a-zA-Z\-\_\/ ]+?/', I351, $cStr); $cStr =trim($cStr, ' /'); $cStr =preg_replace('/[ -\/]+/', I380, $cStr); $oldStrLen =mb_strlen($cStr); $cStr =preg_replace('/^(((.*?)(-|_|\.|\/|$)){1,'.intval($IIILlLl).'}).*?$/', '\1', $cStr); if(mb_strlen($cStr) <$oldStrLen) $cStr =mb_substr($cStr, 0, mb_strlen($cStr)-1); if(!preg_match('/^[0-9a-zA-Z\-\_\.]$/', $cStr[0])) $cStr =I377.$cStr; $cStr =mb_substr($cStr, 0, $IIILl1I); $res =$cStr; if(!empty($this->Module->Name) && ($this->Module->Name != I358) && $this->Core->IssetModOption($this->Module->Name, I381)){ if($this->Core->GetModOption($this->Module->Name, I381)){ $prefixDate =null; if($IIILlLL){ $prefixDate =$IIILlLL; }elseif(isset($this->Vars["date"])){ $prefixDate =$this->Vars["date"]; }$IIILl1l =DateTools::getCorrectUDate($prefixDate, $this->DFMT[I332]); $res =date('Y-m-d', $IIILl1l).'/'.$res; }}return $res; }function TTTTlll() {if (!is_object($this->frn)) {require_once $GLOBALS[I382] .'Front.php'; $this->frn =new Front($this->Core, I351, true); $this->frn->setLang($this->lang_data); $this->frn->constructorPostActions(); }}function TTTTll1($IIILl1L, $cId, $IIILl11, $aNavData =false, $IIILLII =false, $IIILLIl =I376, $idPage =0, $activeModule =I376, $IIILLIL =I376){ if($this->IIIlL11){ $cId =0; }$res =1; $db =new DB_si; $this->TTTTlll(); $cLang =I351; require_once($GLOBALS["CLASSES_PATH"].files_subpath."Page.php"); $tmpPage =new Page($this->frn); $tmpPage->tree->UseHidden =false; $tmpPage->tree->ll1Il1L =false; $tmpPage->tree->UseLang =true; $tmpPage->isLinkConflictsMode =true; if($IIILl1L[mb_strlen($IIILl1L)-1]!="/"){ $IIILl1L .=I383; }$cLang =I376; if(is_array($aNavData)){ $this->frn->SetPageModule($IIILLII); $this->frn->ActivePage =$IIILLII; $this->frn->IILllI1 =false; $IIILLI1 =$this->Core->GetModFrontLink($IIILLII, $idPage); if($this->Core->GetOption("allow_multi_lang")){ $cLang =mb_substr($IIILLI1, 0, 3); $IIILLI1 =mb_substr($IIILLI1, 3); }$stopArgModName =$this->frn->getStopArgModName($IIILLII); $this->frn->ActiveModule =&$this->frn->Core->GetModule($stopArgModName); $aNavData =$this->frn->ApplyNav($aNavData); $IIILl1L =rtrim($IIILLI1.$aNavData["nav_data"], "?"); }$IIILLlI =$tmpPage->DetectPageByLink($IIILl1L, $cId, true, $IIILLIL); if($IIILLIl != I376) {$IIILLIl =", ".$IIILLIl; }foreach($IIILLlI as $tmpItem) {if( isset($tmpItem[$this->lang_data][I384]) ){$vScriptLink =$tmpItem[$this->lang_data][I385]; if(rtrim($vScriptLink, I383)==rtrim($IIILl1L, I383)){ $res =-1; }elseif($tmpItem[$this->lang_data][I384]!="pages" && $vScriptLink!=$IIILl1L){ if(empty($activeModule)) {$activeModule =$this->ActiveModule; }$this->frn->SetPageModule($activeModule); $stopArgModName =$this->frn->getStopArgModName($tmpItem[$this->lang_data][I384]); $vArgLink =mb_substr($IIILl1L, mb_strlen($vScriptLink)); if($stopArgModName!=I376){ $this->frn->SetupStopArgs($stopArgModName, $vArgLink, $tmpItem[$this->lang_data]["id"], $IIILLIl, $activeModule); $navData =$this->frn->TTIT1Tl(); if($this->frn->TITlTll()){ if($IIILl11) {end($this->frn->I1IlIIl); $IIILLll =current($this->frn->I1IlIIl); reset($this->frn->I1IlIIl); $res =($IIILLll >0) ?-1 :1; }else {end($this->frn->I1IlIIl); $IIILLll =current($this->frn->I1IlIIl); reset($this->frn->I1IlIIl); if($IIILLll >0) {$res =-1; if( isset($this->frn->I1IlIIl[$activeModule]) && $this->frn->I1IlIIl[$activeModule]!=$cId && $this->frn->I1IlIIl[$activeModule] >0){ $res =-2; }else {$res =1; }}}}}}else{ $res =1; }}if($res) {$IIILLlL =Array(); if($tmpPage->TTll1TI($IIILl1L, $tmpItem[$this->lang_data]["id"], $tmpItem[$this->lang_data][I384], $tmpItem[$this->lang_data][I385], $IIILLlL)) {if(isset($IIILLlL["id"])) {$res =-3; $navData[I386] =$IIILLlL[I384]; }}}if($res <0) {$navData[I387] =$GLOBALS["ROOT_PATH_WWW"].$cLang.$IIILl1L; $this->TTIT1TI($navData); break; }}unset($db, $tmpPage); return $res; }function TTTTl1T(&$IIILLl1){ $res =true; foreach($IIILLl1 as $vData){ if($vData!=I376){ $res =false; break; }}return $res; }function TTTTl1I($IIILLLI, $IIILLLl){ $res =true; foreach($IIILLLI as $vKey=>$vData){ $vData =removeSpecial($vData); $IIILLLl[$vKey] =removeSpecial($IIILLLl[$vKey]); if($IIILLLl[$vKey]!=$vData){ $res =false; break; }}return $res; }function TTTTl1l($cStr, $IIILLLL =255) {static $minLen; $res =mb_strtolower($cStr); $res =preg_replace("/[^a-zA-Zа-яА-Я0-9-]+/u", " ", $res); if (!isset($minLen)) {$minLen =intval($this->Core->GetModOption('pages', I388)); }if ($minLen >1) {$res =trim(preg_replace(array ('/(^| +)[a-zA-Zа-яА-Я0-9-]{1,' .($minLen -1) .'}(?=$| +)/us', '/ +/'), array ('\\1', I389), $res)); }$res =str_replace(" ", ", ", $res." "); $res =mb_substr($res, 0, $IIILLLL); $res =preg_replace("/,[^,]*$/", I376, $res); return $res; }function TTTTl11($cStr, $IIILLLL =255) {$res =$cStr; $res =preg_replace(I390, I376, $res); $res =$this->stripLine($res, $IIILLLL); $res =str_replace("...", I376, $res); return $res; }function TTTT1TT($content) {$content =preg_replace('/<script(.*?)\/script>/si', I351, unhtmlentities($content, true)); $content =preg_replace('/<style(.*?)\/style>/si', I351, $content); return trim(strip_tags($content)); }function TTTT1TI(&$IIILLl1, $cName, $IIILLL1, $IIILL1I =I376){ $IIILL1l =$this->TTTT1TT($IIILLL1); if($IIILL1l==I376){ $IIILL1l =$this->TTTT1TT($IIILL1I); }$IIILL1l =str_replace("\r\n", I391, $this->Gui->parseText('##--!ver=0200 rules="-SETVAR"--##'.$IIILL1l)); $IIILLl1["title"] =$cName; $cName =strip_tags(unhtmlentities($cName, true)); $IIILLl1["keywords"] =$this->TTTTl1l($cName.I391.$IIILL1l); $IIILLl1["description"] =$this->TTTTl11($cName.I392.$IIILL1l); return true; }function TTTT1Tl($IIILL1L, $IIILL11, $IIIL1II, &$IIIL1Il, &$IIIL1IL, $cName, $IIILLL1, $IIILL1I=I376){ $res =false; $IIIL1IL =array("is_kw_manual"=>$IIILL11); $IIIL1I1 =($IIILL1L=="auto")?$this->TTTTl1I($IIIL1II, $IIIL1Il):1; $IIIL1lI =false; if( $IIILL1L=="force" || ($IIILL1L=="auto" && ($IIILL11==0 )&& $IIIL1I1 )|| $this->TTTTl1T($IIIL1Il) ){$IIIL1IL =array(I393=>"0"); $IIIL1lI =true; $this->TTTT1TI($IIIL1Il, $cName, $IIILLL1, $IIILL1I); $IIIL1Il["title"] =$IIIL1Il["title"]; $IIIL1Il["keywords"] =addslashes($IIIL1Il[I394]); $IIIL1Il["description"] =addslashes($IIIL1Il["description"]); $res =true; }if($IIILL1L=="auto" && !$IIIL1I1 && !$IIIL1lI){ $IIIL1IL =array(I393=>"1"); }return $res; }}