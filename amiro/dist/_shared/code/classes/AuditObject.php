<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       11143 xkqwrtmziywqytpygpiqxmlunsrsyzxiimkrktrlipiwtwuxzwswppmtirmxipgwnyzypnir
 */ ?><?php foreach(array(397=>"unSQfMnQS",398=>"coqRq?Z`MS|MtQI='",399=>"'?zNs?Z`IHSuJQ|nZIQ='",400=>"HrMPMnZJ|DtZtuD",401=>"MtQI|nZIQ",402=>"",403=>"MS|MtQrZtMHn",404=>"IHSuJQ|nZIQ",405=>"ZuSMt|DtZtuD",406=>"WHIIQntD",407=>"'?zNs?IHSuJQ|nZIQ='",408=>"ZGGJB",409=>"ZGGrHvQS",410=>"HCnQr|WOZnPQS",411=>"jmimT?") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class AuditObject {public $cms; public $db; public $module; public $moduleName; public $id; public $itemId; public $itemName; public $IIIL1LI; public $status; public $history; public $IIIL1Ll; public $ownerId; public $initialized; public $comments; function AuditObject(&$cms, &$db) {$this->cms =&$cms; $this->db =&$db; $this->Free(); }function Free() {$this->id =0; $this->module =null; $this->moduleName =""; $this->itemId =0; $this->itemName =""; $this->IIIL1LI =I397; $this->status =I397; $this->IIIL1Ll =0; $this->ownerId =0; $this->initialized =false; $this->comments =""; }function Init($cId, $IIIL1LL, $IIIL1L1 ="") {$vMod =&$this->cms->Core->GetModule($IIIL1LL); if(is_object($vMod) && $vMod->IsInstalled()) {$this->module =$vMod; $this->moduleName =$vMod->GetName(); $this->itemId =$cId; $this->initialized =true; if($cId >0) {$sql ="SELECT a.id, a.original_status, a.audit_status, a.item_name, a.id_owner, a.comments ". "FROM cms_srv_audit a ". I398.$cId.I399.$IIIL1LL."' AND id_iteration=0 AND lang='".$this->cms->lang_data."'". "ORDER BY a.id desc LIMIT 1"; $this->db->query($sql); if($this->db->next_record()) {$this->id =$this->db->Record["id"]; $this->IIIL1LI =$this->db->Record[I400]; $this->status =$this->db->Record["audit_status"]; $this->ownerId =$this->db->Record["id_owner"]; $this->comments =$this->db->Record["comments"]; }}$this->itemName =($IIIL1L1 == "")? $this->db->Record[I401]: $IIIL1L1; }return $this->initialized; }function TTTT1Il() {return $this->initialized; }function TTTT1I1($IIIII1L) {$this->status =$IIIII1L; if($this->IIIL1LI == I397) {$this->IIIL1LI =$this->status; }$this->Save(); }function TTTT1lT($IIIII1L ="") {$status =(!empty($IIIII1L))? $IIIII1L: $this->status; return in_array($status, Array("added", "changed", "deleted")); }function TTTT1lI($IIIII1L =I402) {$status =(!empty($IIIII1L))? $IIIII1L: $this->status; return in_array($status, Array("approved", "rejected", "purged", "owner_changed")); }function TTTT1ll($IIIII1L =I402) {$status =(!empty($IIIII1L))? $IIIII1L: $this->status; return AuditObject::TTTT1lT($status) || AuditObject::TTTT1lI($status); }function Save() {$aSql =Array( I403 => 0, "date" => "=|NOW()", "lang" => $this->cms->lang_data, I404 => $this->moduleName, "id_item" => $this->itemId, I401 => $this->itemName, I400 => $this->IIIL1LI, I405 => $this->status, "id_actor" => $this->IIIL1Ll, "id_owner" => $this->ownerId, "ip" => getenv("REMOTE_ADDR"), I406 => $this->comments, );$sql =$this->db->GenInsertSQL("cms_srv_audit", $aSql); $this->db->query($sql); $IIIL11I =$this->db->lastInsertId(); if($this->id >0) {$sql ="UPDATE cms_srv_audit SET id_iteration = '".$IIIL11I."' ". "WHERE (id='".$this->id."' OR id_iteration='".$this->id."') AND id_item='".$this->itemId.I407.$this->moduleName."'"; $this->db->query($sql); }$this->id =$IIIL11I; }function TTTT1l1($IIIL11l) {$res =false; $IIIL11L =Array( "add" => "added", I408 => "changed", "del" => "deleted", "approve" => I409, "reject" => "rejected", "purge" => "purged" );$status =$IIIL11L[$IIIL11l]; if($this->initialized && AuditObject::TTTT1ll($status)) {$res =true; if($this->TTTT1lT()) {if(AuditObject::TTTT1lI($status)) {$this->TTTT1I1($status); }else {$this->TTTT1I1($status); }}else {if($this->id == 0) {if($this->status == I410) {if(!AuditObject::TTTT1lT($status)) {$this->TTTT1I1($status); }else {trigger_error("Unexpected status $status after CHOWN", E_USER_ERROR); }}else {$this->TTTT1I1("added"); }}else {if(AuditObject::TTTT1lT($status)) {$this->id =0; $this->IIIL1LI =I397; $this->TTTT1I1($status); }elseif(AuditObject::TTTT1lI($status)) {$this->TTTT1I1($status); }}}}return $res; }function GetStatus() {return $this->status; }function TTTT11T($IIIL111) {$this->IIIL1Ll =$IIIL111; }function SetOwner($III1III, $III1IIl =false) {if($III1IIl) {if($this->ownerId >0 && $III1III != $this->ownerId) {$this->TTTT1I1(I410); $this->id =0; $this->IIIL1LI =I410; }elseif ($this->ownerId == 0) {$this->TTTT1I1(I410, false); }}$this->ownerId =$III1III; }function TTTT11I() {return $this->ownerId; }function SetComment($III1IIL) {$III1II1 =trim($III1IIL); $this->comments =$III1II1; }function GetComment() {return $this->comments; }function GetItemId() {return $this->itemId; }function TTTT11l() {return $this->itemName; }function TTTT111($cLimit =10) {$aHistory =Array(); $sql ="SELECT UNIX_TIMESTAMP(a.date) as fdate, a.audit_status as status, a.ip, a.id_actor, a.id_owner, a.comments ". "FROM cms_srv_audit a ". I398.$this->itemId."' ORDER BY a.id desc ".($cLimit >0? I411.$cLimit: I402); $this->db->query($sql); while($this->db->next_record()) {$key =$this->db->Record["fdate"]; $num =9999; do {$key =$this->db->Record["fdate"]."_".$num; $num--; }while(array_key_exists($key, $aHistory)); $aHistory[strval($key)] =$this->db->Record; }return $aHistory; }}?>