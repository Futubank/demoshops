<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       51990 xkqwyrtmuztpnxkwmzsimxpklstkkipgpnqkyupuwtmnqrnkywgiygslgqqtlnmwqmzspnir
 */ ?><?php foreach(array(443=>'wjzddqd|gzTo',444=>'iHSuJQoHDtUDQrD`GOG',445=>'nHnQ',446=>'IHSuJQ',447=>'YZWKQnS',448=>'QxGMrQ|JHWZJ|Hff',449=>'nuI|DMtQD|3JQvQJ',450=>'IZx|DMtQD',451=>'IZx|DMtQD|3JQvQJ',452=>'DMtQD|2JQvQJ|JQft',453=>'DMtQD|3JQvQJ|JQft',454=>'JMIMtD',455=>'`',456=>"fHrYMSSQn|nZIQD",457=>"fHrIZt|SHIZMn|CZrn",458=>'127`0`0`1',459=>'?YBtQD',460=>"?IHSuJQ='DOHC|nuIMIZPQ'?",461=>"'?",462=>"COQrQ?",463=>'',464=>"fHrSQr|tBGQ",465=>"MD|SQfZuJt",466=>'CASZQIHn|GHrt',467=>'MG',468=>'DI|DMtQ|tMtJQ',469=>'DI|WHIGZnB|nZIQ',470=>"JZB|WuDtHI",471=>'WJuDtQr|IQIYQr|MS',472=>"WHIGZnB|tQxt",473=>"JZDtnZIQ",474=>"QIZMJ",475=>'JMWQnWQ|QxG|SZtQ',476=>'JMWQnWQ|tBGQ',477=>'uDQrnZIQ',478=>'zsimN|gzTo|ccc',479=>'SHIZMn',480=>'YuMJSQr|SMDZYJQS',481=>'unKnHCn',482=>'IZx|DMtQD|2JQvQJ',483=>'nuI|DMtQD',484=>'dqRVqR|Nziq',485=>"CMAZrS|QIZMJ",486=>"&```",487=>'DuYSHIZMn',488=>'GrHxB|IHSQ|QnZYJQS',489=>"ZnS?DSZtZ1='",490=>"?JMIMt?1",491=>"fMrDtnZIQ",492=>"?hRsqR?yb?GHDMtMHn",493=>"MS|tZrMff",494=>"MS",495=>'uDQr',496=>'MS',497=>'SZQIHn|tMIQHut',498=>'tZrMff',499=>'ZSS',500=>'SHIZMn|nZIQ',501=>'ZSIMn',502=>"QxG|GQrMHS",503=>'DI|QIZMJ',504=>'rQDQJJQr|MS',505=>'fuJJnZIQ',506=>'DMtQIZG|tBGQ',507=>'MS|vOHDt',508=>'ZSSsnD',509=>'JMWQnWQqxGsZtQ',510=>"0",511=>'JMWQnWQTBGQ',512=>'fMrDtNZIQ',513=>"ZSSrQDD2",514=>'AMG',515=>"GOHnQ",516=>'WHIGZnB',517=>'MWE',518=>'GZDDCHrSoZDO',519=>"DtZtQ",520=>'tHGMWD',521=>'IHSJMnK',522=>'%',523=>'GHrt',524=>'fZtZJ') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} require_once $GLOBALS['CLASSES_PATH'] .'WZDaemon.php'; require_once $GLOBALS[I443] .I444; require_once $GLOBALS[I443] .'SiteManager.php'; if($GLOBALS["BUILDER_VERSION"] <2){ class BuilderResult {public $subdomain =''; public $domain =''; public $errtype =I445; public $msg =array( 'fatal' => '', I446 => array(), 'domain' => '', I447 => ''); public $sitemapDescr ='unknown'; public $username ='unknown'; public $admPathWWW =''; }class Builder {public $III1LII; public $db; public $frn; public $result; public $III1LIl; public $III1LIL; function Builder(&$III1LII,&$db,&$frn) {$this->III1LII =&$III1LII; $this->db =&$db; $this->frn =&$frn; $this->result =new BuilderResult(); $this->III1LIl =intval($this->III1LII->GetOption(I448)) ?1 :0; }function enabled() {$flags =SiteManager::TI1llT1(); return ($flags &CLOPT_NO_BUILD)==0; }function TTTIIIT() {$flags =SiteManager::TI1llT1(); return ($flags &CLOPT_NO_BUILD_FRONT)==0; }function TTTIIII($remind=true) {global $lang_data,$aWords; $limits =ModuleHostUsers::TIlTTT1(); $stats =ModuleHostUsers::TIlTTIT(); $left =intval($limits['remind_sites_left']); $max =intval($limits['max_sites']); $III1LI1 =intval($limits['max_sites_3level']); $err =false; if(($max && $stats['num_sites']>=$max) || ($III1LI1 && $stats[I449]>=$III1LI1)) {$set ='admin_limits_reached'; $err =true; }elseif($remind && $left && ($max && $max-$stats['num_sites']<=$left || $III1LI1 && $III1LI1-$stats[I449]<=$left)) {$set ='admin_limits_remind'; }else {return false; }$this->frn->Gui->addBlock("mail","templates/letters/_wz_letters" .$lang_data .".tpl"); $III1LlI =array(); $III1LlI['max_sites'] =$limits['max_sites']==0 ?$aWords['unlimited'] :$limits[I450]; $III1LlI['max_sites_2level'] =$limits['max_sites_2level']==0 ?$aWords['unlimited'] :$limits['max_sites_2level']; $III1LlI[I451] =$limits[I451]==0 ?$aWords['unlimited'] :$limits[I451]; $III1LlI += $stats; $III1LlI['sites_left'] =$limits[I450]==0 ?$aWords['unlimited'] :$limits[I450]-$stats['num_sites']; $III1LlI[I452] =$limits['max_sites_2level']==0 ?$aWords['unlimited'] :$limits['max_sites_2level']-$stats['num_sites_2level']; $III1LlI[I453] =$limits[I451]==0 ?$aWords['unlimited'] :$limits[I451]-$stats[I449]; $III1Lll =$this->frn->Gui->get('mail:admin_limits',$III1LlI); $III1LlL =$this->frn->Gui->getAbs("mail:${set}_subject", Array()); $III1Ll1 =$_SERVER['SERVER_NAME'].$_SERVER['SCRIPT_NAME']; $mbody =$this->frn->Gui->getAbs("mail:${set}_body", array(I454=>$III1Lll,'builder_url'=>$III1Ll1)); require_once($GLOBALS["CLASSES_PATH"]."Mailer.php"); $oMail =new Mailer(); $oMail->RecipientAddress =$this->III1LII->GetOption("wizard_email"); $oMail->SenderAddress =$this->frn->Core->GetOption("company_robot_email"); $oMail->SenderName =$this->frn->Core->GetOption("company_name"); $oMail->Subject =$III1LlL; $oMail->Body =$mbody; $oMail->BodyFormat ="html"; $oMail->Prepare(); if(!$oMail->Send()){ trigger_error("WZ_BUILDER: sending email failed to [".$oMail->RecipientAddress."]...", E_USER_WARNING); }return $err; }function TTTIIIl() {$domain =$this->result->domain; $sub =$this->result->subdomain; $d =explode(I455,$domain); array_shift($d); $domain =I455.implode(I455,$d); $III1LLI =$this->III1LII->GetAOption("domain"); $re =str_replace('*', '.*', '/^('.$this->III1LII->GetOption(I456).')$/'); if(preg_match($re, $sub, $m) || !in_array($domain, array_keys($III1LLI))) return $this->TTTIIl1("illegal_domain_warn",'domain'); $this->III1LIL =$domain; if(mb_strlen($sub) <3 || mb_strlen($sub) >$this->III1LII->GetOption("domain_maxlen")) {return $this->TTTIIl1(I457,'domain'); }if($this->TTTIII1($this->result->domain)) return $this->TTTIIl1('domain_name_used','domain'); }function TTTIII1($domain) {$sql ="SELECT id FROM cms_host_users WHERE domain_orig='".addslashes($domain)."' OR alias_domain='".addslashes($domain)."'"; $this->db->query($sql); if($this->db->next_record()) return true; if(!$this->III1LII->GetOption('proxy_mode_enabled')) return false; $III1LLl =$this->III1LII->GetAOption('proxy_local_ips'); if(!is_array($III1LLl)) {trigger_error("Empty local IP list",E_USER_WARNING); $III1LLl =array(); }$ip =gethostbyname($domain); if($ip==$domain) return false; array_push($III1LLl,I458); foreach($III1LLl as $III1LLL) {if($III1LLL==$ip) return false; }return true; }function TTTIIlT(&$vars,$ip) {if(isset($GLOBALS['III1LL1'])){ if(!empty($vars['sm_partner'])){ $III1L1I =1024 *1024 *20; $message ='Builder::_checkAccess(): extra hidden field check failed'; if(@filesize($GLOBALS['III1LL1']) <$III1L1I){ $message ="['USER: NOTICE'] [code=1024]:  ['" .$message ."'] [Details: '" .AMI_Service::getEnvInfo() ."'] "; AMI_Service::log($message, $GLOBALS['III1LL1']); }else{ trigger_error($message .', log file size excesses ' .$III1L1I .I459, E_USER_WARNING); }$this->TTTIIl1('twist_invalid_captcha'); return false; }}$sid =$vars["sid"]; $III1L1l =$vars["image_num"]; $III1L1L =I460; $III1L1L .= "and sdata1='".$III1L1l.I461; $III1L1L .= "and sdata2='".$sid."' and ip='".$ip."'"; $sql ="select id from cms_tmp ". I462.$III1L1L." limit 1"; $this->db->query($sql); if(!$this->db->next_record()) {$this->TTTIIl1('image_wrong_warn'); return false; }$sql ="delete from cms_tmp ". I462.$III1L1L; $this->db->query($sql); return true; }function TTTIIlI(&$vars) {global $oMember; $vars["firstname"] =preg_replace('/[^a-zA-Zа-яА-Я0-9_ .-]+/u', '', trim($vars["firstname"])); $vars["lastname"] =preg_replace('/[^a-zA-Zа-яА-Я0-9_ .-]+/u', I463, trim($vars["lastname"])); $sql ="SELECT id, header FROM cms_wz_designs WHERE id='".intval($vars["fdesign_id"])."'"; $this->db->query($sql); if(!$this->db->next_record()) return $this->TTTIIl1("illegal_design_warn"); $III1L11 =$this->db->Record["header"]; $III11II =$this->III1LII->GetOption("packets"); $III11Il =!in_array($vars["forder_type"], $III11II) ?$this->III1LII->GetOption("default_packet") :$vars[I464]; $sql ="SELECT sys_name, is_default, name FROM cms_wz_sitemaps ". " ORDER BY position"; $this->db->query($sql); $III11IL =Array(); while($this->db->next_record()){ $III11IL[$this->db->Record["sys_name"]] =$this->db->Record["name"]; if ($this->db->Record[I465]){ $III11I1 =$this->db->Record["sys_name"]; }}$III11lI =$vars["sitemap"]; if(!in_array($III11lI, array_keys($III11IL))) {$III11lI =$III11I1; }$this->result->sitemapDescr =$III11IL[$III11lI]; $daemon =new WZDaemon(I445,'inet:localhost:'.$GLOBALS['SHARED_OPT'][I466], $this->III1LII->GetOption('daemon_timeout'),SYSD_F_CONFIRM); if(!$daemon->Ping()) return $this->TTTIIl1($daemon->GetLastError(),I447); $III11ll =$vars; $III11ll["ip"] =$_SERVER["REMOTE_ADDR"]; if(!in_array('ip', $oMember->UsedFields)){ $oMember->UsedFields[] =I467; }if(!$oMember->createMember($this->frn, $this->db, $III11ll, false,'username')) return $this->TTTIIl1("member_create_warn"); $id_member =$oMember->checkUsername($this->db, $III11ll['username']); $III11lL =$this->III1LII->GetOption("exp_period"); $III11l1 =array(I468,'sm_site_url', 'sm_site_url_tag', 'sm_site_motto','sm_person_name', I469,'sm_email','sm_email_tag'); $lc =array(); foreach($III11l1 as $name) $lc[$name] =unhtmlentities(stripslashes($vars[$name])); $III11LI =$this->III1LII->GetAOption('domain'); $III11LI =$III11LI[$this->III1LIL]; $dns =mb_strpos($III11LI,'dns')!==false ?1 :0; $III11Ll =array( I470 => $lc, "site_data" => array( 'reseller_id' => intval($vars['reseller_id']), 'domain' => $this->result->domain, I471 => $id_member, 'design_id' => intval($vars["fdesign_id"]), 'company_name' => preg_replace('/[^a-zA-Zа-яА-Я0-9_ .-]+/u', I463, $vars[I472]), 'fullname' => preg_replace('/[^a-zA-Zа-яА-Я0-9_ .-]+/u', I463, $vars["firstname"].' '.$vars[I473]), 'password' => unhtmlentities($vars['password']), 'sitemap_type' => $III11lI, 'email' => $vars[I474], I475 => $III11lL[$III11Il]!="0" ?DateTools::toMysqlDate(strtotime($III11lL[$III11Il])) :DateTools::toMysqlDate(0), I476 => $III11Il, 'force_noexpire' => $this->III1LIl ),'dns_add' => $dns );if(!$daemon->TlTTT1I($III11Ll)) return $this->TTTIIl1($daemon->GetLastError(),I447); $resp =$daemon->GetLastResponse(); $tok =explode(' ',$resp); $III11ll[I477] =$this->result->username =$tok[2]; $none =I463; $oSubscriber =new Subscriber($none); $oSubscriber->setUsed("state", false, false); $oSubscriber->setObligatory('password|firstname|lastname|email', true); $oSubscriber->setObligatory('address1|zip', false); $III11LL =$this->frn->Core->GetModOption('wz_designs', 'force_subscribe_to_default_topics'); if(!empty($III11LL)){ $III11ll['topics'] =';' .trim($III11LL, ';') .';'; }$III11L1 =$oSubscriber->TI1ll1T($this->frn, $this->db, $III11ll); $this->result->admPathWWW =$GLOBALS[I478]; }function TTTIIll(&$vars) {if(empty($vars['webname']) || empty($vars['domain_name'])) {trigger_error('Builder::_initRequest() called with empty webname or domain',E_USER_WARNING); $this->TTTIIl1('format_domain_warn',I479); return false; }$domain =mb_strtolower($vars['domain_name']); $sub =mb_strtolower($vars['webname']); if(!preg_match('/^[a-z0-9\-]+$/',$sub) || !preg_match('/^\.[a-z0-9\-]+(\.[a-z0-9\-]+)?$/',$domain)) {$this->TTTIIl1("illegal_domain_warn",I479); return false; }$this->result->subdomain =$sub; $this->result->domain =$sub.$domain; return true; }function TTTIIl1($msg,$type=I446) {$this->result->errtype =I446; switch($type) {case I447: $this->result->msg[I447] =$msg; $this->result->errtype =I447; break; case I446: $this->result->msg[I446][] =$msg; break; default: $this->result->msg[$type] =$msg; break; }return $this->result; }function TTTII1T() {if(!$this->enabled()) return $this->TTTIIl1('builder_disabled','fatal'); if($this->TTTIIII()) return $this->TTTIIl1('limits_reached','fatal'); }function TTTII1I(&$vars) {if(!$this->TTTIIll($vars)) return $this->result; $this->TTTII1T(); if($this->result->errtype!=I445) return $this->result; $this->TTTIIIl(); return $this->result; }function TTTII1l(&$vars) {$this->TTTII1I($vars); if(!$this->TTTIIIT()) return $this->TTTIIl1(I480,'fatal'); if($this->result->errtype!=I445) return $this->result; if(!$this->TTTIIlT($vars,$_SERVER['REMOTE_ADDR'])) return $this->result; $this->TTTIIlI($vars); return $this->result; }}}else{ class BuilderResult {public $subdomain =I463; public $targetDomain =I463; public $domainType ='subdomain'; public $domain =I463; public $errtype =I445; public $msg =array( 'fatal' => I463, I446 => array(), I479 => I463, I447 => I463); public $sitemapDescr =I481; public $username =I481; public $admPathWWW =I463; }class Builder {public $III1LII; public $db; public $frn; public $result; public $III1LIl; public $III1LIL; function Builder(&$III1LII,&$db,&$frn) {$this->III1LII =&$III1LII; $this->db =&$db; $this->frn =&$frn; $this->result =new BuilderResult(); $this->III1LIl =intval($this->III1LII->GetOption(I448)) ?1 :0; }function enabled() {$flags =SiteManager::TI1llT1(); return ($flags &CLOPT_NO_BUILD)==0; }function TTTIIIT() {$flags =SiteManager::TI1llT1(); return ($flags &CLOPT_NO_BUILD_FRONT)==0; }function TTTIIII($remind=true) {global $lang_data,$aWords; $limits =ModuleHstResCmsInst::TIlTTT1(); $stats =ModuleHstResCmsInst::TIlTTIT(); $left =intval($limits['remind_sites_left']); $max =intval($limits[I450]); $III1LI1 =intval($limits[I451]); $err =false; if(($max && $stats['num_sites']>=$max) || ($III1LI1 && $stats[I449]>=$III1LI1)) {$set ='admin_limits_reached'; $err =true; }elseif($remind && $left && ($max && $max-$stats['num_sites']<=$left || $III1LI1 && $III1LI1-$stats[I449]<=$left)) {$set ='admin_limits_remind'; }else {return false; }$this->frn->Gui->addBlock("mail","templates/letters/_wz_letters" .$lang_data .".tpl"); $III1LlI =array(); $III1LlI[I450] =$limits[I450]==0 ?$aWords['unlimited'] :$limits[I450]; $III1LlI[I482] =$limits[I482]==0 ?$aWords['unlimited'] :$limits[I482]; $III1LlI[I451] =$limits[I451]==0 ?$aWords['unlimited'] :$limits[I451]; $III1LlI += $stats; $III1LlI['sites_left'] =$limits[I450]==0 ?$aWords['unlimited'] :$limits[I450]-$stats[I483]; $III1LlI[I452] =$limits[I482]==0 ?$aWords['unlimited'] :$limits[I482]-$stats['num_sites_2level']; $III1LlI[I453] =$limits[I451]==0 ?$aWords['unlimited'] :$limits[I451]-$stats[I449]; $III1Lll =$this->frn->Gui->get('mail:admin_limits',$III1LlI); $III1LlL =$this->frn->Gui->getAbs("mail:${set}_subject", Array()); $III1Ll1 =$_SERVER[I484].$_SERVER['SCRIPT_NAME']; $mbody =$this->frn->Gui->getAbs("mail:${set}_body", array(I454=>$III1Lll,'builder_url'=>$III1Ll1)); require_once($GLOBALS["CLASSES_PATH"]."Mailer.php"); $oMail =new Mailer(); $oMail->RecipientAddress =$this->III1LII->GetOption(I485); $oMail->SenderAddress =$this->frn->Core->GetOption("company_robot_email"); $oMail->SenderName =$this->frn->Core->GetOption("company_name"); $oMail->Subject =$III1LlL; $oMail->Body =$mbody; $oMail->BodyFormat ="html"; $oMail->Prepare(); if(!$oMail->Send()){ trigger_error("WZ_BUILDER: sending email failed to [".$oMail->RecipientAddress.I486, E_USER_WARNING); }return $err; }function TTTII11($III111I =0) {global $lang_data; if ($III111I) {if(!ModuleHstSubscriptions::TIllTII($this->db, $III111I, $lang_data)) {return $this->TTTIIl1('subscription_overbound_warn','fatal'); }}}function TTTIIIl($III111I =0) {$domain =$this->result->domain; $sub =$this->result->subdomain; $d =explode(I455,$domain); array_shift($d); $domain =I455.implode(I455,$d); $III1LLI =$this->III1LII->GetAOption("domain"); $III111l =array(); if($III111I) {$III111L =ModuleHstResVhostInst::TIlIIl1($this->db, $III111I); if(count($III111L)) {foreach($III111L as $dom){ $III111l[".".$dom] =array(); }}}$III1LLI += $III111l; if(count($III111l)) {if(in_array($this->result->targetDomain, $III111l)) {$this->result->domainType =I487; }}$re =str_replace('*', '.*', '/^('.$this->III1LII->GetOption(I456).')$/'); if(preg_match($re, $sub, $m) || !in_array($domain, array_keys($III1LLI))) return $this->TTTIIl1("illegal_domain_warn",I479); $this->III1LIL =$domain; if(mb_strlen($sub) <3 || mb_strlen($sub) >$this->III1LII->GetOption("domain_maxlen")) {return $this->TTTIIl1(I457,I479); }if($this->TTTIII1($this->result->domain)){ return $this->TTTIIl1('domain_name_used',I479); }}function TTTIII1($domain) {$sql ="SELECT id FROM cms_hst_res_vhost_inst WHERE domain='".addslashes($domain)."'"; $this->db->query($sql); if($this->db->next_record()) return true; if(!$this->III1LII->GetOption(I488)) return false; $III1LLl =$this->III1LII->GetAOption('proxy_local_ips'); if(!is_array($III1LLl)) {trigger_error("Empty local IP list",E_USER_WARNING); $III1LLl =array(); }$ip =gethostbyname($domain); if($ip==$domain) return false; array_push($III1LLl,I458); foreach($III1LLl as $III1LLL) {if($III1LLL==$ip) return false; }return true; }function TTTIIlT(&$vars,$ip) {$sid =$vars["sid"]; $III1L1l =$vars["image_num"]; $III1L1L =I460; $III1L1L .= I489.$III1L1l.I461; $III1L1L .= "and sdata2='".$sid."' and ip='".$ip."'"; $sql ="select id from cms_tmp ". I462.$III1L1L.I490; $this->db->query($sql); if(!$this->db->next_record()) {$this->TTTIIl1('image_wrong_warn'); return false; }$sql ="delete from cms_tmp ". I462.$III1L1L; $this->db->query($sql); return true; }function TTTIIlI(&$vars) {global $oMember; $vars["firstname"] =preg_replace('/[^a-zA-Zа-яА-Я0-9_ .-]+/u', I463, trim($vars[I491])); $vars[I473] =preg_replace('/[^a-zA-Zа-яА-Я0-9_ .-]+/u', I463, trim($vars[I473])); $sql ="SELECT id, header FROM cms_wz_designs WHERE id='".intval($vars["fdesign_id"])."'"; $this->db->query($sql); if(!$this->db->next_record()) return $this->TTTIIl1("illegal_design_warn"); $III1L11 =$this->db->Record["header"]; $III11II =$this->III1LII->GetOption("packets"); $III11Il =!in_array($vars[I464], $III11II) ?$this->III1LII->GetOption("default_packet") :$vars[I464]; $sql ="SELECT sys_name, is_default, name, id_tariff, id_period FROM cms_wz_sitemaps ". I492; $this->db->query($sql); $III11IL =Array(); while($this->db->next_record()){ $III11IL[$this->db->Record["sys_name"]] =$this->db->Record["name"]; $III1111[$this->db->Record["sys_name"]] =Array ("id_tariff" => $this->db->Record[I493], "id_period" => $this->db->Record["id_period"]); if ($this->db->Record[I465]){ $III11I1 =$this->db->Record["sys_name"]; }}$III11lI =$vars["sitemap"]; if(!in_array($III11lI, array_keys($III11IL))) {$III11lI =$III11I1; }$this->result->sitemapDescr =$III11IL[$III11lI]; if($this->frn->Member->isLoggedIn()) {$id_member =$this->frn->Member->getUserInfo(I494); $memberUsername =$this->frn->Member->getUserInfo("username"); $sid =$this->frn->Member->Session->sid; $IIlIIII =$this->frn->Member->getUserInfo("host_data"); if(empty($IIlIIII)){ $this->frn->Member->TTI1I1l("host_data", array(I479=>$this->result->domain)); $this->frn->Member->Session->UnsetVar('user'); $this->frn->Member->Session->Il1IIlL[I495] =$this->frn->Member->getUserInfo(); $this->frn->Member->Session->Il1IlII =true; $this->frn->Member->Session->Store(); }}else {$III11ll =$vars; $III11ll["ip"] =$_SERVER["REMOTE_ADDR"]; if(!$oMember->TT1Il1l($this->frn, $this->db, array('member_data' => $III11ll), false)) return $this->TTTIIl1("member_create_warn"); $id_member =$oMember->checkUsername($this->db, $III11ll[I477]); $memberUsername =$III11ll[I477]; if($id_member) {$this->frn->Member->Session->lang=I463; $this->frn->Member->TTI1I1l(I496, $id_member); $this->frn->Member->getUserInfo("", true); $this->frn->Member->TTI1I1l("host_data", array(I479=>$this->result->domain)); $this->frn->Member->Session->UnsetVar(I495); $this->frn->Member->Session->Il1IIlL[I495] =$this->frn->Member->getUserInfo(); $this->frn->Member->Session->Il1IlII =true; $this->frn->Member->Session->Store(); $sid =$this->frn->Member->Session->sid; }}$daemon =new WZDaemon($sid,'inet:localhost:'.$GLOBALS['SHARED_OPT'][I466], $this->III1LII->GetOption(I497),SYSD_F_CONFIRM); $daemon->TI1l1IT($this->frn->Core); if(!$daemon->Ping()) return $this->TTTIIl1($daemon->GetLastError(),I447); WZDaemon::TlTTI1I($daemon); $IIlIIIl =$III1111[$III11lI]['id_tariff'].":".$III1111[$III11lI]['id_period']; $this->frn->Core->Side ='admin'; $IIlIIIL =$vars; $IIlIII1 =$this->frn->VarsPost; $IIlIIlI =$this->frn->VarsGet; $oldVars =$this->frn->Vars; if($this->frn->Member->isLoggedIn() && intval($vars['subscription_number']) >0) {if(ModuleHstSubscriptions::TIlI1lI($this->db, intval($vars['subscription_number']), $id_member)) {$IIlIIll =ModuleHstSubscriptions::TIlI1ll($this->db, intval($vars['subscription_number'])); $IIlIIlL =$IIlIIll['os_user']; $IIlIIl1 =$IIlIIll[I496]; }else {trigger_error("Cannot add vhost to subscription. Access violation.", E_USER_ERROR); }}else {$this->frn->VarsPost =array(I498 => $IIlIIIl, 'audit_new_owner' => $id_member); $this->frn->VarsGet =array(); $this->frn->Vars =$this->frn->VarsPost; $IIlIILI =$this->frn->Core->GetModule('hst_subscriptions'); $IIlIILI->InitEngine($this->frn, $this->db); $IIlIILI->Engine->side ='admin'; $IIlIILI->Engine->realSide ='front'; $IIlIILI->Engine->Init(); $IIlIILI->Engine->SetRedirect(false); $IIlIILI->Engine->ProcessAction(I499, 0); if($IIlIILI->Engine->errno) {trigger_error("Cannot create subscription. Tariff $IIlIIIl, member $id_member", E_USER_ERROR); }$IIlIIlL =$this->frn->VarsPost['os_user']; $IIlIIl1 =$IIlIILI->Engine->appliedId; }$domainType ='common'; $IIlIILl =I463; if($this->frn->Member->isLoggedIn() && intval($vars['subscription_number']) >0) {$III111L =ModuleHstResVhostInst::TIlIIl1($this->db, intval($vars['subscription_number'])); if(in_array(mb_substr($vars[I500], 1), $III111L)) {$domainType =I487; $IIlIILl =mb_substr($vars[I500], 1); }}$this->frn->VarsPost =array('new_subs' => $IIlIIl1, I479 => $this->result->domain, 'type' => $domainType, 'target_domain' => $IIlIILl); $this->frn->VarsGet =array(); $this->frn->Vars =$this->frn->VarsPost; $IIlIILL =$this->frn->Core->GetModule('hst_res_vhost_inst'); $IIlIILL->InitEngine($this->frn, $this->db); $IIlIILL->Engine->side =I501; $IIlIILL->Engine->realSide ='front'; $IIlIILL->Engine->TTTTlIl($id_member); $IIlIILL->Engine->Init(); $IIlIILL->Engine->SetRedirect(false); $IIlIILL->Engine->ProcessAction(I499, 0); if($IIlIILL->Engine->errno) {trigger_error('Cannot create vhost', E_USER_ERROR); }$IIlIIL1 =$IIlIILL->Engine->appliedId; require_once $GLOBALS[I443] .'ClanNode.php'; $node =&ClanNode::getBySubscr($IIlIIl1); $IIlII1I =$node->defaultIP(); $this->frn->Core->Side ='front'; $III11lL =$this->III1LII->GetOption(I502); $III11l1 =array(I468,'sm_site_url', 'sm_site_url_tag', 'sm_site_motto','sm_person_name', I469,I503,'sm_email_tag'); $lc =array(); foreach($III11l1 as $name) $lc[$name] =unhtmlentities(stripslashes($IIlIIIL[$name])); $III11LI =$this->III1LII->GetAOption(I479); if(isset($III11LI[$this->III1LIL])) {$III11LI =$III11LI[$this->III1LIL]; $dns =mb_strpos($III11LI,'dns')!==false ?1 :0; }else {$dns =ModuleHstResVhostInst::TIlIIlI($this->db, $IIlIIl1); }$III11Ll =array( I470 => $lc, "site_data" => array( 'reseller_id' => intval($IIlIIIL[I504]), I479 => $this->result->domain, I471 => $id_member, 'design_id' => intval($IIlIIIL["fdesign_id"]), 'company_name' => preg_replace('/[^a-zA-Zа-яА-Я0-9_ .-]+/u', I463, $IIlIIIL[I472]), I505 => preg_replace('/[^a-zA-Zа-яА-Я0-9_ .-]+/u', I463, $IIlIIIL[I491].' '.$IIlIIIL[I473]), 'password' => unhtmlentities($IIlIIIL['password']), I506 => $III11lI, 'email' => $IIlIIIL[I474], I475 => $III11lL[$III11Il]!="0" ?DateTools::toMysqlDate(strtotime($III11lL[$III11Il])) :DateTools::toMysqlDate(0), I476 => $III11Il, 'force_noexpire' => $this->III1LIl ),'dns_add' => $dns );$this->frn->VarsPost =array( I507 => $IIlIIL1, 'comments' => I463, 'id_admin' => $id_member, I479 => $this->result->domain, 'domainType' => $domainType, 'targetDomain' => $IIlIILl, I508 => $dns, I467 => $IIlII1I, I477 => $IIlIIlL, 'sitemapType' => $III11lI, 'designId' => intval($IIlIIIL["fdesign_id"]), 'resellerId' => intval($IIlIIIL[I504]), I509 => $III11lL[$III11Il]!=I510 ?DateTools::toMysqlDate(strtotime($III11lL[$III11Il])) :DateTools::toMysqlDate(0), I511 => $III11Il, 'clusterMemberId' => $id_member, 'email' => $IIlIIIL['email'], 'info' => I463, I512 => $IIlIIIL[I491], 'lastName' => $IIlIIIL[I473], 'address1' => $IIlIIIL["address1"], 'address2' => $IIlIIIL[I513], 'city' => $IIlIIIL["city"], 'state' => $IIlIIIL["state"], I514 => $IIlIIIL["zip"], 'country' => $IIlIIIL["country"], 'phone' => $IIlIIIL[I515], 'phoneCell' => $IIlIIIL["phoneCell"], 'phoneWork' => $IIlIIIL["phoneWork"], I516 => $IIlIIIL["company"], 'companyWeb' => $IIlIIIL["companyWeb"]."http://www.test.com", I517 => $IIlIIIL["icq"]."123", 'layoutCustomizations' => $lc, 'memberUsername' => $memberUsername, I518 => md5(unhtmlentities($IIlIIIL['password'])), );$this->frn->VarsGet =array(); $this->frn->Vars =$this->frn->VarsPost; $IIlII1l =$this->frn->Core->GetModule('hst_res_cms_inst'); $IIlII1l->InitEngine($this->frn, $this->db); $IIlII1l->Engine->side =I501; $IIlII1l->Engine->realSide ='front'; $IIlII1l->Engine->TTTTlIl($id_member); $IIlII1l->Engine->Init(); $IIlII1l->Engine->SetRedirect(false); $IIlII1l->Engine->ProcessAction(I499, 0); if($IIlII1l->Engine->errno) {trigger_error('Cannot create CMS', E_USER_ERROR); }$this->frn->VarsPost =$IIlIII1; $this->frn->VarsGet =$IIlIIlI; $this->frn->Vars =$oldVars; $none =I463; $oSubscriber =new Subscriber($none); $oSubscriber->setUsed(I519, false, false); $oSubscriber->setObligatory('password|firstname|lastname|email', true); $oSubscriber->setObligatory('address1|zip', false); $III11LL =$this->frn->Core->GetModOption('wz_designs', 'force_subscribe_to_default_topics'); if(!empty($III11LL)){ $III11ll[I520] =';' .trim($III11LL, ';') .';'; }$III11L1 =$oSubscriber->TI1ll1T($this->frn, $this->db, $III11ll); $this->result->admPathWWW =$GLOBALS[I478]; }function TTTIIll(&$vars) {if(empty($vars['webname']) || empty($vars[I500])) {trigger_error('Builder::_initRequest() called with empty webname or domain',E_USER_WARNING); $this->TTTIIl1('format_domain_warn',I479); return false; }$domain =mb_strtolower($vars[I500]); $sub =mb_strtolower($vars['webname']); if(!preg_match('/^[a-z0-9\-]+$/',$sub) || !preg_match('/^(\.[a-z0-9\-]+){2,}$/',$domain)) {$this->TTTIIl1("illegal_domain_warn",I479); return false; }$this->result->subdomain =$sub; $this->result->domain =$sub.$domain; $this->result->targetDomain =$domain; return true; }function TTTIIl1($msg,$type=I446) {$this->result->errtype =I446; switch($type) {case I447: $this->result->msg[I447] =$msg; $this->result->errtype =I447; break; case I446: $this->result->msg[I446][] =$msg; break; default: $this->result->msg[$type] =$msg; break; }return $this->result; }function TTTII1T() {if(!$this->enabled()) return $this->TTTIIl1(I480,'fatal'); if($this->TTTIIII()) return $this->TTTIIl1('limits_reached','fatal'); }function TTTII1I(&$vars) {if(!$this->TTTIIll($vars)) {return $this->result; }$this->TTTII1T(); if($this->result->errtype!=I445) {return $this->result; }$this->TTTII11($vars['subscription_number']); if($this->result->errtype!=I445) {return $this->result; }$this->TTTIIIl($vars['subscription_number']); return $this->result; }function TTTII1l(&$vars) {$this->TTTII1I($vars); if(!$this->TTTIIIT()) return $this->TTTIIl1(I480,'fatal'); if($this->result->errtype!=I445) return $this->result; if(!$this->TTTIIlT($vars,$_SERVER['REMOTE_ADDR'])) return $this->result; $this->TTTIIlI($vars); return $this->result; }}}class ProxyBuilder extends Builder {public $url; function ProxyBuilder(&$III1LII,&$db,&$frn,$url) {parent::Builder($III1LII,$db,$frn); $this->url =$url; }function TTTIlTT(&$vars) {$arr =removeSpecial($vars); $arr['requester'] ='proxy'; $post =I463; foreach($arr as $k=>$v) {$post .= "&$k=".rawurlencode($v); }return mb_strlen($post) ?mb_substr($post,1) :I463; }function TTTIIlI($vars) {$IIlII1L ="[remote: $this->url] "; $up =parse_url($this->url); $vars[I521] =preg_replace('/^\//',I463,$up['path']); $post =$this->TTTIlTT($vars); $url =$up['scheme'].'://'; if(!empty($up[I495])) $url .= $up[I495].I522.$up['pass'].'@'; $url .= $up['host']; if(!empty($up['port'])) $url .= I522.$up[I523]; $url .= '/pages.php'; $cu =curl_init(); curl_setopt($cu, CURLOPT_URL,$url); curl_setopt($cu, CURLOPT_USERAGENT,"Mozilla/4.0 (compatible; MSIE 6; ProxyBuilder)"); curl_setopt($cu, CURLOPT_POST,1); curl_setopt($cu, CURLOPT_POSTFIELDS,$post); curl_setopt($cu, CURLOPT_RETURNTRANSFER,1); curl_setopt($cu, CURLOPT_TIMEOUT,240); $resp =curl_exec($cu); $code =curl_errno($cu); if($code) return $this->TTTIIl1("CURL error [$code]: ".curl_error($cu),I447); $res =unserialize($resp); if(!is_object($res)) {$resp =htmlspecialchars($resp); return $this->TTTIIl1("Invalid response from remote builder: '$resp'",I447); }$this->result =$res; if(!empty($res->msg['fatal'])) {$this->TTTIIl1(I463,'fatal'); return $this->TTTIIl1($IIlII1L.$res->msg[I524],I447); }if($res->errtype==I447) $this->TTTIIl1($IIlII1L.$res->msg[I447],I447); }}class RemoteBuilder extends Builder {function RemoteBuilder(&$III1LII,&$db,&$frn) {parent::Builder($III1LII,$db,$frn); $this->III1LIl =0; }function TTTIIlT(&$vars,$ip) {$IIlII11 =$this->III1LII->GetAOption('allowed_proxy_ips'); if(!is_array($IIlII11)) {$this->TTTIIl1('Access denied (configuration error)',I524); trigger_error('allowed_proxy_ips option is not an array, access denied',E_USER_WARNING); return false; }if(in_array($ip,$IIlII11)) return true; $this->TTTIIl1('Access denied',I524); trigger_error("Request to remote builder from forbidden IP $ip",E_USER_WARNING); return false; }}?>