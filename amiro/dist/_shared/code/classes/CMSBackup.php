<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       14496 xkqwtgzxrgxuplqiizxyzixmytpmrmuwpwkgwiuxktrrlqgiuzpttrgxlsuzpwztntllpnir
 */ ?><?php foreach(array(525=>'yk|whsq',526=>'yk|TqigjzTqd',527=>'yk|Fmjqd|izdk',528=>'zRwo|dbdTbgq|UdqR',529=>'wHrQ',530=>'Zff|MWHnD',531=>'ZIM|DQrvMWQ`GOG',532=>'fGrHW`GOG',533=>'DOHC|nuIMIZPQ`GOG',534=>'WID|IHSuJQD|tQIGJZtQD',535=>'WID|IHSuJQD|tQIGJZtQD|JZnPD',536=>'WID|DMtQ|ZrWOMvQD',537=>'WID|DQDDMHnD',538=>'nHSZtZ',539=>'mmJmJJj',540=>'+',541=>"`DEJ",542=>'DBD|tBGQ',543=>'SQDWrMGtMHn',544=>'fMJQ|DMAQ',545=>'WHntQntD',546=>'~',547=>'yk|ihsFmjqd',548=>'ZrWO|tBGQ',549=>'WID|WZWOQ|YJHWKD',550=>'|ZSIMn',551=>'dozRqs|hgT',552=>'mNdTzjjqR|VqR|imN',553=>'RhhT|gzTo') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} require_once $GLOBALS['CLASSES_PATH'] .'SiteArchive.php'; define(I525, 0x1); define('BK_DB', 0x2); define('BK_LOCALS', 0x4); define('BK_OPTIONS', 0x8); define('BK_MODFILES', 0x10); define(I526, 0x20); define('BK_DB_UPDATE', 0x40); define('BK_ALL', 0x3f); define('BK_SYS_MASK', BK_CODE); define('BK_USER_MASK', BK_ALL &~BK_SYS_MASK); define(I527, BK_CODE |BK_LOCALS |BK_MODFILES); define('BK_DB_MASK', BK_DB |BK_OPTIONS |BK_TEMPLATES); define('ARCH_TYPE_SITEDATA', 1); define('ARCH_TYPE_DISTRIB', 2); define('ARCH_TYPE_UPDATE', 3); define(I528, 1); define('ARCH_SYSTYPE_SYS', 2); class CMSBackup extends SiteArchive {public $IIlIlII; public $IIlIlIl; function CMSBackup(&$db,$id=0) {$this->SiteArchive($db); $this->_id =$id; $this->IIlIlII =$GLOBALS['IIlIlIL'].'var/backup/'; }function TTTIlTI($what) {if($what==0) return $this->TTTITTI("Archive: Zero contents mask"); $IIlIlI1 =array(); $IIlIllI =array(); $IIlIlll =array(); if($what &BK_CODE) {if(!($GLOBALS[I529]->HostMode() &HOSTMODE_SHARED)) {$IIlIlI1[] ='_admin'; $IIlIllI[] ='_admin/_logs'; $IIlIlI1[] ='_shared/code'; }$IIlIlI1[] ='_js'; $IIlIlI1[] =I530; $IIlIlI1[] ='ftpicons'; $IIlIlI1[] ='treeimgs'; $IIlIlI1[] ='ami_env.php'; $IIlIlI1[] ='ami_resp.php'; $IIlIlI1[] =I531; $IIlIlI1[] ='aproc.php'; $IIlIlI1[] ='calendar.php'; $IIlIlI1[] ='cm_ini.php'; $IIlIlI1[] ='eshop_final.php'; $IIlIlI1[] =I532; $IIlIlI1[] ='ftpgetfile.php'; $IIlIlI1[] ='index.php'; $IIlIlI1[] ='pages.php'; $IIlIlI1[] ='readconf.php'; $IIlIlI1[] =I533; $IIlIlI1[] ='show_pic.php'; $IIlIlI1[] =toStr(array(97, 109, 105, 114, 111, 95, 115, 121, 115, 95, 99, 115, 115, 46, 112, 104, 112)); $IIlIlI1[] =toStr(array(97, 109, 105, 114, 111, 95, 115, 121, 115, 95, 106, 115, 46, 112, 104, 112)); }if($what &BK_LOCALS) {$IIlIlI1[] ='_local'; $IIlIllI[] ='_local/_admin/templates'; $IIlIllI[] ='_local/config.ini.php'; $IIlIllI[] ='_local/config.inc.php'; }if($what &BK_TEMPLATES) {$IIlIlll[] =I534; $IIlIlll[] =I535; }if($what &BK_MODFILES) {$IIlIlI1[] ='_mod_files'; $IIlIlI1[] ='_img'; }if($what &BK_OPTIONS) $IIlIlll[] ='cms_options'; if($what &(BK_DB|BK_DB_UPDATE)) {$this->TI1lIll($this->db->tableList('/^cms_/')); $this->TI1lIl1(array(I536,'cms_updates')); if(!($what &BK_DB_UPDATE)) {$this->TI1lIl1(array( 'cms_host_users','cms_members', 'cms_host_login_history',I537,'cms_cookies')); $this->TI1lIl1(array('cms_cache','cms_cache_blocks','cms_cache_content'),I538); }}elseif(sizeof($IIlIlll)) {$this->TI1lIll($IIlIlll); }$this->TI1lIlT($IIlIlI1); $this->TI1lIlI($IIlIllI); $this->TI1lIlI(array('_shared/sys/var','_admin/_logs')); $this->lllLL1l['arch_type']=ARCH_TYPE_SITEDATA; $this->lllLL1l['contents'] =$what; $this->IIlIlIl =$this->TTTIlTl($GLOBALS[I539]); return true; }function TTTIlTl($IIlIll1) {$IIlIll1 =sprintf("%s-%03x-%d",$IIlIll1,$this->lllLL1l['contents'],$this->tstamp()); if($this->gz) $ext ='.tar.gz'; else $ext ='.tar'; if(!file_exists($this->IIlIlII.$IIlIll1.$ext)) {return $IIlIll1.$ext; }$i =1; for($IIlIlLI=$IIlIll1.I540.$i.$ext; file_exists($this->IIlIlII.$IIlIlLI); $i++); return $IIlIlLI; }function TTTIlT1($data) {if(!$this->TTTIlTI($data['contents'], isset($data['skip_existing_backups']) ?$data['skip_existing_backups'] :0)) return false; $this->archive =$this->IIlIlII.$this->IIlIlIl; $this->llL11ll ="dump-".$this->tstamp().I541; return true; }function create() {if(!parent::create()) return false; chmod($this->archive,0666); return $this->TTTIlIT(); }function TTTIlIT() {$oDB =AMI::getSingleton('db'); $tstamp =$this->tstamp(); $aSql =array( 'arch_type' => $this->lllLL1l['arch_type'], 'sys_type' => $this->lllLL1l[I542], 'contents' => $this->lllLL1l['contents'], 'meta' => $oDB->escape(serialize($this->lllLL1l)), 'description' => $oDB->escape($this->lllLL1l[I543], false), 'filename' => $this->IIlIlIl, 'site_id' => $this->lllLL1l['site_id'], 'tstamp' => "=|FROM_UNIXTIME($tstamp)", I544 => intval(@filesize($this->archive)) );$sql =$this->db->GenInsertSql(I536,$aSql); $this->db->execute($sql,DBC_RAW_QUERY); $this->_id =$this->db->lastInsertId(); return true; }function TTTIlII() {if(is_array($this->lllLL1l)) return true; $rec =$this->db->getRecord('SELECT `filename`,`meta` '. 'FROM `cms_site_archives` WHERE id='.intval($this->_id),DBC_RAW_QUERY); if(!$rec) return $this->TTTITTI("CMSBackup id=$this->_id not found in DB"); return $this->TTTIlI1($this->IIlIlII.$rec['filename']); }function TTTIlIl() {if(is_array($this->lllLL1l)) return true; $rec =$this->db->getRecord('SELECT `filename`,`meta` '. 'FROM `cms_site_archives` WHERE id='.intval($this->_id),DBC_RAW_QUERY); if(!$rec) return $this->TTTITTI("CMSBackup id=$this->_id not found in DB"); $this->IIlIlIl =$rec['filename']; $this->archive =$this->IIlIlII.$rec['filename']; $this->lllLL1l =unserialize($rec['meta']); return parent::TTTIlII(); }function TTTIlI1($archive) {if(!file_exists($archive)) {return $this->TTTITTI("Cannot load archive from '$archive': file not found"); }$this->archive =$archive; if(!parent::TTTIlII()) return false; $this->IIlIlIl =$this->TTTIlTl($this->lllLL1l['site_id']); return true; }function save($path=false) {if(!@rename($this->archive,$this->IIlIlII.$this->IIlIlIl)) return $this->TTTITTI("Cannot move $this->archive to $this->IIlIlII"); $this->archive =$this->IIlIlII.$this->IIlIlIl; @chmod($this->archive,0666); return $this->TTTIlIT(); }function meta() {if(!$this->TTTIlII()) return false; return $this->lllLL1l; }function restore($IIlIlLl=false) {if(!$this->TTTIlII()) return false; $meta =$this->meta(); if($meta[I545] &BK_DB) $this->db->execute('DROP TABLE IF EXISTS cms_members_', DBC_TRUSTED_QUERY); if(!parent::restore($IIlIlLl)) return false; if(!($meta[I545] &BK_DB)) return true; $l =$this->db->tableList('/^cms_members_$/'); if(!is_array($l) || !sizeof($l)) {trigger_error("Full DB restored from archive, cms_members_ not found: arch ID=".$this->id(),E_USER_WARNING); return true; }$mr =$this->db->getRecord('SELECT m.* FROM cms_host_users u, cms_members m '. 'WHERE u.sys_user=1 AND u.id_member=m.id',DBC_RAW_QUERY); if(!$mr) return $this->TTTITTI("Cannot get sys member from DB after restoring archive: arch ID=".$this->id()); $sql =$this->db->genInsertSQL('cms_members',$mr,DBC_GEN_REPLACE); $this->db->execute('DROP TABLE cms_members',DBC_RAW_QUERY); $this->db->execute('RENAME TABLE cms_members_ TO cms_members',DBC_RAW_QUERY); $this->db->execute($sql,DBC_RAW_QUERY); return true; }function delete() {if(!$this->TTTIlIl()) return false; if(!parent::delete()) return false; $tmp =explode(I546,$this->IIlIlIl); if(sizeof($tmp)==2) @rmdir($this->IIlIlII.$tmp[0]); $this->db->execute('DELETE FROM cms_site_archives WHERE id='.intval($this->_id),DBC_RAW_QUERY); return true; }public static function TTTIllT($items) {static $names =array( BK_CODE => I525, BK_DB => 'BK_DB', BK_LOCALS => 'BK_LOCALS', BK_OPTIONS => 'BK_OPTIONS', BK_MODFILES => I547, BK_TEMPLATES => I526 );$n =array(); for($i=1; $i<=$items; $i<<=1) if($items &$i) if(array_key_exists($i,$names)) $n[$i] =$names[$i]; else $n[$i] ='BK_UNKNOWN'; return $n; }function TTTIllI(&$db,$id) {$id =intval($id); $rec =$db->getRecord("SELECT id FROM cms_site_archives WHERE id=$id",DBC_RAW_QUERY); if(!$rec) return true; $IIlIlLL =new CMSBackup($db,$rec['id']); return $IIlIlLL->delete(); }}class CMSDistrib extends CMSBackup {function TTTIlTI($what, $skip =0) {require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_file_system.php"); $Core =&$GLOBALS[I529]; $this->lllLL1l[I548]=ARCH_TYPE_DISTRIB; $ver =$Core->getVersion('cms','code'); $this->TI1lIll('*'); $this->TI1lIl1(array('cms_cache',I549,'cms_cache_content','cms_google_sitemap','cms_host_login_history'),I538); $this->TI1lIlT(array('.')); $this->TI1lIlI(array('_admin/_logs/err.log','_local/config.inc.php','_local/config.ini.php','masterhost')); if($Core->HostMode() &HOSTMODE_SHARED) {$this->TI1lIlI(array('_shared/code',I550)); $IIlIlL1 =$GLOBALS['SHARED_OPT']['code_distr_dir']."code-$ver.tar.gz"; if (!file_exists($IIlIlL1)) {$IIlIl1I =explode('.', $ver); if (count($IIlIl1I) === 4) {$IIlIl1I[3] =0; $IIlIl1I =implode('.', $IIlIl1I); $IIlIlL1 =$GLOBALS[I551]['code_distr_dir']."code-$IIlIl1I.tar.gz"; }}$this->TI1TTT1($IIlIlL1); }$this->lllLL1l[I545] =BK_ALL; $this->lllLL1l['inst_ver_min'] =$GLOBALS[I552]; $this->IIlIlIl =$this->TTTIlTl("cms-$ver-".$GLOBALS[I539]); $this->TI1lIlI(array("_shared/sys/var/$this->IIlIlIl")); if ($skip) {$this->TI1lIl1(array(I536,'cms_updates'),I538); $files =getFiles($GLOBALS['ROOT_PATH'].'_shared/sys/var/backup'); foreach ($files as $file) $this->TI1lIlI(array(str_replace($GLOBALS['ROOT_PATH'], '', $file))); $files =getFiles($GLOBALS['ROOT_PATH'].'_shared/sys/var/updates'); foreach ($files as $file) $this->TI1lIlI(array(str_replace($GLOBALS[I553], '', $file))); $files =getFiles($GLOBALS[I553].'_shared/code/updates', true, true); foreach ($files as $file) {if ($file !== $GLOBALS[I553].'_shared/code/updates/add_new_options.php') {$this->TI1lIlI(array(str_replace($GLOBALS[I553], '', $file))); }}}return true; }}