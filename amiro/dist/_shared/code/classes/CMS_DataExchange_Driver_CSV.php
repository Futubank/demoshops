<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    dataecxchange 
 * @subpackage csv 
 * @version    $Id$ 
 * @size       7286 xkqwmsxgmlsrnrgxlrppnznnpwmntzzlpukulnrxitwxqrllzytttkugqwlyzuwmmgqqpnir
 */ ?><?php foreach(array(1620=>'^',1621=>'GZrZID',1622=>'gRmwq|Tbgq',1623=>'RqFqRqNwq',1624=>'RqFqRqNwq|Nziq|',1625=>'!',1626=>'WHJuIn|MS',1627=>'fnuI') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class CMS_DataExchange_Driver_CSV{ private $II11IIL; private $II11II1 =null; private $II11IlI; public function __construct($oDriver, $aParams){ $this->II11IlI =false; $this->II11IIL =$oDriver; $this->II11IIL->delim =$aParams['vars']['delim']; if(mb_strlen($this->II11IIL->delim) != 1){ $this->II11IIL->delim =I1620; }}public function TTIlTIl($fp, $II11Ill =false){ $res =true; if ($II11Ill || $this->II11IlI) {$aData =fgetcsv($fp, $this->II11IIL->Il11LIl, $this->II11IIL->delim); TlT1lT1($aData); }if ($this->II11IlI) {return $res; }if (isset($aData) && is_array($aData) && sizeof($aData)) {$label ='META.CSV::'; if (mb_strpos($aData[0], $label) === 0) {$this->II11IlI =true; $II11IlL =&$this->II11IIL->_config['fields']; $aData[0] =mb_substr($aData[0], mb_strlen($label)); $this->II11IIL->module->TTIlTT1(0, array ('message' => 'status_metadata_is_used', I1621 => array ()));foreach ($aData as $column => $II11Il1) {if (trim($II11Il1) == '') {continue; }$II11Il1 =explode('|', $II11Il1); foreach ($II11Il1 as $II11ILI) {if (preg_match('/^([A-Z]+)_([A-Z\d_]+)$/', $II11ILI, $aMatches)) {list (,$groupName, $field) =$aMatches; if (mb_strpos($II11ILI, 'PRICE_TYPE_') !== 0) {$II11ILl =empty($II11IlL[$groupName][$field]); }else if (preg_match('/^PRICE_TYPE_(\d+)_([\A-Z\d_]+)$/', $II11ILI, $aMatches)) {$groupName ='PRICE_TYPE'; $priceNumber =$aMatches[1]; $field =$aMatches[2]; $II11ILl =empty($II11IlL[$groupName][$priceNumber][$field]); }else {$II11ILl =true; }if ($II11ILl) {$this->II11IIL->TTIIlT1('10030', 'import_eshop_wrong_meta', array ('column_id' => $II11ILI)); $res =false; break 2; }if ($groupName != I1622) {$II11IlL[$groupName][$field] =array ('type' => 'column', 'value' => $column );if (preg_match('/^CUSTOM_FIELD_(\d+)$/', $field, $aMatches)) {$this->TTIlTI1(); $fnum =$aMatches[1]; if( isset($this->II11II1[$fnum]) && isset($II11IlL[I1623]['CUSTOM_' .($II11ILL =sprintf('%04d', $this->II11II1[$fnum]))]) ){$II11IlL[I1623]['CUSTOM_' .$II11ILL] =array( 'name' => I1624 .$II11ILL, 'num' => $column );}}}else {$II11IlL[$groupName][$priceNumber][$field] =array ('type' => 'column', 'value' => $column );}}else {$aChars =count_chars($II11ILI); if ($aChars[ord($this->delim == I1620 ?I1625 :I1620)] >3) {$this->II11IIL->module->TTIlTT1(1, array ('message' => 'status_import_eshop_possible_wrong_delimeter', I1621 => array ()));}$this->II11IIL->TTIIlT1('10031', 'import_eshop_wrong_meta', array (I1626 => $II11ILI)); $res =false; break 2; }}}}else {rewind($fp); }}else {rewind($fp); }return $res; }private function TTIlTI1(){ if(is_null($this->II11II1)){ $this->II11II1 =array(); $sql ="SELECT `fnum`, `ref_table_num` " ."FROM " .$this->II11IIL->module->oEshop->dbTablePrefix ."_custom_types " ."WHERE `ref_table_num` > 0 AND `value_type` IN ('ref_value', 'ref_reference', 'ref_set')"; $rs =&$this->II11IIL->module->db->select($sql); while($record =$rs->nextRecord()){ $this->II11II1[$record[I1627]] =$record['ref_table_num']; }}}}