<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       33055 xkqwipnpnmygymrwmtzwusyltuuzuwgsppgqqxzrwungywkqprtkupwuyguqupqmiuygpnir
 */ ?><?php foreach(array(1678=>'',1679=>'IQIYQrD|JMnK',1680=>'DKMG|IHSuJQ|fMJtQr',1681=>'fJt|MS|GZrQnt',1682=>'tQxt',1683=>'fJt|ZutOHr',1684=>'mNqT|NThz}.MG.{',1685=>'OMSSQn',1686=>'funW|WHnvQrt`GOG',1687=>'!',1688=>"coqRq?.MS.?=?",1689=>"[",1690=>"ZJJ",1691=>"GuYJMW",1692=>"-",1693=>'!?',1694=>"{",1695=>"",1696=>'?',1697=>"MS",1698=>"?coqRq?MS='",1699=>'=_',1700=>"'",1701=>"?coqRq?MS??mN}",1702=>"YHtO",1703=>"coqRq?MS?mN}",1704=>'EtB',1705=>"rHCD",1706=>"?",1707=>'HffDQt',1708=>"MS!?MS|GZrQnt",1709=>'MS',1710=>'MS|IQIYQr',1711=>'SQfZuJt|GrQfMx',1712=>"?coqRq?1?",1713=>'QSMt') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class CMS_Discussion extends CMS_Forum {public $II11IL1; public $II11I1I =" WHERE 1 "; public $II11I1l; public $II11I1L; public $II11I11; public $II11lII; public $II11lIl; public $II11lIL =0; public $II11lI1; public $II11llI; public $II11lll; public $II11llL; public $II11ll1; protected $isFront =false; protected $II11lLI; protected $II11lLl; protected $II11lLL =FALSE; protected $II11lL1 =FALSE; protected $II11l1I =FALSE; protected $II11l1l =FALSE; function CMS_Discussion(&$cms, &$db, &$cModule) {parent::CMS_Forum($cms, $db, $cModule); }function _Init($IIll1l1 =array (),$IIll1LI ='', $IIll1Ll =I1678, $aOptions =array ()){$this->II11IL1 =$this->module->issetAndTrueOption('use_tree_view'); $IIIIL11 =array ('use_id_page' => false, 'use_options_form' => false );$aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->II11I1l =array ();$this->II11I1L =array ();$this->II11lIl =array ();$this->II11I11 =0; $this->II11lII =array ();}function _InitAdmin() {parent::_InitAdmin(); $vMod =&$this->cms->Core->GetModule('members'); $this->cms->Gui->AddGlobalVars(array (I1679 => $vMod->GetAdminLink())); $prefix =str_replace('.', I1678, $this->options['default_prefix']); $this->II11I1I =" WHERE 1 " .$this->_ApplyFilters(I1678, I1680); $this->II11lLI =(bool)AMI::getSingleton('env/async50')->getInitializedModId(); $this->II11lLl =$this->II11lLI && !empty($this->II11IL1) && !empty($this->cms->Vars[I1681]); }function TTTlTI1() {parent::TTTlTI1(); $this->cms->Gui->AddGlobalVars(array ('FRONT_MEMBERS_LINK' => $this->cms->Core->GetModFrontLink('members'))); $this->II11I1I =" WHERE 1 " .$this->_ApplyFilters(I1678, I1680); }function TTTlIII($II11l1L =true) {if ($II11l1L) {parent::TTTlIII(); }else if ($this->II11llL) {$this->filter->AddField('flt_author', I1682, isset($this->cms->Vars['flt_author']) ?stripslashes(unhtmlentities($this->cms->Vars['flt_author'])) :I1678, I1678, ' LIKE ', "`author`"); if (empty($this->cms->Vars[I1683])) {$this->filter->DisableFieldSQL(I1683); }$this->filter->AddField('flt_ip', I1682, isset($this->cms->Vars['flt_ip']) ?stripslashes(unhtmlentities($this->cms->Vars['flt_ip'])) :I1678, I1678, ' = ', I1684); if (empty($this->cms->Vars['flt_ip'])) {$this->filter->DisableFieldSQL('flt_ip'); }}$this->filter->AddField(I1681, 'hidden', isset($this->cms->Vars[I1681]) ?(int)$this->cms->Vars[I1681] :I1678); if(!$this->II11lLI){ $this->filter->DisableFieldSQL(I1681); }$this->filter->AddField('flt_parent_level', I1685, isset($this->cms->Vars['flt_parent_level']) ?(int)$this->cms->Vars['flt_parent_level'] :I1678); $this->filter->DisableFieldSQL('flt_parent_level'); }function TTTlI11(&$vData, &$aCustom) {require_once $GLOBALS['FUNC_INCLUDES_PATH'] .I1686; parent::TTTlI11($vData, $aCustom); }function TTIlTlT($parentId) {$this->TTI1TI1(); $parentId =intval($parentId); $ids =$this->TTIlTl1($parentId, true); if (sizeof($ids)) {$sql ="SELECT SUM(1) `count_children`, SUM(`public`) `count_public_children` " ."FROM " .$this->module->GetTableName() ." " ."WHERE `id` IN (" .implode(I1687, $ids) .")"; $aSQL =$this->db->getRecord($sql); $sql =$this->db->genUpdateSQL($this->module->GetTableName(), $aSQL, "WHERE `id` = " .$parentId); $this->db->execute($sql); $ids =$this->TTIlTl1($parentId, false); foreach ($ids as $parentId) {$this->TTIlTlT($parentId); }}elseif ($parentId) {$aSQL =array ('count_children' => 0, 'count_public_children' => 0); $sql =$this->db->genUpdateSQL($this->module->GetTableName(), $aSQL, I1688 .$parentId); $this->db->execute($sql); }}function TTIlTlI($id) {if (isset($this->II11lII[$id])) {$this->II11I11 =$this->II11lII[$id]; }else {$ids =$this->TTIlTll($id); $this->II11I11 =intval(array_pop($ids)); }}function TTIlTll($id) {if (!isset($this->II11I1l[$id])) {$parentId =$id; $ids =array ();do {$sql ="SELECT `id_parent` FROM " .$this->module->GetTableName() ." WHERE id = " .$parentId; $parentId =$this->db->getValue($sql); $ids[] =$parentId; }while ($parentId != 0); array_pop($ids); $this->II11I1l[$id] =$ids; }return $this->II11I1l[$id]; }function TTIlTl1($parentId, $II11l11 =true) {if (!isset($this->II11I1L[$parentId])) {$ids =array ();$sql ="SELECT `id` FROM " .$this->module->GetTableName() ." WHERE `id_parent` = " .$parentId; $rs =&$this->db->select($sql); while (list ($id) =$rs->nextRecord(MYSQL_NUM)) {$this->TTI1TI1(); $ids[] =$id; if ($II11l11) {$ids =array_merge($ids, $this->TTIlTl1($id)); }}$this->II11I1L[$parentId] =$ids; }return $this->II11I1L[$parentId]; }function TTIlT1T($id, $II11LII =I1678) {$aItem =array ();$caching =false; if ($id >0) {if($II11LII == I1678 && isset($this->II11lIl[$id])) {$aItem =$this->II11lIl[$id]; }else {if ($II11LII == I1678) {$caching =true; $II11LII =I1689; }$sql ="SELECT ".$II11LII." FROM ". $this->module->GetTableName() ." WHERE id = " .$id; $aItem =$this->db->getRecord($sql); if ($aItem) {if ($caching) {$this->II11lIl[$id] =$aItem; }}else {$aItem =array ();}}}return $aItem; }function TTIlT1I($II11LIl ="+", $II11LIL =I1690, $aItem ="", $II11LI1 ="") {if ($this->appliedId >0) {$II11LlI =""; $II11Lll =""; if(!is_array($II11LIl)) {$II11LIl =Array(I1691 => $II11LIl, I1690 => $II11LIl); }if($II11LIl[I1691] == "+" || $II11LIl[I1691] == "-") {if(!is_array($aItem)) {$aItem =$this->TTIlT1T($this->appliedId); }$II11Lll =$aItem["count_public_children"]; if($II11LIl[I1691] == "-") {$II11Lll++; }}if($II11LIl[I1690] == I1692 || $II11LIl[I1690] == "-") {if(!is_array($aItem)) {$aItem =$this->getItem($this->appliedId); }$II11LlI =$aItem["count_children"]; if($II11LIl[I1690] == "-") {$II11LlI++; }}$ids =$this->TTIlTll($this->appliedId); $itemIds =implode(I1687, $ids); $II11LlL =(isset($II11LIl[I1690]) && ($II11LIl[I1690] == '-')) ?"count_children=IF(count_children>0,count_children".$II11LIl[I1690].$II11LlI.", 0) " :"count_children=count_children".$II11LIl[I1690].$II11LlI." "; $II11Ll1 =(isset($II11LIl[I1691]) && ($II11LIl[I1691] == '-')) ?"count_public_children=IF(count_public_children>0,count_public_children".$II11LIl[I1691].$II11Lll.", 0) " :"count_public_children=count_public_children".$II11LIl[I1691].$II11Lll." "; if(!empty($itemIds)) {switch($II11LIL) {case I1690: $II11LLI =$II11LlL; break; case "both": $II11LLI =$II11LlL .I1693 .$II11Ll1; break; case I1691: $II11LLI =$II11Ll1; break; }$sql ="UPDATE " .$this->module->GetTableName() ." SET ".$II11LLI." ".$II11LI1." WHERE id IN(".$itemIds.I1694; $this->db->execute($sql); foreach ($ids as $id) {unset($this->II11lIl[$id]); }}}}function TTIlT1l($parentId, $II11LII ="", $II11LLl =false, $II11LLL =false, $II11LL1 ="") {static $II11L1I; $II11L1l =array ();$parentId =intval($parentId); if($II11LLl) {$II11L1L =$this->II11lI1; }else {$II11L1L =""; }if($II11LLL && is_object($this->filter)) {$II11L11 =$this->II11I1I; }else {$II11L11 =" WHERE 1 "; }if($II11LII == I1695) {if (empty($II11L1I)) {$II11L1I =empty($this->II11lll) ?$this->cms->DFMT["db_dtime"] :$this->II11lll; if ($this->side == 'front') {$II11L1I =str_replace(':%s', I1678, $II11L1I); }}$II11LII ="*, DATE_FORMAT(date,'".$II11L1I."') AS fdate, UNIX_TIMESTAMP(date) `unixtime` "; }$prefix =str_replace('.', I1678, $this->options['default_prefix']); $sql ="SELECT ".$II11LII." FROM ".$this->module->GetTableName() .I1696 .$prefix .$II11L11." AND id_parent='".$parentId."' ".$II11L1L." ".$II11LL1; $rs =&$this->db->select($sql); while ($record =$rs->nextRecord()) {$II11L1l[] =$record; }return $II11L1l; }function TTIlT11($parentId, $level =-1) {$II11L1l =$this->TTIlT1l($parentId, "id"); $level++; foreach($II11L1l as $index => $aChild) {$itemIds .= $aChild[I1697].","; $itemIds .= $this->TTIlT11($aChild[I1697], $level); }if($level == 0 && !empty($itemIds)) {$itemIds =substr_replace($itemIds, I1695, mb_strlen($itemIds) -1, 1); }return $itemIds; }function TTIlITT(&$aItem, $II11LI1 =I1695, $II111II =0) {$itemId =$aItem['id']; $i =$II111II; $II111Il =0; if ($aItem['id_parent'] >0) {do {$sql ="SELECT id, id_parent, public FROM " .$this->module->GetTableName() .I1698 .$itemId ."'"; $record =$this->db->getRecord($sql); if($record['public'] == 0) {$aSQL =array ('public' => 1, 'count_public_children' => I1699 .$i .$II11LI1); $i++; $II111Il =$record['id_parent']; }else {$aSQL =array ('count_public_children' => '=|count_public_children+' .$i .$II11LI1); }$sql =$this->db->genUpdateSQL($this->module->GetTableName(), $aSQL, "WHERE id = '" .$itemId .I1700); $this->db->execute($sql); $itemId =$record['id_parent']; }while($itemId != 0); }return $II111Il; }function TTIlITI($aItem, $public, $II111IL =true) {if ($aItem[I1691] != $public) {$itemId =$aItem[I1697]; $II111I1 =I1695; $II111II =0; $field =I1695; $itemIds =I1678; if ($public) {if($aItem["id_parent"] == 0) {if($field != I1695) {$field .= ", "; }$field .= "public=1"; }$II111lI =I1692; }else {$itemIds =$this->TTIlT11($itemId); $field =" public=0 , count_public_children=0"; $II111lI ="-"; }if (!empty($itemIds)) {$itemIds .= ","; }$itemIds .= $itemId; if($field != I1695) {$sql ="UPDATE ".$this->module->GetTableName()." SET ".$field.I1701.$itemIds.I1694; $this->db->query($sql); }if($II111IL) {if($public) {$aItem["firstPublicItem"] =$this->TTIlITT($aItem, I1695, $II111II); }else {$this->TTIlT1I($II111lI, I1691, $aItem, $II111I1); }}$aItem[I1691] =$public; }}function TTIlITl($aItem) {$itemIds =$this->TTIlT11($aItem[I1697]); if(!empty($itemIds)) {$itemIds .= ","; }$itemIds .= $aItem[I1697]; $this->appliedId =$aItem[I1697]; $this->TTIlT1I("-", $aItem['public'] ?I1702 :'all', $aItem); $sql ="SELECT `id_member`, COUNT(`id`) `qty` " ."FROM " .$this->module->GetTableName() ." " .I1703 .$itemIds .") AND `id_member` AND `public` = 1 " ."GROUP BY `id_member`"; $II111ll =array(); $oRS =$this->db->select($sql); while($aRecord =$oRS->nextRecord()){ if($aRecord['qty']){ $II111ll[$aRecord['id_member']] =$aRecord[I1704]; }}$sql ="DELETE FROM ".$this->module->GetTableName()." WHERE id IN(".$itemIds.I1694; $this->db->execute($sql); $res =$this->db->affectedRows(); if($res){ foreach($II111ll as $memberId => $qty){ $this->TTI1Tl1($memberId, -$qty); }}return $res; }function TTIlIT1($parentId, $II111lL, $II111l1 =0, $II111LI, $II111Ll =-1, $countItems =0) {$II111LL =array ();if((($II111LI +$II111l1 +1) >$countItems) || $II111LI == 0) {$II11L1l =$this->TTIlT1l($parentId, I1695, true, true); $II111L1 =Array(); $II111Ll++; $II1111I =0; $II1111l =false; foreach($II11L1l as $index => $aChild) {$countItems++; if($parentId == 0) {$this->_currentLock =!empty($aChild["locked"]); }$II1111I =$countItems; if((($II111LI +$II111l1 +1) <= $II1111I) && $II111LI >0 && !$II1111l) {break; }$aChild["tree_level"] =$II111Ll; $aChild["current_item_number"] =$countItems; if(($II111l1 <$II1111I) || $II1111l) {$II111LL[] =$aChild; }if($this->_public == "1") {$II1111L =$aChild["count_public_children"]; }else {$II1111L =$aChild["count_children"]; }if( ($this->isFront ?$aChild['count_public_children'] :true) && (($II111l1 <($II1111I +$II1111L)) || $II1111l) ){$children =$this->TTIlIT1($aChild[I1697], $II111lL, $II111l1, $II111LI, $II111Ll, $countItems); $II111LL =array_merge($II111LL, $children[I1705]); $countItems =$children["count_items"]; }else {$countItems += $II1111L; }}}$res =array (I1705 => $II111LL, "count_items" => $countItems); return $res; }function TTIlIIT($topicId =0, $II11111 =I1690) {if(!$this->II11llI) {if(is_object($this->filter)) {$filter =$this->filter->GetFilterSql(); $prefix =str_replace('.', I1678, $this->options['default_prefix']); }else {$filter =$prefix =I1695; }if($topicId >0) {if($this->_public) {$sql ="SELECT count_public_children AS num FROM ".$this->module->GetTableName() .I1696 .$prefix .$this->II11I1I." AND id=".$topicId." ".$filter; }else {$sql ="SELECT count_children AS num FROM ".$this->module->GetTableName() .I1696 .$prefix .$this->II11I1I." AND id=".$topicId.I1706.$filter; }}else {$sql ="SELECT count(*) AS num FROM ".$this->module->GetTableName() .I1696 .$prefix .$this->II11I1I.I1706.$filter; if($II11111 == "topics") {$sql .= " AND id_parent='".$parentId.I1700; }}$this->II11llI =$this->db->getValue($sql); }return $this->II11llI; }function TTIlIII($parentId, $II111lL =I1695) {$this->browser->MaxCount =$this->TTIlIIT($parentId); if($this->appliedId >0) {$this->II11lIL =$parentId; $this->browser->Position =$this->II11lLI ?$this->appliedId :$this->TTIlII1(); }$this->browser->TI1TT1I(); $II111LI =$this->browser->PageSize; $II111l1 =intval($this->browser->Position); if ($this->filter->issetField('offset')) {$this->filter->UpdateField(I1707, $II111l1); }$res =$this->TTIlIT1($parentId, $II111lL, $II111l1, $II111LI); return $res; }function TTIlIIl() {$this->II11llI =I1695; $this->_parentItemIds =Array(); $this->II11lIl =I1695; }function TTIlII1($aItem =I1695) {$this->TTIlIIl(); $position =0; if(!is_array($aItem)) {$aItem =$this->TTIlT1T($this->appliedId, "id, id_parent"); }$itemId =$aItem["id_parent"]; $IILILLL =$this->appliedId; if($this->_public == 1) {$field ="count_public_children"; }else {$field ="count_children"; }do {$IlIIIII =$this->TTIlT1T($itemId, I1708); $II11L1l =$this->TTIlT1l($itemId, " id, id_parent, ".$field, true, true); foreach($II11L1l AS $index => $aChild) {$position++; if($IILILLL == $aChild[I1697]) {break; }$position += $aChild[$field]; }$IILILLL =$itemId; $itemId =$IlIIIII["id_parent"]; }while($IILILLL != $this->II11lIL); return $position-1; }function _GetFrontItemCB(&$aItem, &$aData) {static $IlIIIIl; if ($this->II11ll1 && $this->II11ll1 == $aItem['id_member']) {if ($this->II11IL1) {$IlIIIIL =!$aItem['count_children']; }else {if (!isset($IlIIIIl)) {$IlIIIIl =$this->module->GetOption('front_page_sort_dim') == 'asc' ?$this->browser->MaxCount +1 :0; }$IlIIIIL =$aItem['abs_row_index'] == $IlIIIIl; }if ($IlIIIIL) {$aItem['front_edit'] =$this->cms->Gui->getAbs($this->moduleName .'_list:front_edit', array (I1709 => $aItem[I1709], 'splitter' => ' | ', 'expire' => $aItem['unixtime'] +$this->IlIlLl1, I1710 => $aItem[I1710] ));}}foreach (array ('author', 'msg_author') as $k) {if (isset($aItem[$k])) {$this->TTI1TIl($aItem[$k]); }}}function TTIlIlT($message) {$IlIIII1 =false; $IlIIIlI =sizeof($this->IlIlLIL) ?$this->IlIlLIL[I1709] :0; if ($IlIIIlI) {$IlIIIll =intval($this->cms->VarsPost['id_update']); $prefix =str_replace('.', I1678, $this->options[I1711]); $sql ="SELECT `id_member`, `count_children` FROM " .$this->module->GetTableName() .I1706 .$prefix ." WHERE id = " .$IlIIIll .$this->_ApplyFilters(); if (($row =$this->db->getRecord($sql)) && $IlIIIlI == $row[I1710]) {if ($this->II11IL1) {$IlIIIIL =!$aItem['count_children']; }else {$sql ="SELECT MAX(`id`) FROM " .$this->module->GetTableName() .I1706 .$prefix .I1712 .$this->_ApplyFilters(); $IlIIIIL =$this->db->getValue($sql) == $IlIIIll; }if ($IlIIIIL) {$aSQL =array ('modified_date' => '=|NOW()', 'message' => $message );$sql =$this->db->genUpdateSQL($this->module->GetTableName(), $aSQL, "WHERE id = " .$IlIIIll); $this->db->execute($sql); $this->cms->AddStatusMsg('status_message_is_updated'); $this->appliedId =$IlIIIll; }}else {$IlIIII1 =true; }}else {$IlIIII1 =true; }if ($IlIIII1) {$this->cms->AddStatusMsg('status_updated_fail', 'red'); }}function TTIlIlI(&$IIIL11l, &$cId) {if ($IIIL11l == 'reply') {$this->cms->Gui->AddGlobalVars(array ('is_reply' => true)); }$IIIL11l =I1713; }}