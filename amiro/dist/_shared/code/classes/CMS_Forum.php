<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       27402 xkqwlmpyxxslrsqzkikggrpyyxtrxinuukxpgnryxngrqpgsyzxismtqssxulyklkrzgpnir
 */ ?><?php foreach(array(1817=>'UTF+8',1818=>'nZIQ|DurnZIQ',1819=>'DBD|PrHuGD',1820=>'IQDDZPQ',1821=>'vMQC|fMQJSD',1822=>'rQPMDtrZtMHn|SZtQ',1823=>'FRhNT|iqiyqRd|jmNk',1824=>'uDQr',1825=>']SJZnP=',1826=>'DIMJQ|WHJJQWtMHn',1827=>'a',1828=>'IDPD|WHunt',1829=>'IDP|ZutOHr',1830=>'ZutOHr',1831=>'nMWKnZIQ',1832=>'ZWtMvQ',1833=>'fHruI',1834=>'',1835=>'WID|fHruI',1836=>'I`nMWKnZIQ',1837=>'JZnP|SZtZ',1838=>'WID|fHruI|WZt',1839=>'WID|PuQDtYHHK',1840=>'?f?',1841=>'frHnt',1842=>"coqRq?.MS|IQIYQr.?",1843=>'DKMG|IHSuJQ|fMJtQr',1844=>'P',1845=>"'",1846=>'GHDtD|WHunt',1847=>'OHDt',1848=>'`[ \*\~mip\&~DM',1849=>'fMrDtnZIQ',1850=>'DtZtuD|IDP',1851=>'JHPMn|DHurWQ',1852=>'ZvZtZr',1853=>'fHruI|DMPn',1854=>'rQJ=nHfHJJHC?OrQf=',1855=>'IQIYQr|DMtQ|LD',1856=>'IQIYQr|DMtQ',1857=>'YHSB|MtQID',1858=>"!?",1859=>"?zNs?.GuYJMW.?=?1") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class CMS_Forum extends CMS_ActModule {public $IlIll11; public $IlIlLII; public $IlIlLIl; public $_public; public $IlIlLIL; public $IlIlLI1; public $IlIlLlI; public $IlIlLll; public $IlIlLlL; public $IlIlLl1; public $IlIlLLI; public $_locateMessageId; public $IlIlLLl; public $IlIlLLL; public $IlIlLL1; public $IlIlL1I; protected $IlIlL1l =true; protected $IlIlL1L; function CMS_Forum(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); }function _Init($IIll1l1 =array (),$IIll1LI ='', $IIll1Ll ='', $aOptions =array ()){$this->IlIll11 =$this->module->issetAndTrueOption('sys_user_as_administration'); $this->IlIlLI1 =$this->cms->Core->GetModOption('common_settings', 'display_nickname_as'); $this->IlIlLlI =array ($this->cms->Core->GetModOption('common_settings', 'url_max_length'), I1817); if ($this->IlIll11) {$this->IlIlLII =array ();switch($this->IlIlLI1){ case 'nickname': $IlIlL11 ='m.nickname'; break; case 'username': $IlIlL11 ='m.username'; break; case I1818: $IlIlL11 ="CONCAT(m.firstname, ' ', m.lastname)"; }$IlIlL11 =', ' .$IlIlL11 .' user_caption '; if($GLOBALS["BUILDER_VERSION"] <2){ $sql ="SELECT hu.`id_member`" .$IlIlL11 ."FROM `cms_host_users` hu " ."LEFT JOIN `cms_members` m ON m.id = hu.`id_member` " ."WHERE hu .`sys_user` = 1"; }else{ $sql ="SELECT c.`id_admin` as id_member" .$IlIlL11 ."FROM `cms_hst_res_cms_inst` c " ."LEFT JOIN `cms_members` m ON m.id = c.`id_admin` " ."WHERE c .`is_sys` = 1"; }if ($record =$this->db->getRecord($sql)) {$this->IlIlLII[$record['id_member']] =trim($record['user_caption']); }if ($this->cms->Core->IsInstalled(I1819)) {$sql ="SELECT hu.`id_member`" .$IlIlL11 ."FROM `cms_sys_users` hu " ."LEFT JOIN `cms_sys_groups` sg ON sg.id = hu.id_group " ."LEFT JOIN `cms_members` m ON m.id = hu.`id_member` " ."WHERE sg.`login` = 1"; $rs =&$this->db->select($sql); while ($record =$rs->nextRecord()) {$this->IlIlLII[$record['id_member']] =trim($record['user_caption']); }}}$IIIIL11 =array ('strip_tags_before_autolink' => true, 'description_field_name' => I1820, 'use_positions' => false );$aOptions += $IIIIL11; $this->IlIlL1I =false; $vMod =&$this->cms->Core->GetModule('members'); $this->IlIlLLl =$vMod->IsPresentInPMandPublic() ?$vMod->GetFrontLink() :''; $this->IlIlLLL =!mb_strlen($this->IlIlLLl); $this->IlIlLL1 =array ();if (!$this->IlIlLLL) {$IlIl1II =$vMod->GetAOption('used_fields'); $IlIl1Il =$vMod->GetAOption(I1821); foreach (array( 'forum_sign' => 'forum_sign', 'photo' => 'avatar', I1822 => I1822, 'posts_count' => 'posts_count', 'companyweb' => 'site' )as $IlIl1IL => $IlIl1I1) {if(in_array($IlIl1IL, $IlIl1Il) && ($IlIl1IL !== I1822 ?in_array($IlIl1IL, $IlIl1II) :TRUE)){ $this->IlIlLL1[$IlIl1I1] =1; }}}$this->cms->Gui->AddGlobalVars(array (I1823 => $this->IlIlLLl, 'DISPLAY_MEMBER_DATE' => !empty($this->IlIlLL1[I1822]) ));$this->IlIlL1L =null; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin() {global $oSession; parent::_InitAdmin(); $this->cms->SetsTemplate =$this->moduleName .'_list'; if (is_object($oSession)) {$this->IlIlLIL =$oSession->GetVar('user'); }else if (function_exists('admSession')) {$session =admSession(); $this->IlIlLIL =$session->GetVar(I1824); }else {$this->IlIlLIL =array(); }$this->IlIlLll =null; AMI_Registry::set( 'AMI/resources/j/e', '_h=' .mb_substr(md5($this->cms->Core->GetModOption('ce', 'smile_collection')), 0, 10) .I1825 .$this->langData .'&ul=' .$this->IlIlLlI[0] );}function TTTlTI1() {global $oSession; parent::TTTlTI1(); $this->IlIlLIL =is_object($oSession) && $oSession->IsSessionStarted() && $oSession->memberId >0 ?$oSession->GetVar(I1824) :array ();AMI_Registry::set( 'AMI/resources/j/e', '_h=' .mb_substr(md5($this->cms->Core->GetModOption('ce', I1826)), 0, 10) .I1825 .$this->langData .'&ul=' .$this->IlIlLlI[0] );$this->IlIlLlL =$this->browser->Icons; $this->IlIlLlL['active'] =$this->IlIlLlL['page']; $this->IlIlLl1 =$this->module->issetOption('updatable_period') ?date(I1827) +strtotime($this->module->GetOption('updatable_period'), 0) :0; $this->_locateMessageId =0; $IlIl1lI =$this->cms->Core->GetModOption('common_settings', 'bb_post_allow_urls_reg_only'); $IlIl1ll =FALSE; switch($IlIl1lI){ case -2: $IlIl1ll =TRUE; break; case 0: break; default: $IlIl1ll =empty($this->IlIlLIL['id']); if(!$IlIl1ll && ($IlIl1lI >0)){ $IlIl1lL =$this->IlIlLIL[I1828] <= ($IlIl1lI -1); }}if($IlIl1ll){ $this->cms->Gui->addGlobalVars(array('disallow_bb_urls' => true)); }$this->IlIlL1l =!$IlIl1ll && empty($IlIl1lL); }function TTIl11l(&$aItem, $IlIl1l1 =false) {static $names =array ('id_member' => 'author', 'msg_id_member' => I1829 );if ($this->IlIll11) {foreach ($names as $memberIdKey => $authorKey) {if (isset($aItem[$memberIdKey])) {$isAdmin =isset($this->IlIlLII[$aItem[$memberIdKey]]); $aItem['is_admin'] =$isAdmin && $memberIdKey == 'id_member'; if ($isAdmin) {$aItem['source_' .$authorKey] =$aItem[$authorKey]; $aItem[$authorKey] =$this->cms->Gui->getAbs($this->moduleName .'_list:admin_nickname', array (I1830 => $this->IlIlLII[$aItem[$memberIdKey]])); }}}}if ($IlIl1l1) {$aItem['id_member'] =0; }}function TTIl111($id) {$sql ="SELECT * FROM " .$this->module->GetTableName() ." WHERE `id` = " .$id; $this->IlIlLll =$this->db->getRecord($sql); }function TTI1TTT($memberId) {$memberId =intval($memberId); $IlIl1LI =$this->cms->__aMemberData__; switch($this->IlIlLI1){ case 'nickname': $aFields =array(I1831); break; case 'username': $aFields =array('username'); break; case I1818: $aFields =array('firstname', 'lastname'); }$aFields =array_merge($aFields, array(I1832, 'photo', 'forum_sign')); $IlIl1Ll =false; foreach ($aFields as $field) {if (array_key_exists($field, $IlIl1LI)) {$IlIl1Ll =true; break; }}if ($IlIl1Ll) {$sql ="SELECT * FROM `cms_members` WHERE `id` = " .$memberId; $IlIl1LL =$this->db->getRecord($sql); $IlIl1L1 =false; foreach ($aFields as $field) {if (array_key_exists($field, $IlIl1LI) && $IlIl1LI[$field] != $IlIl1LL[$field]) {$IlIl1L1 =true; break; }}if ($IlIl1L1) {$aModules =array ();if ($this->moduleName == 'forum') {$aModules[] =I1833; }else {$aAllModules =$this->cms->Core->GetInstalledModuleNames(); foreach ($aAllModules as $moduleName) {if ($this->cms->Core->issetModOption($moduleName, 'extensions') && in_array('ext_discussion', $this->cms->Core->TTlI1TI($moduleName, 'extensions')) ){$aModules[] =$moduleName; }}}foreach(array_unique($aModules) as $moduleName){ $module =$this->cms->Core->GetModule($moduleName); if ($module->IsFrontAllowed() && $module->IsPresentInPMandPublic()) {$this->cms->Core->Cache->SetForceExpireTime($module->Name, strtotime('+1 hour')); }}}}}function TTI1TTI($memberId) {$memberId =intval($memberId); $sql ="DELETE FROM `cms_forum_subscribers` WHERE `id_member` = ' " .$memberId ."'"; $this->db->execute($sql); $IlIl11I =$this->options['lang_data'] ?" AND `lang` = '" .$this->langData ."'" :I1834; $table =$this->module->GetTableName(); $sql =$this->db->genUpdateSQL($table, array ('id_member' => 0), 'WHERE `id_member` = ' .$memberId .$IlIl11I); $this->db->execute($sql); if (in_array($table, array ('cms_forum', 'cms_discussion'))) {$aTables =$table == I1835 ?array ($table, 'cms_forum_cat') :array ($table); foreach ($aTables as $IlIl11l) {$sql =$this->db->genUpdateSQL($IlIl11l, array ('msg_id_member' => 0), 'WHERE `msg_id_member` = ' .$memberId .$IlIl11I); $this->db->execute($sql); }}}function TTT1Tl1($cType, $cModule, $II11l1L =true) {if ($II11l1L) {if ($cType == 'nicknames') {switch($this->IlIlLI1){ case I1831: $IlIl11L =I1836; break; case 'username': $IlIl11L ='m.username'; break; case I1818: $IlIl11L ="CONCAT(m.firstname, ' ', m.lastname)"; }$IlIl11L .= ' '; $IlIl11I =$this->options[I1837] ?" AND f.`lang` = '" .$this->langData ."'" :I1834; foreach (array (I1835 => array (array ('id_member', I1830), array ('msg_id_member', I1829)), I1838 => array (array ('msg_id_member', I1829)), 'cms_discussion' => array (array ('id_member', I1830), array ('msg_id_member', I1829)), I1839 => array (array ('id_member', I1830)) )as $table => $update) {foreach ($update as $fields) {list ($idField, $IlIl111) =$fields; $sql ="SELECT DISTINCT f." .$idField .", " .$IlIl11L ."FROM " .$table .I1840 ."INNER JOIN cms_members m ON m.id = f." .$idField ." AND m.lang = f.lang " ."WHERE f." .$idField ." != 0" .$IlIl11I; $rs =&$this->db->select($sql); while (list ($memberId, $author) =$rs->nextRecord(MYSQL_NUM)) {$this->TTI1TI1(); if ($this->IlIll11 && isset($this->IlIlLII[$memberId])) {$author =$this->cms->Gui->getAbs($this->moduleName .'_list:admin_nickname', array (I1830 => $author)); }$sql =$this->db->genUpdateSQL($table, array ($IlIl111 => trim($author)), "WHERE " .$idField ." = " .$memberId); $this->db->execute($sql); }}}$this->cms->AddStatusMsg('status_repair_nicknames', 'blue'); }parent::TTT1Tl1($cType, $cModule); }else {$this->TTI1TI1(); $this->side =I1841; $IlILIII =$this->options['use_special_list_view']; $this->options['use_special_list_view'] =false; $IlILIIl =array( I1835 => "SELECT `id_member`, COUNT(1) `posts_count` " ."FROM `cms_forum` f " .I1842 .$this->_ApplyFilters('f', I1843) ."GROUP BY `id_member`", 'cms_discussion' => "SELECT `id_member`, COUNT(1) `msgs_count` " ."FROM `cms_discussion` d " .I1842 .$this->_ApplyFilters('d', I1843) ."GROUP BY `id_member`", I1839 => "SELECT `id_member`, COUNT(1) `msgs_count` " ."FROM `cms_guestbook` g " .I1842 .$this->_ApplyFilters(I1844, I1843) ."GROUP BY `id_member`" );$this->side ='admin'; $this->options['use_special_list_view'] =$IlILIII; $IlIl11I =$this->options[I1837] ?" AND `lang` = '" .$this->langData .I1845 :I1834; foreach ($IlILIIl as $table => $sql) {$rs =&$this->db->select($sql); while ($record =$rs->nextRecord()) {$this->TTI1TI1(); $memberId =$record['id_member']; $sql ="SELECT 1 FROM `cms_members` " ."WHERE `id` = " .$memberId .$IlIl11I; if($this->db->getValue($sql)){ unset($record['id_member']); switch($table){ case I1835: $record[I1828] =$record[I1846]; break; default: $record[I1828] ='=|msgs_count+' .$record[I1828]; }$sql =$this->db->genUpdateSQL('cms_members', $record, 'WHERE `id` = ' .$memberId .$IlIl11I); $this->db->execute($sql); }else {$this->TTI1TTI($memberId); }}}}}function TTI1TTl() {static $domain; if ($this->cms->Core->HostMode() &HOSTMODE_SHARED) {if (!isset($domain)) {$domain =parse_url($GLOBALS['ROOT_PATH_WWW']); $domain =mb_strtolower($domain[I1847]); if (mb_substr_count ($domain, '.') >1) {$domain =preg_replace('/^www[^\.]*\./', I1834, $domain); }}$senderEmail =$this->module->getOption('from_mbox') .'@' .$domain; }else {$senderEmail =$this->cms->Core->GetOption('company_robot_email'); }return $senderEmail; }function TTI1TT1(&$scope) {$IlILIIL =$this->module->GetOption('front_images'); if (($index =array_search('registered_users_only', $IlILIIL)) !== false) {if (!sizeof($this->IlIlLIL)) {return; }unset($IlILIIL[$index]); }if (sizeof($IlILIIL)) {$scope['allowed_images'] =I1845 .implode("', '", $IlILIIL) .I1845; }}function TTI1TIT(&$message, $IlILIIL, $authorized) {global $ROOT_PATH_WWW; if (in_array('registered_users_only', $IlILIIL) && !$authorized) {$message =preg_replace('/\[IMG\].*?\[\/IMG\]/si', I1834, $message); return; }if (!in_array('internal_links', $IlILIIL)) {$message =preg_replace('/\[IMG\]' .preg_quote($ROOT_PATH_WWW, '/') .I1848, I1834, $message); }if (!in_array('external_links', $IlILIIL) && preg_match_all('/\[IMG\](.*?)\[\/IMG\]/si', $message, $matches)) {foreach ($matches[1] as $index => $url) {if (mb_strpos($url, $ROOT_PATH_WWW) !== 0) {$message =str_replace($matches[0][$index], I1834, $message); }}}}function TTI1TII() {switch($this->IlIlLI1){ case I1831: $author =$this->IlIlLIL[I1831]; break; case 'username': $author =$this->IlIlLIL['username']; break; case I1818: $author =$this->IlIlLIL[I1849] .' ' .$this->IlIlLIL['lastname']; }$this->TTI1TIl($author); return $author; }function TTI1TIl(&$author) {if (trim($author) == I1834) {$author =$this->words['empty_nickname']; }}function TTI1TI1() {static $lastTime =0; @set_time_limit(29); if (!$this->IlIlL1I) {return; }if (!$lastTime) {$lastTime =time(); }if (($lastTime +15) <= time()) {echo ' '; flush(); }$lastTime =time(); }function TTI1TlT($get =array ()){$this->cms->VarsGet =array (I1850 => serialize(array ('sys' => $this->cms->SysStatusMsgs, 'plain' => $this->cms->StatusMsgs))) +$get; $this->cms->ActiveScript =preg_replace('/\?.*$/', I1834, getenv('REQUEST_URI')); $this->TTTlTlI(); }function TTTll1T(&$vData, &$aCustom){ $vData[I1851] =$this->IlIlLI1; parent::TTTll1T($vData, $aCustom); }protected function TTI1TlI($message, $IlILII1 =false){ $res =$this->IlIlL1l || !preg_match('/<a[^>]+href=/si', $message) || !preg_match('~https?://[\da-zа-яёА-ЯЁ]~si', $message); if(!$res){ if($IlILII1){ unset($this->cms->VarsGet[I1850]); }$this->cms->AddStatusMsg('status_urls_forbidden', 'red'); }return $res; }protected function TTI1Tll(&$aItem, $aData){ $this->TTIl11l($aItem, $this->IlIlLLL); if (!empty($this->IlIlLL1[I1852]) && mb_strlen($aItem[I1852])) {$aItem[I1852] =$this->cms->Member->IlI111l .'avatars/' .$aItem[I1852]; $aItem['member_avatar'] =$this->cms->Gui->get($this->moduleName .'_list:member_avatar', $aItem); }else {$aItem['member_avatar'] =I1834; }if (empty($this->IlIlLL1[I1853])) {$aItem[I1853] =I1834; }elseif($this->module->GetOption('noindex_external_links')){ $html =$aItem[I1853]; if(preg_match_all('~(<a.*?)href\s*=\s*(["\']?(https?:\/\/[^"\'\s]+)(?:.*?' .'>))~si', $html, $aMatches)){ foreach($aMatches[1] as $index => $opener){ if(mb_strpos($aMatches[3][$index], $GLOBALS['ROOT_PATH_WWW']) === FALSE){ $html =str_replace($aMatches[0][$index], $opener .I1854 .$aMatches[2][$index], $html); }}}$aItem[I1853] ='<noindex>' .$html .'</noindex>'; }if (!empty($this->IlIlLL1['site']) && mb_strlen($aItem['member_site'])) {$aItem[I1855] =jparse(preg_replace('/^[\w\d]+:\/\//', I1834, $aItem['member_site'])); if(!preg_match('/^[\w\d]+:\/\//', $aItem['member_site'])){ $aItem[I1856] ='http://' .$aItem[I1856]; }$aItem[I1856] =$this->cms->Gui->get($this->moduleName .'_list:member_site', $aItem); }if(is_object($this->IlIlL1L)){ $this->IlIlL1L->TITIIII($aItem['id_member'], $aItem, $this->moduleName .'_list', I1857); }}protected function TTI1Tl1($memberId, $delta =1, $IlILIlI =FALSE){ $delta =(int)$delta; if (($memberId =(int)$memberId) >0 && $delta != 0){ global $oSession; if(is_object($oSession) && $oSession->IsSessionStarted() && $oSession->memberId == $memberId){ $aUser =$oSession->GetVar(I1824); $aUser[I1828] =$delta >0 ?$aUser[I1828] +$delta :$aUser[I1828] -$delta; $oSession->SetVar(I1824, $aUser); $oSession->Store(); }$delta =($delta >0 ?'+' :I1834) .$delta; $sql ="UPDATE `cms_members` " ."SET " .($IlILIlI ?"`posts_count` = `posts_count`" .$delta .I1858 :I1834) ."`msgs_count` = `msgs_count`" .$delta ." " ."WHERE `id` = " .$memberId; $this->db->execute($sql); }}protected function TTI1T1T($IlILIll, $delta, $IlILIlI =FALSE){ if ($this->options['check_public']) {$IlILIll .= I1859; }$sql ="SELECT `id_member`, COUNT(1) `posts_count` " ."FROM " .$this->module->GetTableName() ." t " ." WHERE " .$IlILIll ." GROUP BY `id_member`"; $rs =&$this->db->select($sql); while (list($memberId, $count) =$rs->nextRecord(MYSQL_NUM)) {$this->TTI1Tl1($memberId, $count *$delta, $IlILIlI); }}}