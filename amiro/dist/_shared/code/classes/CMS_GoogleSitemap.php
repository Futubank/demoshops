<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @since      5.14.0 
 * @version    $Id$ 
 * @size       16996 xkqwuizsmrpslklslimwsmwxrggznimnnppprknnuqntizmuqyulinusrptmxmqmygwspnir
 */ ?><?php foreach(array(1860=>'RhhT|gzTo|ccc',1861=>'#DMtQIZGMnSQx',1862=>"\n",1863=>'WHrQ',1864=>'PQn|DMtQIZG',1865=>'rQMnSQx',1866=>'PHHPJQ|DMtQIZG',1867=>'ZJJHC|IuJtM|JZnP',1868=>"MnDtZJJQS|JZnPD",1869=>"SQfZuJt|SZtZ|JZnP",1870=>'DMtQIZG|IHSuJQD',1871=>"dqjqwT?JMnK!?IHSuJQ|nZIQ!?UNmX|TmiqdTzig}SZtQ|IHSMfMQS{?zd?JZDt|IHSMfMQS|tD?FRhi?WID|DMtQ|DQZrWO?coqRq?ZWtMvQ?=?'1'?ZnS?GuYJMW]WZt|GuYJMW?ZnS?nHMnSQx=0?",1872=>"?hRsqR?yb?IHSuJQ|nZIQ",1873=>"IHSuJQ|nZIQ",1874=>"",1875=>"DMtQIZG|",1876=>"JZDt|IHSMfMQS|tD",1877=>"CY",1878=>'??#DMtQIZG@',1879=>'??#~DMtQIZG@',1880=>'SZMJB',1881=>"vZJuQ",1882=>'MnSQx|DI',1883=>"DMtQIZG|DQnt",1884=>'ZJJHC|urJ|fHGQn',1885=>'?',1886=>".ZWtMHn.?=?'",1887=>'DI|DtZtuD|HK',1888=>"!?",1889=>"dqjqwT?MS?FRhi?WID|GZPQD?coqRq?IHSuJQ|nZIQ?=?'GZPQ|404'?hR?IHSuJQ|nZIQ?=?'GrMnt|vQrDMHn'",1890=>"?zNs?MS|GZPQ?,=?'") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class CMS_GoogleSitemap{ private $IlILILI =false; private $IlILILl; private $IlILILL; private $IlILIL1; private $IlILI1I; private $db; function CMS_GoogleSitemap(){ $this->IlILILl =$GLOBALS['ROOT_PATH']."_mod_files/"; $this->IlILILL =$GLOBALS[I1860]."_mod_files/"; $this->IlILIL1 ="http://www.google.com/webmasters/tools/ping?sitemap="; $this->IlILI1I ='<?xml version="1.0" encoding="UTF-8"?>'."\n". I1861."\n". '  xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"'."\n". '  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'.I1862. '  xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9'.I1862. '                      http://www.sitemaps.org/schemas/sitemap/0.9/siteindex.xsd">'.I1862; }public function processGoogleSitemap(&$process){ $aInstalledModules =array('google_sitemap', 'reindex'); AMI::addResourceMapping(array(I1863 => 'AMI_Core')); $Core =AMI::getSingleton(I1863, array($aInstalledModules)); $Core->init(); if($Core->getModOption('google_sitemap', 'sitemap_auto_update')){ $IlILI1l =$Core->getSingleModOption('google_sitemap', I1864); $IlILI1L =$IlILI1l["value"]; $IlILI11 =unserialize($IlILI1l["big_value"]); if($IlILI1L){ $this->IlILILI =$Core->issetModOption('reindex', 'mode') && $Core->getModOption(I1865, 'mode') == 'fulltext'; $IlILlII =$Core->getModOption('google_sitemap', 'sitemap_changefreq'); $IlILlIl =365; asort($IlILlII); foreach($IlILlII as $IlILlIL){ if($IlILlIL >0){ $IlILlIl =$IlILlIL; break; }}$this->db =&$process->db; if($IlILI1L +$IlILlIl*24*60*60 <time()){ $IlILlI1 =intval($Core->getModOption(I1866, 'sitemap_auto_update_pages')); if($IlILlI1 <10){ $IlILlI1 =10; }$sql ="SELECT id FROM cms_site_search WHERE public&cat_public and date_modified > '".date("Y-m-d H:i:s", $IlILI1L)."' LIMIT ".$IlILlI1; $this->TTI1T1I($sql); $this->db->query($sql); $IlILllI =0; while($this->db->nextRecord()){ $IlILllI += 1; }if($IlILllI >= $IlILlI1){ $IlILlll =$this->TTI1T1l(); $this->keepAlive(); if($Core->GetOption(I1867)){ $langs =$Core->GetOption(I1868); if(!is_array($langs)){ $langs =array($langs); }$IlILllL =" AND lang IN ('".implode("','", $langs)."') "; }else{ $IlILllL =" AND lang = '".$Core->GetOption(I1869)."' "; }$curModule =""; $IlILll1 =""; $IlILlLI =array(); $IlILlLl =0; $IlILlLL =0; $IlILlL1 =0; $IlILl1I =array(); $IlILl1l =0; $IlILl1L =20000; $supportedModules =$Core->getModOption(I1866, I1870); $IlILl11 =$this->TTI1ITI(); foreach($IlILl11 as $modId => $hyper){ $supportedModules[$modId] =isset($supportedModules[$hyper]) ?$supportedModules[$hyper] :5; }$sql =I1871.$IlILllL.$this->TTI1ITT().I1872; $this->TTI1T1I($sql); $this->db->query($sql); $this->keepAlive(); while($IlILLII =$this->db->nextRecord()){ set_time_limit(29); $this->keepAlive(); $IlILLIl =$IlILLII[I1873]; if(array_key_exists($IlILLIl, $supportedModules)){ $curModule =$IlILLIl; }else{ $IlILLIl =mb_substr($IlILLIl, 0, mb_strpos($IlILLIl, '_')); if(array_key_exists($IlILLIl, $supportedModules)){ $curModule =$IlILLIl; }else{ $curModule =I1874; }}if(!$curModule || (isset($supportedModules[$curModule]) && intval($supportedModules[$curModule]) == 0)){ continue; }if(($IlILlLL >= $IlILl1L) && ($curModule == $IlILll1)){ $IlILlLL =0; $IlILLIL += 1; $IlILLI1 ="sitemap_".$IlILll1."_".sprintf("%03d", $IlILLIL).".xml"; $IlILlLI[$curModule][] =$IlILLI1; }if($curModule != $IlILll1){ $this->keepAlive(); $IlILlLL =0; $IlILLIL =1; $IlILlL1 =0; $IlILll1 =$curModule; $IlILLI1 =I1875.$IlILll1."_".sprintf("%03d", $IlILLIL).".xml"; $IlILlLI[$curModule][] =$IlILLI1; }if($IlILLII["last_modified_ts"] >= $IlILlL1){ $IlILl1I[$IlILll1] =$IlILLII[I1876]; $IlILlL1 =$IlILLII[I1876]; }$IlILlLL += 1; }if(isset($IlILI11["index_sm"]) && mb_substr($IlILI11["index_sm"][0], 0, 8) == I1875){ @unlink($this->IlILILl.$IlILI11["index_sm"][0]); }$IlILLlI ="sitemap_index.xml"; $IlILLll =fopen($this->IlILILl.$IlILLlI, I1877); fwrite($IlILLll, $this->IlILI1I); foreach($IlILlLI as $module => $IlILLlL){ set_time_limit(29); $this->keepAlive(); foreach($IlILLlL as $IlILLl1){ $IlILLLI =$IlILl1I[$module]; if(!$IlILLLI) {$IlILLLI =time(); }$IlILLLl =date("Y-m-d\TH:i:s",$IlILLLI).mb_substr(date("O",$IlILLLI),0,3).":".mb_substr(date("O",$IlILLLI),3,2); $IlILLLL =I1878.I1862; $IlILLLL .= "    <loc>".$GLOBALS[I1860].$IlILLl1."</loc>\n"; $IlILLLL .= "    <lastmod>".$IlILLLl."</lastmod>\n"; $IlILLLL .= I1879.I1862; fwrite($IlILLll, $IlILLLL); $IlILl1l += 1; }}fwrite($IlILLll, '</sitemapindex>'); @fclose($IlILLll); @chmod($this->IlILILl.$IlILLlI, 0644); $IlILlLI["index_sm"][0] =$IlILLlI; $Core->setSingleModOption(I1866, I1864, time(), serialize($IlILlLI)); $IlILLL1 =$this->TTI1T1l(); $this->TTI1T11("act_auto_gen_sitemap", sprintf("%.5f", $IlILLL1 -$IlILlll), I1874, $IlILLlI, @filesize($this->IlILILl.$IlILLlI), $IlILl1l); }}$IlILL1I =array( I1880 => 1, 'weekly' => 7, 'monthly' => 30 );$IlILL1l =$Core->getModOption(I1866, 'sitemap_ping_google'); $IlILL1l =isset($IlILL1I[$IlILL1l]) ?$IlILL1I[$IlILL1l] :7; $IlILL1L =$Core->getSingleModOption(I1866, 'send_sitemap'); $IlILL11 =$IlILL1L[I1881]; if(!$IlILL11 || (($IlILL11 +$IlILL1l*24*60*60) <time())){ $IlILlll =$this->TTI1T1l(); $IlIL1II =I1874; $IlIL1Il =0; if(isset($IlILI11["index_sm"]) && file_exists($this->IlILILl.$IlILI11["index_sm"][0])){ $IlIL1IL =$this->IlILILL.$IlILI11["index_sm"][0]; @clearstatcache; $IlIL1II =@filesize($this->IlILILl.$IlILI11["index_sm"][0]); foreach($IlILI11 as $IlIL1I1 => $mod){ if($IlIL1I1 != I1882){ $IlIL1Il += sizeof($mod); }}}if($IlIL1Il){ $IlILL1L =array(); $IlILL1L =$Core->getSingleModOption(I1866, 'send_sitemap'); $IlIL1lI =unserialize($IlILL1L["big_value"]); if(!isset($IlIL1lI['num_failed'])){ $IlIL1lI['num_failed'] =0; }$IlIL1ll =I1883; $IlIL1lL =$this->IlILIL1.urlencode($IlIL1IL); if(function_exists('curl_init')){ $ch =curl_init(); curl_setopt($ch, CURLOPT_URL, $IlIL1lL); curl_setopt($ch, CURLOPT_HEADER, 0); curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); $IlIL1l1 =curl_exec($ch); $IlIL1LI =curl_getinfo($ch); curl_close($ch); if($IlIL1LI['http_code'] != 200){ $IlIL1lI['num_failed'] += 1; $IlIL1ll ="sitemap_sent_err_http_code"; }}elseif(ini_get(I1884) || get_cfg_var(I1884)){ $handle =fopen($IlIL1lL, "r"); fclose($handle); }if($IlIL1ll == I1883){ $IlIL1lI['num_failed'] =0; }$Core->setSingleModOption(I1866, 'send_sitemap', time(), serialize($IlIL1lI)); $IlILLL1 =$this->TTI1T1l(); $status =($IlIL1ll != I1883) ?$IlIL1ll :''; $this->TTI1T11("act_auto_send_sitemap", sprintf("%.5f", $IlILLL1 -$IlILlll), $status, I1874, $IlIL1II, $IlIL1Il); }}}}}private function TTI1T1I(&$sql){ if($this->IlILILI){ $sql =str_replace('cms_site_search', 'cms_site_search_index', $sql); }}private function TTI1T1l(){ list($usec, $sec) =explode(" ", microtime()); return ((float)$usec +(float)$sec); }private function keepAlive(){ print I1885; ob_flush(); }private function TTI1T11($action, $time ="0.0", $status =I1874, $sitemap_file =I1874, $sitemap_size =I1874, $num_urls =0){ $sql ="INSERT INTO `cms_google_sitemap` " ."SET " ."`date` = NOW(), " .I1886 .$action ."', " ."`time` = '" .$time ."', " ."`status` = '" .($status ?$status :I1887) ."', " ."`sitemap_file` = '" .mysql_real_escape_string($sitemap_file, $this->db->_dbLink) ."', " ."`sitemap_size` = " .$sitemap_size .I1888 ."`num_urls` = " .$num_urls .I1888 ."`daemon_mode` = 1"; $this->db->query($sql); }private function TTI1ITT(){ $IlIL1Ll =''; $IlIL1LL =array(); $sql =I1889; $this->db->query($sql); while($IlILLII =$this->db->nextRecord()){ $IlIL1LL[] =$IlILLII["id"]; }foreach($IlIL1LL as $ID){ $IlIL1Ll .= I1890.mysql_real_escape_string($ID, $this->db->_dbLink)."' "; }return $IlIL1Ll; }private function TTI1ITI(){ $aModules =array(); $oDeclarator =AMI_ModDeclarator::getInstance(); $aInstalled =$oDeclarator->getRegistered('ami_multifeeds'); if(sizeof($aInstalled)){ foreach($aInstalled as $modId){ if((strpos(substr($modId, -4), '_cat') !== false)){ }else{ $aHyperData =$oDeclarator->getHyperData($modId); if(!empty($aHyperData[1])){ $aModules[$modId] =$aHyperData[1]; }}}}return $aModules; }}