<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       26288 xkqwinpqmurxrqrwnqqgmwmsqlnwgmkxtimupmgxywnytmltsulsyglypsupkpmyknyypnir
 */ ?><?php foreach(array(1893=>'FUNw|mNwjUsqd|gzTo',1894=>'~',1895=>'trMI',1896=>'ZGM|vQrDMHn',1897=>'WHGB|ZJJHCQS',1898=>'MnvZJMS|MS',1899=>'IHS|OZvMnP|MS|ZJrQZSB|MnDtZJJQS',1900=>'`',1901=>'JZnP',1902=>'MnDtZJJ|ZD',1903=>'fMJQD|tBGQ',1904=>'tBGQ',1905=>'MWHn',1906=>'|GZtO',1907=>'CHrK|IHSQD',1908=>'IMDDMnP|CHrK|IHSQD',1909=>'HCnQr|MD|nHt|MnDtZJJQS',1910=>'',1911=>'IHSuJQ|QxMDtD',1912=>'IHSuJQ',1913=>'RhhT|gzTo',1914=>'md|mNdTzjj',1915=>'CHrK|IHSQD|tQxt',1916=>'vZJuQ',1917=>'MnDtZJJ|ZD|rHCD',1918=>"GJuPMnD|CMAZrS|DuYfHrI%MnDtZJJ|ZD|rHC",1919=>'nZIQ',1920=>'fMJQD',1921=>'fMJQD|MnfH',1922=>'BQD',1923=>'QrrHrD',1924=>'DEJ|MnDtZJJ',1925=>'rQS',1926=>'MnDtZJJ|GZtO',1927=>'fMJQ',1928=>"\n",1929=>'fuJJ|GZtO',1930=>'DtZtuD|WZnnHt|WrQZtQ|MnDtZJJ|GZtO',1931=>'GZtO',1932=>"\n~[?gJuPMn%?",1933=>'GZPQD',1934=>'DEJ|unMnDtZJJ',1935=>"FUNw|mNwjUsqd|gzTo",1936=>'``',1937=>'`YZK',1938=>'MIP',1939=>'|MnDtZJJ|GZtO',1940=>"GJuPMn|IHSuJQ",1941=>'MnDtZJJQS',1942=>'DGQW|DIZJJ|',1943=>'~\r \n~',1944=>'?',1945=>'<') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class CMS_InstallablePlugin {public $config; public $cms; function CMS_InstallablePlugin(&$cms) {$this->cms =&$cms; $this->config =$cms->Core->GetModProperty('plugins_wizard', 'config'); }function TTI1IT1($dirs) {require_once $GLOBALS[I1893] .'func_file_system.php'; $dirs =(array) $dirs; $plugins =array(); foreach($dirs as $IlI1IIl) {if (!validatePath($IlI1IIl)) {trigger_error('FS path hack attempt (distr_path)', E_USER_ERROR); }$dir =$GLOBALS['ROOT_PATH'] .$IlI1IIl; if ($handle =@opendir($dir)) {while (false !== ($file =readdir($handle))) {if(is_dir($dir.$file) && mb_substr($file, 0, 1) != '.') {$info =$this->GetPluginInfo($dir.$file.I1894); if(!empty($info)) {$plugins[$info['id']] =$info +array('distr_path' => $IlI1IIl.$file.I1894); }}}closedir($handle); }}return $plugins; }function GetPluginInfo($IlI1IIL, $IlI1II1 =false) {$info =array(); if(is_file($IlI1IIL.$this->config['conf_file'])) {$conf =@parse_ini_file($IlI1IIL.$this->config['conf_file']); $info =array_map(I1895, $conf); $version =explode('.', $conf['version']); $IlI1IlI =isset($conf['api_version']) ?explode('.', $conf[I1896]) :array(0, 0); if(!isset($IlI1IlI[1])){ $IlI1IlI[1] =0; }$info['version'] =sprintf("%02d.%02d", max(0, $version[0]), max(0, $version[1])); $info[I1896] =sprintf("%02d.%02d", max(0, $IlI1IlI[0]), max(0, $IlI1IlI[1])); $info['orig_header'] =array(); $info[I1897] =intval(!empty($conf[I1897])); $info['errors'] =array(); if(!preg_match('/^[a-zA-Z0-9_]+$/', $info['id'])){ $info['errors'][I1898] =true; }if($this->cms->Core->IsInstalled($info['id'])){ $info['errors'][I1899] =TRUE; }$IlI1Ill =$this->cms->lang; if ($handle =@opendir($IlI1IIL.$this->config['lang_path'])) {$readFromDB =$this->cms->Gui->getReadFromDB(); if($readFromDB) {$this->cms->Gui->setForceReadFromDisk(); }$dir =$IlI1IIL.$this->config['lang_path'].I1894; while (false !== ($file =readdir($handle))) {if(is_dir($dir.$file) && mb_substr($file, 0, 1) != I1900 && mb_strlen($file)==2) {$this->cms->setLang($file); $lang =$this->cms->Gui->ParseLangFile($dir.$file.I1894.$this->config['lang_file']); if(!empty($lang['plugin_name'])) {$info['orig_header'][$file] =$lang['plugin_name']; }if($IlI1Ill == $file) {$info[I1901] =$lang; }}}closedir($handle); if($readFromDB) {$this->cms->Gui->setForceReadFromDisk(false); $this->cms->Gui->setReadFromDB(true); }}$this->cms->setLang($IlI1Ill); foreach(array('id', 'version', I1902) as $param) {if(empty($conf[$param])) {$info['errors']['missing_param_'.$param] =true; }}if($IlI1II1) {$aFiles =array(); foreach($this->config[I1903] as $type => $pathType) {$aFiles[$type] =array(); if(isset($info[$type])){ foreach(explode(',', $info[$type]) as $file) {$file =basename(trim($file)); if(!empty($file)) {$fullPath =$IlI1IIL.$this->config[$pathType.'_path'].I1894.$file; $aFiles[$type][$file] =array('full_path' => $fullPath, 'is_file' => is_file($fullPath), I1904 => $type, 'path_type' => $pathType); if(!$aFiles[$type][$file]['is_file']) {$info['errors']['missing_files'] =true; }}}}if($type == I1905 && is_dir($IlI1IIL .$this->config[$pathType .'_path'])){ $aIcons =AMI_Lib_FS::scan($IlI1IIL .$this->config[$pathType .'_path'], 'icon-*.*', '', AMI_Lib_FS::SCAN_FILES); foreach($aIcons as $file){ $file =basename(trim($file)); $fullPath =$IlI1IIL .$this->config[$pathType .I1906] .I1894 .$file; $aFiles[$type][$file] =array( 'full_path' => $fullPath, 'is_file' => true, I1904 => $type, 'path_type' => $pathType );}}}$info['files_info'] =$aFiles; $info[I1907] =array(); foreach(array('admin', 'specblock') as $type) {if(sizeof($info['files_info'][$type])) {$info[I1907][] =$type; }}if(empty($info[I1907])) {$info['errors'][I1908] =true; }}}return $info; }function TTI1IIT($IlI1IlL, $IlI1Il1 =false) {$IlI1ILI =array(); $aInstalledModules =array(); $aAllowed =array(); foreach(explode(',', $IlI1IlL) as $module) {$module =mb_strtolower(trim($module)); if(preg_match('/^([a-z0-9_]+)(::([a-z0-9_]+))?::([a-z0-9_]+)$/', $module, $match)) {$owner =$match[1]; $parent =$match[3]; $mod =$match[4]; if(!$this->cms->Core->IsOwnerInstalled($owner)) {$IlI1ILI[$owner] =true; }elseif (is_object($this->cms->Core->GetModule($mod))) {$aInstalledModules[$mod] =true; }else {$aAllowed[] =$module; }}}foreach(array_keys($IlI1ILI) as $owner) {$this->cms->AddStatusMsg(I1909, '', '', I1910, array('owner' => $owner)); }foreach(array_keys($aInstalledModules) as $module) {$this->cms->AddStatusMsg(I1911, I1910, I1910, I1910, array(I1912 => $module)); }return $aAllowed; }function TTI1III($cPluginId, $IlI1ILl, $IlI1ILL, $IlI1IL1 =true) {$this->cms->Gui->addBlock("plugins_wizard_subform", "templates/plugins_wizard_details.tpl"); $lang =$this->cms->Gui->ParseLangFile('templates/lang/plugins_wizard.lng'); $aInfo =$this->GetPluginInfo($GLOBALS[I1913] .$IlI1ILl, true); $aData =$aInfo; if(is_array($aInfo[I1901])) {$aData += $aInfo[I1901]; }$aData[I1914] =$IlI1IL1; $IlI1I1I =array(); if(empty($aInfo[I1907])) {$IlI1I1I[] =$lang['work_mode_missing']; $aData['work_mode_error'] =true; }else {foreach($aInfo[I1907] as $type) {$IlI1I1I[] =$lang[$type]; }}$aData += array( 'header' => $aInfo['orig_header'][$this->cms->lang], I1915 => implode(', ', $IlI1I1I) );foreach($aData as $key => $val) {if(!is_array($val)) {$aData[$key] =htmlspecialchars($val); }}$aData["description"] =$aInfo["lang"]["description"]; $IlI1I1l =$this->cms->Gui->ParseLangFile('templates/lang/languages.lng'); $aData['headers'] =I1910; foreach($aInfo['orig_header'] as $IlI1I1L => $value) {$aHeaderData =array( 'language' => $IlI1I1l[$IlI1I1L], I1901 => $IlI1I1L, 'name' => trim($value), I1916 => !empty($IlI1ILL['header_'.$IlI1I1L])? $IlI1ILL['header_'.$IlI1I1L]: $value );$aData['headers'] .= $this->cms->Gui->get("plugins_wizard_subform:header_row", $aHeaderData); }$aData[I1917] =I1910; $aAllowed =$this->TTI1IIT($aData[I1902], true); foreach($aAllowed as $module) {$aData[I1917] .= $this->cms->Gui->getAbs(I1918, array(I1919 => mb_strtolower(trim($module)), 'selected' => isset($IlI1ILL[I1902]) && $IlI1ILL[I1902] == $module ?'selected': I1910)); }$aData['files_rows'] =I1910; if($IlI1IL1) {$class =false; foreach($this->config[I1903] as $type => $pathType) {$IlI1I11 =array('header' => $lang[$type], I1920 => I1910, 'available' => I1910, 'class' => ($class? 'row1': 'row2')); $class =!$class; foreach($aData[I1921][$type] as $file => $fileData) {$IlI1I11[I1920] .= $file.'<br>'; $IlI1I11['available'] .= $this->cms->Gui->getAbs("plugins_wizard_subform:available_".($fileData['is_file']? I1922: 'no')).'<br>'; }if(!empty($IlI1I11[I1920])) {$aData['files_rows'] .= $this->cms->Gui->get("plugins_wizard_subform:files_row", $IlI1I11); }}}foreach($aInfo[I1923] as $error => $IlI1lII) {$this->cms->AddStatusMsg('status_'.$error, ($IlI1lII)? 'red': I1910); }return $aData; }function Install($cPluginId, $IlI1ILl, $IlI1lIl, $IlI1lIL, $IlI1lI1) {$res =false; $aInfo =$this->GetPluginInfo($GLOBALS[I1913] .$IlI1ILl, true); if(empty($aInfo[I1923])) {$aAllowed =$this->TTI1IIT($aInfo[I1902]); if(in_array($IlI1lIl, $aAllowed)) {if(!$aInfo[I1897] || !$IlI1lIL) {foreach($aInfo[I1921] as $type => $data) {if($type != 'config' && $type != I1905) {$aInfo[I1921][$type] =array(); }}}$aAllFiles =array(); foreach($this->config[I1903] as $type => $pathType) {$aAllFiles += $aInfo[I1921][$type]; }$IlI1llI =$this->TTI1IIl($cPluginId); $res =true; if(!empty($aInfo[I1924])){ $res =$this->TTI1Ill($aInfo[I1924], $IlI1ILl); if(!$res){ $this->cms->AddStatusMsg('status_sql_fail', I1925, I1910, I1910, array('file' => htmlspecialchars($IlI1ILl ."database/" .$aInfo[I1924]))); return false; }}foreach($aAllFiles as $file => $fileData) {$aAllFiles[$file][I1926] =$IlI1llI[$fileData['path_type']].$file; if(!$IlI1lI1 && is_file($aAllFiles[$file][I1926])) {$res =false; $this->cms->AddStatusMsg('status_file_exists', I1925, I1910, I1910, array(I1927 => htmlspecialchars($aAllFiles[$file][I1926]))); }}$IlI1lll =$GLOBALS[I1913] .'_mod_files/_css/plugins.css'; $IlI1llL =I1910; $IlI1ll1 =$GLOBALS[I1913] .$IlI1ILl .'_mod_files'; if(is_dir($IlI1ll1)){ $IlI1lLI =getFiles($IlI1ll1, true, true); if(sizeof($IlI1lLI)){ $len =mb_strlen($GLOBALS[I1913] .$IlI1ILl); foreach($IlI1lLI as $from){ if(mb_strpos($from, '/.svn') !== false){ continue; }if(preg_match('/\/_css\/.*?\.css/i', $from) && is_readable($from)){ $IlI1llL .= file_get_contents($from) .I1928; }else{ $to =$GLOBALS[I1913] .mb_substr($from, $len); if(is_dir($from)){ $IlI1llI[] =$to; }elseif(is_file($to)){ $this->cms->AddStatusMsg('status_file_exists', I1925, I1910, I1910, array( I1927 => htmlspecialchars($to) ));$this->cms->AddStatusMsg('status_cannot_copy', I1925, I1910, I1910, array( 'from' => htmlspecialchars($from), 'to' => htmlspecialchars($to) ));$res =false; }else{ $aAllFiles[] =array(I1929 => $from, I1926 => $to); }}}}}$IlI1llL =trim($IlI1llL); if(!empty($IlI1llL) && is_file($IlI1lll) && is_readable($IlI1lll)){ $IlI1lLl =file_get_contents($IlI1lll); if(mb_strpos($IlI1lLl, '/* Plugin: ' .$cPluginId .' start */') !== false){ $this->cms->AddStatusMsg('status_style_exists', I1925, I1910, I1910, array( 'pluginId' => htmlspecialchars($cPluginId) ));$res =false; }}foreach($IlI1llI as $IlI1lLL) {if($res && !is_dir($IlI1lLL) && !($res =mkdir($IlI1lLL, 0777, true))) {$this->cms->AddStatusMsg(I1930, I1925, I1910, I1910, array(I1931 => htmlspecialchars($IlI1lLL))); }else{ AMI_Registry::push('disable_error_mail', true); chmod($IlI1lLL, 0777); AMI_Registry::pop('disable_error_mail'); }}if($res) {if(!empty($IlI1llL)){ $IlI1llL ="\n/* Plugin: " .$cPluginId ." start */\n" .$IlI1llL .I1932 .$cPluginId ." end */\n"; $IlI1lL1 =is_file($IlI1lll); if($IlI1lL1 && !is_writable($IlI1lll) || (file_put_contents($IlI1lll, $IlI1llL, FILE_APPEND) === false)){ $this->cms->AddStatusMsg('status_cannot_add_style', I1925); $res =false; }else{ if(!$IlI1lL1){ chmod($IlI1lll, 0777); }$this->cms->Core->SetModOption('pages', 'plugins_css_stamp', time()); $this->cms->Core->SaveOptions(I1933); }}if($res){ foreach($aAllFiles as $file => $fileData) {if(!$this->cms->TTITlTl($aAllFiles[$file][I1929], $aAllFiles[$file][I1926])) {$this->cms->AddStatusMsg('status_cannot_copy', I1925, I1910, I1910, array('from' => htmlspecialchars($aAllFiles[$file][I1929]), 'to' => htmlspecialchars($aAllFiles[$file][I1926]))); $res =false; }}}}}}return $res; }function Uninstall($cPluginId, $IlI1ILl ="") {$res =true; if($IlI1ILl){ $aInfo =$this->GetPluginInfo($GLOBALS[I1913] .$IlI1ILl, true); if(!empty($aInfo[I1934])){ $this->TTI1Ill($aInfo[I1934], $IlI1ILl); }}$IlI1llI =$this->TTI1IIl($cPluginId); require_once($GLOBALS[I1935]."func_file_system.php"); foreach($IlI1llI as $path) {$res =TT1lIll($path) && $res; }if($IlI1ILl){ $IlI1l1I =false; $IlI1ll1 =$GLOBALS[I1913] .$IlI1ILl .'_mod_files'; if(is_dir($IlI1ll1)){ $len =mb_strlen($GLOBALS[I1913] .$IlI1ILl); $IlI1lLI =getFiles($IlI1ll1, true, true); rsort($IlI1lLI); foreach($IlI1lLI as $from){ if(mb_strpos($from, '/.svn') !== false){ continue; }if(preg_match('/\/_css\/.*?\.css/i', $from) && is_readable($from)){ $IlI1l1I =true; }else{ $to =$GLOBALS[I1913] .mb_substr($from, $len); $IlI1l1l =is_dir($from); if(!$IlI1l1l && is_file($to)){ @unlink($to); }elseif($IlI1l1l){ $empty =true; $dh =opendir($to); while(false !== ($file =readdir($dh))){ if($file == I1900 || $file == I1936){ continue; }$empty =false; break; }closedir($dh); if($empty){ rmdir($to); }}}}}if($IlI1l1I){ $IlI1lll =$GLOBALS[I1913] .'_mod_files/_css/plugins.css'; if(is_writeable($IlI1lll)){ $IlI1l1L =preg_replace( '/\/\* Plugin\: ' .preg_quote($cPluginId) .' start \*\/.*?\/\* Plugin\: ' .preg_quote($cPluginId) .' end \*\//si', I1910, file_get_contents($IlI1lll) );$IlI1l1L =trim($IlI1l1L); $this->cms->TTITlTl($IlI1lll, $IlI1lll .I1937); if(file_put_contents($IlI1lll, $IlI1l1L) !== false){ if(empty($IlI1l1L)){ $this->cms->Core->SetModOption(I1933, 'plugins_css_stamp', 0); }else{ $this->cms->Core->SetModOption(I1933, 'plugins_css_stamp', time()); }$this->cms->Core->SaveOptions(I1933); }}}}return $res; }function TTI1IIl($cPluginId) {require_once $GLOBALS[I1893] .'func_file_system.php'; $IlI1llI =array(); foreach(array('code', I1938) as $type) {$path =$this->config[$type.I1939]; if (!validatePath($path)) {trigger_error("FS path hack attempt ({$type}_install_path)", E_USER_ERROR); }$IlI1llI[$type] =$GLOBALS[I1913] .$path .$cPluginId.I1894; }return $IlI1llI; }public static function GetPluginName($cId) {return sprintf('plugin_%02d', $cId); }function TTI1II1($cName) {$db =new db_si; $sql ="SELECT plugin_module FROM cms_plugins WHERE plugin_id = '$cName'"; $db->query($sql); if ($db->next_record()) {return sprintf('plugin_%02d', $db->Record[I1940]); }}public static function &TTI1IlT(&$cms) {$IlI1l11 =array(); for($i =1; $i <= $GLOBALS['PLUGINS_COUNT']; $i++) {$modName =CMS_InstallablePlugin::GetPluginName($i); $vMod =&$cms->Core->GetModule($modName); if($vMod->issetAndTrueOption(I1941)) {$IlI1l11[$modName] =&$vMod; }}return $IlI1l11; }public static function TTI1IlI(&$cms) {$aHeaders =array(); $plugins =&CMS_InstallablePlugin::TTI1IlT($cms); foreach($plugins as $modName => $vMod) {$IlI1LII =$vMod->GetOption('admin_menu_caption'); $aHeaders[I1942.$modName] =$IlI1LII[$cms->lang]; }return $aHeaders; }function TTI1Ill($IlI1LIl, $IlI1ILl){ $IlI1LIL =$GLOBALS[I1913] .$IlI1ILl ."database/" .$IlI1LIl; if(!file_exists($IlI1LIL)){ return false; }$sqlstr =file_get_contents($IlI1LIL); $sql =array(); if(!empty($sqlstr)){ PMA_splitSqlFile($sql, $sqlstr, 0); $db =new db_si; $db->setAttr('halt_on_err', false); for($i =0; $i <sizeof($sql); $i++){ if(preg_match('/^\s*CREATE\s+TABLE/i',$sql[$i]['query'])){ $line =preg_replace(I1943, ' ', $sql[$i]['query']); $db->TT1lIIT($line, DBC_RAW_QUERY); continue; }elseif(preg_match('/^\s*DROP\s+TABLE/i',$sql[$i]['query'])){ $line =preg_replace(I1943, I1944, $sql[$i]['query']); $db->query($line, DBC_TRUSTED_QUERY); continue; }$lines =explode(I1928, $sql[$i]['query']); $query =I1910; foreach($lines as $line){ $line =trim($line); if($line{0}=='#' && $line{1} == '@'){ continue; }elseif($line{0}==I1945 || ($line{0}=='-' && $line{1}=='-')){ continue; }$query .= " $line"; }if($query != ""){ $db->query($query); }}}return true; }}