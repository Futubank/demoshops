<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       7282 xkqwyxpxtzzqqrtyxsmtgqrukqtysiilsntziqzklzumyuxsimrnmxmnkntuxliqurskpnir
 */ ?><?php foreach(array(1948=>'WID|IZMJ|JQttQrD',1949=>'',1950=>"?jmimT?1",1951=>'#',1952=>'SZtZ',1953=>'MS',1954=>"{") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class CMS_MailQueue {function addLetter(&$db, $IlI1LLl, $aRecipients) {if (is_array($IlI1LLl) && is_array($aRecipients) && sizeof($aRecipients)) {$IlI1LLl += array ('date' => '=|NOW()'); $sql =$db->genInsertSQL(I1948, $IlI1LLl); $db->query($sql); $IlI1LLL =mysql_insert_id($db->_dbLink); foreach ($aRecipients as $IlI1LL1 => $data) {$sql =$db->genInsertSQL('cms_mail_recipients', array ('id_letter' => $IlI1LLL, 'email' => addslashes($IlI1LL1), 'data' => addslashes(serialize($data)), ),DBC_LOW_PRI); $db->query($sql); }}}function processQueue(&$process) {$IlI1L1I =AMI_Registry::get('ami/mailer/oneTimeLimit', 100); $IlI1L1l =array(); $IlI1L1L =AMI_Registry::get('ami/mailer/maxFailuresNumber', 3); require_once $GLOBALS['CLASSES_PATH'] .'Mailer.php'; $IlI1L11 =false; $IlI11II =0; $db =&$process->db; $sql ="LOCK TABLES `cms_mail_letters` WRITE, `cms_mail_recipients` WRITE"; $db->query($sql); $IlI11Il =array(); $IlI11IL =array(); do {$IlI11I1 =I1949; if(sizeof($IlI1L1l) >0){ $IlI11I1 ="WHERE id NOT IN ('".implode("','", $IlI1L1l)."') "; }$sql ="SELECT `id`, `subject`, `headers`, `body` FROM `cms_mail_letters` " .$IlI11I1 .I1950; $db->query($sql); $letter =$db->nextRecord(); $IlI1L1l[] =$letter['id']; if(!$letter){ $db->query("SELECT COUNT(id) FROM cms_mail_letters"); $res =$db->nextRecord(); $IlI1L11 =$res['COUNT(id)'] >0 ?false :true; break; }$sql ="SELECT `id`, `email`, `data`, `fail_count` " ."FROM `cms_mail_recipients` " ."WHERE `id_letter` = " .$letter['id'] ." ORDER BY `fail_count` ASC, `id` ASC" ." LIMIT " .($IlI1L1I -$IlI11II); $res =$db->query($sql); if (mysql_num_rows($res) <1) {if (CheckProbability(0.02)) {$sql ="OPTIMIZE TABLES `cms_mail_recipients`"; $db->query($sql); }$sql ="DELETE FROM `cms_mail_letters` WHERE `id` = " .$letter['id']; $db->query($sql); continue; }while ($recipient =$db->nextRecord()){ $IlI11lI =(int)$recipient['fail_count']; $oMail =new Mailer(); if (mb_strpos($recipient['email'], I1951) !== false) {list ($oMail->RecipientName, $oMail->RecipientAddress) =explode(' <', $recipient['email']); $oMail->RecipientAddress =mb_substr($oMail->RecipientAddress, 0, -1); }else {$oMail->RecipientAddress =$recipient['email']; }$body =$letter['body']; if ($recipient[I1952] != I1949) {$data =unserialize($recipient[I1952]); foreach ($data as $key => $value) {$body =str_replace('++' .$key .'++', $value, $body); }}$oMail->Body =$body; $oMail->Prepare(); $oMail->_Headers =unserialize($letter['headers']); $oMail->Subject =$letter['subject']; $this->_MailPrepared =true; $IlI11ll =(bool)$oMail->Send(); $IlI11II++; if($IlI11ll || (($IlI11lI +1) >= $IlI1L1L)){ $IlI11IL[] =$recipient[I1953]; if(!$IlI11ll && (($IlI11lI +1) >= $IlI1L1L)){ AMI_Service::log( 'CMS_MailQueue: Failed sending e-mail! Recipient was deleted due to max number of failures. cms_mail_recipients data: ' .print_r($recipient, true) .', cms_mail_letters data: ' .print_r($letter, true), $GLOBALS['ROOT_PATH'] .'_admin/_logs/err.log' );}}else{ $IlI11Il[] =$recipient[I1953]; AMI_Service::log( 'CMS_MailQueue: Failed sending e-mail! Number of failures was increased up to ' .($IlI11lI +1) .'. cms_mail_recipients data: ' .print_r($recipient, true) .', cms_mail_letters id = ' .$letter[I1953], $GLOBALS['ROOT_PATH'] .'_admin/_logs/err.log' );}}}while ($IlI11II <$IlI1L1I); if(count($IlI11Il)){ $sql ="UPDATE LOW_PRIORITY `cms_mail_recipients` SET fail_count = fail_count + 1 WHERE `id` IN (" .implode(",", $IlI11Il) .")"; $db->query($sql); }if(count($IlI11IL)){ $sql ="DELETE LOW_PRIORITY FROM `cms_mail_recipients` WHERE `id` IN (" .implode(",", $IlI11IL) .I1954; $db->query($sql); }$sql ="UNLOCK TABLES"; $db->query($sql); if ($IlI1L11) {if (CheckProbability(0.1)) {$sql ="TRUNCATE `cms_mail_recipients`"; $db->query($sql); $sql ="TRUNCATE `cms_mail_letters`"; $db->query($sql); }$process->unregisterHandler('CMS_MailQueue::processQueue'); }}}