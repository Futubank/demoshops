<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       42474 xkqwynmkprmyzpgnqqxxyqpltxnnkyklrwizxsykniwwrultlixnwulmsgrgyzktywzgpnir
 */ ?><?php foreach(array(2205=>"nQC",2206=>'fJt|tGJ|IHSuJQ|tBGQ',2207=>"ZJJHCQS|ZWtMHnD",2208=>"DZvQ",2209=>"JZnP|SZtZ",2210=>"uGSZtQ?",2211=>"?DQt?ZJJHCQS=1?COQrQ?IHSuJQ|HCnQr=''?ZnS?IHSuJQ=''",2212=>'?DQt?ZJJHCQS=1?COQrQ?IHSuJQ?JMKQ?\',:\'?ZnS?IHSuJQ|HCnQr?Mn?}\'',2213=>'DQJQWt?SMDtMnWt?IHSuJQ!?IHSuJQ|HCnQr?frHI?',2214=>'?COQrQ?IHSuJQ|HCnQr?Mn?}\'',2215=>"'!'",2216=>'IHSuJQ',2217=>'IHSuJQ|HCnQr',2218=>"dqT?.ZJJHCQS.?=?1?",2219=>".IHSuJQ.?Mn?}'",2220=>".IHSuJQ|HCnQr.?Mn?}'",2221=>"|qNzyjq|yUTThNd",2222=>"rQEuMrQ|rQDQt|IHSuJQD",2223=>"DQJQWt?IHSuJQ|HCnQr!?IHSuJQ?frHI?",2224=>"?COQrQ?ZJJHCQS=1?ZnS?IHSuJQ|HCnQr,=''",2225=>"?PrHuG?YB?IHSuJQ!?IHSuJQ|HCnQr?HrSQr?YB?IHSuJQ|HCnQr!?IHSuJQ",2226=>"IHSuJQ",2227=>'',2228=>'IHSuJQD',2229=>"IHSuJQD",2230=>'|DHrtiHSuJQDhCnQrD',2231=>'SZtQfrHI',2232=>"nZIQ",2233=>"IuJtM|DMtQD",2234=>"fJt|IHSQ",2235=>"IHSuJQ|tBGQ|DOZrQS",2236=>"IHSuJQ|tBGQ|ZSIMn",2237=>'ZSIMn',2238=>"IHSuJQ|tBGQ|frHnt",2239=>"fJt|tGJ|IHSuJQ|tBGQ",2240=>"=",2241=>'=',2242=>"WOQWKYHx",2243=>"IHSMfMQS|MSD",2244=>"fJt|tGJ|IHSuJQ|nZIQ",2245=>"?JMKQ?",2246=>":",2247=>'?hR?IHSuJQ?JMKQ?\'',2248=>'?hR?IHSuJQ?Mn}\'',2249=>'fJt|tGJ|IHSuJQD',2250=>"ZJJ",2251=>"WHIIHn|IHSuJQ",2252=>"`|WHIIHn",2253=>"fJt|tGJ|IHSuJQD",2254=>'`',2255=>'?hR?}IHSuJQ|HCnQr=\'',2256=>'\'',2257=>'?zNs?IHSuJQ?JMKQ?\'',2258=>"fJt|tGJ|WHntQnt",2259=>"fJt|tGJ|nZIQ",2260=>"IHSMfMQS",2261=>"nuI",2262=>"",2263=>'`|WHIIHn',2264=>"DQJQWtQS",2265=>"IHSuJQ|HCnQr",2266=>"IHSuJQD|WurrQnt",2267=>'GZtOD',2268=>'DQJQWt?SMDtMnWt?GZtO?frHI?WID|IHSuJQD|tQIGJZtQD',2269=>"GZtO",2270=>"MS!?MD|DBD!?DMSQ!?GZtO!?nZIQ!?IHSuJQ!?IHSuJQ|HCnQr!?SZtQ|fHrIZt}IHSMfMQS!'",2271=>"'{?ZD?ISZtQ",2272=>"fMQJSD",2273=>'IQtOHS',2274=>'|DQtiHSuJQNZIQ',2275=>"MS",2276=>"fHrI|SZtZ",2277=>"ZWtMHn",2278=>"|JMDt%vMQC",2279=>"QSMt|MS",2280=>'ZWtMHn',2281=>"ZSS",2282=>"JQP|rQS",2283=>"JQP|tGJ|IHSMfMQS",2284=>"DMSQ",2285=>'IHSMfMQS',2286=>"uGSZtQ?WID|IHSuJQD|tQIGJZtQD?DQt?WHntQnt|tBGQ=0!?GZrDQS=''",2287=>'JZnPD|',2288=>'tZ|OMPOJMPOt',2289=>"dqjqwT?MS!?MD|DBD!?GZtO!?nZIQ!?IHSuJQ|HCnQr!?IHSuJQ!?WHntQnt?",2290=>"WHntQnt",2291=>'Qnv~WHHKMQ',2292=>"DQJQWt?IHSuJQ!?IHSuJQ|HCnQr?frHI?",2293=>"'",2294=>'tZ|GHDMtMHn',2295=>"MD|DBD",2296=>"?COQrQ?GZtO='",2297=>"b+I+S?o%M%D",2298=>'uGSZtQS',2299=>"rQS",2300=>'MPnHrQS',2301=>"``",2302=>"RhhT|gzTo",2303=>"tQIGJZtQD~trQQ~",2304=>'hGtMHnDiHSuJQNZIQ',2305=>'nZIQ',2306=>"QDOHG",2307=>"DMtQIZG",2308=>"WZGtMHn",2309=>"WHrrQWtvZJuQ",2310=>"FRhi?.WID|IHSuJQD|tQIGJZtQD.?",2311=>"coqRq?",2312=>"}.IHSuJQ.?=?'",2313=>"'?hR?IHSuJQ?=?''{?zNs?",2314=>"\|:`tGJ'?",2315=>"~",2316=>'YHSB',2317=>"?",2318=>"tZ|GHDMtMHn") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class CMS_ModulesTemplates extends CMS_ActModule {public $aModules; public $IllLL1L; public $IllLL11; public $extension; public $isLangs; public $IllL1II; function CMS_ModulesTemplates(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->aModules =array(); $this->IllLL1L =array(); $this->IllLL11 =array( "modified" => array(), "modified_ids" => array(), I2205 => array(), "old" => array() );}function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {$this->IllL1II =false; if(isset($this->cms->Vars[I2206]) && $this->cms->Vars[I2206] == 'admin'){ $this->IllL1II =true; }$IIIIL11[I2207] =$this->IllL1II ?array('view') :array("add", "edit", "apply", I2208, "del", "import", "export"); $IIIIL11["group_operations"] =Array(); $IIIIL11[I2209] =false; $IIIIL11["check_public"] =false; $IIIIL11["multi_sites"] =true; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function setTemplatesPermissions(){ $sql ="update ".$this->module->GetTableName()." set allowed=0, content_type=0, parsed=''"; $this->db->query($sql); $sql =I2210.$this->module->GetTableName().I2211; $this->db->query($sql); $allowedOwners =array(); $vOwners =$this->cms->Core->GetOwnersList(); foreach($vOwners as $name => $vOwner) {if($this->cms->Core->IsOwnerInstalled($name)){ $allowedOwners[] =$name; }}if(!in_array('pmanager', $allowedOwners)) $allowedOwners[] ='pmanager'; if(sizeof($allowedOwners) >0){ $sql =I2210.$this->module->GetTableName().I2212.implode("','", $allowedOwners).'\')'; $this->db->query($sql); $allowedModules =array(); $sql =I2213.$this->module->GetTableName().I2214.implode(I2215, $allowedOwners).'\')'; $this->db->query($sql); while($this->db->next_record()){ if(!empty($this->db->Record[I2216]) && ($this->db->Record[I2217] == 'pmanager' || $this->cms->Core->IsInstalled($this->db->Record[I2216]))){ $allowedModules[] =$this->db->Record[I2216]; }}}if(sizeof($allowedModules) >0){ $sql ="UPDATE " .$this->module->GetTableName() ." " .I2218 ."WHERE " .I2219 .implode(I2215, $allowedModules) ."') AND " .I2220 .implode(I2215, $allowedOwners) ."')"; $this->db->query($sql); }}function _InitAdmin() {parent::_InitAdmin(); if(!$this->options["multi_sites"] && !$this->IllL1II){ $this->cms->Gui->AddGlobalVars(Array(I2221 => 1)); }if(defined('TEMPLATES_FROM_DISK')){ $this->cms->Gui->AddGlobalVars(Array("TPLS_READ_FROM_DISK" => 1)); }$vData =false; if($this->cms->Core->ReadOption($vData, $this->moduleName, I2222)){ $this->setTemplatesPermissions(); $this->cms->Core->DeleteOption($this->moduleName, I2222); }$IllL1Il =$this->cms->Gui->parseLangFile('templates/lang/_menu_all.lng'); $sql =I2223.$this->module->GetTableName().I2224.$this->_ApplyFilters().I2225; $this->db->query($sql); while($this->db->next_record()){ $IIIl11L =$this->db->Record[I2217]; if($this->db->Record[I2226][0] == '!'){ $this->IllLL1L[$IIIl11L] =TRUE; }else if(!isset($this->aModules[$IIIl11L])){ $IllL1IL =I2227; $oModule =&$this->cms->Core->GetModule($this->db->Record[I2216]); if(is_object($oModule) && $oModule->HaveParent()){ $IllL1IL =$IllL1Il[$oModule->GetParentName()] .' : '; }$this->aModules[$IIIl11L] =array( 'name' => isset($IllL1Il[$IIIl11L]) ?$IllL1Il[$IIIl11L] :'unknown', I2228 => array( $this->db->Record[I2216] => $IllL1IL .$IllL1Il[$this->db->Record[I2216]] ));}else{ $IllL1IL =I2227; $oModule =&$this->cms->Core->GetModule($this->db->Record[I2226]); if(is_object($oModule) && $oModule->HaveParent()){ $IllL1IL =$IllL1Il[$oModule->GetParentName()] .' : '; }$this->aModules[$IIIl11L][I2229][$this->db->Record[I2226]] =$IllL1IL .$IllL1Il[$this->db->Record[I2226]]; }}uasort($this->aModules, array(&$this, I2230)); foreach($this->aModules as $ownerName => $ownerData){ asort($this->aModules[$ownerName][I2228]); }if($this->filter->issetField(I2231)){ $this->filter->TITI1l1(I2231); }if($this->filter->issetField('dateto')){ $this->filter->TITI1l1('dateto'); }$this->filter->IL11l1L =array('limit'); }function _sortModulesOwners($a, $b){ return strcasecmp($a["name"], $b[I2232]); }function TTTlITT($IIIL11l, $cId, $cModule ="") {switch($IIIL11l){ case "import": if(!$this->options["multi_sites"] && !$this->IllL1II) {$this->TTIITT1($cId, $cModule); }break; case "export": if(!$this->options[I2233] && !$this->IllL1II) {$this->TTTl11I($cId, $cModule); }break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function _ApplyFilters($prefix =I2227, $bodyType =I2227, $IIlLLl1 =TRUE){ $res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); if($this->options[I2233] && $this->siteId == 0) {$res .= " AND ".$this->options["default_prefix"]."id_site='".$this->siteId."'"; }return $res; }function GetHtml(&$aCustom) {return parent::GetHtml($aCustom); }function TTlTll1() {parent::TTlTll1(); }function TTTlIII() {parent::TTTlIII(); $this->filter->AddField(I2234, "hidden", $this->cms->Vars[I2234]); if(AMI::getSingleton('env/cookie')->get('ami_engine', false) == 6){ $IllL1I1 =array(); $IllL1I1 =$this->filter->TITI1TT($IllL1I1, array($this->words[I2235] => 'shared'), 55); $IllL1I1 =$this->filter->TITI1TT($IllL1I1, array($this->words[I2236] => I2237), 55); $IllL1I1 =$this->filter->TITI1TT($IllL1I1, array($this->words[I2238] => 'front'), 55); $IllL1lI =isset($this->cms->Vars[I2206]) ?$this->cms->Vars[I2206] :'front'; $this->filter->AddField(I2239, "select", $IllL1lI, "", I2240, "side", $IllL1I1); }else{ $this->filter->AddField(I2239, "hidden", 'front', 'front', I2241, 'side'); $this->filter->TITI1II(I2239, " OR side = 'shared'"); }if(!$this->options[I2233]) {$this->getModifiedTemplates(); if(sizeof($this->IllLL11["modified_ids"]) >0){ $this->filter->AddField("flt_show_modified_templates", I2242, empty($this->cms->Vars['flt_show_modified_templates']) ?0 :intval($this->cms->Vars['flt_show_modified_templates']), '0', I2240, "id"); if(empty($this->cms->Vars['flt_show_modified_templates'])){ $this->filter->DisableFieldSQL("flt_show_modified_templates"); }else{ $this->filter->TITI1II("flt_show_modified_templates", ' OR id in ("'.implode('","', $this->IllLL11[I2243]).'")', 'force'); }}}$IllL1ll =isset($this->cms->Vars[I2244]) ?stripslashes(unhtmlentities($this->cms->Vars[I2244])) :I2227; $this->filter->AddField(I2244, "text", $IllL1ll, "", I2245, "content"); $this->filter->MoveField(I2244, _MOVE_START); if(empty($this->cms->Vars[I2244])){ $this->filter->DisableFieldSQL(I2244); }else{ $IllL1lL =mb_strtolower(str_replace("*", "", $IllL1ll)); $IllL1l1 =array(); foreach($this->aModules as $ownerName => $ownerData){ foreach($ownerData[I2229] as $moduleName => $IllL1LI){ if(!empty($IllL1LI) && (mb_strpos(mb_strtolower($IllL1LI), $IllL1lL) !== false)){ $IllL1l1[] =$moduleName; }}}$IllL1ll =str_replace("*", I2246, $IllL1ll); $this->filter->TITI1II(I2244, I2247.mysql_real_escape_string($IllL1ll).'%\''.(sizeof($IllL1l1) >0 ?I2248.implode(I2215, $IllL1l1).'\')' :""), 'force'); }$IllL1Ll =isset($this->cms->Vars[I2249]) ?$this->cms->Vars[I2249] :null; $aModules =Array(); $aModules =$this->filter->TITI1TT($aModules, Array($this->cms->Words[I2250]=>I2227), 55); $aModules =$this->filter->TITI1TT($aModules, Array($this->words[I2251]=>'._common'), 55); foreach($this->aModules as $ownerName => $ownerData){ if(sizeof($ownerData[I2229]) >1){ $IllL1LL =$ownerData[I2232]." : ".$this->cms->Words[I2250]; $IllL1L1 =$ownerName."._all"; $aModules =$this->filter->TITI1TT($aModules, Array($IllL1LL=>$IllL1L1), 55); if(isset($this->IllLL1L[$ownerName])){ $IllL1LL =$ownerData[I2232]." : ".$this->words[I2251]; $IllL1L1 =$ownerName.I2252; $aModules =$this->filter->TITI1TT($aModules, Array($IllL1LL=>$IllL1L1), 55); }}foreach($ownerData[I2229] as $moduleName => $IllL1LI){ if(!empty($IllL1LI)){ $IllL1LL =$ownerData[I2232]." : ".$IllL1LI; $IllL1L1 =$ownerName.".".$moduleName; $aModules =$this->filter->TITI1TT($aModules, Array($IllL1LL=>$IllL1L1), 55); }}}$this->filter->AddField(I2253, "select", $IllL1Ll, "", I2240, I2226, $aModules); $this->filter->MoveField(I2253, _MOVE_START); if(empty($IllL1Ll)){ $this->filter->DisableFieldSQL(I2253); }else{ $IllL11I =explode(I2254, $IllL1Ll); if(sizeof($IllL11I) == 2){ if(empty($IllL11I[0])){ $IllL11I[0] =""; $IllL11I[1] =""; }else if($IllL11I[1] == "_common"){ $IllL11I[1] ="!%"; }$this->filter->TITI1II(I2253, I2255.$IllL11I[0].I2256.($IllL11I[1] != '_all' ?I2257.$IllL11I[1].I2256 :I2227).')', 'force'); }else{ $this->filter->DisableFieldSQL(I2253); }}$IllL11l =isset($this->cms->Vars["flt_tpl_content"]) ?stripslashes(unhtmlentities($this->cms->Vars[I2258])) :I2227; $this->filter->AddField(I2258, "text", $IllL11l, "", I2245, "content"); $this->filter->TITI1T1(I2258); $this->filter->MoveField(I2258, _MOVE_START); if(empty($this->cms->Vars[I2258])){ $this->filter->DisableFieldSQL(I2258); }$IllL11L =isset($this->cms->Vars["flt_tpl_name"]) ?stripslashes(unhtmlentities($this->cms->Vars[I2259])) :I2227; $this->filter->AddField(I2259, "text", $IllL11L, "", I2245, I2232); $this->filter->MoveField(I2259, _MOVE_START); if(empty($this->cms->Vars[I2259])){ $this->filter->DisableFieldSQL(I2259); }}function &TTTlI1T(&$aCustom) {return parent::TTTlI1T($aCustom); }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); $vData['form_width'] ='100%'; }function TTTlI11(&$vData, &$aCustom) {if(!$this->options[I2233]) {if(sizeof($this->IllLL11[I2260]) >0){ $this->cms->AddStatusMsg("status_modified_templates", "red", "", "", array(I2261 => (string)sizeof($this->IllLL11[I2260]))); }if(sizeof($this->IllLL11[I2205]) >0){ $this->cms->AddStatusMsg("status_new_templates", "red", "", "", array(I2261 => I2262.(string)sizeof($this->IllLL11[I2205]))); }}if(sizeof($this->IllLL11[I2260])){ $vData['isChooseExportSyncType'] =true; }if(sizeof($this->IllLL11["old"])){ $vData['isChooseImportSyncType'] =true; }$aData =array( I2232 => $this->words[I2251], "val" => I2263, );$vData[I2229] =$this->cms->Gui->get($this->moduleName."_subform:option", $aData); foreach($this->aModules as $ownerName => $ownerData){ foreach($ownerData[I2229] as $moduleName => $IllL1LI){ if(!empty($IllL1LI)){ $aData =array( I2232 => $ownerData[I2232]." : ".$IllL1LI, "value" => $ownerName.".".$moduleName, I2264 => empty($this->itemData[I2226]) || $moduleName != $this->itemData[I2226] ?I2262 :I2264 );$vData[I2229] .= $this->cms->Gui->get($this->moduleName."_subform:option", $aData); }}}if(!empty($this->itemData["id"])){ if(empty($this->itemData[I2265])){ $vData[I2266] =$this->words[I2251]; }else{ $ownerName =$this->aModules[$this->itemData[I2265]][I2232]; $moduleName =$this->aModules[$this->itemData[I2265]][I2229][$this->itemData[I2226]]; if(empty($moduleName) || $moduleName[0] == "!") $moduleName =$this->words[I2251]; $vData[I2266] =$ownerName." : ".$moduleName; }}$vData[I2267] =I2227; $sql =I2268.($this->isLangs ?'_langs' :I2227).' where allowed=1 AND side <> \'admin\' order by path'; $this->db->query($sql); while($this->db->next_record()){ $aData =array( I2232 => $this->db->Record["path"], "value" => $this->db->Record[I2269], I2264 => I2262 );if(isset($this->itemData[I2269]) && $this->db->Record[I2269] == $this->itemData[I2269]){ $vData["paths_current"] =$this->db->Record[I2269]; $aData[I2264] =I2264; }$vData["paths"] .= $this->cms->Gui->get($this->moduleName."_subform:option", $aData); }$this->browser->InitSQL(I2270.$this->cms->DFMT["db_dtime"].I2271, "FROM ".$this->module->GetTableName()." ", "WHERE allowed=1 ".$this->_ApplyFilters().$this->TTTlIl1(), I2262, I2226, "id desc" );$aCustom[I2272] += Array( "mdate"=>Array('action'=>'callback', 'object'=>&$this, I2273=>'_setModified'), I2226=>Array('action'=>'callback', 'object'=>&$this, I2273=>I2274), );if(defined('TEMPLATES_FROM_DISK')){ $aCustom[I2272]["action_edit"] =Array("action"=>"flagicon", "value"=>I2262, I2275=>"edit_id", "on"=>$this->moduleName."_list:icon_none","off"=>I2262); $aCustom[I2276]["buttons"] =Array(); $this->cms->AddStatusMsg("templates_read_from_disk", "red"); }else{ if($this->IllL1II){ $aCustom[I2272]["action_edit"] =array(I2277 => "flagicon", "value" => I2262, I2275 => "view_id", "on" => $this->moduleName.I2278, "off" => I2262); }else{ $aCustom[I2272]["action_edit"] =Array(I2277=>"flagicon", "value"=>I2262, I2275=>I2279, "on"=>$this->moduleName."_list:edit","off"=>I2262); }$aCustom[I2272]["action_del"] =Array(I2280=>'callback', 'object'=>&$this, I2273=>'_setActionDel'); $aCustom[I2276]["buttons"] =$this->IllL1II ?array() :array(I2281, "apply", "cancel", I2208); }$aCustom["applied_id"] =I2275; $aCustom["legend"] =Array(I2282, "leg_yellow", "leg_blue", "leg_edit", "leg_del", I2283); parent::TTTlI11($vData, $aCustom); }function _setActionDel(&$aItem, &$aData){ $links["del_id"] =$links[I2279] =$links["pub_id"] =$aItem[I2275]; $aItem["action_del"] =($aItem["is_sys"] || ($aItem[I2284] == I2237)) ?$this->cms->Gui->get($this->moduleName."_list:icon_none", $links) :$this->cms->Gui->get($this->moduleName."_list:del", $links); }function _setModuleName(&$aItem, &$aData){ if(empty($aItem[I2265])){ $aItem[I2226] =$this->words[I2251]; }else{ $ownerName =$this->aModules[$aItem[I2265]][I2232]; $moduleName =$this->aModules[$aItem[I2265]][I2229][$aItem[I2226]]; if(empty($moduleName) || $moduleName[0] == "!") $moduleName =$this->words[I2251]; $aItem[I2226] =$ownerName." : ".$moduleName; }}function _setModified(&$aItem, &$aData){ if(isset($this->IllLL11[I2285][$aItem[I2269].$aItem[I2232]])){ $aItem["isModified"] =true; }}function TTlTl1T(){ $sql =I2210.$this->module->GetTableName()." set content_type=0, parsed=''"; $this->db->query($sql); if($this->isLangs){ $sql =I2286; $this->db->query($sql); }}function TTT1Tl1($cType, $cModule, $condition =I2227) {$this->setTemplatesPermissions(); parent::TTT1Tl1($cType, $cModule, $condition); }function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); if(isset($this->cms->VarsPost['ta_position'])){ SetLocalCookie('ta_position_'.($this->isLangs ?I2287 :I2227).$this->appliedId, $this->cms->VarsPost['ta_position'], time()+3600, $this->cms->AdminPathWWW); }if(isset($this->cms->VarsPost['ta_highlight'])){ SetLocalCookie('ta_highlight'.($this->isLangs ?'_langs' :I2227), $this->cms->VarsPost[I2288], time()+3600, $this->cms->AdminPathWWW); }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql =I2289. "FROM ".$this->module->GetTableName()." ". "WHERE allowed = 1 AND id = " .(int)$cId .$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData["body"] =$this->cms->htmlchars($this->itemData[I2290]); $this->itemData[I2232] =preg_replace('/\.'.$this->extension.'$/i', I2227, $this->itemData[I2232]); $IllL111 ='ta_position_' .($this->isLangs ?I2287 :I2227) .$cId; $this->itemData["ta_position"] =AMI::getSingleton(I2291)->get($IllL111); $IllL111 =I2288 .($this->isLangs ?'_langs' :I2227); $this->itemData["ta_highlight"] =AMI::getSingleton(I2291)->get($IllL111); }}function TTTll1l($cId, $cModule){ $this->TTTl1Tl($cId, $cModule); }function TTTl1T1($cId, $cModule) {parent::TTTl1T1($cId, $cModule); }function _ActionDel($cId, $cModule) {parent::_ActionDel($cId, $cModule); if($II1LLLL->errno == 0){ $this->TTlTl1T(); }}function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno'])){ $this->TTlTl1T(); $sql =I2292.$this->module->GetTableName()." where id='".$cId.I2293; $this->db->query($sql); $this->db->next_record(); if(empty($this->db->Record[I2265]) || $this->db->Record[I2265] == 'pmanager' || $this->db->Record[I2226][0] == '!'){ $this->cms->Core->Cache->ClearAdd(I2250); }else if(!empty($this->db->Record[I2226])){ $module =$this->db->Record[I2226]; $oMod =$this->cms->Core->GetModule($module); $this->cms->Core->Cache->clearModCache($oMod); }}if(isset($this->cms->VarsPost['ta_position'])){ SetLocalCookie('ta_position_'.($this->isLangs ?I2287 :I2227).$cId, $this->cms->VarsPost[I2294], time()+3600, $this->cms->AdminPathWWW); }if(isset($this->cms->VarsPost[I2288])){ SetLocalCookie(I2288.($this->isLangs ?'_langs' :I2227), $this->cms->VarsPost[I2288], time()+3600, $this->cms->AdminPathWWW); }}function TTT1IlI($aSql =Array(), $cId =0) {$isSys =0; if($cId >0){ $sql ="select `is_sys`, `side` from ".$this->module->GetTableName()." where id='".$cId.I2293; $this->db->query($sql); $this->db->next_record(); if($this->db->Record['side'] == I2237){ return array(); }$isSys =$this->db->Record[I2295]; }$name =I2262; if(!$isSys){ if(!empty($this->cms->VarsPost[I2232]) && preg_match('/^[a-zA-Z0-9_\-\.]+$/si', $this->cms->VarsPost[I2232])) $name =preg_replace('/\.'.$this->extension.'$/i', I2227, $this->cms->VarsPost[I2232]).I2254.$this->extension; if(!empty($name)){ $sql ="select count(*) as count from ".$this->module->GetTableName().I2296.$this->cms->VarsPost[I2269]."' and name='".$name.I2293.$this->_ApplyFilters().($cId >0 ?" AND id!='".$cId.I2293 :I2262); $this->db->query($sql); $this->db->next_record(); if($this->db->Record["count"] >0){ $name =I2227; }}}if($isSys || !empty($name)){ $content =$this->cms->TTITIIT($this->cms->VarsPost["body"]); $aSql =Array( I2290=>$content, I2260=>date(I2297), "synchronized"=>date(I2297) );if(!$isSys){ $aSql[I2232] =$name; $aModule =explode(I2254, $this->cms->VarsPost[I2226]); if(empty($aModule[0])) $aModule[1] =I2227; else{ if($aModule[1] == '_common') $aModule[1] =I2227; }$aSql[I2265] =$aModule[0]; $aSql[I2226] =$aModule[1]; $aSql[I2269] =$this->cms->VarsPost[I2269]; if($cId == 0){ $aSql["created"] =date(I2297); }}}$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TTTl11I($cId, $cModule){ $res =$this->cms->Gui->exportTemplatesToDisk($this->db, $this->isLangs, $this->cms->Vars["sync_type"] == 2); $this->TTlTl1T(); $this->cms->AddStatusMsg("status_exported_templates", "none", I2262, I2262, array( 'added' => (string)$res['added'], 'updated' => (string)$res[I2298], 'ignored' => (string)$res['ignored'] ));if($res['failed'] >0){ $this->cms->AddStatusMsg("status_export_failed_templates", I2299, I2262, I2262, array( 'failed' => (string)$res['failed'] ));}}function TTIITT1($cId, $cModule){ $res =$this->cms->Gui->importTemplatesFromDisk($this->db, $this->isLangs, false, $this->cms->Vars["sync_type"] == 2); $this->TTlTl1T(); if($res['added'] >0){ $this->setTemplatesPermissions(); }$this->cms->AddStatusMsg("status_imported_templates", "none", I2262, I2262, array( 'added' => (string)$res['added'], I2298 => (string)$res[I2298], 'ignored' => (string)$res[I2300] ));$this->cms->Core->Cache->ClearAdd(I2250); }function getModifiedTemplates(){ $dbTemplates =array(); $sql ="select id, path, name, unix_timestamp(synchronized) as modified_tm from ".$this->module->GetTableName() .' WHERE 1 ' .$this->_ApplyFilters(); $this->db->query($sql); while($this->db->next_record()){ $dbTemplates[$this->db->Record[I2269].$this->db->Record[I2232]] =array($this->db->Record[I2275], $this->db->Record["modified_tm"]); }clearstatcache(); $this->_rGetModifiedTemplates($dbTemplates, "templates/"); $this->_rGetModifiedTemplates($dbTemplates, $GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/"); }function _rGetModifiedTemplates(&$dbTemplates, $filesPath){ if(is_dir($GLOBALS["ROOT_PATH"].$filesPath)){ if($handle =opendir($GLOBALS["ROOT_PATH"].$filesPath)){ while(($file =readdir($handle)) !== false){ if($file == "." || $file == I2301) continue; else if(is_dir($GLOBALS["ROOT_PATH"].$filesPath.$file)){ $this->_rGetModifiedTemplates($dbTemplates, $filesPath.$file."/"); }else{ if(preg_match('/\.'.$this->extension.'$/si', $file, $matches)){ if(file_exists($GLOBALS[I2302].$filesPath.$file)){ $fileTime =filemtime($GLOBALS[I2302].$filesPath.$file); if(isset($dbTemplates[$filesPath.$file]) && $dbTemplates[$filesPath.$file][1] <$fileTime){ $this->IllLL11[I2260][$filesPath.$file] =$fileTime; $this->IllLL11[I2243][] =$dbTemplates[$filesPath.$file][0]; }else if(isset($dbTemplates[$filesPath.$file]) && $dbTemplates[$filesPath.$file][1] >$fileTime){ $this->IllLL11["old"][$filesPath.$file] =$fileTime; }else if(!isset($dbTemplates[$filesPath.$file])){ $this->IllLL11[I2205][$filesPath.$file] =$fileTime; }}}}}closedir($handle); }}}function GetCustomLetterTemplates($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues") {$this->GetCustomModuleTemplates($cData, $IIL1lL1, $res, $aData, $IIL1l1I, "templates/letters/", false); return true; }function GetCustomTreeTemplates($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues") {$this->GetCustomModuleTemplates($cData, $IIL1lL1, $res, $aData, $IIL1l1I, I2303, true); return true; }function GetCustomModuleTemplatesWithPath($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues") {$this->GetCustomModuleTemplates($cData, $IIL1lL1, $res, $aData, $IIL1l1I, "templates/", true); return true; }function GetCustomModuleTemplates($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues", $Ill1III ="templates/", $Ill1IIl =false) {$Ill1IIL =$IIL1lL1[I2304]; $oModule =&$this->cms->Core->GetModule($Ill1IIL); if (is_object($oModule) && $oModule->HaveParent()) {$modName =$oModule->GetParentName(); }else {$modName =$Ill1IIL; }$optName =$cData[I2305]; if($optName == 'form_template'){ $oDeclarator =AMI_ModDeclarator::getInstance(); if($oDeclarator->isRegistered($modName)){ list($hyper, $config) =$oDeclarator->getHyperData($modName); if( 'ami_multifeeds' === $hyper ){$modName ='rating'; }unset($hyper, $config); }unset($oDeclarator); }if (mb_substr($modName, 0, 6) == "eshop_") {$modName =I2306; }elseif(mb_substr($modName, 0, 10) == "portfolio_") {$modName ="portfolio"; }elseif(mb_substr($modName, 0, 3) == "kb_") {$modName ="kb"; }elseif ($modName == I2307 || $modName == "sectionmap") {$modName ="sm"; }switch($IIL1l1I) {case "getallvalues": $res =array(); $Ill1II1 =I2262; if ($Ill1IIl) {$Ill1II1 =$Ill1III; }$this->TTlTl1I($GLOBALS[I2302].$Ill1III, $modName, $res, $Ill1II1, $cData["value"]); $res[] =Array( I2232 => I2262, I2308 => "%%by_default%%", I2264 => ((I2262 == $cData["value"]) ?I2264 :I2262) );break; case "getvalue": $res =$cData["value"]; break; case I2309: $res =$cData["value"]; break; }return true; }function TTlTl1I($Ill1III, $modName, &$vRes, $Ill1II1 =I2262, $IILLLlL =I2262, $Ill1IlI =true) {if (!$this->cms->Gui->forceReadFileFromDisk) {if(mb_strpos($Ill1III, $GLOBALS['ROOT_PATH']) === 0){ $Ill1III =mb_substr($Ill1III, mb_strlen($GLOBALS['ROOT_PATH'])); }$vRes =array(); $sql ="SELECT `path`, `name` " .I2310 .I2311 ."`allowed` = 1 AND (`side` = 'front' OR `side` = 'shared') AND " .I2312 .mysql_real_escape_string($modName) .I2313 ."`path` LIKE '" .mysql_real_escape_string($Ill1III) ."%' AND " ."`name` LIKE '" .mysql_real_escape_string($modName) .I2314 .$this->cms->Gui->getSqlFilter(); $this->db->query($sql); while($this->db->next_record()) {if ($Ill1II1) {$path =$this->db->Record[I2269]; }else {$path =I2227; }$vRes[] =Array( I2232 => $path.$this->db->Record[I2232], I2308 => $path.$this->db->Record[I2232], I2264 => (($path.$this->db->Record[I2232] == $IILLLlL) ?I2264 :I2262) );}return true; }else {if ($Ill1IlI) {$vRes =array(); }if ($Ill1III[mb_strlen($Ill1III)-1] == '/' || $Ill1III[mb_strlen($Ill1III)-1] == '\\') {$Ill1III =mb_substr($Ill1III, 0, mb_strlen($Ill1III)-1); }if (is_dir($Ill1III)) {if ($dir =opendir($Ill1III)) {while (($file =readdir($dir)) !== false) {if ($file != "." && $file != I2301) {if (is_dir($Ill1III."/".$file)) {if ($Ill1II1) {$path =$Ill1II1.$file.I2315; }else {$path =I2262; }$this->TTlTl1I($Ill1III.I2315.$file, $modName, $vRes, $path, $IILLLlL, false); }else {if (preg_match('/^'.$modName.'\_.*\.tpl$/si', $file)) {$vRes[] =Array( I2232 => $Ill1II1.$file, I2308 => $Ill1II1.$file, I2264 => (($Ill1II1.$file == $IILLLlL) ?I2264 :I2262) );}}}}closedir($dir); return true; }}return false; }}function TTlTl1l($Ill1Ill, $cPath =I2227, $IIIL1LL =I2227) {$fileId =0; $aRec =$this->TTlTl11($Ill1Ill); if($aRec) {$fileId =$aRec['id']; }else {$Ill1IlL =$this->cms->VarsPost; $Ill1Il1 =Array(I2305 => mb_substr($Ill1Ill, 0, mb_strrpos($Ill1Ill, I2254)), 'path' => $cPath, I2216 => $IIIL1LL, I2316 => I2262, );$this->cms->VarsPost =$Ill1Il1; $this->_Init(); $this->TTTll11(0, I2262); $fileId =$this->appliedId; if($this->errno) {}$this->cms->ClearMessages(); $this->SetLastError(); $this->cms->VarsPost =$Ill1IlL; }$Ill1ILI =Array ('id' => $fileId, 'content' => Array() );if($this->cms->Gui->isValidFile($cPath.$Ill1Ill)) {$Ill1ILl =$this->cms->Gui->parseLangFile($cPath.$Ill1Ill); $Ill1ILI['content'] =$Ill1ILl; }return $Ill1ILI; }function TTlTl11($cName) {$aRec =false; $sql =I2289. "FROM ".$this->module->GetTableName().I2317. "WHERE allowed=1 AND name='".$cName.I2293.$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$aRec =$this->db->Record; $aRec["body"] =$this->cms->htmlchars($this->itemData[I2290]); $aRec[I2232] =preg_replace('/\.'.$this->extension.'$/i', I2227, $this->itemData[I2232]); $aRec[I2318] =AMI::getSingleton(I2291)->get('ta_position_'.($this->isLangs ?I2287 :I2227).$cId); $aRec["ta_highlight"] =AMI::getSingleton(I2291)->get(I2288.($this->isLangs ?'_langs' :I2227)); }return $aRec; }}