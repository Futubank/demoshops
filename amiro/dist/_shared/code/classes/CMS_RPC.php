<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @subpackage api 
 * @version    $Id$ 
 * @size       12420 xkqwmwtrwzswwpurwygqmsyxrkyitwxusyyuqlsrprykmynwmrmuxigliiylnrygtqxwpnir
 */ ?><?php foreach(array(2340=>'WHnfMP|rGW`MnM`GOG',2341=>'JHP|QrrHrD',2342=>'ZJJHCQS|rQIHtQ|MGD',2343=>'IZDtQr|GZDDCHrS',2344=>'rGW|IHSuJQ',2345=>'DQWurMtB',2346=>'rGW|IHSuJQ|GHDtfMx',2347=>'Qxt|MntQPrZtMHn',2348=>'QxtQrnZJ|MntQPrZtMHn|IHSuJQD|JMDt',2349=>'IQIYQrD',2350=>'IHSuJQ',2351=>'KQB|QxtQrnZJ',2352=>"coqRq?IHSuJQ?=?'",2353=>"'",2354=>"",2355=>'^',2356=>"\r\n\r\n",2357=>'DQttMnPD') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class CMS_RPC {public $cms; public $db; public $settings; public $externalKeyAction; public $action; public $moduleName; public $IlL1LlI; public $parameters; public $IlIL11I; public $_cookies; function Init(&$cms, &$db) {$this->externalKeyAction =''; $this->IlIL11I =false; $path =$GLOBALS['LOCAL_FILES_PATH'] .I2340; if (!is_file($path)) {return 1; }$prevoiusErrorLevel =error_reporting(E_ALL); $this->settings =parse_ini_file($path, true); error_reporting($prevoiusErrorLevel); $IlL1Lll =array ('security' => array ('master_password'), 'settings' => array ('cms_language', I2341, 'log_path') );foreach ($IlL1Lll as $sectionName => $variables) {if (!isset($this->settings[$sectionName])) {return 2; }foreach ($variables as $name) {if (!isset($this->settings[$sectionName][$name])) {return 3; }}}if (isset($this->settings['security']['allowed_remote_ips'])) {$this->settings['security'][I2342] =explode(',', $this->settings['security'][I2342]); }$this->cms =&$cms; $this->db =&$db; $this->IlIL11I =true; $this->_cookies =AMI::getSingleton('env/cookie')->getVarsCookie(); return 0; }function ProcessRequest() {if (!$this->IlIL11I) {return 1; }if (isset($this->settings['security'][I2343]) && !in_array($_SERVER['REMOTE_ADDR'], $this->settings['security'][I2342]) ){return 2; }$IlL1LlL =array ('rpc_master_password', I2344, 'rpc_action'); foreach ($IlL1LlL as $IlL1Ll1) {if (!isset($this->cms->VarsPost[$IlL1Ll1])) {return 3; }}if ($this->settings[I2345][I2343] != $this->cms->VarsPost['rpc_master_password']) {return 4; }$this->moduleName =$this->cms->VarsPost[I2344]; $this->IlL1LlI =isset($this->cms->VarsPost[I2346]) ?$this->cms->VarsPost[I2346] :''; $this->action =$this->cms->VarsPost['rpc_action']; $module_path =$GLOBALS['LOCAL_FILES_PATH'] .I2347; if (!is_dir($module_path)) {return 5; }$className ='RPC_' .$this->moduleName; $module_path .= '/'; if (!is_file($module_path .$className .'.php') || !$this->cms->Core->issetModOption('members', I2348) || !in_array($this->moduleName .$this->IlL1LlI, $this->cms->Core->TTlI1TI(I2349, I2348)) ){return 6; }require $module_path .$className .'.php'; $class =new $className(); $result =$class->ProcessRequest($this); if ($result == 0 && isset($this->cms->VarsPost['key_external'])) {switch ($class->externalKeyAction) {case 'insert': $aSql =array (I2350 => $this->moduleName .$this->IlL1LlI, 'key_internal' => $class->recordId, I2351 => $this->cms->VarsPost[I2351] );$sql =$this->db->GenInsertSQL('cms_external_integration', $aSql); $this->db->query($sql); break; case 'delete': $sql ="DELETE FROM `cms_external_integration` ". I2352 .$this->moduleName .$this->IlL1LlI ."' AND key_internal = '" .$class->recordId .I2353; $this->db->query($sql); break; }}return $result; }function checkParameters($requiredParameters, $allowedParameters) {if (!isset($requiredParameters[$this->action])) {return 7; }$this->parameters =array ();foreach ($allowedParameters[$this->action] as $IlL1Ll1) {if (isset($this->cms->VarsPost[$IlL1Ll1])) {$this->parameters[$IlL1Ll1] =$this->cms->VarsPost[$IlL1Ll1]; }}return 0; }function getInternalKeyByExternal($externalKey) {$sql ="SELECT `key_internal` " ."FROM `cms_external_integration` " .I2352 .addslashes($this->moduleName .$this->IlL1LlI) ."' AND `key_external` = '" .addslashes($externalKey) .I2353; $this->db->query($sql); return $this->db->next_record() ?addslashes($this->db->Record['key_internal']) :I2354; }function httpRequest($url, $postFields =null) {if (!function_exists('curl_init')) {trigger_error('No curl library', E_USER_ERROR); }$curl =curl_init($url); curl_setopt($curl, CURLOPT_FOLLOWLOCATION, false); curl_setopt($curl, CURLOPT_HEADER, true); curl_setopt($curl, CURLOPT_MUTE, true); curl_setopt($curl, CURLOPT_POST, is_array($postFields)); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); if (count($this->_cookies) >0) {$data =''; foreach ($this->_cookies as $name => $value) {$data .= $name .'=' .$value .I2355; }curl_setopt($curl, CURLOPT_COOKIE, mb_substr($data, 0, -1)); }if (is_array($postFields)) {$data =''; foreach ($postFields as $name => $value) {$data .= urlencode($name) .'=' .urlencode($value) .'&'; }curl_setopt($curl, CURLOPT_POSTFIELDS, mb_substr($data, 0, -1)); }curl_setopt($curl, CURLOPT_USERAGENT, @$_SERVER['HTTP_USER_AGENT']); $content =@curl_exec($curl); @curl_close($curl); $headers =mb_substr($content, 0, mb_strpos($content, I2356)); if (preg_match_all("/Set-Cookie: ([^=]+)=([^;]+)/s", $headers, $matches)) {$cookiesToDelete =array ();foreach ($matches[1] as $index => $cookieName) {if ($matches[2][$index] == 'deleted') {$cookiesToDelete[] =$cookieName; }else {SetLocalCookie($cookieName, $matches[2][$index], time() +$this->settings['settings']['cookie_ttl'], $this->settings[I2357]['cookie_path'], true); $this->_cookies[$cookieName] =$matches[2][$index]; }}$cookiesToDelete =array_unique($cookiesToDelete); foreach ($cookiesToDelete as $cookieName) {SetLocalCookie($cookieName, '', time() -3600 *24 *365 *2, $this->settings[I2357]['cookie_path'], true); unset($this->_cookies[$cookieName]); }}return $content; }}?>