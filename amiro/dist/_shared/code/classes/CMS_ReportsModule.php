<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       11088 xkqwxrmnnllrgtizquisluqlxwlgymgwkryrlnnrknpumrquxnkgrtwgymqwgnszytmkpnir
 */ ?><?php foreach(array(2358=>"'?zNs?IHSuJQ|nZIQ='",2359=>"tBGQ",2360=>"SZtQ",2361=>"S",2362=>"fJt|rQGHrtYB",2363=>"YB|CQQK",2364=>"BQZr",2365=>"SZtQfrHI",2366=>"{",2367=>",=",2368=>"OMSSQn",2369=>"'",2370=>"'?hRsqR?yb?JQvQJ",2371=>"",2372=>"DJZDOQD",2373=>"nH|rQGHrt|DQJQWtQS",2374=>"fJt|rQGHrt",2375=>"tQIGJZtQ",2376=>"SZBHfBQZr}",2377=>"CQQK}") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class CMS_ReportsModule extends CMS_Wrapper {public $IlL1LLI; public $IlL1LLl; public $IlL1LLL; public $IIILlLL; public $fieldsMap; function CMS_ReportsModule(&$cms, &$db, &$cModule) {$this->IlL1LLI =Array(); $this->IlL1LLl =Array(); $this->IlL1LLL =""; $this->IIILlLL =""; $this->fieldsMap =Array(); parent::CMS_Wrapper($cms, $db, $cModule); }function _InitAdmin() {parent::_InitAdmin(); $this->module->PushPager($this->browser); $this->module->InitPager($this->browser); $sql ="SELECT id, name, type FROM cms_reports WHERE lang='".$this->langData.I2358.$this->moduleName."' ORDER BY `name`"; $this->db->query($sql); while($this->db->next_record()){ $this->IlL1LLI[$this->db->Record["id"]] =$this->db->Record; }$this->module->PopPager($this->browser); }function TTTlIII() {parent::TTTlIII(); $IlL1LL1 =Array(); if($this->cms->Vars["flt_report"] >0) {$this->TTll11T($this->cms->Vars["flt_report"]); $sql ="SELECT field, type, value FROM cms_reports_filter WHERE id_report='".$this->cms->Vars["flt_report"]."'"; $this->db->query($sql); while($this->db->next_record()){ $IlL1LL1[$this->db->Record["field"]] =$this->db->Record; }$this->cms->Gui->AddGlobalVars(Array("REPORT_TYPE" => $this->IlL1LLl[I2359])); if($this->cms->Vars["flt_report"] != $this->cms->Vars["flt_report_selected"]) {foreach($IlL1LL1 as $field => $IlL1L1I) {$value =false; switch($IlL1L1I[I2359]) {case "select": $value =$IlL1L1I["value"]; break; case I2360: $udate =strtotime("-".$IlL1L1I["value"]." day"); $value =mktime(0, 0, 0, date("m", $udate) ,date(I2361, $udate), date("Y", $udate)); break; }if($value !== false) {$this->filter->UpdateField($field, $value); $this->filter->TITI1lT($field); }}}if($this->IlL1LLl[I2359] == "stats") {$this->IlL1LLL =(empty($this->cms->Vars["flt_reportby"])) ?"month": $this->cms->Vars[I2362]; $IlL1L1l =Array(); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["by_hour"]=>"hour"), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["by_day"]=>"day"), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words[I2363]=>"week"), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["by_month"]=>"month"), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["by_year"]=>I2364), 55); $this->filter->AddField(I2362, "select", $this->IlL1LLL, "", "=", "id", $IlL1L1l); $this->filter->MoveField(I2362, _MOVE_START); $this->filter->DisableFieldSQL(I2362); $IlL1LL1[I2362] =Array(); $this->IIILlLL =$this->filter->TITI11I(I2365); if(empty($this->IIILlLL)) {trigger_error("Cannot find date field", E_USER_ERROR); }}}$this->filter->TITI11T(array_keys($IlL1LL1)); $IlL1LLI =Array(); $IlL1LLI =$this->filter->TITI1TT($IlL1LLI, Array($this->words["no"]=>0), 55); foreach($this->IlL1LLI as $id => $aReport) {$IlL1LLI =$this->filter->TITI1TT($IlL1LLI, array($aReport["name"]." (".$this->words[$aReport[I2359]].I2366 => $id), 500); }$this->filter->AddField("flt_report", "select", $this->cms->Vars["flt_report"], "", I2367, "id", $IlL1LLI); $this->filter->DisableFieldSQL("flt_report"); $this->filter->MoveField("flt_report",_MOVE_START); $this->filter->AddField("flt_report_selected", I2368, $this->cms->Vars["flt_report"]); $this->filter->DisableFieldSQL("flt_report_selected"); }function TTll11T($cId) {if(empty($this->IlL1LLl)) {$sql ="SELECT name, type, template FROM cms_reports WHERE id='".$cId."' AND lang='".$this->langData.I2358.$this->moduleName.I2369; $this->db->query($sql); if($this->db->next_record()) {$this->IlL1LLl =$this->db->Record; }}}function TTTlI11(&$vData, &$aCustom) {if($this->cms->Vars["flt_report"] >0) {$aGroups =Array(); $sql ="SELECT level, field, sort_order FROM cms_reports_grouping ". "WHERE id_report='".$this->cms->Vars["flt_report"].I2370; $this->db->query($sql); while($this->db->next_record()){ $aGroups[$this->db->Record["field"]] =$this->db->Record; }$IlL1L1L =Array(); $sql ="SELECT field, method, grouping_field FROM cms_reports_calc WHERE id_report='".$this->cms->Vars["flt_report"].I2369; $this->db->query($sql); while($this->db->next_record()){ $IlL1L1L[] =$this->db->Record; }$IlL1L11 =Array( "decimal_digits" => $this->module->GetOption("number_decimal_digits"), "decimal" => $this->module->GetOption("decimal_point"), "thousand" => $this->module->GetOption("thousands_separator") );$IlL11II =I2371; if($this->IlL1LLl[I2359] == "stats") {$IlL11Il =$this->TTll111(); $aGroups =$IlL11Il +$aGroups; $IlL11II =implode(",", array_keys($IlL11Il)); }if(!empty($this->fieldsMap)) {$aTmp =Array(); foreach($aGroups as $group => $value) {$aTmp[(empty($this->fieldsMap[$group])? $group: $this->fieldsMap[$group])] =$value; }$aGroups =$aTmp; }$this->browser->TI1TITT($IlL1L1L, $aGroups, $IlL11II); if($this->action == "print") {$this->browser->PageSize =100000; $aCustom["list_data"] += removeSpecial($this->cms->Vars, I2372); $aCustom["list_data"]["metas"] =$this->cms->Gui->getMetas(); }parent::TTTlI11($vData, $aCustom); $this->browser->TI1TITI(); }else {$vData["list_table"] =$this->cms->Gui->getAbs($this->moduleName."_list:".(!empty($this->IlL1LLI)? I2373: "no_reports_found")); }}function TTTllTT(&$vData) {if($this->action == "print") {echo $vData["list_table"]; $GLOBALS["conn"]->Out(); die(); }}function TTll11I($cId) {$this->TTll11T($this->cms->Vars[I2374]); if(empty($this->IlL1LLl)) {trigger_error("No data found for report ".$this->cms->Vars[I2374], E_USER_ERROR); }$this->cms->Gui->addBlock($this->moduleName.'_list', $GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/reports/".$this->IlL1LLl[I2375]); }function TTll11l($IlL11IL, $IlL11I1 ="asc") {return Array($IlL11IL => Array("sort_order" => $IlL11I1)); }function TTll111() {$IlL11Il =$this->TTll11l("year(".$this->IIILlLL.I2366); if($this->IlL1LLL != I2364) {switch($this->IlL1LLL) {case "hour": $IlL11Il += $this->TTll11l(I2376.$this->IIILlLL.I2366); $IlL11Il += $this->TTll11l("hour(".$this->IIILlLL.I2366); break; case "month": $IlL11Il += $this->TTll11l("month(".$this->IIILlLL.I2366); break; case "week": $IlL11Il += $this->TTll11l(I2377.$this->IIILlLL.",0)"); break; case "day": $IlL11Il += $this->TTll11l(I2376.$this->IIILlLL.I2366); break; }}return $IlL11Il; }}?>