<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       19514 xkqwpputszqsslnzqygzwztizztipzsmynzqtwgtymglirskllswrqxpxgpzliiqtlklpnir
 */ ?><?php foreach(array(2378=>'IZx',2379=>"",2380=>"SZtQfrHI",2381=>"?JMKQ?",2382=>"DQJQWt",2383=>"fJt|tBGQ",2384=>"zNs?IHSuJQ|nZIQ?=?'",2385=>"ZGGJB",2386=>"tBGQ",2387=>"DQJQWtQS",2388=>"DQJQWt|nZIQ",2389=>"MD|uDQS",2390=>"PrHuG|fMQJSD",2391=>"MS",2392=>"WZJW|fMQJS|",2393=>"WZJW",2394=>"WuDtHI|1",2395=>"ZiQtOHSD",2396=>"fMJtQr|fMQJSD|SQf",2397=>"vZJuQ",2398=>"fMQJS",2399=>"ZrrZB|nZIQ",2400=>"nZIQ",2401=>"r",2402=>"rP_r",2403=>"r`MS",2404=>"fMQJSD",2405=>"PQt|CHrS",2406=>"ZWtMHn",2407=>"fJZPMWHn",2408=>"ZWtMHn|WHGB",2409=>"ZWtMHn|SQJ",2410=>"rQGHrtD|JMnK",2411=>"JQP|YJuQ",2412=>"ZSS",2413=>'QrrnH',2414=>"PrHuGD",2415=>"tQIGJZtQ",2416=>"IHSuJQ|nZIQ",2417=>"'",2418=>"SQDW") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class CMS_ReportsWizardModule extends CMS_ActModule {public $IlL11lI; public $IlL11ll; public $type; public $groups; public $IlL11lL; public $IlL11l1; public $IIlLLII; function CMS_ReportsWizardModule(&$cms, &$db, &$cModule) {$this->IlL11lI =""; $this->IlL11l1 =Array('sum', I2378, 'min', 'avg'); $this->groups =Array(); $this->IlL11lL =Array(); $this->IIlLLII =Array(); $this->IlL11ll =Array("details"); $this->type =$this->IlL11ll[0]; parent::CMS_ActModule($cms, $db, $cModule); }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll =I2379, $aOptions =Array()) {$IIIIL11 =Array(); $IIIIL11["default_prefix"] ="r"; $IIIIL11["group_operations"][] ="del"; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function TTTlIII() {parent::TTTlIII(); $this->filter->TITI1l1(I2380); $this->filter->TITI1l1("dateto"); $this->filter->AddField("flt_name", "text", stripslashes(unhtmlentities($this->cms->Vars["flt_header"])), I2379, I2381, "name"); $this->filter->MoveField("flt_name",_MOVE_PREV); $aPages =Array(); foreach($this->IlL11ll as $type) {$aPages =$this->filter->TITI1TT($aPages, Array($this->words[$type]=>$type), 35, false); }$aPages =$this->filter->TITI1TT($aPages, Array($this->words["all"]=>I2379), 35, false); $this->filter->AddField("flt_type", I2382, $this->cms->Vars["flt_type"], I2379, "=", "r.type", $aPages); if($this->cms->Vars["flt_type"] == I2379) {$this->filter->DisableFieldSQL(I2383); }}function _ApplyFilters($prefix ='', $bodyType ='', $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); $res .= I2384.$this->IlL11lI."'"; return $res; }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); }function TTTlITT($IIIL11l, $cId, $cModule =I2379) {if($IIIL11l == "add" || $IIIL11l == I2385) {$this->TTl1TTT($this->cms->Vars["type"]); }parent::TTTlITT($IIIL11l, $cId, $cModule); }function TTTlI11(&$vData, &$aCustom) {require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_file_system.php"); if($this->TTl1TTI($this->cms->Vars["type"])) {$this->type =$this->cms->Vars[I2386]; }elseif(!empty($this->itemData[I2386])) {$this->type =$this->itemData[I2386]; }elseif($this->cms->Vars[I2383] != I2379) {$this->type =$this->cms->Vars[I2383]; }$vData[I2386] =$this->type; $vData["type_rows"] =I2379; foreach($this->IlL11ll as $type) {$aType =Array( "name" => $this->words[$type], "value" => $type, "selected" => ($this->type == $type)? I2387: I2379, );$vData["type_rows"] .= $this->cms->Gui->get($this->moduleName."_subform:type_row", $aType); }$vData["type_descr"] =$this->words[$this->type."_descr"]; $this->TTl1TTT($this->type); if(is_array($this->groups)) {foreach($this->groups as $group) {$IlL11LI =Array( I2388 => "group_fields_def", "id" => $group, "name" => $this->words["group_".$group], I2389 => 0, "is_unique" => 1, "custom_1" => $this->itemData["groups"][$group]["sort_order"] );$vData[I2390] .= $this->cms->Gui->get($this->moduleName."_subform:select_field", $IlL11LI); }if(is_array($this->itemData["groups"])) {foreach($this->itemData["groups"] as $group => $IlL11Ll) {$IlL11LI =Array( "ctrl_name" => I2390, I2391 => $group, );$vData["group_insert_fields"] .= $this->cms->Gui->get($this->moduleName."_subform:insert_field_row", $IlL11LI); }}}if(is_array($this->IlL11lL)) {foreach($this->IlL11lL as $IlL11LL) {$IlL11LI =Array( I2388 => "calc_fields_def", I2391 => $IlL11LL, "name" => $this->words[I2392.$IlL11LL], I2389 => 0, "is_unique" => 0 );$vData["calc_fields"] .= $this->cms->Gui->get($this->moduleName."_subform:select_field", $IlL11LI); }if(is_array($this->itemData["calc"])) {ksort($this->itemData[I2393]); foreach($this->itemData[I2393] as $IlL11LL => $IlL11L1) {foreach($IlL11L1 as $field => $aFields) {foreach($aFields as $method => $val) {$IlL111I =Array( "ctrl_name" => "calc_fields", I2391 => $field, I2388 => "calc_fields_def", "index" => array_search($field, $this->IlL11lL, true), I2394 => $method, "custom_2" => $IlL11LL, );$vData["calc_insert_fields"] .= $this->cms->Gui->get($this->moduleName."_subform:insert_field_row", $IlL111I); }}}}foreach($this->IlL11l1 as $method) {$aMethod =Array( "array_name"=>I2395, "key"=>$method, "value"=>$this->words[$method] );$vData["calc_methods"] .= $this->cms->Gui->get($this->moduleName."_subform:array_row", $aMethod); }}if(is_array($this->IIlLLII)) {foreach($this->IIlLLII as $filterField => $IlL111l) {$aFilter =Array( I2388 => I2396, I2391 => $filterField, "name" => $this->words["filter_field_".$filterField], I2389 => 0, "is_unique" => 1, I2394 => $IlL111l[I2386], "custom_3" => I2379, );switch($IlL111l[I2386]) {case I2382: foreach($IlL111l[I2397] as $val) {$aFilter["custom_3"] .= $val."=".$this->words[$val]."|"; }break; }$vData["filter_fields"] .= $this->cms->Gui->get($this->moduleName."_subform:select_field", $aFilter); }if(is_array($this->itemData["filter"])) {$IlL111L =array_keys($this->IIlLLII); foreach($this->itemData["filter"] as $filterField => $IlL1111) {$aFilterField =Array( "ctrl_name" => "filter_fields", I2391 => $IlL1111[I2398], I2388 => I2396, "index" => array_search($filterField, $IlL111L, true), "custom_2" => $IlL1111[I2397], );$vData["filter_insert_fields"] .= $this->cms->Gui->get($this->moduleName."_subform:insert_field_row", $aFilterField); }}}$list =$this->cms->Gui->getTemplatesList($this->db, $GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/reports/", $this->IlL11lI."_".$this->type."*.tpl"); $vData[$this->type."_tpls"] =I2379; foreach($list as $fileData) {$aFileData =Array( I2399 => $this->type."_tpls", "key" => $fileData["name"], I2397 => empty($this->words[$fileData["name"]])? $fileData[I2400]: $this->words[$fileData[I2400]], );$vData[$this->type."_tpls"] .= $this->cms->Gui->get($this->moduleName."_subform:array_row", $aFileData); }$this->browser->InitSQL("r.id, r.name, r.template, r.type ", Array("tables" => Array(I2401 => "cms_reports", "rg" => "cms_reports_grouping"), "joins" => Array(I2402=>"r.id=rg.id_report"), "joins_types" => Array(I2402=>"LEFT OUTER"), ),"WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), I2403, I2400, "id desc" );$this->browser->AddSQLJoinedTables($this->cms->Core, 'r', Array("cms_reports_grouping" => "rg")); $aCustom[I2404] += Array( I2400=>Array("action"=>"stripline", "size"=>200), I2386=>Array("action"=>I2405, 'words'=>&$this->words, "default_word"=>"unknown"), "template"=>Array(I2406=>I2405, 'words'=>&$this->words, "default_word"=>"unknown"), "action_edit"=>Array(I2406=>I2407, I2397=>I2379, I2391=>"edit_id", "on"=>$this->moduleName."_list:edit","off"=>I2379), I2408=>Array(I2406=>I2407, I2397=>I2379, I2391=>"copy_id", "on"=>$this->moduleName."_list:copy","off"=>I2379), I2409=>Array(I2406=>I2407, I2397=>I2379, I2391=>"del_id", "on"=>$this->moduleName."_list:del","off"=>I2379), );$vMod =&$this->module->TTlIIIT(); if(is_object($vMod)) {$this->cms->Gui->addGlobalVars(Array(I2410 => $vMod->GetAdminLink())); }$aCustom["applied_id"] =I2403; $aCustom["legend"] =Array("leg_red", "leg_yellow", I2411, "leg_edit", "leg_del"); $aCustom["form_data"]["buttons"] =Array(I2412, I2385, "cancel", "save"); parent::TTTlI11($vData, $aCustom); }function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno'])) {$this->TTl1TTl(); }}function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno'])) {$this->TTl1TTl(true); }}function _ActionDel($cId, $cModule) {parent::_ActionDel($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL[I2413])) {$sql ="DELETE FROM cms_reports_grouping WHERE id_report='".$cId."'"; $this->db->query($sql); $sql ="DELETE FROM cms_reports_calc WHERE id_report='".$cId."'"; $this->db->query($sql); }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT r.* FROM cms_reports r WHERE r.id='".$cId."'".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $sql ="SELECT field, sort_order FROM cms_reports_grouping WHERE id_report='".$cId."' order by level asc"; $this->db->query($sql); $this->itemData["groups"] =Array(); while($this->db->next_record()) {$this->itemData[I2414][$this->db->Record[I2398]] =$this->db->Record; }$sql ="SELECT field, method, grouping_field FROM cms_reports_calc WHERE id_report='".$cId."' order by id asc"; $this->db->query($sql); $this->itemData[I2393] =Array(); while($this->db->next_record()) {$this->itemData[I2393][$this->db->Record["grouping_field"]][$this->db->Record[I2398]][$this->db->Record["method"]] =true; }$sql ="SELECT field, value FROM cms_reports_filter WHERE id_report='".$cId."' order by id asc"; $this->db->query($sql); $this->itemData["filter"] =Array(); while($this->db->next_record()) {$this->itemData["filter"][$this->db->Record[I2398]] =$this->db->Record; }}}function TTT1IlI($aSql =Array(), $cId =0) {$name =$this->cms->VarsPost[I2400]; $template =$this->cms->VarsPost["template"]; if($name != I2379 && $template != I2379) {$aSql =Array( I2400 => $name, I2415 => $template, I2416 => $this->IlL11lI, I2386 => $this->cms->VarsPost[I2386] );}$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TTl1TTT($cType ='') {$this->groups =Array(); $this->IlL11lL =Array(); $this->IIlLLII =Array(); $this->IIlLLII =Array(); }function TTl1TTI($cType) {return in_array($cType, $this->IlL11ll); }function TTl1TTl($Il1IIII =false) {if($Il1IIII) {$sql ="DELETE FROM cms_reports_grouping WHERE id_report='".$this->appliedId."'"; $this->db->query($sql); $sql ="DELETE FROM cms_reports_calc WHERE id_report='".$this->appliedId.I2417; $this->db->query($sql); $sql ="DELETE FROM cms_reports_filter WHERE id_report='".$this->appliedId.I2417; $this->db->query($sql); }$Il1IIIl =array_intersect((array)$this->cms->VarsPost["arr_group_fields"], $this->groups); $level =1; $aGroups =Array(I2379 => true); foreach($Il1IIIl as $key => $field) {$Il1IIIL =$this->cms->VarsPost["sort_order_".$field]; if(in_array($Il1IIIL, Array("asc", I2418))) {$sql ="INSERT INTO cms_reports_grouping (id_report, level, field, sort_order) ". "VALUES ('".$this->appliedId."', $level, '$field', '$Il1IIIL')"; $this->db->query($sql); $aGroups[$field] =true; $level++; }}foreach($this->cms->VarsPost as $name => $val) {if(mb_substr($name, 0, 11) == "calc_level_" && (in_array($val, array_keys($aGroups)))) {$method =$this->cms->VarsPost["calc_method_".mb_substr($name, 11)]; $field =$this->cms->VarsPost[I2392.mb_substr($name, 11)]; if(in_array($method, $this->IlL11l1) && in_array($field, $this->IlL11lL)) {$sql ="INSERT INTO cms_reports_calc (id_report, field, method, grouping_field) ". "VALUES ('".$this->appliedId."', '$field', '$method', '$val')"; $this->db->query($sql); }}}$Il1III1 =array_intersect((array)$this->cms->VarsPost["arr_filter_fields"], array_keys($this->IIlLLII)); foreach($Il1III1 as $key => $field) {$Il1IIlI =$this->cms->VarsPost["filter_value_".$field]; switch($this->IIlLLII[$field][I2386]) {case I2382: $Il1IIll =in_array($Il1IIlI, $this->IIlLLII[$field][I2397]); break; case "date": $Il1IIlI =abs(intval($Il1IIlI)); $Il1IIll =true; break; default: $Il1IIll =false; }if($Il1IIll) {$sql ="INSERT INTO cms_reports_filter (id_report, field, type, value) ". "VALUES ('".$this->appliedId."', '$field', '".$this->IIlLLII[$field][I2386]."', '$Il1IIlI')"; $this->db->query($sql); }}}}