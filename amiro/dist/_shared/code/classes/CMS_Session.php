<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       28421 xkqwkrpmgqnqqriwkyssspkgytlntkwikwnwipnzxmgkltwktsmmtxmxguqyktpskstgpnir
 */ ?><?php foreach(array(2419=>'DQDDMHn',2420=>'',2421=>"WHHKMQ",2422=>"",2423=>'DBD',2424=>"'?",2425=>"MS|IQIYQr",2426=>"_",2427=>"!'",2428=>"'!?",2429=>"{",2430=>'OZDO',2431=>"'",2432=>"SZtQ=nHC}{!?",2433=>'jZDt+iHSMfMQS%?',2434=>"dqRVqR|gRhThwhj",2435=>'IZrKgZPQmDdKMGGQS',2436=>"'!?DGQW|fJZPD='",2437=>"?coqRq?MS='",2438=>'QDOHG~WZrt') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class CMS_Session {public $lang; public $Il1IIlL; public $Il1IIl1; public $sid; public $CookieName; public $Il1IILI; public $expTime; public $expirationTime; public $Il1IILl; public $Il1IILL; public $Il1IIL1; public $Il1II1I; public $Il1II1l; public $Il1II1L; public $memberId; public $cms; public $_isSessionStarted; public $Il1II11; public $Il1IlII; public $Il1IlIl; public $Il1IlIL; public $Il1IlI1; public $Il1IllI; public $Il1Illl; public $Il1IllL; private $Il1Ill1 =''; protected $Il1IlLI =null; function CMS_Session(&$cms, $lang ="en", $Il1IlLl =I2419) {$this->lang ="_".$lang; $this->Il1Ill1 =parse_url($GLOBALS['ROOT_PATH_WWW'], PHP_URL_PATH); if('/' == $this->Il1Ill1){ $this->Il1Ill1 =''; }if($lang != I2420){ $this->Il1Ill1 =rtrim($this->Il1Ill1, '/') .'/' .$lang .'/'; }$this->Il1IIlL =Array(); $this->Il1IIl1 =Array(); $this->Il1II1L =0; $this->memberId =0; $this->_isSessionStarted =false; $this->Il1II11 =false; $this->Il1IlII =false; $this->Il1IlIl =false; $this->Il1II1I =0; $this->Il1IlIL =false; $this->Il1IlI1 =true; $this->Il1IllI =is_object($cms); $this->Il1IlLI ='1 MONTH'; if($this->Il1IllI) {$Il1IlLL =&$cms->Core->GetModule($Il1IlLl); $this->CookieName =$Il1IlLL->GetOption(I2421).$this->lang; $this->Il1IILI =$Il1IlLL->GetOption("force_store"); $this->expirationTime =(int)$Il1IlLL->GetOption("timeout"); $this->Il1IILL =(int)$Il1IlLL->GetOption("short_timeout"); $this->Il1II1l =$Il1IlLL->GetOption("table_locks"); $this->sid =isset($cms->VarsCookie[$this->CookieName]) ?$cms->VarsCookie[$this->CookieName] :I2422; $this->cms =&$cms; if($cms->Core->IsInstalled('eshop_cart')){ $this->Il1IlLI =$cms->Core->GetModOption('eshop_cart', 'store_cart_after_logout'); }}else {$this->CookieName ="session".$this->lang; $this->Il1IILI =true; $this->expirationTime =120; $this->Il1IILL =20; $this->Il1II1l =20; $this->sid =isset($_COOKIE[$this->CookieName]) ?$_COOKIE[$this->CookieName] :I2420; $this->cms =null; }$this->TTl1T11(); $this->Il1IILl =$this->expirationTime; $this->Il1IIL1 =$this->Il1IILL; if($GLOBALS[I2423]['session_no_ip_bind']){ $this->Il1IlI1 =false; }$this->TTl1Tl1(false); $this->Il1IllL ="user_session"; $this->Il1Illl =Array(); }function Start($expirationTime =0, $Il1IlL1 =false) {global $lang_data; $expirationTime =(int)$expirationTime; if($expirationTime <= 0) {$expirationTime =$this->expirationTime; }if(!$this->_isSessionStarted && (!$this->Il1II11 || $Il1IlL1)) {$this->Il1II11 =true; $this->expTime =$expirationTime; $db =new DB_si; $ip =$_SERVER['REMOTE_ADDR']; if(empty($this->sid) && $Il1IlL1){ srand(); mt_srand(); $this->sid =mt_rand(1000,9999) .mt_rand(1000,9999) .mt_rand(1000,9999) .mt_rand(1000,9999) .mt_rand(1000,9999) .mt_rand(1000,9999) .doubleval(microtime() *10000000); $Il1Il1I =true; }else{ $Il1Il1I =$Il1IlL1; if(!empty($this->sid)) {$Il1Il1I =false; $sql ="SELECT data, spec_flags, id_member, (short_expired < NOW()) as is_short_expired, long_session, timeouts FROM cms_sessions WHERE id='".$this->sid.I2424.($this->Il1IlI1 ?(" AND ip='" .$ip ."'") :I2422); $db->query($sql); if ($db->next_record()) {$this->Il1IIlL =unserialize($db->Record["data"]); $this->Il1II1L =$db->Record["spec_flags"]; $this->memberId =$db->Record[I2425]; $Il1Il1l =$db->Record["timeouts"]; $this->Il1IlIL =(!$db->Record["is_short_expired"]); $this->TTl1Tl1($db->Record["long_session"]); if($this->Il1IllI){ $sql .= ", timeouts='".$this->Il1IILL.I2426.$expirationTime."'"; }else {if($Il1Il1l != I2422){ $Il1Il1L =explode(I2426, $Il1Il1l); if($Il1Il1L[0] >0){ $this->Il1IILL =(int)$Il1Il1L[0]; }if($Il1Il1L[1] >0){ $expirationTime =$this->expirationTime =(int)$Il1Il1L[1]; }}}$sql ="UPDATE cms_sessions SET long_session=".$this->Il1II1I.", expired=DATE_ADD(NOW(), INTERVAL ".$expirationTime." MINUTE) "; if($this->Il1IlIL && $this->memberId >0){ $sql .= ", short_expired=DATE_ADD(NOW(), INTERVAL ".$this->Il1IILL." MINUTE)"; }$sql .= " WHERE id='".$this->sid."'"; $db->query($sql); $this->_isSessionStarted =true; }else {$this->TTl1TIT(); }}}if($Il1Il1I) {$Il1Il11 =$this->Il1IllI ?array(", timeouts", I2427.$this->Il1IILL.I2426.$expirationTime."'") :array(I2420, I2420); $sql ="INSERT INTO cms_sessions (id, long_session, expired, ip, data, spec_flags, id_member".$Il1Il11[0].") ". "VALUES ('".$this->sid.I2428.$this->Il1II1I.", DATE_ADD(NOW(), INTERVAL ".$expirationTime." MINUTE), '$ip', '".serialize(Array())."', '".$this->Il1II1L."', '".$this->memberId."'".$Il1Il11[1].I2429; $db->query($sql); $this->_isSessionStarted =true; }if(!empty($this->sid) && $Il1Il1I) {$sql ="DELETE FROM cms_sessions WHERE expired < now() AND cart_expired < now()"; $db->execute($sql); }}if(!empty($this->sid)) {if($this->IssetVar("_js_session_cookies")){ $this->Il1Illl =$this->GetVar("_js_session_cookies"); }SetLocalCookie($this->CookieName, $this->sid, $this->TTl1TT1()); if(!$this->IssetVar('hash')){ $Il1ILII =$this->TTl1TI1(FALSE); $this->SetVar(I2430, mt_rand(100000, 999999)); $this->TTl1TI1($Il1ILII); }}return true; }function IsSessionStarted() {return $this->_isSessionStarted; }function Stop() {$db =new DB_si; $Il1ILIl =false; if($this->cms->Core->IsInstalled('eshop_cart')){ $oEshopCart =AMI::getSingleton('eshop/cart'); if(!$oEshopCart->isEmpty() && !empty($this->Il1IlLI)){ $Il1ILIl =true; }}if($Il1ILIl){ $sql ="UPDATE cms_sessions SET expired = DATE_ADD(NOW(), INTERVAL -1 MINUTE), cart_expired = DATE_ADD(NOW(), INTERVAL " .$this->Il1IlLI .") WHERE id='".$this->sid.I2431; }else{ $sql ="DELETE FROM cms_sessions WHERE id='".$this->sid.I2431; }$db->query($sql); $this->TTl1TIT(); $this->_isSessionStarted =false; $this->Il1II11 =false; $this->TTl1TIl(); }function TTl1TT1($Il1ILIL =false) {if($Il1ILIL){ $expTime =time() +24 *30 *60 *60; }else{ $expTime =time() +$this->expirationTime *60; }return $expTime; }function TTl1TIT() {$this->sid =I2422; SetLocalCookie($this->CookieName, I2420, time()-1); }function TTl1TII($login, $ip, $function, $ring, $details) {$db =new DB_si; $sql ="SELECT id FROM cms_members WHERE username like '" .addslashes($login) .I2431; $db->query($sql); $db->next_record(); $id_member =intval($db->Record["id"]); if($id_member <= 0) $id_member =0; $Il1ILI1= "INSERT cms_session_msgs SET ". "ip='$ip', ". "id_member=$id_member, ". I2432. "ring=$ring, ". "function='$function', ". "details='".addslashes($details).I2431; $db->query($Il1ILI1); }function Location($url, $httpStatus ="200 OK", $Il1ILlI =false) {if(empty($url)) {trigger_error("Session::Location: empty url", _ERROR_WARN); }ob_clean(); if($Il1ILlI){ header('Expires: Mon, 26 Jul 1997 05:00:00 GMT'); header(I2433 .gmdate('D, d M Y H:i:s') .' GMT'); header('Cache-Control: post-check=0, pre-check=0', false); header('Pragma: no-cache'); }header($GLOBALS[I2434]." ".$httpStatus); if($httpStatus == "200 OK"){ header("Location: $url", true, 301); }else{ header("Location: $url"); }?>
<html><head><title></title></head>
<body>
<!--
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
-->
</body>
</html>
        <?php  if(is_object($GLOBALS['oCache']) && is_callable(array($GLOBALS['oCache'], I2435))){ $GLOBALS["oCache"]->markPageIsSkipped(); }die; }function SetVar($name, $value) {$this->Il1IlII =true; $this->Il1IIl1[$name.$this->lang] =(is_object($value))? clone($value): $value; if($this->Il1IILI) {$this->Store(); }}function GetVar($name){ if(!isset($this->Il1IIl1[$name.$this->lang])){ if(isset($this->Il1IIlL[$name.$this->lang])){ $this->Il1IIl1[$name.$this->lang] =unserialize($this->Il1IIlL[$name.$this->lang]); }}if(isset($this->Il1IIl1[$name .$this->lang])){ return is_object($this->Il1IIl1[$name .$this->lang]) ?clone($this->Il1IIl1[$name .$this->lang]) :$this->Il1IIl1[$name .$this->lang]; }else{ return NULL; }}function IssetVar($name) {return !(empty($this->Il1IIlL[$name.$this->lang]) && empty($this->Il1IIl1[$name.$this->lang])); }function UnsetVar($name) {$this->Il1IlII =true; unset($this->Il1IIlL[$name.$this->lang]); unset($this->Il1IIl1[$name.$this->lang]); if($this->Il1IILI) {$this->Store(); }}function addJsSessionCookie($name, $value){ $this->Il1Illl[$name] =$value; $this->SetVar("_js_session_cookies", $this->Il1Illl); }function storeJsSessionCookies() {if(sizeof($this->Il1Illl) >0){ $this->_aJsSessionCookiesStr =TlT1lTI($this->Il1Illl); SetLocalCookie($this->Il1IllL, $this->_aJsSessionCookiesStr, $this->TTl1TT1(true), $this->Il1Ill1, false, false, true); }}function TTl1TIl() {SetLocalCookie($this->Il1IllL, I2420, time() -60 *60 *24 *365, $this->Il1Ill1); }function Store() {$this->_isIgnoreCallStore =true; $this->storeJsSessionCookies(); if($this->Il1IlII) {if(!$this->_isSessionStarted) {$this->Start($this->expTime, true); }foreach($this->Il1IIl1 as $name => $value) {$this->Il1IIlL[$name] =serialize($value); }$db =new DB_si; $sql ="UPDATE cms_sessions SET long_session=".$this->Il1II1I.", data='".addslashes(serialize($this->Il1IIlL)).I2436.$this->Il1II1L."', id_member='".$this->memberId.I2431; if($this->Il1IllI){ $sql .= ", timeouts='".$this->Il1IILL.I2426.$this->expirationTime.I2431; if($this->cms->Core->Side == 'front'){ if($this->IssetVar('cart') && !empty($this->Il1IlLI)){ $sql .= ", cart_expired = DATE_ADD(NOW(), INTERVAL " .$this->Il1IlLI .I2429; }else {$sql .= ", cart_expired = DATE_ADD(NOW(), INTERVAL -1 MINUTE)"; }}}if($this->Il1IlIl){ if($this->Il1IlIL){ $sql .= ", short_expired=DATE_ADD(NOW(), INTERVAL ".$this->Il1IILL." MINUTE)"; }else{ $sql .= ", short_expired=DATE_ADD(NOW(), INTERVAL -1 MINUTE)"; }}$sql .= I2437.$this->sid.I2431; $db->execute($sql,DBC_SYS_QUERY); $this->Il1IlII =false; if($this->memberId && $this->Il1IllI && ($this->cms->Core->Side == 'front') && $this->cms->Core->IsInstalled('eshop_cart')){ $Il1ILll ='cart' .$this->lang; $sql ="SELECT id, data FROM cms_sessions WHERE id_member = '".$this->memberId."' AND expired < NOW() AND cart_expired >= NOW()"; $db->query($sql); if($db->next_record()){ $sessionId =$db->Record['id']; $sessionData =unserialize($db->Record['data']); $sessionCart =null; $sql ="DELETE FROM cms_sessions WHERE id_member = '".$this->memberId."' AND expired < NOW()"; $db->query($sql); if(!empty($sessionData[$Il1ILll])){ $sessionCart =unserialize($sessionData[$Il1ILll]); if(!empty($sessionCart)){ $oEshopCart =AMI::getSingleton(I2438); $res =$oEshopCart->joinCarts($sessionCart); }unset($sessionCart); }}}}}function TTl1TI1($force =false) {$res =$this->Il1IILI; $this->Il1IILI =$force; return $res; }function TTl1TlT($Il1ILlL){ return (($this->Il1II1L &$Il1ILlL) == $Il1ILlL); }function TTl1TlI($Il1ILlL, $Il1ILl1 =false, $Il1ILLI =0){ $this->Il1II1L &= $Il1ILlL; if($Il1ILl1){ $db =new DB_si; $sql ="UPDATE cms_sessions SET spec_flags='".$this->Il1II1L.I2431. "WHERE id='".($Il1ILLI >0 ?intval($Il1ILLI) :$this->sid).I2431; $db->query($sql,DBC_SYS_QUERY); }else {$this->Il1IlII =true; }}function TTl1Tll($memberId){ $memberId =intval($memberId); $this->Il1IlII =($this->memberId != $memberId); $this->memberId =$memberId; if($memberId == 0){ $this->TTl1T1I(); }}function TTl1Tl1($isLongSession){ $this->Il1II1I =intval($isLongSession); if($isLongSession){ $this->expirationTime =$this->Il1IILl *2; $this->Il1IILL =$this->Il1IIL1 *2; }else{ $this->expirationTime =$this->Il1IILl; $this->Il1IILL =$this->Il1IIL1; }}function TTl1T1T(){ $this->Il1IlII =true; $this->Il1IlIl =true; $this->Il1IlIL =true; }function TTl1T1I(){ $this->Il1IlII =true; $this->Il1IlIl =true; $this->Il1IlIL =false; }function TTl1T1l(){ return $this->Il1IlIL; }private function TTl1T11(){ if($this->sid !== I2420 && !preg_match('/^[0-9a-z]+$/', $this->sid)){ $this->TTl1TIT(); }}}