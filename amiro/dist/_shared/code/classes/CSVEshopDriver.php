<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       50922 xkqwqrnykptwtlinlxrznpkqpqgnpklqmwzquxytuxmtmnirsspxwskiwzsktrgkngxzpnir
 */ ?><?php foreach(array(2565=>"",2566=>"DuGGHrtQS|ZWtMHnD",2567=>"fMJQIZDK",2568=>"MIGHrt|IHSuJQD",2569=>"MnWJuSQS|MIGHrt|IHSuJQD",2570=>"%",2571=>"IHSuJQ",2572=>"MIGHrt",2573=>"r",2574=>"fMQJSD",2575=>"wzTqphRb",2576=>"vZJuQ",2577=>"WZtmSFMQJS",2578=>'wzTzjhp',2579=>"mizpq",2580=>'',2581=>'DKMG|fMrDt|JMnQ',2582=>"SZtZ|nHt|fHunS",2583=>"QDOHG|HrSQr",2584=>"SZtZ|DHurWQ",2585=>"CrHnP|MIGHrt|IHSQ",2586=>"QxGHrt|IHSuJQ",2587=>"nZIQ",2588=>'WuDtHI|fMQJSD|ZJJ',2589=>'MS|QxtQrnZJ',2590=>'fZJDQ',2591=>'ZnnHunWQ',2592=>"QDOHG|WZt",2593=>"WZt|MS|QxtQrnZJ",2594=>"GrHWQDD|WZtQPHrMQD",2595=>"WZJJYZWK|QrrHr",2596=>"wzTzjhp",2597=>"GrHWQDD|MtQID",2598=>"10012",2599=>"ms|qXTqRNzj",2600=>"GrHWQDD|rQfQrQnWQD",2601=>"RqFqRqNwq",2602=>"10013",2603=>"GMS",2604=>"10014",2605=>"rQP",2606=>"MS",2607=>"GrQGZrQ|WZtQPHrMQD",2608=>"GrQGZrQ|MIZPQD",2609=>'tIG|fMJQ|nZIQ',2610=>'mizpq',2611=>"WHJuIn",2612=>'rQP',2613=>'MS',2614=>'GMS',2615=>'""',2616=>"MS|QxtQrnZJ",2617=>"PQt|MS|QxtQrnZJ",2618=>"WuDtMnfH",2619=>"DtrQQt",2620=>"ZGZrtIQnt",2621=>"fJHHr",2622=>"GOHnQ",2623=>"SQJMvQrB|SZtQ",2624=>"QxtSZtZ",2625=>"HrSQr|tHtZJ",2626=>"MtQI|MS|QxtQrnZJ",2627=>"MtQI|MnfH",2628=>"Qxt|SZtZ",2629=>"\n",2630=>"QDOHG|MtQI",2631=>'OtIJ|tMtJQ',2632=>'OtIJ|MD|ZutHPQn',2633=>'Qxt|GMWturQ',2634=>'Qxt|DIZJJ|GMWturQ',2635=>'vZJuQ|tBGQ',2636=>'ftBGQ',2637=>'WuDtHI|fMQJS|',2638=>'rQf|rQfQrQnWQ',2639=>"!",2640=>":04S",2641=>'rQf|tZYJQ|nuI',2642=>'DWZJZr',2643=>'_',2644=>"|",2645=>'^',2646=>'UTF+8',2647=>"QDOHG|",2648=>'fMQJSD|IZG',2649=>'fnuI') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class CSVEshopDriver extends ExchangeDriver {public $Il11lL1; public $Il11l1I; public $delim; public $Il11l1l; public $Il11l1L; public $Il11l11; public $Il11LII; public $_fields; public $Il11LIl; public $Il11LIL; public $Il11LI1; public $aCustomFields =array(); public $aDatasets =array(); public $Il11LlI =array(); public $Il11Lll =array(); private $Il11LlL; private $Il11Ll1 =array(); function CSVEshopDriver(&$gui, &$module) {parent::__construct($gui, $module); $this->name ="CSVEshopDriver"; $this->Il11lL1 =Array(); $this->Il11l1I =Array(); $this->delim =""; $this->Il11l1l =0; $this->Il11l1L =0; $this->Il11l11 =1/5; $this->Il11LII =0; $this->Il11LIl =60000; $this->Il11LIL =I2565; }function GetInfo() {$aInfo =Array( "name"=>"CSVEshopDriver", "title"=>$this->words["title"], I2566=>Array("import", "export"), "pathtypes"=>Array("files"), I2567=>Array("*.csv"), I2568 => Array("eshop_item", "eshop_order", "eshop_user"), I2569 => Array(), );return $aInfo; }function GetForm($type, &$formData) {parent::GetForm($type, $formData); $html =$this->gui->get($this->name.I2570.$type."_form", $formData); return $html; }function Start($actionType, &$aParams) {$II1LIlI =parent::Start($actionType, $aParams); $module =$aParams["vars"][I2571]; require_once $GLOBALS['CLASSES_PATH'] .'CMS_DataExchange_Driver_CSV.php'; $this->Il11LlL =new CMS_DataExchange_Driver_CSV($this, $aParams); switch ($actionType) {case I2572: $this->module->I11LIlL =false; switch ($module) {case "eshop_item": $Il11LLI =false; $Il11LLl =false; $Il11LLL =false; if($II1LIlI) {$this->_config['fields'] =$this->module->TTII111('fields_map', true); $dataSource =$aParams["data_source"]; if (file_exists($dataSource)) {$this->TTIIlIl(0, 100); $this->II1LIIL =filesize($dataSource); if(($fp =@fopen($dataSource, I2573))) {$II1LIlI =$this->Il11LlL->TTIlTIl($fp, true); $II1LIlI =$II1LIlI && $this->TTIIlIT(Array("action"=>"common")); if($II1LIlI) {if($aParams['vars']['skip_first_line']) {fgetcsv($fp, $this->Il11LIl, $this->delim); }if(is_array($this->_config[I2574]["CATEGORY"]) && sizeof($this->_config[I2574]["CATEGORY"]) >0) {$this->I1IL1Ll["catIdField"] =-1; $this->I1IL1Ll["catParentIdField"] =-1; foreach($this->_config[I2574][I2575] as $fieldName=>$fieldData) {if($fieldName == "ID_PARENT_EXTERNAL" && $fieldData["type"] == "column") {$this->I1IL1Ll["catParentIdField"] =$fieldData[I2576]; }if($fieldName == "ID_EXTERNAL" && $fieldData["type"] == "column") {$this->I1IL1Ll["catIdField"] =$fieldData[I2576]; }}$Il11LLl =$Il11LLI =($this->I1IL1Ll[I2577] >-1); }$this->module->I11LIlL =$Il11LLl && !empty($this->_config['fields']['CATEGORY']['ID_EXTERNAL']) && !empty($this->_config['fields'][I2578]['ID_EXTERNAL']) && !empty($this->_config['fields'][I2578]['ITEM_LINKS']); if(is_array($this->_config[I2574]["IMAGE"]) && sizeof($this->_config[I2574][I2579]) >0) {$Il11LLL =true; $this->module->TTII1l1($this->Il11Ll1, 'item_fields_map'); $this->Il11Ll1 =array_intersect_key( $this->Il11Ll1, array('IMAGE_MAIN' => '', 'IMAGE_POPUP' => I2580, 'IMAGE_SMALL' => I2580) );}if(is_array($this->_config[I2574]["REFERENCE"]) && sizeof($this->_config[I2574]["REFERENCE"]) >0) {$II1LIlI =$this->TT1TT1l($fp, $Il11LLI, $Il11LLL); if($II1LIlI) {$this->Il11l1L =$this->Il11l11*$this->Il11l1l; $II1LIlI =$this->TT1TT11($fp, $Il11LLI, $Il11LLL, false); }}else {$this->Il11l1L =$this->Il11l11*$this->Il11l1l; if($Il11LLI || $Il11LLL) {$II1LIlI =$this->TT1TT11($fp, $Il11LLI, $Il11LLL, true); }}if($II1LIlI && $Il11LLl) {$this->Il11l1L =2*$this->Il11l11*$this->Il11l1l; fseek($fp, 0); $this->Il11LlL->TTIlTIl($fp); if($aParams['vars'][I2581]) {fgetcsv($fp, $this->Il11LIl, $this->delim); }$II1LIlI =$this->TT1TTlI($fp); }if($II1LIlI) {$this->Il11l1L =3*$this->Il11l11*$this->Il11l1l; $this->Il11l11 =2*$this->Il11l11; fseek($fp, 0); $this->Il11LlL->TTIlTIl($fp); if($aParams['vars'][I2581]) {fgetcsv($fp, $this->Il11LIl, $this->delim); }$II1LIlI =$this->TT1TTll($fp); if($II1LIlI) {$this->TTIIlIl($this->Il11l1l, $this->Il11l1l); }}}}else {$this->TTIIlT1("10011", "data_open_error"); $II1LIlI =false; }}else {$this->TTIIlT1("10010", I2582); $II1LIlI =false; }}break; case "eshop_user": $II1LIlI =$this->TTIIlIT(Array("action"=>"common")); if ($II1LIlI) {if($aParams['vars'][I2581]) {fgetcsv($fp, $this->Il11LIl, $this->delim); }$this->_config[I2574] =$this->module->TTII111("import_user_fields_map", true); $dataSource =$aParams["data_source"]; if (file_exists($dataSource)) {$this->TTIIlIl(0, 100); $this->II1LIIL =filesize($dataSource); if (($fp =@fopen($dataSource, I2573))) {$II1LIlI =$this->TT1TT1T($fp); }else {$this->TTIIlT1("10011", "data_open_error"); $II1LIlI =false; }}else {$this->TTIIlT1("10010", I2582); $II1LIlI =false; }}break; case I2583: $II1LIlI =$this->TTIIlIT(Array("action"=>"common")); if ($II1LIlI) {if($aParams['vars'][I2581]) {fgetcsv($fp, $this->Il11LIl, $this->delim); }$this->_config[I2574] =$this->module->TTII111("import_order_fields_map", true); $dataSource =$aParams[I2584]; if (file_exists($dataSource)) {$this->TTIIlIl(0, 100); $this->II1LIIL =filesize($dataSource); if (($fp =@fopen($dataSource, I2573))) {$II1LIlI =$this->TT1TTl1($fp); }else {$this->TTIIlT1("10011", "data_open_error"); $II1LIlI =false; }}else {$this->TTIIlT1("10010", I2582); $II1LIlI =false; }}break; default: $this->TTIIlT1("10015", I2585); $II1LIlI =false; break; }break; case "export": $this->TT1TII1(); if(isset($aParams["vars"][I2586]) && in_array("eshop_item", $aParams["vars"][I2586])){ $aData =array(); $this->Il11LI1 =I2565; $this->module->oEshop->tree->setCallbackObject($this); $this->module->oEshop->tree->TI11III(I2587, "c.id_external, c.announce, c.description, pc.id AS cat_id_parent, pc.id_external AS cat_id_parent_external, c.public"); $this->module->oEshop->tree->addJoinedTable("c2", "LEFT JOIN ".$this->module->oEshop->dbTablePrefix."_cats pc ON c.id_parent = pc.id"); $this->module->oEshop->tree->TI11II1(); $this->module->oEshop->tree->setCallbackMethod("createChildsArrayFlt", "_createChildsArrayFltCB"); $this->module->oEshop->tree->createChildsArrayFlt(I2587); $aData["categories_rows"] =$this->Il11LI1; $aData['custom_fields_all'] =I2580; foreach($this->aCustomFields as $Il11LL1 => $Il11L1I){ if(intval($Il11L1I['fnum'])){ $aData[I2588] .= ';'.'CATALOG_CUSTOM_FIELD_'.intval($Il11L1I['fnum']); }}$this->Il11LIL =$this->gui->getAbsDefPostf($this->name.":export_item_header", I2565, $aData); }$this->_config["custom_field_prefix"] =$aParams["custom_field_prefix"]; break; }return $II1LIlI; }function _createChildsArrayFltCB(&$II11L1l, &$record, &$Il11L1l) {$catID =$record["id"]; $Il11L1L =$record["id_parent"]; $aCatData =array(); $aCatData['cat_id_external'] =$record[I2589]; $aCatData['cat_id_parent_external'] =$record['cat_id_parent_external']; $aCatData['category_is_deleted'] =intval($record['public']) ?I2590 :'true'; $aCatData['cat_name'] =$record['name']; $aCatData['cat_announce'] =$record[I2591]; $aCatData['cat_description'] =$record['description']; $this->module->II1lllL["eshop_cat"][$catID] =$aCatData['cat_id_external']; if($this->module->cms->Core->GetModOption(I2592, "generate_id_external")){ if(!isset($aCatData["cat_id_external"]) || empty($aCatData["cat_id_external"])){ if(isset($this->module->II1lllL[I2592][$catID]) && !empty($this->module->II1lllL[I2592][$catID])){ $aCatData["cat_id_external"] =$this->module->II1lllL[I2592][$catID]; }else{ $aCatData[I2593] =$this->TTIIllI(); $this->module->II1lllL[I2592][$catID] =$aCatData[I2593]; }}if($Il11L1L && (!isset($aCatData["cat_id_parent_external"]) || empty($aCatData["cat_id_parent_external"]))){ if(isset($this->module->II1lllL[I2592][$Il11L1L]) && !empty($this->module->II1lllL[I2592][$Il11L1L])){ $aCatData["cat_id_parent_external"] =$this->module->II1lllL[I2592][$Il11L1L]; }else{ $aCatData["cat_id_parent_external"] =$this->TTIIllI(); $this->module->II1lllL[I2592][$Il11L1L] =$aCatData["cat_id_parent_external"]; }}}else{ $this->module->II1lllL[I2592][$Il11L1L] =$aCatData["cat_id_parent_external"]; }$this->TT1TIII($aCatData); $this->Il11LI1 .= $this->gui->getAbsDefPostf($this->name.":export_item_row", I2565, $aCatData); $this->Il11LI1 .= "\n"; }function TT1TTlI($fp) {if($this->TTIIlIT(Array("action"=>I2594))) {$II1LIlI =true; $Il11L11 =0; while($aData =fgetcsv($fp, $this->Il11LIl, $this->delim)) {TlT1lT1($aData); $Il11L11++; if ($this->TTIIllT($aData)) {$aCatData =Array(); $II1L1lI =$this->TT1TIT1($this->_config[I2574][I2575]["ID_EXTERNAL"], $aData); if(isset($this->Il11lL1["reg_id"][$II1L1lI])) {unset($this->Il11lL1["reg_id"][$II1L1lI]); foreach($this->_config[I2574][I2575] as $fieldName=>$fieldData) {$aCatData[$fieldName] =$this->TT1TIT1($fieldData, $aData); }$aCatData += $this->TT1TITI($aData); $this->II1I1IL->{$this->II1I1I1[I2594]}($aCatData); }}$this->TTIIlIl($this->Il11l1L +$this->Il11l11 *$Il11L11, $this->Il11l1l); }}else {$this->TTIIlT1("10012", I2595); $II1LIlI =false; }$this->TTIIlII(Array("action"=>I2594)); return $II1LIlI; }function TT1TTll($fp) {if($this->TTIIlIT(Array("action"=>"process_items"))) {unset($this->II1I1IL->II1llIL->Engine->ext['ext_rating']); $II1LIlI =true; $Il11L11 =0; while($aData =fgetcsv($fp, $this->Il11LIl, $this->delim)) {TlT1lT1($aData); $Il11L11++; if ($this->TTIIllT($aData)) {$aItemData =Array(); $II1L1lI =$this->TT1TIT1($this->_config[I2574][I2596]["ID_EXTERNAL"], $aData); if($II1L1lI != I2565) {foreach($this->_config[I2574][I2596] as $fieldName=>$fieldData) {$aItemData[$fieldName] =$this->TT1TIT1($fieldData, $aData); }$aItemData += $this->TT1TITI($aData); $this->II1I1IL->{$this->II1I1I1["process_items"]}($aItemData); }}$this->TTIIlIl($this->Il11l1L +$this->Il11l11 *$Il11L11, $this->Il11l1l); }}else {$this->TTIIlT1("10012", I2595); $II1LIlI =false; }$this->TTIIlII(Array("action"=>I2597)); return $II1LIlI; }function TT1TTl1($fp) {if($this->TTIIlIT(Array("action"=>"process_orders"))) {$II1LIlI =true; $Il11L11 =0; $Il111II =Array(); while($aData =fgetcsv($fp, $this->Il11LIl, $this->delim)) {TlT1lT1($aData); $Il11L11++; if ($this->TTIIllT($aData)) {$aOrderData =Array(); $II1L1lI =$this->TT1TIT1($this->_config[I2574]["ID_EXTERNAL"], $aData); if($II1L1lI != I2565 && !isset($Il111II[$II1L1lI])) {foreach($this->_config[I2574] as $fieldName=>$fieldData) {$aOrderData[$fieldName] =$this->TT1TIT1($fieldData, $aData); }$this->II1I1IL->{$this->II1I1I1["process_orders"]}($aOrderData); $Il111II[$II1L1lI] =true; }}$this->TTIIlIl($this->Il11l1L +$this->Il11l11 *$Il11L11, $this->Il11l1l); }}else {$this->TTIIlT1(I2598, I2595); $II1LIlI =false; }$this->TTIIlIl(100, 100); $this->TTIIlII(Array("action"=>"process_orders")); return $II1LIlI; }function TT1TT1T($fp) {if ($this->TTIIlIT(Array("action"=>"process_users"))) {$II1LIlI =true; $Il11L11 =0; while($aData =fgetcsv($fp, $this->Il11LIl, $this->delim)) {TlT1lT1($aData); $Il11L11++; if ($this->TTIIllT($aData)) {$aUserData =Array(); $II1L1lI =$this->TT1TIT1($this->_config[I2574][I2599], $aData); foreach($this->_config[I2574] as $fieldName=>$fieldData) {$aUserData[$fieldName] =$this->TT1TIT1($fieldData, $aData); }$this->II1I1IL->{$this->II1I1I1["process_users"]}($aUserData); }$this->TTIIlIl($this->Il11l1L +$this->Il11l11 *$Il11L11, $this->Il11l1l); }}else {$this->TTIIlT1(I2598, I2595); $II1LIlI =false; }$this->TTIIlIl(100, 100); $this->TTIIlII(Array("action"=>"process_users")); return $II1LIlI; }function TT1TT1I(&$aData) {$II1LIlI =true; if (count($aData) <6) $II1LIlI =false; return $II1LIlI; }function TT1TT1l($fp, $Il11LLI, $Il11LLL) {if($this->TTIIlIT(Array("action"=>I2600))) {$II1LIlI =true; $this->Il11l1l =0; while($aData =fgetcsv($fp, $this->Il11LIl, $this->delim)) {TlT1lT1($aData); $this->Il11l1l++; if ($this->TTIIllT($aData)) {$Il111Il =mb_strlen(implode(";", $aData)); $II1LIlI =$this->TT1TT1I($aData); if(!$II1LIlI) {$this->TTIIlT1("10014", "num_columns_error", Array("line" => $this->Il11l1l)); break; }foreach($this->_config[I2574][I2601] as $type=>$fields) {$Il111IL =Array(); $Il111IL["data_type"] ="REFERENCE_".$type; $Il111IL[$fields[I2587]] =$aData[$fields["num"]]; $Il111IL[I2599] =trim($aData[$fields["num"]]); $this->II1I1IL->{$this->II1I1I1[I2600]}($Il111IL); $this->TTIIlIl($this->Il11l1L +$this->Il11l11 *$Il111Il, $this->II1LIIL); }if(!$this->__PrepareImagesCats($aData, $Il11LLI, $Il11LLL)) {$this->TTIIlT1(I2602, "category_cycling", Array("line" => $this->Il11l1l)); $II1LIlI =false; break; }}}}else {$this->TTIIlT1(I2598, I2595); $II1LIlI =false; }$this->TTIIlII(Array("action"=>I2600)); return $II1LIlI; }function __PrepareImagesCats(&$aData, $Il11LLI, $Il11LLL) {$II1LIlI =true; if($Il11LLI) {if($aData[$this->I1IL1Ll[I2577]] != $aData[$this->I1IL1Ll["catParentIdField"]]) {$this->Il11lL1[I2603][$aData[$this->I1IL1Ll["catParentIdField"]]][] =Array("id"=>$aData[$this->I1IL1Ll[I2577]]); $this->Il11lL1["id"][$aData[$this->I1IL1Ll[I2577]]] =$aData[$this->I1IL1Ll["catParentIdField"]]; }else {$II1LIlI =false; }}if($Il11LLL) {$this->TT1TITT($aData); }return $II1LIlI; }function TT1TT11($fp, $Il11LLI, $Il11LLL, $Il111I1) {$II1LIlI =true; if($Il111I1) {$this->Il11l1l =0; while($aData =fgetcsv($fp, $this->Il11LIl, $this->delim)) {TlT1lT1($aData); $this->Il11l1l++; if ($this->TTIIllT($aData)) {$II1LIlI =$this->TT1TT1I($aData); if(!$II1LIlI) {$this->TTIIlT1(I2604, "num_columns_error", Array("line" => $this->Il11l1l)); break; }if(!$this->__PrepareImagesCats($aData, $Il11LLI, $Il11LLL)) {$this->TTIIlT1(I2602, "category_cycling", Array("line" => $this->Il11l1l)); $II1LIlI =false; break; }}}}if($II1LIlI) {if($Il11LLI) {$this->TT1TIIT(); }if(is_array($this->Il11lL1[I2605])) {if($this->TTIIlIT(Array("action"=>"prepare_categories"))) {$i =0; foreach ($this->Il11lL1[I2605] as $row) {$this->II1I1IL->{$this->II1I1I1["prepare_categories"]}(Array("id_external"=>$row[I2606], "id_parent_external"=>$row[I2603], "is_mark_deleted"=>$row["is_deleted"])); $this->TTIIlIl($this->Il11l1L +$this->Il11l11 *(++$i), $this->Il11l1l); }}else {$this->TTIIlT1(I2598, I2595); $II1LIlI =false; }$this->TTIIlII(Array("action"=>I2607)); }if(is_array($this->Il11l1I) && sizeof($this->Il11l1I) >0) {if($this->TTIIlIT(Array("action"=>"prepare_images"))) {foreach($this->Il11l1I as $aImage) {$this->II1I1IL->{$this->II1I1I1["prepare_images"]}($aImage); }}else {$this->TTIIlT1(I2598, I2595); $II1LIlI =false; }$this->TTIIlII(Array("action"=>I2608)); }}return $II1LIlI; }function TT1TITT(&$aRecord){ foreach($this->_config['fields']['IMAGE'] as $fieldName => $fieldData) {$img =$this->TT1TIT1($fieldData, $aRecord); if($img != I2580){ $this->Il11l1I[] =isset($this->Il11Ll1[$fieldName]) && $this->Il11Ll1[$fieldName]['operation'] == 'image' ?array(I2609 => $img, 'store_name' => $img, 'force_overwrite' => true) :array('file_name' => $img); }}}function TT1TITI(&$aRecord){ $aImages =Array(); if(isset($this->_config['fields'][I2610])){ foreach((array)$this->_config['fields'][I2610] as $fieldName => $fieldData){ $aImages[$fieldName] =I2580; $fname =$this->TT1TIT1($fieldData, $aRecord); if(!empty($fname)){ $aImages[$fieldName] =isset($this->Il11Ll1[$fieldName]) && $this->Il11Ll1[$fieldName]['operation'] == 'image' ?$fname :str_replace($GLOBALS['ROOT_PATH'], I2580, $GLOBALS['CUSTOM_PICTURES_PATH']) .$this->module->I11lLl1 .'/' .$fname; }}}return $aImages; }function TT1TITl(&$aRowData) {$prices =Array(); if(is_array($this->_config[I2574]["PRICE_TYPE"])) {foreach($this->_config[I2574]["PRICE_TYPE"] as $numPrice=>$Il111lI) {foreach($Il111lI as $fieldName=>$fieldData) {$prices[$numPrice][$fieldName] =$this->TT1TIT1($fieldData, $aRowData); }}}return $prices; }function TT1TIT1($fieldData, &$aRowData) {$value =I2565; switch($fieldData["type"]) {case I2611: $value =$aRowData[$fieldData[I2576]]; break; case "column_price": $value =preg_replace("/[^0-9\\.,]/", I2565, $aRowData[$fieldData[I2576]]); break; case I2576: $value =$fieldData[I2576]; break; case "add_price_type": $value =$this->TT1TITl($aRowData); break; }return $value; }function TT1TIIT($Il111ll =true) {if(is_array($this->Il11lL1[I2603]) && sizeof($this->Il11lL1[I2603]) >0) {foreach($this->Il11lL1[I2603] as $pid=>$children) {if(!isset($this->Il11lL1[I2606][$pid])) {if(is_array($children)) {foreach($children as $child) {$this->Il11lL1[I2605][] =$child +Array(I2603=>$pid); $this->Il11lL1["reg_id"][$child[I2606]] =1; unset($this->Il11lL1[I2606][$child[I2606]]); }}unset($this->Il11lL1[I2603][$pid]); }}$this->TT1TIIT(false); }if ($Il111ll) {if (is_array($this->Il11lL1[I2612])) {$Il111lL =array ();$Il111l1 =array ();foreach (array_keys($this->Il11lL1[I2612]) as $i) {$el =$this->Il11lL1[I2612][$i]; $set =true; if ($el['pid'] != I2580 && isset($Il111l1[$el['id']]) && $Il111l1[$el['id']]['pid'] == I2580) {$Il111lL[] =$Il111l1[$el[I2613]]['idx']; }else if (isset($Il111l1[$el[I2613]])) {$Il111lL[] =$i; $set =false; }if ($set) {$Il111l1[$el[I2613]] =array ('pid' => $el['pid'], 'pid' => $el[I2614], 'idx' => $i); }}foreach ($Il111lL as $i) {unset($this->Il11lL1[I2612][$i]); }}}}function TT1TIII(&$aArray) {foreach ($aArray as $key => $value) {if (!is_array($value)) {$value =unhtmlentities($value); $aSearch =Array('"', "\r\n", "\r"); $aReplace =Array(I2615, "\n", "\n"); $value =str_replace($aSearch, $aReplace, $value); $aArray[$key] ="\"$value\""; }}}function TTIIIl1($II1ILL1, $II1IL1I, $II1IL1l, $II1IL1L) {$Il111LI =false; $content =I2565; switch ($II1ILL1) {case I2583: $aOrderData =$II1IL1I; if(!isset($aOrderData["id_external"]) || empty($aOrderData["id_external"])) {$aOrderData[I2616] =$aOrderData[I2606]; $Il111LI =true; }$II1LI1I =$aOrderData[I2616]; $Il111Ll =$aOrderData['items']; $aOrderData += (array)$aOrderData["custinfo"]; $aOrderData += (array)$aOrderData["sysinfo"]; $aOrderData["user_id_external"] =$this->II1I1IL->{$this->II1I1I1[I2617]}("user", $aOrderData["id_member"], "id_member"); $aOrderData["zip"] =$aOrderData[I2618]["zip"]; $aOrderData["city"] =$aOrderData[I2618]["city"]; $aOrderData["street"] =$aOrderData[I2618][I2619]; $aOrderData["house"] =$aOrderData[I2618]["house"]; $aOrderData["building"] =$aOrderData[I2618]["building"]; $aOrderData[I2620] =$aOrderData[I2618]["app"]; $aOrderData["entrance"] =$aOrderData[I2618]["entrance"]; $aOrderData["floor"] =$aOrderData[I2618][I2621]; $aOrderData["entrance_code"] =$aOrderData[I2618]["code"]; $aOrderData["customer_address"] =$aOrderData[I2618]["customer_address"]; $aOrderData[I2622] =$aOrderData[I2618]["contact"]; $aOrderData["shipping_type"] =$aOrderData[I2618]["get_type_name"]; $aOrderData["delivery_date"] =$aOrderData[I2618][I2623]; $aOrderData["subway_station"] =$aOrderData[I2618]["station"]; unset($aOrderData["ext_data"]); unset($aOrderData[I2618]); unset($aOrderData["sysinfo"]); unset($aOrderData[I2624]); unset($aOrderData["items"]); unset($aOrderData["currency"]); $aOrderData["statuses_history"] =$this->TT1TIIl($aOrderData["statuses_history"]); $aOrderData[I2625] =$aOrderData["total_tax"] +$aOrderData["total_price"] +$aOrderData["total_shipping"]; $content =I2565; if(is_array($Il111Ll)) {foreach($Il111Ll as $name => $aItem) {if($aItem["item_id_external"] == I2565 && $aItem[I2606] != I2565) {$aItem[I2626] =$this->II1I1IL->{$this->II1I1I1[I2617]}("item", $aItem[I2606]); }$Il111LL =$aOrderData +$aItem; unset($Il111LL["ext_data"]); $Il111LL["shipping"] =$aItem["ext_data"][I2627]["shipping"]; $Il111LL["tax"] =$aItem["ext_data"][I2627]["tax_item_value"]; $Il111LL[I2587] =$aItem[I2628][I2627][I2587]; $Il111LL["cat_name"] =$aItem[I2628][I2627]["cat_name"]; $Il111LL["sku"] =$aItem[I2628][I2627]["sku"]; $this->TT1TIII($Il111LL); foreach ($this->_fields as $field) {$content .= $Il111LL[$field].$this->delim; }$content =mb_substr($content, 0, -1); $content .= I2629; }}else {}break; case "eshop_user": $aUserData =$II1IL1I; if(!isset($aUserData[I2616]) || empty($aUserData[I2616])) {$aUserData[I2616] =$aUserData[I2606]; $Il111LI =true; }$II1LI1I =$aUserData[I2616]; $aUserData["balance_history"] =$this->TT1TIIl($aUserData["balance_history"]); unset($aUserData["currency"]); $this->TT1TIII($aUserData); $content =I2565; foreach ($this->_fields as $field) {$content .= $aUserData[$field].$this->delim; }$content =mb_substr($content, 0, -1); $content .= I2629; break; case I2630: $aItemData =$II1IL1I; if($this->module->cms->Core->GetModOption(I2630, "generate_id_external") && (!isset($aItemData[I2616]) || empty($aItemData[I2616]))){ $aItemData[I2616] =$this->TTIIllI(); $Il111LI =true; }if(!empty($aItemData['sm_data'])){ $aMeta =@unserialize($aItemData['sm_data']); if(is_array($aMeta)){ foreach(array( 'title' => I2631, 'keywords' => 'html_keywords', 'description' => 'html_description' )as $src => $dest){ $aItemData[$dest] =isset($aMeta[$src]) ?$aMeta[$src] :I2580; }$aItemData[I2632] =empty($aMeta['is_kw_manual']) ?'true' :I2590; }}$II1LI1I =$aItemData[I2616]; $this->Il11Lll['items'][$aItemData[I2613]] =$aItemData[I2616]; $aItemData[I2593] =$this->module->II1lllL[I2592][$aItemData["cat_id"]]; $aItemData["cat_id_parent_external"] =$this->module->II1lllL[I2592][$aItemData["cat_id_parent"]]; $aItemData['catalog_is_deleted'] =intval($aItemData['public']) ?I2590 :'true'; $aItemData['category_is_deleted'] =intval($aItemData['cat_public']) ?I2590 :'true'; if($aItemData['ext_picture']){ $aItemData['ext_picture'] =basename($aItemData[I2633]); }if($aItemData['ext_popup_picture']){ $aItemData['ext_popup_picture'] =basename($aItemData['ext_popup_picture']); }if($aItemData['ext_small_picture']){ $aItemData[I2634] =basename($aItemData[I2634]); }foreach($this->aCustomFields as $Il11LL1 => $IlL1L1I){ if(($IlL1L1I['value_type'] == 'ref_reference' || $IlL1L1I['value_type'] == 'ref_set') || (($IlL1L1I[I2635] == 'ref_value' || $IlL1L1I[I2635] == 'scalar') && ($IlL1L1I['ftype'] == 'related_items' || $IlL1L1I[I2636] == 'related_cats'))){ if(mb_strpos($this->aDatasets[$aItemData['cat_dataset_id']], ';'.$Il11LL1.';') !== false){ if(isset($aItemData[I2637.$IlL1L1I['fnum']])){ $Il111L1 =I2580; $Il1111I =array(); foreach(explode(";", trim($aItemData[I2637.$IlL1L1I['fnum']], ';')) as $refId){ if(!empty($refId)){ $Il1111I[] =intval($refId); }}foreach($Il1111I as $refId){ if($IlL1L1I[I2635] == I2638 || $IlL1L1I[I2635] == 'ref_set'){ if(isset($this->Il11LlI[$IlL1L1I['ref_table_num']][$refId])){ $Il111L1 .= $this->Il11LlI[$IlL1L1I['ref_table_num']][$refId].'|'; }else{ $sql ="SELECT id, id_external FROM ".$this->module->oEshop->dbTablePrefix."_reference_".sprintf("%04d", $IlL1L1I['ref_table_num'])." WHERE id IN (".implode(I2639, $Il1111I).")"; $rs =&$this->module->db->select($sql); while($record =$rs->nextRecord()){ if(!empty($record[I2589])){ $this->Il11LlI[$IlL1L1I['ref_table_num']][$record[I2613]] =$record[I2589]; }else{ $this->Il11LlI[$IlL1L1I['ref_table_num']][$record[I2613]] =$this->TTIIllI(); $Il1111l =$this->module->db->GenUpdateSQL($this->module->oEshop->dbTablePrefix."_reference_".sprintf(I2640, $IlL1L1I['ref_table_num']), array(I2589 => $this->Il11LlI[$IlL1L1I['ref_table_num']][$record[I2613]]), "WHERE id = '".$record[I2613]."'"); $this->module->db->query($Il1111l); }}if(isset($this->Il11LlI[$IlL1L1I[I2641]][$refId])){ $Il111L1 .= $this->Il11LlI[$IlL1L1I[I2641]][$refId].'|'; }}}elseif(($IlL1L1I[I2636] == 'related_items' || $IlL1L1I[I2636] == 'related_cats') && ($IlL1L1I[I2635] == 'ref_value' || $IlL1L1I[I2635] == I2642)){ if($IlL1L1I[I2636] == 'related_items'){ $fType ='items'; }else{ $fType ='cats'; $this->Il11Lll['cats'][$refId] =$this->module->II1lllL[I2592][$refId]; }if(isset($this->Il11Lll[$fType][$refId])){ $Il111L1 .= $this->Il11Lll[$fType][$refId].I2643; }else{ $sql ="SELECT id, id_external FROM ".$this->module->oEshop->dbTablePrefix."_".$fType." WHERE id IN (".implode(I2639, $Il1111I).")"; $rs =&$this->module->db->select($sql); while($record =$rs->nextRecord()){ if(!empty($record[I2589])){ $this->Il11Lll[$fType][$record[I2613]] =$record[I2589]; }else{ $this->Il11Lll[$fType][$record[I2613]] =$this->TTIIllI(); $Il1111l =$this->module->db->GenUpdateSQL($this->module->oEshop->dbTablePrefix.I2644.$fType, array(I2589 => $this->Il11Lll[$fType][$record[I2613]]), "WHERE id = '".$record[I2613]."'"); $this->module->db->query($Il1111l); }}if(isset($this->Il11Lll[$fType][$refId])){ $Il111L1 .= $this->Il11Lll[$fType][$refId].I2643; }}}}$aItemData[I2637.$IlL1L1I['fnum']] =trim($Il111L1, I2643); }}}}$this->TT1TIII($aItemData); $aItemData[I2588] =I2580; foreach($this->aCustomFields as $Il11LL1 => $Il11L1I){ if(intval($Il11L1I['fnum'])){ $aItemData[I2588] .= I2645.$aItemData[I2637.$Il11L1I['fnum']]; }}$content =$this->Il11LIL; $this->Il11LIL =I2565; $content .= $this->gui->getAbsDefPostf($this->name.":export_item_row", I2565, $aItemData); $content .= I2629; break; }$res =Array(); $res["content"] =mb_convert_encoding($content, 'Windows-1251', I2646); $res["is_new_id_external"] =$Il111LI; $res[I2616] =$II1LI1I; return $res; }function TT1TIIl($Il1111L, $Il11111 ="|=", $ILIIIII ="|") {$str =I2565; if(is_array($Il1111L)) {foreach ($Il1111L as $timestamp => $data) {array_unshift($data, date($this->module->cms->DFMT["php_dtime"], $timestamp)); $str .= implode($ILIIIII, $data).$Il11111; }$str =mb_substr($str, 0, mb_strlen($str) -mb_strlen($Il11111)); }return $str; }function TTIIIlT($II1ILLL, &$aParams) {$II1ILLL =str_replace(I2647, I2565, $II1ILLL); $this->_fields =$this->module->TTII111($II1ILLL."_export_fields", true); return true; }function TT1TII1(){ $sql ="SELECT `id`, `fields_map` FROM ".$this->module->oEshop->dbTablePrefix."_datasets WHERE lang = '".$this->module->langData."'"; $rs =&$this->module->db->select($sql); while($record =$rs->nextRecord()){ $this->aDatasets[$record[I2613]] =$record[I2648]; }$sql ="SELECT `id`, `fnum`, `ftype`, `value_type`, `ref_table_num` " ."FROM " .$this->module->oEshop->dbTablePrefix ."_custom_types " ."WHERE `is_prop` = 0 AND `type_owner` = 'item' AND `ftype` NOT IN ('flagmap', 'related_cats') AND `value_type` IN ('scalar', 'ref_value', 'ref_set') ORDER BY fnum"; $rs =&$this->module->db->select($sql); while($record =$rs->nextRecord()){ $this->aCustomFields[$record[I2613]] =array( I2649 => $record[I2649], I2636 => $record[I2636], I2635 => $record[I2635], I2641 => $record[I2641] );}}}