<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       31631 xkqwustkzzwnplsywnnggrxlxszlxmqwtuzttipluyzypqrqpriusplgnwsikgyiglwnpnir
 */ ?><?php foreach(array(4088=>'q|sqgRqwzTqs',4089=>"|qRR|szTq|FiT",4090=>"|qRR|FzTzj",4091=>"|qRR|idp|Th|Fmjq",4092=>"|qRR|jmNq|whjhR",4093=>"#~tZYJQ@\n",4094=>"gog%?gzRdq?qRRhR",4095=>"gog%?sqgRqwzTqs",4096=>"",4097=>"*<|q|szTq<&",4098=>"?",4099=>'|YZWKtrZWQdtrMnP',4100=>'',4101=>'funWtMHn',4102=>"\n",4103=>"ZWtMHn",4104=>'wHrQ',4105=>"\njMWQnWQ?HCnQr%?",4106=>'WHSQ',4107=>"\nWJMQnt|MG?=?",4108=>"jhwzj|zssR",4109=>"sZtQ%\t",4110=>"ghdT%\n",4111=>'```',4112=>"\nwHHKMQD%\n\t",4113=>"RhhT|gzTo|ccc",4114=>'whNNqwT|hgTmhNd',4115=>'qRRhR|wJMQntFJZPD',4116=>'SY',4117=>'GQrMHS',4118=>"UgszTq?",4119=>"!?GQrMHS?=?",4120=>'?HWWurrQnWQD{',4121=>'?') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} @ini_set("track_errors",1); if(!defined('E_DEPRECATED')){ define(I4088, 8192); }if(!defined('E_USER_DEPRECATED')){ define('E_USER_DEPRECATED', 16384); }define ("_ERR_MAX_LOG_SIZE", 2000000); define ("_ERR_MAKE_BACKUP", 1); define (I4089, "Y-m-d H:i:s"); define ("_ERR_SOURCE_LINES_SHOW", 9); define ("_ERR_DEFAULT_LOG_FILE", "logs/messages.log"); define (I4090, E_USER_ERROR); define ("_ERR_WARN", E_USER_WARNING); define ("_ERR_NOTE", E_USER_NOTICE); define ("_ERR_DEBUG_NO", 7001); define ("_ERR_DEBUG_YES", 7002); define (I4091, 7004); define ("_ERR_MSG_TO_SCREEN", 7005); define ("_ERR_TERMINATE_MSG","</td></tr></table>\n<br><font color=\"red\" size=2><b>You are not allowed to view this page.</b></font><br>\n"); define ("_ERR_HTML_MSG","</td></tr></table>\n<br><font color=\"red\" size=2><b>[#_E_TYPE#] [code = [#_E_CODE#]]:</b></font>&nbsp;<font color=\"black\">[#_E_BODY#]</font>\n"); define ("_ERR_TXT_MSG","[[#_E_DATE#]] ['[#_E_TYPE#]'] [code=[#_E_CODE#]]: [#_E_BODY#]\n"); define ("_ERR_SRC_HEAD","\n<table border=0 bgcolor=#cccccc cellspacing=0 cellpadding=0>\n"); define (I4092," bgcolor=#ff8888"); define ("_ERR_LINE","<tr><td[#_E_COLOR#]>&nbsp;[#_E_LINE#]</td></tr>\n"); define ("_ERR_SRC_FOOT",I4093); define ("_ERR_MASK_FILTERED", (E_ALL ^E_NOTICE ^E_USER_NOTICE)); define ("_ERR_MASK_UNDEFINED", "undefined"); define('_ERR_SAME_ERRORS_QTY', 10); define('_ERR_SAME_ERRORS_PERIOD', 1); $err =new ERR_Handler(_ERR_DEBUG_YES, $ILll11l); $err->TT1llI1(0); $err->TT1lllT(0); $err->TT1lll1(1); $err->TT1lllI(); class ERR_Handler {public $ILll11L; public $ILll111; public $ILlLIII; public $ILlLIIl; public $ILlLIIL; public $ILlLII1; public $ILlLIlI; public $ILlLIll; public $ILlLIlL; public $ILlLIl1; public $ILlLILI; public $ILlLILl; public $ILlLILL; public $_Messages; public $ILlLIL1; public $ILlLI1I; public $forceDisableEmail; private $ILlLI1l =false; function ERR_Handler( $ILlLI1L =_ERR_DEBUG_NO, $ILlLI11 =_ERR_DEFAULT_LOG_FILE){ $this->ILll11L =1; $this->ILll111 =1; $this->ILlLIII =1; $this->ILlLIIl =""; $this->ILlLIIL =0; $this->ILlLII1 =1; $this->ILlLILL =0; $this->ILlLIll =''; $this->_LogFileSize =_ERR_MAX_LOG_SIZE; $this->_oldLogFileSize =_ERR_MAX_LOG_SIZE; $this->ILlLIlL =$ILlLI1L; $this->ILlLIl1 =false; $this->ILlLILI =false; $this->ILlLILl =false; $this->_Messages =array( E_ERROR => "PHP: FATAL ERROR", E_WARNING => "PHP: WARNING", E_PARSE => I4094, E_NOTICE => "PHP: NOTICE", E_CORE_ERROR => "PHP: CORE ERROR", E_CORE_WARNING => "PHP: CORE WARNING", E_COMPILE_ERROR => "PHP: COMPILE ERROR", E_COMPILE_WARNING => "PHP: COMPILE WARNING", E_USER_ERROR => "USER: ERROR", E_USER_WARNING => "USER: WARNING", E_USER_NOTICE => "USER: NOTICE", E_RECOVERABLE_ERROR => "PHP: RECOVERABLE ERROR", E_DEPRECATED => I4095, E_USER_DEPRECATED => "USER: DEPRECATED" );$this->forceDisableEmail =false; $this->TT1llT1($ILlLI11); return true; }function TT1llT1($file) {$pi =pathinfo($file); $this->ILlLIlI =realpath($pi['dirname']).'/'.$pi['basename']; }function TT1llIT($cMask){ $this->ILlLILl =error_reporting(); $this->ILlLIl1 =true; $this->ILlLILI =mb_strtolower($cMask); error_reporting (E_ALL); return; }function TT1llII(){ if($this->ILlLIl1){ $this->ILlLIl1 =false; $this->ILlLILI =false; error_reporting ($this->ILlLILl); }return; }public function TT1llIl($ILlLlII){ $this->ILlLI1l =$ILlLlII; }function TT1llI1($ILlLlIl =1){ $this->ILll11L =0; if($ILlLlIl==1) $this->ILll11L =1; return; }function TT1lllT($ILlLlIl =1){ $this->ILll111 =0; if($ILlLlIl==1) $this->ILll111 =1; return; }function TT1lllI($ILlLlIL =I4096){ $this->ILlLIIl =$ILlLlIL; return; }function TT1llll($ILlLlIl =0){ $this->ILlLIIL =0; if($ILlLlIl==1) $this->ILlLIIL =1; return; }function TT1lll1($ILlLlIl =0){ $this->ILlLII1 =0; if($ILlLlIl==1) $this->ILlLII1 =1; return; }function TT1ll1T($ILlLlIl =0){ $this->ILlLILL =0; if($ILlLlIl==1) $this->ILlLILL =1; return; }function fatal($IIl11LL){ $this->TTITIl1($IIl11LL,_ERR_FATAL); }function warn($IIl11LL){ $this->TTITIl1($IIl11LL,_ERR_WARN); }function note($IIl11LL){ $this->TTITIl1($IIl11LL,_ERR_NOTE); }function TTITIl1($IIl11LL, $ILlLlI1 =_ERR_NOTE){ $ILlLllI =I4096; if($this->ILlLILL == 1) $ILlLllI ="] [Details: ".$this->TT1l1I1(); $IIILL1l =" ['$IIl11LL'$ILlLllI] "; $ILlLlll =str_replace("[#_E_BODY#]", $IIILL1l, $this->TT1l1TI($ILlLlI1, _ERR_MSG_TO_FILE)); if( ($this->ILlLII1 == 1) && (error_reporting() || $this->ILlLIIL) ){$this->TT1l1T1($ILlLlll); }return; }function TT1ll1I($ILlLllL){ $this->ILlLIll =$this->ILlLIlI; $this->TT1llT1($ILlLllL); }function TT1ll1l(){ $this->ILlLIlI =$this->ILlLIll; $this->ILlLIll =''; }function TT1ll11($ILlLll1){ $this->_oldLogFileSize =$this->_LogFileSize; $this->_LogFileSize =$ILlLll1; }function TT1l1TT(){ $this->_LogFileSize =$this->_oldLogFileSize; $this->_oldLogFileSize =_ERR_MAX_LOG_SIZE; }function TT1l1TI($ILlLlI1, $ILlLlLI =_ERR_MSG_TO_SCREEN){ if($ILlLlLI == _ERR_MSG_TO_SCREEN){ $ILlLlLl =str_replace("[#_E_CODE#]", "$ILlLlI1", _ERR_HTML_MSG); }else{ $ILlLlLl =str_replace(I4097, date(_ERR_DATE_FMT), _ERR_TXT_MSG); $ILlLlLl =str_replace("[#_E_CODE#]", "$ILlLlI1", $ILlLlLl); }$IllLI1L =isset($this->_Messages[$ILlLlI1]) ?$this->_Messages[$ILlLlI1] :'UNKNOWN'; $ILlLlLl =str_replace("[#_E_TYPE#]", $IllLI1L, $ILlLlLl); return $ILlLlLl; }function TT1l1Tl($IILLI1l, $ILlLlLL, $ILlLlL1){ $source =_ERR_SRC_HEAD; clearstatcache(); if(is_readable($IILLI1l)){ $fp =@fopen($IILLI1l, "r"); $line =1; $ILlLl1I =$ILlLlLL -(int)($ILlLlL1/2); $ILlLl1l =$ILlLl1I +$ILlLlL1 -1; if($ILlLlL1==0){ $ILlLl1I =1; $ILlLl1l =99999; }while( !feof($fp) ){$str =chop(@fgets($fp, 8192)); if($line >$ILlLl1l) break; $color =I4096; if($line == $ILlLlLL) $color =_ERR_LINE_COLOR; if($line >= $ILlLl1I){ $str =str_replace(I4098, "&nbsp;", htmlspecialchars($str)); $str =str_replace("[#_E_LINE#]", "$str", _ERR_LINE); $str =str_replace("[#_E_COLOR#]", "$color", $str); $source .= $str; }$line++; }@fclose($fp); clearstatcache(); }$source .= _ERR_SRC_FOOT; return $source; }function TT1l1T1($IIl11LL =I4096){ if(empty($IIl11LL)) {return; }clearstatcache(); if(@file_exists($this->ILlLIlI)){ $fsize =@filesize($this->ILlLIlI); if( _ERR_MAKE_BACKUP && ($this->_LogFileSize>0) && ($fsize >= $this->_LogFileSize) ){$IILlIIL =$this->ILlLIlI.".bak"; @unlink($IILlIIL); @rename($this->ILlLIlI, $IILlIIL); }}@file_put_contents($this->ILlLIlI, $IIl11LL, FILE_APPEND); @chmod($this->ILlLIlI ,0666); return; }function TT1l1IT($ILlLl1L, $cMask){ $res =false; if(empty($cMask)){ $res =true; }else{ if(mb_strpos(mb_strtolower($ILlLl1L), $cMask)!==false){ $res =true; }}return $res; }function TT1l1II($ILlLl11 =true) {$backtrace =debug_backtrace(); $ILlLLII =!$ILlLl11 && function_exists(I4099); for($i=0; $i <($ILlLLII ?3 :4); $i++){ array_shift($backtrace); }if($ILlLLII){ return _backtraceString($backtrace); }$calls =array(); foreach ($backtrace as $i => $call) {$location =isset($call['file']) ?$call['file'] .':' .$call['line'] :I4100; $function =(isset($call['class'])) ?$call['class'] .'.' .$call['function'] :$call[I4101]; $params =I4100; if (isset($call['args'])) {$aParams =Array(); foreach($call['args'] as $arg) {$aParams[] =(is_object($arg))? "Object" :(string)$arg; }$params =implode(', ', $aParams); }$calls[] =sprintf("#%d  %s(%s) \n\t called at [%s]", $i, $function, $params, $location); }return implode("\n", $calls); }function Handler($ILlLlI1, $ILlLLIl, $ILlLLIL, $ILlLLI1) {if( !(error_reporting() &$ILlLlI1) || ($this->ILlLIl1 && !$this->TT1l1IT($ILlLLIl, $this->ILlLILI) && !(_ERR_MASK_FILTERED &$ILlLlI1) )){return; }$ILlLllI =I4096; $ILlLLlI =I4100; if($this->ILlLILL == 1) {$ILlLLlI =$this->TT1l1I1(); $ILlLllI =" [Details: $ILlLLlI ]"; }$IIILL1l =" ['$ILlLLIl'] [File: '$ILlLLIL'] [Line: $ILlLLI1]"; $ILlLLll =str_replace("[#_E_BODY#]", $IIILL1l, $this->TT1l1TI($ILlLlI1)); $ILlLlll =str_replace("[#_E_BODY#]", $IIILL1l.$ILlLllI, $this->TT1l1TI($ILlLlI1, _ERR_MSG_TO_FILE)); if($this->ILll11L){ $source =$this->TT1l1Tl($ILlLLIL, $ILlLLI1, _ERR_SOURCE_LINES_SHOW); $ILlLLll .= $source; }$btrace ="\n"; if($this->ILlLIII){ $btrace .= $this->TT1l1II().I4102; $ILlLLll .= $this->TT1l1II(false) .I4102; }if( ($this->ILlLII1 == 1) && (error_reporting() || $this->ILlLIIL) && $ILlLlI1 != E_NOTICE){ $this->TT1l1T1($ILlLlll); }if(($this->ILll111) && ($this->ILlLIlL == _ERR_DEBUG_YES) && (error_reporting() || $this->ILlLIIL)){ if (function_exists('_print')) {_print($ILlLLll); }else {echo $ILlLLll; }}$this->forceDisableEmail =$this->forceDisableEmail || ($GLOBALS["_SIDE"] == "admin" && isset($_GET["step"]) && isset($_GET[I4103]) && $_GET[I4103] == "refresh" && $_GET["step"] == "1"); if (defined('AMIRO_HOST') && !empty($this->ILlLIIl) && $ILlLlI1 != E_NOTICE && (error_reporting() || $this->ILlLIIL) && $this->TT1l1Il($ILlLLIl) && !$this->forceDisableEmail) {$vstr =I4100; if(isset($GLOBALS[I4104])) {$vers =$GLOBALS[I4104]->getVersion('cms'); $vstr =(isset($GLOBALS['ILlLLlL']) ?I4105 .strip_tags($GLOBALS['ILlLLlL']) :I4100) ."\nVersions: cms=".$vers[I4106].'  req_db='.$vers['db'].'  act_db='.$vers['act_db'].I4102; }$ILlLLl1 =I4107.getenv("REMOTE_ADDR"). "\nhost_ip = ".$_SERVER["SERVER_ADDR"].",". @getenv(I4108)."\nwww_path = ".$GLOBALS["ROOT_PATH_WWW"]."\n\n"; $ILlLLl1 .= "Msg:\t" .mb_substr($ILlLLIl, 0, 6 *1024) .I4102; $ILlLLl1 .= I4109.date(_ERR_DATE_FMT).I4102; $ILlLLl1 .= "Code:\t$ILlLlI1\n"; $ILlLLl1 .= "Src:\t$ILlLLIL:$ILlLLI1\n"; $ILlLLl1 .= "URL:\t" .$GLOBALS["ROOT_PATH_WWW"] .ltrim(@getenv("REQUEST_URI"), '/'). I4102; if($this->ILlLI1l && !empty($_POST)){ $ILlLLl1 .= I4110; foreach($_POST as $postKey => $postValue){ $ILlLLl1 .= "  [" .$postKey ."] => " .(is_array($postValue) ?'Array(' .sizeof($postValue) .')' :mb_substr($postValue, 0, 200) .(mb_strlen($postValue) >200 ?I4111 :I4100)) .I4102; }}$ILlLLl1 .= "Env:\n\t".$this->TT1l1I1("\n\t"); $ILlLLl1 .= "\nPHP:\t" .phpversion() ."\nOS:\t" .php_uname() .I4102; if ($this->ILlLI1I) {$ILlLLl1 .= "\nSame errors period:\n\t" .$this->ILlLI1I .I4102; }$aCookies =sizeof($_COOKIE)? $_COOKIE :((is_object($GLOBALS['cms']) && sizeof($GLOBALS['cms']->VarsCookie))? $GLOBALS['cms']->VarsCookie :Array()); if (sizeof($aCookies)) {$cookies =array ();foreach ($aCookies as $name => $value) {$cookies[] =$name .' = ' .$value; }$ILlLLl1 .= I4112 .implode("\n\t", $cookies) .I4102; }$ILlLLl1 .= $vstr; if (mb_substr($this->ILlLIIl, -17) == '@websitemaster.ru' || mb_substr($this->ILlLIIl, -9) == '@amiro.ru') {$ILlLLl1 .= $btrace; }$ILlLLl1 =mb_substr($ILlLLl1, 0, 5120); @mail($this->ILlLIIl, "ERROR REPORT: SITE ".$GLOBALS[I4113] .$this->ILlLIL1, $ILlLLl1); }if ($ILlLlI1 == _ERR_FATAL) {if (function_exists('display503Header')) {display503Header(3600); }exit(_ERR_TERMINATE_MSG); }}function TT1l1Il($ILlLLLI) {static $dbh, $table; $this->ILlLIL1 =I4100; $this->ILlLI1I =I4100; if (!isset($dbh)) {if ($GLOBALS['_h']['mode'] == 'shared') {if (isset($GLOBALS[I4114]['ERROR_User'])) {$dbh =mysql_connect( $GLOBALS[I4114]['ERROR_Host'], $GLOBALS[I4114]['ERROR_User'], $GLOBALS[I4114]['ERROR_Password'], FALSE, isset($GLOBALS[I4114][I4115]) ?(int)$GLOBALS[I4114][I4115] :0 );if (!is_resource($dbh)) {return true; }}$table ='`' .$GLOBALS[I4114]['ERROR_Database'] .'`.`cms_errors`'; }else {if (!is_object($GLOBALS['db'])) {return true; }$dbh =$GLOBALS[I4116]->_dbLink; $table ='`cms_errors`'; }}$label =debug_backtrace(); unset($label[0], $label[1]); foreach (array_keys($label) as $index) {unset($label[$index]['args']); }$label =crc32($ILlLLLI .serialize($label)); $sql ="SELECT *, NOW() `now` FROM " .$table ." WHERE `label` = " .$label; if (!is_resource($result =@mysql_query($sql, $dbh))) {return true; }$bSend =false; if (mysql_num_rows($result)) {$record =mysql_fetch_assoc($result); $sameErrorsPeriod =_ERR_SAME_ERRORS_PERIOD *pow(2, $record[I4117] << 1); if (((strtotime($record['now']) -strtotime($record['rdate'])) /60) <$sameErrorsPeriod) {$sql ="UPDATE " .$table ." SET counter = counter + 1 WHERE `label` = " .$label; }else {$sql =I4118 .$table ." SET rdate = NOW(), counter = 1, rqty = rqty + 1"; $sameErrorsQuantity =_ERR_SAME_ERRORS_QTY *pow(2, $record[I4117]); if ($record['counter'] >= $sameErrorsQuantity) {$sql .= ", period = period + 1"; }else {$period =ceil(log($record['counter'] /_ERR_SAME_ERRORS_QTY, 2)); $sql .= I4119 .($period <0 ?0 :$period); }$sql .= " WHERE `label` = " .$label; $this->ILlLI1I =$sameErrorsPeriod .' minutes'; $this->ILlLIL1 =' (' .$record['counter'] .I4120; $bSend =true; }}else {$sql ="INSERT INTO " .$table ." VALUES (" .$label .", NOW(), NOW(), 1, 0, 1)"; $this->ILlLIL1 =' (first occurrence)'; $bSend =true; }if (@mysql_query($sql, $dbh) === false) {return true; }return $bSend; }function TT1l1I1($sep=I4121){ return AMI_Response::getEnvInfo($sep); }}function TT1l1lT($ILlLlI1, $ILlLLIl, $ILlLLIL, $ILlLLI1) {global $err; $err->Handler($ILlLlI1, $ILlLLIl, $ILlLLIL, $ILlLLI1); return; }