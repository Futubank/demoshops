<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       27555 xkqwsxgxuxqkylkksnwlmqymgutmstkrpkgyixnrrlwgunirluzzkssgstggxulsgpptpnir
 */ ?><?php foreach(array(4298=>"1",4299=>"Mnt",4300=>"rQJZtQS|MtQID",4301=>"IZG",4302=>"SQDWrMYQ?",4303=>"vZJuQ|1",4304=>"?SrHG?",4305=>"|rQfQrQnWQ|",4306=>"ZJtQr?tZYJQ?",4307=>":0",4308=>"DOHC",4309=>".",4310=>"IZxnuI",4311=>"fJZPIZG|SZtZ",4312=>"nZIQ",4313=>"ftBGQ",4314=>"tZYJQ|nuI",4315=>"uGSZtQ?",4316=>"ZJtQr",4317=>'WZtQPHrB',4318=>"fnuI",4319=>"tBGQ|HCnQr",4320=>"|",4321=>"SQJQtQ?frHI?",4322=>"MS",4323=>"FMQJS",4324=>"?zss?vZJuQ|",4325=>"S",4326=>"fJZP",4327=>"WuDtHI|fMQJS|",4328=>"fMQJSD|IZG",4329=>"fMQJSD|WZGtMHnD",4330=>"fMQJSD|DOZrQS",4331=>"DKu|IZG",4332=>"'",4333=>"fMQJSD|DOHC|QIGtB",4334=>"^",4335=>"fMQJSD|fMJtQr",4336=>"'?ZnS?MD|DBD=1",4337=>"GHDtfMx",4338=>"|SZtZDQtD") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class EshopDatasetFunctions extends CMS_Functions{ public $ILLILl1; public $ILLILLI; public $ILLILLl; public $ILLILLL; function EshopDatasetFunctions(&$cms, &$db, &$cModule, &$IlILIl1) {parent::CMS_Functions($cms, $db, $cModule, $IlILIl1); $this->ILLILl1 =4; $this->ILLILLI =sprintf("%0".$this->ILLILl1."d", I4298); $this->ILLILLl =array("char" => "text", "text" => "mediumtext", I4299 => "int(11) not null default '0'", "float" => "double not null default '0.00'", "date" => "datetime not null default '0000-00-00 00:00:00'", "picture" => "varchar(128) not null default ''", "flagmap" => "bigint(64) unsigned not null default 0", I4300 => "text", "related_cats" => "text"); $this->ILLILLL =$this->ILLILLl; $this->ILLILLL["ref_reference"] ="int(11) not null default 0"; }function TT1111l($ILLILL1, $ILLIL1I, $newValue, $tableNum, $ILLIL1l =array()){ if($newValue == "flagmap"){ if(!is_array($ILLIL1l) || !isset($ILLIL1l["map"])) $ILLIL1l =array("map" => ""); $ILLIL1L =max(1, ceil(mb_strlen($ILLIL1l[I4301])/63)); }else $ILLIL1L =1; $newValue =empty($newValue) ?"char" :$newValue; if($ILLIL1I != $newValue && intval($tableNum) >0){ $tableNum =sprintf("%0".$this->ILLILl1."d", $tableNum); $ILLIL11 =array(); $this->db->setSafeSQLOptions("describe"); $sql =I4302.$ILLILL1."_reference_".$tableNum; $this->db->query($sql); while($this->db->next_record()) if(mb_strpos($this->db->Record["Field"], "value_") === 0) $ILLIL11[] =$this->db->Record["Field"]; for($i =0; $i <sizeof($ILLIL11); $i++){ if($ILLIL11[$i] != I4303){ $this->db->setSafeSQLOptions("alter"); $this->db->setSafeSQLOptions("drop"); $sql ="alter table ".$ILLILL1."_reference_".$tableNum.I4304.$ILLIL11[$i]; $this->db->query($sql); }}for($i =1; $i <= $ILLIL1L; $i++){ if(isset($this->ILLILLl[$newValue])){ if(!in_array("value_".$i, $ILLIL11)){ $this->db->setSafeSQLOptions("alter"); $this->db->setSafeSQLOptions("modify"); $sql ="alter table ".$ILLILL1.I4305.$tableNum." ADD value_".$i." ".$this->ILLILLl[$newValue]; $this->db->query($sql); }else{ if($this->ILLILLl[$newValue] != $this->ILLILLl[$ILLIL1I]){ $this->db->setSafeSQLOptions("alter"); $this->db->setSafeSQLOptions("modify"); $sql =I4306.$ILLILL1.I4305.$tableNum." MODIFY value_".$i." ".$this->ILLILLl[$newValue]; $this->db->query($sql); }}}}}}function TT11111($ILLILL1, $cId){ $sql ="select table_num, ftype, flagmap_data from ".$ILLILL1."_ref_types where id=".intval($cId); $this->db->query($sql); if($this->db->next_record()){ $tableNum =sprintf(I4307.$this->ILLILl1."d", $this->db->Record["table_num"]); $ILLI1II =$this->db->Record["ftype"]; $ILLIL1l =$this->db->Record["flagmap_data"]; $this->db->setSafeSQLOptions(I4308); $this->db->setSafeSQLOptions("create"); $sql ="show create table ".$ILLILL1.I4305.$this->ILLILLI; $this->db->query($sql); $this->db->next_record(); $ILLI1Il =$this->db->Record[1]; $ILLI1Il =preg_replace('/^create\s+table\s+(`|\').*?\1/si', "CREATE TABLE IF NOT EXISTS `".$ILLILL1.I4305.$tableNum.I4309, $ILLI1Il); $this->db->setSafeSQLOptions("create"); $sql =$ILLI1Il; $this->db->query($sql); $this->TT1111l($ILLILL1, "", $ILLI1II, $tableNum, $ILLIL1l); }}function TTT1IlI($ILLILL1, &$varsPost, $aSql =Array(), $cId =0){ if($cId == 0){ $sql ="select max(table_num)+1 as maxnum from ".$ILLILL1."_ref_types"; $this->db->query($sql); $this->db->next_record(); $ILLI1IL =intval($this->db->Record[I4310]); if($ILLI1IL == 0) $ILLI1IL =2; }$name =$varsPost["name"]; $default_caption =$varsPost["default_caption"]; if($name != '' && $default_caption != ''){ $aSql =array(I4311 => addslashes(serialize(array($this->IlILIlL->langData => array(I4301 => "", "name" => array()))))); if($cId == 0){ $ILLI1I1 =array(); $ILLI1lI =array(); }else{ $sql ="select name, default_caption, ftype from ".$ILLILL1."_ref_types where id=".intval($cId); $this->db->query($sql); if($this->db->next_record()){ $ILLI1lI =unserialize($this->db->Record[I4312]); if(!is_array($ILLI1lI)) $ILLI1lI =array(); $ILLI1I1 =unserialize($this->db->Record["default_caption"]); if(!is_array($ILLI1I1)) $ILLI1I1 =array(); if($this->db->Record["ftype"] == $varsPost["ftype"]){ unset($aSql[I4311]); }}}$ILLI1lI[$this->IlILIlL->langData] =stripslashes($name); $ILLI1I1[$this->IlILIlL->langData] =stripslashes($default_caption); $aSql += Array( I4312=>addslashes(serialize($ILLI1lI)), "default_caption"=>addslashes(serialize($ILLI1I1)), I4313=>$varsPost[I4313], "sys_alias"=>$varsPost["sys_alias"], "public"=>$varsPost["public"], );if(!empty($varsPost[I4311])){ $aSql[I4311] =$varsPost[I4311]; }if($cId == 0) $aSql[I4314] =$ILLI1IL; }return $aSql; }function TITTTTT($ILLILL1, &$asql){ $res =false; if(!empty($asql)){ $asql["modified_date"] ="=|NOW()"; $sql =$this->db->GenInsertSQL($ILLILL1."_ref_types", $asql); if($this->db->query($sql)) {$appliedId =$this->db->lastInsertId(); $this->TT11111($ILLILL1, $appliedId); $res =true; }}return $res; }function TITTTTI($ILLILL1, $ILLI1ll, $ILLI1lL, &$rec){ $id =intval($rec["id"]); if($id >0 && $ILLI1ll != $ILLI1lL){ $sql =I4315.$ILLILL1."_custom_types set ftype='".$ILLI1lL."'"; $sql .= " where id=".$id; $this->db->query($sql); $sql =""; if(!empty($sql)){ $this->db->setSafeSQLOptions(I4316); $this->db->query($sql); }}}function TITTTTl($ILLILL1, &$rec){ $id =intval($rec["id"]); if($id >0){ $sql =I4315.$ILLILL1."_custom_types set value_type='scalar', ref_table_num='0', default_gui_type='text' where id=".$id; $this->db->query($sql); $this->db->setSafeSQLOptions(I4316); $this->db->setSafeSQLOptions("modify"); if($rec["type_owner"] == I4317){ $sql =I4306.$ILLILL1."_cats modify custom_field_".intval($rec["fnum"])." ".$this->ILLILLL[$rec[I4313]]; }else{ $sql =I4306.$ILLILL1."_items modify custom_field_".intval($rec[I4318])." ".$this->ILLILLL[$rec[I4313]]; }$this->db->query($sql); }}function TITTTT1($ILLILL1, &$rec){ $id =intval($rec["id"]); if($id >0){ $ILLI1l1 ="custom_field_".intval($rec[I4318]); $ILLIL11 =array(); $this->db->setSafeSQLOptions("describe"); if($rec[I4319] == I4317){ $sql =I4302.$ILLILL1."_cats"; }else{ $sql =I4302.$ILLILL1."_items"; }$this->db->query($sql); while($this->db->next_record()) if($ILLI1l1 == $this->db->Record["Field"] || mb_strpos($this->db->Record["Field"], $ILLI1l1.I4320) === 0) $ILLIL11[] =$this->db->Record["Field"]; for($i =0; $i <sizeof($ILLIL11); $i++){ if(!empty($ILLIL11[$i])){ $this->db->setSafeSQLOptions(I4316); $this->db->setSafeSQLOptions("drop"); if($rec[I4319] == I4317){ $sql =I4306.$ILLILL1."_cats drop ".$ILLIL11[$i]; }else{ $sql =I4306.$ILLILL1."_items drop ".$ILLIL11[$i]; }$this->db->query($sql); }}$sql =I4321.$ILLILL1."_custom_types where id=".intval($id); $this->db->query($sql); }}function TITTTIT($ILLILL1, $tableNum, $ILLI1LI, $ILLI1Ll){ $sql ="select id, flagmap_data from ".$ILLILL1."_ref_types where table_num='".intval($tableNum)."'"; $this->db->query($sql); if($this->db->next_record()){ $id =intval($this->db->Record[I4322]); $ILLIL1l =unserialize($this->db->Record[I4311]); $ILLI1LL =1; foreach($ILLIL1l as $lang => $data) $ILLI1LL =max($ILLI1LL, ceil(mb_strlen($data[I4301])/63)); $ILLIL1l[$this->IlILIlL->langData] =array(I4301 => $ILLI1LI, I4312 => $ILLI1Ll); $sql =$this->db->GenUpdateSQL($ILLILL1."_ref_types", array(I4311 => addslashes(serialize($ILLIL1l))), "where id=".$id); $this->db->query($sql); $ILLI1L1 =1; foreach($ILLIL1l as $lang => $data) $ILLI1L1 =max($ILLI1L1, ceil(mb_strlen($data[I4301])/63)); if($ILLI1L1 != $ILLI1LL){ $this->db->setSafeSQLOptions("describe"); $sql =I4302.$ILLILL1.I4305.sprintf(I4307.$this->ILLILl1."d", $tableNum); $this->db->query($sql); while($this->db->next_record()) if(mb_strpos($this->db->Record[I4323], "value_") === 0) $ILLIL11[$this->db->Record[I4323]] =1; if($ILLI1L1 >$ILLI1LL){ for($i =1; $i <= $ILLI1L1; $i++){ if(!isset($ILLIL11["value_".$i])){ $this->db->setSafeSQLOptions(I4316); $this->db->setSafeSQLOptions("add"); $sql =I4306.$ILLILL1.I4305.sprintf(I4307.$this->ILLILl1."d", $tableNum).I4324.$i." ".$this->ILLILLl["flagmap"]; $this->db->query($sql); }}}else{ for($i =$ILLI1L1+1; $i <= $ILLI1LL; $i++){ if(isset($ILLIL11["value_".$i]) && $i >1){ $this->db->setSafeSQLOptions(I4316); $this->db->setSafeSQLOptions("drop"); $sql =I4306.$ILLILL1.I4305.sprintf(I4307.$this->ILLILl1.I4325, $tableNum)." DROP value_".$i; $this->db->query($sql); }}}}}}function TITTTII($ILLILL1, $cId, $ILLI11I, $ILLI1LL){ $ILLI1L1 =1; $sql ="select default_params, type_owner from ".$ILLILL1."_custom_types where id=".intval($cId); $this->db->query($sql); if($this->db->next_record()){ $ILLI11l =$this->db->Record[I4319]; $ILLI11L =unserialize($this->db->Record["default_params"]); if(!is_array($ILLI11L) || !is_array($ILLI11L[I4326])) $ILLI11L =array(I4326 => array()); foreach($ILLI11L[I4326] as $lang => $data) if(is_array($data)) $ILLI1L1 =max($ILLI1L1, ceil(sizeof($data)/63)); }if($ILLI1L1 != $ILLI1LL){ $this->db->setSafeSQLOptions("describe"); if($ILLI11l == I4317){ $sql =I4302.$ILLILL1."_cats"; }else{ $sql =I4302.$ILLILL1."_items"; }$this->db->query($sql); while($this->db->next_record()) if(mb_strpos($this->db->Record[I4323], "custom_field_") === 0) $ILLIL11[$this->db->Record[I4323]] =1; if($ILLI1L1 >$ILLI1LL){ for($i =1; $i <= $ILLI1L1; $i++){ if(!isset($ILLIL11[I4327.$ILLI11I.I4320.$i])){ $this->db->setSafeSQLOptions(I4316); $this->db->setSafeSQLOptions("add"); if($ILLI11l == I4317){ $sql =I4306.$ILLILL1."_cats ADD custom_field_".$ILLI11I.I4320.$i." ".$this->ILLILLl["flagmap"]; }else{ $sql =I4306.$ILLILL1."_items ADD custom_field_".$ILLI11I.I4320.$i." ".$this->ILLILLl["flagmap"]; }$this->db->query($sql); }}}else{ for($i =$ILLI1L1+1; $i <= $ILLI1LL; $i++){ if(isset($ILLIL11[I4327.$ILLI11I.I4320.$i]) && $i >1){ $this->db->setSafeSQLOptions(I4316); $this->db->setSafeSQLOptions("drop"); if($ILLI11l == I4317){ $sql =I4306.$ILLILL1."_cats DROP custom_field_".$ILLI11I.I4320.$i; }else{ $sql =I4306.$ILLILL1."_items DROP custom_field_".$ILLI11I.I4320.$i; }$this->db->query($sql); }}}}}function TITTTIl($ILLILL1, $cId){ $db2 =new DB_si; $sql ="select * from ".$ILLILL1."_datasets where fields_map like '%;".intval($cId).";%'"; $this->db->query($sql); while($this->db->next_record()){ $ILLI111 =array("fields_map" => $this->db->Record[I4328], "fields_captions" => $this->db->Record["fields_captions"]); $ILLI111[I4328] =str_replace(";".intval($cId), "", $ILLI111[I4328]); $captions =unserialize($ILLI111[I4329]); unset($captions[intval($cId)]); $ILLI111[I4329] =addslashes(serialize($captions)); $sql =$db2->GenUpdateSQL($ILLILL1."_datasets", $ILLI111, "WHERE id=".intval($this->db->Record[I4322])); $db2->query($sql); AMI_Eshop::updateCatProps(substr($ILLILL1, 4), null, intval($this->db->Record[I4322])); $ILLI111[I4329] =stripslashes($ILLI111[I4329]); $ILLlIII =array_merge($this->db->Record, $ILLI111); $this->TITTTlT($ILLILL1, $this->db->Record[I4322], $ILLlIII); }}function TITTTI1($ILLILL1, $cId){ $sql =I4315.$ILLILL1."_cats set dataset_id=0, dataset_data='', has_props=0 where dataset_id=".intval($cId); $this->db->query($sql); }function TITTTlT($ILLILL1, $cId, $ILLlIII =null){ if(!is_array($cId)){ if(!is_null($ILLlIII) && !isset($ILLlIII[$cId])){ $ILLlIII[$cId] =$ILLlIII; }$cId =array($cId); }if(sizeof($cId) >0){ $db2 =new DB_si; if(is_null($ILLlIII)){ $ILLlIII =array(); $sql ="select * from ".$ILLILL1."_datasets d where d.id in ('".implode("','", $cId)."')"; $db2->query($sql); while($db2->next_record()){ $ILLlIII[$db2->Record[I4322]] =$db2->Record; }}if(is_array($ILLlIII)){ foreach($ILLlIII as $datasetId => $ILLlIIl){ $ILLlIIl =addslashes(serialize(array( "postfix" => $ILLlIIl["postfix"], I4312 => $ILLlIIl[I4312], I4328 => $ILLlIIl[I4328], I4330 => $ILLlIIl[I4330], "fields_filter" => $ILLlIIl["fields_filter"], "fields_show_empty" => $ILLlIIl["fields_show_empty"], I4329 => unserialize($ILLlIIl[I4329]), I4331 => $ILLlIIl[I4331]))); $sql =I4315.$ILLILL1."_cats set dataset_data='".$ILLlIIl."' where dataset_id=".intval($datasetId); $db2->query($sql); AMI_Eshop::updateCatProps(substr($ILLILL1, 4), null, intval($cId)); }}}}function TITTTlI(&$ILLlIIL, $ILLILL1, $cId, $IllLIIL){ $sql ="select * from ".$ILLILL1."_datasets where lang='".$this->IlILIlL->langData.I4332; $this->db->query($sql); $ILLlII1 =array(); $ILLlIlI =array(); $ILLlIll =false; $isFirst =true; while($this->db->next_record()){ if($isFirst){ if(mb_strpos($this->db->Record[I4330], ";".$cId.";") !== false) $ILLlIll =true; $isFirst =false; }$ILLlII1[] =array(I4322 => $this->db->Record[I4322], I4328 => $this->db->Record[I4328], I4330 => $this->db->Record[I4330], I4329 => unserialize($this->db->Record[I4329]), "fields_filter" => $this->db->Record["fields_filter"], I4333 => $this->db->Record[I4333]); }if($ILLlIll && count($ILLlIIL) == count($ILLlII1)){ return; }for($i =0; $i <count($ILLlII1); $i++){ $isChanged =false; if($ILLlIll){ $isChanged =true; $ILLlII1[$i][I4330] =str_replace(";".$cId.";", ";", $ILLlII1[$i][I4330]); }if(mb_strpos($ILLlII1[$i][I4328], ";".$cId.I4334) !== false){ if(!in_array($ILLlII1[$i][I4322], $ILLlIIL)){ $isChanged =true; $ILLlII1[$i][I4328] =str_replace(I4334.$cId.I4334, I4334, $ILLlII1[$i][I4328]); $ILLlII1[$i]["fields_filter"] =str_replace(I4334.$cId.I4334, I4334, $ILLlII1[$i]["fields_filter"]); $ILLlII1[$i][I4333] =str_replace(I4334.$cId.I4334, I4334, $ILLlII1[$i][I4333]); unset($ILLlII1[$i][I4329][$cId]); }}else{ if(in_array($ILLlII1[$i][I4322], $ILLlIIL)){ $isChanged =true; $ILLlII1[$i][I4328] .= (empty($ILLlII1[$i][I4328]) ?I4334 :"").$cId.I4334; $ILLlII1[$i][I4329][$cId] =$IllLIIL; }}if($isChanged){ if(!in_array($ILLlII1[$i][I4322], $ILLlIIL)) $ILLlIIL[] =$ILLlII1[$i][I4322]; $ILLlIlL =array(I4328 => $ILLlII1[$i][I4328], I4330 => $ILLlII1[$i][I4330], "fields_filter" => $ILLlII1[$i][I4335], I4333 => $ILLlII1[$i][I4333], I4329 => addslashes(serialize($ILLlII1[$i][I4329]))); $sql =$this->db->GenUpdateSql($ILLILL1."_datasets", $ILLlIlL, "where id=".$ILLlII1[$i][I4322]); $this->db->query($sql); }}}function TITTTll($ILLILL1){ $sql ="select count(*) as count from ".$ILLILL1."_datasets where lang='".$this->IlILIlL->langData.I4336; $this->db->query($sql); $this->db->next_record(); if($this->db->Record["count"] >0){ return; }$ILLlIl1 =array(I4312 => $this->IlILIlL->words["dataset_system"], "lang" => $this->IlILIlL->langData, "is_sys" => I4298, I4337 => "_system"); $sql ="select fields_shared, fields_captions from ".$ILLILL1."_datasets where lang='".$this->IlILIlL->langData."' limit 1"; $this->db->query($sql); if($this->db->next_record()){ $ILLlIl1[I4330] =$ILLlIl1[I4328] =$this->db->Record[I4330]; $ILLlIl1[I4329] =addslashes($this->db->Record[I4329]); }$sql =$this->db->GenInsertSql($ILLILL1.I4338, $ILLlIl1); $this->db->query($sql); $ILLlILI =$this->db->lastInsertId(); $ILLlILl =addslashes(serialize(array( I4337 => $ILLlIl1[I4337], I4312 => $ILLlIl1[I4312], I4328 => $ILLlIl1[I4328], I4330 => $ILLlIl1[I4330], I4335 => $ILLlIl1[I4335], I4333 => $ILLlIl1[I4333], I4329 => unserialize(stripslashes($ILLlIl1[I4329])), I4331 => $ILLlIl1[I4331]))); $sql =$this->db->GenUpdateSql($ILLILL1."_cats", array("dataset_id" => $ILLlILI, "dataset_data" => $ILLlILl), "where dataset_id<=0 && lang='".$this->IlILIlL->langData.I4332); $this->db->query($sql); }}