<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       25538 xkqwwiilztqqlxgipqltpgsqkgpsilitnmtnymksyunstnyulnxqnlpzmqnsxrykkgtlpnir
 */ ?><?php foreach(array(4339=>"MtQI|tBGQ",4340=>"WHunt|ZJJ",4341=>"fMJQD|DMAQ",4342=>"DMAQ",4343=>"'",4344=>"fMJQ|MSD",4345=>"'?coqRq?MS?mN}'",4346=>"nHnQ",4347=>"",4348=>"HrSQr|ZWtMHn|ZGGJB",4349=>"YQfHrQ|HrSQr|ZGGJB",4350=>"WHnf",4351=>"fMJQ|MS",4352=>"Qxt|SZtZ",4353=>"SHCnJHZS|ZttQIGtD",4354=>"QDOHG|SMPMtZJD",4355=>"'?zNs?MS|GrHSuWt='",4356=>"GOG",4357=>"ZqDOHGFMJQD",4358=>"<s00000",4359=>"MS",4360=>"QxtsZtZ",4361=>"MnMtMZJ",4362=>"YHSB|CQJWHIQ",4363=>"YHSB|MtQIs",4364=>"ftGPQtfMJQ`GOG IHSuJQ=QDOHG]MS=:S",4365=>"nZIQ",4366=>"MtQI",4367=>"YHSB|WZtD",4368=>"WHunt",4369=>"HrSQr|MS",4370=>"SHCnJHZS|DtZtuD",4371=>"HnZIQ",4372=>"fMJQDMAQ",4373=>"ftGPQtfMJQ`GOG IHSuJQ=QDOHG]MS=:S]HrSQr|MS=",4374=>"HrSQr|OMDtHrB|JMDt",4375=>"fMJQnZIQ",4376=>"SQDWr",4377=>"fDMAQ",4378=>"rQDt",4379=>"QDOHG|SMPMtZJD|WHJ",4380=>"tQIGJZtQgHDtfMx",4381=>"?jqFT?lhmN?") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class EshopDigitals extends EshopExtention {function EshopDigitals() {parent::EshopExtention(); }function processAction($action, $cId, &$itemData, &$addParams) {parent::processAction($action, $cId, $itemData, $addParams); switch($action) {case "before_add": case "before_apply": if($this->cms->VarsPost[I4339] == $this->modName) {$itemData["shipping"] =0; if($this->TITTT1T($cId)) {$ILLlILL =$this->TITTT1I($cId); $itemData["num_files"] =$ILLlILL["count"]; $itemData["num_files_all"] =$ILLlILL[I4340]; $itemData["files_size"] =$ILLlILL["size"]; }}else {$this->TITTTl1($cId); $itemData["num_files"] =0; $itemData["num_files_all"] =0; $itemData[I4341] =0; }break; case "after_add": if($this->cms->VarsPost[I4339] == $this->modName) {if($this->TITTT1T($cId)) {$ILLlILL =$this->TITTT1I($cId); $itemData["num_files"] =$ILLlILL["count"]; $itemData["num_files_all"] =$ILLlILL[I4340]; $itemData[I4341] =$ILLlILL[I4342]; }}break; case "before_ssapply_add": $itemData["num_files"] =0; $itemData[I4341] =0; $itemData["num_files_all"] =0; if($itemData[I4339] == $this->modName) {$itemData["shipping"] =0; }case "before_ssapply_apply": break; }}function TITTTl1($cId) {$ILLlIL1 =false; if(is_array($cId)) {if(sizeof($cId) >0) {$cId =implode("','", $cId); }else {$ILLlIL1 =true; }}if(!$ILLlIL1) {$sql ="UPDATE ".$this->oEshop->dbTablePrefix."_files SET id_product='0' WHERE id_product IN('".$cId."') AND lang='".$this->oEshop->langData.I4343; $this->oEshop->db->query($sql); }}function TITTT1T($cId) {$res =false; if(isset($this->cms->Vars["file_ids"]) && $this->cms->Vars["file_ids"] != "") {$aFileIds =explode(",", $this->cms->Vars[I4344]); $ILLlI1I =""; if(is_array($aFileIds) && sizeof($aFileIds) >0) {$ILLlI1I =implode("','", $aFileIds); $sql ="UPDATE ".$this->oEshop->dbTablePrefix."_files SET id_product='".$cId.I4345.$ILLlI1I."') AND lang='".$this->oEshop->langData.I4343; $this->oEshop->db->query($sql); $res =true; }}return $res; }function TITTT1I($cId) {require_once $GLOBALS['FUNC_INCLUDES_PATH'] .'func_eshop.php'; return TlTl1TT($this->oEshop->db, $cId, $this->oEshop->langData, $this->oEshop->dbTablePrefix); }}class EshopDigitalsAdmin extends EshopDigitals {public $ILLlI1l; function TT11ll1($action, &$vData) {if($action == "add" || $action == I4346) {$vData["num_files"] =0; }if(isset($vData["num_files"]) && $vData['num_files'] >0){ $vData["eshop_digitals_icon_add"] =I4346; $vData["eshop_digitals_icon_edit"] ="inline"; }else {$vData["eshop_digitals_icon_add"] ="inline"; $vData["eshop_digitals_icon_edit"] =I4346; }parent::TT11ll1($action, $vData); }function TT11l1T(&$vData, &$aCustom) {$aCustom["eshop_digitals_header"] =$this->cms->Gui->get($this->oEshop->ownerName."_item_list:eshop_digitals_header", $GLOBALS["NONE"]); }function TT11lll($pageType, &$aItem, &$aData) {if($aItem[I4339] != "eshop_digitals") {$aItem["num_files"] =I4347; }$aItem["eshop_digitals_col"] =$this->cms->Gui->get($this->oEshop->ownerName."_item_list:eshop_digitals_col", $aItem); }function TT11l1I($tableAlias, $type) {return ", ".$tableAlias."num_files, ".$tableAlias.I4341; }function TT11l1l($IIL1II1, &$result) {switch($IIL1II1) {case I4348: $result["select"] .= ", count(oi.id_product) as num_items"; $result["join"] .= " LEFT JOIN ".$this->oEshop->dbTablePrefix."_order_items AS oi ON o.id=oi.id_order "; $result["group"] .= " GROUP BY oi.id_order "; break; }}function processAction($action, $cId, &$itemData, &$addParams) {parent::processAction($action, $cId, $itemData, $addParams); switch($action) {case "edit": break; case "after_del": if($itemData[I4339] == $this->modName) {$this->TITTTl1($cId); }break; case I4349: if(isset($addParams["extData"]["eshop_digitals"]["expire"])) {$udate =DateTools::getCorrectUDate($this->cms->VarsPost["expire_date"], $this->cms->DFMT[I4350]); $addParams["extData"]["eshop_digitals"]["expire"] =$udate; }break; case "after_order_apply": $maxAttempts =$this->module->GetOption("max_download_attempts"); for($i=1;$i<=$addParams["numItems"];$i++) {if(isset($this->cms->VarsPost["id".$i]) && $this->cms->VarsPost["id".$i] >0) {$ILLlI1L =$this->cms->VarsPost["id".$i]; if(is_array($this->cms->VarsPost[I4351.$ILLlI1L]) && sizeof($this->cms->VarsPost[I4351.$ILLlI1L]) >0) {$sql ="SELECT ext_data FROM ".$this->oEshop->dbTablePrefix."_order_items WHERE id_order='".$this->cms->Vars["id"]."' AND id_product='".$ILLlI1L.I4343; $this->oEshop->db->query($sql); if($this->oEshop->db->next_record()) {$aExtData =unserialize($this->oEshop->db->Record[I4352]); $ILLlI11 =Array(); $isChanged =false; foreach($this->cms->VarsPost[I4351.$ILLlI1L] as $key=>$fileId) {if(isset($this->cms->VarsPost["number_attempts".$fileId]) && $this->cms->VarsPost["number_attempts".$fileId] != $this->cms->VarsPost["number_attempts_old".$fileId]) {$aExtData["eshop_digitals"][I4353][$fileId]["rest"] =intval($this->cms->VarsPost["number_attempts".$fileId]); if(!isset($aExtData["eshop_digitals"][I4353][$fileId]["initial"])) {$aExtData[I4354][I4353][$fileId]["initial"] =$maxAttempts; }$isChanged =true; }}if($isChanged) {$asql =Array(I4352=>addslashes(serialize($aExtData))); $sql =$this->oEshop->db->GenUpdateSQL($this->oEshop->dbTablePrefix."_order_items", $asql, "WHERE id_order='".$this->cms->Vars["id"].I4355.$ILLlI1L.I4343); $this->oEshop->db->query($sql); }}}}}break; }}function TT11l11($pageType, &$aItem, &$aData) {switch($pageType) {case "order_edit": if(isset($aData["oExtData"][I4354]["expire"])) {$aItem["eshop_digitals_expire"] =date($this->cms->DFMT[I4356], $aData["oExtData"][I4354]["expire"]); $aItem["eshop_digitals_expire"] =$this->cms->Gui->get($this->cms->ActiveModule."_subform:eshop_digitals_expire", $aItem); }$db2 =new DB_si; $sql ="SELECT id_product, id, original_fname FROM ".$this->oEshop->dbTablePrefix."_files WHERE id_product IN('".implode("','", $aData["itemIds"])."') AND active=1"; $db2->query($sql); $this->ILLlI1l[I4357] =Array(); while($db2->next_record()) {$this->ILLlI1l[I4357][$db2->Record["id_product"]][$db2->Record["id"]] =Array("name"=>$db2->Record["original_fname"]); }$aItem["eshop_digitals_header"] =$this->cms->Gui->getAbs($this->cms->ActiveModule."_subform:eshop_digitals_header", I4347); $aItem["eshop_digitals_legend"] =$this->cms->Gui->getAbs($this->cms->ActiveModule."_list:leg_darkgreen_eshop",I4347); $aItem["eshop_digitals_legend"] .= $this->cms->Gui->getAbs($this->cms->ActiveModule."_list:leg_darkred_eshop",I4347); break; }}function TT111TT($pageType, &$aItem, &$aData) {switch($pageType) {case "order_edit": $aItemFiles =$this->ILLlI1l[I4357][$aData["id"]]; $aStoredInfo =$aData["extData"]["ext_info"][I4354]; if(sizeof($aStoredInfo) >0 && sizeof($aItemFiles)) {$aTmpItems =$aStoredInfo +$aItemFiles; }elseif(sizeof($aStoredInfo) >0) {$aTmpItems =&$aStoredInfo; }elseif(sizeof($aItemFiles) >0) {$aTmpItems =&$aItemFiles; }else {$aTmpItems =Array(); }if(sizeof($aTmpItems) >0) {$aItem["eshop_digitals_rows"] =I4347; foreach($aTmpItems as $fileId=>$fileInfo) {$fileData =Array(); $fileData["atempts_disabled"] =I4347; if(isset($aStoredInfo[$fileId])) {if(isset($aItemFiles[$fileId])) {$fileData["name_color"] ="#000000"; unset($aItemFiles[$fileId]); }else {$fileData["name_color"] =I4358; $fileData["atempts_disabled"] ="disabled"; }}else {$fileData["name_color"] ="#00A000"; }$fileData[I4359] =$aItem[I4359]; $fileData[I4351] =$fileId; $fileData["filename"] =$fileInfo["name"]; $fileData["short_filename"] =$this->cms->stripLine($fileInfo["name"], 32); if(isset($aData[I4360][I4354][I4353][$fileId]["rest"])) {$fileData["number_attempts"] =$aData[I4360][I4354][I4353][$fileId]["rest"]; $fileData["number_initial_attempts"] =$aData[I4360][I4354][I4353][$fileId][I4361]; }else {$fileData["number_initial_attempts"] =$fileData["number_attempts"] =$this->module->GetOption("max_download_attempts"); }$aItem["eshop_digitals_rows"] .= $this->cms->Gui->get($this->cms->ActiveModule."_subform:eshop_digitals_row", $fileData); }$aItem["eshop_digitals_col"] =$this->cms->Gui->get($this->cms->ActiveModule."_subform:eshop_digitals_col", $aItem); }else {$aItem["eshop_digitals_col"] =$this->cms->Gui->get($this->cms->ActiveModule."_subform:eshop_digitals_col_na", $aItem); }break; }}}class EshopDigitalsFront extends EshopDigitals {public $ILLlI1l; function TT11lll($pageType, &$aItem, &$aData) {if($aItem[I4339] == $this->modName) {switch($pageType) {case I4362: case "spec_body_welcome": if($pageType == I4362) {$ILLllII ="special"; }else {$ILLllII ="small_special"; }$aData["eshop_digitals_count"] =$this->cms->TTITI1l($ILLllII, "eshop_digitals_count", Array("eshop_digitals_count"=>$aItem["num_files"])); if($aItem[I4341] <0) {$aData["eshop_digitals_size"] =I4347; }else {$aData["eshop_digitals_size"] =$this->cms->TTITI1l($ILLllII, "eshop_digitals_size", Array("eshop_digitals_size"=>number_format($aItem[I4341]/1024,0,I4347," "))); }$aData["eshop_digitals_info"] =$this->cms->TTITI1l($ILLllII, "eshop_digitals_info", $aData); break; case I4363: $sql ="SELECT id_product, free_download, id, original_fname, name, description, filesize FROM ".$this->oEshop->dbTablePrefix."_files WHERE id_product='".$aItem[I4359]."' AND active=1"; $this->oEshop->db->query($sql); $firstIter =true; $aData["eshop_digitals_rows"] =I4347; $ILLllIl =I4364; while($this->oEshop->db->next_record()) {$name =$this->oEshop->db->Record[I4365]; if(empty($name)) {$name =$this->oEshop->db->Record["original_fname"]; }$fileData =Array(); $fileData[I4365] =$name; if($this->oEshop->db->Record["free_download"]) {$ILLllII ="eshop_digitals_lname"; $fileData["get_file_link"] =sprintf($ILLllIl, $this->oEshop->db->Record[I4359]); }else {$ILLllII ="eshop_digitals_name"; }$fileData["eshop_digitals_name"] =$this->cms->TTITI1l("item", $ILLllII, Array("eshop_digitals_name"=>$name) +$fileData); $fileData["eshop_digitals_descr"] =$this->cms->TTITI1l(I4366, "eshop_digitals_descr", Array("eshop_digitals_descr"=>$this->oEshop->db->Record["description"])); $fileData["eshop_digitals_fname"] =$this->cms->TTITI1l(I4366, "eshop_digitals_fname", Array("eshop_digitals_fname"=>$this->oEshop->db->Record["original_fname"])); if($this->oEshop->db->Record["filesize"] <0) {$fileData["eshop_digitals_size"] =I4347; }else {$fileData["eshop_digitals_size"] =$this->cms->TTITI1l(I4366, "eshop_digitals_size", Array("eshop_digitals_size"=>number_format($this->oEshop->db->Record["filesize"]/1024,0,I4347," "))); }$aData["eshop_digitals_rows"] .= $this->cms->TTITI1l("itemD", "eshop_digitals_row", $fileData); if($firstIter) {$firstIter =false; }else {$aData["eshop_digitals_rows"] .= $this->cms->TTITI1l("itemD", "eshop_digitals_splitter", I4347); }}$aData["eshop_digitals_info"] =$this->cms->TTITI1l("itemD", "eshop_digitals_info", $aData); break; case "body_items": case I4367: $aData["eshop_digitals_count"] =$this->cms->TTITI1l(I4366, "eshop_digitals_count", Array("eshop_digitals_count"=>$aItem["num_files"])); if($aItem[I4341] <0) {$aData["eshop_digitals_size"] =I4347; }else {$aData["eshop_digitals_size"] =$this->cms->TTITI1l(I4366, "eshop_digitals_size", Array("eshop_digitals_size"=>number_format($aItem[I4341]/1024,0,I4347," "))); }$aData['eshop_digitals_info'] =$this->cms->TTITI1l('item', 'eshop_digitals_info', $aData); break; case "pricelist_catitems": $aData["eshop_digitals_count"] =$this->cms->TTITI1l(I4354, I4368, Array("eshop_digitals_count"=>$aItem["num_files"])); if($aItem[I4341] <0) {$aData["eshop_digitals_size"] =I4347; }else {$aData["eshop_digitals_size"] =$this->cms->TTITI1l(I4354, I4342, Array("eshop_digitals_size"=>number_format($aItem[I4341]/1024,0,I4347," "))); }$aData["eshop_digitals_info"] =$this->cms->TTITI1l(I4354, "info", $aData); break; }}}function TT11l11($pageType, &$aItem, &$aData) {switch($pageType) {case "order_history_list": $orderId =$aData[I4369]; $this->ILLlI1l["expireTime"] =intval($aData["oExtData"][I4354]["expire"]); $this->ILLlI1l["currentTime"] =time(); $ILLllIL =$this->module->GetOption(I4370); if(is_array($ILLllIL)) {$this->ILLlI1l["downloadStatusOk"] =in_array($aData["status"], $ILLllIL); }else {$this->ILLlI1l["downloadStatusOk"] =($aData["status"] == $ILLllIL); }$sql ="SELECT id_product, id, original_fname, name, description, filesize FROM ".$this->oEshop->dbTablePrefix."_files WHERE id_product IN('".$aData["itemIds"]."') AND active=1"; $this->oEshop->db->query($sql); $aEshopFiles =Array(); while($this->oEshop->db->next_record()) {$aEshopFiles[$this->oEshop->db->Record["id_product"]][] =Array(I4359=>$this->oEshop->db->Record[I4359], I4371=>$this->oEshop->db->Record["original_fname"], I4365=>$this->oEshop->db->Record[I4365], "descr"=>$this->oEshop->db->Record["description"], "fsize"=>$this->oEshop->db->Record[I4372]); }$this->ILLlI1l[I4357] =$aEshopFiles; $aItem["item_eshop_digitals_header"] =$this->cms->TTITI1l(I4366, "eshop_digitals_header", I4347); if(isset($oExtData[I4354]["expire"])) {$aItem["eshop_digitals_expire"] =$this->cms->TTITI1l(I4366, "eshop_digitals_expire", Array("expire_date"=>date($this->cms->DFMT[I4356], $oExtData[I4354]["expire"]))); }$this->ILLlI1l["getFileLink"] =I4373.$orderId."&item_id=%d&lang=".$this->oEshop->langData; break; }}function TT111TT($pageType, &$aItem, &$aData) {switch($pageType) {case I4374: $itemId =$aItem[I4359]; $aItemFiles =$this->ILLlI1l[I4357][$aData["id_product"]]; if(sizeof($aItemFiles) >0) {$aItem["eshop_digitals_rows"] =I4347; $firstIter =true; foreach($aItemFiles as $key=>$fileInfo) {$fileData =Array(); $fileData["filename"] =$this->cms->TTITI1l(I4366, "eshop_digitals_fname", Array(I4375=>$fileInfo[I4371])); $fileData[I4365] =$this->cms->TTITI1l(I4366, "eshop_digitals_name", Array(I4365=>$fileInfo[I4365])); $fileData["descr"] =$this->cms->TTITI1l(I4366, "eshop_digitals_descr", Array("descr"=>$fileInfo[I4376])); if($fileInfo["fsize"] <0) {$fileData["fsize"] =I4347; }else {$fileData["fsize"] =$this->cms->TTITI1l(I4366, "eshop_digitals_fsize", Array(I4377=>number_format($fileInfo[I4377]/1024,0,I4347," "))); }if($firstIter) {$firstIter =false; }else {$aItem["eshop_digitals_rows"] .= $this->cms->TTITI1l(I4366, "eshop_digitals_splitter", I4347); }if($this->ILLlI1l["downloadStatusOk"] && ((!isset($aData[I4352][I4354][I4353][$fileInfo[I4359]][I4378]) || (isset($aData[I4352][I4354][I4353][$fileInfo[I4359]][I4378]) && $aData[I4352][I4354][I4353][$fileInfo[I4359]][I4378] >0)) && $this->ILLlI1l["expireTime"] >$this->ILLlI1l["currentTime"])) {$fileData["get_file_link"] =sprintf($this->ILLlI1l["getFileLink"], $fileInfo[I4359], $itemId); $aItem["eshop_digitals_rows"] .= $this->cms->TTITI1l(I4366, "eshop_digitals_lrow", $fileData); }else {$aItem["eshop_digitals_rows"] .= $this->cms->TTITI1l(I4366, "eshop_digitals_row", $fileData); }}$aItem["item_eshop_digitals_col"] =$this->cms->TTITI1l(I4366, I4379, $aItem); }else {$aItem["item_eshop_digitals_col"] =$this->cms->TTITI1l(I4366, "eshop_digitals_col_na", I4347); }break; case "order_notify_email": $aItem[$this->modName] =$this->cms->Gui->get("es_order_mail:order_".$this->modName.$aData[I4380]."_".$this->oEshop->langData, $aData); break; }}function TT11l1l($IIL1II1, &$result) {switch($IIL1II1) {case I4374: $result["select"] .= ", i.item_type"; $result["join"] .= I4381.$this->oEshop->dbTablePrefix."_items i ON i.id=oi.id_product"; break; }}}?>