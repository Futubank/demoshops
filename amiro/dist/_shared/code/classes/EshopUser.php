<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       14195 xkqwgxkkiqtspwplikpginqrmliwtpunurpknqwqgtsuxylunzluqytlpxqsxynlqtqgpnir
 */ ?><?php foreach(array(4515=>'',4516=>'MS|QxtQrnZJ',4517=>'SMDWHunt|tBGQ',4518=>'QDOHG|SMDWHunt',4519=>"dqjqwT?MS?FRhi?",4520=>"|uDQrD",4521=>"dqjqwT?1?FRhi?",4522=>"ZWtMvQ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class EshopUser extends CMS_Member {public $Cart; public $ILLLIL1; public $dbTablePrefix; function EshopUser(&$sess, $IIIL1ll ="eshop_user", $ILLLI1I ="cart") {$this->ILLLIL1 =$ILLLI1I; parent::CMS_Member($sess, $IIIL1ll); }function SetDbTablePrefix($dbTablePrefix) {$this->dbTablePrefix =$dbTablePrefix; }function createUser(&$cms, &$db, $data, $sendMail =false, $update =true, $genData =I4515){ $res =0; $id_member =$this->checkUsername($db, $data["username"]); $data['eshop_discount'] =(double)$data['eshop_discount']; list($day, $month, $year) =explode(".", $data['eshop_discount_exp_date']); if(!$year || !$month || !$day || !checkdate($month, $day, $year)){ $data['eshop_discount_exp_date'] =null; }if($data['eshop_discount'] <0 || $data['eshop_discount'] >100){ $data['eshop_discount'] =0; $data['eshop_discount_exp_date'] =null; }$data['eshop_discount_exp_date']="$year-$month-$day"; $ILLLI1l =$this->UsedFields; $this->setUsed(array('eshop_discount', 'eshop_discount_type'), true); if($id_member >0){ $sql ="SELECT id FROM ".$this->dbTablePrefix."_users WHERE id_member='" .$id_member ."'"; $db->query($sql); $add =!$db->next_record(); $userData =$update ?$data :array('eshop_discount' => $data['eshop_discount'],'eshop_discount_exp_date' => $data['eshop_discount_exp_date'], 'eshop_discount_type' => $data['eshop_discount_type']); $this->updateMember($cms, $db, $id_member, $userData, true); }else{ $add =$this->createMember($cms, $db, $data, $sendMail, $genData); $id_member =$db->lastInsertId(); }if($add){ $aSQL =array( 'id_member' => $id_member, 'active' => 1, I4516 => $data[I4516], 'discount' => $data['eshop_discount'], 'discount_exp_date' => $data['eshop_discount_exp_date'], I4517 => 'percent' );$sql =$db->genInsertSQL($this->dbTablePrefix .'_users', $aSQL); $db->execute($sql); $res =$id_member; }$this->UsedFields =$ILLLI1l; return $res; }function TTTT1T1(&$cms, &$db, $id, $data, $IIIL1lL =false) {global $lang_data; $res =0; $balance =$data["balance"]; $currency =$data["currency"]; $data[I4518] =(double)$data[I4518]; list($day, $month, $year) =explode(".", $data['eshop_discount_exp_date']); if(!$year || !$month || !$day || !checkdate($month, $day, $year)){ $data['eshop_discount_exp_date'] =null; }$data[I4518] =(double)$data[I4518]; if($data[I4518] <0 || $data[I4518] >100){ $data[I4518] =0; }$data['eshop_discount_exp_date']="$year-$month-$day"; $ILLLI1l =$this->UsedFields; $this->setUsed(array(I4518, 'eshop_discount_type', 'eshop_discount_exp_date'), true); if($this->updateMember($cms, $db, $id, $data, $IIIL1lL)) {$this->updateBalance($db, $id, $balance, $currency, true, "admin"); $aSQL =array( 'discount' => $data[I4518], 'discount_exp_date' => $data['eshop_discount_exp_date'], I4517 => 'percent' );$sql =$db->GenUpdateSQL($this->dbTablePrefix .'_users', $aSQL, "WHERE `id_member` = " .intval($id)); $db->execute($sql); $res =$id; }$this->UsedFields =$ILLLI1l; return $res; }function replaceUser(&$cms, &$db, $id, $active) {$asql =Array( "active" => $active );$sql =I4519.$this->dbTablePrefix."_users WHERE id_member='$id'"; $db->query($sql); if($db->next_record()) {$sql =$db->GenUpdateSQL($this->dbTablePrefix."_users", $asql, "WHERE id_member='".$id."'"); }else {$asql["id_member"] =$id; $sql =$db->GenInsertSQL($this->dbTablePrefix.I4520, $asql); }$db->query($sql); }function TTTT1IT(&$cms, &$db, $id) {$sql ="DELETE FROM ".$this->dbTablePrefix."_users WHERE id_member='$id'"; $db->query($sql); parent::TTI1lTl($cms, $db, $id); }function TTTT1II(&$cms, &$db, $id, $active) {$res =false; $sql ="SELECT active FROM cms_members WHERE id='$id'"; $db->query($sql); if($active=="0" || ($db->next_record() && $db->Record["active"]==1)) {$sql ="UPDATE ".$this->dbTablePrefix."_users SET active='$active' WHERE id_member='$id'"; $db->query($sql); $res =true; }return $res; }function TT1I1Tl(&$cms, &$db, $id, $status) {$res =false; $sql =I4521.$this->dbTablePrefix."_users WHERE id_member='$id'"; $db->query($sql); if(!$db->next_record()) {$sql ="INSERT INTO ".$this->dbTablePrefix."_users (id_member, active) VALUES ('$id', '0')"; $db->query($sql); }$res =$this->TTTT1II($cms, $db, $id, $status); return $res; }function TT1I1T1(&$cms, &$db, $id =0) {if(empty($id)) {$id =$this->User["id"]; }$sql ="SELECT (cm.active & ceu.active) as active FROM cms_members cm ". "INNER JOIN ".$this->dbTablePrefix."_users ceu ON ceu.id_member=cm.id WHERE cm.id='$id'"; $db->query($sql); $db->next_record(); $res =($db->Record[I4522] == 1); return $res; }function TITTI1l() {if(is_object($this->Session)) {$this->Cart->onSerialize(true); $this->Session->SetVar($this->ILLLIL1, $this->Cart); }else {trigger_error("EshopUser::storeCart session is not object", E_USER_WARNING); }}}