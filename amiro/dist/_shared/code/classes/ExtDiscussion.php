<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       22122 xkqwtzgqlintrswsuiipmgugliurpuxgyuqqzxmntmuytnuqllqrgyuxyusuyrixpxuspnir
 */ ?><?php foreach(array(4623=>'1',4624=>'?WOQWKQS',4625=>'WZJJYZWK',4626=>'fMQJSD',4627=>'|pQtRQGJMQDwHuntwy',4628=>'SMDZYJQ|WHIIQntD',4629=>'fHruI|ZSS',4630=>'DBD',4631=>'ZDW',4632=>'ZWtMHn',4633=>'SQJ',4634=>"coqRq?.MS|Qxt|IHSuJQ.?=?",4635=>"?zNs?.Qxt|IHSuJQ.?=?'",4636=>'ZSIMn',4637=>'JHWZtQ',4638=>'JMDt',4639=>'GZPQ|MtQI|tBGQ',4640=>'IQtOHS',4641=>'YHSB|WZtD',4642=>'|pQtFHruIsQtZMJDwy',4643=>"WZJJYZWK",4644=>'QDOHG|MtQI',4645=>'rQGJMQD',4646=>"MtQI|JMnKD|ZJJHCQS",4647=>'MS|DHurWQ',4648=>'MS',4649=>'nHMnSQx',4650=>"fHruI|JMnK",4651=>'',4652=>"dqjqwT?.MS|Qxt|IHSuJQ.!?.WHunt|GuYJMW|WOMJSrQn.?",4653=>"coqRq?Qxt|IHSuJQ='",4654=>"'?zNs?.MS|Qxt|IHSuJQ.?mN?}",4655=>"pRhUg?yb?.MS|Qxt|IHSuJQ.",4656=>'MS|Qxt|IHSuJQ',4657=>'GZPQ|DMAQ',4658=>'frHnt|MIZPQD',4659=>'iHSuJQsMDWuDDMHn') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ExtDiscussion extends CMS_ExtModule {public $ILL1IIl; public $ILL1IIL; public $ILL1II1; public $ILL1IlI; public $IlIlLlI; public $ILL1Ill; public $ILL1IlL; public $ILL1Il1; public $ILL1ILI; public $ILL1ILl; public $ILL1ILL; protected $doMapping =FALSE; private $started; private $disableSEIndexing; function ExtDiscussion() {parent::CMS_ExtModule(); $this->ILL1IIl =false; $this->started =null; $this->disableSEIndexing =false; }function Init(&$cms, &$IlIlIl1, &$IlIlILI){ parent::Init($cms, $IlIlIl1, $IlIlILI); $this->TTIlIl1('discussion'); $this->ILL1IlI =array ();$this->IlIlLlI =''; $modId =$this->activeModule->Name; if(preg_match('/^(blog|news)_archive/', $modId, $aMatches)){ $modId =$aMatches[1]; }$this->doMapping =AMI::getResourceModel($modId .'/table') ->hasField('disable_comments'); }function GetModuleName(){ return 'ext_discussion'; }function TTIlI11($cId, &$vItemData, &$vData, &$IILIILl) {$this->cms->Gui->addGlobalVars(array ('EXTENSION_FORUM' => I4623)); $this->ILL1IlI['show_count_replies'] =$this->GetOption('show_forum_count_replies'); parent::TTIlI11($cId, $vItemData, $vData, $IILIILl); }function TTIllTI($cId, &$vItemData, &$vData, &$IILIILl) {if ($this->installed) {$this->TITT1I1(); }}function TTIllIl($cId, &$vItemData, &$vData, &$IILIILl) {if ($this->installed && !empty($vItemData['disable_comments'])) {$vItemData['disable_comments'] =I4624; }}function TTIllII($cId, &$vItemData, &$vData, &$IILIILl) {if ($this->installed) {$field =$this->doMapping ?'disable_comments' :'ext_dsc_disable'; $vItemData[$field] =empty($this->cms->VarsPost['disable_comments']) ?0 :1; }}function TTIllTl($cId, &$vItemData, &$vData, &$IILIILl) {$this->disableSEIndexing =$this->activeModule->issetOption('disable_se_indexing_pages') && in_array('page_ext_discussion', $this->activeModule->GetOption('disable_se_indexing_pages')); $IILIILl['fields']['replies'] =array ('action' => I4625, 'object' => $this, 'method' => '_GetFrontRepliesCountCB'); if($this->TITT1lT()){ $this->ILL1IIl =true; }parent::TTIllTl($cId, $vItemData, $vData, $IILIILl); }function TTIllI1($cId, &$vItemData, &$vData, &$IILIILl){ if(!AMI_Registry::get('oldenv_inside_newenv', FALSE)){ $IILIILl[I4626]['replies'] =array ('action' => I4625, 'object' => $this, 'method' => I4627); $this->TITT1Tl(); if(!is_object($this->ILL1IIL)){ d::trace(); return; }$this->ILL1IlI['forum_link'] =$this->ILL1IIL->getAdminLink(FALSE); }parent::TTIllI1($cId, $vItemData, $vData, $IILIILl); }function TTIl1IT($cId, &$vItemData, &$vData, &$IILIILl){ if ($this->ILL1IIl && ($table =$this->mod->module->GetTableName()) != '') {if($this->mod->moduleName == 'eshop_item' && $this->mod->module->IssetAndTrueOption("item_links_allowed")){ $sql ="SELECT `disable_comments`,`id_source` FROM {$table} WHERE `id` = " .intval($this->mod->getItemId()); $rs =&$this->db->select($sql); $record =$rs->nextRecord(); $ILL1IL1 =$record[I4628]; if(isset($record['id_source']) && $record['id_source']){ $this->mod->id =$record['id_source']; }}else{ $sql ="SELECT `disable_comments` FROM {$table} WHERE `id` = " .intval($this->mod->getItemId()); $ILL1IL1 =$this->db->getValue($sql); }if (empty($ILL1IL1)) {$this->TITT1I1(); $this->ILL1II1->fltExtModuleId =$this->mod->getItemId(); if ((!isset($this->cms->Vars['action']) || $this->mod->action == I4629) && isset($this->cms->VarsPost['forum_action']) && $this->cms->VarsPost['forum_action'] == 'add' ){if ($appliedId =$this->ILL1II1->extFrontActionAdd()) {if($this->ILL1II1->isMessagePublished()){ $this->ILL1II1->clearFrontCache($this->mod->moduleName); }$this->mod->forceRedirect =true; $this->cms->VarsGet =array ('status_msg' => serialize(array (I4630 => $this->cms->SysStatusMsgs, 'plain' => $this->cms->StatusMsgs))); $this->cms->ActiveScript =preg_replace(array ('/\&?offset\=\d+/', '/\&action=[^&]*/', '/\&id_message=\d+/', '/\&?go_last_page\=1/'), '', $GLOBALS['vGlobVars']['script_full_link']); $this->mod->IIlll1L =($this->ILL1IIL->GetOption('front_page_sort_dim') == I4631 ?'&offset=99999999999' :'') .'#d' .$appliedId; }}elseif (isset($this->cms->Vars['action']) && $this->cms->Vars[I4632] == 'forum_watching' && isset($this->cms->Vars['subaction']) && $this->cms->Vars['subaction'] == 'stop' ){$this->ILL1II1->extFrontActionStopWatching(); }}}}function TTIl1I1($cId, &$vItemData, &$vData, &$IILIILl) {if ($this->mod->action == I4633 && (isset($this->activeModule->Engine) ?!$this->activeModule->Engine->errno :true)) {$sql ="DELETE FROM " .$this->IlIlIlL['discussion']->GetTableName() ." " .I4634 .intval($cId) .I4635 .$this->activeModule->GetName() ."'"; $this->db->execute($sql); }}function TITT1Tl(){ if ($this->mod->side == I4636 || $this->ILL1IlI['show_count_replies']) {if ($this->mod->browser->lll1IIL) {if ($this->mod->side != I4636) {$IlIlILl =$this->TTIlI1T($this->mod->browser->TI1TIlT($this->mod->db)); }else {$IlIlILl =$this->TTIlI1T(); }}else {$IlIlILl =$this->mod->getItemId(); }$this->ILL1IlI['replies'] =$this->TITT1Il($this->activeModule->GetName(), $IlIlILl); }}function TITT1T1($cId, &$vItemData, &$vData, &$IILIILl) {if ($this->ILL1IIl) {$this->TITT1I1(); $this->ILL1II1->fltExtModuleId =$this->mod->getItemId(); $this->ILL1IlI['replies'] =$this->TITT1Il($this->activeModule->GetName(), $this->mod->getItemId()); if (!empty($this->cms->VarsGet[I4632]) && !empty($this->cms->VarsGet['id_message']) && $this->cms->VarsGet[I4632] =I4637 ){$this->ILL1II1->_locateMessageId =intval($this->cms->VarsGet['id_message']); }$aCustom =array ('real_nav_data' => $this->activeModule->getFrontLink($this->cms->GetPageId()) .$vData['nav_data'] );$aData =$this->ILL1II1->GetHtml($aCustom); $this->cms->Gui->AddGlobalVars(array ('offset' => 0)); $aData =array (I4638 => $aData['body'], 'form' => $aData['form']); $vData['forum_extention'] =$this->cms->Gui->get($this->mod->moduleName .'_list:forum_extention', $aData); }}function TTIll1I($cId, &$vItemData, &$vData, &$IILIILl){ if($this->mod->getItemId() >0){ if($this->ILL1IIl){ $this->mod->forcePageSize =$this->GetOption('page_size', true); if( !empty($this->cms->Vars['forum_ext']) && ($this->disableSEIndexing || ($this->mod->module->issetAndTrueOption('show_forum_at_details') && empty($this->cms->Vars['offset'])) )){$this->mod->TTTllT1(); }}if($IILIILl[I4639] == 'body_browse') {if($this->GetOption('show_forum_link_in_list')) {$this->TITT1II(); $IILIILl[I4626]['forum'] =array (I4632 => I4625, 'object' => $this, I4640 => '_GetForumDetailsCB'); }}else {$this->IlIlLlI =$IILIILl['url_params']; $this->TITT1Tl(); }}else {if (in_array($IILIILl[I4639], array ('body_items', 'body_urgent_items', I4641, 'body_urgent_cats')) && $this->GetOption('show_forum_link_in_list')) {$this->TITT1II(); $IILIILl[I4626]['forum'] =array (I4632 => I4625, 'object' => $this, I4640 => I4642); }}parent::TTIll1I($cId, $vItemData, $vData, $IILIILl); }function TTIl1TT($cId, &$vItemData, &$vData, &$IILIILl){ if($this->GetOption("show_forum_link_in_small")) {$this->TITT1II(); $IILIILl["fields"]["replies"] =Array("action"=>I4643, "object"=>&$this, "method"=>"_GetSmallForumCB"); }parent::TTIl1TT($cId, $vItemData, $vData, $IILIILl); }function _GetRepliesCountCB(&$aItem, &$aData){ $id =$aItem['id']; if($this->mod->moduleName == I4644 && $this->mod->module->IssetAndTrueOption("item_links_allowed") && !empty($aItem['id_source'])){ $id =$aItem['id_source']; }$aItem['replies'] =empty($this->ILL1IlI[I4645][$id]) ?0 :intval($this->ILL1IlI[I4645][$id]['all']); $aItem['forum_link'] =$this->ILL1IlI['forum_link']; }function TITT1IT(&$vItemData, &$vData) {$ILL1I1I =array ();if ($this->ILL1IlI['show_count_replies']) {if($this->mod->moduleName == I4644 && $this->mod->module->IssetAndTrueOption(I4646) && isset($vItemData['id_source']) && $vItemData['id_source']){ $vItemData['count_replies'] =$vData['count_replies'] =isset($this->ILL1IlI[I4645][$vItemData[I4647]]) ?intval($this->ILL1IlI[I4645][$vItemData[I4647]]['all']) :0; }else{ $vItemData['count_replies'] =$vData['count_replies'] =isset($this->ILL1IlI[I4645][$vItemData['id']]) ?intval($this->ILL1IlI[I4645][$vItemData[I4648]]['all']) :0; }}return $ILL1I1I; }function TTIl1T1($cId, &$vItemData, &$vData, &$IILIILl){ if (empty($vItemData[I4628])) {$ILL1I1l =$vItemData; $this->TITT1T1($cId, $vItemData, $vData, $IILIILl); if (empty($IILIILl['skip_item_restoration'])) {$vItemData =$ILL1I1l; unset($ILL1I1l); }$vData += $this->TITT1IT($vItemData, $vData); if (empty($this->cms->Vars['forum_ext']) && !$this->activeModule->issetAndTrueOption('show_forum_at_details')) {$vData[I4649] =$this->disableSEIndexing; $vData['forum_link'] =$this->cms->Gui->get($this->mod->moduleName .'_list:forum_link', $vData); }}else {$vData['forum_link'] =$this->cms->Gui->get($this->mod->moduleName .'_list:disabled_comments', $vData); }parent::TTIl1T1($cId, $vItemData, $vData, $IILIILl); }function _GetForumDetailsCB(&$aItem, &$aData){ if (empty($aItem[I4628]) && !empty($aItem[I4648])) {$aItem += $this->TITT1IT($aItem, $aData); $aItem[I4649] =$this->disableSEIndexing; $aItem[I4650] =$this->cms->Gui->get($this->mod->moduleName."_list:forum_link_list", $aItem); }}function _GetSmallForumCB(&$aItem, &$aData){ if (empty($aItem[I4628])) {$aItem += $this->TITT1IT($aItem, $aData); $aItem[I4649] =$this->disableSEIndexing; $aItem[I4650] =$this->cms->Gui->get($this->mod->moduleName."_list:forum_link_small", $aItem); }}function TITT1II() {if ($this->ILL1IlI['show_count_replies']) {$IlIlILl =$this->TTIlI1T(); $this->ILL1IlI[I4645] =$this->TITT1Il($this->activeModule->GetName(), $IlIlILl); }}function TTIlI1T($sql ='') {$IlIlILl =I4651; if ($sql == I4651) {$this->mod->browser->ProcessSQL($this->mod->db); while($this->mod->db->next_record()) {$id =$this->mod->db->Record["id"]; if($this->mod->moduleName == I4644 && $this->mod->module->IssetAndTrueOption(I4646) && isset($this->mod->db->Record[I4647]) && $this->mod->db->Record[I4647]){ $id =$this->mod->db->Record[I4647]; }$IlIlILl .= ",".$id; }}else {$rs =&$this->mod->db->select($sql); while ($record =$rs->nextRecord()) {$id =$record["id"]; if($this->mod->moduleName == I4644 && $this->mod->module->IssetAndTrueOption(I4646) && isset($record[I4647]) && $record[I4647]){ $id =$record[I4647]; }$IlIlILl .= ",".$id; }}$IlIlILl =mb_substr($IlIlILl, 1); return $IlIlILl; }function TITT1Il($modName, $IlIlILl) {$res =array ();if ($IlIlILl != I4651) {$sql =I4652 ."FROM `cms_discussion` f " .I4653 .$modName ."' AND lang='" .$this->mod->langData .I4654 .$IlIlILl .") AND `id_parent` = 0  AND public = 1 " .I4655; $rs =&$this->mod->db->select($sql); while ($record =$rs->nextRecord()) {$res[$record[I4656]] =array ('all' => $record['count_public_children']); }}return $res; }function TITT1I1($ILL1I1L =I4651) {static $ILL1I11, $aExtOptions =array (I4657, 'messages_pages', 'add_messages_by_registered_only', 'noindex_external_links', 'sys_user_as_administration', I4658, 'watch_comments', 'from_mbox', 'updatable_period', 'front_page_sort_col', 'front_page_sort_dim'), $aModuleOptions =array ('notify_admin_about_new_message', 'forum_webmaster_email', 'use_tree_view', 'forum_pager_page_number_as_bound', 'show_forum_link_in_small'); if (isset($ILL1I11) && $ILL1I11 == $ILL1I1L && I4659 == get_class($this->ILL1IIL)) {return; }$ILL1I11 =$ILL1I1L; $this->ILL1IIL =&$this->IlIlIlL['discussion']; $this->ILL1IIL->InitEngine($this->cms, $this->mod->db); $this->ILL1II1 =&$this->ILL1IIL->Engine; foreach ($aExtOptions as $optionName) {$this->ILL1IIL->SetOption($optionName, $this->GetOption($optionName, true)); }foreach ($aModuleOptions as $optionName) {$this->ILL1IIL->SetOption($optionName, $this->mod->module->issetOption($optionName) ?$this->mod->module->GetOption($optionName) :false); }if ($this->mod->side != I4636) {$this->ILL1II1->Init(array ('discussion_list' => 'templates/discussion.tpl'), 'templates/lang/_ext_discussion_msgs.lng', 'templates/lang/forum.lng'); }else {}$this->ILL1II1->I1LlLIL =&$this->activeModule; $this->ILL1II1->fltExtModule =$ILL1I1L == I4651 ?$this->mod->moduleName :$ILL1I1L; }protected function TITT1lT(){ if(is_null($this->started)){ $this->started =$this->installed && ($this->mod->module->issetAndTrueOption('show_forum_at_details') || isset($this->cms->Vars['forum_ext']) );}return $this->started; }}