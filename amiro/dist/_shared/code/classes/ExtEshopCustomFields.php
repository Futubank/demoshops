<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       181845 xkqwkgkxpklpygltyilgwzrprzpquuwlkytmsqizwlyswzuilrlxpqrwixxmmtkupskqpnir
 */ ?><?php foreach(array(4663=>"DQt",4664=>"1",4665=>"MtQI|GMWturQD",4666=>"PQnQrZtQ|GMWturQD",4667=>"|rQfQrQnWQ",4668=>"GMWturQ|IZxOQMPOt",4669=>"WuDtHI|nZIQ",4670=>"ftBGQ",4671=>"MD|GrHG",4672=>"fnuI",4673=>"DOHC|IQtOHS",4674=>"uDQr|fHrI",4675=>"fMQJSD|WZGtMHnD",4676=>"^",4677=>"tBGQ|HCnQr",4678=>"rQJ|WZt|MtQI|HrSQr",4679=>"fMQJSD|IZG",4680=>"MD|DBDtQI",4681=>'WZtQPHrB',4682=>"fJHZt",4683=>'fnuI',4684=>"ZSS|QxtQntMHn|DEJ",4685=>"PQt|SQtZMJD",4686=>"PQt|GrHG|SQDW",4687=>"PQt|tMtJQD",4688=>"VDGJMttQr",4689=>"nuI|nH|rQDt",4690=>"",4691=>"grHGprHuGdGJMttQr",4692=>"|",4693=>"YHSB|MtQIs",4694=>"YuttHn",4695=>'YHSB|fMJtQrQS',4696=>"SQtZMJD",4697=>"rQf|tZYJQ|nuI",4698=>"SQDWrMGtMHn",4699=>"SZtZDQt|SZtZ",4700=>"'!'",4701=>"GrHG|nuI",4702=>"WuDtHI|fMQJSD",4703=>"WuDtHI|tMtJQ",4704=>"u",4705=>"rQD",4706=>"rQf|DQt",4707=>"fJZP|IZG",4708=>"rQf|vZJuQ",4709=>"rQf|rQfQrQnWQ",4710=>"MS",4711=>"MnJMnQ",4712=>"\"@",4713=>"nHnQ",4714=>"DWZJZr",4715=>"WuDtHI|vZJuQ",4716=>'urJ',4717=>'MS',4718=>'QSMt|GMWturQ',4719=>"QSMt|vZJuQ",4720=>"tQxt",4721=>"|rQfQrQnWQ|",4722=>"SZtZ",4723=>"WuDtHI|fMQJSD|tHG",4724=>'^',4725=>"JMDt",4726=>"|DuYfHrI%",4727=>"|IDPD`JnP",4728=>"'",4729=>"nZIQ",4730=>"fMQJSD|DOHC|QIGtB",4731=>"MS|WZtQPHrB",4732=>"'?ZnS?MS='",4733=>"fJZPIZG",4734=>"WHunt",4735=>"'!?2!?10{",4736=>"rQS",4737=>"'?ZnS?vZJuQ|1='",4738=>"0",4739=>'=_NUjj',4740=>"DtZtuD|",4741=>"rQJZtQS|MtQID",4742=>"OMSSQn",4743=>"SZtQ",4744=>"WOZr",4745=>"DMIGJQ|fMQJSD",4746=>'urPQnt|',4747=>'W`',4748=>'',4749=>"GrQfMx",4750=>"DEJ",4751=>"WuDtHI|fMQJS|",4752=>"DQJQWt",4753=>'fMQJSD',4754=>'IQtOHS',4755=>'`',4756=>"LHMn",4757=>"{",4758=>"?jqFT?lhmN?",4759=>'ZutH|frQQ',4760=>'SZtZDQt|MS',4761=>"M`",4762=>"DOHC|YHSB|tBGQ",4763=>"^YHSB|MtQID^",4764=>"MD|JMnK",4765=>"mF}",4766=>"W`SZtZDQt|MS",4767=>'HYLQWt',4768=>"rQWHrS|tBGQ",4769=>"GrMWQ0",4770=>"GrHG|CQMPOt",4771=>"HrSQr|MD|GrHG",4772=>":04S",4773=>"vZJuQ|tBGQ",4774=>"^GrMWQ|JMDt^",4775=>'nuI',4776=>"OZD|SQtZMJD",4777=>"GMWturQ",4778=>'ftBGQ',4779=>'~\S-$~',4780=>"MDnHt|ZJJ",4781=>"WuDtHI|fMQJS|ZJJ",4782=>"Mnt",4783=>"GZPQ|MtQI|tBGQ",4784=>'YHSB|WZtD',4785=>'rQJZtQS|MtQID',4786=>"rQJZtQS|WZtD",4787=>"Qxt|GMWturQ",4788=>"vZJuQ|1",4789=>"|IuJtM|",4790=>"|IuJtM",4791=>"|JMDt",4792=>"!M`WuDtHI|fMQJS|",4793=>"?FRhi?",4794=>'?zNs?W`GuYJMW?=?1?',4795=>"DMIGJQ|GrQfMx",4796=>"WZt|DuYJMnK",4797=>"MtQI",4798=>"WuDtHI|fMQJS|tMtJQ",4799=>"ZWtMHn",4800=>"YHSB|WZtD",4801=>'rQJ|WZt|MtQI|nuI',4802=>"?hRsqR?yb?M`",4803=>"MtQI|",4804=>'MtQI',4805=>"nZv|SZtZ",4806=>"HtOQr|GrMWQD",4807=>'MtQID',4808=>"fJZP",4809=>"WuDtHI|fMQJS",4810=>"IHSNZIQ",4811=>'Qxt|MIZPQD',4812=>"MDZWtMvQ",4813=>"Qxt|WuDtHI|",4814=>'SQtZMJD',4815=>'MDnHt|ZJJ',4816=>"|GrMWQ",4817=>"GrHGQrtB|DMAQ",4818=>"GrHG|",4819=>"'?",4820=>"?HrSQr?YB?MS",4821=>'SZtZ',4822=>"GrHGmS",4823=>"|pQtgMWturQDwy",4824=>"MtQIgrHG",4825=>'|GS',4826=>"QIGtB",4827=>"fMQJS",4828=>"vZJuQ",4829=>"nQ",4830=>"@=",4831=>"nMnt",4832=>"=",4833=>"tH",4834=>"DQZrWO|DuYWZtD",4835=>"nHt?Mn",4836=>"WOQWKYHx",4837=>'vZJuQ',4838=>"dqjqwT?MS?FRhi?",4839=>"{?@=?1{",4840=>"{?",4841=>"?}",4842=>"YHSB|DQZrWO",4843=>"Mn",4844=>"|ZJJ",4845=>"?W`SZtZDQt|MS?",4846=>"_",4847=>"{?hR?}1",4848=>"]whNV}'",4849=>"#@0",4850=>"coqRq?1",4851=>"?hR?}",4852=>"QEuZJ",4853=>"_whNV}'",4854=>"coqRq?",4855=>"!",4856=>"fHrWQ",4857=>"GHDMtMHn?",4858=>"!'_'!",4859=>'rQf|rQfQrQnWQ',4860=>'WHIIHn|DQttMnPD',4861=>'?zNs?.GuYJMW.?=?1',4862=>'|GrHGD',4863=>'?zNs?',4864=>"-0`00",4865=>"JMnKzSSHn",4866=>"IuJtMGJQ|DQJQWt",4867=>"GrMWQ",4868=>"?ZnS?JZnP='",4869=>"IZDK",4870=>"~",4871=>"+",4872=>"rQturn?}",4873=>"{^",4874=>"'!?CQMPOt='",4875=>"|GrHGD?COQrQ?MS=",4876=>"RqVqRdq}whNV}GrHG|",4877=>"SQDW|Zrr",4878=>"%",4879=>"GrHGgrQf",4880=>"SQDW",4881=>"YJHWKNZIQ",4882=>"SZtZDQt|MS",4883=>"coqRq?JZnP?=?'",4884=>'!',4885=>"|WuDtHI|tBGQD?",4886=>'nZIQ',4887=>'SQDWrMGtMHn',4888=>'OZD|SQtZMJD',4889=>'rQf|vZJuQ',4890=>"GrHG|rQGQZt",4891=>"SZtZDQtD",4892=>"DBD|ZJMZD",4893=>"OZrSWHSQS|fMQJSD") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ExtEshopCustomFields extends CMS_ExtModule{ public $ILL1lII; public $ILL1lIl; public $ILL1lIL; public $ILL1lI1; public $ILL1llI; public $ILL1lll; public $ILL1llL; public $ILL1ll1; public $ILL1lLI; public $ILL1lLl; public $ILL1lLL; public $ILL1lL1; public $ILL1l1I; public $ILL1l1l =array(); public $ILL1l1L; public $ILL1l11; public $ILL1LII; public $ILL1LIl; public $ILL1LIL; public $ILL1LI1; public $ILL1LlI; public $ILL1Lll; public $II1lllI; public $ILL1LlL; public $ILL1Ll1; public $ILL1LLI; public $oEshop; public $isImport; public $ILL1LLl; public $ILL1LLL; private $_moduleName; private $ILL1LL1; private $ILL1L1I =false; private $ILL1L1l; function ExtEshopCustomFields(){ $this->ILL1lII =""; $this->ILL1lIl =&$GLOBALS['ExtEshopCustomFields_CommonStorage']->ILL1lIl; $this->ILL1lIL =&$GLOBALS['ExtEshopCustomFields_CommonStorage']->ILL1lIL; $this->ILL1lI1 =Array(); $this->ILL1LI1 =Array(); $this->ILL1lll =Array(); $this->systemFieldsList =Array(); $this->ILL1llL =&$GLOBALS['ExtEshopCustomFields_CommonStorage']->ILL1llL; $this->ILL1ll1 =Array(); $this->ILL1Lll =&$GLOBALS['ExtEshopCustomFields_CommonStorage']->ILL1Lll; $this->ILL1LlI =""; $this->II1lllI =Array(); $this->ILL1LlL =Array("char", I4663); $this->ILL1lLl =false; $this->ILL1lLL =0; $this->ILL1lL1 =array(); $this->ILL1l1L =false; $this->ILL1l11 =array(); $this->ILL1Ll1 =array(); $this->ILL1LLI =""; $this->ILL1llI =&$GLOBALS['ExtEshopCustomFields_CommonStorage']->ILL1llI; $this->ILL1LII =array(); $this->ILL1LIl =array(); $this->isImport =false; $this->ILL1LLl =35; $this->ILL1LIL =false; $this->ILL1l1I =array(); $this->ILL1LLL =array(); parent::CMS_ExtModule(); }function Init(&$cms, &$IlIlIl1, &$IlIlILI) {if(is_object($IlIlILI) && !empty($IlIlILI->oEshop)){ $this->oEshop =&$IlIlILI->oEshop; }else{ $this->oEshop =&$cms->Eshop; }$this->_moduleName =is_object($IlIlILI) ?$IlIlILI->moduleName :''; parent::Init($cms, $IlIlIl1, $IlIlILI); $this->cms->Gui->removeGlobalVars(mb_strtoupper($this->GetModuleName())); $this->cms->Gui->addGlobalVars(Array("EXT_ESHOP_CUSTOM_FIELDS" => I4664)); $this->ILL1LII["item_pictures"] =$this->cms->Core->issetModOption($this->oEshop->ownerName."_reference", "item_pictures") ?$this->cms->Core->GetModOption($this->oEshop->ownerName."_reference", I4665) :array(); $this->ILL1LII["generate_pictures"] =$this->cms->Core->issetModOption($this->oEshop->ownerName."_reference", "generate_pictures") ?$this->cms->Core->GetModOption($this->oEshop->ownerName."_reference", I4666) :array(); $this->ILL1LII["generate_picture_postf"] =$this->cms->Core->issetModOption($this->oEshop->ownerName."_reference", "generate_picture_postf") ?$this->cms->Core->GetModProperty($this->oEshop->ownerName."_reference", "generate_picture_postf") :""; $this->ILL1LII["picture_maxwidth"] =$this->cms->Core->issetModOption($this->oEshop->ownerName."_reference", "picture_maxwidth") ?$this->cms->Core->GetModOption($this->oEshop->ownerName.I4667, "picture_maxwidth") :""; $this->ILL1LII["picture_maxheight"] =$this->cms->Core->issetModOption($this->oEshop->ownerName.I4667, "picture_maxheight") ?$this->cms->Core->GetModOption($this->oEshop->ownerName.I4667, I4668) :""; $this->ILL1LII["generate_bigger_image"] =$this->cms->Core->issetModOption($this->oEshop->ownerName.I4667, "generate_bigger_image") ?$this->cms->Core->GetModOption($this->oEshop->ownerName.I4667, "generate_bigger_image") :false; $this->ILL1LII["category_custom_types_allowed"] =$this->cms->Core->issetModOption($this->oEshop->ownerName."_custom_types", "category_custom_types_allowed") ?$this->cms->Core->GetModOption($this->oEshop->ownerName."_custom_types", "category_custom_types_allowed") :false; $this->ILL1LII["is_category_custom_fields"] =false; $this->TITIITT($this->cms->Core->IssetModOption($this->oEshop->ownerName."_item", "show_ref_items_in_admin") ?$this->cms->Core->GetModOption($this->oEshop->ownerName."_item", "show_ref_items_in_admin") :-1); $this->ILL1LlI =$this->GetOption(I4669); $this->ILL1LLl =$this->cms->Core->GetModOption($this->oEshop->ownerName."_datasets", 'list_max_characters'); $this->ILL1LL1 =!($this->oEshop->TT1l1lI($this->_moduleName, 'order') && $cms->Core->Side == 'front'); if($this->ILL1LL1){ $this->TITIITI(); $this->setDataset(0, array()); }}function TITT1lI($dir =true){ if($dir){ $this->ILL1LIl =array( $this->mod->options[I4665], $this->mod->options[I4666], $this->mod->options["generate_picture_postf"], $this->mod->options["picture_maxwidth"], $this->mod->options[I4668], $this->mod->options["generate_bigger_image"], empty($this->mod->options["show_ref_items_in_admin"]) ?null :$this->mod->options["show_ref_items_in_admin"], );$this->mod->options[I4665] =$this->ILL1LII[I4665]; $this->mod->options[I4666] =$this->ILL1LII[I4666]; $this->mod->options["generate_picture_postf"] =$this->ILL1LII["generate_picture_postf"]; $this->mod->options["picture_maxwidth"] =$this->ILL1LII["picture_maxwidth"]; $this->mod->options[I4668] =$this->ILL1LII[I4668]; $this->mod->options["generate_bigger_image"] =$this->ILL1LII["generate_bigger_image"]; $this->mod->options["show_ref_items_in_admin"] =$this->ILL1LII["show_ref_items_in_admin"]; }else{ list( $this->mod->options[I4665], $this->mod->options[I4666], $this->mod->options["generate_picture_postf"], $this->mod->options["picture_maxwidth"], $this->mod->options[I4668], $this->mod->options["generate_bigger_image"], $this->mod->options["show_ref_items_in_admin"]) =$this->ILL1LIl; }}function TITT1ll($cId, $vItemData, $vData, $IILIILl) {$this->ILL1LLL =$IILIILl["exclude_filter_fields"]; }function TITT1l1($idx, &$aData, $value, $ILL1L1L) {$aFileds =Array("fnum", "fnum", I4670, "value_type", "ref_table_num", "default_params", "default_gui_type", I4671, "fnum", "public", "body_type", "fnum", I4672, "has_details", "details", "flagmap_method", I4672, "datasets", I4673, "show_body_type", "isnot_all", "admin_form", "no_rest", I4674, "text_comparison", 'sys_name'); $num =sizeof($aFileds); for($i =0; $i <$num; $i++) {$aData[$idx][$i] =$this->ILL1lIL[$value][$aFileds[$i]]; }$aData[$idx][0] =preg_replace('/^(.*?)\[.*?\]\s*$/', '\1', $ILL1L1L[I4675][$value]); $aData[$idx][8] =false; $aData[$idx][11] =$this->ILL1lIL[$value]["prefix"][$this->mod->langData]; $aData[$idx][12] =$this->ILL1lIL[$value]["postfix"][$this->mod->langData]; $aData[$idx][16] =(mb_strpos($ILL1L1L["fields_filter"], ";".$value.I4676) !== false); $aData[$idx][25] =$ILL1L1L[I4675][$value]; $aData[$idx]["is_link"] =$this->ILL1lIL[$value]["is_link"]; $aData[$idx]["filter_existent_items"] =$this->ILL1lIL[$value]["filter_existent_items"]; $aData[$idx][I4677] =$this->ILL1lIL[$value][I4677]; $aData[$idx]["rel_cat_item_num"] =$this->ILL1lIL[$value]["rel_cat_item_num"]; $aData[$idx]["rel_cat_item_field"] =$this->ILL1lIL[$value]["rel_cat_item_field"]; $aData[$idx][I4678] =$this->ILL1lIL[$value][I4678]; $aData[$idx]["show_empty"] =(mb_strpos($ILL1L1L["fields_show_empty"], I4676.$value.I4676) !== false); if($aData[$idx]["show_empty"]){ $this->ILL1l1l[] =$aData[$idx][1]; }$aData[$idx]["show_empty_in_search"] =$this->ILL1lIL[$value]["show_empty_in_search"]; }function setDataset($datasetId, $ILL1L1L){ $ILL1L11 =0; $ILL11II =0; $ILL11Il =0; $ILL11IL =0; $this->ILL1lII =""; $this->ILL1lI1 =array(); $this->systemFieldsList =array(); if(empty($this->ILL1L1I)){ $this->ILL1lll =array(); }$this->ILL1lLI =array(); if(is_array($ILL1L1L) && sizeof($ILL1L1L) >0 && isset($ILL1L1L["fields_map"])){ $this->TITIITI($ILL1L1L['fields_map']); $this->ILL1lLL =$datasetId; $this->ILL1lL1 =$ILL1L1L; $this->ILL1lII =$ILL1L1L["postfix"]; foreach(explode(I4676, $ILL1L1L[I4679]) as $value){ if(intval($value) >0 && isset($this->ILL1lIL[$value])){ $fnum =$this->ILL1lIL[$value]['fnum']; if($this->ILL1L1I && $this->TITT11I($fnum)){ continue; }if($this->ILL1lIL[$value]["is_system"]){ $idx =sizeof($this->systemFieldsList); $this->TITT1l1($idx, $this->systemFieldsList, $value, $ILL1L1L); }else{ $idx =sizeof($this->ILL1lI1); $this->TITT1l1($idx, $this->ILL1lI1, $value, $ILL1L1L); }if(!$this->ILL1lIL[$value][I4671]){ $ILL1L11 += 1; if($this->ILL1lIL[$value]["admin_form"] == 3) $ILL11IL += 1; }else{ $ILL11II += 1; if($this->ILL1lIL[$value]["no_rest"]) $ILL11Il += 1; }$aField =$this->ILL1lIL[$value][I4680] ?$this->systemFieldsList[$idx] :$this->ILL1lI1[$idx]; $aField['_fnum'] =$fnum; $aField[27] =$this->ILL1lIL[$value]['sys_name']; $this->ILL1lll[] =$aField; $this->ILL1lLI[($this->ILL1lIL[$value][I4671] ?"prop_" :"").$aField[1]] =sizeof($this->ILL1lll)-1; if(!$this->ILL1lIL[$value][I4671] && ($this->ILL1lIL[$value][I4677] != I4681) && (mb_strpos($ILL1L1L["fields_shared"], I4676.$value.I4676) !== false) && in_array($this->ILL1lIL[$value][I4670], Array("char", "text", "int", I4682, "date")) && in_array($this->ILL1lIL[$value]["value_type"], Array('scalar', 'ref_value'))){ $this->ILL1l1I[$this->ILL1lIL[$value][I4683]] =array( I4672 => $this->ILL1lIL[$value][I4672], 'sys_name' => $this->ILL1lIL[$value]['sys_name'], "default_caption" => $this->ILL1lIL[$value]["default_caption"] );}}elseif(intval($value) >100000){ if(is_array($this->ILL1llL)){ foreach($this->ILL1llL as $key => $val){ if($val == intval($value)){ $this->ILL1ll1[$value][0] =$this->ILL1ll1[$value][25] =$ILL1L1L[I4675][$value]; $this->ILL1ll1[$value][1] =$key; $this->ILL1ll1[$value][8] =true; $this->ILL1ll1[$value][9] =1; $this->ILL1ll1[$value][10] =";body_items;body_cat;body_search;"; $this->ILL1ll1[$value][27] =$key; $this->ILL1lll[] =$this->ILL1ll1[$value]; break; }}}}}$this->ILL1lLl =true; }return array($ILL1L11, $ILL11II, $ILL11IL, $ILL11Il); }public function TITT11T($aDatasets){ $this->ILL1L1I =true; foreach($aDatasets as $aDataset){ $this->setDataset($aDataset[0], unserialize($aDataset[1])); }$this->ILL1L1I =false; }private function TITT11I($fnum){ foreach($this->ILL1lll as $aField){ if(isset($aField['_fnum']) && $aField['_fnum'] === $fnum){ return true; }}return false; }function GetModuleName() {return "ext_".$this->oEshop->ownerName."_custom_fields"; }function ProcessAction(&$IIIL11l, $cId, &$vItemData, &$vData, &$IILIILl) {switch($IIIL11l) {case I4684: $this->TITITII($cId, $vItemData, $vData, $IILIILl); break; case "set_dataset": $this->TITITT1($cId, $vItemData, $vData, $IILIILl); break; case "createfilterfields": $this->TITT111($cId, $vItemData, $vData, $IILIILl); break; case "postcreatefilterdata": $this->TITITTT($cId, $vItemData, $vData, $IILIILl); break; case "recalc_prop_data": $this->TITITll($cId, $vItemData, $vData, $IILIILl); break; case I4685: $this->TITITTI($cId, $vItemData, $vData, $IILIILl); break; case "get_ref_details": $this->TITITTl($cId, $vItemData, $vData, $IILIILl); break; case "get_if_dataset_has_props": $vItemData["has_props"] =isset($this->ILL1l11[$cId]) && $this->ILL1l11[$cId] >0 ?true :false; break; case "get_prop_rest": $this->TITITl1($cId, $vItemData, $vData, $IILIILl); break; case I4686: $this->TITIT1T($cId, $vItemData, $vData, $IILIILl); break; case "get_prop_desc_by_arr": $this->TITIT1I($cId, $vItemData, $vData, $IILIILl); break; case "prepare_record": $this->TITITIl($cId, $vItemData, $vData, $IILIILl); break; case "get_dataset_field_types_count": $this->TITIT1l($cId, $vItemData, $vData, $IILIILl); break; case "add_system_referencies_fields": $this->TITITI1($cId, $vItemData, $vData, $IILIILl); break; case I4687: $this->TITIT11($cId, $vItemData, $vData, $IILIILl); break; case "get_price_list_header": $this->TITITlT($cId, $vItemData, $vData, $IILIILl); break; case "prepare_to_import": $this->TITT11l($cId, $vItemData, $vData, $IILIILl); break; case "get_cat_custom_fields": $this->TTIl1T1($cId, $vItemData, $vData, $IILIILl); break; case "get_subcat_custom_fields": $this->ILL1LIL =true; $this->TTIl1T1($cId, $vItemData, $vData, $IILIILl); break; case "set_exclude_filter_fields": $this->TITT1ll($cId, $vItemData, $vData, $IILIILl); break; default: parent::ProcessAction($IIIL11l, $cId, $vItemData, $vData, $IILIILl); break; }}function TITT11l($cId, &$vItemData, &$vData, &$IILIILl){ $this->isImport =true; }function TITT111($cId, &$vItemData, &$vData, &$IILIILl){ $bodyType =$vData["body_type"]; $this->ILL1LLI =$bodyType; $vData =array(); $ILL11I1 =0; $ILL11lI =array(); if(is_array($this->ILL1lll)){ foreach($this->ILL1lll as $key => $val){ if($val[9] && mb_strpos($val[10], I4676.$bodyType.I4676) !== false && (!empty($val[16]) || $val[8])){ if(!empty($val[6])){ $fldName =($val[7] == 1 ?"prop_" :"ext_custom_").$val[1]; $vData[] =$fldName; $IILIILl[$fldName] =$val[25]; if($val[7] == 1 && $val[22] && $this->ILL1lIl[$this->ILL1lLL]["prop_repeat"] >0) $ILL11lI[] =array($fldName, $val[25]); }elseif($val[8]){ $ILL11I1 ++; if($val[1] == I4688 || $val[1] == "Hsplitter" || $val[1] == "Sblock" || $val[1] == "Fblock"){ $val[1] .= $ILL11I1; if($this->ILL1lIl[$this->ILL1lLL]["prop_repeat"] >0 && $this->ILL1lIl[$this->ILL1lLL][I4689] >0) $ILL11lI[] =array($fldName, $val[25]); }$vData[] =$val[1]; $IILIILl[$val[1]] =$val[25]; }}}}if($bodyType == "body_itemD" && $this->ILL1lIl[$this->ILL1lLL]["prop_repeat"] >0 && count($ILL11lI) >0){ array_splice($vData, 0, 0, "PropBlockStart1"); $IILIILl["PropBlockStart1"] =I4690; for($i =0; $i <$this->ILL1lIl[$this->ILL1lLL]["prop_repeat"]-1; $i++){ $vData[] ="PropBlockEnd".($i+1); $IILIILl["PropBlockEnd".($i+1)] =I4690; $vData[] ="PropGroupSplitter".($i+1); $IILIILl[I4691.($i+1)] =I4690; $vData[] ="PropBlockStart".($i+2); $IILIILl["PropBlockStart".($i+2)] =I4690; for($j =0; $j <count($ILL11lI); $j++){ $vData[] =$ILL11lI[$j][0]."_".str_repeat("x", $i+1); $IILIILl[$ILL11lI[$j][0].I4692.str_repeat("x", $i+1)] =$ILL11lI[$j][1]; }}$vData[] ="PropBlockEnd".($i+1); $IILIILl["PropBlockEnd".($i+1)] =I4690; }}function TITITTT($cId, &$vItemData, &$vData, &$IILIILl){ $bodyType =$vData["body_type"]; if($bodyType == I4693 && $this->ILL1lIl[$this->ILL1lLL]["prop_repeat"] >0 && $this->ILL1lIl[$this->ILL1lLL][I4689] >0){ if($this->mod->filter->issetField("submit")) $this->mod->filter->TITI1l1("submit"); $this->mod->filter->AddField("order", I4694); $this->mod->filter->AddField("propId", "hidden", "-1"); }$aFields =$this->mod->filter->GetFieldsAsArray(); $ILL11ll =0; foreach($aFields as $fieldName => $fieldValue){ if(preg_match('/ext_custom_(\d+)/', $fieldName, $aMatches)){ $this->mod->TTTllII(I4695); if($ILL11ll != 0){ $ILL11ll =0; break; }else{ $ILL11ll =$aMatches[1]; }}}foreach($this->ILL1lIL as $ILL11lL => $IlL1L1I){ if($IlL1L1I[I4683] == $ILL11ll){ if($IlL1L1I['disable_noindex'] == '1'){ $this->mod->TTTllIT(); }break; }}}function TITITTI($cId, &$vItemData, &$vData, &$IILIILl){ $ILL11l1 =$vData["details"]; $vData =array(); $ILL11LI =(mb_strpos($ILL11l1, "prop_") !== false); $fNum =$ILL11LI ?mb_substr($ILL11l1, 5) :mb_substr($ILL11l1, 11); $sql ="select description from ".$this->oEshop->dbTablePrefix."_custom_types where fnum=".intval($fNum)." and is_prop=".intval($ILL11LI); $this->db->query($sql); if($this->db->next_record()){ $ILL11Ll =unserialize($this->db->Record["description"]); $vData["details"] =$ILL11Ll[$this->mod->langData]; }}function TITITTl($cId, &$vItemData, &$vData, &$IILIILl){ $ILL11l1 =$vData[I4696]; $refId =$vData["ref_id"]; $vData =array(); $fNum =mb_substr($ILL11l1, 11); $sql ="select ref_table_num from ".$this->oEshop->dbTablePrefix."_custom_types where fnum=".intval($fNum)." and is_prop=0"; $this->db->query($sql); if($this->db->next_record()){ if($this->db->Record[I4697] >0){ $ILL11LL =sprintf("%04d", $this->db->Record[I4697]); $sql ="select description from ".$this->oEshop->dbTablePrefix."_reference_".$ILL11LL." where id=".intval($refId); $this->db->query($sql); if($this->db->next_record()){ $vData[I4696] =$this->db->Record[I4698]; }}}}function TITITT1($cId, &$vItemData, &$vData, &$IILIILl){ $IILIILl["custom_num"] =0; $IILIILl["custom_num_tabs"] =0; $IILIILl["prop_num"] =0; $IILIILl["prop_num_norest"] =0; if(isset($vItemData[I4699]) && isset($vItemData["dataset_id"])){ if($this->mod->realSide == "front") {$aData =unserialize($vItemData[I4699]); $sql ="SELECT id FROM ".$this->oEshop->dbTablePrefix."_custom_types WHERE user_form=1 AND id IN ('0".str_replace(I4676, I4700, $aData[I4679])."0')"; $aData[I4679] =I4676; $this->db->query($sql); while($this->db->next_record()){ $aData[I4679] .= $this->db->Record["id"].I4676; }$vItemData[I4699] =serialize($aData); }$this->ILL1L1l =(int)$vItemData['count_public_childs']; list($IILIILl["custom_num"], $IILIILl[I4701], $IILIILl["custom_num_tabs"], $IILIILl["prop_num_norest"]) =$this->setDataset($vItemData["dataset_id"], unserialize($vItemData[I4699])); }}function TTIllI1($cId, &$vItemData, &$vData, &$IILIILl) {$itemData =Array(); if($cId >0) $itemData =$this->mod->itemData; $vData["custom_fields_hiddens"] =I4690; $vData[I4702] =I4690; $vData["custom_fields_top"] =I4690; $vData["custom_fields_bottom"] =I4690; $this->TITITIT($cId, $this->ILL1lll, $itemData, $vData); parent::TTIllI1($cId, $vItemData, $vData, $IILIILl); }function TITITIT($cId, $ILL11L1, &$itemData, &$vData) {if($this->ILL1lLl && is_array($ILL11L1)){ $aFieldsData =Array(); $Il111IL =Array(); foreach($ILL11L1 as $id => $arr){ if(is_array($arr)){ if((isset($arr[7]) && $arr[7] == I4664) || $arr[8]){ continue; }$fieldData =array(); $arr[0] =stripslashes($arr[0]); if($arr[2] == "flagmap"){ if(is_array($arr[5]["flag"][$this->mod->langData])){ $fieldData =Array(I4703 => $arr[0], "flag_map" => I4690); $ILL111I =$arr[5]["flag"][$this->mod->langData]; $ILL111l =I4690; $ILL111L =I4690; if($cId >0 && $arr[3] != "ref_reference" && $arr[3] != "ref_set"){ $flagmap =I4690; for($i =1; $i <= sizeof($ILL111I); $i++){ $flagmap .= $ILL111I[$i][I4704] == I4664 ?I4664 :"0"; }$flagmap =rtrim($flagmap, "0"); for($i =1; $i <= ceil(mb_strlen($flagmap)/63); $i++){ $sql ="select conv('".$itemData[$this->ILL1LlI.$arr[1].I4692.$i]."', 10, 2) as res"; $this->db->query($sql); if($this->db->next_record()){ $ILL111l .= str_pad(strrev($this->db->Record[I4705]), 63, "0"); $ILL111L .= str_pad(strrev($this->db->Record[I4705]), 64, "0"); }}}if($arr[3] != "ref_value" && $arr[3] != "ref_reference" && $arr[3] != I4706){ for($i =1; $i <= sizeof($ILL111I); $i++){ if($ILL111I[$i][I4704] == I4664){ $ILL1111 =Array(I4703 => $ILL111I[$i]["c"], I4669 => $this->ILL1LlI.$arr[1].I4692.$i, "id" => $cId, );if($arr[3] != "ref_reference" && $arr[3] != I4706){ $ILL1111["custom_value"] =isset($ILL111l[$i-1]) ?$ILL111l[$i-1] :null; }$fieldData[I4707] .= $this->cms->Gui->get($this->activeModule->GetName()."_subform:custom_field_flag", $ILL1111); }if($ILL111I[$i]["s"] == I4664){ $fieldData[I4707] .= $this->cms->Gui->getAbs($this->activeModule->GetName()."_subform:custom_field_flagsplit"); }}}else{ $fieldData += Array(I4703 => $arr[0], I4669 => $this->ILL1LlI.$arr[1], "custom_value" => $arr[3] == I4708 ?"0x".TlTllIT($ILL111L, true, true) :$itemData[$this->ILL1LlI.$arr[1]], "id" => $cId, "value_type" => $arr[3], "reference_id" => (($arr[3] == I4708 || $arr[3] == I4709 || $arr[3] == I4706) && $arr[4] >0) ?intval($arr[4]) :0, );if($fieldData["custom_value"] == "0x") $fieldData["custom_value"] =I4690; }}}else{ $fieldData =Array(I4703 => $arr[0], I4669 => $this->ILL1LlI.$arr[1], "custom_value" => isset($itemData[$this->ILL1LlI.$arr[1]]) ?$itemData[$this->ILL1LlI.$arr[1]] :null, I4710 => $cId, "value_type" => $arr[3], "reference_id" => (($arr[3] == I4708 || $arr[3] == I4709 || $arr[3] == I4706) && $arr[4] >0) ?intval($arr[4]) :0, );switch($arr[2]){ case "related_items": if($arr[3] != I4708 && $arr[3] != I4709 && $arr[3] != I4706){ if(empty($itemData[$this->ILL1LlI.$arr[1]]) || $itemData[$this->ILL1LlI.$arr[1]] == I4676){ $fieldData["custom_related_items_add"] =I4711; $fieldData["custom_related_items_edit"] ="none"; }else {$fieldData["custom_related_items_add"] ="none"; $fieldData["custom_related_items_edit"] =I4711; }$fieldData[I4710] =$arr[1]; $fieldData["custom_field_name"] =$this->ILL1LlI.$arr[1]; $value =I4690; $IL1IIII =0; if(!empty($itemData[$this->ILL1LlI.$arr[1]])) {$ids =$this->mod->TTTlT11($itemData[$this->ILL1LlI.$arr[1]]); $IL1IIII =sizeof($ids); $value =$itemData[$this->ILL1LlI.$arr[1]]; }$vData["custom_fields_hiddens"] .= "<input type=\"hidden\" name=\"".$this->ILL1LlI.$arr[1]."\" value=\"".$value.I4712; $fieldData["related_items_number"] =$IL1IIII; }break; case "related_cats": if($arr[3] != I4708 && $arr[3] != I4709 && $arr[3] != I4706){ if(empty($itemData[$this->ILL1LlI.$arr[1]]) || $itemData[$this->ILL1LlI.$arr[1]] == I4676){ $fieldData["custom_related_cats_add"] =I4711; $fieldData["custom_related_cats_edit"] =I4713; }else {$fieldData["custom_related_cats_add"] =I4713; $fieldData["custom_related_cats_edit"] =I4711; }$fieldData[I4710] =$arr[1]; $fieldData["custom_field_name"] =$this->ILL1LlI.$arr[1]; $value =I4690; $IL1IIII =0; if(!empty($itemData[$this->ILL1LlI.$arr[1]])) {$ids =$this->mod->TTTlT11($itemData[$this->ILL1LlI.$arr[1]]); $IL1IIII =sizeof($ids); $value =$itemData[$this->ILL1LlI.$arr[1]]; }$vData["custom_fields_hiddens"] .= "<input type=\"hidden\" name=\"".$this->ILL1LlI.$arr[1]."\" value=\"".$value.I4712; $fieldData["related_cats_number"] =$IL1IIII; }break; case "date": if(!empty($fieldData["custom_value"]) && $arr[3] == I4714 || $arr[3] == I4708) {$II1L1ll =DateTools::conf2phpFormat($this->cms->DFMT["conf"]); if(!empty($fieldData["custom_value"]) && $fieldData["custom_value"] != "0000-00-00 00:00:00") $fieldData[I4715] =date($II1L1ll, strtotime($fieldData[I4715])); else $fieldData[I4715] =I4690; }break; case "picture": if(!isset($vData["pictures_js_vars"])) {$vData["pictures_js_vars"] =I4690; $vData["pictures_js_script"] =I4690; }$aPicData =Array(I4716 => 'ce_img_proc.php?cat='.$this->mod->options["picture_cat"].'&fld='.$fieldData[I4669].'&lang='.$this->cms->lang, I4717=>"pic_".$fieldData[I4669]); $addPic =$this->cms->Gui->get($this->mod->moduleName."_list:images_add", $aPicData); $editPic =$this->cms->Gui->get($this->mod->moduleName."_list:images_edit", $aPicData); if(!empty($fieldData[I4715])) {$fieldData['edit_picture'] =$editPic; }else {$fieldData[I4718] =$addPic; }$vData["pictures_js_vars"] .= $this->cms->Gui->getAbs($this->mod->moduleName."_subform:pictures_js_vars", Array("name"=>$fieldData[I4669], "add_value"=>jparse($addPic), I4719=>jparse($editPic))); $vData["pictures_js_script"] .= $this->cms->Gui->getAbs($this->mod->moduleName."_subform:pictures_js_script", Array("name"=>$fieldData[I4669])); break; case "int": if(mb_strlen($fieldData[I4715]) && ($arr[3] == I4714 || $arr[3] == I4708)){ $fieldData[I4715] =intval($fieldData[I4715]); }break; case I4682: if(mb_strlen($fieldData[I4715]) && ($arr[3] == I4714 || $arr[3] == I4708)){ $fieldData[I4715] =floatval($fieldData[I4715]); }break; }}if($this->ILL1LII["show_ref_items_in_admin"] >= 0 && isset($fieldData["reference_id"]) && !isset($Il111IL[$fieldData["reference_id"]]) && $fieldData["reference_id"] >0 && in_array($arr[2], Array("char", I4720, "int", I4682))) {$ILL11LL =sprintf("%04d", $fieldData["reference_id"]); $sql ="select id, name, value_1 from ".$this->oEshop->dbTablePrefix.I4721.$ILL11LL." where lang='".$this->mod->langData."' ORDER BY `name`"; $this->db->query($sql); $Il111IL[$fieldData["reference_id"]] =Array( "count" => $this->db->num_rows(), I4722 => Array() );$IL1IIIl =true; if($this->ILL1LII["show_ref_items_in_admin"] >0) {$IL1IIIl =($this->db->num_rows() <= $this->ILL1LII["show_ref_items_in_admin"]); }if($IL1IIIl) {while($this->db->next_record()) {$Il111IL[$fieldData["reference_id"]][I4722][] =$this->db->Record; }}}$aFieldsData[$id] =$fieldData; }}$modName =$this->activeModule->GetName(); $IILll1I =Array("references_select_js" => I4690); foreach($ILL11L1 as $id => $arr){ if(is_array($arr) && isset($arr[21]) && $arr[21] >0 && isset($aFieldsData[$id])){ switch($arr[21]){ case 1: $IL1IIIL =&$vData[I4723]; break; case 2: $IL1IIIL =&$vData["custom_fields_bottom"]; break; default: $IL1IIIL =&$vData[I4702]; break; }$II11ILL =isset($aFieldsData[$id]["reference_id"]) ?$aFieldsData[$id]["reference_id"] :null; if(isset($Il111IL[$II11ILL]) && count($Il111IL[$II11ILL][I4722]) >0) {$IL1III1 =I4690; foreach($Il111IL[$II11ILL][I4722] as $aRefItem) {switch($arr[3]) {case I4708: $selected =($aFieldsData[$id][I4715] == $aRefItem["value_1"]); break; case I4709: $selected =($aFieldsData[$id][I4715] == $aRefItem[I4710]); break; case I4706: $selected =mb_strpos($aFieldsData[$id][I4715], I4724 .$aRefItem[I4710] .I4724) !== false; break; }$aRefItem["selected"] =$selected? "selected": I4690; $IL1III1 .= $this->cms->Gui->get($modName."_subform:".$arr[3]."_row", $aRefItem); }$aFieldsData[$id][I4725] =$IL1III1; $aFieldsData[$id]["ref_select"] =$this->cms->Gui->get($modName."_subform:".$arr[3]."_list", $aFieldsData[$id]); $IILll1I["references_select_js"] .= $this->cms->Gui->get($modName.I4726.$arr[3]."_js", $aFieldsData[$id]); }$IL1IIIL .= $this->cms->Gui->get($modName."_subform:custom_field_".$arr[2], $aFieldsData[$id]); }}$this->cms->Gui->AddGlobalVars($IILll1I); }}function TTIllII($cId, &$vItemData, &$vData, &$IILIILl) {if($this->cms->Gui->isValidFile($GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/lang/_".$this->activeModule->GetName().I4727)) {$this->cms->AddMessages($this->cms->Gui->ParseLangFile($GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/lang/_".$this->activeModule->GetName().I4727)); }if(!$this->ILL1lLl && ($vItemData["id_category"] >0 || $this->ILL1LII["is_category_custom_fields"]) || $this->isImport){ if($this->ILL1LII["is_category_custom_fields"]){ if(intval($vItemData["dataset_id"])){ $sql ="SELECT * FROM ".$this->oEshop->dbTablePrefix."_datasets WHERE id = '".intval($vItemData["dataset_id"]).I4728; }else{ $sql ="SELECT * FROM ".$this->oEshop->dbTablePrefix."_datasets where is_sys = 1 AND lang = '".$this->langData.I4728; }$this->db->query($sql); if($this->db->next_record()){ $datasetId =intval($this->db->Record[I4710]); $ILLlIII =array( "postfix" => $this->db->Record["postfix"], I4729 => $this->db->Record[I4729], I4679 => $this->db->Record[I4679], "fields_shared" => $this->db->Record["fields_shared"], "fields_filter" => $this->db->Record["fields_filter"], I4730 => $this->db->Record[I4730], I4675 => unserialize($this->db->Record[I4675]), "sku_map" => $this->db->Record["sku_map"] );}}else{ $sql ="select dataset_id, dataset_data from ".$this->oEshop->dbTablePrefix."_cats where id=".intval($vItemData[I4731]); $this->db->query($sql); if($this->db->next_record()){ $datasetId =$this->db->Record["dataset_id"]; $ILLlIII =unserialize($this->db->Record[I4699]); }}if($datasetId && $ILLlIII){ $this->setDataset($datasetId, $ILLlIII); }}$this->__ActionPrepareItemData($this->ILL1lI1, $cId, $vItemData, $vData, $IILIILl, 1); $this->__ActionPrepareItemData($this->systemFieldsList, $cId, $vItemData, $vData, $IILIILl, 0); }function __ActionPrepareItemData($aFieldsList, $cId, &$vItemData, &$vData, &$IILIILl, $type) {if(is_array($aFieldsList)){ foreach($aFieldsList as $id => $arr){ if(is_array($arr) && $arr[7] != 1){ $value =$this->cms->VarsPost[$this->ILL1LlI.$arr[1]]; if($arr[3] == I4708 || $arr[3] == I4709 || $arr[3] == I4706){ if(($arr[3] == I4709 || $arr[3] == I4706) && $arr[4] >0){ $values =explode(I4676, $value); $value =I4690; foreach($values as $IL1IIlI){ $sql ="select count(*) as count from ".$this->oEshop->dbTablePrefix.I4721.sprintf("%04d", $arr[4])." WHERE lang='".$this->mod->langData.I4732.intval($IL1IIlI).I4728; $this->db->query($sql); $this->db->next_record(); if($this->db->Record["count"] >0) $value .= I4676.$IL1IIlI; else{ if($IL1IIlI != I4690 && $IL1IIlI != "0") $this->cms->AddStatusMsg("reference_not_found", "red"); }}if(mb_strlen($value) >0){ if($arr[3] == I4706) $value .= I4676; else $value =mb_substr($value, 1); }else if($arr[3] == I4706) $value =I4676; $vItemData[$this->ILL1LlI.$arr[1]] =$value; }else if($arr[3] == I4708 && $arr[4] >0){ if($arr[2] == I4733){ $ILL111I =$arr[5]["flag"][$this->mod->langData]; $IL1IIll =ceil(sizeof($ILL111I)/63); $IL1IIlL =array(); for($i =1; $i <= $IL1IIll; $i++){ $IL1IIlL[] ="RPAD(REVERSE(CONV(value_".$i.", 10, 2)), 64, '0')"; }$value =str_pad(TlTllT1($value), 64*$IL1IIll, "0"); $sql ="select count(*) as count from ".$this->oEshop->dbTablePrefix.I4721.sprintf("%04d", $arr[4])." where CONCAT(".implode(",", $IL1IIlL).") like '".$value.I4728; $this->db->query($sql); $this->db->next_record(); if($this->db->Record[I4734] <= 0){ if($value != I4690 && $value != "0") $this->cms->AddStatusMsg("reference_not_found", "red"); $value =I4690; }$vItemData[$this->ILL1LlI.$arr[1]] =I4690; for($i =1; $i <= $IL1IIll; $i++){ $vItemData[$this->ILL1LlI.$arr[1].I4692.$i] ="=|CONV('".strrev(mb_substr($value, ($i-1)*64, 64)).I4735; }}else if($arr[2] == "date"){ $sql ="select count(*) as count from ".$this->oEshop->dbTablePrefix.I4721.sprintf("%04d", $arr[4])." WHERE lang='".$this->mod->langData."' and DATE_FORMAT(value_1,'".$this->cms->DFMT["db"]."') like '".$value.I4728; $this->db->query($sql); $this->db->next_record(); if($this->db->Record[I4734] <= 0){ if(!mb_strlen($value)){ $vItemData[$this->ILL1LlI.$arr[1]] ="=|NULL"; }if($value != I4690) $this->cms->AddStatusMsg("reference_not_found", I4736); }else $vItemData[$this->ILL1LlI.$arr[1]] =DateTools::toMysqlDate(DateTools::getCorrectUDate($value, $this->cms->DFMT["conf"])); }else{ $sql ="select count(*) as count from ".$this->oEshop->dbTablePrefix.I4721.sprintf("%04d", $arr[4])." WHERE lang='".$this->mod->langData.I4737.$value.I4728; $this->db->query($sql); $this->db->next_record(); if($this->db->Record[I4734] <= 0){ if(!mb_strlen($value)){ $vItemData[$this->ILL1LlI.$arr[1]] ='=|NULL'; }elseif(!is_null($value)){ $vItemData[$this->ILL1LlI.$arr[1]] =$value; }if($value != "0" && $value != I4690) $this->cms->AddStatusMsg("reference_not_found", I4736); }else{ $vItemData[$this->ILL1LlI.$arr[1]] =$value; }}}else{ $vItemData[$this->ILL1LlI.$arr[1]] =I4690; }}else{ if($arr[2] == I4733){ $ILL111I =$arr[5]["flag"][$this->mod->langData]; $IL1IIll =ceil(sizeof($ILL111I)/63); $value =I4690; for($i =1; $i <= sizeof($ILL111I); $i++){ if($ILL111I[$i][I4704] == I4664 && !empty($this->cms->VarsPost[$this->ILL1LlI.$arr[1].I4692.$i])) $value .= I4664; else $value .= I4738; }for($i =1; $i <= $IL1IIll; $i++){ $vItemData[$this->ILL1LlI.$arr[1].I4692.$i] ="=|CONV('".strrev(str_pad(mb_substr($value, ($i-1)*63, 63), 64, I4738)).I4735; }}else if(isset($this->cms->VarsPost[$this->ILL1LlI.$arr[1]])){ switch($arr[2]) {case "char": case I4720: if(!mb_strlen($value)){ $value ='=|NULL'; }break; case "int": if(!mb_strlen($value)){ $value =I4739; }else{ $value =intval($value); }break; case I4682: $value =str_replace(",", ".", $value); if(!mb_strlen($value)){ $value =I4739; }else{ $value =floatval($value); }break; case "date": if(!mb_strlen($value)){ $value =I4739; }else{ $udate =DateTools::isvaliddate($value, $this->cms->DFMT["conf"]); if($udate === false){ $error =true; if($this->cms->TTITIIl(I4740.$this->ILL1LlI.$i."_fail")) {$this->cms->AddStatusMsg(I4740.$this->ILL1LlI.$i."_fail", I4736); }}$value =DateTools::toMysqlDate($udate, $this->cms->DFMT["conf"]); }break; case "related_cats": case I4741: $value =$this->mod->TTTlT11($value); if(sizeof($value) >0) {$value =I4676.implode(I4676, $value).I4676; }else {$value =I4690; }break; }$vItemData[$this->ILL1LlI.$arr[1]] =$value; }}}}}parent::TTIllII($cId, $vItemData, $vData, $IILIILl); }function TTIll1I($cId, &$vItemData, &$vData, &$IILIILl) {if($this->ILL1l1L && $cId == 0) return; $IIl1II1 =isset($IILIILl['page_item_type']) ?$IILIILl['page_item_type'] :null; if($IIl1II1 && $cId >0 && empty($vItemData['tmpDoNotUseFilter'])){ $this->mod->filter->AddField("itemId", I4742, $cId); $this->mod->filter->AddField("num", I4742, 0); }$aTypes =Array(); $IL1IIl1 =Array("char", I4720, "int", I4682, "picture", I4743); switch($IIl1II1) {case I4693: $aTypes =Array("char", I4720, "int", I4682, I4743, I4733, "picture", I4741, "related_cats"); break; default: $aTypes =Array(I4744, I4720, "int", I4682, "picture", I4743); }$IIllILl =Array(); $this->II1lllI["sql"]["select"] =Array(); $this->II1lllI[I4745] =Array(); $this->II1lllI["type"] =Array(); $prefix ="i."; $IL1IILI =(mb_strpos($this->activeModule->GetName(), "price_list") !== false); $IL1IILl =mb_strpos($IIl1II1, 'urgent_') === false ?$IIl1II1 :str_replace(I4746, '', $IIl1II1); if(is_array($this->ILL1lll)) foreach($this->ILL1lll as $i => $IllL11I) {$IL1IILL =empty($IllL11I[7]) ?null :$IllL11I[7]; $prefix =empty($IllL11I['type_owner']) || $IllL11I['type_owner'] != I4681 ?'i.' :I4747; if($IL1IILI && $IL1IILl == "body_items"){ if(isset($IllL11I[19]) && mb_strpos($IllL11I[19], ";price_list;") !== false){ $IllL11I[19] .= ";body_items;"; }else{ $IllL11I[19] =isset($IllL11I[19]) ?str_replace(";body_items;", I4676, $IllL11I[19]) :I4748; }}if($IL1IILL == 1 || $IllL11I[8] || !$IllL11I[9] || mb_strpos($IllL11I[19], I4676 .$IL1IILl .I4676) === false){ continue; }if(in_array($IllL11I[2], $IL1IIl1) && $IllL11I[3] != I4709 && $IllL11I[3] != I4706 && $IL1IILL != 1){ $this->II1lllI[I4745][] =array( I4729 => "custom_field_" .$IllL11I[1], "num" => $IllL11I[1], I4670 => $IllL11I[2], "is_link" => $IllL11I["is_link"], I4749 => $IllL11I[11], "postfix" => $IllL11I[12], "has_details" => $IllL11I[13], I4696 => $IllL11I[14], "isnot_all" => $IllL11I[20], 'sys_name' => isset($IllL11I[27]) ?$IllL11I[27] :null );}if((in_array($IllL11I[2], $aTypes) && ($IIl1II1 == I4693 || $IllL11I[3] != I4709 && $IllL11I[3] != I4706))) {if($IllL11I[2] == I4743 && $IllL11I[3] != I4709 && $IllL11I[3] != I4706){ $this->II1lllI[I4750]["select"][$i] ="IF(".$prefix."custom_field_".$IllL11I[1]."!='', DATE_FORMAT(".$prefix.I4751.$IllL11I[1].", '".$this->cms->DFMT["db"]."'), '') AS fmt_custom_field_".$IllL11I[1].", custom_field_".$IllL11I[1]; }else if($IllL11I[2] == I4733 && $IllL11I[3] != I4709 && $IllL11I[3] != I4706){ $this->II1lllI[I4750][I4752][$i] =I4690; for($n =1; $n <= ceil(sizeof($IllL11I[5]["flag"][$this->mod->langData])/63); $n++){ $this->II1lllI[I4750][I4752][$i] .= (empty($this->II1lllI[I4750][I4752][$i]) ?I4690 :",")."CONV(".$prefix.I4751.$IllL11I[1].I4692.$n.", 10, 2) as custom_field_".$IllL11I[1].I4692.$n; }if(!$this->II1lllI[I4750][I4752][$i]){ unset($this->II1lllI[I4750][I4752][$i]); }}else {$this->II1lllI[I4750][I4752][$i] =$prefix.I4751.$IllL11I[1]; }}}if(sizeof($this->II1lllI[I4745]) >0) {$IILIILl[I4753]['custom_fields'] =Array('action'=>'callback', 'object'=>&$this, I4754=>'_customFielsdCB'); }}function TITITII($cId, &$vItemData, &$vData, &$IILIILl) {$prefix =I4690; if(isset($IILIILl["sql_type"])) {$prefix =isset($IILIILl['prefix']) ?$IILIILl['prefix'] :I4748; if($prefix != I4748) {$prefix .= I4755; }switch($IILIILl["sql_type"]) {case "prop_join": $vData[I4752] .= $this->TTIl11I("p.price AS prop_price0, NOT ISNULL(p.id) as is_prop, " .$prefix ."rest, p.weight as prop_weight, p.rest as prop_rest, p.size as prop_size, p.id as propId", I4752); $vData[I4756] .= $this->TTIl11I(" LEFT JOIN ".$this->oEshop->dbTablePrefix."_props AS p ON " .$prefix ."id=p.id_item AND p.id IN(".$IILIILl["propIdList"].I4757, I4756); break; case "prop_join2": $vData[I4752] .= $this->TTIl11I("po.price AS order_prop_price0, NOT ISNULL(po.id) AS order_is_prop, po.id AS order_propId, ".$IILIILl["order_prefix"].".id_prop", I4752); $vData[I4756] .= $this->TTIl11I(I4758.$this->oEshop->dbTablePrefix."_props AS po ON po.id=".$IILIILl["order_prefix"].".id_prop AND po.id_item=".$IILIILl["order_item_field"], I4756); break; case "system_referencies_fields": if(!isset($this->II1lllI["_system_referencies_fields"])) {$sql ="SELECT ct.fnum, rt.table_num, rt.sys_alias FROM ".$this->oEshop->dbTablePrefix."_custom_types ct LEFT JOIN ".$this->oEshop->dbTablePrefix."_ref_types rt ON ct.ref_table_num=rt.table_num WHERE rt.sys_alias!='' AND ct.is_prop=0"; $this->db->query($sql); $IL1IIL1 =Array(); while($this->db->next_record()) {$this->II1lllI["_system_referencies_fields"][$this->db->Record["sys_alias"]] =$this->ILL1LlI.$this->db->Record[I4672]; $IL1IIL1[$this->db->Record["sys_alias"]] =$prefix .$this->ILL1LlI.$this->db->Record[I4672]; }if(sizeof($IL1IIL1) >0) {$vData[I4752] .= $this->TTIl11I(implode(", ", $IL1IIL1), I4752); }}break; case "home_fields": $sql ="SELECT distinct c.dataset_id, c.dataset_data FROM ".$this->oEshop->dbTablePrefix."_items i LEFT JOIN ".$this->oEshop->dbTablePrefix."_cats c ON i.id_category=c.id where 1".$IILIILl["sql_filter"]; $tmp =$this->db->attr('auto_free'); $this->db->setAttr(I4759, false); $this->db->query($sql); $fields =array(); while($this->db->next_record()){ if($this->db->Record['dataset_id'] >0) {$fieldsMap =unserialize($this->db->Record['dataset_data']); if(is_array($fieldsMap) &&mb_strlen($fieldsMap =trim($fieldsMap['fields_map'], I4724))){ $fields =array_merge($fields, explode(I4724, $fieldsMap)); }}}$this->TITIITI($fields); $this->db->seek(0); $this->db->setAttr(I4759, $tmp); $fields =array(); while($this->db->next_record()){ if($this->db->Record["dataset_id"] >0){ $arr =unserialize($this->db->Record[I4699]); if(is_array($arr)){ foreach(explode(I4676, $arr[I4679]) as $field){ $field =intval($field); if($field >0 && $field <100000){ if($this->ILL1lIL[$field][I4671]){ $datasetId =$this->db->Record[I4760]; if(empty($this->ILL1l11[$datasetId])){ $this->ILL1l11[$datasetId] =0; }$this->ILL1l11[$datasetId]++; }if(mb_strpos($arr["fields_shared"], I4676.$field.I4676) !== false && is_array($fields) && !in_array($field, $fields)){ $fields[] =$field; }}}}}}$IL1IIl1 =Array(I4744, I4720, "int", I4682, "picture", I4743); $this->II1lllI[I4750][I4752] =Array(); $this->II1lllI[I4745] =Array(); $this->II1lllI["type"] =Array(); $prefix =I4761; for($i =0; $i <count($fields); $i++){ $IllL11I =array( 1 => $this->ILL1lIL[$fields[$i]][I4672], 2 => $this->ILL1lIL[$fields[$i]][I4670], 3 => $this->ILL1lIL[$fields[$i]]["value_type"], 7 => $this->ILL1lIL[$fields[$i]][I4671], 8 => false, 9 => $this->ILL1lIL[$fields[$i]]["public"], 11 => $this->ILL1lIL[$fields[$i]][I4749][$this->mod->langData], 12 => $this->ILL1lIL[$fields[$i]]["postfix"][$this->mod->langData], 13 => $this->ILL1lIL[$fields[$i]]["has_details"], 14 => $this->ILL1lIL[$fields[$i]][I4696], 19 => $this->ILL1lIL[$fields[$i]][I4762], 20 => $this->ILL1lIL[$fields[$i]]["isnot_all"], 27 => $this->ILL1lIL[$fields[$i]]['sys_name'] );$GLOBALS['ExtEshopCustomFields_CommonStorage']->homeFields[] =$IllL11I[1]; if($IllL11I[7] == 1 || !$IllL11I[9] || (!isset($IILIILl["all_item_shared"]) && mb_strpos($IllL11I[19], I4763) === false) || (isset($IILIILl["all_item_shared"]) && $this->ILL1lIL[$fields[$i]][I4677] != 'item')){ continue; }if(in_array($IllL11I[2], $IL1IIl1) && $IllL11I[3] != I4709 && $IllL11I[3] != I4706 && $IllL11I[7] != 1){ $this->II1lllI[I4745][] =array( I4729 => I4751.$IllL11I[1], "num" => $IllL11I[1], I4670 => $IllL11I[2], "is_link" => isset($IllL11I[I4764]) ?$IllL11I[I4764] :null, I4749 => $IllL11I[11], "postfix" => $IllL11I[12], "has_details" => $IllL11I[13], I4696 => $IllL11I[14], "isnot_all" => $IllL11I[20], 'sys_name' => $IllL11I[27] );if($IllL11I[2] == I4743 && $IllL11I[3] != I4709 && $IllL11I[3] != I4706){ $this->II1lllI[I4750][I4752][$i] =I4765.$prefix.I4751.$IllL11I[1]."!='', DATE_FORMAT(".$prefix.I4751.$IllL11I[1].", '".$this->cms->DFMT["db"]."'), '') AS custom_field_".$IllL11I[1]; }else {$this->II1lllI[I4750][I4752][$i] =$prefix.I4751.$IllL11I[1]; }}}if(is_array($this->II1lllI[I4750][I4752]) && sizeof($this->II1lllI[I4750][I4752]) >0) {$this->II1lllI[I4750][I4752][] =I4766; $IL1II1I =implode(", ", $this->II1lllI[I4750][I4752]); $vData[I4752] .= $this->TTIl11I($IL1II1I, I4752); $this->ILL1l1L =true; }if(sizeof($this->II1lllI[I4745]) >0) {$vData[I4753]['custom_fields'] =Array('action'=>'callback', I4767=>&$this, I4754=>'_customFielsdCB'); $this->ILL1l1L =true; }}}else {$vItemData["tmpDoNotUseFilter"] =true; $this->TTIll1I($cId, $vItemData, $vData, $IILIILl); unset($vItemData["tmpDoNotUseFilter"]); if(is_array($this->II1lllI[I4750][I4752]) && sizeof($this->II1lllI[I4750][I4752]) >0) {$IL1II1I =$prefix.implode(", ".$prefix, $this->II1lllI[I4750][I4752]); $vData[I4752] .= $this->TTIl11I($IL1II1I, I4752); }}}function TITITIl($cId, &$vItemData, &$vData, &$IILIILl) {switch($IILIILl[I4768]) {case "item_record": if($vItemData[I4671] && is_numeric($vItemData["propId"])) {$vItemData["prop_price0_diff"] =$vItemData["prop_price0"] -$vItemData[I4769]; $vItemData[I4769] =$vItemData["prop_price0"]; $vItemData["rest"] =$vItemData["prop_rest"]; $vItemData["weight"] =$vItemData[I4770]; $vItemData["size"] =$vItemData["prop_size"]; }break; case "order_item_record": if($vItemData["id_prop"] >0) {if($vItemData[I4771]) {$vItemData[I4769] =$vItemData["order_prop_price0"]; }else {$vItemData[I4710] =0; }}break; }}function TITITI1($cId, &$vItemData, &$vData, &$IILIILl) {if(is_array($this->II1lllI["_system_referencies_fields"])){ foreach($this->II1lllI["_system_referencies_fields"] as $IL1II1l => $IILLL1I) {$vData[$IL1II1l] =$vItemData[$IILLL1I]; $ILL11l1 =intval(str_replace($this->ILL1LlI, I4690, $IILLL1I)); if($ILL11l1 >0){ foreach($this->ILL1lIL as $null => $IL1II1L){ if($IL1II1L[I4672] == $ILL11l1){ if($IL1II1L[I4697] >0){ $tmp =explode(I4676, $vItemData[$IILLL1I]); $Il1111I =array(); for($i =0; $i <count($tmp); $i++){ if(intval($tmp[$i]) >0) $Il1111I[] =intval($tmp[$i]); }if(count($Il1111I) >0){ $db =new db_si(); $sql ="select value_1 from ".$this->oEshop->dbTablePrefix.I4721.sprintf(I4772, $IL1II1L[I4697])." where id IN (".implode(",", $Il1111I).I4757; $db->query($sql); if($IL1II1L["value_type"] == I4709){ if($db->next_record()) $vData[$IL1II1l] =$db->Record["value_1"]; else $vData[$IL1II1l] =I4690; }else if($IL1II1L[I4773] == I4706){ $vData[$IL1II1l] =array(); while($db->next_record()) $vData[$IL1II1l][] =$db->Record["value_1"]; }}}break; }}}}}}function TITITlT($cId, &$vItemData, &$vData, &$IILIILl){ $IL1IIl1 =Array(I4744, I4720, "int", I4682, "picture", I4743); $IL1IILI =(mb_strpos($this->activeModule->GetName(), "price_list") !== false); if($IL1IILI && is_array($this->ILL1lll)){ foreach($this->ILL1lll as $i => $IllL11I) {if(isset($IllL11I[19]) && mb_strpos($IllL11I[19], I4774) !== false){ if($IllL11I[7] == 1 || $IllL11I[8] || !$IllL11I[9]){ continue; }if(in_array($IllL11I[2], $IL1IIl1) && $IllL11I[3] != I4709 && $IllL11I[3] != I4706 && $IllL11I[7] != 1){ $IL1II11 =array( "custom_field_title" => $this->ILL1Lll[$this->ILL1lLL][I4751.$IllL11I[1]], );$IL1IlII =array(I4692.$IllL11I[1], I4692.$IllL11I[2].$this->ILL1lII, $this->ILL1lII, I4692.$IllL11I[2]); $key ='custom_field_header_' .$IllL11I[1]; if(!isset($IILIILl[$key])){ $IILIILl[$key] =I4748; }$IILIILl[$key] .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:item_custom_field_header", $IL1IlII, $IL1II11); if(!$IllL11I[20]){ if(!isset($IILIILl['custom_field_header_list'])){ $IILIILl['custom_field_header_list'] =I4748; }$IILIILl["custom_field_header_list"] .= $IILIILl["custom_field_header_".$IllL11I[1]]; }}}}}}function _customFielsdCB(&$vData, &$aCustom) {if(is_array($this->II1lllI[I4745])){ foreach($this->II1lllI[I4745] as $customData) {$fValue =isset($vData[$customData[I4729]]) ?$vData[$customData[I4729]] :I4748; if(isset($vData["fmt_".$customData[I4729]])){ $fValue =$vData["fmt_".$customData[I4729]]; }$IL1IlIl =false; if($fValue != I4690){ $IL1IlIl =true; }elseif(in_array($customData[I4775], $this->ILL1l1l)){ $IL1IlIl =true; }if($IL1IlIl || mb_strpos($this->activeModule->GetName(), "price_list") !== false){ $IL1IlIL =($customData[I4670] == I4744 && $customData[I4764] ?"link" :$customData[I4670]); $IL1IlII =array(I4692.$customData["num"], I4692.$IL1IlIL.$this->ILL1lII, $this->ILL1lII, I4692.$IL1IlIL); $details =I4690; if($customData["has_details"]){ $IL1IlI1 =array(I4696 => $customData[I4776][$this->mod->langData], "details_id" => "ext_custom_".$customData["num"]); $details =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:field_details", $IL1IlII, $IL1IlI1); }if($customData[I4670] == I4777 && !empty($fValue)){ $IL1IllI =array(I4777 => $fValue); $fValue =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:item_custom_picture", $IL1IlII, $IL1IllI); }$IL1Illl =isset($vData["dataset_id"]) && $vData["dataset_id"] >0 ?$vData["dataset_id"] :$this->ILL1lLL; if(!isset($this->ILL1Lll[$IL1Illl][$customData[I4729]])){ continue; }if($customData[I4778] == 'text'){ $fValue =unhtmlentities($fValue); }$IL1IlI1 =array("custom_field_title" => $this->ILL1Lll[$IL1Illl][$customData[I4729]], "custom_field" => $customData[I4749].($customData[I4670] == I4682 ?floatval($fValue) :$fValue).$customData["postfix"], I4696 => $details); $prefix =preg_replace(I4779, I4748, $customData['name']); $vData[$customData[I4729]] =$this->cms->Gui->getDefPostf( $this->activeModule->GetName() ."_list:item_custom_field", $IL1IlII, $IL1IlI1 );$vData[$prefix .$customData['sys_name']] =$vData[$customData['name']]; if(!$customData[I4780]){ foreach(array('custom_field_list', 'custom_field_all') as $key){ if(!isset($vData[$key])){ $vData[$key] =I4748; }}$vData["custom_field_list"] .= $vData[$customData[I4729]]; $vData["custom_field_all"] .= $vData[$customData[I4729]]; }}}}}function TTIl1T1($cId, &$vItemData, &$vData, &$IILIILl) {$vData[I4781] =I4748; $IL1IlI1 =$vData; if(is_array($this->ILL1lll) && sizeof($this->ILL1lll) >0){ $db =new DB_Si; $props =array(); $IL1IllL =array(); foreach($this->ILL1lll as $num => $IllL11I){ if(isset($IllL11I[7]) && $IllL11I[7] == I4664 && $IllL11I[9]){ $props[] =$num; if($IllL11I[22]) $IL1IllL[] =$num; continue; }$IL1Ill1 =empty($IllL11I['type_owner']) || $IllL11I['type_owner'] != I4681; if($IILIILl['page_item_type'] == 'body_cats'){ if($IL1Ill1){ continue; }if($this->ILL1LIL){ if(!in_array($IllL11I[2], array(I4744, I4720, I4782, I4682, I4777, I4743, I4741, "related_cats"))){ continue; }$IllL11I[19] .= ";body_cats;"; }elseif(mb_strpos($IllL11I[19], ";body_catD;") !== false){ $IllL11I[19] .= ";body_cats;"; }}if($IllL11I[8] || (mb_strpos($IllL11I[19], I4676.$IILIILl[I4783].I4676) === false && !isset($vItemData['_pd']))){ continue; }$fValue =I4690; $IL1IlLI =0; $IL1IlLl =I4690; $fName =I4751.$IllL11I[1]; $IL1IlLL ='custom_field_' .$IllL11I[27]; $IL1IlI1['sys_name'] =$IllL11I[27]; if($IllL11I[2] == I4733 && $IllL11I[3] != I4709 && $IllL11I[3] != I4706){ $fValue =I4690; for($i =0; $i <ceil(sizeof($IllL11I[5]["flag"][$this->mod->langData])/63); $i++){ if($IILIILl[I4783] == I4784){ $fValue .= str_pad(strrev(base_convert($vItemData[$fName.I4692.($i+1)], 10, 2)), 63, I4738); }else{ $fValue .= str_pad(strrev($vItemData[$fName.I4692.($i+1)]), 63, I4738); }}}else{ $fValue =$vItemData[$fName]; if(isset($vItemData["fmt_".$fName])){ $fValue =$vItemData["fmt_".$fName]; }}if(!isset($IllL11I['show_empty']) || !$IllL11I['show_empty']){ if(is_array($fValue) && !sizeof($fValue)){ continue; }if(!is_array($fValue) && !strlen($fValue)){ continue; }if(($IllL11I[2] == I4785 || $IllL11I[2] == 'related_cats') && $fValue == I4724){ continue; }}$IL1IlL1 =I4748; if($IllL11I[3] == I4709 || $IllL11I[3] == I4706) {$IL1Il1I =array(); if($IllL11I[3] == I4709){ $IL1Il1I[] =intval($IL1IlI1[I4751.$IllL11I[1]]); }else{ foreach(explode(I4676, $IL1IlI1[I4751.$IllL11I[1]]) as $null => $id){ if(!empty($id)) $IL1Il1I[] =intval($id); }}if(sizeof($IL1Il1I) >0){ $IL1Il1l ="value_1"; if($IllL11I[2] == I4733){ $IL1Il1l =I4690; for($i =0; $i <ceil(sizeof($IllL11I[5]["flag"][$this->mod->langData])/63); $i++) $IL1Il1l .= (!empty($IL1Il1l) ?"," :I4690)."RPAD(REVERSE(CONV(value_".($i+1).", 10, 2)), 63, '0')"; if(!empty($IL1Il1l)) $IL1Il1l ="CONCAT(".$IL1Il1l.") as value_1"; else $IL1Il1l ="'' as value_1"; }$IL1Il1L =($IllL11I[2] != I4733 && $IllL11I[2] != I4741 && $IllL11I[2] != I4786 && $IllL11I[3] == I4706 && $IllL11I[18] == 1); $sql ="select id, ext_picture, description, ".$IL1Il1l." from ".$this->oEshop->dbTablePrefix.I4721.sprintf(I4772, $IllL11I[4]).($IL1Il1L ?I4690 :" where id in(".implode(",", $IL1Il1I).I4757); $db->query($sql); if($IllL11I[3] == I4709 && $db->next_record()){ $IL1Il11 =$db->Record[I4710]; $IL1IlL1 =$db->Record[I4787]; $fValue =$db->Record["value_1"]; $IL1IlLI =!empty($db->Record[I4698]) ?$db->Record[I4710] :0; $IL1IlLl =$db->Record[I4698]; }else if($IllL11I[3] == I4706){ $fValue =array(); while($db->next_record()){ if($IllL11I[2] == I4741 || $IllL11I[2] == I4786) $fValue .= ($db->Record["value_1"][0] == I4676 && !empty($fValue) ?mb_substr($db->Record["value_1"], 1) :$db->Record["value_1"]); else if($IllL11I[2] == I4733){ if(is_array($fValue)) $fValue =I4738; for($i =0; $i <mb_strlen($db->Record[I4788]); $i++){ if($db->Record[I4788][$i] == I4664) $fValue[$i] =I4664; }$fValue =str_replace(" ", I4738, $fValue); }else{ $fValue[] =array($db->Record[I4710], $db->Record[I4788], ($IL1Il1L ?in_array($db->Record[I4710], $IL1Il1I) :I4664), !empty($db->Record[I4698]) ?$db->Record[I4710] :0, $db->Record[I4787]); }}}else{ $fValue =I4690; }}}else if($IllL11I[3] == I4708){ $sql ="select id, ext_picture, description from ".$this->oEshop->dbTablePrefix.I4721.sprintf(I4772, $IllL11I[4])." where value_1='".$vItemData[$fName].I4728; $db->query($sql); if($db->next_record()){ $IL1ILII =$db->Record[I4698]; $IL1Il11 =$db->Record[I4710]; $IL1IlL1 =$db->Record[I4787]; }}$IL1IlIL =($IllL11I[2] == I4744 && $IllL11I[I4764] ?"link" :$IllL11I[2]); $IL1IlII =array(I4692.$IllL11I[1], I4692.$IL1IlIL.$this->ILL1lII, $this->ILL1lII, I4692.$IL1IlIL); $IL1ILIl =array(I4692.$IllL11I[1], I4789.$IL1IlIL.$this->ILL1lII, "_multi".$this->ILL1lII, I4789.$IL1IlIL, "_multi"); $IL1ILIL =array(I4692.$IllL11I[1]."_splitter", I4789.$IL1IlIL.$this->ILL1lII."_splitter", I4790.$this->ILL1lII."_splitter", I4789.$IL1IlIL."_splitter", "_multi_splitter"); $IL1ILI1 =array(I4692.$IllL11I[1]."_list", I4789.$IL1IlIL.$this->ILL1lII.I4791, I4790.$this->ILL1lII.I4791, I4789.$IL1IlIL.I4791, "_multi_list"); switch($IllL11I[2]){ case I4741: $IL1IlI1[I4696] =I4690; if($IllL11I[13]){ $IL1IllI =array(I4696 => $IllL11I[14][$this->mod->langData], "details_id" => "ext_custom_".$IllL11I[1]); $IL1IlI1[I4696] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:field_details", $IL1ILI1, $IL1IllI); }$IL1ILlI =$this->mod->TTTlT11($fValue); if(sizeof($IL1ILlI) >0) {$IL1ILll =I4690; foreach($this->ILL1l1I as $IL1ILlL){ $IL1ILll .= I4792.$IL1ILlL[I4672]; }$sql ="SELECT i.id, i.name, i.announce, i.sublink AS sublink, i.ext_picture, i.ext_small_picture, i.ext_popup_picture, i.sku, c.id AS cat_id, c.sublink AS cat_sublink". ", i.price AS price0,i.tax,i.tax_type". $this->oEshop->getPriceFields("c.price_caption%d, i.price%d, SUBSTRING(c.price%d, INSTR(c.price%d, '#')+1, 3) AS currency%d, SUBSTRING(c.price%d, INSTR(c.price%d, ':')+1, 3) AS db_currency%d"). ", i.charge_tax_type,i.discount,i.discount_type, c.id_discount, c.dataset_id, c.dataset_data, c.has_props cat_has_props ".$IL1ILll. I4793.$this->oEshop->dbTablePrefix."_items i INNER JOIN ".$this->oEshop->dbTablePrefix."_cats AS c ON c.id=i.id_category WHERE i.id IN(".implode(",", $IL1ILlI).")  ".$this->mod->_ApplyFilters().I4794.$this->oEshop->TITTIII("i"); $db->query($sql); $firstIter =true; if($db->num_rows() >0) {$IL1IlI1["custom_field"] =I4690; $ILlL1l1 =Array("active_item_type" => "body_items"); $aTmp =Array(I4795 => "item_"); $IL1ILl1 =$this->mod->IIllII1; $this->mod->TTTlll1($this->oEshop->ownerName."_item"); while($db->next_record()) {$IL1ILLI =$db->Record; $ILlL1l1["cat_id"] =$db->Record["cat_id"]; $ILlL1l1[I4796] =$db->Record[I4796]; if($IL1Ill1){ $this->cms->Gui->AddGlobalVars(array("ITEM_REL_ITEMS" => I4664)); $IL1ILLI[I4677] ='item'; }else{ $this->cms->Gui->AddGlobalVars(array("CAT_REL_ITEMS" => I4664)); $IL1ILLI[I4677] =I4681; }$null =I4748; $this->TITIT1l(0, $null, $db->Record, $IL1ILLl); if($IL1ILLl["props"] >0){ $this->oEshop->TITTT11(); }$aPriceData =$db->Record; $IL1ILLI['common_custom_fields'] =I4748; $aPriceData['itemid'] =$aPriceData[I4717]; $aPriceData["nav_data"] =$vData["nav_data"]; $IL1ILLI["base_price"] =$this->oEshop->TITTITI($aPriceData, $aPriceData, I4797, I4797); $IL1ILLI["other_prices"] =$this->oEshop->TITTITl($aPriceData, $aPriceData, I4797, I4797, "other_price"); $this->oEshop->TITTITT(); if($firstIter) {$firstIter =false; }else {$IL1IlI1["custom_field"] .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field", $IL1ILIL, $IL1IlI1); }$IL1IlI1[I4798] =$this->ILL1Lll[$this->ILL1lLL][$fName]; $this->mod->_GetNavDataCB($IL1ILLI, $ILlL1l1); $IL1ILLI[I4729] =$IllL11I[11].$IL1ILLI[I4729].$IllL11I[12]; $IL1ILLL =array(); foreach($this->ILL1l1I as $IL1ILlL){ $IL1ILLL[I4798] =$IL1ILlL["default_caption"][$this->mod->langData]; $IL1ILLL["custom_field"] =$db->Record[I4751.$IL1ILlL[I4672]]; $IL1ILL1 =array(I4692.$IL1ILlL[I4672], I4692.$IL1IlIL.$this->ILL1lII, $this->ILL1lII, I4692.$IL1IlIL); $IL1ILLI["common_custom_fields"] .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:item_custom_field", $IL1ILL1, $IL1ILLL); }$IIlLIIL =Array(I4799=>"_GetPicturesCB", I4722=> $_data =array(&$IL1ILLI, &$aTmp)); $this->mod->TTT1lI1($IIlLIIL, array('ext_images')); $IL1IlI1["custom_field"] .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field", $IL1ILIl, $IL1ILLI); }$this->mod->TTTlll1($IL1ILl1); $vData[$fName] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field", $IL1ILI1, $IL1IlI1); $vData[$IL1IlLL] =$vData[$fName]; if(!$IllL11I[20]) $vData[I4781] .= $vData[$fName]; }else{ $vData[$fName] =I4748; }}break; case I4786: $IL1IlI1[I4696] =I4690; if($IllL11I[13]){ $IL1IllI =array(I4696 => $IllL11I[14][$this->mod->langData], "details_id" => "ext_custom_".$IllL11I[1]); $IL1IlI1[I4696] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:field_details", $IL1ILI1, $IL1IllI); }$IL1ILlI =$this->mod->TTTlT11($fValue); if(sizeof($IL1ILlI) >0) {$sql ="SELECT id, name, announce, sublink FROM ".$this->oEshop->dbTablePrefix."_cats c WHERE id IN(".implode(",", $IL1ILlI).")  "; $db->query($sql); $firstIter =true; if($db->num_rows() >0) {$IL1IlI1["custom_field"] =I4690; $ILlL1l1 =Array("active_item_type" => I4800); while($db->next_record()) {$IL1ILLI =$db->Record; if($firstIter) {$firstIter =false; }else {$IL1IlI1["custom_field"] .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field", $IL1ILIL, $IL1IlI1); }$IL1IlI1[I4798] =$this->ILL1Lll[$this->ILL1lLL][$fName]; $this->mod->_GetNavDataCB($IL1ILLI, $ILlL1l1); $IL1ILLI[I4729] =$IllL11I[11].$IL1ILLI[I4729].$IllL11I[12]; $IL1IlI1["custom_field"] .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field", $IL1ILIl, $IL1ILLI); $IL1IL1I =$IllL11I[I4801]; if($IL1IL1I>0){ $IL1IL1l =new db_si(); $IL1IL1L =$IllL11I['rel_cat_item_field']; $IL1IL11 =$IllL11I['rel_cat_item_order']; $IL1IL11?$IL1IL11=I4748:$IL1IL11=' DESC '; $IL1ILll =I4690; foreach($this->ILL1l1I as $IL1ILlL){ $IL1ILll .= I4792.$IL1ILlL[I4672]; }$sql ="SELECT i.id, i.name, i.announce, i.sublink AS sublink, i.ext_picture, i.ext_small_picture, i.ext_popup_picture, i.sku, c.id AS cat_id, c.sublink AS cat_sublink". ", i.price AS price0,i.tax,i.tax_type". $this->oEshop->getPriceFields("i.price%d, SUBSTRING(c.price%d, INSTR(c.price%d, '#')+1) AS currency%d"). ", i.charge_tax_type,i.discount,i.discount_type, c.id_discount, c.dataset_id, c.dataset_data ".$IL1ILll. I4793.$this->oEshop->dbTablePrefix."_items i INNER JOIN ".$this->oEshop->dbTablePrefix."_cats AS c ON c.id=i.id_category WHERE c.id = ".$IL1ILLI[I4717].I4802.$IL1IL1L." ".$IL1IL11." LIMIT ".$IL1IL1I; $IL1IL1l->query($sql); if($IL1IL1l->num_rows() >0) {$IL1I1II =Array("active_item_type" => "body_items"); $aTmp =Array(I4795 => I4803); $IL1ILl1 =$this->mod->IIllII1; $this->mod->TTTlll1($this->oEshop->ownerName."_item"); $IL1I1Il =true; $IL1I1IL =I4748; while($IL1IL1l->next_record()) {$IL1I1I1 =$IL1IL1l->Record; $IL1I1II["cat_id"] =$IL1IL1l->Record["cat_id"]; $IL1I1II[I4796] =$IL1IL1l->Record[I4796]; if($IL1Ill1){ $this->cms->Gui->AddGlobalVars(array("ITEM_REL_ITEMS" => I4664)); $IL1I1I1[I4677] =I4804; }else{ $this->cms->Gui->AddGlobalVars(array("CAT_REL_ITEMS" => I4664)); $IL1I1I1[I4677] =I4681; }$null =I4748; $this->TITIT1l(0, $null, $IL1IL1l->Record, $IL1ILLl); if($IL1ILLl["props"] >0){ $this->oEshop->TITTT11(); }$aPriceData =$IL1IL1l->Record; $aPriceData['itemid'] =$aPriceData[I4717]; $aPriceData["nav_data"] =$vData[I4805]; $IL1I1I1["base_price"] =$this->oEshop->TITTITI($aPriceData, $aPriceData, I4797, I4797); $IL1IlI1["base_price_form"] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_base_price", array('_cats_items'), $IL1IlI1); $IL1I1I1[I4806] =$this->oEshop->TITTITl($aPriceData, $aPriceData, I4797, I4797, "other_price"); $this->oEshop->TITTITT(); if($IL1I1Il) {$IL1I1Il =false; }else {$IL1I1IL .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field_related_cats_items_splitter", I4748, $IL1IlI1); }$this->mod->_GetNavDataCB($IL1I1I1, $IL1I1II); $IL1I1I1[I4729] =$IllL11I[11].$IL1I1I1[I4729].$IllL11I[12]; $IL1ILLL =array(); foreach($this->ILL1l1I as $IL1ILlL){ $IL1ILLL[I4798] =$IL1ILlL["default_caption"][$this->mod->langData]; $IL1ILLL["custom_field"] =$IL1IL1l->Record[I4751.$IL1ILlL[I4672]]; $IL1ILL1 =array(I4692.$IL1ILlL[I4672], I4692.$IL1IlIL.$this->ILL1lII, $this->ILL1lII, I4692.$IL1IlIL); $IL1I1I1["common_custom_fields"] .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:item_custom_field", $IL1ILL1, $IL1ILLL); }$IIlLIIL =Array(I4799=>"_GetPicturesCB", I4722=> $_data =array(&$IL1I1I1, &$aTmp)); $this->mod->TTT1lI1($IIlLIIL, array('ext_images')); $IL1I1IL .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field_multi_related_cats_items", I4748, $IL1I1I1); }$IL1I1lI =array(I4807=>$IL1I1IL); $IL1IlI1["custom_field"] .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field_related_cats_items_list",I4748,$IL1I1lI); $this->mod->TTTlll1($IL1ILl1); }unset($IL1I1ll); }}$vData[$fName] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field", $IL1ILI1, $IL1IlI1); $vData[$IL1IlLL] =$vData[$fName]; if(!$IllL11I[20]) $vData[I4781] .= $vData[$fName]; }else{ $vData[$fName] =I4748; }}break; case I4733: $IL1IlI1["custom_field"] =I4690; $firstIter =true; $IL1I1lL =$IllL11I[18] == 1 ?1 :2; for($i =1; $i <= sizeof($IllL11I[5][I4808][$this->mod->langData]); $i++){ if($IllL11I[5][I4808][$this->mod->langData][$i][I4704] == I4664 && ($IL1I1lL == 1 || $IL1I1lL == 2 && $fValue[$i-1] == I4664)){ if($firstIter) {$firstIter =false; }else {$IL1IlI1["custom_field"] .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field", $IL1ILIL, $IL1IlI1); }$IL1IlI1[I4729] =$IllL11I[11].$IllL11I[5][I4808][$this->mod->langData][$i]["c"].$IllL11I[12]; $IL1IlI1["isactive"] =$fValue[$i-1] == I4664 ?I4664 :I4738; $IL1IlI1[I4809] .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field", $IL1ILIl, $IL1IlI1); }}$IL1IlI1[I4798] =$this->ILL1Lll[$this->ILL1lLL][$fName]; $IL1IlI1[I4696] =I4690; if($IllL11I[13]){ $IL1IllI =array(I4696 => $IllL11I[14][$this->mod->langData], "details_id" => "ext_custom_".$IllL11I[1]); $IL1IlI1[I4696] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:field_details", $IL1ILI1, $IL1IllI); }$vData[$fName] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field", $IL1ILI1, $IL1IlI1); $vData[$IL1IlLL] =$vData[$fName]; if(!$IllL11I[20]) $vData[I4781] .= $vData[$fName]; break; default: if(is_array($fValue)){ $IL1IlI1[I4798] =$this->ILL1Lll[$this->ILL1lLL][$fName]; $IL1IlI1[I4696] =I4690; $IL1IllI =array("details_id" => "ext_custom_".$IllL11I[1]); if($IllL11I[13]){ $IL1IllI[I4696] =$IllL11I[14][$this->mod->langData]; $IL1IlI1[I4696] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:field_details", $IL1ILI1, $IL1IllI); }$IL1IlI1[I4809] =I4690; $firstIter =true; if(is_array($fValue)){ foreach($fValue as $null => $value){ $IL1IlI1["ref_val_id"] =$value[0]; $IL1IlI1[I4777] =I4690; if(!empty($value[4]) && $value[0] >0){ $IL1I1l1 =$this->ILL1LII[I4665]; if(count($IL1I1l1) >0){ $this->TITT1lI(); $IL1I1LI =array(I4810 => $this->oEshop->ownerName.I4667, "linkAddon" => "|refnum=".$IllL11I[4], I4795 => "itemD_reference_item_"); $picData =array(I4777 => $value[4], I4710 => $value[0]); $IIlLIIL =Array(I4799=>"_GetPicturesCB", I4722=> $_data =array(&$picData, &$IL1I1LI)); $this->mod->TTT1lI1($IIlLIIL, array(I4811)); $IL1IlI1[I4777] =$picData[I4777]; $this->TITT1lI(false); }}if($IllL11I[2] == I4682){ $value[1] =floatval($value[1]); }$IL1IlI1["val_details"] =I4748; if($value[3] >0){ $IL1IllI["val_id"] =$value[3]; $IL1IlI1["val_details"] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:field_ref_details", $IL1IlII, $IL1IllI); }if(is_array($value)){ $IL1IlI1[I4812] =$value[2]; $value =$value[1]; }else $IL1IlI1[I4812] =I4664; if($firstIter) $firstIter =false; else $IL1IlI1[I4809] .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field", $IL1ILIL, $IL1IlI1); $IL1IlI1[I4729] =$IllL11I[11].$value.$IllL11I[12]; $IL1IlI1[I4809] .= $this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field", $IL1ILIl, $IL1IlI1); }}$vData[$fName] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field", $IL1ILI1, $IL1IlI1); $vData[$IL1IlLL] =$vData[$fName]; if(!$IllL11I[20]) $vData[I4781] .= $vData[$fName]; }else{ $IL1IllI =array("details_id" => I4813.$IllL11I[1]); if($IllL11I[2] == I4777 && !empty($fValue)){ $IL1IllI['picture'] =$fValue; $fValue =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_picture", $IL1IlII, $IL1IllI); }$IL1IlI1[I4798] =$this->ILL1Lll[$this->ILL1lLL][$fName]; if($IllL11I[2] == 'text'){ $IL1IlI1[I4809] =$IllL11I[11].unhtmlentities($fValue).$IllL11I[12]; }else{ $IL1IlI1[I4809] =$IllL11I[11].($IllL11I[2] == I4682 ?floatval($fValue) :$fValue).$IllL11I[12]; }$IL1IlI1[I4696] =I4690; $IL1IlI1["val_details"] =I4690; if($IllL11I[13]){ $IL1IllI[I4814] =$IllL11I[14][$this->mod->langData]; $IL1IlI1[I4696] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:field_details", $IL1IlII, $IL1IllI); }if($IL1IlLI >0){ $IL1IllI["val_id"] =$IL1IlLI; $IL1IlI1["val_details"] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:field_ref_details", $IL1IlII, $IL1IllI); }if(!empty($IL1ILII)) $IL1IlI1["custom_field_description"] =$IL1ILII; $IL1IlI1[I4777] =I4748; if(!empty($IL1IlL1) && $IL1Il11 >0){ $IL1I1l1 =$this->ILL1LII[I4665]; if(count($IL1I1l1) >0){ $this->TITT1lI(); $IL1I1LI =array(I4810 => $this->oEshop->ownerName.I4667, "linkAddon" => "|refnum=".$IllL11I[4], I4795 => "itemD_reference_item_"); $picData =array(I4777 => $IL1IlL1, I4710 => $IL1Il11); $IIlLIIL =Array(I4799=>"_GetPicturesCB", I4722=> $_data =array(&$picData, &$IL1I1LI)); $this->mod->TTT1lI1($IIlLIIL, array(I4811)); $IL1IlI1[I4777] =$picData[I4777]; $this->TITT1lI(false); }}$vData[$fName] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_custom_field", $IL1IlII, $IL1IlI1); $vData[$IL1IlLL] =$vData[$fName]; if(!$IllL11I[20]) $vData[I4781] .= $vData[$fName]; }break; }if($IILIILl[I4783] == I4784 && isset($vData[$fName])){ $IILIILl["list_data"][$fName] =$vData[$fName]; $IILIILl["list_data"][$IL1IlLL] =$vData[$fName]; }if (isset($vItemData['_pd'])) {$vItemData['_pd'][I4815][$fName] =$IllL11I[20]; }}if($IILIILl[I4783] == I4784){ $IILIILl["list_data"]['custom_field_all'] =$vData[I4781]; return; }if(sizeof($props) >0 && sizeof($IL1IllL) <= 0 && ($vItemData["show_all_props"] >0 || sizeof($this->ILL1Ll1) >0)){ if($this->GetOption("property_price")) $props[] =I4816; if($this->GetOption("property_rest")) $props[] ="_rest"; if($this->GetOption("property_weight")) $props[] ="_weight"; if($this->GetOption(I4817)) $props[] ="_size"; $IL1I1Ll =array(); $IL1I1LL =array(); if(is_array($this->ILL1lll)){ foreach($this->ILL1lll as $ILL11l1 => $IL1I1L1){ if(!isset($IL1I1L1[7]) || $IL1I1L1[7] != 1 || !$IL1I1L1[9]) continue; if($IL1I1L1[2] == I4733) $IL1I1Ll[] ="REVERSE(CONV(prop_".$IL1I1L1[1].", 10, 2)) as prop_".$IL1I1L1[1]; else{ $IL1I1Ll[] ="prop_".$IL1I1L1[1]; if($IL1I1L1[3] == I4708 && $IL1I1L1[4] >0){ $IL1I1LL[I4818.$IL1I1L1[1]] =array(); $sql ="select id, value_1, ext_picture from ".$this->oEshop->dbTablePrefix.I4721.sprintf(I4772, $IL1I1L1[4]); $this->db->query($sql); while($this->db->next_record()){ if(!empty($this->db->Record[I4787])) $IL1I1LL[I4818.$IL1I1L1[1]][$this->db->Record[I4788]] =array($this->db->Record[I4710], $this->db->Record[I4787]); }}}}}$IL1I11I =I4690; if(is_array($this->ILL1Ll1) && sizeof($this->ILL1Ll1) >0){ $IL1I11I =implode(" ", $this->ILL1Ll1); }$sql ="select ".implode(",", $IL1I1Ll).", rest, price, weight, size, id from ".$this->oEshop->dbTablePrefix."_props where id_item='".(empty($vItemData['id_source']) ?$cId :$vItemData['id_source'])."' and mask=1 and lang='".$this->mod->langData.I4819.(isset($vItemData['_pd']) ?"and id = '".$vItemData['propId'].I4728 :"and rest>0 ".$IL1I11I).I4820; $db->query($sql); $IL1I11l =array('data' => I4748); while($db->next_record()){ if (isset($vItemData['_pd'])) {$vItemData['_pd']['record'] =$db->Record; }$IL1I11L =array(I4821 => I4748); for($i =0; $i <sizeof($props); $i++){ $cur =$props[$i]; $IL1I111 =$cur[0] == I4692; $cur =$IL1I111 ?mb_substr($cur, 1) :$cur; if(!$IL1I111 && $this->ILL1lll[$cur][2] == I4733){ $IL1lIII =&$this->ILL1lll[$cur][5][I4808][$this->mod->langData]; $val =$db->Record[I4818.$this->ILL1lll[$cur][1]]; $IL1lIIl =array(I4729 => I4690); for($f =1; $f <= sizeof($IL1lIII); $f++){ if(($val[$f-1] == I4664 || $this->ILL1lll[$cur][18] == 1) && $IL1lIII[$f][I4704] == I4664){ if($f != 1) $IL1lIIl[I4729] .= $this->cms->Gui->getAbs($this->activeModule->GetName()."_list:itemD_property_flag_delimeter"); $IL1lIIl[I4729] .= $this->cms->Gui->getAbs($this->activeModule->GetName()."_list:itemD_property_flag".($val[$f-1] != I4664 ?"_notselected" :I4690), array(I4729 => $IL1lIII[$f]["c"])); }}}else if(!$IL1I111){ $IL1lIIl =array(I4729 => $db->Record[I4818.$this->ILL1lll[$cur][1]], I4822 => $db->Record[I4710]); if($this->ILL1lll[$cur][2] == I4777 && !empty($IL1lIIl[I4729])){ $IL1lIIl[I4729] =$this->cms->Gui->getAbs($this->activeModule->GetName()."_list:itemD_property_picture", array(I4777 => $IL1lIIl[I4729], I4672 => $this->ILL1lll[$cur][1])); }$IL1lIIL =I4818.$this->ILL1lll[$cur][1]; if(isset($IL1I1LL[$IL1lIIL]) && isset($IL1I1LL[$IL1lIIL][$db->Record[$IL1lIIL]]) && is_array($IL1I1LL[$IL1lIIL][$db->Record[$IL1lIIL]])){ $IL1I1l1 =$this->ILL1LII[I4665]; if(count($IL1I1l1) >0){ $this->TITT1lI(); $IL1I1LI =array(I4810 => $this->oEshop->ownerName.I4667, "linkAddon" => "|refnum=".$this->ILL1lll[$cur][4], I4795 => "itemD_"); $picData =array(I4777 => $IL1I1LL[$IL1lIIL][$db->Record[$IL1lIIL]][1], I4710 => $IL1I1LL[$IL1lIIL][$db->Record[$IL1lIIL]][0]); $IIlLIIL =Array(I4799=>I4823, I4722=> $_data =array(&$picData, &$IL1I1LI)); $this->mod->TTT1lI1($IIlLIIL, array(I4811)); $IL1lIIl[I4777] =$picData[I4777]; }if(count($IL1I1l1) >0) $this->TITT1lI(false); }}else{ $IL1lIIl =array(I4729 => $db->Record[$cur]); if($cur == "price"){ $IL1lII1 =array_merge($vData, array("itemid" => $vItemData[I4710], I4822 => $db->Record[I4710])); $IL1lIlI =array_merge($vItemData, array(I4769 => $db->Record["price"])); $IL1lIIl[I4729] =$this->oEshop->TITTITI($IL1lII1, $IL1lIlI, "itemProp", I4824); }}if($IL1I111) {$IL1lIll =$cur; $varName =$IL1lIll; }else {$IL1lIll =$this->ILL1lll[$cur][1]; $varName =I4729; }$IL1I11L[$varName] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_property_cell", $IL1lIll, $IL1lIIl); $IL1I11L[I4722] .= $IL1I11L[$varName]; }$IL1I11l[I4722] .= $this->cms->Gui->get($this->activeModule->GetName()."_list:itemD_property_row", $IL1I11L); }if(!empty($IL1I11l[I4722]) || isset($vItemData['_pd'])){ $IL1I11L =array(I4821 => I4748); for($i =0; $i <sizeof($props); $i++){ $cur =$props[$i]; $IL1I111 =$cur[0] == I4692; $cur =$IL1I111 ?mb_substr($cur, 1) :$cur; $IL1lIIl =array(I4729 => $IL1I111 ?$this->mod->words[I4818.$cur] :$this->ILL1lll[$cur][0]); $IL1lIIl[I4696] =I4690; if($this->ILL1lll[$cur][13]){ $IL1IllI =array(I4696 => $this->ILL1lll[$cur][14][$this->mod->langData], "details_id" => I4818.$this->ILL1lll[$cur][1]); $IL1lIIl[I4696] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:field_details", $IL1I111 ?$cur :$this->ILL1lll[$cur][1], $IL1IllI); }$IL1lIll =($IL1I111 ?$cur :$this->ILL1lll[$cur][1]); $IL1I11L[$IL1lIll] =$this->cms->Gui->getDefPostf($this->activeModule->GetName()."_list:itemD_property_Hcell", $IL1lIll, $IL1lIIl); $IL1I11L[I4722] .= $IL1I11L[$IL1lIll]; }$IL1I11l[I4722] =$this->cms->Gui->get($this->activeModule->GetName()."_list:itemD_property_Hrow", $IL1I11L).$IL1I11l[I4722]; $vData['property_data'] .= $this->cms->Gui->get( $this->activeModule->GetName() .'_list:itemD_property_data', $IL1I11l );if (isset($vItemData[I4825])) {unset($IL1I11L[I4821]); $vItemData[I4825]['captions'] =$IL1I11L; }}else{ $vData["property_data"] .= $this->cms->Gui->get($this->activeModule->GetName()."_list:itemD_property_".(sizeof($this->ILL1Ll1) >0 ?"no" :I4826), $IL1I11l); }}}}function TTIlll1($cId, &$vItemData, &$vData, &$IILIILl) {if($this->ILL1LLI == I4693 && $this->ILL1lIl[$this->ILL1lLL]["prop_repeat"] >0 && $this->ILL1lIl[$this->ILL1lLL][I4689] >0) $vData["value"] =I4690; $IL1lIlL =$this->oEshop->mEshop->GetOption("include_subcat_no_fields"); if(mb_strpos($vData["field"], I4813) !== false || mb_strpos($vData[I4827], I4818) !== false){ $ILL11LI =false; if(mb_strpos($vData[I4827], I4818) !== false){ $ILLI11I =intval(mb_substr($vData[I4827], 5)); $ILL11LI =true; }else $ILLI11I =intval(mb_substr($vData[I4827], 11)); $IL1lIl1 =(isset($this->ILL1lLI[($ILL11LI ?I4818 :I4690).$ILLI11I]) && $this->ILL1lLI[($ILL11LI ?I4818 :I4690).$ILLI11I] >= 0 ?$this->ILL1lLI[($ILL11LI ?I4818 :I4690).$ILLI11I] :-1); if(!$ILL11LI && $this->ILL1lll[$IL1lIl1]['show_empty_in_search']){ $this->mod->filter->IL11lLL[] =$vData[I4827]; }if($IL1lIl1 >= 0 && !in_array($ILLI11I, $this->ILL1LLL)){ $fType =$this->ILL1lll[$IL1lIl1][2]; $IL1lILI =$this->ILL1lll[$IL1lIl1][3]; $IL1lILl =$this->ILL1lll[$IL1lIl1][6]; $IL1lILL =$this->ILL1lll[$IL1lIl1][24]; $IL1lIL1 =$ILL11LI ?"i.id" :"i.custom_field_".$ILLI11I; if(!empty($IL1lILl)){ if(is_array($vData["value"])) {foreach($vData[I4828] as $index => $value) {$vData[I4828][$index] =stripslashes(unhtmlentities($value)); }}else {$vData[I4828] =stripslashes(unhtmlentities($vData[I4828])); }if($fType != I4733){ if($IL1lILl == I4720 && $IL1lILI != I4709 && $IL1lILI != I4706){ switch($IL1lILL){ case "inc": $condition ="like"; break; case "ninc": $condition ="not like"; break; case I4829: $condition ="!="; break; case "gt": $condition =">"; break; case "gte": $condition =I4830; break; case "lt": $condition ="<"; break; case "lte": $condition ="<="; break; case I4831: $condition ="[interval_".$fType."]"; break; case "iint": $condition ="(interval_".$fType.I4757; break; default: $condition =I4832; break; }}else{ $condition =($IL1lILI == I4708 || $IL1lILI == I4709 || $IL1lILI == I4706 || $ILL11LI ?I4832 :"like"); }if($IL1lILl == I4720){ if(($fType == I4782 || $fType == I4682) && mb_substr($vData[I4827], -4) == "from"){ $this->mod->filter->AddField($vData[I4827], I4720, $vData[I4828], I4690, I4830, "convert(".$IL1lIL1.",SIGNED)", I4690, 0, 1, $this->ILL1lll[$IL1lIl1][13]); }elseif(($fType == I4782 || $fType == I4682) && mb_substr($vData[I4827], -2) == I4833){ $this->mod->filter->AddField($vData[I4827], I4720, $vData[I4828], I4690, "<=", "convert(".$IL1lIL1.",SIGNED)", I4690, 0, 1, $this->ILL1lll[$IL1lIl1][13]); }else{ $this->mod->filter->AddField($vData[I4827], ($fType == I4743 ?I4743 :I4720), $vData[I4828], ($fType == I4743 ?false :I4690), $condition, $IL1lIL1, I4690, 0, 1, $this->ILL1lll[$IL1lIl1][13]); }if(is_array($vData[I4828]) && empty($vData[I4828][0]) && empty($vData[I4828][1]) || empty($vData[I4828])){ $this->mod->filter->DisableFieldSQL($vData[I4827]); }if($this->ILL1LLI == "body_search" && $this->cms->VarsGet[I4834] == I4664){ $IL1lI1I ="=| ".($IL1lIlL ?"OR" :"AND")." c.dataset_id ".($IL1lIlL ?I4835 :"in")." (".$this->ILL1lll[$IL1lIl1][17].I4757; $this->mod->filter->TITI1II($vData[I4827], $IL1lI1I, "force"); }}else if($IL1lILl == I4752 || $IL1lILl == "multiple_select" || $IL1lILl == I4836 || $IL1lILl == "radio"){ $this->TITITlI($vData, $IL1lIL1, $ILLI11I, $IL1lIl1, $this->ILL1lll[$IL1lIl1][13], $condition, $IL1lILl, array($this->ILL1lll[$IL1lIl1][5]["ref_sort"], $this->ILL1lll[$IL1lIl1][5]["ref_sort_method"])); if((!is_array($vData[I4828]) && $vData[I4828] == I4690) || (is_array($vData[I4828]) && (sizeof($vData[I4828]) == 0 || $vData[I4828][0] == I4690))) {$this->mod->filter->DisableFieldSQL($vData[I4827]); }}if(($IL1lILI == I4709 || $IL1lILI == I4706) && !empty($vData[I4828])){ if(!is_array($vData['value'])){ $vData[I4837] =array($vData[I4837]); }$db =new DB_si; $aCond =$this->mod->filter->GetLikeSQL( array_map( array('AMI_Lib_String', 'htmlChars'), $vData[I4837] ),'value_1', TRUE, I4748, '=' );$IL1lI1I =I4690; $sql =I4838.$this->oEshop->dbTablePrefix.I4721.sprintf(I4772, $this->ILL1lll[$IL1lIl1][4])." ". "WHERE 1".$aCond[I4705]; $db->query($sql); while($db->next_record()) {if($IL1lILI == I4706) $IL1lI1I .= " OR (position(';".$db->Record[I4710].";' in ".$IL1lIL1.I4839; else $IL1lI1I .= " OR ".$IL1lIL1."='".$db->Record[I4710].I4728; }if($this->ILL1LLI == "body_search" && $this->cms->VarsGet[I4834] == I4664) $IL1lI1I =" OR (".(!empty($IL1lI1I) ?mb_substr($IL1lI1I, 3) :I4738).I4840.($IL1lIlL ?"OR" :"AND")." c.dataset_id ".($IL1lIlL ?I4835 :"in").I4841.$this->ILL1lll[$IL1lIl1][17].I4757; $this->mod->filter->TITI1II($vData[I4827], $IL1lI1I, "force"); }else if(($IL1lILI != I4709 || $IL1lILI != I4706) && (is_array($vData[I4828]) ?!empty($vData[I4828][0]) :!empty($vData[I4828])) && $ILL11LI){ $db =new DB_si; $aCond =$this->mod->filter->GetLikeSQL($vData[I4828], I4818.$this->ILL1lll[$IL1lIl1][1], true, I4690, $condition); $IL1lI1I =I4690; $this->ILL1Ll1[] =$aCond[I4705]; $sql ="SELECT id_item FROM ".$this->oEshop->dbTablePrefix."_props ". "WHERE 1".$aCond[I4705]." and mask=1 group by id_item"; $db->query($sql); $IL1lI1l =array(); while($db->next_record()) {$IL1lI1l[] =$db->Record["id_item"]; }if(sizeof($IL1lI1l) >0){ $IL1lI1I .= " OR ".$IL1lIL1." in (".implode(",", $IL1lI1l).I4757; }if($this->ILL1LLI == I4842 && $this->cms->VarsGet[I4834] == I4664) $IL1lI1I =" OR (".(!empty($IL1lI1I) ?mb_substr($IL1lI1I, 3) :I4738).I4840.($IL1lIlL ?"OR" :"AND")." c.dataset_id ".($IL1lIlL ?I4835 :I4843).I4841.$this->ILL1lll[$IL1lIl1][17].I4757; $this->mod->filter->TITI1II($vData[I4827], $IL1lI1I, "force"); }}else{ if(($IL1lILI == I4709 || $IL1lILI == I4706 || $IL1lILI == I4708) && ($IL1lILl == I4752 || $IL1lILl == "multiple_select")){ $this->TITITlI($vData, $IL1lIL1, $ILLI11I, $IL1lIl1, $this->ILL1lll[$IL1lIl1][13], I4832, $IL1lILl, array($this->ILL1lll[$IL1lIl1][5]["ref_sort"], $this->ILL1lll[$IL1lIl1][5]["ref_sort_method"]), $this->ILL1lll[$IL1lIl1][5][I4808][$this->mod->langData]); if((!is_array($vData[I4828]) && $vData[I4828] == I4690) || (is_array($vData[I4828]) && (sizeof($vData[I4828]) == 0 || $vData[I4828][0] == I4690))) {$this->mod->filter->DisableFieldSQL($vData[I4827]); }}else{ $IL1lI1L =I4690; if(isset($this->mod->filter->Captions[$vData[I4827].I4844])) {$IL1lI1L =$this->mod->filter->Captions[$vData[I4827].I4844]; }else {$IL1lI1L =$this->mod->words["all"]; }$this->mod->filter->AddField($vData[I4827], I4733, $vData[I4828], I4690, $this->ILL1lll[$IL1lIl1][15], $IL1lIL1, array($IL1lILl, $this->ILL1lll[$IL1lIl1][5][I4808][$this->mod->langData], $IL1lI1L), 0, 1, $this->ILL1lll[$IL1lIl1][13]); if($this->ILL1LLI == I4842 && $this->cms->VarsGet[I4834] == I4664){ $IL1lI1I ="=| ".($IL1lIlL ?"OR" :"AND").I4845.($IL1lIlL ?I4835 :I4843).I4841.$this->ILL1lll[$IL1lIl1][17].I4757; $this->mod->filter->TITI1II($vData[I4827], $IL1lI1I, "force"); }if(mb_strpos(TlTllT1($vData[I4828]), I4664) === false) $this->mod->filter->DisableFieldSql($vData[I4827]); }if(($IL1lILI == I4709 || $IL1lILI == I4706 || ($IL1lILI == I4708 && ($IL1lILl == I4752 || $IL1lILl == "multiple_select"))) && !($IL1lILl == I4752 && empty($vData[I4828]) || $IL1lILl == "multiple_select" && empty($vData[I4828][0]))){ $db =new DB_si; $IL1lI11 =I4690; $IL1llII =1; if($IL1lILl == "multiple_select") $IL1llIl =$vData[I4828]; else if($IL1lILl == I4752) $IL1llIl =array($vData[I4828]); else{ $IL1llIL =sizeof($this->ILL1lll[$IL1lIl1][5][I4808][$this->mod->langData]); $realVal =I4690; $IL1llI1 =TlTllT1($vData[I4828]); $usedFlagsMask =array(); for($i =0; $i <ceil($IL1llIL/63); $i++){ $IL1lllI =strrev(mb_substr($IL1llI1, $i*63, 63)); if(mb_strpos($IL1lllI, I4664) === false) $realVal .= (!empty($realVal) ?I4846 :I4690)."00"; else $realVal .= (!empty($realVal) ?I4846 :I4690)."CONV('".(empty($IL1lllI) ?I4738 :$IL1lllI)."',2,10)"; }for($i =1; $i <= $IL1llIL; $i++){ $usedFlagsMask[ceil($i/63)].= ($this->ILL1lll[$IL1lIl1][5][I4808][$this->mod->langData][$i][I4704] == I4664 && $this->ILL1lll[$IL1lIl1][5][I4808][$this->mod->langData][$i]["f"] == I4664 ?I4664 :I4738); }$IL1llIl =array($realVal); $IL1llII =2; }for($i =0; $i <sizeof($IL1llIl); $i++){ $counter =1; if(!empty($IL1lI11)) $IL1lI11 .= I4847; foreach(explode(I4846, $IL1llIl[$i]) as $IL1llll){ if(empty($IL1llll)) $IL1llll =I4738; $IL1lllL =($IL1lILI == I4708 ?$IL1lIL1 :I4828).I4692.$counter; if($IL1llII == 1){ $IL1lI11 .= " AND ".$IL1lllL."='".$IL1llll.I4728; }else{ switch($this->ILL1lll[$IL1lIl1][15]){ case "equal": $IL1lI11 .= " AND ".$IL1lllL.I4848.strrev(str_pad($usedFlagsMask[$counter], 64, I4738))."', 2, 10)=".$IL1llll; break; case "like": if(mb_strpos($IL1llll, I4664) !== false) $IL1lI11 .= " AND ".$IL1lllL.I4848.strrev(str_pad($usedFlagsMask[$counter], 64, I4738))."', 2, 10)&".$IL1llll.I4849.$postfix; break; default: if(mb_strpos($IL1llll, I4664) !== false) $IL1lI11 .= " AND ".$IL1lllL.I4846.$IL1llll.I4832.$IL1lllL; break; }}$counter ++; }}if(!empty($IL1lI11)) $IL1lI11 =" AND (1".$IL1lI11.I4757; $IL1lI1I =I4690; if($IL1lILI == I4708){ $IL1lI1I .= " OR (1".$IL1lI11.I4757; }else{ $sql =I4838.$this->oEshop->dbTablePrefix.I4721.sprintf(I4772, $this->ILL1lll[$IL1lIl1][4])." ". I4850.$IL1lI11; $db->query($sql); while($db->next_record()) {if($IL1lILI == I4706) $IL1lI1I .= " OR (position(';".$db->Record[I4710].";' in ".$IL1lIL1.I4839; else $IL1lI1I .= " OR ".$IL1lIL1."='".$db->Record[I4710].I4728; }}if($this->ILL1LLI == I4842 && $this->cms->VarsGet[I4834] == I4664) $IL1lI1I =I4851.mb_substr($IL1lI1I, 3).I4840.($IL1lIlL ?"OR" :"AND").I4845.($IL1lIlL ?I4835 :I4843).I4841.$this->ILL1lll[$IL1lIl1][17].I4757; $this->mod->filter->TITI1II($vData[I4827], $IL1lI1I, "force"); }else if(($IL1lILI != I4709 || $IL1lILI != I4706) && $ILL11LI && !empty($vData[I4828])){ $db =new DB_si; $IL1lll1 =I4690; for($i =1; $i <= sizeof($this->ILL1lll[$IL1lIl1][5][I4808][$this->mod->langData]); $i++) $IL1lll1 .= $this->ILL1lll[$IL1lIl1][5][I4808][$this->mod->langData][$i][I4704] == I4664 && $this->ILL1lll[$IL1lIl1][5][I4808][$this->mod->langData][$i]["f"] == I4664 ?I4664 :I4738; $vData[I4828] =empty($vData[I4828]) ?I4738 :$vData[I4828]; $IL1llLI =I4690; $fldCount =$this->ILL1lll[$IL1lIl1][1]; switch($this->ILL1lll[$IL1lIl1][15]){ case I4852: $IL1llLI =I4818.$fldCount.I4848.strrev(str_pad($IL1lll1, 64, I4738))."', 2, 10)=CONV('".strrev(str_pad(TlTllT1($vData[I4828]), 64, I4738)).I4735; break; case "like": $IL1llLI =I4818.$fldCount.I4848.strrev(str_pad($IL1lll1, 64, I4738))."', 2, 10)&CONV('".strrev(str_pad(TlTllT1($vData[I4828]), 64, I4738))."', 2, 10)<>0"; break; default: $IL1llLI =I4818.$fldCount.I4853.strrev(str_pad(TlTllT1($vData[I4828]), 64, I4738))."', 2, 10)=prop_".$fldCount; break; }$this->ILL1Ll1[] =" AND ".$IL1llLI; $sql ="SELECT id_item FROM ".$this->oEshop->dbTablePrefix."_props ". I4854.$IL1llLI." and mask=1 group by id_item"; $db->query($sql); $IL1lI1l =array(); while($db->next_record()) {$IL1lI1l[] =$db->Record["id_item"]; }if(sizeof($IL1lI1l) >0){ $IL1lI1I .= " OR ".$IL1lIL1." in (".implode(I4855, $IL1lI1l).I4757; }else $IL1lI1I .= " OR ".$IL1lIL1." in (0)"; if($this->ILL1LLI == I4842 && $this->cms->VarsGet[I4834] == I4664) $IL1lI1I =I4851.mb_substr($IL1lI1I, 3).I4840.($IL1lIlL ?"OR" :"AND").I4845.($IL1lIlL ?I4835 :I4843).I4841.$this->ILL1lll[$IL1lIl1][17].I4757; $this->mod->filter->TITI1II($vData[I4827], $IL1lI1I, I4856); }}}}}}function TITITlI($vData, $IL1lIL1, $ILLI11I, $IL1lIl1, $hasDetails, $condition, $IL1llLl =false, $ILLLIII =false, $IL1llLL =false){ $db =new DB_si; $ILL11LI =(mb_strpos($vData['field'], I4818) !== false); switch($ILLLIII[0]){ case I4729: $IL1llL1 ="name "; break; case I4743: $IL1llL1 ="date "; break; case "position": $IL1llL1 =I4857; break; default: $IL1llL1 ="id "; break; }if($ILLLIII[1] == "desc") $IL1llL1 .= "desc"; else $IL1llL1 .= "asc"; $IL1ll1I =1; $values =I4690; if($IL1llLL !== false) $IL1ll1I =ceil(sizeof($IL1llLL)/63); for($i =1; $i <= $IL1ll1I; $i++) $values .= (empty($values) ?I4690 :I4858)."value_".$i; $IL1ll1l =I4748; $IL1ll1L =TRUE; $this->cms->Gui->addGlobalVars(array('CURRENT_CAT_ID', $this->mod->catId)); if($this->mod->catId >0 && $this->ILL1lll[$IL1lIl1]["filter_existent_items"] && ($this->ILL1lll[$IL1lIl1][3] == 'ref_value' || $this->ILL1lll[$IL1lIl1][3] == I4859)){ $aCategories =array($this->mod->catId); $IL1ll11 =$this->oEshop->mEshop->GetOption('show_all_subitems_level'); $sql ="SELECT `id` FROM " .$this->oEshop->dbTablePrefix ."_cats WHERE "; if( $IL1ll11 && $this->mod->lIII1Ll >= $IL1ll11 && $this->oEshop->ILlLLLL->GetOption('item_counters_on') ){if($this->ILL1L1l <$this->cms->Core->GetModOption(I4860, 'hard_ops_item_limit')){ $sql .= "`all_parents` LIKE '%," .$this->mod->catId .",%'"; }else {$IL1ll1L =FALSE; }}else{ $sql .= '`id_parent` = ' .$this->mod->catId; }if($IL1ll1L){ $sql .= I4861; $db->query($sql); while($db->next_record()){ $aCategories[] =$db->Record[I4717]; }$aValues =array(); $sql ='select distinct '.($ILL11LI ?'prop_' :'custom_field_').$ILLI11I.' as value from '.$this->oEshop->dbTablePrefix.($ILL11LI ?I4862 :'_items').' where id_category in ('.implode(',', $aCategories).') and public = 1'; unset($aCategories); $db->query($sql); while($db->next_record()){ $aValues[] =addslashes($db->Record[I4837]); }$IL1lLII =is_array($vData[I4828]) ?$vData[I4828] :array($vData[I4828]); foreach($IL1lLII as $IL1lLIl){ if(strlen($IL1lLIl) && !in_array($IL1lLIl, $aValues)){ $aValues[] =addslashes($IL1lLIl); }}$IL1ll1l =I4863.($this->ILL1lll[$IL1lIl1][3] == I4859 ?I4717 :'value_1').' in (\''.implode(I4700, $aValues).'\')'; unset($aValues); }}$sql ="SELECT id, name, ext_picture, ".($this->ILL1lll[$IL1lIl1][2] == I4682 ?$values.I4864 :"CONCAT(".$values.I4757)." as value_1 FROM ".$this->oEshop->dbTablePrefix.I4721.sprintf(I4772, $this->ILL1lll[$IL1lIl1][4])." WHERE lang='".$this->mod->langData.I4728.$IL1ll1l." ORDER BY ".$IL1llL1; $db->query($sql); $aLines =Array(); $IL1I1l1 =$this->ILL1LII[I4665]; if(count($IL1I1l1) >0){ $this->TITT1lI(); $IL1I1LI =array(I4810 => $this->oEshop->ownerName.I4667, I4865 => "|refnum=".$this->ILL1lll[$IL1lIl1][4]); if(sizeof($this->mod->ext) >0){ if(array_key_exists(I4811,$this->mod->ext)){ $IL1lLIL =array(&$this->mod->ext[I4811], I4823, $IL1I1LI, array(I4777)); }}}$aLines =$this->mod->filter->TITIl11($db, I4788, I4729, $this->ILL1LLl, $this->ILL1lll[$IL1lIl1][2] == I4682, $IL1lLIL); if(count($IL1I1l1) >0) $this->TITT1lI(false); $IL1lLI1 =($IL1llLl == "multiple_select" || $IL1llLl == I4836 )?"no_consider" :"all"; if(isset($this->mod->filter->Captions[$vData[I4827].I4692.$IL1lLI1])) {$IL1lI1L =$this->mod->filter->Captions[$vData[I4827].I4692.$IL1lLI1]; }else {$IL1lI1L =$this->mod->words[$IL1lLI1]; }switch($IL1llLl){ case I4866: case I4752: $aLines =$this->mod->filter->TITI1TT($aLines, Array($IL1lI1L=>I4690), $this->ILL1LLl, false); $this->mod->filter->AddField($vData[I4827], I4752, $this->cms->htmlchars($vData[I4828]), I4690, $condition, $IL1lIL1, $aLines, $IL1llLl == I4866, $IL1llLl == I4866 ?3 :1, $hasDetails); break; case "radio": $aLines =$this->mod->filter->TITI1TI($aLines, Array($IL1lI1L=>I4690), $this->ILL1LLl, false); $this->mod->filter->AddField($vData[I4827], "radio", $this->cms->htmlchars($vData[I4828]), I4690, $condition, $IL1lIL1, $aLines, 1, 1, $hasDetails); break; case I4836: $aLines =$this->mod->filter->TITI1Tl($aLines, Array($IL1lI1L=>I4690), $this->ILL1LLl, false); $this->mod->filter->AddField($vData[I4827], I4836, $this->cms->htmlchars($vData[I4828]), I4690, $condition, $IL1lIL1, $aLines, 1, 1, $hasDetails); break; }}function TITITll($cId, &$vItemData, &$vData, &$IILIILl){ $cId =intval($cId); $IL1lLlI =$IL1lLll =array(); $IL1lLlL =array(); $IL1lLl1 =false; $hasProps =false; $basePrice =0; $IL1lLLI =0; $IL1lLLl =I4690; $sql ="select price, weight, size from ".$this->oEshop->dbTablePrefix."_items where id=".$cId; $this->db->query($sql); if($this->db->next_record()){ $basePrice =floatval($this->db->Record[I4867]); $IL1lLLI =$this->db->Record["weight"]; $IL1lLLl =$this->db->Record["size"]; }$sql ="select * from ".$this->oEshop->dbTablePrefix."_props where id_item=".$cId.I4868.$this->mod->langData."' order by id"; $this->db->query($sql); while($this->db->next_record()){ if(!$IL1lLl1 && !$hasProps){ foreach($this->db->Record as $key => $val){ if(mb_strpos($key, I4818) === 0) $IL1lLlL[] =$key; }}if($this->db->Record["mask"] == I4664){ $IL1lLlI[] =$this->db->Record; $hasProps =true; }else{ $IL1lLll[] =$this->db->Record; $IL1lLl1 =true; }}for($i =0; $i <count($IL1lLlI); $i++){ $size =$IL1lLLl; $weight =I4690; $price =I4690; for($j =0; $j <count($IL1lLll); $j++){ $IL1lLLL =true; for($k =0; $k <count($IL1lLlL); $k++){ if(!($IL1lLll[$j][$IL1lLlL[$k]] == I4690 || $IL1lLll[$j][$IL1lLlL[$k]] == I4738 || $IL1lLll[$j][$IL1lLlL[$k]] == $IL1lLlI[$i][$IL1lLlL[$k]])){ $IL1lLLL =false; break; }}if($IL1lLLL){ if(($IL1lLll[$j]["mask"] &2) != 0){ $size =$IL1lLll[$j]["size"]; }if(($IL1lLll[$j][I4869] &4) != 0){ if(mb_strlen($IL1lLll[$j]["weight"]) >0 && in_array($IL1lLll[$j]["weight"][0], array("+", "-", I4870, "*"))){ $weight .= $IL1lLll[$j]["weight"]; }else $weight =$IL1lLll[$j]["weight"]; }if(($IL1lLll[$j][I4869] &8) != 0){ if(mb_strlen($IL1lLll[$j][I4867]) >0 && in_array($IL1lLll[$j][I4867][0], array("+", I4871, I4870, "*"))){ $price .= $IL1lLll[$j][I4867]; }else $price =$IL1lLll[$j][I4867]; }if($IL1lLll[$j]["stop"] == 1) break; }}if(mb_strlen($price) >0 && in_array($price[0], array("+", I4871, I4870, "*"))){ $price =floatval(@eval(I4872.$basePrice.$price.");")); }else if(mb_strlen($price) >0) $price =floatval(@eval(I4872.$price.");")); else $price =$basePrice; if(mb_strlen($weight) >0 && in_array($weight[0], array("+", I4871, I4870, "*"))){ $weight =floatval(@eval(I4872.$IL1lLLI.$weight.I4873)); }else if(mb_strlen($weight) >0) $weight =floatval(@eval(I4872.$weight.I4873)); else $weight =$IL1lLLI; if(mb_strlen($size) >0 && in_array($size[0], array("+", I4871, I4870, "*"))){ $size =floatval(@eval(I4872.$IL1lLLl.$size.I4873)); }else if(mb_strlen($size) >0) $size =floatval(@eval(I4872.$size.I4873)); else $size =$IL1lLLl; $sql ="update ".$this->oEshop->dbTablePrefix."_props set size='".addslashes($size).I4874.addslashes($weight)."', price='".addslashes($price)."' where id=".intval($IL1lLlI[$i][I4710]); $this->db->query($sql); }}function TITITl1($cId, &$vItemData, &$vData, &$IILIILl){ $IILIILl["rest"] =0; if($vData[I4822] >0){ $db =new DB_Si; $sql ="select rest from ".$this->oEshop->dbTablePrefix.I4875.intval($vData[I4822]); $db->query($sql); if($db->next_record()){ $IILIILl["rest"] =$db->Record["rest"]; }}}function TITIT1T($cId, &$vItemData, &$vData, &$IILIILl){ $IILIILl["desc"] =I4690; $IILIILl["desc_arr"] =array(); $vData[I4822] =intval($vData[I4822]); $IL1lLL1 =($vData[I4822] >0 || $vData[I4822] <0); if($IL1lLL1) {$db =new DB_Si; $IL1lL1I =array(); if($this->ILL1lLl){ $IL1lL1l =$this->ILL1lLL; $IL1lL1I =$this->ILL1lL1; }if($vData[I4822] >0){ $sql ="select c.dataset_data, c.dataset_id from ".$this->oEshop->dbTablePrefix."_props p LEFT JOIN ".$this->oEshop->dbTablePrefix."_cats c ON p.id_category=c.id where c.id>0 and p.id=".$vData[I4822]; }else {$vData["itemId"] =intval($vData["itemId"]); $sql ="select c.dataset_data, c.dataset_id from ".$this->oEshop->dbTablePrefix."_items i LEFT JOIN ".$this->oEshop->dbTablePrefix."_cats c ON i.id_category=c.id where c.id>0 and i.id=".$vData["itemId"]; }$db->query($sql); if($db->next_record()){ $this->setDataset($db->Record["dataset_id"], unserialize($db->Record[I4699])); $props =array(); if(is_array($this->ILL1lll)){ foreach($this->ILL1lll as $num => $IllL11I){ if($IllL11I[7] == I4664 && $IllL11I[9]){ $props[] =$num; continue; }}}if($vData[I4822] >0) {$IL1I1Ll =array(); if(is_array($this->ILL1lll)){ foreach($this->ILL1lll as $ILL11l1 => $IL1I1L1){ if($IL1I1L1[7] != 1 || !$IL1I1L1[9]) continue; if($IL1I1L1[2] == I4733) $IL1I1Ll[] =I4876.$IL1I1L1[1].", 10, 2)) as prop_".$IL1I1L1[1]; else $IL1I1Ll[] =I4818.$IL1I1L1[1]; }}$sql ="select ".implode(I4855, $IL1I1Ll).", rest, price, weight, size from ".$this->oEshop->dbTablePrefix.I4875.$vData[I4822]; $db->query($sql); if($db->next_record()){ $IL1I11L =array(); for($i =0; $i <sizeof($props); $i++){ $cur =$props[$i]; if($this->ILL1lll[$cur][2] == I4733){ $IL1lIII =&$this->ILL1lll[$cur][5][I4808][$this->cms->lang_data]; $val =$db->Record[I4818.$this->ILL1lll[$cur][1]]; $idx =count($IILIILl["desc_arr"]); $IILIILl[I4877][$idx] =array(I4729 => $this->ILL1lll[$cur][0], I4828 => array()); for($f =1; $f <= sizeof($IL1lIII); $f++){ if(($val[$f-1] == I4664 || $this->ILL1lll[$cur][18] == 1) && $IL1lIII[$f][I4704] == I4664){ $IILIILl[I4877][$idx][I4828][] =array($IL1lIII[$f]["c"], $val[$f-1] == I4664); }}}else if($this->ILL1lll[$cur][2] !== I4777){ $IILIILl[I4877][] =array(I4729 => $this->ILL1lll[$cur][0], I4828 => $db->Record[I4818.$this->ILL1lll[$cur][1]], "type" => $this->ILL1lll[$cur][2]); }}}}else {for($i =0; $i <sizeof($props); $i++){ $cur =$props[$i]; if($this->ILL1lll[$cur][2] !== I4777){ $IL1lL1L =abs($vData[I4822]) -1; $IILIILl[I4877][] =array(I4729 => $this->ILL1lll[$cur][0], I4828 => $this->cms->Vars[I4818.$this->ILL1lll[$cur][1]][$IL1lL1L], "type" => $this->ILL1lll[$cur][2]); $IL1lL11 ="a".md5(serialize($IILIILl[I4877])); $IILIILl["correctedItemPropId"] =$IL1lL11; }}}}if(count($IL1lL1I) >0) $this->setDataset($IL1lL1l, $IL1lL1I); }}function TITIT1I($cId, &$vItemData, &$vData, &$IILIILl){ $IILIILl["desc"] =I4690; if(is_array($vData[I4877]) && !empty($vData["propPref"])){ for($i =0; $i <count($vData[I4877]); $i++){ if(is_array($vData[I4877][$i])){ $IL1l1II =array(); if($i >0){ $IILIILl["desc"] .= $this->cms->Gui->get($vData["blockName"].I4878.$vData["propPref"]."_property_delimeter", $IL1l1II); }if(is_array($vData[I4877][$i][I4828])){ $IL1l1II[I4729] =$vData[I4877][$i][I4729]; $IILIILl["desc"] .= $this->cms->Gui->get($vData["blockName"].I4878.$vData[I4879]."_property_caption", $IL1l1II); for($j =0; $j <count($vData[I4877][$i][I4828]); $j++){ if($j >0){ $IILIILl["desc"] .= $this->cms->Gui->get($vData["blockName"].I4878.$vData[I4879]."_property_flag_delimeter", $IL1l1II); }$IL1l1II[I4729] =$vData[I4877][$i][I4828][$j][0]; if($vData[I4877][$i][I4828][$j][1]) $IILIILl[I4880] .= $this->cms->Gui->get($vData["blockName"].I4878.$vData[I4879]."_property_flag", $IL1l1II); else $IILIILl[I4880] .= $this->cms->Gui->get($vData["blockName"].I4878.$vData[I4879]."_property_flag_inactive", $IL1l1II); }}else{ $IL1l1II[I4729] =$vData[I4877][$i][I4729]; $IILIILl[I4880] .= $this->cms->Gui->get($vData[I4881].I4878.$vData[I4879]."_property_caption", $IL1l1II); $IL1l1II[I4729] =$vData[I4877][$i][I4828]; $IILIILl[I4880] .= $this->cms->Gui->get($vData[I4881].I4878.$vData[I4879]."_property_value", $IL1l1II); }}}}}function TITIT1l($cId, &$vItemData, &$vData, &$IILIILl){ $IILIILl =array("props" => 0, "custom" => 0); if($vData[I4882] >0 && !empty($vData[I4699])){ $ILLlIII =unserialize($vData[I4699]); if(is_array($ILLlIII) && isset($ILLlIII[I4679])){ $this->TITIITI($ILLlIII['fields_map']); foreach(explode(I4676, $ILLlIII[I4679]) as $ILL11l1){ if($ILL11l1 >0 && $ILL11l1 <100000){ if(in_array($ILL11l1, $this->ILL1llI)) $IILIILl["props"]++; else $IILIILl["custom"]++; }}}}}function TITIT11($cId, &$vItemData, &$vData, &$IILIILl){ $IILIILl =array(); if($this->ILL1lLl && is_array($this->ILL1lll)){ foreach($this->ILL1lll as $i => $IllL11I){ if(isset($IllL11I[2]) && $IllL11I[2] == I4744 && !$IllL11I[7] && ($IllL11I[3] == I4714 || $IllL11I[3] == I4708) && $IllL11I[9]){ $IILIILl[] =I4751.intval($IllL11I[1]); }}}}function TITIITT($value) {$this->ILL1LII["show_ref_items_in_admin"] =$value; }public function isFieldNotLoaded($fieldId){ return intval($fieldId) >100000 ?false :!isset($this->ILL1lIL[$fieldId]); }private function TITIITI($IL1l1Il =I4748){ if(!$this->ILL1LL1){ return; }$dataLang =is_object($this->mod) ?$this->mod->langData :$this->cms->lang_data; if(is_string($IL1l1Il) && !mb_strlen($IL1l1Il)){ if($GLOBALS['ExtEshopCustomFields_CommonStorage']->IL1l11I){ return; }$GLOBALS['ExtEshopCustomFields_CommonStorage']->IL1l11I =true; $sql ="SELECT `fields_shared` ". "FROM " .$this->oEshop->dbTablePrefix ."_datasets " .I4883 .$dataLang .I4819 ."LIMIT 1"; $IL1l1Il =$this->db->getValue($sql); if(!$IL1l1Il){ return; }}if(is_string($IL1l1Il)){ $IL1l1Il =explode(I4724, trim($IL1l1Il, I4724)); }$IL1l1Il =array_filter($IL1l1Il, 'is_numeric'); $IL1l1Il =array_filter($IL1l1Il, array($this, 'isFieldNotLoaded')); if(!sizeof($IL1l1Il)){ return; }$IL1l1IL =' WHERE `id` IN(' .implode(I4884, $IL1l1Il) .')'; $Il1111I =array(); $IL1l1I1 =array(); if($this->cms->Core->Side == "admin"){ if((mb_substr($this->_moduleName, -4) == "_cat") && $this->ILL1LII["category_custom_types_allowed"]){ $IL1l1IL .= " AND type_owner = 'category'"; $this->ILL1LII["is_category_custom_fields"] =true; }elseif($this->ILL1LII["category_custom_types_allowed"]){ $IL1l1IL .= " AND type_owner = 'item'"; }}$sql ="SELECT * FROM " .$this->oEshop->dbTablePrefix .I4885 .$IL1l1IL; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ $IL1l1lI =$record[I4710]; $this->ILL1lIL[$IL1l1lI] =$record; $this->ILL1lIL[$IL1l1lI]['is_system'] =false; $this->ILL1lIL[$IL1l1lI]['type_owner'] =$record['type_owner']; $this->ILL1lIL[$IL1l1lI]['name'] =unserialize($record[I4886]); $this->ILL1lIL[$IL1l1lI]['default_caption'] =unserialize($record['default_caption']); $this->ILL1lIL[$IL1l1lI]['default_params'] =unserialize($record['default_params']); $this->ILL1lIL[$IL1l1lI][I4887] =unserialize($record[I4887]); $this->ILL1lIL[$IL1l1lI]['prefix'] =unserialize($record['prefix']); $this->ILL1lIL[$IL1l1lI]['postfix'] =unserialize($record['postfix']); $IL1l1ll =unserialize($record[I4887]); $this->ILL1lIL[$IL1l1lI][I4888] =(isset($IL1l1ll[$dataLang]) && (mb_strlen($IL1l1ll[$dataLang]) >0)); $this->ILL1lIL[$IL1l1lI][I4814] =$IL1l1ll; $this->ILL1lIL[$IL1l1lI]['datasets'] =I4748; if($record['is_prop']){ $this->ILL1llI[] =$record[I4717]; }unset($this->ILL1lIL[$IL1l1lI][I4717], $this->ILL1lIL[$IL1l1lI]['modified_date']); if(in_array($record['value_type'], array(I4889, I4859, 'ref_set')) && $record[I4697] >0){ $Il1111I[intval($record[I4697])][] =$IL1l1lI; $IL1l1I1[] =intval($record[I4697]); }}$sql ="select id, prop_repeat, fields_map, fields_captions from ".$this->oEshop->dbTablePrefix."_datasets"; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ $IL1l1lL =$record[I4710]; $this->ILL1lIl[$IL1l1lL] =array( "prop_repeat" => $record[I4890], 'num_no_rest' => 0 );$IL1l1l1 =unserialize($record[I4675]); if(is_array($IL1l1l1)){ foreach($IL1l1l1 as $IL1l1LI => $IL1l1Ll){ if(isset($this->ILL1lIL[$IL1l1LI])){ $IL1l1Ll =preg_replace('/^(.*?)\[.*?\]\s*$/', '\1', $IL1l1Ll); $this->ILL1Lll[$IL1l1lL][($this->ILL1lIL[$IL1l1LI][I4671] ?I4818 :I4751).$this->ILL1lIL[$IL1l1LI][I4672]] =$IL1l1Ll; }}}$IL1l1LL =explode(I4724, $record[I4679]); foreach($IL1l1LL as $IL1l1LI){ if(isset($this->ILL1lIL[$IL1l1LI])){ $this->ILL1lIL[$IL1l1LI]["datasets"] .= (!empty($this->ILL1lIL[$IL1l1LI][I4891]) ?I4884 :I4748).$IL1l1lL; if($this->ILL1lIL[$IL1l1LI]["no_rest"]){ $this->ILL1lIl[$IL1l1lL]['num_no_rest'] ++; }}}}if(sizeof($IL1l1I1) >0){ $sql ="select table_num, sys_alias from ".$this->oEshop->dbTablePrefix."_ref_types where table_num in(".implode(I4855, $IL1l1I1).I4757; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ if(!empty($record[I4892]) && is_array($Il1111I[$record["table_num"]])){ for($i =0; $i <sizeof($Il1111I[$record["table_num"]]); $i++){ $this->ILL1lIL[$Il1111I[$record["table_num"]][$i]][I4680] =true; }}}}$this->ILL1llL =$this->cms->Core->GetModProperty($this->oEshop->ownerName."_datasets", I4893); if(is_array($this->ILL1llL)){ foreach($this->ILL1llL as $pref => $IL1l1L1){ if($IL1l1L1 <100000) $this->ILL1llL[$pref] =$IL1l1L1 +100000; }}}}class ExtEshopCustomFields_CommonStorage{ public $IL1l11I =false; public $ILL1lIl =array(); public $ILL1lIL =array(); public $ILL1llI =array(); public $ILL1llL =array(); public $homeFields =array(); public $ILL1Lll =array(); }$GLOBALS['ExtEshopCustomFields_CommonStorage'] =new ExtEshopCustomFields_CommonStorage; 