<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       41501 xkqwlgzinpprppxmttsrstryqtixgqkwpuzmqttrxmlkizixgipnlqlsxwpkrigzplqrpnir
 */ ?><?php foreach(array(4912=>"MtQI|GMWturQD",4913=>"",4914=>"GMWturQ|IZxOQMPOt",4915=>"CZtQrIZrK|IQtOHS",4916=>"CZtQrIZrK|ZJGOZ",4917=>"DtZtMW|CZtQrIZrK",4918=>"WQntQr",4919=>"85",4920=>'IuJtM|uDQr',4921=>"Qxt|MIZPQD",4922=>"WHJ|GMWturQ|tBGQ",4923=>'Qxt|GMWturQ',4924=>'Qxt|DIZJJ|GMWturQ',4925=>"WZJJYZWK",4926=>"SQfZuJt|GrQfMx",4927=>"Qxt|GMWturQ",4928=>'DZvQ',4929=>'IHSmS',4930=>'GZtO',4931=>"|URj",4932=>'Qxt|ZWtMHn',4933=>"GMWturQ",4934=>"YMP|GMWturQ",4935=>"nZIQ|fMQJS|nZIQ",4936=>'YHSB|urPQnt|WZtD',4937=>"WZtD|IHSuJQ|nZIQ",4938=>"GZPQ|MtQI|tBGQ",4939=>"fMQJSD",4940=>'DIZJJ|GMWturQ',4941=>"Qxt|",4942=>"JMnKzSSHn",4943=>"|GMWturQ|WHJ",4944=>"IHSNZIQ",4945=>'GMWturQ',4946=>'DIZJJ|',4947=>"tMtJQ",4948=>"ZJt",4949=>']EuHt^',4950=>"CMStO",4951=>'GMWturQ|GZtO|CCC',4952=>"PuMiHSNZIQ",4953=>"GHGuG|",4954=>"GHGuG|GMWturQ|DrW",4955=>"OQMPOt",4956=>"GHGuG|GMWturQ",4957=>"DMIGJQ|GrQfMx",4958=>'PuMiHSNZIQ',4959=>"GZrZI",4960=>"RhhT|gzTo",4961=>"RhhT|gzTo|ccc",4962=>"DrW",4963=>"GMWturQ|GHDtf",4964=>"DIZJJ|",4965=>"]DrW=|||PQn=1_IHS=",4966=>"|rQturn",4967=>']IHSuJQ=',4968=>"GMW|",4969=>'PQnQrZtQ|',4970=>"ZWtMHn",4971=>'Qxt|') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ExtImages extends CMS_ExtModule {public $II1lIl1; public $ILLLLLL; public $IL1LII1; function ExtImages() {$this->IL1LII1 =false; parent::CMS_ExtModule(); }function Init(&$cms, &$IlIlIl1, &$IlIlILI) {$aDefault["col_picture_type"] ="none"; if ($IlIlILI->module->IssetOption(I4912)) {$aDefault[I4912] =$IlIlILI->module->GetAOption(I4912); }$IlIlILI->options += $aDefault; parent::Init($cms, $IlIlIl1, $IlIlILI); $this->TTIll11($IlIlILI->moduleName, $vItemData, $vData, $IILIILl); }function TTIll11($cId, &$vItemData, &$vData, &$IILIILl) {$moduleName =$cId; $this->mod->options["generate_pictures"] =$this->mod->cms->Core->IssetModOption($moduleName, "generate_pictures") ?$this->mod->cms->Core->GetModOption($moduleName, "generate_pictures") :array(); $this->mod->options["prior_source_picture"] =$this->mod->cms->Core->IssetModOption($moduleName, "prior_source_picture") ?$this->mod->cms->Core->GetModOption($moduleName, "prior_source_picture") :""; $this->mod->options["generate_picture_postf"] =$this->mod->cms->Core->IssetModProperty($moduleName, "generate_picture_postf") ?$this->mod->cms->Core->GetModProperty($moduleName, "generate_picture_postf") :""; $this->mod->options["generate_small_picture_postf"] =$this->mod->cms->Core->IssetModProperty($moduleName, "generate_small_picture_postf") ?$this->mod->cms->Core->GetModProperty($moduleName, "generate_small_picture_postf") :I4913; $this->mod->options["picture_maxwidth"] =$this->mod->cms->Core->IssetModOption($moduleName, "picture_maxwidth") ?$this->mod->cms->Core->GetModOption($moduleName, "picture_maxwidth") :I4913; $this->mod->options["picture_maxheight"] =$this->mod->cms->Core->IssetModOption($moduleName, I4914) ?$this->mod->cms->Core->GetModOption($moduleName, I4914) :I4913; $this->mod->options["popup_picture_maxwidth"] =$this->mod->cms->Core->IssetModOption($moduleName, "popup_picture_maxwidth") ?$this->mod->cms->Core->GetModOption($moduleName, "popup_picture_maxwidth") :I4913; $this->mod->options["popup_picture_maxheight"] =$this->mod->cms->Core->IssetModOption($moduleName, "popup_picture_maxheight") ?$this->mod->cms->Core->GetModOption($moduleName, "popup_picture_maxheight") :I4913; $this->mod->options["small_picture_maxwidth"] =$this->mod->cms->Core->IssetModOption($moduleName, "small_picture_maxwidth") ?$this->mod->cms->Core->GetModOption($moduleName, "small_picture_maxwidth") :I4913; $this->mod->options["small_picture_maxheight"] =$this->mod->cms->Core->IssetModOption($moduleName, "small_picture_maxheight") ?$this->mod->cms->Core->GetModOption($moduleName, "small_picture_maxheight") :I4913; $this->mod->options["generate_bigger_image"] =$this->mod->cms->Core->IssetModOption($moduleName, "generate_bigger_image") ?$this->mod->cms->Core->GetModOption($moduleName, "generate_bigger_image") :false; $this->mod->options["watermark_postf"] =$this->mod->cms->Core->IssetModOption($moduleName, "watermark_postf") && $this->mod->cms->Core->IssetModOption($moduleName, "watermark_postf") ?$this->mod->cms->Core->GetModOption($moduleName, "watermark_postf") :I4913; $this->mod->options[I4915] =$this->mod->cms->Core->IssetModOption($moduleName, I4915) && $this->mod->cms->Core->IssetModOption($moduleName, I4915) ?$this->mod->cms->Core->GetModOption($moduleName, I4915) :"center"; $this->mod->options["watermark_alpha"] =$this->mod->cms->Core->IssetModOption($moduleName, "watermark_alpha") && $this->mod->cms->Core->IssetModOption($moduleName, "watermark_alpha") ?$this->mod->cms->Core->GetModOption($moduleName, I4916) :"100"; $this->mod->options["static_watermark"] =$this->mod->cms->Core->IssetModOption($moduleName, "static_watermark") && $this->mod->cms->Core->IssetModOption($moduleName, "static_watermark") ?$this->mod->cms->Core->GetModOption($moduleName, I4917) :I4913; $this->mod->options["static_watermark_method"] =$this->mod->cms->Core->IssetModOption($moduleName, "static_watermark_method_pictures") && $this->mod->cms->Core->IssetModOption($moduleName, "static_watermark_method") ?$this->mod->cms->Core->GetModOption($moduleName, "static_watermark_method") :I4918; $this->mod->options["static_watermark_alpha"] =$this->mod->cms->Core->IssetModOption($moduleName, "static_watermark_alpha") && $this->mod->cms->Core->IssetModOption($moduleName, "static_watermark_alpha") ?$this->mod->cms->Core->GetModOption($moduleName, "static_watermark_alpha") :I4919; if (!empty($this->mod->options[I4917]) && !is_file($GLOBALS["ROOT_PATH"] .$this->mod->options[I4917])) $this->mod->options[I4917] =I4913; $this->mod->options['use_special_list_view'] =$this->mod->cms->Core->TTlI1IT($moduleName, 'use_special_list_view') && ('admin' != $this->mod->side ?!$this->db->attr(I4920) :TRUE); $this->mod->options["col_picture_type"] =$this->mod->cms->Core->IssetModOption($moduleName, "col_picture_type") && $this->mod->cms->Core->IssetModOption($moduleName, "col_picture_type") ?$this->mod->cms->Core->GetModOption($moduleName, "col_picture_type") :I4913; parent::TTIll11($cId, $vItemData, $vData, $IILIILl); }function GetModuleName() {return I4921; }function ProcessAction(&$IIIL11l, $cId, &$vItemData, &$vData, &$IILIILl) {switch ($IIIL11l) {case "_GetPicturesCB": $this->_GetPicturesCB($vData[0], $vData[1]); break; case "_genLinkToPic": $this->_genLinkToPic($vData[0], $vData[1], $vData[2], $vData[3], $vData[4], $vData[5], $vData[6], $vData[7]); break; case "_preparePicsData": $this->_preparePicsData($vData[0], $vData[1]); break; case "_OverrideGenPicModName": $this->_OverrideGenPicModName($vData[0]); break; default: parent::ProcessAction($IIIL11l, $cId, $vItemData, $vData, $IILIILl); break; }}function TTIlI11($cId, &$vItemData, &$vData, &$IILIILl) {parent::TTIlI11($cId, $vItemData, $vData, $IILIILl); }function TTIllTI($cId, &$vItemData, &$vData, &$IILIILl) {$aDefault[I4912] =Array(); $aDefault[I4922] ="none"; if ($this->mod->module->IssetOption(I4912)) {$aDefault[I4912] =$this->mod->module->GetAOption(I4912); if ($this->mod->module->IssetOption(I4922)) {$ILLL1l1 =$this->mod->module->GetOption(I4922); if (in_array($ILLL1l1, $aDefault[I4912])) {$aDefault[I4922] =$ILLL1l1; }}}$this->mod->options += $aDefault; $this->cms->Gui->addBlock(I4921, "templates/ext_images.tpl"); if (AMI_Registry::get('oldenv_inside_newenv', FALSE) === TRUE) {$this->cms->Gui->addBlock($this->mod->moduleName ."_list", "templates/_icons.tpl"); }$this->_genPictures =array(); if ($this->mod->module->IssetOption(I4912)) {$this->_genPictures =$this->mod->module->GetAOption(I4912); if (!is_array($this->_genPictures)) $this->_genPictures =array(); $genPics =array(); if (sizeof($this->_genPictures) >0 && $this->mod->module->IssetOption("generate_pictures")) {foreach ($this->mod->module->GetOption("generate_pictures") as $key => $picType) $genPics[] =$picType; }$this->_genPictures =$genPics; }if (sizeof($this->_genPictures) >0) {require_once $GLOBALS['CLASSES_PATH'] .'IMG_Proc.php'; }parent::TTIllTI($cId, $vItemData, $vData, $IILIILl); }function TTIllIl($cId, &$vItemData, &$vData, &$IILIILl) {if ($vItemData and is_array($vItemData)) {if (array_key_exists(I4923, $vItemData)) {$vItemData['picture'] =$vItemData[I4923]; }if (array_key_exists('ext_popup_picture', $vItemData)) {$vItemData['popup_picture'] =$vItemData['ext_popup_picture']; }if (array_key_exists(I4924, $vItemData)) {$vItemData['small_picture'] =$vItemData[I4924]; }}parent::TTIllIl($cId, $vItemData, $vData, $IILIILl); }function TTIllI1($cId, &$vItemData, &$vData, &$IILIILl) {if ($this->mod->options[I4922] != "none") {$IILIILl["list_data"]["_picture_header"] =$this->mod->cms->Gui->getAbs($this->mod->moduleName ."_list:_picture_header", Array("_picture_title" => $this->mod->words[$this->mod->options[I4922]])); if (is_array($this->mod->options[I4912])) {if (count($this->mod->options[I4912]) == 0) $IL1LIlI =$this->mod->options[I4912][0]; else $IL1LIlI ="small_picture"; $IILIILl["fields"][$IL1LIlI] =Array("action" => I4925, "object" => &$this, "method" => "_colPictureCB"); if (in_array("small_picture", $this->mod->options[I4912])) $this->mod->browser->TI1TITl($this->mod->options[I4926] ."ext_small_picture"); if (in_array("popup_picture", $this->mod->options[I4912])) $this->mod->browser->TI1TITl($this->mod->options[I4926] ."ext_popup_picture"); if (in_array("picture", $this->mod->options[I4912])) $this->mod->browser->TI1TITl($this->mod->options[I4926] .I4927); }}foreach ($this->mod->options[I4912] as $picture) {$this->_preparePicsData($vData, $picture); }$vData['ext_images'] =$this->cms->Gui->get("ext_images:main_body", $vData); parent::TTIllI1($cId, $vItemData, $vData, $IILIILl); }function TTIl1I1($cId, &$vItemData, &$vData, &$IILIILl) {$IL1LIll =isset($this->mod->cms->VarsPost['action_original']) ?$this->mod->cms->VarsPost['action_original'] != I4928 :true; foreach ($this->_genPictures as $key => $picType) {$aData =array(); $genData =IMG_PROC::TIT1II1($this->mod->module, $this->mod->db, $this->mod->moduleName, intval($cId), $picType, $aData); if ($IL1LIll && $genData[3] && !empty($genData[0])) {$imgData =imageGetSize($genData[1]); if ($imgData) {if (!isset($this->_picsGenerated)){ $this->_picsGenerated =array(); }if($genData[4]){ $aEvent =array( 'action' => isset($IILIILl['ext_action']) ?$IILIILl['ext_action'] :'unknown', I4929 => $this->mod->moduleName, 'oExt' => $this, 'aImage' => array( 'type' => $picType, 'url' => &$genData[0], I4930 => &$genData[1], 'width' => &$imgData[0], 'height' => &$imgData[1] ));AMI_Event::fire('v5_on_ext_image_generated', $aEvent, AMI_Event::MOD_ANY); }$this->_picsGenerated[$picType] =array("GENERATED_" .mb_strtoupper($picType) .I4931 => $genData[0], "GENERATED_" .mb_strtoupper($picType) ."_W" => $imgData[0], "GENERATED_" .mb_strtoupper($picType) ."_H" => $imgData[1]); }}}if (isset($IILIILl[I4932]) and $IILIILl[I4932] == "edit" and isset($this->_picsGenerated)) {foreach ($this->_picsGenerated as $IL1LIlL) $this->mod->cms->Gui->addGlobalVars($IL1LIlL); }parent::TTIl1I1($cId, $vItemData, $vData, $IILIILl); }function TTIllII($cId, &$vItemData, &$vData, &$IILIILl) {foreach ($this->mod->options[I4912] as $picture) {if (isset($this->mod->cms->VarsPost[$picture])) {$vItemData['ext_' .$picture] =$this->mod->cms->VarsPost[$picture]; if (isset($vItemData[$picture])) unset($vItemData[$picture]); }}parent::TTIllII($cId, $vItemData, $vData, $IILIILl); }function TTIl1T1($cId, &$vItemData, &$vData, &$IILIILl) {$aImages =isset($this->mod->options[I4912]) ?(is_array($this->mod->options[I4912]) ?$this->mod->options[I4912] :array($this->mod->options[I4912])) :array(); if (in_array("popup_picture", $aImages) and !empty($vItemData["ext_popup_picture"])) {$IL1LIl1 =Array(); $IL1LIl1[I4933] =$GLOBALS["ROOT_PATH_WWW"] .$vItemData["ext_popup_picture"]; $IL1LIl1["title"] =$vItemData[$this->mod->options["name_field_name"]]; $vData[I4934] =$this->mod->cms->Gui->get($this->mod->moduleName ."_list:" .$IILIILl["simple_prefix"] .I4934, $IL1LIl1); }elseif (in_array(I4933, $aImages) and !empty($vItemData[I4927])) {$IL1LIl1 =Array(); $IL1LIl1[I4933] =$GLOBALS["ROOT_PATH_WWW"] .$vItemData[I4927]; $IL1LIl1["title"] =$vItemData[$this->mod->options[I4935]]; $vData[I4934] =$this->mod->cms->Gui->get($this->mod->moduleName ."_list:" .$IILIILl["simple_prefix"] .I4934, $IL1LIl1); }parent::TTIl1T1($cId, $vItemData, $vData, $IILIILl); }function TTIl1TT($cId, &$vItemData, &$vData, &$IILIILl) {$IIL1lIl =$this->mod->options[I4912]; if (in_array($IILIILl["page_item_type"], array('body_cats', I4936))) {if (isset($IILIILl[I4937]) && $this->mod->cms->Core->IssetModOption($IILIILl[I4937], I4912)) {$this->mod->options[I4912] =$this->mod->cms->Core->TTlI1TI($IILIILl[I4937], I4912); }else {$this->mod->options[I4912] =Array(); }$IL1LILI =$this->mod->options["cat_default_prefix"]; }else {$IL1LILI =$this->mod->options[I4926]; }$IL1LILl =$this->_AddPicturesSqlFieldsAndCB($IL1LILI); $this->mod->options[I4912] =$IIL1lIl; if (is_array($IL1LILl) and is_array($IILIILl["fields"])) $IILIILl["fields"] =$IL1LILl +$IILIILl["fields"]; parent::TTIl1TT($cId, $vItemData, $vData, $IILIILl); }function TTIll1I($cId, &$vItemData, &$vData, &$IILIILl) {$IIL1lIl =$this->mod->options[I4912]; if (in_array($IILIILl[I4938], array('body_cats', I4936))) {if (isset($IILIILl[I4937]) && $this->mod->cms->Core->IssetModOption($IILIILl[I4937], I4912)) {$this->mod->options[I4912] =$this->mod->cms->Core->TTlI1TI($IILIILl[I4937], I4912); }else {$this->mod->options[I4912] =Array(); }$IL1LILI =$this->mod->options["cat_default_prefix"]; }else {$IL1LILI =$this->mod->options[I4926]; }$IL1LILl =$this->_AddPicturesSqlFieldsAndCB($IL1LILI); $this->mod->options[I4912] =$IIL1lIl; if (is_array($IL1LILl) and is_array($IILIILl["fields"])) $IILIILl["fields"] =$IL1LILl +$IILIILl[I4939]; parent::TTIll1I($cId, $vItemData, $vData, $IILIILl); }function TTIl1Tl($cId, $vItemData, $vData, $IILIILl) {if ($vData and is_array($vData)) {if (array_key_exists(I4923, $vData)) {$vData['picture'] =$vData[I4923]; unset($vData[I4923]); }if (array_key_exists('ext_popup_picture', $vData)) {$vData['popup_picture'] =$vData['ext_popup_picture']; unset($vData[I4923]); }if (array_key_exists(I4924, $vData)) {$vData[I4940] =$vData[I4924]; }}parent::TTIl1Tl($cId, $vItemData, $vData, $IILIILl); }function _colPictureCB(&$vItem, &$vData) {if ($this->mod->module->IssetOption("generate_pictures") && in_array($this->mod->options[I4922], $this->mod->module->GetOption("generate_pictures"))) {$vRes =array(); $level =3; $origFileLevel =0; foreach (array("popup_", I4913, "small_") as $picpref) {if (!empty($vItem[I4941 .$picpref .I4933])) {$origFilePath =$vItem[I4941 .$picpref .I4933]; $origFileLevel =$level; break; }$level --; }$preffx =$this->mod->options[I4922]; if (($pos =mb_strpos($preffx, "_")) !== false) $preffx =mb_substr($preffx, 0, $pos +1); else $preffx =I4913; if ($this->_genLinkToPic(!empty($vData["modName"]) ?$vData["modName"] :$this->mod->IIllII1, $preffx, $origFilePath, $origFileLevel, $vItem[$preffx .I4933], $vItem["id"], $vRes, empty($vData[I4942]) ?false :$vData[I4942])) {$imgData =array("img_url" => $vRes["src"]); $vItem["_picture_col"] =$this->mod->cms->Gui->get($this->mod->moduleName ."_list:_picture_col", $imgData); }else $vItem[I4943] =$this->mod->cms->Gui->getAbs($this->mod->moduleName ."_list:_picture_no_col"); }else if (!empty($vItem[$this->mod->options[I4922]])) {$imgData =array("img_url" => $GLOBALS["ROOT_PATH_WWW"] .$vItem[$this->mod->options[I4922]]); $vItem[I4943] =$this->mod->cms->Gui->get($this->mod->moduleName ."_list:_picture_col", $imgData); }else $vItem[I4943] =$this->mod->cms->Gui->getAbs($this->mod->moduleName ."_list:_picture_no_col"); }function _OverrideGenPicModName($modName) {$this->IL1LII1 =$modName; }function _GetPicturesCB(&$vItem, &$vData) {$vRes =array(); $vResP =array(); $picData =array(); $level =3; if (!empty($vItem["id"])) {$IL1LILL =$vItem["id"]; }elseif (!empty($vItem["cat_id"])) {$IL1LILL =$vItem["cat_id"]; }$curModule =$this->IL1LII1 ?$this->IL1LII1 :(!empty($vData[I4944]) ?$vData[I4944] :$this->mod->IIllII1); $origFilePath =null; $origFileLevel =null; foreach (array("popup_", I4913, "small_") as $picpref) {if (!empty($vItem['ext_' .$picpref .'picture'])) {$vItem[$picpref .I4945] =$vItem['ext_' .$picpref .I4945]; }}foreach (array("popup_", I4913, "small_") as $picpref) {if (!empty($vItem[$picpref .I4933])) {$origFilePath =$vItem[$picpref .I4933]; $origFileLevel =$level; break; }$level --; }foreach (array('', I4946) as $preffx) {if ($this->_genLinkToPic($curModule, $preffx, $origFilePath, $origFileLevel, isset($vItem[$preffx .I4933]) ?$vItem[$preffx .I4933] :null, $IL1LILL, $vRes, empty($vData[I4942]) ?false :$vData[I4942])) {$vItem[$preffx ."picture_src"] =$picData[I4933] =$picData["src"] =$vRes["src"]; $vItem[$preffx ."picture_title"] =$picData[I4947] =$picData["alt"] =$vItem[$this->mod->options[I4935]]; $picData["alt_js"] =jparse(str_replace('&#039;', "'", $picData[I4948])); $vItem[$preffx .'picture_title'] =$picData['title'] =$picData['alt'] =str_replace('"', I4949, $picData['alt']); $vItem[$preffx ."picture_width"] =$picData[$preffx ."picture_width"] =$picData["width"] =$vRes[I4950]; $vItem[$preffx ."picture_height"] =$picData[$preffx ."picture_height"] =$picData["height"] =$vRes["height"]; if (!empty($vRes[I4951])) {$vItem[$preffx .I4951] =$vRes[I4951]; }if ($preffx == "small_") {$vItem["small_popup_picture"] =$vItem["small_picture"] =$this->mod->cms->Gui->get((!empty($vData["guiModName"]) ?$vData[I4952] :$this->mod->moduleName ."_list") .":" .$vData["simple_prefix"] ."small_picture", $picData); }if ($this->_genLinkToPic($curModule, I4953, $origFilePath, $origFileLevel, isset($vItem["popup_picture"]) ?$vItem["popup_picture"] :null, isset($vItem["id"]) ?$vItem["id"] :null, $vResP, empty($vData[I4942]) ?false :$vData[I4942])) {if ($preffx == I4913 || empty($vItem[I4933])) {$vItem[I4954] =$picData["src"] =$vResP["param"]; $vItem["popup_picture_width"] =$picData[I4950] =$vResP[I4950]; $vItem["popup_picture_height"] =$picData[I4955] =$vResP[I4955]; if (!empty($vResP[I4951])) {$vItem['popup_picture_path_www'] =$vResP[I4951]; }if ($preffx == I4913) $vItem[I4933] =$this->mod->cms->Gui->get((!empty($vData[I4952]) ?$vData[I4952] :$this->mod->moduleName ."_list") .":" .$vData["simple_prefix"] .I4956, $picData); }if ($preffx == "small_") $vItem["small_popup_picture"] =$this->mod->cms->Gui->get((!empty($vData[I4952]) ?$vData[I4952] :$this->mod->moduleName ."_list") .":" .$vData[I4957] ."small_popup_picture", $picData); }else if ($preffx == I4913) {$setName =(isset($vData['simple_prefix']) ?$vData['simple_prefix'] :'') .I4945; $vItem[I4945] =$this->mod->cms->Gui->get((empty($vData[I4958]) ?$this->mod->moduleName .'_list' :$vData[I4958]) .':' .$setName, $picData); }}else {$vItem[$preffx .I4933] =''; }}return $picData; }function _genLinkToPic($curModule, $cPicType, $cOrigPicPath, $origFileLevel, $cPicPath, $cRecID, &$vRes, $lnkAddon =false) {$vRes =array(I4950 => 0, I4955 => 0, "src" => I4913, I4959 => I4913, "_return" => false); if (!empty($cPicPath) and $cOrigPicPath != $cPicPath) {$cOrigPicPath =$cPicPath; }$picSubPath =$curModule; if (($pos =mb_strpos($picSubPath, "_")) !== false) $picSubPath =mb_substr($picSubPath, 0, $pos); $genPics =array(); if ($this->mod->options["generate_pictures"]) $genPics =$this->mod->options["generate_pictures"]; $origFileName =I4913; $origFileExt =I4913; $origFileX =0; $origFileY =0; if (!empty($cOrigPicPath) && sizeof($genPics) >0 && is_file($GLOBALS[I4960] .$cOrigPicPath)) {$IL1LIL1 =imageGetSize($GLOBALS[I4960] .$cOrigPicPath); $origFileX =$IL1LIL1[0]; $origFileY =$IL1LIL1[1]; if (($pos =mb_strrpos($cOrigPicPath, ".")) !== false) {$origFileExt =mb_substr($cOrigPicPath, $pos +1); $origFileName =mb_substr($cOrigPicPath, 0, $pos); }}$possiblyWillBeGenerated =false; if (!empty($origFileName) && in_array($cPicType .I4933, $genPics) && (empty($cPicPath) || $cPicPath == $cOrigPicPath)) $possiblyWillBeGenerated =true; if (empty($cPicPath) && !($possiblyWillBeGenerated && $origFileX >0 && $origFileY >0 && $this->mod->options[$cPicType ."picture_maxwidth"] >0 && $this->mod->options[$cPicType .I4914] >0)) return false; if (!empty($cPicPath) && ($size =imageGetSize($GLOBALS[I4960] .$cPicPath))) {$vRes[I4950] =$size[0]; $vRes[I4955] =$size[1]; $vRes[I4959] =$GLOBALS["ROOT_PATH_WWW"] .$cPicPath; $vRes["src"] =$GLOBALS[I4961] .$cPicPath; if (!($possiblyWillBeGenerated && $origFileX >0 && $origFileY >0 && $this->mod->options[$cPicType ."picture_maxwidth"] >0 && $this->mod->options[$cPicType .I4914] >0)) {$vRes["_return"] =true; return true; }}$currLevel =0; switch ($cPicType) {case I4953: $currLevel =3; break; case I4913: $currLevel =2; break; case "small_": $currLevel =1; break; }if ($origFileLevel <$currLevel) {$vRes["_return"] =!empty($vRes[I4962]); return !empty($vRes[I4962]); }if ($origFileX === 0 or $origFileY === 0) {return false; }if (!empty($cOrigPicPath) && sizeof($genPics) >0 && is_file($GLOBALS[I4960] .$cOrigPicPath)) {$_newFileX =$origFileX; $_newFileY =$origFileY; $newFileMaxX =$this->mod->options[$cPicType ."picture_maxwidth"]; $newFileMaxY =$this->mod->options[$cPicType .I4914]; if ($_newFileX >$newFileMaxX || $_newFileY >$newFileMaxY || ($_newFileX <$newFileMaxX && $_newFileY <$newFileMaxY && $this->mod->options["generate_bigger_image"] && $cPicType != I4953)) {if ($_newFileX /$newFileMaxX >= $_newFileY /$newFileMaxY) {$_newFileY =ceil($_newFileY *$newFileMaxX /$_newFileX); $_newFileX =$newFileMaxX; }else {$_newFileX =ceil($_newFileX *$newFileMaxY /$_newFileY); $_newFileY =$newFileMaxY; }}if ($_newFileX == $origFileX and $_newFileY == $origFileY) {$vRes[I4950] =$origFileX; $vRes[I4955] =$origFileY; $vRes[I4959] =$GLOBALS[I4961] .$cOrigPicPath; $vRes[I4962] =$GLOBALS[I4961] .$cOrigPicPath; $vRes["_return"] =true; return true; }}if ($possiblyWillBeGenerated) {$newFileMaxX =$this->mod->options[$cPicType ."picture_maxwidth"]; $newFileMaxY =$this->mod->options[$cPicType .I4914]; $newFileX =$origFileX ?$origFileX :$newFileMaxX; $newFileY =$origFileY ?$origFileY :$newFileMaxY; if ($newFileX >$newFileMaxX || $newFileY >$newFileMaxY || ($newFileX <$newFileMaxX && $newFileY <$newFileMaxY && $this->mod->options["generate_bigger_image"] && $cPicType != I4953)) {if ($newFileX /$newFileMaxX >= $newFileY /$newFileMaxY) {$newFileY =ceil($newFileY *$newFileMaxX /$newFileX); $newFileX =$newFileMaxX; }else {$newFileX =ceil($newFileX *$newFileMaxY /$newFileY); $newFileY =$newFileMaxY; }}if (!is_dir($GLOBALS[I4960] .$GLOBALS["CUSTOM_PICTURES_HTTP_PATH"] .$picSubPath ."/generated/")) {if (!mkdir($GLOBALS[I4960] .$GLOBALS["CUSTOM_PICTURES_HTTP_PATH"] .$picSubPath ."/generated/", 0777, true)) {trigger_error("CMS_ExtImages::_genLinkToPic: unable to create path " .$GLOBALS[I4960] .$GLOBALS["CUSTOM_PICTURES_HTTP_PATH"] .$picSubPath ."/generated/", E_USER_WARNING); return false; }else {chmod($GLOBALS[I4960] .$GLOBALS["CUSTOM_PICTURES_HTTP_PATH"] .$picSubPath ."/generated/", 0777); }}$genFileName =$GLOBALS["CUSTOM_PICTURES_HTTP_PATH"] .$picSubPath ."/generated/" .basename($origFileName) ."_" .$newFileX ."x" .$newFileY .(isset($this->mod->options["generate_" .$cPicType .I4963]) ?$this->mod->options["generate_" .$cPicType .I4963] :'') .(!empty($this->mod->options["watermark_postf"]) ?$this->mod->options["watermark_postf"] :I4913) .(!empty($this->mod->options[I4917]) && $cPicType != I4964 ?"_swt" :I4913) ."." .$origFileExt; $vRes[I4950] =$newFileX; $vRes[I4955] =$newFileY; $vRes["picture_path_www"] =$GLOBALS[I4961] .$genFileName; if (is_file($GLOBALS[I4960] .$genFileName)) {$vRes[I4959] =$GLOBALS[I4961] .$genFileName; $vRes[I4962] =$GLOBALS[I4961] .$genFileName; }else {$vRes[I4959] ="sname=" .rawurlencode($genFileName) .I4965 .$curModule ."|id=" .$cRecID ."|type=" .$cPicType ."picture|lang=" .$this->mod->langData; if ($lnkAddon !== false) {$vRes[I4959] .= $lnkAddon; }else {$this->TITIIT1($vRes[I4959]); }$vRes[I4962] =$GLOBALS[I4961] ."show_pic.php?" .$vRes[I4959]; }}if (!empty($vRes[I4962]) && !empty($vRes[I4959]) && $vRes[I4950] >0 && $vRes[I4955] >0) {$vRes[I4966] =true; return true; }else {return false; }}function TITIIT1(&$IL1LI1I) {}function _preparePicsData(&$vData, $name) {if (!isset($vData["pictures_js_vars"])) {$vData["pictures_js_vars"] =I4913; $vData["pictures_js_script"] =I4913; }$aPicData =Array('url' => 'ce_img_proc.php?cat=' .$this->mod->options["picture_cat"] .'&fld=' .$name .'&lang=' .$this->mod->cms->lang .I4967 .$this->mod->moduleName, 'id' => I4968 .$name); $addPic =$this->mod->cms->Gui->get($this->mod->moduleName ."_list:images_add", $aPicData); $editPic =$this->mod->cms->Gui->get($this->mod->moduleName ."_list:images_edit", $aPicData); $IL1LI1l =preg_replace("/(\_)?\d+$/", '', $name); $vData[I4969 .$IL1LI1l] =(in_array($IL1LI1l, $this->mod->options["generate_pictures"])) ?"1" :"0"; $vData['prior_source_picture'] =$this->mod->options["prior_source_picture"]; $vData['url_' .$IL1LI1l] =$aPicData['url']; $vData['edit_' .$IL1LI1l] =empty($vData[$name]) ?$addPic :$editPic; $vData["pictures_js_vars"] .= $this->mod->cms->Gui->getAbs($this->mod->moduleName ."_subform:pictures_js_vars", Array("name" => $name, "add_value" => jparse($addPic), "edit_value" => jparse($editPic))); $vData["pictures_js_script"] .= $this->mod->cms->Gui->getAbs($this->mod->moduleName ."_subform:pictures_js_script", Array("name" => $name)); $vData[$IL1LI1l] =isset($vData[$name]) ?$vData[$name] :''; $vData['item_' .$IL1LI1l] =$this->mod->cms->Gui->getAbs($this->mod->moduleName ."_subform:" .$IL1LI1l, $vData); }function _AddPicturesSqlFieldsAndCB($IL1LI1L) {$aField =Array(); if (sizeof($this->mod->options[I4912]) >0) {$aField[I4912] =Array(I4970 => I4925, "object" => &$this, "method" => "_GetPicturesCB"); foreach ($this->mod->options[I4912] as $fieldName) {if (!empty($fieldName) && $fieldName != 'null' && $fieldName != -222222) {$this->mod->browser->TI1TITl($IL1LI1L .I4971 .$fieldName); }}}return $aField; }function TITTl1l(&$modEngine) {if (is_object($modEngine)) $modEngine->realSide =$this->realSide; $this->TITTl11(); }}