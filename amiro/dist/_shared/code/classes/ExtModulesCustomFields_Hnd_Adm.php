<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    modules 
 * @subpackage extensions 
 * @version    $Id$ 
 * @size       15541 xkqwtnpqytmgtlurnutznnrurruiuynglktqmytpkniswtlgzqttiniyygulsrzpsuigpnir
 */ ?><?php foreach(array(5023=>'?IHSuJQ?OZD?nH?fMJtQr',5024=>'IHSuJQ|MS|SZtZDQt',5025=>"dqjqwT?.MS.!?.nZIQ.!?.IHSuJQ|nZIQ.?",5026=>"FRhi?.WID|IHSuJQD|SZtZDQtD.?",5027=>"coqRq?.IHSuJQ|nZIQ.?",5028=>"?=?'",5029=>"zNs?.JZnP.?=?'",5030=>'IHSuJQ|nZIQ',5031=>'fJt|',5032=>'IS`MS',5033=>"FRhi?.WID|IHSuJQD|WuDtHI|fMQJSD.?",5034=>"coqRq?.IHSuJQ|nZIQ.?=?'",5035=>'ftBGQ',5036=>'Mnt',5037=>"?jqFT?lhmN?.WID|IHSuJQD|SZtZDQtD.?IS?",5038=>'qXT|ihsUjqd|wUdThi|Fmqjsd|zsshN',5039=>'qXT|ihsUjqd|wUdThi|Fmqjsd|szTzdqT|Nziq',5040=>'YHttHI',5041=>'Qxt|IHSuJQD|WuDtHI|fMQJSD|',5042=>'DBDtQI|nZIQ',5043=>'WZGtMHn',5044=>'DMIGJQ',5045=>'SZtZDQt|MS',5046=>'|DuYfHrI%Qxt|IHSuJQD|WuDtHI|fMQJSD|ZSSHn',5047=>'',5048=>"dqjqwT?.MS.!?.nZIQ.?FRhi?.WID|IHSuJQD|SZtZDQtD.?coqRq?.IHSuJQ|nZIQ.?=?'",5049=>"'?zNs?.JZnP.?=?'",5050=>'|DuYfHrI%Qxt|IHSuJQD|WuDtHI|fMQJSD|HGtMHn|rHC',5051=>'MS',5052=>'qXT|ihsUjqd|wUdThi|Fmqjsd|szTzdqT|zsshN',5053=>'|DuYfHrI%Qxt|IHSuJQD|WuDtHI|fMQJSD|SZtZDQt|ZSSHn',5054=>'MD|WZt|IHSuJQ',5055=>'MS|SZtZDQt') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ExtModulesCustomFields_Hnd_Adm_InitFilter implements CMS_Ext_ActionHandler_Interface{ public function processAction($IlIlI11, $cId, &$vItemData, &$vData, &$IILIILl){ if(empty($IlIlI11->mod->filter)){ trigger_error($IlIlI11->activeModule->Name .I5023, E_USER_WARNING); return; }$IIlI111 =$IlIlI11->IL1Llll->getModuleUsageMode($IlIlI11->moduleName); if($IIlI111 != 'simple'){ $IIlI11L =$IlIlI11->IL1Llll->getParentForCatModule($IlIlI11->moduleName); $IL1Ll1l =array('id_dataset' => $IIlI11L); if($IIlI11L != $IlIlI11->moduleName){ $IL1Ll1l[I5024] =$IlIlI11->moduleName; }$aElementDatasets =array(); foreach($IL1Ll1l as $moduleName){ $aElementDatasets[$moduleName] =array(); }$sql =I5025 .I5026 .I5027 .(sizeof($IL1Ll1l) == 1 ?I5028 .$IIlI11L ."' " :"IN ('" .implode("', '", $IL1Ll1l) ."') ") .I5029 .$IlIlI11->mod->langData ."' " ."ORDER BY `name` ASC"; $rs =$IlIlI11->db->select($sql); while($record =$rs->nextRecord()){ $aElementDatasets[$record[I5030]][$record['id']] =$record['name']; }foreach(array_keys($IL1Ll1l) as $index => $field){ $IIlI111 =$IlIlI11->IL1Llll->getModuleUsageMode($IL1Ll1l[$field]); $filterField =I5031 .$field; $fieldValue =isset($IlIlI11->cms->Vars[$filterField]) ?stripslashes(unhtmlentities($IlIlI11->cms->Vars[$filterField])) :null; $aSelect =array(); $aSelect =$IlIlI11->mod->filter->TITI1TT($aSelect, array($IlIlI11->cms->Words['all'] => 0)); foreach($aElementDatasets[$IL1Ll1l[$field]] as $id => $caption){ $aSelect =$IlIlI11->mod->filter->TITI1TT($aSelect, array($caption => $id)); }if(sizeof($aSelect['data']) <3){ continue; }switch($IIlI111){ case 'pages': if($fieldValue){ $IlIlI11->aCrossHandlerData['extend_sql_by_dataset'] =true; $field =I5032; }break; default: if($index){ break 2; }}$IlIlI11->mod->filter->AddField( $filterField, 'select', $fieldValue, '', '=', $field, $aSelect );if(!$fieldValue){ $IlIlI11->mod->filter->DisableFieldSQL($filterField); }}}$aIds =array(); $sql ="SELECT `id` " .I5033 .I5034 .$IlIlI11->moduleName ."' AND `admin_filter` = 1"; $rs =$IlIlI11->db->select($sql); while($record =$rs->nextRecord()){ $aIds[] =$record['id']; }if(sizeof($aIds)){ $IlIlI11->IL1Llll->loadFieldsByIds($aIds); foreach($aIds as $id){ $aField =$IlIlI11->IL1Llll->aCustomFields[$id]; $field =CMS_API_ModulesCustomFields::PREFIX .$aField['system_name']; $filterField =I5031 .$field; $IlIlI11->mod->filter->AddCaptions(array($filterField => $aField['caption'])); $fieldValue =isset($IlIlI11->cms->Vars[$filterField]) ?stripslashes(unhtmlentities($IlIlI11->cms->Vars[$filterField])) :null; $prefix =$IlIlI11->mod->options['default_prefix']; switch($aField[I5035]){ case 'char': $IlIlI11->mod->filter->AddField($filterField, 'text', $fieldValue, '', ' LIKE ', $prefix .$field); break; case I5036: case 'float': $IlIlI11->mod->filter->AddField($filterField, 'text', $fieldValue, '', ' = ', $prefix .$field); break; }if(!mb_strlen($fieldValue)){ $IlIlI11->mod->filter->DisableFieldSql($filterField); }}}}}class ExtModulesCustomFields_Hnd_Adm_ModifySQL implements CMS_Ext_ActionHandler_Interface{ public function processAction($IlIlI11, $cId, &$vItemData, &$vData, &$IILIILl){ if(empty($IlIlI11->aCrossHandlerData['extend_sql_by_dataset'])){ return; }$prefix =$IlIlI11->mod->browser->SQLData['default_prefix']; $IlIlI11->mod->browser->SQLData['sql_from'] .= I5037 ."ON IF(" .$prefix ."id_page, POSITION(CONCAT(';', " .$prefix ."id_page , ';') IN md.`used_pages`), md.id = " .$IlIlI11->IL1Llll->getSysDatasetId($IlIlI11->moduleName) .")"; }}class ExtModulesCustomFields_Hnd_Adm_FillData implements CMS_Ext_ActionHandler_Interface{ public function processAction($IlIlI11, $cId, &$vItemData, &$vData, &$IILIILl){ if(isset($IlIlI11->cms->Gui->globalVars[I5038])){ return; }$datasetId =$IlIlI11->detectDatasetId(); if($IlIlI11->setDataset($datasetId)){ $IlIlI11->cms->Gui->addGlobalVars(array(I5039 => $IlIlI11->aDataset['name'])); $IL1Ll1L =array( 'top' => array(), 'tab' => array(), I5040 => array() );foreach($IlIlI11->aDataset['fields_map'] as $fieldId){ if(isset($IlIlI11->IL1Llll->aCustomFields[$fieldId]) && ($place =$IlIlI11->IL1Llll->aCustomFields[$fieldId]['admin_form']) != 'none'){ $IL1Ll1L[$place][] =$IlIlI11->IL1Llll->aCustomFields[$fieldId]; }}foreach($IL1Ll1L as $place => $aFields){ if(sizeof($aFields)){ $IL1Ll11 =I5041 .$place; $vData[$IL1Ll11] =''; foreach($aFields as $aField){ $field =CMS_API_ModulesCustomFields::PREFIX .$aField[I5042]; if($IlIlI11->mod->itemData){ $value =$IlIlI11->mod->itemData[$field]; }elseif(isset($IlIlI11->mod->aPostData) && $IlIlI11->mod->aPostData){ $value =$IlIlI11->mod->aPostData[$field]; }else{ $value =''; }$aSetData =array('name' => $field, 'value' => $value) +$aField; $IL1LLII =$IlIlI11->cms->Gui->getAbs($IlIlI11->moduleName .'_subform:cf_value', $aSetData); $aSetData =array( I5043 => $IlIlI11->aDataset['fields_captions'][$aField['id']], 'value' => $IL1LLII )+$aField; $vData[$IL1Ll11] .= $IlIlI11->cms->Gui->getAbs($IlIlI11->moduleName .'_subform:cf_row', $aSetData); }}}$IIlI111 =$IlIlI11->IL1Llll->getModuleUsageMode($IlIlI11->moduleName); $IIlI11L =$IlIlI11->IL1Llll->getParentForCatModule($IlIlI11->moduleName); if($IIlI111 != I5044){ $IL1LLIl =$IlIlI11->IL1Llll->getSysDatasetId($IlIlI11->moduleName); $aSetData =array( I5030 => $IlIlI11->moduleName, 'table' => $IIlI111 == 'pages' ?'cms_pages' :$IlIlI11->activeModule->GetTableName() .'_cat', I5045 => $datasetId ?$datasetId :$IL1LLIl, 'sys_dataset_id' => $IL1LLIl, 'display_tooltip' => $IlIlI11->IL1LllL <1 && $IIlI111 == 'pages', 'object_id' => (int)$cId );$addon =$IlIlI11->cms->Gui->get($IlIlI11->moduleName .I5046, $aSetData); }else{ $addon =I5047; }$IlIlI11->cms->Gui->addGlobalVars(array(I5038 => $addon)); if($IIlI11L != $IlIlI11->moduleName){ $IL1LLIL =-1; $cId =(int)$cId; if($cId){ $sql ="SELECT `id_dataset` " ."FROM " .$IlIlI11->activeModule->GetTableName() ." " ."WHERE `id` = " .$cId; $IL1LLIL =(int)$IlIlI11->db->getValue($sql); }$sql =I5048 .$IIlI11L .I5049 .$IlIlI11->mod->langData ."'"; $rs =$IlIlI11->db->select($sql); $options =I5047; while($record =$rs->nextRecord()){ $options .= $IlIlI11->cms->Gui->getAbs($IlIlI11->moduleName .I5050, array( 'value' => $record['id'], 'selected' => $record[I5051] != $IL1LLIL ?I5047 :' selected', I5043 => $record['name'] ));}$IlIlI11->cms->Gui->addGlobalVars(array(I5052 => $IlIlI11->cms->Gui->getAbs($IlIlI11->moduleName .I5053, array('id_dataset' => $options)))); }}}}class ExtModulesCustomFields_Hnd_Adm_PrepareItemData implements CMS_Ext_ActionHandler_Interface{ public function processAction($IlIlI11, $cId, &$aSQL, &$vData, &$IILIILl){ if($IlIlI11->setDataset()){ if($IlIlI11->aCrossHandlerData[I5054] && isset($IlIlI11->cms->VarsPost['id_dataset'])){ $aSQL[I5055] =(int)$IlIlI11->cms->VarsPost[I5055]; }foreach($IlIlI11->aDataset['fields_map'] as $fieldId){ $aField =$IlIlI11->IL1Llll->aCustomFields[$fieldId]; $IL1lIL1 =CMS_API_ModulesCustomFields::PREFIX .$aField[I5042]; if($aField['admin_form'] != 'none' && isset($IlIlI11->cms->VarsPost[$IL1lIL1])){ if(mb_strlen($IlIlI11->cms->VarsPost[$IL1lIL1])){ $value =$IlIlI11->cms->VarsPost[$IL1lIL1]; }else{ $value ='=|NULL'; }$aSQL[$IL1lIL1] =$value; }}}}}