<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       24536 xkqwqwgmzyyyqmtxskpxxlywwkszrmmqszzurwggxyngkkituprggtylsngtlzplkknupnir
 */ ?><?php foreach(array(4972=>"Qxt|rDD",4973=>'SMDZYJQ|WZWOQ|CZrn',4974=>"rDD|WOZnnQJ|tMtJQ",4975=>"rDD|WOZnnQJ|MIZPQ",4976=>"rDD|WOZnnQJ|SMr",4977=>"nHnQ",4978=>"WZJJYZWK",4979=>'DEJ|fMJtQr',4980=>"rDD|MtQI|GuYSZtQ",4981=>"",4982=>"rDD|SMDGJZB|MIZPQ",4983=>'HffDQt|JMnK',4984=>"rDD|PQnQrZtQ",4985=>'nHMnSQx',4986=>"rDD|ZutHJMnK",4987=>"rDD|SMDGJZB|GZPQ",4988=>"rDD|YJHWK%",4989=>"rDD|MtQI|tMtJQ",4990=>"rDD|MtQI|fuJJtQxt",4991=>"r",4992=>" MS=",4993=>'rDD|MIZPQ',4994=>'',4995=>"OHDt",4996=>']',4997=>']Pt^',4998=>"]nYDG^",4999=>"?",5000=>"<",5001=>" ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ExtRSS extends CMS_ExtModule {public $IL1LI11; public $linkRSS; public $root_path_www; public $_itemLink; function ExtRSS() {parent::CMS_ExtModule(); }function Init(&$cms, &$IlIlIl1, &$IlIlILI) {$this->IL1LI11 =false; $this->root_path_www =$GLOBALS["ROOT_PATH_WWW"]; $this->_itemLink =""; parent::Init($cms, $IlIlIl1, $IlIlILI); }function GetModuleName() {return I4972; }function ProcessAction(&$IIIL11l, $cId, &$aItemData, &$vData, &$IILIILl){ if (isset($IILIILl['ext_action']) && $IILIILl['ext_action'] == 'export_rss'){ $this->IL1LI11 =true; }parent::ProcessAction($IIIL11l, $cId, $aItemData, $vData, $IILIILl); }function TTIlI11($cId, &$vItemData, &$vData, &$IILIILl) {parent::TTIlI11($cId, $vItemData, $vData, $IILIILl); }function TTIllTl($cId, &$vItemData, &$vData, &$IILIILl) {parent::TTIllTl($cId, $vItemData, $vData, $IILIILl); }function TTIl1IT($cId, &$vItemData, &$vData, &$IILIILl){ if ($this->IL1LI11) {$GLOBALS['CONNECT_OPTIONS'][I4973] =TRUE; $this->cms->Gui->addBlock($this->activeModule->GetName()."_list", "templates/ext_rss.tpl"); $aChannel =Array(); if ($this->activeModule->issetOption("rss_channel_title")) $aChannel["rss_tpl_channel_title"] =$this->GetOption(I4974); if ($aChannel["rss_tpl_channel_title"] == "") $aChannel["rss_tpl_channel_title"] =$this->cms->Core->GetOption("company_name"); if ($this->activeModule->issetOption("rss_channel_description")) $aChannel["rss_tpl_channel_description"] =$this->GetOption("rss_channel_description"); if ($aChannel["rss_tpl_channel_description"] == "") $aChannel["rss_tpl_channel_description"] =$aChannel["rss_tpl_channel_title"]; $this->linkRSS =$this->root_path_www.$this->_HrefLink($this->cms->ActiveScriptNavLink); $aChannel["rss_tpl_channel_link"] =$this->linkRSS; $aChannel["rss_tpl_channel_copyright"] =$this->activeModule->issetOption("rss_channel_copyright") ?$this->GetOption("rss_channel_copyright") :''; if ($this->activeModule->issetOption("rss_channel_webmaster") && isEmail($this->GetOption("rss_channel_webmaster")) )$aChannel["rss_tpl_channel_webmaster"] =$this->GetOption("rss_channel_webmaster"); else $aChannel["rss_tpl_channel_webmaster"] =$this->cms->Core->GetOption("company_email"); $aChannel["rss_tpl_channel_pubdate"] =date("r"); $aChannel["rss_tpl_channel_lastbuilddate"] =$aChannel["rss_tpl_channel_pubdate"]; $aChannel["rss_tpl_channel_lang"] =$this->mod->langData; $aChannel['rss_tpl_channel_encoding'] ='UTF-8'; if ($this->activeModule->issetOption(I4975) && $this->GetOption(I4975) != -1 ){$aChannel["rss_tpl_channel_img_url"] =$this->root_path_www. $this->cms->Core->GetModProperty(I4972,"rss_channel_dir"). $this->GetOption(I4975); $aChannel["rss_tpl_channel_img_title"] =$aChannel["rss_tpl_channel_title"]; $aChannel["rss_tpl_channel_img_link"] =$aChannel["rss_tpl_channel_link"]; }if ($this->activeModule->issetOption("rss_channel_style") && $this->GetOption("rss_channel_style") != -1 ){$aChannel["rss_tpl_channel_style"] =$this->root_path_www. $this->cms->Core->GetModProperty(I4972,I4976). $this->GetOption("rss_channel_style"); }$aChannel["rss_tpl_channel_title"] =$this->removeTagsSpecialChars($aChannel["rss_tpl_channel_title"]); $aChannel["rss_tpl_channel_description"] =$this->removeTagsSpecialChars($aChannel["rss_tpl_channel_description"]); $aChannel["rss_tpl_channel_copyright"] =$this->removeTagsSpecialChars($aChannel["rss_tpl_channel_copyright"]); $aChannel["rss_tpl_channel_img_title"] =$aChannel["rss_tpl_channel_title"]; foreach ($aChannel as $key => $val) $aChannel[$key] =trim($val); $this->cms->Gui->addGlobalVars($aChannel); $this->mod->action =I4977; }}function TTIllIT($cId, &$vItemData, &$vData, &$IILIILl) {parent::TTIllIT($cId, $vItemData, $vData, $IILIILl); }function TTIll1I($cId, &$vItemData, &$vData, &$IILIILl) {$this->cms->Gui->addBlock('rss_block', 'templates/ext_rss.tpl'); if ($this->IL1LI11) {$this->mod->IIllILl =Array(); $IILIILl["fields"][I4972] =Array("action"=>I4978, "object"=>&$this, "method"=>"_FillFrontDataMapping"); if($this->cms->ActiveScript != "") {$this->_itemLink =$this->root_path_www.$this->cms->ActiveScript; }else {$this->_itemLink =mb_substr($this->root_path_www, 0, -1); }if (is_object($this->mod->browser)) {if ($this->activeModule->issetOption('rss_elements_period')) {$this->mod->browser->PageSize =2147483647; $period =$this->GetOption('rss_elements_period'); if(stripos($period, 'week') !== false){ $numDays =0; preg_match('/^(\d*)\s*.*$/i', $period, $matches); $numDays =7 *(int)$matches[1]; if($numDays <= 6){ $numDays =7; }$period =$numDays .' DAY'; }$filter =trim($this->mod->browser->SQLData[I4979]); $this->mod->browser->SQLData[I4979] =(empty($filter) ?'WHERE' :$filter .' AND') ." " .$this->mod->options['default_prefix'] .$this->GetOption('rss_elements_period_field'). " >= CONCAT(DATE_SUB(CURDATE(), INTERVAL " .$period ."), ' 00:00:00') "; }else {$rssNumElements =intval($this->GetOption('rss_num_elements')); if ($rssNumElements >0) {$this->mod->browser->PageSize =$rssNumElements; }}}else {trigger_error("Can't replace browser option PageSize", E_USER_WARNING); }if ($this->activeModule->issetOption(I4980)) {$IL1LlII =str_replace("rss_","",$this->GetOption(I4980)); if ((!empty($IL1LlII)) and ($this->GetOption(I4980) != I4977) )$this->mod->browser->SetForceRules ("ORDER BY ".$IL1LlII." desc", I4981); }}elseif( !empty($this->mod->IIllIL1[$this->mod->moduleName != 'forum' ?'body_items' :'body_itemD']) && $this->activeModule->issetOption("rss_display_page") && $this->activeModule->issetOption(I4982) ){$IL1LlIl =Array("active_item_type"=>"body_items") +$vData; $IL1LlIL =array(); $this->mod->_GetNavDataCB($IL1LlIL, $IL1LlIl); if ($this->mod->moduleName != 'forum') {$this->linkRSS =$this->root_path_www.$this->cms->ActiveScript.$IL1LlIL["nav_data"]; }else if (isset($IL1LlIl[I4983])) {$this->linkRSS =$this->root_path_www.preg_replace('/\?.*$/', '', $IL1LlIl[I4983]) .'?'; }$aDisplayPage =(array) $this->GetOption("rss_display_page"); if ((in_array(I4984, $aDisplayPage)) and ($this->GetOption(I4982) != I4977) ){$linkImage =$this->cms->Gui->getAbs("rss_block:".$this->GetOption(I4982)); $aRssData =array( 'rss_tpl_linkimg' => $linkImage, 'rss_tpl_href' => $this->linkRSS .'action=export_rss', I4985 => false );if($this->activeModule->issetOption('disable_se_indexing_pages')){ $aRssData[I4985] =in_array('page_ext_rss', $this->activeModule->GetOption('disable_se_indexing_pages')); }$vData[I4984] =$this->cms->Gui->getAbs("rss_block:rss_generate", $aRssData); }if (in_array(I4986,$aDisplayPage)) {$this->cms->Gui->addHeaderTag("link", "rel=\"alternate\" type=\"application/rss+xml\" title=\"RSS\" ". "href=\"". $this->linkRSS."action=export_rss\""); }}parent::TTIll1I($cId, $vItemData, $vData, $IILIILl); }function TTIl1lI($cId, &$vItemData, &$vData, &$IILIILl) {parent::TTIl1lI($cId, $vItemData, $vData, $IILIILl); if (!$this->IL1LI11 && $this->activeModule->IssetProperty("rss_link_smallblock") ){$omitLinkRSS =false; if ($this->activeModule->issetOption("spec_id_pages")) {$aSpecIdPages =$this->activeModule->GetAOption("spec_id_pages"); $aPages =$this->cms->Core->TTlI1I1($this->activeModule->GetName()); if (($key =array_search("0", $aSpecIdPages)) !== false) unset($aSpecIdPages[$key]); if (sizeof($aPages) >1 && (sizeof($aSpecIdPages) != 1 || in_array(-1, $aSpecIdPages))) {$omitLinkRSS =true; }}if (!$omitLinkRSS && $this->activeModule->GetProperty("rss_link_smallblock") && $this->activeModule->issetOption(I4987) && $this->activeModule->issetOption(I4982)) {$this->linkRSS =$this->root_path_www.$vItemData["front_link"]."?"; $aDisplayPage =(array) $this->GetOption(I4987); if ((in_array(I4984, $aDisplayPage)) and ($this->GetOption(I4982) != I4977) ){$this->cms->Gui->addBlock("rss_block", "templates/ext_rss.tpl"); $linkImage =$this->cms->Gui->getAbs(I4988.$this->GetOption(I4982)); $aRssData =array ("rss_tpl_linkimg" => $linkImage, "rss_tpl_href" => $this->linkRSS."action=export_rss"); $vData[I4984] =$this->cms->Gui->getAbs("rss_block:rss_generate", $aRssData); }}}}function TTIll1l($cId, &$vItemData, &$vData, &$IILIILl){ global $conn; if($this->IL1LI11){ AMI_Service::hideDebug(); $conn->AddHeader('Content-Type: text/xml; charset=UTF-8'); if($conn->EnableBuffering){ ob_clean(); }echo $vData[$this->mod->moduleName != 'forum' ?'item_list' :'itemD_list']; $GLOBALS['Core']->Cache->pageIsComplitedForSave =true; $conn->Out(); die; }}function _FillFrontDataMapping(&$aItem, &$aData) {if ($this->activeModule->issetOption(I4989)) {$rssItemTitle =str_replace("rss_", I4981, $this->GetOption(I4989)); $aItem["rss_tpl_item_title"] =$aItem[$rssItemTitle]; $aItem["rss_tpl_item_title"] =$this->removeTagsSpecialCharsDB($rssItemTitle, $aItem["rss_tpl_item_title"]); }if ($this->activeModule->issetOption("rss_item_description")) {$IL1LlI1 =str_replace("rss_", I4981, $this->GetOption("rss_item_description")); $aItem["rss_tpl_item_description"] =$aItem[$IL1LlI1]; $aItem["rss_tpl_item_description"] =$this->improveURL($aItem["rss_tpl_item_description"]); $aItem["rss_tpl_item_description"] =$this->removeTagsSpecialCharsDB($IL1LlI1, $aItem["rss_tpl_item_description"]); $hasDetails =trim(strip_tags($aItem[$this->mod->options['description_field_name']])) !== ''; $aItem['rss_tpl_item_description_details_link'] =$hasDetails; $aItem['rss_tpl_item_link'] =$this->_itemLink .$this->_HrefLink($aItem['nav_data']); if($hasDetails){ if(method_exists($this->mod, 'cbRSSItem')){ $this->mod->cbRSSItem($aItem); }$aItem['rss_details'] =$this->cms->Gui->getAbs('rss_block:rss_details', array('link' => $aItem['rss_tpl_item_link'])); $aItem['rss_details'] =$this->removeTagsSpecialCharsDB( $IL1LlI1, $this->improveURL($aItem['rss_details']) );}}if ($this->activeModule->issetOption(I4990)) {$IL1LllI =str_replace("rss_", I4981, $this->GetOption(I4990)); $aItem["rss_tpl_item_fulltext"] =isset($aItem[$IL1LllI]) ?$aItem[$IL1LllI] :''; $aItem["rss_tpl_item_fulltext"] =$this->improveURL($aItem["rss_tpl_item_fulltext"]); $aItem["rss_tpl_item_fulltext"] =$this->removeTagsSpecialCharsDB($IL1LllI, $aItem["rss_tpl_item_fulltext"]); }if ($this->activeModule->issetOption(I4980)) {$IL1LlII =str_replace("rss_", I4981, $this->GetOption(I4980)); $aItem["rss_tpl_item_pubdate"] =date(I4991, strtotime($aItem[$IL1LlII])); }if ($this->activeModule->issetOption("rss_item_guid")) {if ($this->GetOption("rss_item_guid") == "rss_link" )$aItem["rss_tpl_item_guid"] =$this->linkRSS.I4992.$aItem["id"]; }if($this->activeModule->issetOption('rss_item_enclosure')){ $map =array ('rss_small_image' => 'small_picture_src', I4993 => 'picture_src', 'rss_popup_image' => 'popup_picture_src' );$source =$this->GetOption('rss_item_enclosure'); $fileNameImage =isset($map[$source]) ?(isset($aItem[$map[$source]]) ?$aItem[$map[$source]] :I4994) :I4994; $fileNameImage =trim(str_replace($this->root_path_www, I4994, $fileNameImage)); if (file_exists($fileNameImage)) {$imgTypes =$this->cms->Core->GetProperty("images_mimes"); $fileExtension =mb_strtoupper(get_file_ext($fileNameImage)); if (isset($imgTypes[$fileExtension]) ){$aItem["rss_tpl_enclosure_src"] =$this->root_path_www.$fileNameImage; $aItem["rss_tpl_enclosure_size"] =filesize($fileNameImage); $aItem["rss_tpl_enclosure_type"] =$imgTypes[$fileExtension]; }}}}function improveURL (&$Str) {$patternHref ="/href=(\"|')?([^\"'\s]+)/si"; preg_match_all ($patternHref, $Str, $matches); AMI_Registry::push('disable_error_mail', true); foreach ($matches[2] as $key => $strVal) {$parseUrl =parse_url($strVal); if (!isset($parseUrl["host"]) || $parseUrl["host"]== I4981) $Str =str_replace($strVal, $this->root_path_www.$strVal, $Str); }$patternSrc ="/src=(\"|')?([^\"'\s]+)/si"; preg_match_all ($patternSrc, $Str, $matches); foreach ($matches[2] as $key => $strVal) {$parseUrl =parse_url($strVal); if (!isset($parseUrl[I4995]) || $parseUrl[I4995]== I4981) $Str =str_replace($strVal, $this->root_path_www.$strVal, $Str); }$Str =preg_replace('/(' .preg_quote($this->root_path_www, '/') .')+/i', $this->root_path_www, $Str); AMI_Registry::pop('disable_error_mail'); return $Str; }function _escapeXmlChars(&$str) {$aXmlReplaceChars =array( I4996 => '&amp;', '<' => '&lt;', '>' => I4997, '"' => '&quot;' );return strtr($str, $aXmlReplaceChars); }function removeTagsSpecialChars($vData) {$vData =unhtmlentities($vData); $vData =strip_tags($vData); $aSetHTML =get_html_translation_table(HTML_SPECIALCHARS, ENT_QUOTES); foreach ($aSetHTML as $key => $val) {$aSetChars[] =htmlspecialchars($val); $aSetChars[] =htmlspecialchars($key); $aSetChars[] =$key; }$aSetChars[] ="'"; $aSetChars[] ="&apos;"; $aSetChars[] =I4998; $aSetChars[] ="apos;"; $aSetChars[] ="nbsp;"; $vData =str_replace ($aSetChars, I4981, $vData); return $vData; }function removeTagsSpecialCharsDB($Field, $vData) {$vData =$this->_escapeXmlChars($vData); $vData =str_replace("'", "&apos;", $vData); $vData =str_replace(I4998, I4999, $vData); $vData =preg_replace("/(&lt;)+$/", I4981, $vData); $vData =preg_replace("/^(&gt;)+/", I4981, $vData); $vData =preg_replace("/(&amp;lt;)+$/", I4981, $vData); $vData =preg_replace("/^(&amp;gt;)+/", I4981, $vData); $vData =trim($vData); return $vData; }function _HrefLink($link){ $link =stripslashes($link); $anchor =I4981; if(($pos =mb_strpos($link, I5000)) !== false){ $anchor =mb_substr($link, $pos); $link =mb_substr($link, 0, $pos); }$link =preg_replace('/&(?:cat)?offset=(&|$)/i', '\\1', $link); $link =preg_replace('/\?(?:cat)?offset=(&|$)/i', '?', $link); if($link[mb_strlen($link)-1] == I5001){ $link =mb_substr($link, 0, mb_strlen($link)-1); }return $link.$anchor; }}