<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       37772 xkqwypsmwunpkwwnrzgwxmmkmsinyurskluimtkmzrupkstpzlmmmrlmqymimiruryszpnir
 */ ?><?php foreach(array(5080=>"rZtMnP",5081=>"SMDGJZB|vHtQD",5082=>'|MtQI',5083=>"WZt|IHSuJQ|nZIQ",5084=>"QxtQnDMHnD",5085=>"fHrI|tBGQ",5086=>'RqihTq|zssR',5087=>'vMS',5088=>"vHtQD|rZtQ?",5089=>"!?",5090=>"ZWtMHn",5091=>"WOQWKQS",5092=>"HYLQWt",5093=>"vHtQD|rZtQ",5094=>"00000000",5095=>"fMQJSD",5096=>"YHSB|MtQID",5097=>"WZt|MS",5098=>"rZtMnP|SZtZ",5099=>"IQtOHS",5100=>"|pQtFrHntFHrIwy",5101=>"dqjqwT?MS|IHSuJQ!?MS|MtQI?FRhi?WID|rZtQ|OMDtHrB?coqRq?vMS='",5102=>"MS|IHSuJQ",5103=>'%',5104=>':3z',5105=>'',5106=>'IDP',5107=>'0',5108=>'_',5109=>"IHSuJQ|nZIQ",5110=>"rZtMnP|MIP",5111=>"vHtQD|YJHWK",5112=>'MS|MtQI',5113=>'MS',5114=>'ZJJHC|rZtMnPD',5115=>"rZtMnP|tQxt",5116=>"rZtMnP|fHrI|YHSB",5117=>"WHnfMrI|rQPMDtQr",5118=>"'",5119=>"vHtQD|WHunt",5120=>"WZt|rZtMnP|YJHWK",5121=>"PrG|rQDQt|rZtMnPD",5122=>"vHtQD|rZtQ=",5123=>"",5124=>"MtQI|JMnKD|ZJJHCQS",5125=>"WZtMS",5126=>"MS",5127=>"MG",5128=>'rZtMnP',5129=>'b+I+S?o+M+D',5130=>"WID|rZtQ|OMDtHrB",5131=>"PrZSQ|DMAQ",5132=>"}}\$rQPSZBD-",5133=>"CQMPOt|fHrIuJZ",5134=>'!',5135=>"ZvQrZPQ|WZt|rZtMnP",5136=>"IQIYQrD",5137=>"?coqRq?MS|WZt=",5138=>"?dqT?vHtQD|WHunt=",5139=>"?coqRq?MS=",5140=>"'{",5141=>'DEJ|ZSSHn',5142=>'DQJQWt',5143=>'|DEJ',5144=>"MS|IHSuJQ='",5145=>"?zNs?",5146=>"vMS='") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ExtRating extends CMS_ExtModule {public $IlllLll; public $frontModuleName; public $catModuleName; public $catRatingsEnabled; public $currentAction; public $tablePrefix; public $IL1LLLL; public $bodyType; public $aRateOptions; public $decimalPlaces; public $defaultRating; public $IL1LLL1; public $gradeSize; public $formType; public $userLoggedIn; public $id_user; public $vid; public $numRatingPics; public $membersLink; protected $ratingBlock =''; protected $votesBlock =''; protected $doMapping =FALSE; function ExtRating() {parent::CMS_ExtModule(); }function Init(&$cms, &$IlIlIl1, &$IlIlILI) {parent::Init($cms, $IlIlIl1, $IlIlILI); $this->TTIlIl1(I5080); $this->IlllLll =$IlIlILI; $this->tablePrefix =$this->IlllLll->options["default_prefix"]; $this->IL1LLLL =$IlIlIl1->GetTableName(); $this->aRateOptions =Array("allow_ratings", "display_ratings", "sort_by_ratings", I5081); $this->defaultRating =floatval($this->GetOption("default_rating")); $this->decimalPlaces =intval($this->GetOption("rating_decimal_places")); $this->catModuleName =""; $this->catRatingsEnabled =false; $modId =$this->IlllLll->moduleName; if(preg_match('/^(eshop|kb|portfolio)_home$/', $modId, $aMatches)){ $modId =$aMatches[1] .I5082; }$this->doMapping =AMI::getResourceModel($modId .'/table') ->hasField('votes_rate'); }function TTIllT1($cId, &$vItemData, &$vData, &$IILIILl) {parent::TTIllT1($cId, $vItemData, $vData, $IILIILl); $this->catModuleName =$vItemData[I5083]; $this->catRatingsEnabled =($this->IlllLll->module->IssetAndTrueOption("extensions") && in_array("ext_rating", $this->cms->Core->GetModOption($this->catModuleName, I5084))); }function GetModuleName() {return "ext_rating"; }function ProcessAction(&$IIIL11l, $cId, &$aItemData, &$vData, &$IILIILl) {$this->currentAction =$IIIL11l; parent::ProcessAction($IIIL11l, $cId, $aItemData, $vData, $IILIILl); }function TTIlI11($cId, &$vItemData, &$vData, &$IILIILl) {$this->cms->Gui->addGlobalVars(Array("EXTENSION_RATING" => "1")); parent::TTIlI11($cId, $vItemData, $vData, $IILIILl); }function TTIllTT($cId, &$vItemData, &$vData, &$IILIILl) {}function TTIllTI($cId, &$vItemData, &$vData, &$IILIILl) {parent::TTIllTI($cId, $vItemData, $vData, $IILIILl); }function TTIllTl($cId, &$vItemData, &$vData, &$IILIILl) {global $oSession; $this->gradeSize =intval($this->GetOption("grade_size")); $this->formType =$this->GetOption(I5085); $this->cms->Gui->addBlock($this->IlllLll->moduleName ."_rating_tpl", "templates/" .$this->GetOption("form_template")); parent::TTIllTl($cId, $vItemData, $vData, $IILIILl); $this->userLoggedIn =(is_object($this->IlllLll->cms->Member) && $this->IlllLll->cms->Member->isLoggedIn()); $this->id_user =0; if ($this->userLoggedIn) {$this->id_user =$this->IlllLll->cms->Member->getUserInfo("id"); }$this->ip =ip2long(getenv(I5086)); if (isset($this->cms->VarsCookie['vid'])) {$this->vid =$this->cms->VarsCookie['vid']; }else {$this->vid =md5(getenv(I5086) .':' .rand(0, 1000000) .':' .microtime()); SetLocalCookie(I5087, $this->vid, time() +315360000); }$this->numRatingPics =5; }function TTIllIl($cId, &$vItemData, &$vData, &$IILIILl) {$optionsVal =$this->TITII1I($cId); foreach ($this->aRateOptions as $optIndex => $optName) {$vData[$optName] =($this->getOptionBit($optionsVal, $optIndex) == 1) ?"checked" :""; }parent::TTIllIl($cId, $vItemData, $vData, $IILIILl); }function TITIII1($cId, &$vItemData, &$vData, &$IILIILl) {$vData["select"] .= ", " .$this->tablePrefix .I5088; $vData["select"] .= ", " .$this->tablePrefix ."votes_count "; $vData["select"] .= I5089 .$this->tablePrefix ."rate_opt "; }function TITIIlT($cId, &$vItemData, &$vData, &$IILIILl) {if (isset($IILIILl["current_table_prefix"])) {$this->IlllLll->cms->Pager->TI1TITl($IILIILl["current_table_prefix"] ."votes_rate"); $this->IlllLll->cms->Pager->TI1TITl($IILIILl["current_table_prefix"] ."votes_count"); $this->IlllLll->cms->Pager->TI1TITl($IILIILl["current_table_prefix"] ."rate_opt"); }}function TTIllI1($cId, &$vItemData, &$vData, &$IILIILl) {$IILIILl["current_table_prefix"] =$this->tablePrefix; $this->TITIIlT($cId, $vItemData, $vData, $IILIILl); if ($vData[I5090] == "add") {$vData["votes_count"] ="0"; $vData["votes_rate"] =$this->defaultRating; foreach ($this->aRateOptions as $optIndex => $optName) {$vData[$optName] =($this->GetOption($optName)) ?I5091 :""; }}$IILIILl["fields"] += Array("votes_rate" => Array(I5090 => "callback", I5092 => &$this, "method" => "_GetAdminItemCB")); parent::TTIllI1($cId, $vItemData, $vData, $IILIILl); if ($this->catRatingsEnabled && $this->cms->Core->GetModOption($this->catModuleName, "average_cat_rating")) {$this->TITIIll(); }}function _GetAdminItemCB(&$aItem) {$aItem["votes_rate"] =round($aItem[I5093], $this->decimalPlaces); }function TTIllII($cId, &$vItemData, &$vData, &$IILIILl) {if ($this->IlllLll->cms->VarsPost["rewrite_ratings"] == "true") {$vItemData["votes_count"] =$this->IlllLll->cms->VarsPost["votes_count"]; $vItemData[I5093] =$this->IlllLll->cms->VarsPost[I5093]; }$optionsVal =I5094; foreach ($this->aRateOptions as $optIndex => $optName) {if (isset($this->IlllLll->cms->VarsPost[$optName])) {$optionsVal =$this->setOptionBit($optionsVal, $optIndex, 1); }}$field =$this->doMapping ?'rate_opt' :'ext_rate_opt'; $vItemData[$field] =bindec($optionsVal); parent::TTIllII($cId, $vItemData, $vData, $IILIILl); }function TTIll1I($cId, &$vItemData, &$vData, &$IILIILl) {$this->bodyType =$IILIILl["page_item_type"]; $this->frontModuleName =$this->IlllLll->moduleName; $showform =true; switch ($this->bodyType) {case "body_cats": if ($this->catRatingsEnabled) {$IILIILl["current_table_prefix"] ="c."; $this->TITIIlT($cId, $vItemData, $vData, $IILIILl); $this->cms->Gui->addBlock($this->catModuleName ."_rating_tpl", "templates/" .$this->GetOption("form_template")); $IILIILl[I5095]["cat_rating_data"] =Array(I5090 => "callback", I5092 => &$this, "method" => "_GetFrontItemCB"); }break; case I5096: case 'body_urgent_items': case "body_filtered": if ($this->catRatingsEnabled) {$this->_GetFrontItemCB($vData); $avg =$this->cms->Core->GetModOption($this->catModuleName, "average_cat_rating"); if ($avg == false) {$this->frontModuleName =$this->catModuleName; if (isset($vData["cat_id"]) && (!$this->TITII1T($vData[I5097]))) {$this->_GetFrontFormCB($vData); }$this->frontModuleName =$this->IlllLll->moduleName; }}$IILIILl["current_table_prefix"] =$this->tablePrefix; $this->TITIIlT($cId, $vItemData, $vData, $IILIILl); break; case "body_browse": case "body_itemD": if ($this->catRatingsEnabled) {$this->TITIIlI($vData); }$IILIILl["current_table_prefix"] =$this->tablePrefix; $this->TITIIlT($cId, $vItemData, $vData, $IILIILl); break; default: break; }$IILIILl[I5095][I5098] =Array(I5090 => "callback", I5092 => &$this, "method" => "_GetFrontItemCB"); if ($this->cms->Core->IsInstalled("members") && $this->GetOption("rating_by_registered_only")) {$mMembers =$this->cms->Core->GetModule("members"); $this->membersLink =$mMembers->GetFrontLink(); }if ($this->GetOption("rating_by_registered_only") && !$this->userLoggedIn) {$IILIILl[I5095]["confirm"] =Array(I5090 => "callback", I5092 => &$this, I5099 => "_GetFrontConfirmCB"); }if ($showform && in_array($this->bodyType, $this->GetOption("show_form_in"))) {$IILIILl[I5095]["rating_form"] =Array(I5090 => "callback", I5092 => &$this, I5099 => I5100); }parent::TTIll1I($cId, $vItemData, $vData, $IILIILl); return; }function processAjaxRequest() {if (isset($this->IlllLll->cms->VarsPost['is_ajax'])) {$cookieString =''; $expTimeUser =strtotime($this->GetOption("history_allow_same_user")); $expTimeIP =strtotime($this->GetOption("history_allow_same_ip")); $expTimeVid =strtotime($this->GetOption("history_allow_same_vid")); $cookieExpTime =min(array($expTimeUser, $expTimeIP, $expTimeVid)); $aModuleRatings =array(); $sql =I5101 .$this->vid ."' ORDER BY id DESC LIMIT 150"; $this->db->query($sql); while ($this->db->next_record()) {$module =$this->db->Record[I5102]; $item =$this->db->Record["id_item"]; if (!isset($aModuleRatings[$module])) {$aModuleRatings[$module] =array(); }$aModuleRatings[$module][] =$item; }if (count($aModuleRatings)) {$moduleRatings =''; foreach ($aModuleRatings as $module => $aRatings) {$moduleRatings .= $module .':' .implode(I5103, $aRatings) .';'; }$checkStr =str_replace(I5103, '%3A', $moduleRatings); $checkStr =str_replace(';', '%3B', $checkStr); if (strlen($checkStr) >1000) {$checkStr =substr($checkStr, 0, 1000); $checkStr =substr($checkStr, 0, strrpos($checkStr, I5104)); $checkStr =str_replace(I5104, I5103, $checkStr); $moduleRatings =str_replace('%3B', ';', $checkStr); $moduleRatings .= ';'; }$cookieString =$moduleRatings; }$aSysMsgs =array(); $aPlainMsgs =array(); $statusMessages =$this->cms->getStatusMsgArrays($aSysMsgs, $aPlainMsgs); $aStatusMessages =array_merge($aSysMsgs, $aPlainMsgs); $cookieLifetimeHrs =ceil(($cookieExpTime -time()) /3600); $status =''; $error =I5105; foreach ($aStatusMessages as $aMessage) {if (preg_match("/\<script/i", $aMessage['msg'])) {$aMatches =array(); preg_match("/alert\('(.*)'\)/isU", $aMessage['msg'], $aMatches); $status =$aMatches[1]; }else {$status =$aMessage[I5106]; }$error =(isset($aMessage['type']) && ($aMessage['type'] == 'red')) ?'1' :I5107; }$this->cms->Core->Cache->SetForceExpireTime($this->frontModuleName, '+ 15 minute'); $this->cms->Core->Cache->ClearCacheNow(); $oResponse =AMI::getSingleton('response'); $oResponse->directOutput($cookieString .'|' .$cookieLifetimeHrs .'|' .$this->ratingBlock .I5108 .$this->votesBlock .I5108 .$status .I5108 .$error); }}function _GetFrontItemCB(&$aItem) {if (!isset($aItem['votes_rate'])) {return; }$IL1LL1I =""; if (isset($aItem["set_prefix"])) {$IL1LL1I =$aItem["set_prefix"]; }$aItem[I5109] =$this->frontModuleName; $aItem[I5110] =round((($this->numRatingPics) *($aItem[I5093])) /(($this->defaultRating) *2 -1), 0); $aItem[I5093] =round($aItem[I5093], $this->decimalPlaces); $itemOptions ="0000000" .decbin($aItem["rate_opt"]); $aItem['rating_block'] =$aItem['votes_block'] =I5105; if ($this->GetOption("minimum_votes_to_display") <= $aItem["votes_count"]) {if ($this->getOptionBit($itemOptions, array_search("display_ratings", $this->aRateOptions))) {$aItem["rating_block"] =$this->cms->Gui->get($this->IlllLll->moduleName ."_rating_tpl:rating_block", $aItem); }if ($this->getOptionBit($itemOptions, array_search(I5081, $this->aRateOptions))) {$aItem[I5111] =$this->cms->Gui->get($this->IlllLll->moduleName ."_rating_tpl:votes_block", $aItem); }}if(isset($aItem['id']) && isset($this->IlllLll->cms->VarsPost['id_item'])){ $itemId =$aItem['id']; $IL1LL1l =$this->IlllLll->cms->VarsPost[I5112]; if( $itemId != $IL1LL1l && 'eshop_item' == $this->frontModuleName && $this->cms->Core->GetModOption('eshop_item', 'item_links_allowed') ){$oItem =AMI::getResourceModel('eshop_item/table') ->findByFields( array( I5113 => $IL1LL1l, 'id_source' => $itemId ),array(I5113) );if($oItem->id){ $this->IlllLll->cms->VarsPost[I5112] =$itemId; $IL1LL1l =$itemId; }}if($IL1LL1l == $itemId){ $this->ratingBlock =isset($aItem["rating_block"]) ?$aItem["rating_block"] :I5105; $this->votesBlock =isset($aItem[I5111]) ?$aItem[I5111] :I5105; $this->processAjaxRequest(); }}}function _GetFrontFormCB(&$aItem) {if ($this->getOptionBit($aItem['rate_opt'], array_search(I5114, $this->aRateOptions))) {$aItem[I5102] =$this->frontModuleName; $aItem[I5109] =$this->frontModuleName; $aItem["rating_form_body"] =$this->cms->Gui->get($this->IlllLll->moduleName ."_rating_tpl:rating_" .$this->formType ."_open", $aItem); for ($i =0; $i <$this->gradeSize; $i++) {$aItem["rating_value"] =$i; $aItem[I5115] ="item " .$i; $aItem["rating_form_body"] .= $this->cms->Gui->get($this->IlllLll->moduleName ."_rating_tpl:rating_" .$this->formType ."_items", $aItem); }$aItem[I5116] .= $this->cms->Gui->get($this->IlllLll->moduleName ."_rating_tpl:rating_" .$this->formType ."_close", $aItem); $aItem["rating_form"] =$this->cms->Gui->get($this->IlllLll->moduleName ."_rating_tpl:rating_form", $aItem); }}function _GetFrontConfirmCB(&$aItem) {$aItem[I5117] ="true"; $aItem["register_link"] =$this->membersLink; }function TTIl11T($cId, &$vItemData, &$vData, &$IILIILl) {$this->_GetFrontItemCB($vItemData); }function TITIIlI(&$vData) {$tmpMod =&$this->cms->Core->GetModule($this->catModuleName); $tableName =$tmpMod->GetTableName(); $sql ="SELECT votes_rate, votes_count FROM " .$tableName ." WHERE id='" .intval($vData[I5097]) .I5118; $this->db->query($sql); if ($this->db->next_record() && ($this->GetOption("minimum_votes_to_display") <= $this->db->Record["votes_count"])) {$vData["cat_votes_rate"] =$this->db->Record[I5093]; $vData["cat_votes_count"] =$this->db->Record[I5119]; $vData["cat_votes_rate"] =round($vData["cat_votes_rate"], $this->decimalPlaces); $vData["cat_rating_img"] =round((($this->numRatingPics) *($vData["cat_votes_rate"])) /(($this->defaultRating) *2 -1), 0); $vData[I5120] =$this->cms->Gui->get($this->IlllLll->moduleName ."_rating_tpl:cat_rating_block", $vData); $vData["cat_votes_block"] =$this->cms->Gui->get($this->IlllLll->moduleName ."_rating_tpl:cat_votes_block", $vData); }}function TTIl1Il($cId, &$vItemData, &$vData, &$IILIILl) {if ($IILIILl["ext_action"] == I5121) {$aGroupIds =$this->IlllLll->TTTlT11($this->cms->Vars["_grp_ids"]); $numItems =sizeof($aGroupIds); if ($numItems >0) {$sql ="UPDATE " .$this->IL1LLLL ." SET  "; $sql .= "votes_count=0, votes_weight=0, rate_opt=15, "; $sql .= I5122 .$this->GetOption("default_rating"); $sql .= " WHERE id IN(" .implode(",", $aGroupIds) .")"; $this->db->query($sql); $this->IlllLll->cms->AddStatusMsg("status_grp_note_resetratings", "blue", "", "", Array("num_items" => $numItems .I5123)); }}}function TTIl1IT($cId, &$vItemData, &$vData, &$IILIILl) {if (isset($this->IlllLll->cms->VarsPost['action']) && $this->IlllLll->cms->VarsPost['action'] == 'rate') {$langFile =$this->cms->Gui->ParseLangFile("templates/lang/_rating_msgs.lng"); $this->cms->InitMessages($langFile); $ratingOK =(!$this->GetOption("rating_by_registered_only")) || $this->userLoggedIn; if ($ratingOK) {$this->TITIIl1(); if (isset($this->IlllLll->cms->VarsPost["id_item"]) && $this->IlllLll->cms->VarsPost["id_item"] != I5123) {$ratedID =intval($this->IlllLll->cms->VarsPost["id_item"]); $this->frontModuleName =$this->IlllLll->moduleName; $tableName =$this->IL1LLLL; if ($this->IlllLll->moduleName == 'eshop_item' && $this->IlllLll->module->IssetAndTrueOption(I5124)) {$sql ="SELECT `id_source` FROM {$tableName} WHERE `id` = " .intval($ratedID); $rs =&$this->db->select($sql); $record =$rs->nextRecord(); if (isset($record['id_source']) && $record['id_source']) {$linkRatedID =$ratedID; $ratedID =$record['id_source']; }$sql ="SELECT `id`,`id_category` FROM {$tableName} WHERE `id_source` = " .intval($ratedID); $rs =&$this->db->select($sql); $aLinksRatedID =array(); while ($record =$rs->nextRecord()) {$aLinksRatedID[] =$record; }}}elseif (isset($this->IlllLll->cms->VarsPost[I5097]) && $this->IlllLll->cms->VarsPost[I5097] != I5123) {$ratedID =intval($this->IlllLll->cms->VarsPost[I5097]); $this->frontModuleName =$this->catModuleName; $tmpMod =&$this->cms->Core->GetModule($this->catModuleName); $tableName =$tmpMod->GetTableName(); }elseif (isset($this->IlllLll->cms->VarsPost["catid"]) && $this->IlllLll->cms->VarsPost[I5125] != I5123) {$ratedID =intval($this->IlllLll->cms->VarsPost[I5125]); $this->frontModuleName =$this->catModuleName; $tmpMod =&$this->cms->Core->GetModule($this->catModuleName); $tableName =$tmpMod->GetTableName(); }$rated =true; if (isset($ratedID)) {$rated =$this->TITII1T($ratedID); }if ($rated == true) {$this->cms->AddStatusMsg("status_error_" .$this->frontModuleName, "red"); unset($this->cms->VarsGet['status_msg'], $this->cms->VarsCookie['status_msg']); }else {$aInsertHistory =Array(); $aInsertHistory[I5126] ="LAST_INSERT_ID()"; $aInsertHistory[I5102] =$this->frontModuleName; $aInsertHistory["id_item"] ="=|" .$ratedID; if ($this->userLoggedIn) {$aInsertHistory["id_user"] =$this->id_user; }$aInsertHistory[I5127] =$this->ip; $aInsertHistory["vid"] =$this->vid; $aEvent =array( 'modId' => $this->frontModuleName, 'itemId' => $ratedID, 'rating' => $this->IlllLll->cms->VarsPost[I5128], 'userId' => $this->userLoggedIn ?$this->id_user :0, I5087 => $this->vid );AMI_Event::fire('on_rate', $aEvent, $this->GetModuleName()); if ($this->userLoggedIn) {$expireTime =strtotime($this->GetOption("history_allow_same_user")); $aInsertHistory["date_expire_user"] =date(I5129, $expireTime); }else {$expireTime =strtotime($this->GetOption("history_allow_same_ip")); $aInsertHistory["date_expire_ip"] =date(I5129, $expireTime); }$expireTime =strtotime($this->GetOption("history_allow_same_vid")); $aInsertHistory["date_expire_vid"] =date(I5129, $expireTime); $sql =$this->db->GenInsertSQL(I5130, $aInsertHistory); $this->db->query($sql); $sql ="SELECT votes_count, votes_weight, votes_rate FROM " .$tableName ." WHERE id=" .$ratedID; $this->db->query($sql); if ($this->db->next_record()) {$count =intval($this->db->Record[I5119]); $weight =intval($this->db->Record["votes_weight"]); $rating =floatval($this->db->Record[I5093]); }$rval =1 +(intval($this->IlllLll->cms->VarsPost[I5080]) *($this->GetOption("default_rating") *2 -2) /($this->GetOption(I5131) -1)); $userWeight =1; if ($this->GetOption("weighted_rating") && $this->userLoggedIn) {$regdays =intval((time() -$this->IlllLll->cms->Member->getUserInfo("date_timestamp")) /(24 *60 *60)); $formula =str_replace(" ", I5123, $this->GetOption("weight_formula")); $IL1LL1L =I5132; $formula =str_replace($IL1LL1L, I5123, $formula); $aFormula =mb_split(")", $formula); if ((count($aFormula) >2) && is_numeric($aFormula[0]) && is_numeric(str_replace("/", I5123, $aFormula[1])) && is_numeric(str_replace("+", I5123, $aFormula[2]))) {eval("\$userWeight = floatval(" .$this->GetOption(I5133) .");"); }}if ($this->GetOption("weighted_rating") == "true") {$rating =(($rval *$userWeight) +($rating *$weight)) /($weight +$userWeight); }else {$rating =(($rval) +($rating *$count)) /($count +1); }$aUpdateModule =Array(); $aUpdateModule[I5119] =$count +1; $aUpdateModule["votes_weight"] =$weight +$userWeight; $aUpdateModule[I5093] =$rating; if (!empty($aLinksRatedID)) {$linksIDs =I5105; foreach ($aLinksRatedID as $aRecord) {$linksIDs .= $aRecord[I5113] .I5134; }$linksIDs =trim($linksIDs, I5134); $sql =$this->db->GenUpdateSQL($tableName, $aUpdateModule, "WHERE id IN (" .$ratedID ."," .$linksIDs .")"); }else {$sql =$this->db->GenUpdateSQL($tableName, $aUpdateModule, "WHERE id=" .$ratedID); }$this->db->query($sql); if ($this->catRatingsEnabled && $this->cms->Core->GetModOption($this->catModuleName, I5135)) {$this->TITIIll(); if (!empty($aLinksRatedID)) {foreach ($aLinksRatedID as $aRecord) {$this->TITIIll($aRecord['id_category']); }}}$this->cms->AddStatusMsg("status_add"); unset($this->cms->VarsGet['status_msg'], $this->cms->VarsCookie['status_msg']); }}else {$IL1LL11 =I5123; if ($this->cms->Core->IsInstalled(I5136)) {$mMembers =$this->cms->Core->GetModule(I5136); $IL1LL11 =$mMembers->GetFrontLink(); }$this->cms->AddStatusMsg("status_please_register", "red", I5123, I5123, Array('registerlink' => $IL1LL11)); }}}function TITIIll($realCatId =null) {if (empty($realCatId) && isset($this->IlllLll->cms->VarsPost[I5125])) {$realCatId =intval($this->IlllLll->cms->VarsPost[I5125]); }if ($this->GetOption("weighted_rating")) {$avg ="(sum((votes_weight)*(votes_rate)))/(sum(votes_weight))"; }else {$avg ="avg(votes_rate)"; }if (isset($realCatId)) {$sql ="SELECT sum(votes_count) as total_votes, " .$avg ." as avg_rate"; $sql .= " FROM " .$this->IL1LLLL; $sql .= I5137 .$realCatId ." AND votes_count > 0"; $this->db->query($sql); $tmpMod =&$this->cms->Core->GetModule($this->catModuleName); $tableName =$tmpMod->GetTableName(); if ($this->db->next_record() && is_numeric($this->db->Record["total_votes"]) && is_numeric($this->db->Record["avg_rate"])) {$sql ="UPDATE " .$tableName; $sql .= I5138 .$this->db->Record["total_votes"] .","; $sql .= " votes_rate=" .$this->db->Record["avg_rate"]; $sql .= I5139 .$realCatId; }$this->db->query($sql); }}function TITIIl1() {$now =time(); if ($now >($this->GetOption("last_clearing_time") +strtotime($this->GetOption("history_clear_interval")))) {$dnow =date("Y-m-d H-i-s"); $sql ="DELETE FROM cms_rate_history WHERE "; $sql .= "(date_expire_ip < '" .$dnow ."') OR "; $sql .= "(date_expire_user < '" .$dnow ."') OR "; $sql .= "(date_expire_vid < '" .$dnow .I5140; $this->db->query($sql); $this->IlllLll->cms->Core->SetModOption("ext_rating", "last_clearing_time", $now); $this->IlllLll->cms->Core->SaveOptions("ext_rating"); }}function TTIl1lT($cId, &$vItemData, &$vData, &$IILIILl) {if (!isset($IILIILl['sql_addon'])) {$IILIILl[I5141] =array('select' => I5105); }$IILIILl[I5141]['select'] .= (', ' .$this->tablePrefix .'votes_rate'); $IILIILl[I5141][I5142] .= (', ' .$this->tablePrefix .'votes_count'); $IILIILl[I5141][I5142] .= (', ' .$this->tablePrefix .'rate_opt'); }function TTIl1lI($cId, &$vItemData, &$vData, &$IILIILl) {$this->_GetFrontItemCB($vItemData); }function TTIl1TI($cId, &$vItemData, &$vData, &$IILIILl) {if (!isset($IILIILl[I5143][I5142])) {$IILIILl[I5143][I5142] =I5105; }$IILIILl[I5143][I5142] .= ', c.votes_rate, c.votes_count, c.rate_opt'; }function TITII1T($id =0) {$sql ="SELECT id FROM cms_rate_history WHERE "; $sql .= I5144 .$this->frontModuleName ."' AND "; $sql .= "id_item=" .$id .I5145; if ($this->userLoggedIn) {$sql .= "(id_user='" .$this->id_user ."' OR "; }else {$sql .= "(ip='" .$this->ip ."' OR "; }$sql .= I5146 .$this->vid .I5140; $this->db->query($sql); return $this->db->num_rows() >0; }function TITII1I($id) {$res ="0000000"; $sql ="SELECT rate_opt FROM " .$this->IL1LLLL .I5139 .$id; $this->db->query($sql); if ($this->db->next_record()) {$res .= decbin(($this->db->Record["rate_opt"])); }return $res; }function getOptionBit($num, $bitPos) {if (mb_strlen($num) >$bitPos) {return $num[mb_strlen($num) -$bitPos -1]; }else return (-1); }function setOptionBit($num, $bitPos, $val) {if (mb_strlen($num) >$bitPos) {$num[mb_strlen($num) -$bitPos -1] =$val; }return $num; }}