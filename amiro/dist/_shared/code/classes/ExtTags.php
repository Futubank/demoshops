<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       18566 xkqwkirkxppqgrngtqizymyuwmgwqwlpikxiuzutlgqyzqzguiipugygnutwxzgstnkgpnir
 */ ?><?php foreach(array(5157=>'Drv|tZPD|rQMnSQx',5158=>"rQLQWt",5159=>'nHnQ',5160=>'tZPD',5161=>"PrG|SQJ",5162=>"!",5163=>"QxtQnDMHnD",5164=>'iHSuJQRQMnSQxFunWtMHnD`GOG',5165=>"'?zNs?IHSuJQ|nZIQ?=?'",5166=>"Drv|tZPD",5167=>"",5168=>'tZP',5169=>"tZPD|YJHWK",5170=>"|pQtFrHntmtQIwy",5171=>"WZJJYZWK",5172=>".?coqRq?MS?=?'",5173=>'JMDt',5174=>"DuYJMnK",5175=>"JMDt",5176=>"nQC|DEJ",5177=>"{",5178=>'tQIGJZtQD~JZnP~|',5179=>"'",5180=>'MS',5181=>"'?jmimT?1",5182=>'`JnP') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ExtTags extends CMS_ExtModule {public $II1lIl1; public $ILLLLLL; public $IL1L1I1; public $IL1L1lI; public $IL1L1ll; function ExtTags() {parent::CMS_ExtModule(); }function Init(&$cms, &$IlIlIl1, &$IlIlILI) {parent::Init($cms, $IlIlIl1, $IlIlILI); $this->IL1L1I1 =$this->cms->Core->GetModFrontLink("srv_tags"); $this->IL1L1lI =""; $this->IL1L1ll =$this->cms->Core->IsInstalled(I5157); if (!$this->IL1L1ll) {$this->cms->Gui->addGlobalVars(array ('EXT_TAGS' => '0')); }}function GetModuleName() {return "ext_tags"; }function TTIllIl($cId, &$vItemData, &$vData, &$IILIILl) {}function TTIllI1($cId, &$vItemData, &$vData, &$IILIILl) {}function TTIl1Il($cId, &$vItemData, &$vData, &$IILIILl){ $action =$IILIILl["ext_action"]; if ($this->ILLLLLL[$action] == I5158) {$this->cms->AddStatusMsg("status_audit_reject", "red"); $action ="none"; $this->mod->action ="none"; }if (!$this->IL1L1ll) {$action =I5159; $this->mod->action =I5159; }switch ($action) {case "del": $table =$this->mod->module->GetTableName(); $sql ="SELECT tags FROM `".$table."` WHERE id = '".$cId."'"; $this->mod->db->query($sql); if ($this->mod->db->nextRecord()) {$tags =$this->mod->db->Record[I5160]; if ($tags != "") {$tags =trim($tags, ","); $sql ="UPDATE `cms_tags` SET tmp_count = tmp_count - 1, count = count - 1 WHERE id IN (".$tags.")"; $this->mod->db->query($sql); $this->TITIlTl($cId); }}break; case I5161: $table =$this->mod->module->GetTableName(); foreach ($this->mod->aGroupIds as $value) {$sql ="SELECT tags FROM `".$table."` WHERE id = '".$value."'"; $this->mod->db->query($sql); if ($this->mod->db->nextRecord()) {$tags =$this->mod->db->Record[I5160]; if ($tags != "") {$tags =trim($tags, I5162); $sql ="UPDATE `cms_tags` SET tmp_count = tmp_count - 1, count = count - 1 WHERE id IN (".$tags.")"; $this->mod->db->query($sql); $this->IL1L1lI =""; $this->TITIlTl($value); }}}break; }}function TITIlTl($cId) {if ($this->mod->module->issetOption("extensions")) {$optExtensions =$this->mod->module->getOption(I5163); if (is_array($optExtensions) && !in_array("ext_reindex", $optExtensions)) {require_once $GLOBALS['CLASSES_PATH'] .'CMS_Functions.php'; require_once $GLOBALS['CLASSES_PATH'] .I5164; $modReindex =new ModuleReindexFunctions($this->mod->cms, $this->mod->db, $this->mod->module, $this->mod->module); if (is_object($modReindex)) {$modReindex->reindexById($cId, $this->mod->module, $this->mod->db, $this->mod->langData); }$sql ="UPDATE `cms_site_search` SET tags = '" .$this->IL1L1lI ."' WHERE id_item = '" .$cId .I5165 .$this->mod->moduleName ."'"; $this->mod->db->query($sql); }}$sql ="SELECT MAX(count) AS counter FROM `cms_tags`"; $this->mod->db->query($sql); if ($this->mod->db->nextRecord()) {$counter =$this->mod->db->Record['counter']; $this->mod->cms->Core->WriteOption(I5166, "tags_elements_count", $counter); }}function TTIl1I1($cId, &$vItemData, &$vData, &$IILIILl) {$action =$IILIILl["ext_action"]; switch ($action) {case "add": $this->TITIlTl($this->mod->appliedId); break; case "edit": $tags =I5167; $aTags =array(); if ($vItemData[I5160] !== I5167) {if ($this->IL1L1lI === I5167) {$this->IL1L1lI =$vItemData[I5160]; }if ($this->IL1L1lI != '') {$this->IL1L1lI =trim($this->IL1L1lI, ','); $sql ="SELECT tag FROM `cms_tags` WHERE id IN (".$this->IL1L1lI.")"; $this->mod->db->query($sql); while ($this->mod->db->nextRecord()) {$aTags[] =unhtmlentities($this->mod->db->Record[I5168]); }$vItemData[I5160] =implode(I5162, $aTags); }}break; case "save": break; }}function TTIll1I($cId, &$vItemData, &$vData, &$IILIILl) {if ($this->IL1L1ll) {$bodyType =$IILIILl["page_item_type"]; switch ($bodyType) {case 'body_itemD': $IILIILl["fields"][I5169] =Array("action"=>"callback", "object"=>&$this, "method"=>I5170); break; case 'body_items': break; case 'body_urgent_items': $IILIILl["fields"][I5169] =Array("action"=>I5171, "object"=>&$this, "method"=>I5170); break; }}parent::TTIll1I($cId, $vItemData, $vData, $IILIILl); }function _GetFrontItemCB(&$aItem){ $cId =$aItem['id']; $tags =I5167; $table =$this->mod->module->GetTableName(); $sql ="SELECT tags FROM `".$table.I5172.$cId."' LIMIT 1"; $tags =$this->mod->db->getValue($sql); if ($tags !== I5167) {$tags =trim($tags, ','); $sql ="SELECT * FROM `cms_tags` WHERE id IN (".$tags.")"; $rs =&$this->mod->db->select($sql); $aItem[I5173] =''; while ($IL1L1lL =$rs->nextRecord()) {$IL1L1l1 =array(); $this->cms->PushNavSettings(); $this->cms->InitNavSettings(I5166); $ILLl11l["id"] =$IL1L1lL["id"]; $ILLl11l["id_sublink"] =$IL1L1lL[I5174]; $IL1L1l1 =$this->cms->ApplyNav($ILLl11l); $this->cms->PopNavSettings(); $aData =array(); $aData =$IL1L1lL; $aData["tag_front_link"] =$this->IL1L1I1; $aData =array_merge($aData, $IL1L1l1); $aItem["list"] .= $this->cms->Gui->get($this->mod->moduleName."_list:tag_link", $aData); }$aData["list"] =$aItem[I5175]; $aItem["tags_extension"] =$this->cms->Gui->get($this->mod->moduleName."_list:tags_extension",$aData); unset($aData[I5175]); }}function TTIl1Tl($cId, $vItemData, $vData, $IILIILl) {parent::TTIl1Tl($cId, $vItemData, $vData, $IILIILl); }function TTIl1T1($cId, &$vItemData, &$vData, &$IILIILl) {parent::TTIl1T1($cId, $vItemData, $vData, $IILIILl); }function TTIl1IT($cId, &$vItemData, &$vData, &$IILIILl) {}function TTIl1l1($cId, &$vItemData, &$vData, &$IILIILl) {if (!empty($IILIILl["new_sql"]["tags"])) {$IILIILl[I5176]["tags"] =trim($IILIILl[I5176]["tags"], I5162); $sql ="UPDATE `cms_tags` SET count = count + 1, tmp_count = tmp_count + 1 WHERE id IN (".$IILIILl[I5176]["tags"].I5177; $this->mod->db->query($sql); $this->IL1L1lI =I5167; $this->TITIlTl($cId); }}function TTIllII($cId, &$vItemData, &$vData, &$IILIILl) {$tags =array(); switch ($this->mod->action) {case "add": if (trim($this->cms->VarsPost['srv_tags'])) {$cTags =str_replace(";", I5162, $this->cms->VarsPost['srv_tags']); $aTags =explode(I5162, $cTags); $aTags =array_unique($aTags); if (count($aTags) >0) {$modName =I5166; $oModule =&$this->cms->Core->GetModule($modName); if (is_object($oModule) && $oModule->IsInstalled()) {$db =new DB_si; $oModule->InitEngine($this->cms, $db); $oModule->Engine->Init(array(), I5178 .$modName .'_msgs.lng', 'templates/lang/' .$modName .'.lng'); }foreach ($aTags as $tag) {$IL1L1LI =0; $tag =trim($tag); $sql ="SELECT id FROM `cms_tags` WHERE lower(tag) = '".mb_strtolower($tag).I5179; $this->mod->db->query($sql); if ($this->mod->db->nextRecord()) {$tags[] =$this->mod->db->Record['id']; }else {$aVarsPost =$this->cms->VarsPost; $aVarsGet =$this->cms->VarsGet; $aVars =$this->cms->Vars; $this->cms->VarsPost =array("tag" => $tag, I5174 => I5167); $this->cms->VarsGet =array(); $this->cms->Vars =array(); if (is_object($oModule) && $oModule->IsInstalled()) {$oModule->Engine->ProcessAction("add", $cId); }$this->cms->VarsPost =$aVarsPost; $this->cms->VarsGet =$aVarsGet; $this->cms->Vars =$aVars; $sql ="SELECT id FROM `cms_tags` WHERE tag = '".$tag.I5179; $this->mod->db->query($sql); if ($this->mod->db->nextRecord()) {$tags[] =$this->mod->db->Record[I5180]; }}}unset($oModule); $tags =array_unique($tags); $tagsSql =implode(I5162, $tags); if (count($tags) >0) {$sql ="UPDATE `cms_tags` SET count = count + 1, tmp_count = tmp_count + 1 WHERE id IN (".$tagsSql.I5177; $this->mod->db->query($sql); $vItemData[I5160] =$tagsSql; $this->IL1L1lI =$vItemData[I5160]; $this->TITIlTl($cId); }}$this->TITIlTl($cId); }break; case "save": case "apply": $aTagsOld =array(); $aTagsDel =array(); $table =$this->mod->module->GetTableName(); $sql ="SELECT tags FROM `".$table.I5172.$cId.I5181; $this->mod->db->query($sql); if ($this->mod->db->nextRecord()) {$aTagsOld =explode(I5162, $this->mod->db->Record[I5160]); }$cTags =str_replace(";", I5162, $this->cms->VarsPost['srv_tags']); $aTags =explode(I5162, $cTags); $aTags =array_unique($aTags); $tags =array(); $modName =I5166; $oModule =&$this->cms->Core->GetModule($modName); if (is_object($oModule) && $oModule->IsInstalled()) {$db =new DB_si; $oModule->InitEngine($this->cms, $db); $oModule->Engine->Init(array(), I5178 .$modName .'_msgs.lng', 'templates/lang/' .$modName .I5182); }foreach ($aTags as $tag) {$IL1L1LI =0; $tag =trim($tag); $sql ="SELECT id FROM `cms_tags` WHERE lower(tag) = '".mb_strtolower($tag).I5179; $this->mod->db->query($sql); if ($this->mod->db->nextRecord()) {$tags[] =$this->mod->db->Record[I5180]; if (!in_array($this->mod->db->Record[I5180], $aTagsOld)) {$sql ="UPDATE `cms_tags` SET count = count + 1, tmp_count = tmp_count + 1 WHERE id = '".$this->mod->db->Record[I5180].I5181; $this->mod->db->query($sql); }else {$index =array_search($this->mod->db->Record[I5180], $aTagsOld); unset($aTagsOld[$index]); }}else {if (!empty($tag)) {$aVarsPost =$this->cms->VarsPost; $aVarsGet =$this->cms->VarsGet; $aVars =$this->cms->Vars; $this->cms->VarsPost =array("tag" => $tag, I5174 => I5167); $this->cms->VarsGet =array(); $this->cms->Vars =array(); if (is_object($oModule) && $oModule->IsInstalled()) {$oModule->Engine->ProcessAction("add", $cId); }$this->cms->VarsPost =$aVarsPost; $this->cms->VarsGet =$aVarsGet; $this->cms->Vars =$aVars; $sql ="SELECT id FROM `cms_tags` WHERE lower(tag) = '".mb_strtolower($tag).I5179; $this->mod->db->query($sql); if ($this->mod->db->nextRecord()) {$tags[] =$this->mod->db->Record[I5180]; $sql ="UPDATE `cms_tags` SET count = count + 1, tmp_count = tmp_count + 1 WHERE id = '".$this->mod->db->Record[I5180].I5181; $this->mod->db->query($sql); }}}}foreach ($aTagsOld as $value) {$sql ="UPDATE `cms_tags` SET count = count - 1, tmp_count = tmp_count - 1 WHERE id = '".$value.I5179; $this->mod->db->query($sql); }$vItemData[I5160] =implode(I5162, $tags); $this->IL1L1lI =$vItemData[I5160]; $this->TITIlTl($cId); break; case "edit": break; case "del": break; }}function TITTl1l(&$modEngine){ if (is_object($modEngine)) $modEngine->realSide =$this->realSide; $this->TITTl11(); }}