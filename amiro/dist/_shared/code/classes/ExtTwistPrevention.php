<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       20114 xkqwugqsxstpkpmmsizspinwrpniugrgtqplnluxgxnmqnxinlgyrxkxmtwukiqxspizpnir
 */ ?><?php foreach(array(5183=>'%',5184=>"|LD~IS5`LD",5185=>"MIZPQ|DBIYHJD|DQt",5186=>"|pQtFrHntFHrIwy",5187=>'ZSv|ZSvQrtMDQrD',5188=>'WJZDDMfMQSD',5189=>"ZWtMHn|GQrMHS",5190=>"'{",5191=>'rZtQ',5192=>'',5193=>"nH|WZGtWOZ|ZWtMHnD",5194=>'WZGtWOZdms',5195=>'SMDWuDDMHn',5196=>".Qxt|IHSuJQ.?=?'",5197=>"'",5198=>'MG|ZSSrQDD',5199=>"dqjqwT?1?",5200=>"jmimT?1",5201=>'Qxt|IHSuJQ',5202=>'ZWtMHn',5203=>'=_',5204=>'DWrMGt|fuJJ|JMnK',5205=>'rQS',5206=>"LD|WOQWKMnP",5207=>"IHSuJQ",5208=>"DOHC|WZGtWOZ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ExtTwistPrevention extends CMS_ExtModule {public $IL1L1Ll ="vid"; public $IL1L1LL =31536000; public $IL1L1L1 ='show_num_image'; public $IL1L11I ='srv_twist_prevention'; public $IIIL11l; public $IL1L11l; public $IL1L11L; public $IL1L111; public $IL11III; public $IL11IIl; public $IL11IIL; public $IL11II1; public $IL11IlI; function ExtTwistPrevention() {parent::CMS_ExtModule(); }function GetModuleName() {return "ext_twist_prevention"; }function ProcessAction(&$IIIL11l, $cId, &$aItemData, &$vData, &$IILIILl) {if (!$this->cms->Core->IsInstalled($this->IL1L11I)) {return; }$this->IIIL11l =&$IIIL11l; parent::ProcessAction($IIIL11l, $cId, $aItemData, $vData, $IILIILl); }function TTIllTl($cId, &$vItemData, &$vData, &$IILIILl) {$this->IL1L11L =array_flip($this->cms->Core->TTlI1TI($this->IL1L11I, "visitors_originality_parameters")); if ((isset($this->cms->VarsCookie) && isset($this->cms->VarsCookie[$this->IL1L1Ll])) ){$this->IL1L11l =$this->cms->VarsCookie[$this->IL1L1Ll]; }else {$this->IL1L111 =md5(getenv('REMOTE_ADDR').':'.rand(0, 1000000).I5183.microtime()); SetLocalCookie($this->IL1L1Ll, $this->IL1L111, time() +$this->IL1L1LL, '', true); $this->cms->VarsCookie[$this->IL1L1Ll] =$this->IL1L111; $this->IL1L11l =$this->IL1L111; }$this->IL11IIL =$this->cms->Core->getModOption($this->IL1L11I, "use_js_protection"); $this->IL11IlI =$this->cms->Core->getModOption($this->IL1L11I, "split_image"); $this->IL11II1 =$this->activeModule->GetOption("show_captcha") && (!is_object($this->cms->Member) || ($this->cms->Member->isLoggedIn() ?$this->cms->Core->GetModOption($this->IL1L11I, "show_captcha_for_registered_users") :true) );if ($this->IL11IIL || $this->IL11II1) {$this->cms->Gui->addGlobalVars(array ("EXTENSION_TWIST_PREVENTION" => "1", "EXTENSION_TWIST_PREVENTION_" .mb_strtoupper($this->mod->moduleName) => "1" ));if ($this->IL11II1) {$this->cms->Gui->addScript(I5184); $this->IL11III =$this->cms->Core->issetModOption($this->IL1L11I, "image_digits_qty") ?$this->cms->Core->getModOption($this->IL1L11I, "image_digits_qty") :$this->cms->Core->getModOption($this->IL1L1L1, "image_digits_qty"); $this->IL11IIl =$this->cms->Core->issetModOption($this->IL1L11I, "image_symbols_set") ?$this->cms->Core->getModOption($this->IL1L11I, I5185) :$this->cms->Core->getModOption($this->IL1L1L1, I5185); }$langFile =$this->cms->Gui->ParseLangFile("templates/lang/captcha.lng"); $this->cms->AddMessages($langFile); $this->cms->Gui->addBlock("captcha", "templates/captcha.tpl"); }parent::TTIllTl($cId, $vItemData, $vData, $IILIILl); }function TTIll1I($cId, &$vItemData, &$vData, &$IILIILl, $IL11Ill =true) {$IILIILl["fields"]["ext_twist_prevention"] =Array( "action" => "callback", "object" => &$this, "method" => I5186 );if (!empty($this->mod->isSmallMode)) {if ($this->mod->moduleName != "members") {$this->_GetFrontFormCB($vItemData, $vData); }}elseif (isset($this->mod->ext['ext_discussion']) || in_array($this->mod->moduleName, array ('faq', 'members', I5187, 'subscribe', 'feedback', 'forum', 'guestbook', I5188, 'photoalbum_cat')) ){$this->_GetFrontFormCB($vData, $vData, isset($this->mod->ext['ext_discussion'])); }if ($IL11Ill) {parent::TTIll1I($cId, $vItemData, $vData, $IILIILl); }}function TTIl1IT($cId, &$vItemData, &$vData, &$IILIILl) {$moduleName =$this->mod->moduleName; $action =$this->mod->action; if (!$this->cms->Core->issetModProperty($moduleName, 'twist_actions') || !in_array($action, $this->cms->Core->GetModProperty($moduleName, 'twist_actions')) ){return; }$twist =0; if (checkProbability(0.001)) {$query ="DELETE FROM `cms_twist_prevention` " ."WHERE " ."    `date` <= DATE_SUB(NOW(), INTERVAL " .$this->cms->Core->getModOption($this->IL1L11I, "record_ttl") .")"; $this->db->query($query); if (checkProbability(0.1)) {$query ="OPTIMIZE TABLES `cms_twist_prevention`"; $this->db->query($query); }}if (checkProbability(0.01)) {$query ="DELETE FROM `cms_twist_prevention` " ."WHERE " ."    `twist` = 0 AND " ."    `date` <= DATE_SUB(NOW(), INTERVAL " .$this->activeModule->GetOption(I5189) .")"; $this->db->query($query); }$twistedAction =$this->activeModule->GetOption("generate_twist_action") ?$action ."_twist" :"none"; if (!$this->cms->Core->TTlI1TI($this->IL1L11I, "allow_disabled_cookies") && !empty($this->IL1L111) ){$this->mod->action =$this->IIIL11l =$twistedAction; $twistAlert ='twist_enable_cookies'; $reason ='no_cookies'; }$ip ="INET_ATON('" .getenv('REMOTE_ADDR') .I5190; if (empty($this->IL1L111)) {$cookie ="'" .addslashes($this->IL1L11l) ."'"; $IL11IlL =0; }else {$cookie ="'" .$this->IL1L111 ."'"; $IL11Il1 =1; }do {if (isset($reason)) {$twist =1; break; }if( $action != I5191 && $this->IL11IIL && (empty($this->cms->VarsPost['tp_freu_d']) || $this->cms->VarsPost['tp_freu_d'] != 43 || !isset($this->cms->VarsPost['tp_email']) || $this->cms->VarsPost['tp_email'] !== I5192 )){$reason ="no_javascript"; $twistAlert ="twist_enable_javascript"; $twist =1; $this->mod->action =$this->IIIL11l =$twistedAction; break; }if ($this->activeModule->GetOption("show_captcha") && !in_array($action, $this->cms->Core->GetModProperty("ext_twist_prevention", I5193)) && (!is_object($this->cms->Member) || ($this->cms->Member->isLoggedIn() ?$this->cms->Core->GetModOption($this->IL1L11I, "show_captcha_for_registered_users") :true)) ){$captcha =isset($this->cms->VarsPost['captcha']) ?mb_strtoupper(strval($this->cms->VarsPost['captcha'])) :I5192; $sid =isset($this->cms->VarsPost['captchaSID']) ?strval($this->cms->VarsPost[I5194]) :I5192; if (mb_strlen($captcha) != $this->IL11III) {$twist =1; }else {$oCaptcha =AMI::getResource('captcha', array($moduleName, $sid, $this->IL11III, AMI_Captcha::getConstantCharset($this->IL11IIl))); if ($captcha != $oCaptcha->loadImageString()) {$twist =1; }else {$oCaptcha->removeRecord(); }}if ($twist) {$this->mod->action =$this->IIIL11l =$twistedAction; $twistAlert ='twist_invalid_captcha'; $reason ='invalid_captcha'; break; }}if(empty($this->cms->VarsPost['id_update']) || !in_array($this->activeModule->Name, array(I5195, 'forum', 'guestbook'))){ $where =array (I5196 .$moduleName ."'", "`action` = '" .$action .I5197, "`id_page` = '" .$this->cms->GetPageId() .I5197, "`date` >= DATE_SUB(NOW(), INTERVAL " .$this->activeModule->GetOption(I5189) .")", "`twist` = 0" );if (isset($this->IL1L11L[I5198])) {$where[] ="ip = INET_ATON('" .getenv('REMOTE_ADDR') .I5190; }if (empty($this->IL1L111) && isset($this->IL1L11L['cookie'])) {$where[] ="vid = " .$cookie; }$query =I5199 ."FROM `cms_twist_prevention` " ."WHERE (" .implode(") AND (", $where) .") " .I5200; $this->db->query($query); if ($this->db->num_rows() >0) {$twist =1; $this->mod->action =$this->IIIL11l =$twistedAction; $twistAlert ='twist_detected'; $reason ='too_frequently'; }}}while(false); $aSql =array ('date' => '=|NOW()', I5201 => $moduleName, I5202 => $action, 'id_page' => $this->cms->GetPageId(), 'ip' => '=|' .$ip, 'vid' => I5203 .$cookie, 'is_generated' => I5203 .intval(!empty($this->IL1L111)), 'twist' => I5203 .$twist );if (isset($reason)) {$aSql['reason'] =$reason; }$sql =$this->db->GenInsertSQL('cms_twist_prevention', $aSql); $this->db->query($sql); if ($twist) {$this->cms->Gui->globalVars[I5204] =preg_replace('/status\_msg\=[^&]+/', I5192, $this->cms->Gui->globalVars[I5204]); unset($this->cms->VarsGet['status_msg']); }if (isset($twistAlert) && $this->activeModule->GetOption("show_alert")) {$langFile =$this->cms->Gui->ParseLangFile("templates/lang/_twist_prevention_msgs.lng"); $this->cms->AddMessages($langFile); $this->cms->AddStatusMsg($twistAlert, I5205); }$this->cms->Gui->addGlobalVars(array ("NO_SPAM" => 1 -$twist, "NO_SPAM_" .mb_strtoupper($this->mod->moduleName) => 1 -$twist ));}function TTIl1lI($cId, &$vItemData, &$vData, &$IILIILl) {parent::TTIl1lI($cId, $vItemData, $vData, $IILIILl); $this->TTIll1I($cId, $vItemData, $vData, $IILIILl, false); }function _GetFrontFormCB(&$aItem, &$aData, $IL11ILI =false){ $IL11ILl =$this->IL11II1 && $this->activeModule->GetOption("show_captcha") && (!is_object($this->cms->Member) || ($this->cms->Member->isLoggedIn() ?$this->cms->Core->GetModOption($this->IL1L11I, "show_captcha_for_registered_users") :true)); if ($IL11ILl || $this->IL11IIL) {$IL11ILL =$this->activeModule->GetOption(I5206); $IL11IL1 =$this->cms->Gui->getAbs("captcha:captcha_row", array (I5207 => $this->mod->moduleName, "length" => $this->IL11III, "use_js_protection" => $this->IL11IIL, "split_image" => $this->IL11IlI, I5208 => $IL11ILl ));$IL11I1I =$this->cms->Gui->getAbs("captcha:captcha_script", array ("length" => $this->IL11III, "use_js_protection" => $this->IL11IIL, I5208 => $IL11ILl, 'check_captcha_code' => $IL11ILL ));if ($IL11ILI) {$this->cms->Gui->addGlobalVars(array ('EXTENSION_TWIST_PREVENTION_DISCUSSION_HTML_' .mb_strtoupper($this->mod->moduleName) => $IL11IL1, 'EXTENSION_TWIST_PREVENTION_DISCUSSION_SCRIPT_' .mb_strtoupper($this->mod->moduleName) => $IL11I1I, ));}$aItem["captcha_row"] =$IL11IL1; $aItem["captcha_script"] =$IL11I1I; }}}