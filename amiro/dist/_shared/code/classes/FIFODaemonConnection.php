<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       7409 xkqwpxykiwzxtyryynrtmglkynswyzktxrrkwpxstsgntrqrkutrpizpmusrgrupspqkpnir
 */ ?><?php foreach(array(5217=>'sw|qRR|NhdqRVqR',5218=>"\n",5219=>'%%',5220=>'~DQrv`JHWK',5221=>'dbN',5222=>'FmN') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} define('DC_ERR_TIMEOUT', 0x01); define('DC_ERR_BUSY', 0x02); define(I5217, 0x03); require_once $GLOBALS['CLASSES_PATH'] .'BaseObject.php'; class FIFODaemonConnection extends BaseObject {public $IL11I1l; public $IL11I1L; public $IL11I11; public $path; public $IL11lII; public $IL11lIl; function FIFODaemonConnection($dir,$IL11I11=false) {$this->BaseObject(); $this->path =$dir; $this->IL11I11 =$IL11I11===false ?10 :$IL11I11; $this->IL11lII =$this->IL11I1l =$this->IL11I1L =false; $this->IL11lIl =false; }function TITIlIT($str,$on=true) {if($on) {$str =str_replace("\\","\\\\",$str); return str_replace(I5218,"\\n",$str); }else {$str =str_replace("\\n",I5218,$str); return str_replace("\\\\","\\",$str); }}function TITIlII($fname,&$fd) {$IL11lIL =__CLASS__.I5219.__FUNCTION__.'():'; if(!($fd=@fopen($fname,'w'))) {$this->TTTITTI("$IL11lIL Cannot open $fname for writing"); return -1; }@chmod($fname,0666); if(!@flock($fd,LOCK_EX|LOCK_NB)) return 0; return 1; }function open($to=false) {if($this->IL11lIl) return; $IL11lIL =__CLASS__.I5219.__FUNCTION__.'():'; $IL11lI1 =$this->path.'/client.lock'; $IL11llI =$this->path.I5220; $IL11lll =$this->path.'/sock.serv'; $fin =$this->path.'/sock.client'; clearstatcache(); if(!file_exists($IL11lll) || !file_exists($fin)) {sleep(1); clearstatcache(); if(!file_exists($IL11lll) || !file_exists($fin)) {$this->TTTITTI("$IL11lIL Server is not running"); return DC_ERR_NOSERVER; }}$ret =false; do {$code =$this->TITIlII($IL11lI1,$this->IL11lII); if($code===-1) break; if(!$code) {$this->TTTITTI("$IL11lIL Daemon is talking to another client"); $ret =DC_ERR_BUSY; break; }$code =$this->TITIlII($IL11llI,$fd); if($code===-1) break; if(!$code) {$this->TTTITTI("$IL11lIL Daemon is busy"); @fclose($fd); $ret =DC_ERR_BUSY; break; }fclose($fd); if(!($this->IL11I1L=@fopen($IL11lll,'r+'))) {$this->TTTITTI("$IL11lIL Cannot open $IL11lll"); break; }if(!($this->IL11I1l=@fopen($fin,'r+'))) {$this->TTTITTI("$IL11lIL Cannot open $fin"); break; }$this->IL11lIl =true; if(($ret=$this->send(I5221))!==true) {$this->TTTITTI("$IL11lIL Cannot send SYN"); break; }if(($ret=$this->TITIlIl($data))!==true) {$this->TTTITTI("$IL11lIL Server does not respond to SYN"); break; }if($data!='ACK') {$this->TTTITTI("$IL11lIL Invalid response to SYN: '$data'"); break; }$ret =true; }while(false); if($ret!==true) $this->close(); return $ret; }function TITIlIl(&$data,$to=false) {$IL11lIL =__CLASS__.I5219.__FUNCTION__.'():'; if(!$this->IL11lIl) return $this->TTTITTI("$IL11lIL Connection is not open"); if($to===false) $to =$this->IL11I11; $data =''; $IL11llL =$to; $start =time(); do {if(false===($num=stream_select($read=array($this->IL11I1l),$write=null,$IL11ll1=null,$IL11llL))) {return $this->TITIlI1("$IL11lIL stream_select() returned error"); }elseif($num>0) {$data .= @fread($this->IL11I1l,1024); $len =mb_strlen($data); if($data[$len-1]==I5218) {$data =$this->TITIlIT(mb_substr($data,0,$len-1),false); return true; }}$IL11llL =$to-(time()-$start); }while($IL11llL>0); $this->close(); $this->TTTITTI("$IL11lIL Operation timed out"); return DC_ERR_TIMEOUT; }function send($data,$to=false) {$IL11lIL =__CLASS__.I5219.__FUNCTION__.'():'; if(!$this->IL11lIl) return $this->TTTITTI("$IL11lIL Connection is not open"); if($to===false) $to =$this->IL11I11; $data =$this->TITIlIT($data).I5218; $IL11llL =$to; $start =time(); do {if(false===($num=stream_select($read=null,$write=array($this->IL11I1L),$IL11ll1=null,$IL11llL))) {return $this->TITIlI1("$IL11lIL stream_select() returned error"); }elseif($num>0) {$IL11lLI =@fwrite($this->IL11I1L,$data); if($IL11lLI===false) return $this->TITIlI1("$IL11lIL fwrite() returned error"); $data =mb_substr($data,$IL11lLI); if(mb_strlen($data)==0) return true; }$IL11llL =$to-(time()-$start); }while($IL11llL>0); $this->close(); $this->TTTITTI("$IL11lIL Operation timed out"); return DC_ERR_TIMEOUT; }function close() {if($this->IL11I1L) {$this->send(I5222,2); sleep(1); }$this->_close(); }function _close() {@fclose($this->IL11I1l); @fclose($this->IL11I1L); $this->IL11I1l =$this->IL11I1L =false; $this->IL11lIl =false; @fclose($this->IL11lII); $this->IL11lII =false; }function TITIlI1($msg) {$this->_close(); return $this->TTTITTI($msg); }}?>