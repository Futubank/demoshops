<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       33712 xkqwpqsrtllrwtksuulgxytyzpqwtiyiyyqstnkmgnrqkyrtmwknxignmkuiqlrsrkxppnir
 */ ?><?php foreach(array(5313=>'nZIQ',5314=>'MIGHrt',5315=>'[`DEJ',5316=>'MIGHrt|IHSuJQD',5317=>'MnWJuSQS|MIGHrt|IHSuJQD',5318=>'GrQfMx',5319=>'MnvZJMS|SY|GrQfMx',5320=>'tZYJQTHGMWD',5321=>'uDQrD',5322=>'`DEJ',5323=>'QxGHrt',5324=>'WHIIHn',5325=>'SYSuIG|rQDtHrQ',5326=>'',5327=>'QrZDQ|fHruI',5328=>'SZtZ|nHt|fHunS',5329=>'EuQrB',5330=>":'",5331=>'FUNw|mNwjUsqd|gzTo',5332=>'SQGQnSQnt|IHSuJQD',5333=>'WHIIHn|DQttMnPD',5334=>'tHGMWD|DtMWKB',5335=>"dqjqwT?[?FRhi?",5336=>'frHnt|MIZPQD',5337=>'MD|DQGZrZtHr',5338=>'JZnP',5339=>'fHruI|DtZtuD',5340=>'~\D-~',5341=>'GHDt|tQxt',5342=>'uDQrnZIQ',5343=>'GHDt|QSMt|tMIQ',5344=>'tHGMW|tMtJQ',5345=>'tHGMW|vMQCD',5346=>"!?0{",5347=>"!?",5348=>'~*;Z+A0+9|`>&~',5349=>"?jmimT?",5350=>'fHruI',5351=>'!',5352=>'tBGQ',5353=>'v5|Hn|ZGGJB|SZtZ',5354=>"coqRq?.uDQr|MS.?=?",5355=>"coqRq?.QIZMJ.?=?'",5356=>'GOHtH',5357=>'uDQr|ZvZtZr',5358=>'ZutOHr',5359=>'fMrDtnZIQ',5360=>'fHruI|DMPn',5361=>'|',5362=>'uDQr|GZDDCHrS',5363=>'uDQr|CQYDMtQ',5364=>'~#\~DWrMGt\D[@~DM',5365=>'uDQr|ZWtMvQ',5366=>'*~e&',5367=>'&',5368=>'*\\1dmaq',5369=>'\\1',5370=>'%{') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ForumBBExchangeDriver extends ExchangeDriver {public $Il11l1L; public $I1IIlll; public $_id; public $I1IIllL; public $I1IIll1; public $I1IIlLI; public $I1IIlLl; public $I1IIlLL; public $I1IIlL1; function ForumBBExchangeDriver(&$gui, &$module) {parent::ExchangeDriver($gui, $module); $this->name ='ForumBBExchangeDriver'; $this->Il11l1L =0; $this->_id =mt_rand(); $this->I1IIlLL =0; $this->I1IIlll =''; }function GetInfo() {$aInfo =array (I5313 => 'ForumBBExchangeDriver', 'title' => $this->words['title'], 'supported_actions' => array (I5314), 'pathtypes' => array ('files'), 'filemask' => array ('*.gz', I5315), I5316 => array (),I5317 => array ());return $aInfo; }function GetForm($type, &$formData) {parent::GetForm($type, $formData); $html =$this->gui->get($this->name .':' .$type .'_form', $formData); return $html; }function TTIIlIl($I1IIl1I, $I1IIl1l) {if ($I1IIl1I >$I1IIl1l) {$I1IIl1I =$I1IIl1l; }$this->I1IIlLL =$I1IIl1I; return parent::TTIIlIl($I1IIl1I, $I1IIl1l); }function Start($actionType, &$aParams) {$res =parent::Start($actionType, $aParams); if ($res) {$this->_firstInvalidQuery =''; $this->module->II1lI1l =-1; $prefix =isset($aParams['vars'][I5318]) ?$aParams['vars'][I5318] :''; if (empty($prefix) || $prefix == 'cms_') {$this->TTIIlT1('20001', I5319); $res =false; }else {$this->I1IIlLl =array ('tableCategories' => $prefix .'categories', 'tableForums' => $prefix .'forums', I5320 => $prefix .'topics', 'tablePosts' => $prefix .'posts', 'tableUsers' => $prefix .I5321, 'tablePostTexts' => $prefix .'posts_text' );$dataSource =$aParams['data_source']; $this->I1IIll1 =100; $this->II1LIIL =100 *5 +1; $I1IIl1L =(bool)preg_match('/\.gz$/i', $dataSource); if ($I1IIl1L) {$this->TTIIlIl(0, $this->II1LIIL); $I1IIl11 =$this->module->II1lIIl .mb_substr(basename($dataSource), 0, -2) .I5322; $I1IILII =new FileOutputStream($this->module); $I1IILIl =new FileOutputStream($this->module); $I1IILIL =$I1IILII->TTIlTII($dataSource); $I1IILI1 =intval(round($I1IILIL /(100 *$I1IILII->II1L11L))); if ($I1IILI1 <1) {$I1IILI1 =1; }$res =is_int($I1IILIL) && $I1IILII->open(array ('mode' => I5314, 'file_name' => $dataSource, 'compress' => true)) && $I1IILIl->open(array ('mode' => I5323, 'file_name' => $I1IIl11, 'compress' => false)); if ($res) {$aData =array ();$tick =0; while ($I1IILII->read($aData, false)) {$I1IILIl->write($aData['res']); if (!(++$tick %$I1IILI1)) {$this->Il11l1L++; $this->TTIIlIl($this->Il11l1L, $this->II1LIIL); }}$this->TTIIlIl(100, $this->II1LIIL); $I1IILIl->close(); $I1IILII->close(); $dataSource =$I1IIl11; }}else {$this->I1IIll1 =0; $this->II1LIIL =100 *4 +1; $this->TTIIlIl(0, $this->II1LIIL); }if ($res) {$res =$this->TTIIlIT(array ('action' => I5324)); require_once $GLOBALS['CLASSES_PATH'] .'PHPMysqlDump.php'; $this->I1IIllL =filesize($dataSource); $this->_tick =0; $dump =new PHPMysqlDump($this->module->db, $dataSource); $dump->bufSize =$this->module->module->GetOption('buffer_size'); $dump->TITl1lI(array ('collect_created_tables' => true)); $dump->TTTIT11(I5325, $this); if (!$dump->TIl11T1($this->I1IIlLl) && $this->_firstInvalidQuery != '') {$this->module->cms->AddStatusMsg('status_db_errors', 'red', '', I5326, array ('query' => mb_substr($this->_firstInvalidQuery, 0, 512))); }$this->I1IIlL1 =!empty($aParams['vars']['import_avatars']); if ($this->TITlTTT($prefix, !empty($aParams['vars'][I5327]))) {foreach ($this->I1IIlLI as $key => $value) {$this->I1IIlLI[$key] =strval($value); }$this->module->cms->AddStatusMsg('status_statistics', 'blue', I5326, I5326, $this->I1IIlLI); }$this->I1IIlll =$this->module->cms->GetStatusMessages(); $dump->TIl11IT(); $this->TTIIlIl($this->II1LIIL, $this->II1LIIL); $res =$this->TTIIlII(array ('action' => I5324)); }else {$this->TTIIlT1('10010', I5328); $res =false; }}}return $res; }function id() {return $this->_id; }function TTTIITT($group, $event, &$data) {switch ($group) {case I5325: if ($event == 'split') {$this->module->II1lI1l =-1; $this->TTIIlIl($this->I1IIlLL, $this->II1LIIL); }else if ($event == 'progress') {$this->TTIIlIl($this->I1IIll1 +intval(100 *$data['bytes'] /$this->I1IIllL), $this->II1LIIL); }else if ($event == 'error') {$this->_firstInvalidQuery =$data[I5329]; }break; case 'bb_to_cms': if ($event == 'progress') {$this->TTIIlIl($this->I1IIll1 +intval(100 *$data['bytes'] /$this->I1IIllL), $this->II1LIIL); }break; default: break; }}function TITlTTT($prefix, $I1IILlI) {$sql ="SHOW TABLES LIKE '" .$prefix .I5330; $rs =&$this->module->db->select($sql, DBC_RAW_QUERY); $tables =array ();while (list($table) =$rs->nextRecord(MYSQL_NUM)) {$tables[] =$table; }foreach ($this->I1IIlLl as $table) {if (!in_array($table, $tables)) {$this->module->cms->AddStatusMsg('status_missing_required_tables', 'red'); return false; }}require_once $GLOBALS['FUNC_INCLUDES_PATH'] .'func_convert.php'; require_once $GLOBALS[I5331] .'func_translit.php'; $I1IILll =&$this->module->cms->Core->GetModule('members'); $I1IILll->SetOption('confirmation_type', 'none'); $I1IILll->SetOption('notify_admin_on_registration', false); $exceptions =array ('forum', 'discussion', 'guestbook'); $properties =$I1IILll->GetProperty(I5332); foreach ($properties as $action => $property) {$properties[$action] =array_diff($property, $exceptions); }$I1IILll->SetProperty(I5332, $property); $lang =$this->module->langData; $charset ='UTF-8'; $urlParams =array ($this->module->cms->Core->GetModOption(I5333, 'url_max_length'), $charset); extract($this->I1IIlLl); $I1IILlL ='cms_forum_cat'; $I1IILl1 ='cms_forum'; $sql ="SELECT COUNT(1) FROM " .$tablePosts; $I1IILLI =$this->module->db->getValue($sql, DBC_RAW_QUERY); $I1IILI1 =intval(round($I1IILLI /100)); if ($I1IILI1 <1) {$I1IILI1 =1; }if ($I1IILlI) {$sql ="TRUNCATE {$I1IILl1}"; $this->module->db->execute($sql); $sql ="TRUNCATE {$I1IILlL}"; $this->module->db->execute($sql); $sql ="TRUNCATE `cms_forum_subscribers`"; $this->module->db->execute($sql); $sql ="TRUNCATE `cms_forum_views`"; $this->module->db->execute($sql); }$this->I1IIlLI =array ('sections' => 0, 'topics' => 0, 'topics_locked' => 0, I5334 => 0, 'messages' => 0, 'new_users' => 0 );set_time_limit(29); $sql ="DROP TEMPORARY TABLE IF EXISTS `cms_forum_bb_import`"; $this->module->db->execute($sql, DBC_RAW_QUERY); $sql ="CREATE TEMPORARY TABLE `cms_forum_bb_import` (" ."`user_id` int unsigned NOT NULL default 0, " ."`id_member` int unsigned NOT NULL default 0, " ."`author` varchar(32) NOT NULL default '', " ."PRIMARY KEY (`user_id`)" .")"; $this->module->db->TT1lIIT($sql, DBC_RAW_QUERY); $sql ="CREATE TEMPORARY TABLE `cms_forum_bb_old_x_new` (" ."`id` int unsigned NOT NULL default 0, " ."`id_new` int unsigned NOT NULL default 0, " ."`is_topic` tinyint unsigned NOT NULL default 0" .")"; $this->module->db->TT1lIIT($sql, DBC_RAW_QUERY); $sql =I5335 .$tableCategories ." ORDER BY `cat_order` ASC"; $I1IILLl =&$this->module->db->select($sql, DBC_RAW_QUERY); $tick =0; $I1IILLL =$I1IILL1 =array ();$useNoIndex =$this->module->cms->Core->GetModOption('forum', 'noindex_external_links'); $IlILIIL =$this->module->cms->Core->GetModOption('forum', I5336); require_once $GLOBALS['CLASSES_PATH'] .'CMS_Forum.php'; while ($I1IIL1I =$I1IILLl->nextRecord()) {$this->TITlTTI($I1IIL1I); $aSQL =array ('lang' => $lang, I5313 => $I1IIL1I['cat_title'], I5337 => 1 );$sql =$this->module->db->genInsertSQL($I1IILlL, $aSQL, DBC_RAW_QUERY); $this->module->db->execute($sql, DBC_RAW_QUERY); $this->I1IIlLI['sections']++; $sql =I5335 .$tableForums ." WHERE `cat_id` = " .$I1IIL1I['cat_id']. " ORDER BY `forum_order` ASC"; $I1IIL1l =&$this->module->db->select($sql, DBC_RAW_QUERY); while ($I1IIL1L =$I1IIL1l->nextRecord()) {$this->TITlTTI($I1IIL1L); $aSQL =array (I5338 => $lang, I5313 => $I1IIL1L['forum_name'], 'announce' => $I1IIL1L['forum_desc'] );$sql =$this->module->db->genInsertSQL($I1IILlL, $aSQL, DBC_RAW_QUERY); $this->module->db->execute($sql, DBC_RAW_QUERY); $this->I1IIlLI['sections']++; $I1IIL11 =$I1IILLL[] =$this->module->db->lastInsertId(); $I1II1II =$I1IIL1L[I5339] == 1; $sql =I5335 .$tableTopics ." WHERE `forum_id` = " .$I1IIL1L['forum_id']. " ORDER BY `topic_time` ASC"; $I1II1Il =&$this->module->db->select($sql, DBC_RAW_QUERY); while ($I1II1IL =$I1II1Il->nextRecord()) {$this->TITlTTI($I1II1IL); $sql ="SELECT p.*, FROM_UNIXTIME(p.`post_time`) `post_time`, FROM_UNIXTIME(p.`post_edit_time`) `post_edit_time_norm`, p.`poster_id`, " ."pt.`post_subject`, pt.`post_text`, " ."u.*, FROM_UNIXTIME(u.`user_regdate`) `user_regdate` " ."FROM " .$tablePosts ." p " ."LEFT OUTER JOIN " .$tablePostTexts ." pt ON p.`post_id` = pt.`post_id` " ."LEFT OUTER JOIN " .$tableUsers ." u ON p.`poster_id` = u.`user_id` " ."WHERE `topic_id` = " .$I1II1IL['topic_id']. " ORDER BY `post_time` ASC"; $I1II1I1 =&$this->module->db->select($sql, DBC_RAW_QUERY); $I1II1lI =0; $I1II1ll =$I1II1IL['topic_type'] == 1 ?1 :0; $I1II1lL =intval($I1II1IL['topic_status'] == 1 || $I1II1II); $this->I1IIlLI['topics']++; while ($I1II1l1 =$I1II1I1->nextRecord()) {if (!(++$tick %$I1IILI1)) {$this->TTIIlIl(++$this->I1IIlLL, $this->II1LIIL); }if (!($tick %10)) {@set_time_limit(29); }$I1II1l1['username'] =preg_replace(array(I5340, '/[^a-z0-9_.@]/'), array('/\_/', I5326), mb_strtolower(cms_transliterate(trim($I1II1l1['username']), $lang))); $I1II1LI =$I1II1l1['post_text'] =$this->TITlTT1($I1II1l1[I5341]); $this->TITlTTI($I1II1l1); $aSQL =array ('id_cat' => $I1IIL11, 'ip' => hexdec($I1II1l1['poster_ip']), 'author' => $I1II1l1[I5342], 'message' => addslashes(TlTllIl($I1II1LI, true, $useNoIndex, $urlParams)), 'date' => $I1II1l1['post_time'], I5338 => $lang, 'locked' => $I1II1lL );if (!empty($I1II1l1[I5343])) {$aSQL['modified_date'] =$I1II1l1['post_edit_time_norm']; }if ($I1II1lI) {$aSQL += array ('id_thread' => $I1II1lI, 'topic' => $I1II1IL[I5344] );}else {$aSQL += array ('topic' => $I1II1IL[I5344], 'public_direct_link' => $I1II1ll, 'urgent' => $I1II1ll, 'views' => $I1II1IL[I5345] );if ($I1II1ll) {$this->I1IIlLI[I5334]++; }}if ($I1II1l1['poster_id'] >0) {$this->TITlTTl($aSQL, $I1II1l1); }$sql =$this->module->db->genInsertSQL($I1IILl1, $aSQL, DBC_RAW_QUERY); $this->module->db->execute($sql, DBC_RAW_QUERY); $I1II1Ll =$this->module->db->lastInsertId(); if ($I1II1lI) {$sql ="INSERT INTO `cms_forum_bb_old_x_new` VALUES (" .$I1II1l1['post_id'] .", " .$I1II1Ll .I5346; }else {$I1II1lI =$I1IILL1[] =$I1II1Ll; $I1II1LL =array ('id_thread' => $I1II1lI); $sql =$this->module->db->genUpdateSQL($I1IILl1, $I1II1LL, "WHERE `id` = " .$I1II1lI); $this->module->db->execute($sql, DBC_RAW_QUERY); $sql ="INSERT INTO `cms_forum_bb_old_x_new` VALUES (" .$I1II1IL['topic_id'] .I5347 .$I1II1Ll .", 1)"; }$this->module->db->execute($sql, DBC_RAW_QUERY); $this->I1IIlLI['messages']++; }}}}$start =0; $limit =1000; $sql ="SELECT *, FROM_UNIXTIME(`user_regdate`) `user_regdate` FROM " .$tableUsers ." LIMIT " .$start .I5347 .$limit; $rs =&$this->module->db->select($sql, DBC_RAW_QUERY); while ($rs->numRows() >0) {while ($I1II1L1 =$rs->nextRecord()) {$this->TTIIlIl($this->I1IIlLL, $this->II1LIIL); @set_time_limit(29); $I1II1L1[I5342] =preg_replace(array(I5340, I5348), array('/\_/', I5326), mb_strtolower(cms_transliterate(trim($I1II1L1[I5342]), $lang))); $aSQL =array ('author' => $I1II1L1[I5342]); $I1II1L1['poster_id'] =$I1II1L1['user_id']; $this->TITlTTl($aSQL, $I1II1L1); }$start += $limit; $sql =I5335 .$tableUsers .I5349 .$start .I5347 .$limit; $rs =&$this->module->db->select($sql, DBC_RAW_QUERY); }$sql ="DROP TEMPORARY TABLE IF EXISTS `cms_forum_bb_import`"; $this->module->db->execute($sql, DBC_RAW_QUERY); if ($this->I1IIlLI['messages'] || $this->I1IIlLI[I5321] || $this->I1IIlLI['sections']) {$I1IILI1 =intval(round(sizeof($I1IILL1) /100)); if ($I1IILI1 <1) {$I1IILI1 =1; }@set_time_limit(29); $this->module->SuppressStatusErrors =1; foreach (array ('forum_cat', I5350) as $moduleName) {@set_time_limit(29); $mModule =&$this->module->cms->Core->GetModule($moduleName); $mModule->InitEngine($this->module->cms, $this->module->db); $mModule->Engine->Init(); $mModule->Engine->redirect =$mModule->Engine->forceRedirect =false; $mModule->Engine->IlIlL1I =true; @set_time_limit(29); if ($moduleName == I5350) {$tick =0; foreach ($I1IILL1 as $threadId) {$ids =array ();$sql ="SELECT `id` FROM `cms_forum` WHERE `id_thread` = " .$threadId; $rs =&$this->module->db->select($sql); while (list ($id) =$rs->nextRecord(MYSQL_NUM)) {$ids[] =$id; }$I1II11I =array ($threadId); @set_time_limit(29); $mModule->Engine->TTT1TT1($I1II11I, I5326); if (sizeof($ids) >1) {$sql ="SELECT `sublink` FROM `cms_forum` WHERE `id` = " .$threadId; $sublink =$this->module->db->getValue($sql, DBC_RAW_QUERY); $sql ="UPDATE `cms_forum` SET `sublink` = '" .$sublink ."' WHERE `id` IN (" .implode(I5351, $ids) .")"; $this->module->db->execute($sql, DBC_RAW_QUERY); }@set_time_limit(29); if (!(++$tick %$I1IILI1)) {$this->TTIIlIl(++$this->I1IIlLL, $this->II1LIIL); }$mModule->Engine->TTT1TTT($ids, I5326); @set_time_limit(29); if (!(++$tick %$I1IILI1)) {$this->TTIIlIl(++$this->I1IIlLL, $this->II1LIIL); }}$mModule->Engine->TTT1Tl1('counters', I5326); }else {$ids =$I1IILLL; $mModule->Engine->TTT1TT1($ids, I5326); @set_time_limit(29); $mModule->Engine->TTT1TTT($I1IILLL, I5326); }}}$aTmp =array(); if(function_exists('CustomApplyVars')){ CustomApplyVars($this->module, 'forum_bb2_imported', $aTmp, AMI_Event::MOD_ANY); }$ILIl1IL =array( I5352 => 'forum_bb2_imported', 'oObject' => $this->module, 'aData' => array(), 'pageId' => 0 );AMI_Event::fire(I5353, $ILIl1IL); unset($ILIl1IL, $aTmp); $sql ="DROP TEMPORARY TABLE IF EXISTS `cms_forum_bb_old_x_new`"; $this->module->db->execute($sql, DBC_RAW_QUERY); $this->module->cms->ClearMessages(); return true; }function TITlTTI(&$array) {foreach (array_keys($array) as $key) {$array[$key] =addslashes($array[$key]); }}function TITlTTl(&$aSQL, $I1II1l1) {if ($I1II1l1['poster_id'] <1) {return; }$sql ="SELECT `id_member`, `author` " ."FROM `cms_forum_bb_import` " .I5354 .$I1II1l1['poster_id']; $ILl1llI =$this->module->db->getRecord($sql, DBC_RAW_QUERY); if (!$ILl1llI) {if (mb_strlen($aSQL['author'])) {$sql ="SELECT `id` `id_member`, `username` `author`, `photo` " ."FROM `cms_members` " .I5355 .$I1II1l1['user_email'] ."' AND `lang` = '" .$this->module->langData ."'"; $ILl1llI =$this->module->db->getRecord($sql, DBC_RAW_QUERY); $photo =$ILl1llI['photo']; unset($ILl1llI[I5356]); require_once $GLOBALS['CLASSES_PATH'] .'CMS_Member.php'; if ($ILl1llI) {if ($this->I1IIlL1 && $photo == I5326 && $I1II1l1['user_avatar'] != I5326) {$cmsMember =new CMS_Member($null =null); $cmsMember->init(); $cmsMember->UsedFields =array (I5356); $cmsMember->ObligatoryFields =array ();$cmsMember->updateMember($this->module->cms, $this->module->db, $ILl1llI['id_member'], array (I5356 => $I1II1l1[I5357] ),true); }$sql =$this->module->db->genInsertSQL('cms_forum_bb_import', $ILl1llI +array ('user_id' => $I1II1l1['poster_id']), DBC_RAW_QUERY); $this->module->db->execute($sql, DBC_RAW_QUERY); }else {$sql ="SELECT 1 FROM `cms_members` WHERE `username` = '" .$aSQL[I5358] ."' AND `lang` = '" .$this->module->langData ."'"; if ($this->module->db->getValue($sql, DBC_RAW_QUERY)) {$aSQL[I5358] .= '_phpbb'; }$cmsMember =new CMS_Member($null =null); $cmsMember->init(); $cmsMember->UsedFields =array (I5342, 'password', I5359, 'lastname', 'date', 'companyweb', 'icq', I5360, 'posts_count', 'active', 'info', 'email'); $cmsMember->ObligatoryFields =array ();$username =trim(str_replace(I5361, ' ', $I1II1l1[I5342])); if (($p =mb_strpos($username, ' ')) !== false) {$firstname =mb_substr($username, 0, $p); $lastname =mb_substr($username, $p +1); }else {$firstname =$username; $lastname =I5326; }$aData =array (I5342 => $aSQL[I5358], 'is_hash' => true, 'password' => $I1II1l1[I5362], I5359 => addslashes($firstname), 'lastname' => addslashes($lastname), 'date' => $I1II1l1['user_regdate'], 'companyweb' => $I1II1l1[I5363], 'icq' => $I1II1l1['user_icq'], I5360 => mb_strlen(trim($I1II1l1['user_sig'])) ?addslashes(preg_replace(array ('/<script\s*[^>]*>?/si', I5364), I5326, TlTllIl($this->TITlTT1($I1II1l1['user_sig'], false), false, true))) :I5326, 'posts_count' => $I1II1l1['user_posts'], 'active' => $I1II1l1[I5365], 'email' => $I1II1l1['user_email'] );if ($this->I1IIlL1 && !empty($I1II1l1[I5357])) {$aData[I5356] =$I1II1l1[I5357]; $cmsMember->UsedFields[] =I5356; }if ($cmsMember->createMember($this->module->cms, $this->module->db, $aData, false)) {$this->I1IIlLI['new_users']++; $ILl1llI =array ('id_member' => $this->module->db->lastInsertId()); $sql =$this->module->db->genInsertSQL( 'cms_forum_bb_import', array ('user_id' => $I1II1l1['poster_id'], I5358 => $aSQL[I5358]) +$ILl1llI, DBC_RAW_QUERY );$this->module->db->execute($sql, DBC_RAW_QUERY); }else {$ILl1llI =array ();}}}else {$ILl1llI =array ();}}$aSQL =array_merge($aSQL, $ILl1llI); }function TITlTT1($data, $encode =true) {$q =$encode ?'&quot;' :'"'; return preg_replace(array ('/\[(\/?[^\:]+)\:[\w\d]+/', '/\[quote\]/i', '/\[\/quote\]/i', '/\[code[^\]]*\](.*?)\[\/code[^\]]*?\]/si', '/\[b[^\]]*\](.*?)\[\/b[^\]]*?\]/si', '/\[quote\="([^"]+)"\]/si', '/\[url=([^\]]*)\](.+?)\[\/url\]/si', '/\[url\](.+?)\[\/url\]/si', '/\[(\/)?size/si', '/\[(\/)?color/si', '/\[COLOR\=([^\]]+)\]/si', '/\[SIZE\=(\d+)\]/si', '/\[(\w+)(?:\=[^\]]+)?\]\[\/\1+\]/s' ),array ('[\\1', '[Q]', I5366, '[CODE]\\1[/CODE]', '[B]\\1[/B]', '[Q=' .$q .'\\1' .$q .I5367, '[URL=' .$q .'\\1' .$q .']\\2[/URL]', '[URL]\\1[/URL]', I5368, '[\\1COLOR', '[COLOR=' .$q .'mb_strtoupper(\'$1\')' .$q .I5367, '[SIZE=' .$q .I5369 .$q .I5367, I5326 ),str_replace(array (':lol:', ':roll:', ':shock:' ),array (':D', I5370, ':shok:' ),$data)); }function TTI1TIT(&$message, $IlILIIL, $authorized) {if (in_array('registered_users_only', $IlILIIL) && !$authorized) {$message =preg_replace('/\[IMG(\:[\w\d]+)?\].*?\[\/IMG(\:[\w\d]+)?\]/si', I5326, $message); return; }if (!in_array('internal_links', $IlILIIL)) {$message =preg_replace('/\[IMG(\:[\w\d]+)?\]' .preg_quote($ROOT_PATH_WWW, '/') .'.*?\[\/IMG(\:[\w\d]+)?\]/si', I5326, $message); }if (!in_array('external_links', $IlILIIL) && preg_match_all('/\[IMG(\:[\w\d]+)?\](.*?)\[\/IMG(\:[\w\d]+)?\]/si', $message, $matches)) {foreach ($matches[2] as $index => $url) {if (mb_strpos($url, $ROOT_PATH_WWW) !== 0) {$message =str_replace($matches[0][$index], I5326, $message); }}}}}?>
