<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       20448 xkqwrzxtsuqytgmgtkkplxxmgnnwuygxxilrnmgyuwtulyqlzxtyrnlrkmgkwugpuuzgpnir
 */ ?><?php foreach(array(5371=>"Qn",5372=>"",5373=>"I~S~b",5374=>"ZIM|WuDtHI`WDD",5375=>"GJuPMnD`WDD",5376=>'frn',5377=>'JZnP',5378=>"DY|SZtZ",5379=>'WZtMS',5380=>'',5381=>'}',5382=>"IHS",5383=>"!?JMnK|ZJMZD",5384=>'DGQW|IHSuJQ|YHSB',5385=>'IHS|MS|GZPQD',5386=>"?zNs?MS|GZPQ?mN?}",5387=>"IuJtM|DMtQ",5388=>"?COQrQ?",5389=>"JMnK|ZJMZD",5390=>'~',5391=>'IHS',5392=>"MS",5393=>"DuYJMnK",5394=>'GZtO') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class Front extends CMS_Base{ public $Pager; public $IIIlLLl; public $ActivePage; public $IILlIlI; public $ActiveScript; public $I1II11l; public $StatusMsgs; public $I1II11L; public $I1II111; public $Messages; public $IIIlLLL; public $IIIlLL1; public $DFMT; public $Gui; public $Member; public $Eshop; public $PageId; public $ILI1ILl; public $Ill1lIl; public $I1IlIII; public $I1IlIIl; public $I1IlIIL; public $I1IlII1; public $ActiveScriptNavLink; public $IILlllI; public $I1IlIlI; function Front(&$Core, $IIIl1Il ="", $IILllll =false) {parent::CMS_Base($Core, $IIIl1Il, $IILllll); $this->lang ="en"; $this->lang_data =I5371; $this->IIIlLLl ="SoftImpression"; $this->Side ="front"; $this->ActivePage =""; $this->IILlIlI =""; $this->ActiveScript =I5372; $this->I1II111 =array(); $this->I1II11l =".php"; $this->StatusMsgs =Array(); $this->I1II11L =Array(); $this->Messages =Array(); $this->DFMT =Array( "conf" => "MM/DD/YYYY", "php" => I5373, "db" => "%m/%d/%Y" );$this->Member =I5372; $this->Eshop =I5372; $this->PageId =0; $this->ILI1ILl =I5372; $this->Ill1lIl =I5372; $this->Gui->CSSPath =$GLOBALS["CSS_FILES_PATH_HTTP"]; $this->Gui->addStyle("common.css"); $this->Gui->addStyle(I5374); if($this->Core->issetModOption('pages', 'plugins_css_stamp') && ($I1IlIll =$this->Core->GetModOption('pages', 'plugins_css_stamp')) >0){ $this->Gui->addStyle(I5375, array('_ts' => $I1IlIll)); }$this->_systemIncJSCnt(); $this->I1IlIII =Array(); $this->I1IlIIl =Array(); $this->I1IlIIL =false; $this->I1IlII1 =Array(); $this->ActiveScriptNavLink =I5372; $this->I1IlIlI =array(); }function _systemIncJSCnt($postfix =''){ if(defined('RUN_UPDATE') && RUN_UPDATE){ return; }static $counter =1; if(AMI_Registry::get('side', I5376) !== 'adm'){ $this->Gui->delScript(); }$oItem =AMI::getResourceModel('locales/table')->findByFields(array('lang' => $this->lang)); if(!$oItem->jquery_cdn){ $oItem =AMI::getResourceModel('locales/table')->findByFields(array(I5377 => 'en')); }if($oItem->jquery_cdn){ $this->Gui->addScript($oItem->jquery_cdn); }$counter++; }function TITlTIT(&$arr, $prefix=I5372) {if(is_array($arr)) {foreach ($arr as $key => $value) {if($value == I5372) {$this->Gui->addGlobalVars(array($prefix."_".$key."_is_empty" => "1")); }}}}function TITlTII($cBlockName) {foreach($this->I1IlII1 as $modName => $tmp) {$this->Core->TTlTlI1($modName, "multi_block_options", true, true); }if(isset($this->ActivePageInfo["sb_data"][$cBlockName])) {foreach($this->ActivePageInfo["sb_data"][$cBlockName] as $modName => $aModOptions) {if($this->Core->IsInstalled($modName)) {$this->Core->TTlTlIl($modName, "multi_block_options"); $this->I1IlII1[$modName] =1; $this->Core->TTlIl11($modName, $aModOptions); }}}}function TITlTIl($cBlockName){ $res =array(); if(!empty($this->ActivePageInfo["sb_data"][$cBlockName])){ $res =$this->ActivePageInfo[I5378][$cBlockName]; }return $res; }function SpecBlockFound($cBlockName){ return (in_array($cBlockName, $this->I1II11L)); }function TITlTI1($cBlockName){ return in_array($cBlockName, $this->I1II11L); }function TITlTlT($cBlockName){ $res =false; if(isset($this->I1II111[$cBlockName])){ $res =$this->I1II111[$cBlockName]; }return $res; }function SetPageId($Ill11lL) {$this->PageId =$Ill11lL; $this->Core->Cache->SetPageId($Ill11lL); }function GetPageId() {return $this->PageId; }function SetPageModule($cModule) {$this->ILI1ILl =$cModule; $this->Core->Cache->SetPageModule($cModule); }function TITlTlI() {return $this->ILI1ILl; }function SetFrontLink($I1IlIlL) {$this->Ill1lIl =$I1IlIlL; }function GetFrontLink() {return $this->Ill1lIl; }function setLang($lang){ parent::setLang($lang); $this->lang_data =$lang; }function SetupStopArgs($IIIL1LL, $I1IlIl1, $pageId, $I1IlILI =I5372, $activeModule =I5372){ $this->I1IlIII =Array(); $this->IILlI1l =false; $this->I1IlIIl =Array(); $I1IlILl =Array(); $vMod =&$this->Core->GetModule($IIIL1LL); $I1IlILL =$vMod->getProperty("stop_use_sublinks"); if($I1IlILL) {$aNames =$vMod->getAOption("stop_arg_names"); if($vMod->issetOption('use_categories') && !$vMod->getOption('use_categories') && !empty($aNames[I5379])) {unset($aNames[I5379]); }$aFilters =Array(); $I1IlIL1 =Array(); if($vMod->issetProperty("stop_arg_filters")) {$aFilters =$vMod->getProperty("stop_arg_filters"); }$I1IlI1I =sizeof($aNames); $I1IlI1l =$I1IlI1I == 1; $i =0; $IIILlL1 =$I1IlIl1; $I1IlI1L =0; $isMultiPageAllowed =$this->Core->issetAndTrueOption("multi_page_allowed"); foreach($aNames as $I1IlI11=>$vModName){ $I1IlI1L++; $IIILlL1 =ltrim($IIILlL1, '/ '); if($IIILlL1 === I5380){ break; }$I1IllII ="0 "; $I1IllIl =I5372; $vVal =I5372; $I1IllIL =$IIILlL1; if(mb_strpos($IIILlL1, "/")!==false){ $I1IllIL =TlT1IIl($IIILlL1, $I1IllII, "sublink", "0", I5372); $I1IllIl ="order by length(sublink) desc, id asc limit 1"; }else{ $I1IllII ="sublink='".$IIILlL1."'"; if($this->Core->GetModOption('common_settings', 'slash_reaction') == 301){ $I1IllII =I5381 .$I1IllII ." OR sublink='" .$IIILlL1 ."/')"; }$I1IllIl ="ORDER BY id ASC LIMIT 1"; }$vVal =$I1IllIL; $aTmp =Array("id"=>intval($vVal), I5382=>$vModName); if($I1IlILL && $IIILlL1 != I5372){ if($vModName!=$IIIL1LL){ $I1IllI1 =&$this->Core->GetModule($vModName); }else{ $I1IllI1 =&$vMod; }if(empty($db)){ $db =new DB_si; }$aAdditionalParams =Array("check_links_conflict" => 1); $I1IllI1->TTlT1I1("page_id", $pageId); $vKey =$I1IllI1->TTlT1lI(); $ILlllIl =$I1IllI1->GetTableName($aAdditionalParams); $I1IlllI =I5372; if($this->I1IlIIL){ $I1IllII .= " link_alias='".$IIILlL1."'"; $I1IlllI =I5383; }$sql ="select ".$vKey.", sublink".$I1IlllI; $I1Illll =$I1IllI1->GetName(); if($activeModule == $I1Illll) {$sql .= $I1IlILI; }$I1IlllL =I5372; if(($I1IlI1l || $I1IlI1L == 1) && $isMultiPageAllowed && $vMod->issetAndTrueOption("multi_page") && $pageId >0) {if($vMod->issetOption('mod_id_pages')){ $I1Illl1 ="SELECT `sb_data` FROM `cms_pages` WHERE `id` = " .((int)$pageId); $this->ActivePageInfo['sb_data'] =@unserialize($db->getValue($I1Illl1)); if(is_array($this->ActivePageInfo['sb_data']) && isset($this->ActivePageInfo['sb_data'][I5384][$vModName]['mod_id_pages'])){ $this->TTITT1l($vModName); $this->TITlTII(I5384); $IIlLLLl =$vMod->GetAOption(I5385); if(in_array(-1, $IIlLLLl)){ $IIlLLLl =array(); }if(sizeof($IIlLLLl)){ if(($index =array_search(-2, $IIlLLLl)) !== false){ $IIlLLLl[$index] =$pageId; $IIlLLLl =array_unique($IIlLLLl); }$I1IlllL .= " AND (" ."id_page IN (" .implode(',', $IIlLLLl) .")) "; }}}else{ $I1IlllL =I5386 .((int)$pageId) .",0)"; }}$I1IllLI =I5372; if(isset($aFilters[$vModName]) && $aFilters[$vModName] != I5380) {$I1IllLl =strtr($aFilters[$vModName], $I1IlIL1); if(mb_strpos($I1IllLl, "%") === false) {$I1IllLI =" AND ".$I1IllLl; }}$I1IllLL =I5372; if($this->Core->IsInstalled("srv_multi_sites") && $vMod->issetAndTrueOption(I5387)) {$idSite =intval($this->Core->GetModOption("srv_multi_sites", "id")); if($idSite >0) {$I1IllLL =" AND id_site=".$idSite; }}$sql .= " from ".$ILlllIl.I5388; $sql .= $I1IllII; $sql .= $I1IllLI.$I1IlllL." and lang='".$this->lang_data."' ". $I1IllIl; $db->query($sql); $this->I1IlIIl[$vModName] =-1; if($db->nextRecord()){ $vVal =$db->Record[$vKey]; $this->IILlI1l =true; $this->I1IlIIl[$vModName] =$vVal; $aTmp["sublink"] =$db->Record["sublink"]; if($this->I1IlIIL && $IIILlL1==$db->Record[I5389]){ $aTmp["sublink"] =$db->Record[I5389]; }if($aTmp["sublink"]!=I5372){ $I1IllIL =$aTmp["sublink"]; }$found =rtrim($IIILlL1, '/') == rtrim($I1IllIL, I5390); if(($found || ($I1IlI1L == $I1IlI1I)) && $IIILlL1 != $I1IllIL) {if($found){ if($activeModule == I5380 && $this->Core->GetModOption('common_settings', 'slash_reaction') == 301){ echo ' '; $url =$this->fixURLSlash(); $this->Core->Cache->pageIsComplitedForSave =true; doRedirect301($url, $this->Core->Cache); }else{ $found =false; }}if(!$found){ $this->I1IlIII[$I1IlI11] =array('id' => -1, I5391 => $vModName); $vVal =-1; $_GET[$I1IlI11] =$vVal; break; }}$aTmp["id"] =$vVal; if($activeModule == $I1Illll) {$I1IlILl["_additional_info"] =$db->Record; }}else{ if($I1IllIL!="0" && $I1IllIL!="-"){ $this->I1IlIII[$I1IlI11] =Array(I5392=>-1, I5382=>$vModName); $vVal =-1; }else{ $this->I1IlIII[$I1IlI11] =Array(I5392=>-2, I5382=>$vModName); $vVal =-2; }$_GET[$I1IlI11] =$vVal; $IIILlL1 =mb_substr($IIILlL1, mb_strlen($I1IllIL)); continue; }}$I1IlIL1["%".$I1IlI11] =$vVal; $_GET[$I1IlI11] =$vVal; $this->I1IlIII[$I1IlI11] =$aTmp; $IIILlL1 =mb_substr($IIILlL1, mb_strlen($I1IllIL)); $i++; }$aTmp =$I1IlILl +$this->I1IlIII; }$this->I1IlIlI =$this->I1IlIII; AMI_Registry::set('nav_data', $this->I1IlIlI); $this->TTIT1TI($aTmp); return $I1IlILL; }function TITlTll(){ return $this->IILlI1l; }function detectNavData($IIIL1LL, $I1IllL1){ $this->I1IlIII =Array(); $vMod =&$this->Core->GetModule($IIIL1LL); $I1IlILL =$vMod->getProperty("stop_use_sublinks"); if($I1IlILL){ $aNames =$vMod->getAOption("stop_arg_names"); foreach($aNames as $I1IlI11=>$vModName){ if(isset($this->VarsGet[$I1IlI11])) {$this->I1IlIII[$I1IlI11] =Array(I5392=>$this->VarsGet[$I1IlI11], I5382=>$vModName); }}}}function GetNavData($key, $I1Ill1I) {$res =I5372; if(!$this->IILllI1) $this->InitNavSettings(); if($this->IILlI1L) {if(isset($this->I1IlIII[$key][$I1Ill1I])) {$res =$this->I1IlIII[$key][$I1Ill1I]; }else {$I1IllI1 =&$this->Core->GetModule($this->I1IlIII[$key][I5382]); if(is_object($I1IllI1)) {$vKey =$I1IllI1->TTlT1lI(); $ILlllIl =$I1IllI1->GetTableName(); $db =new DB_si; $sql ="select sublink from ".$ILlllIl.I5388.$vKey."='".$this->I1IlIII[$key][I5392]."' and lang='".$this->lang_data."'"; $db->query($sql); $this->I1IlIII[$key]["sublink"] =I5372; if($db->next_record()){ $this->I1IlIII[$key][I5393] =$db->Record[I5393]; }$res =$this->I1IlIII[$key][I5393]; }}}return $res; }function PushNavSettings(){ $this->_NavModNames =$this->IILlI11 ;$this->_NavStopLinkValue =$this->IILllIl; $this->_NavStopLinkSplitter =$this->IILllIL; }function PopNavSettings(){ $this->IILlI11 =$this->_NavModNames ;$this->IILllIl =$this->_NavStopLinkValue; $this->IILllIL =$this->_NavStopLinkSplitter; }function TITlTl1($I1Ill1l, $IIl1IL1, $I1Ill1L =Array()) {$res =Array(); if(!empty($IIl1IL1['filled'])) {$res =$IIl1IL1; }if(!empty($I1Ill1L['filled'])) {$res += $I1Ill1L; }$res += $I1Ill1l; return $res; }public function fixURLSlash(){ $uri =parse_url($_SERVER['REQUEST_URI']); $path =isset($uri['path']) ?$uri[I5394] :I5380; $query =isset($uri['query']) ?$uri['query'] :I5380; if($query !== I5380){ $query ='?' .$query; }return rtrim($GLOBALS['ROOT_PATH_WWW'], I5390) .(mb_substr($path, -1) == I5390 ?mb_substr($path, 0, -1) :$path .I5390) .$query; }}