<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       9979 xkqwxiwttzslzpymtsklqupwgrwlpkgkttlrsrqtypzzrluxqkrzwqyizgwrgkyinypmpnir
 */ ?><?php foreach(array(5615=>"WID|IHSuJQD|tQIGJZtQD|JZnPD",5616=>"WID|IHSuJQD|tQIGJZtQD",5617=>"dqjqwT?nZIQ?FRhi?",5618=>'~;WHIIHn|IHSuJQD|DQtD$~',5619=>'~;nQCD|ZrWOMvQ$~',5620=>"RhhT|gzTo",5621=>"|JHWZJ~IHSuJQD~SMDtrMY",5622=>"SMrnZIQ",5623=>"",5624=>"WHntQnt",5625=>"'") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class guiUpdater extends gui {public $I1Il1IL; function guiUpdater($I1Il1I1="", $IIIl1Il ="") {$this->I1Il1IL =Array(); parent::gui($I1Il1I1, $IIIl1Il); $this->db =new db_si; $this->cacheState(false); }function TITlI1T($fileName, $filesPath, $I1Il1lI) {if(!isset($this->I1Il1IL[$filesPath])) {$oldReadFileFromDB =$this->readFileFromDB; $filePrefix =$this->_correctReadMode($filesPath.$fileName); $aFiles =Array(); if($this->readFileFromDB && !$this->forceReadFileFromDisk){ if($I1Il1lI) {$IIl11lI =I5615; }else {$IIl11lI =I5616; }$sql =I5617.$IIl11lI." WHERE path='".mysql_real_escape_string($filesPath)."'  ".$this->getSqlFilter(); $this->db->query($sql); while($this->db->next_record()) {$aFiles[] =$this->db->Record["name"]; }}else {$dh =@opendir($filesPath); if($dh) {while ($file =readdir($dh)) {if(is_file($filesPath.$file)) {$aFiles[] =$file; }}closedir($dh); }}$this->I1Il1IL[$filesPath] =$aFiles; $this->setReadFromDB($oldReadFileFromDB); }return $this->I1Il1IL[$filesPath]; }function &TITlI1I($fileName, $filesPath) {static $I1Il1ll =array ('/^_(eshop|gallery|kb|portfolio)_item_(details|list)$/', '/^adv_places_common$/', I5618, '/^(eshop|gallery|kb|portfolio)/', '/^jobs_history(_form_reply)?$/', '/^jobs_employer(_request)?$/', '/^jobs_resume$/', I5619, '/^blog_archive$/', '/^pages_common$/', '/^rating_(blocks|stars|thumbs)$/', '/^redirect_submit$/', '/^pager_item_details$/' );$extension =mb_substr($fileName, -4); $files =array ();$I1Il1lI =($extension == ".lng"); $I1Il1lL =mb_substr($fileName, 0, -4); $I1Il1l1 =$this->TITlI1T($fileName, $filesPath, $I1Il1lI); foreach($I1Il1l1 as $file) {if($fileName != $file) {if (preg_match("/^" .preg_quote($I1Il1lL) ."(_.+)?" .preg_quote($extension) ."$/", $file)) {$I1Il1LI =mb_substr($file, 0, -4); foreach ($I1Il1ll as $IlIIL1I) {if (preg_match($IlIIL1I, $I1Il1LI)) {continue 2; }}$files[] =$file; }}else {$files[] =$file; }}return $files; }function TITlI1l($Il1L1LL, $Il1L1L1, $fileName, $Il1L1II, $backupFileStore, $rewriteFileIfExists) {$I1Il1Ll =0; $file =$GLOBALS[I5620].$Il1L1L1.$fileName; $I1Il1LL =file_exists($file); if($backupFileStore && $rewriteFileIfExists && $I1Il1LL) {$I1Il1L1 =mb_strrpos($fileName, "."); $Il1LL1L =mb_substr($fileName, $I1Il1L1); $I1Il11I =mb_substr($fileName, 0, $I1Il1L1); $I1Il11I .= ".".$Il1L1II.$Il1LL1L; $Il1L1Ll =$GLOBALS[I5620].$Il1L1L1.$I1Il11I; $res =@copy($file, $Il1L1Ll); $I1Il1Ll =$I1Il1Ll |(8 *intval($res)); if($res) {@chmod($Il1L1Ll, 0666); }}if(!$I1Il1LL || $rewriteFileIfExists) {$res =@copy($Il1L1LL.$fileName, $file); if($res) {@chmod($Il1L1LL.$fileName, 0666); }$I1Il1Ll =$I1Il1Ll |(2 *intval($I1Il1LL)); $I1Il1Ll =$I1Il1Ll |(4 *intval($res == false)); }else {$I1Il1Ll =$I1Il1Ll |1; }return $I1Il1Ll; }function TITlI11($fileName) {$res =0; if(mb_strpos($fileName, ".lng") !== false) {$res =1; }elseif(mb_strpos($fileName, ".tpl") !== false) {$res =2; }return $res; }function TITllTT(&$db, $Il1L1LL, $Il1L1L1, $fileName, $Il1L1II, $backupFileStore, $rewriteFileIfExists) {$I1Il1Ll =1; if($rewriteFileIfExists || !$this->isValidFile($Il1L1L1.$fileName)) {$I1Il11l =$this->TITlI11($fileName); $I1Il11L =false; if(strpos($Il1L1LL, I5621) !== false){ $I1Il11l =0; $I1Il11L =true; }if($I1Il11l >0) {if($this->_checkFile($Il1L1L1.$fileName)) {$oldReadFileFromDB =$this->readFileFromDB; $filePrefix =$this->_correctReadMode($Il1L1L1.$fileName); if($this->readFileFromDB && !$this->forceReadFileFromDisk){ $isLangs =($I1Il11l == 1); $fileContent =file_get_contents($Il1L1LL.$fileName); $fileTimeSt =filemtime($Il1L1LL.$fileName); $res =$this->_putFileContentToDb($db, $Il1L1L1, $fileName, $fileTimeSt, $fileContent, $isLangs, true); if($res == 1) {$I1Il1Ll =0; }elseif($res == 2) {$I1Il1Ll =2; }}else {$I1Il11L =true; }$this->setReadFromDB($oldReadFileFromDB); }}if($I1Il11l == 0 || $I1Il11L) {$I1Il1Ll =$this->TITlI1l($Il1L1LL, $Il1L1L1, $fileName, $Il1L1II, $backupFileStore, $rewriteFileIfExists); }}return $I1Il1Ll; }function _saveFile($file, &$content, $ts =0, $checkTimeStamp =TRUE){ $res =false; if($this->_checkFile($file)) {$oldReadFileFromDB =$this->readFileFromDB; $filePrefix =$this->_correctReadMode($file); $I1Il11l =$this->TITlI11($file); if($I1Il11l && $this->readFileFromDB && !$this->forceReadFileFromDisk){ $isLangs =($I1Il11l == 1); $aFile =pathinfo($file); if(!$ts){ $ts =time(); }$tmpRes =$this->_putFileContentToDb($this->db, $aFile[I5622]."/", $aFile["basename"], $ts, $content, $isLangs, TRUE, $checkTimeStamp); $res =($tmpRes == 1 || $tmpRes == 2); }else{ $hFile =@fopen($filePrefix.$file, "w"); if($hFile) {$res =@fwrite($hFile, $content); @fclose($hFile); }}$this->setReadFromDB($oldReadFileFromDB); }return $res; }function TITllTI(&$log, $isLang) {$num =0; $table =I5616 .($isLang ?"_langs" :I5623); $sql ="SELECT id, path, name, content FROM " .$table ." WHERE content RLIKE '##--[^#]*\\\\(patched:[^#]*--##'"; $I1Il111 =&$this->db->select($sql); while($I1Il111->nextRecord()) {$content =preg_replace('/(.*?)##--[^#]*?\(patched:[^#]*?--##/si', "\\1", $I1Il111->Record[I5624]); $sql ="UPDATE " .$table ." SET content='".mysql_real_escape_string($content)."' WHERE id='".$I1Il111->Record["id"].I5625; $this->db->execute($sql); $num++; $log .= "cleared [ ".$I1Il111->Record["path"].$I1Il111->Record["name"]." ]\n"; }return $num; }}