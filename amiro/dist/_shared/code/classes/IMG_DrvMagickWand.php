<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       20223 xkqwzzuxqniggrqpgszsuyygllptplzrgmmtrigwszirtzrpguqityqrsuriygktpgxqpnir
 */ ?><?php foreach(array(5739=>"PMf",5740=>"LGP",5741=>"",5742=>"1",5743=>"4",5744=>"WQntQr",5745=>"JZBQr",5746=>"LGQP",5747=>'SMDZYJQ|QrrHr|IZMJ',5748=>'iZPMWKRQZSmIZPQ',5749=>"RhhT|gzTo",5750=>'UTF+8') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class IMG_DRVMAGICKWAND{ public $I1ILl1I; public $I1ILl1l; function IMG_DRVMAGICKWAND(){ $this->I1ILl1I =0; $this->I1ILl1l =75; }function TIT1TIT($I1ILl1L){ if(!empty($I1ILl1L)){ $data =false; $img =NewMagickWand(); if(!@MagickReadImage($img, $I1ILl1L)) return false; $data[0] =MagickGetImageWidth($img); $data[1] =MagickGetImageHeight($img); switch(mb_strtolower(MagickGetImageFormat($img))){ case "jpeg": case "jpg": $data[2] =2; break; case I5739: $data[2] =1; break; case "png": $data[2] =3; break; default: $data =false; break; }return $data; }else return false; }function TIT1TII($I1ILl11, $I1ILLII, $I1ILLIl ="", $I1ILLIL =65, $I1ILLI1 ="center", $cX =0, $cY =0, $I1ILLlI =0){ set_time_limit(60); if(!empty($I1ILl11) && !empty($I1ILLII)){ $I1ILLll =NewMagickWand(); $I1ILLlL =false; if(MagickReadImage($I1ILLll, $I1ILl11)) $I1ILLlL =array(MagickGetImageWidth($I1ILLll), MagickGetImageHeight($I1ILLll), str_replace("jpeg", I5740, mb_strtolower(MagickGetImageFormat($I1ILLll)))); $I1ILLl1 =NewMagickWand(); $I1ILLLI =false; if(MagickReadImage($I1ILLl1, $I1ILLII)) $I1ILLLI =array(MagickGetImageWidth($I1ILLl1), MagickGetImageHeight($I1ILLl1), str_replace("jpeg", I5740, mb_strtolower(MagickGetImageFormat($I1ILLl1)))); if($I1ILLlL !== false && $I1ILLLI !== false && in_array($I1ILLlL[2], array(I5740, I5739, "png")) && in_array($I1ILLLI[2], array(I5740, I5739, "png"))){ if($this->I1ILl1I >0){ $I1ILLLl =$I1ILLlL[0]*$I1ILLlL[1]*4 +$I1ILLLI[0]*$I1ILLLI[1]*4; if($I1ILLLl >$this->I1ILl1I){ DestroyMagickWand($I1ILLll); DestroyMagickWand($I1ILLl1); return false; }}if(empty($I1ILLIl) || preg_match('/.*\.((gif)|(jpg)|(jpeg)|(png))$/i', $I1ILLIl, $I1ILLLL)){ $this->TIT1TIl($I1ILLll, $I1ILLl1, $I1ILLI1, $I1ILLIL, $cX, $cY); DestroyMagickWand($I1ILLl1); $I1ILLL1 =I5741; $fileExt =I5741; if(empty($I1ILLIl)){ $I1ILLL1 =$I1ILl11; $fileExt =$I1ILLlL[2]; }else{ $I1ILLL1 =$I1ILLIl; $fileExt =mb_strtolower($I1ILLLL[1]); if($fileExt == "jpeg") $fileExt =I5740; }if($I1ILLlI >0 && $fileExt == I5740) MagickSetImageCompressionQuality($I1ILLll, $I1ILLlI >0 ?$I1ILLlI :$this->I1ILl1l); MagickSetImageFormat($I1ILLll, mb_strtoupper($fileExt)); if(MagickWriteImage($I1ILLll, $I1ILLL1)) @chmod($I1ILLL1, 0666); DestroyMagickWand($I1ILLll); return true; }}}return false; }function TIT1TIl(&$I1ILL1I, &$I1ILL1l, $I1ILLI1 ="center", $I1ILLIL =80, $cX =0, $cY =0){ set_time_limit(60); $I1ILLlL[0] =MagickGetImageWidth($I1ILL1I); $I1ILLlL[1] =MagickGetImageHeight($I1ILL1I); $I1ILLLI[0] =MagickGetImageWidth($I1ILL1l); $I1ILLLI[1] =MagickGetImageHeight($I1ILL1l); $I1ILL1L =0; $I1ILL11 =0; switch($I1ILLI1){ case "6": $I1ILLI1 ="tile"; case I5742: case "tile": case "upleft": break; case "2": case "upright": $I1ILL1L =max(0, $I1ILLlL[0]-$I1ILLLI[0]); break; case I5743: case "downleft": $I1ILL11 =max(0, $I1ILLlL[1]-$I1ILLLI[1]); break; case "5": case "downright": $I1ILL1L =max(0, $I1ILLlL[0]-$I1ILLLI[0]); $I1ILL11 =max(0, $I1ILLlL[1]-$I1ILLLI[1]); break; case "3": case I5744: $I1ILL1L =max(0, floor(($I1ILLlL[0]-$I1ILLLI[0])/2)); $I1ILL11 =max(0, floor(($I1ILLlL[1]-$I1ILLLI[1])/2)); break; default: $I1ILL1L =$cX; $I1ILL11 =$cY; break; }$I1IL1II =MagickGetQuantumRange(); $opacity =$I1IL1II -($I1IL1II *max(0, 127-$I1ILLIL)/127) ;if($opacity >$I1IL1II){ $opacity =$I1IL1II; }elseif($opacity <0){ $opacity =0; }MagickSetImageIndex($I1ILL1l, 0); MagickSetImageType($I1ILL1l, MW_TrueColorMatteType); MagickEvaluateImage($I1ILL1l, MW_SubtractEvaluateOperator, $opacity, MW_OpacityChannel); if($I1ILLI1 != "tile" && $I1ILLI1 != "6"){ MagickCompositeImage($I1ILL1I, $I1ILL1l, MW_OverCompositeOp, $I1ILL1L, $I1ILL11); }else{ $I1ILL1L =0; $I1ILL11 =0; for($w =0; $w <$I1ILLlL[0]; $w+=$I1ILLLI[0]){ set_time_limit(25); for($h =0; $h <$I1ILLlL[1]; $h+=$I1ILLLI[1]){ MagickCompositeImage($I1ILL1I, $I1ILL1l, MW_OverCompositeOp, $w, $h); }}}}function TIT1TI1($I1ILl11, $I1ILLIl, $I1IL1Il, $I1IL1IL, $I1IL1I1 =true, $I1ILLlI =0, $I1IL1lI =array(), $I1IL1ll =array()){ set_time_limit(60); if(!empty($I1ILl11)){ $I1IL1lL =NewMagickWand(); $I1ILLlL =false; if(MagickReadImage($I1IL1lL, $I1ILl11)) $I1ILLlL =array(MagickGetImageWidth($I1IL1lL), MagickGetImageHeight($I1IL1lL), str_replace("jpeg", I5740, mb_strtolower(MagickGetImageFormat($I1IL1lL)))); if($I1ILLlL !== false && in_array($I1ILLlL[2], array(I5740, I5739, "png"))){ if($this->I1ILl1I >0){ if($I1ILLlL[0]*$I1ILLlL[1]*4*2 >$this->I1ILl1I){ DestroyMagickWand($I1IL1lL); return false; }}if(empty($I1ILLIl) || preg_match('/.*\.((gif)|(jpg)|(jpeg)|(png))$/i', $I1ILLIl, $I1ILLLL)){ if($I1IL1I1){ if($I1IL1Il <= 0 && $I1IL1IL <= 0){ DestroyMagickWand($I1IL1lL); return false; }if(!($I1ILLlL[0]>0) || !($I1ILLlL[1]>0)){ DestroyMagickWand($I1IL1lL); trigger_error('Image dimension detection fail:'.$I1ILl11, E_USER_WARNING); return false; }if($I1IL1Il >0 and $I1IL1IL >0){ $I1IL1l1 =$I1IL1Il/$I1ILLlL[0]; $I1IL1LI =$I1IL1IL/$I1ILLlL[1]; if($I1IL1l1 <$I1IL1LI){ $I1IL1IL =ceil($I1ILLlL[1]*$I1IL1Il/$I1ILLlL[0]); }else{ $I1IL1Il =ceil($I1ILLlL[0]*$I1IL1IL/$I1ILLlL[1]); }}}else{ if($I1IL1Il <= 0) $I1IL1Il =$I1ILLlL[0]; if($I1IL1IL <= 0) $I1IL1IL =$I1ILLlL[1]; }$I1ILLIl =str_replace(array("[NEWWIDTH]", "[NEWHEIGHT]"), array($I1IL1Il, $I1IL1IL), $I1ILLIl); if(!MagickResizeImage($I1IL1lL, $I1IL1Il, $I1IL1IL, MW_LanczosFilter, 1)){ DestroyMagickWand($I1IL1lL); return false; }else{ if(is_array($I1IL1lI) && sizeof($I1IL1lI) >0 && is_file($I1IL1lI["layer"])){ $I1ILLl1 =NewMagickWand(); $I1ILLLI =false; if(MagickReadImage($I1ILLl1, $I1IL1lI[I5745])) $I1ILLLI =array(MagickGetImageWidth($I1ILLl1), MagickGetImageHeight($I1ILLl1), str_replace("jpeg", I5740, mb_strtolower(MagickGetImageFormat($I1ILLl1)))); if($I1ILLLI !== false && in_array($I1ILLLI[2], array(I5740, I5739, "png"))) $this->TIT1TIl($I1IL1lL, $I1ILLl1, $I1IL1lI["orient"], $I1IL1lI["alpha"]); DestroyMagickWand($I1ILLl1); }if(is_array($I1IL1ll) && sizeof($I1IL1ll) >0 && is_file($I1IL1ll[I5745])){ $I1ILLl1 =NewMagickWand(); $I1ILLLI =false; if(MagickReadImage($I1ILLl1, $I1IL1ll[I5745])) $I1ILLLI =array(MagickGetImageWidth($I1ILLl1), MagickGetImageHeight($I1ILLl1), str_replace(I5746, I5740, mb_strtolower(MagickGetImageFormat($I1ILLl1)))); if($I1ILLLI !== false && in_array($I1ILLLI[2], array(I5740, I5739, "png"))) $this->TIT1TIl($I1IL1lL, $I1ILLl1, $I1IL1ll["orient"], $I1IL1ll["alpha"]); DestroyMagickWand($I1ILLl1); }$I1ILLL1 =I5741; $fileExt =I5741; if(empty($I1ILLIl)){ $I1ILLL1 =$I1ILl11; $fileExt =$I1ILLlL[2]; }else{ $I1ILLL1 =$I1ILLIl; $fileExt =mb_strtolower($I1ILLLL[1]); if($fileExt == I5746) $fileExt =I5740; }if($I1ILLlI >0 && $fileExt == I5740) MagickSetImageCompressionQuality($I1IL1lL, $I1ILLlI >0 ?$I1ILLlI :$this->I1ILl1l); MagickSetImageFormat($I1IL1lL, mb_strtoupper($fileExt)); AMI_Registry::push('disable_error_mail', true); if(@MagickWriteImage($I1IL1lL, $I1ILLL1)) @chmod($I1ILLL1, 0666); if(is_file($I1ILLL1) && filesize($I1ILLL1) === 0){ unlink($I1ILLL1); }AMI_Registry::pop(I5747); DestroyMagickWand($I1IL1lL); return true; }}}}return false; }function TIT1TlT($cType =I5741, $IL111LL ="rw"){ $retVal =array(); $I1I1II1 =(mb_strpos($IL111LL, "r") !== false); $I1I1IlI =(mb_strpos($IL111LL, "w") !== false); if(!function_exists('NewMagickWand')) return (!empty($cType) ?false :$retVal); if($I1I1II1 && (!function_exists(I5748) || !function_exists('MagickGetImageFormat'))) return (!empty($cType) ?false :$retVal); if($I1I1IlI && (!function_exists('MagickWriteImage'))) return (!empty($cType) ?false :$retVal); if($I1I1IlI && ($cType == I5740 || $cType == I5746) && !function_exists('MagickSetImageFormat')) return (!empty($cType) ?false :$retVal); return (!empty($cType) ?true :array(I5740, I5746, "png", I5739)); }function TIT1TlI($I1ILLIl, $I1IL1L1, $I1IL11I, $I1IL11l, $I1IL11L, $errData){ $font =$GLOBALS[I5749].'templates/fonts/tahoma.ttf'; $I1IL111 =11; if(preg_match('/^\d+$/', $I1IL11L)) $I1IL11L ="#".$I1IL11L; $I1I1III =$I1IL11l; $img =NewMagickWand(); $I1I1IIl =NewDrawingWand(); $I1I1IIL =NewPixelWand(); MagickNewImage($img, $I1IL1L1, $I1IL11I, '#FFFFFF'); DrawSetFont($I1I1IIl, $font); DrawSetFontSize($I1I1IIl, $I1IL111); DrawSetFontWeight($I1I1IIl, 100); DrawSetTextEncoding($I1I1IIl, I5750); DrawSetTextAntialias($I1I1IIl, true); PixelSetColor($I1I1IIL, $I1IL11L); DrawSetFillColor($I1I1IIl, $I1I1IIL); DrawSetTextAlignment($I1I1IIl, MW_CenterAlign); DrawSetGravity($I1I1IIl, MW_CenterGravity); DrawAnnotation($I1I1IIl, $I1IL1L1/2, $I1IL111+2, $I1I1III); MagickDrawImage($img, $I1I1IIl); MagickSetFormat($img, 'GIF'); $res =false; if(MagickWriteImage($img, $I1ILLIl)) $res =true; DestroyMagickWand($img); DestroyDrawingWand($I1I1IIl); DestroyPixelWand($I1I1IIL); return $res; }}?>
