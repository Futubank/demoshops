<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       51339 xkqwkkzgkqrwywxtmmtsixmprtnmlnzwgyxszwzptxylsknynipnqmsyixsywsrutiwzpnir
 */ ?><?php foreach(array(5850=>"YHSB",5851=>"OHIQ",5852=>'widVQr',5853=>"",5854=>"~#,++\\D[)",5855=>"WHntQnt",5856=>"(\\D[++@~D",5857=>"WZGtMHn",5858=>"<<",5859=>"~#,++?)}\\~\\~{ ",5860=>"MD|SQfZuJt",5861=>"WDD|fMJQ",5862=>"JZB|IZMn",5863=>"JZB|",5864=>"MnDtZJJQS|JZnPD",5865=>"JZnP",5866=>"`OtIJ",5867=>"YZDQnZIQ",5868=>"QrrHr|WHSQ",5869=>"~",5870=>"DtZtuD|fHJSQr|fZMJ",5871=>'JZB|IZMn|YHSB',5872=>'',5873=>'nZIQ',5874=>'JZB|YHSB',5875=>'|YHSB',5876=>'<<QnS<<',5877=>'+',5878=>'YZDQSMr',5879=>'zUTohR',5880=>'`txt',5881=>'=1',5882=>'~JZBHutD~',5883=>'YHSB',5884=>'|IHS|fMJQD~|WDD',5885=>'trQQMIPD',5886=>'~',5887=>'~\`GOG$~uM',5888=>'fMJQD~',5889=>'tQIGJZtQD',5890=>'WID|IHSuJQD|tQIGJZtQD',5891=>'WID|IHSuJQD|tQIGJZtQD|JZnPD',5892=>":D",5893=>":D!?",5894=>"\r",5895=>'~tQIGJZtQD~',5896=>'tQIGJZtQD~',5897=>'JZBHutD',5898=>"ruJQD|",5899=>'~HGtMHnD`txt',5900=>'RhhT|gzTo|ccc',5901=>'SQDMPn',5902=>'wjzddqd|gzTo',5903=>'``',5904=>'RhhT|gzTo',5905=>'~|JHWZJ~',5906=>'`JnP',5907=>'IZMn',5908=>'fZKQ',5909=>'IHSmS',5910=>'HdtHrZPQ',5911=>'GKP~OZnSJQrD~unMnDtZJJ',5912=>'WHnfMP',5913=>'IHSQ',5914=>'~fMJQD~SQW|',5915=>'GKP~OZnSJQrD~MnDtZJJ',5916=>'SQDMPn?MnDtZJJ',5917=>'JZBHut',5918=>"JZB|f",5919=>"+1{{!JZB|f",5920=>"WID|GZPQD",5921=>'Qnv~fMJQ|WZWOQ',5922=>"\r\n") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class Layouts{ public $I1lILl1; public $I1lILLI; public $I1lILLl; public $I1lILLL; public $I1lILL1; public $I1lIL1I; public $I1lIL1l; public $I1lIL1L; public $I1lIL11; public $I1lI1II; public $I1lI1Il; public $I1lI1IL; public $I1lI1I1; public $II1LLLL; public $I1lI1lI; public $I1lI1ll; public $I1lI1lL; public $I1lI1l1; public $I1lI1LI; public $I1lI1Ll; public $I1lI1LL; public $I1lI1L1; public $I1lI11I; public $cms; public $db; public $I1lI11l; function Layouts(&$cms, $I1lI11L =""){ if(!is_object($cms)){ trigger_error("CMS object is not initialized...", E_USER_ERROR); die(); }$this->cms =&$cms; $this->db =new DB_Si; $this->I1lILl1 =$I1lI11L; $this->I1lILLI =true; $this->I1lILLl =true; $this->I1lILLL =true; $this->checkHead =true; $this->I1lILL1 =true; $this->I1lIL1I =true; $this->I1lIL1l =$this->cms->PManager->GetProperty("template_blocks_number"); $this->I1lI1IL =preg_quote("##status_messages##", "/"); $this->I1lIL1L =preg_quote("lay_", "/"); $this->I1lIL11 =array(I5850); $this->I1lI1II =array(); for($i=1; $i<=$this->I1lIL1l; $i++){ $this->I1lI1II[] ="f".$i; }$this->I1lI1II =array_merge($this->I1lI1II, $this->I1lIL11); $this->I1lI11I =false; $this->I1lI1Il ="lay_main"; $this->I1lI1I1 ="css_file"; $this->nameHead ="head"; $this->II1LLLL =0; $this->I1lI1lI =true; $this->I1lI1ll =I5851; $this->I1lI1lL ="main"; $this->I1lI1l1 ='<!DOCTYPE>'."\n##init##"; $this->I1lI1LI ="##end##"; $this->I1lI1Ll =false; $this->I1lI1LL =array(); $this->I1lI1L1 =array(); $this->I1lI11l =array(I5852, 'NAME', 'AUTHOR'); }function AddStatusMsg($p1, $p2="", $I1lI111="", $I1llIII=I5853, $I1llIIl=array()){ if($this->I1lI1lI){ $this->cms->AddStatusMsg($p1, $p2, $I1lI111, $I1llIII, $I1llIIl); }}function TIT1l1T($I1llIIL, $cType ="blue", $I1llII1 ="error_"){ $mask =intval($I1llIIL); $c =1; while($c<=1024){ $code =($mask &$c );if($code){ $this->AddStatusMsg($I1llII1."$code", $cType); }$c <<= 1; }}function TIT1l1I(&$I1llIlI) {$str =$I1llIlI; $error =0; $I1lI1II =$this->I1lI1II; $I1lIL11 =$this->I1lIL11; while(preg_match("/##".$this->I1lIL1L."([^#]*)_body##/s", $str, $matches)) {$key =array_search($matches[1], $I1lI1II); if($key !== false) {unset($I1lI1II[$key]); $key =array_search($matches[1], $I1lIL11); if($key !== false) {unset($I1lIL11[$key]); }}else {$error |= 2; }$str =str_replace($matches[0], I5853, $str); }if(sizeof($I1lIL11) >0) {$error |= 1; }if($error) $this->II1LLLL =$error; return $error; }function TIT1l1l($str, &$aResult, $I1llIll =false) {$aResult =Array(); $error =0; $this->II1LLLL =0; $I1lI1II =$this->I1lI1II; $I1lIL11 =$this->I1lIL11; preg_match_all("/<!--\\s*{exclude}\\s*-->/s", $str, $m, PREG_SET_ORDER); $I1llIlL =sizeof($m); preg_match_all("/<!--\\s*{\\/\\/exclude}\\s*-->/s", $str, $m, PREG_SET_ORDER); $I1llIl1 =sizeof($m); if($I1llIlL != $I1llIl1){ $error |= 64; }$str =preg_replace("/<!--\\s*{exclude}\\s*-->(.*?)<!--\\s*{\\/\\/exclude}\\s*-->/s", '', $str); if(preg_match('/^(<\!DOCTYPE.*?>)/ui', $str, $matches)) {$I1llILI =$matches[0]; }if($this->I1lILLL) {if(preg_match(I5854.$this->I1lI1I1.":\"([^\"]*)\"}\\s*-->/s", $str, $matches)) {$data["name"] =$this->I1lI1I1; $data["caption"] =''; $data[I5855] =$matches[1]; $aResult[$data["name"]] =$data; $str =preg_replace(I5854.$this->I1lI1I1.":\"([^\"]*)\"}\\s*-->/s", '', $str); }else {$error |= 32; }}if($this->checkHead) {if(preg_match(I5854.$this->nameHead.":\"([^\"]*)\"}\\s*-->(.*)<!--\\s*{\/\/".$this->nameHead.I5856, $str, $matches)) {$data["name"] =$this->nameHead; $data["caption"] =''; $data[I5855] =$matches[2]; $aResult[$data["name"]] =$data; $str =preg_replace(I5854.$this->nameHead.":\"([^\"]*)\"}\\s*-->(.*)<!--\\s*{\/\/".$this->nameHead.I5856, '', $str); }}if($this->I1lILLl) {if(CacheHtmlContent){ $this->I1lI11I[$this->_fName] =$str; }$main =Array(); $main["name"] =$this->I1lI1Il; $main["caption"] =I5853; $main[I5855] =I5853; if(preg_match(I5854.$this->I1lI1Il.":\"([^\"]*)\"}\\s*-->(.*)<!--\\s*{\\/\\/".$this->I1lI1Il.I5856, $str, $matches)) {$str =$matches[2]; $main[I5857] =$matches[1]; if($this->I1lILL1) {if(!preg_match("/".$this->I1lI1IL."/s", $str)) {$error |= 128; }}}else {$error |= 8; }}if($this->I1lILLI) {preg_match_all("/<!--\\s*{replace:\"([^\"]*)\"}\\s*-->/s", $str, $m, PREG_SET_ORDER); $I1llILl =sizeof($m); preg_match_all("/<!--\\s*{\\/\\/replace}\\s*-->/s", $str, $m, PREG_SET_ORDER); $I1llILL =sizeof($m); if($I1llILl != $I1llILL){ $error |= 16; }while(preg_match("/<!--\\s*{replace:\"([^\"]*)\"}\\s*-->(.*?)<!--\\s*{\\/\\/replace}\\s*-->/s", $str, $matches)) {$str =str_replace($matches[0], $matches[1], $str); }}while(preg_match(I5854.$this->I1lIL1L."([^}]*):\"([^\"]*)\"}\\s*-->(.*)<!--\\s*{\\/\\/".$this->I1lIL1L."\\1}\\s*-->/s", $str, $matches)) {$postfix ="_body"; if($matches[1]==I5850){ }$str =str_replace($matches[0], "##".$this->I1lIL1L.$matches[1].$postfix.I5858, $str); $data["name"] =$matches[1]; $data[I5857] =$matches[2]; $data[I5855] =$matches[3]; $key =array_search($data["name"], $I1lI1II); if($key !== false) {$aResult[$data["name"]] =$data; unset($I1lI1II[$key]); $key =array_search($data["name"], $I1lIL11); if($key !== false) {unset($I1lIL11[$key]); }}else {$error |= 2; }}foreach($I1lI1II as $val) {if(preg_match(I5859.$this->I1lIL1L.preg_quote($val, "/")."(:\"([^\"]*)\")?} -->/", $str)) {$error |=4; }}if(sizeof($I1lIL11) >0) {$error |= 1; }if($this->I1lILLl) {$main[I5855] =$this->I1lI1l1.$str.$this->I1lI1LI; if(!empty($I1llILI)) {$main[I5855] =preg_replace('/^(<\!DOCTYPE.*?>)/ui', $I1llILI, $main[I5855]); }$aResult[$main['name']] =$main; }$this->II1LLLL =$error; return $error; }function TTll1I1(){ if(!$this->I1lI1Ll){ return false; }return $this->I1lI1LL; }function TIT1l11(&$aLayout, $I1llIL1 =false){ $asql =array(); foreach($aLayout as $I1llI1I=>$I1llI1l){ if($I1llI1I==I5860){ $asql[I5860] =(($I1llI1L[I5860])?"1":"0"); }else{ switch ($I1llI1l["name"]) {case I5860: break; case "css_file": $asql[I5861]=$I1llI1l[I5855]; break; case "head": $asql["html_head_tail"]=$I1llI1l[I5855]; break; case I5850: $asql["lay_body_type"]=$I1llI1l[I5857]; $asql["lay_body"]=addslashes($I1llI1l[I5855]); break; case I5862: $asql["name"]=$I1llI1l[I5857]; $asql["lay_main_body"]=addslashes($I1llI1l[I5855]); if($I1llIL1) $asql["lay_main_body_original"]=addslashes($I1llI1l[I5855]); break; default: $n =$I1llI1l["name"]; $asql[I5863.$n."_type"]=$I1llI1l[I5857]; $asql[I5863.$n."_body"]=addslashes($I1llI1l[I5855]); if($I1llIL1) $asql[I5863.$n."_body_original"]=addslashes($I1llI1l[I5855]); break; }}}return $asql; }function TIT11TT($I1llI11){ $sql ="delete from cms_wz_design_layouts where id_design='$I1llI11'"; $this->db->query($sql); $this->I1lI1L1 =array(); foreach($this->cms->Core->GetAOption(I5864) as $IILLl1L){ $this->I1lI1L1[$IILLl1L] =0; }$I1lllII =I5853; $I1lI1LL =$this->TTll1I1(); foreach($I1lI1LL as $IILLl1L=>$vData){ foreach($vData as $lName=>$I1llI1L){ if(empty($I1lllII)){ $I1lllII =$IILLl1L; }$asql =Array( "id_design"=>$I1llI11, I5865=>$IILLl1L, I5860=>(($I1llI1L[I5860])?"1":"0"), "filename"=>$lName, "html_source"=>addslashes($this->I1lI11I[$lName]) );$asql += $this->TIT1l11($I1llI1L); $sql =$this->db->GenInsertSQL("cms_wz_design_layouts", $asql); $this->db->query($sql); $this->I1lI1L1[$IILLl1L]++; }}return $this->I1lI1L1[$I1lllII]; }function TIT11TI($cPath, $cid=0, $I1llIll =false){ require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_file_system.php"); $res =true; $I1lllIl =array($this->cms->lang_data); $I1lllIl =array_unique(array_merge($I1lllIl, $this->cms->Core->GetAOption(I5864))); $required =true; foreach($I1lllIl as $num=>$IILLl1L){ $realPath =$this->I1lILl1.$cPath."/"; $I1lllIL =0; $I1lllI1 =false; $I1llllI =false; $I1lllll =$this->TIT11Tl($cPath, $cid, $required); if($I1lllll){ $aFiles =getDirFileList($realPath); foreach($aFiles as $I1llllL){ $f =pathinfo($I1llllL); $I1llll1 ="_".$IILLl1L.I5866; $I1lllLI ="_".$IILLl1L.".jpg"; if(mb_strpos($f["basename"], $I1llll1)===false ){continue; }$I1llI1L =array(); $I1lllLl =false; if(mb_strpos("!".$f[I5867], $this->I1lI1ll)===1){ $I1lllI1 =true; $I1lllLl =true; }if(mb_strpos("!".$f[I5867], $this->I1lI1lL)===1){ $I1llllI =true; }$I1lllLL =$f[I5867]; $vName =mb_substr($I1lllLL, 0, mb_strpos($I1lllLL, $I1llll1)); $this->_fName =$vName; $I1lllL1 =$this->TIT1l1l(file_get_contents($realPath.$I1lllLL), $I1llI1L, $I1llIll); $I1llI1L[I5860] =$I1lllLl; if($I1lllL1>0){ $this->AddStatusMsg("status_parse_fail", "red",I5853,I5853,array("name"=>$I1lllLL, I5865=>$IILLl1L, I5868=>"$I1lllL1")); $this->TIT1l1T($I1lllL1); return false; }else{ $I1lllIL++; $I1lI1LL[$IILLl1L][$vName] =$I1llI1L; $I1lll1I =$vName.$I1lllLI; if($this->I1lIL1I && !file_exists($realPath.$I1lll1I)){ $this->AddStatusMsg("status_img_missing", "red",I5853,I5853,array("img_name"=>$I1lll1I, "lay_name"=>$I1lllLL)); return false; }}}}if(!$I1lllll && $required){ return false; }if($I1lllIL && !$I1lllI1){ $this->AddStatusMsg("status_required_missing", "red",I5853,I5853,array("required_name"=>$this->I1lI1ll.$I1llll1, I5865=>$IILLl1L)); return false; }if($I1llllI){ $I1lI1LL[$IILLl1L][$this->I1lI1ll][I5860] =false; $I1lI1LL[$IILLl1L][$this->I1lI1lL][I5860] =true; }$required =false; }if(count($I1lI1LL)>0){ $this->I1lI1LL =$I1lI1LL; $this->I1lI1Ll =true; }else{ $this->AddStatusMsg("status_missing", "red"); $res =false; }return $res; }function TIT11Tl($cPath, $cid=0, $I1lll1l =false){ $res =false; clearstatcache(); $path =$this->I1lILl1.$cPath.I5869; if(is_dir($path)){ if($I1lll1l){ $filter =I5853; if($cid>0){ $filter =" and id<>'$cid' "; }$sql ="SELECT id, header FROM cms_wz_designs WHERE folder_path='$cPath' $filter limit 1"; $this->db->query($sql); if($this->db->next_record()){ $this->AddStatusMsg("status_folder_fail_dup", "red", I5853, I5853, array("design"=>$this->db->Record["header"])); return false; }}$res =true; }if(!$res){ $this->AddStatusMsg(I5870, "red", I5853, I5853, array("folder"=>"$cPath")); }return $res; }function TIT11T1($I1lll1L) {require_once($GLOBALS["FUNC_INCLUDES_PATH"] ."func_layout.php"); $ret =$I1lll1L[I5871]; $head =TlT1TT1('css_file', $I1lll1L['css_file']) .'<html><head>' .TlT1TT1('head', I5872) .$I1lll1L['html_head_tail'] .TlT1TIT('head') .'</head>' .TlT1TT1('lay_main', $I1lll1L[I5873]); $ret =str_replace('##init##', $head, $ret); $body =TlT1TT1('lay_body', $I1lll1L['lay_body_type']) .$I1lll1L['lay_body'] .TlT1TIT(I5874); $ret =str_replace('##lay_body_body##', $body, $ret); for($i =$this->cms->PManager->GetProperty("template_blocks_number"); $i >= 1 ;$i--) {$I1lll11 ='lay_f' .$i; $replace =TlT1TT1($I1lll11, $I1lll1L[$I1lll11 .'_type']) .$I1lll1L[$I1lll11 .I5875] .TlT1TIT($I1lll11); $ret =str_replace('##' .$I1lll11 .'_body##', $replace, $ret); }$tail =TlT1TIT('lay_main') .'</html>'; $ret =str_replace(I5876, $tail, $ret); return $ret; }function export($params) {$basePath =$GLOBALS['ROOT_PATH'] .'_mod_files/_upload/tmp'; if(!is_dir($basePath)) {error_log('LAYOUTS EXPORT: missing tmp root dir.'); return; }$II1l1Il =$basePath .'/design-' .rand(1000, 9999) .I5877 .rand(1000, 9999); mkdir($II1l1Il); if(!is_dir($II1l1Il)) {error_log('LAYOUTS EXPORT: unable to create temporary dir.'); return; }require_once $GLOBALS["FUNC_INCLUDES_PATH"]."func_translit.php"; require_once $GLOBALS["FUNC_INCLUDES_PATH"]."func_file_system.php"; require_once $GLOBALS['CLASSES_PATH'] .'PHPTar.php'; $I1llLII =basename($params[I5873]); if(empty($I1llLII)) {$I1llLII =basename($II1l1Il); }$I1llLII =$this->cms->TTITI11($I1llLII) .'.tar.gz'; $IIlILL1 =new PHPTar($basePath .'/' .$I1llLII, true); $IIlILL1->options(array(I5878 => $II1l1Il)); $version =$GLOBALS['Core']->getVersion(); $meta =$this->TIT11Il( array( I5852 => $version['cms']['code'], 'NAME' => $params[I5873], I5879 => $params['author'] ));file_put_contents($II1l1Il .'/info.txt', $meta); $IIlILL1->add('info.txt'); $IIlILL1->meta($meta); $I1llLIl =array(); mkdir($II1l1Il .'/layouts'); $ch =curl_init(); if(!$ch) {error_log('LAYOUTS EXPORT: unable to init curl.'); return; }curl_setopt($ch, CURLOPT_HEADER, false); curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); $tmpPage =new Page($this->cms); $tmpPage->tree->UseHidden =false; $tmpPage->tree->UseLang =true; $rs =$this->db->select('SELECT * FROM `cms_layouts` WHERE `lang` = "' .$this->cms->lang_data .'"'); while($record =$rs->nextRecord()) {$filename =$this->cms->TTITI11($record[I5873]) .'_' .$record['id'] .I5880; $I1llLIL =false; $pageID =$tmpPage->TTlllIl($record['id']); if($pageID) {$I1llLI1 =$GLOBALS['ROOT_PATH_WWW'] .$tmpPage->TTll1Tl($pageID) .'?' .$this->cms->Core->GetOption("layouts_export_flag") .I5881; curl_setopt($ch, CURLOPT_URL, $I1llLI1); $content =trim(curl_exec($ch)); if(!empty($content)) {foreach( array( '/<script[^>]*>function [a-z]*\(data\)\{document.write\(decodeURIComponent\(data\)\)\}<\/script>/ui', '/<span id="sign[a-z0-9]*"><table[^>]*id=sign[^>]*>.*?<\/table><\/span>/ui', '/<script[^>]*script=imgclear[^>]*><\/script>/ui', '/<script[^>]*>\s*DEBUG.*?<\/div>\s*<div[^>]*?>.*?<\/div>/uis' )as $regex ){$content =preg_replace($regex, I5872, $content); }if(trim($content) != I5872) {file_put_contents($II1l1Il .I5882 .$filename, $content); $IIlILL1->add('layouts/' .$filename); if(!empty($params['options'])) {$oDB =new DB_Si(); $oRS =$oDB->select('SELECT `body`, `sb_data` FROM `cms_pages` WHERE id = ' .$pageID); if(($aPageData =$oRS->nextRecord()) !== false) {$I1llLlI =unserialize($aPageData['sb_data']); $I1llLll =array(); foreach($I1llLlI as $blockId => $I1llLlL) {if(mb_strpos($aPageData[I5883], $blockId) === false) {$I1llLll[$blockId] =$I1llLlL; }}if(count($I1llLll) >0) {$I1llLIl[$filename] =$I1llLll; }}}$I1llLIL =true; }}}if(!$I1llLIL) {if($pageID) {$oDB =new DB_Si(); $oRS =$oDB->select('SELECT * from `cms_pages` where id = ' .$pageID); $I1llLl1 =$oRS->nextRecord(); if($I1llLl1) {foreach($I1llLl1 as $name => $value) {if(isset($record[$name]) && preg_match('/^lay_f[0-9]*_body/', $name)) {$record[$name] =$value; }}if(!empty($I1llLl1[I5883])) {$record[I5874] =$I1llLl1[I5883]; }}}$content =$this->TIT11T1($record); if(trim($content) != I5872) {file_put_contents($II1l1Il .I5882 .$filename, $content); $IIlILL1->add('layouts/' .$filename); }}}curl_close($ch); mkdir($II1l1Il .'/files'); $I1llLLI =array(I5884, '_mod_files/_js'); if(!empty($params['images'])) {array_push($I1llLLI, '_img', 'ftpicons', I5885, '_mod_files/ce_images', '_mod_files/60', '_mod_files/smiles'); }foreach($I1llLLI as $source) {$aFiles =getFiles($GLOBALS['ROOT_PATH'] .I5886 .$source, true, false); foreach($aFiles as $path) {$path =mb_substr($path, mb_strlen($GLOBALS['ROOT_PATH'] .I5886)); $file =basename($path); $dir =dirname($path); if( mb_strpos($file, '.') === 0 || mb_strpos($file, '_index_') === 0 || mb_strpos($dir, 'generated') !== false || preg_match(I5887, $file) ){continue; }if(!is_dir($II1l1Il .'/files/' .$dir)) {mkdir($II1l1Il .'/files/' .$dir, 0777, true); }copy($GLOBALS['ROOT_PATH'] .I5886 .$path, $II1l1Il .'/files/' .$path); $IIlILL1->add(I5888 .$path); }}foreach(array( 'custom', 'dec_common_functions.php', 'reg_common_functions.php', 'dec_front_functions.php', 'reg_front_functions.php' )as $source) {if(file_exists($basePath .I5886 .$source)) {if(is_dir($basePath .I5886 .$source)) {$aFiles =getFiles($basePath .I5886 .$source, true, false); foreach($aFiles as $path) {$path =mb_substr($path, mb_strlen($basePath .I5886)); $file =basename($path); $dir =dirname($path); if(!is_dir($II1l1Il .'/files/' .$dir)) {mkdir($II1l1Il .'/files/' .$dir, 0777, true); }copy($basePath .I5886 .$path, $II1l1Il .'/files/' .$path); $IIlILL1->add(I5888 .$path); }}else {copy($basePath .I5886 .$source, $II1l1Il .'/files/' .$source); $IIlILL1->add(I5888 .$source); }}}if(!empty($params[I5889])) {mkdir($II1l1Il .'/templates'); foreach(array(I5890, I5891) as $source) {$sql ="SELECT `name`, `path`, `content` FROM %s WHERE " ."(" ."`side` != %s AND " ."`content_default` IS NOT NULL AND " ."TRIM(" ."REPLACE(" ."REPLACE(`content`, %s, %s), " ."%s, " .I5892 .")" .") != TRIM(" ."REPLACE(" ."REPLACE(`content_default`, %s, %s), " .I5893 .I5892 .")" .")" .")"; $oQuery =DB_Query::getSnippet($sql) ->plain($source) ->q('admin') ->q(I5894)->q(I5872) ->q("\n")->q(' ') ->q(I5894)->q(I5872) ->q("\n")->q(' '); $rs =$this->db->select($oQuery->get()); while($record =$rs->nextRecord()) {if(!is_dir($II1l1Il .I5895 .$record['path'])) {mkdir($II1l1Il .I5895 .$record['path'], 0777, true); }file_put_contents($II1l1Il .I5895 .$record['path'] .$record[I5873], $record['content']); $IIlILL1->add(I5896 .$record['path'] .$record[I5873]); }}}if(!empty($params['options'])) {$aAllowedOptions =array(); if($this->cms->Core->IssetModOption('layouts', 'export_allowed_options')) {$aAllowedOptions =$this->cms->Core->GetModOption(I5897, 'export_allowed_options'); }$I1llLLl =array(); $IIII1II =$this->cms->Core->GetOwnersList(); $oCoreRules =new CMS_CoreRules($this->cms); require $GLOBALS["CONST_PATH"] ."rules_common.php"; foreach ($IIII1II as $ownerName => $ownerData) {if (file_exists($GLOBALS["CONST_PATH"] .I5898 .$ownerName .".php")) {require $GLOBALS["CONST_PATH"] .I5898 .$ownerName .".php"; }}$aModules =$this->cms->Core->GetAllModules(); foreach($aModules as $modId => $mod) {$I1llLLL =&$oCoreRules->getModule($modId); if (is_object($I1llLLL)) {$I1llLLL->TTlTTIT(); $I1llLL1 =$oCoreRules->TTIITl1($modId); if (is_array($I1llLL1) && sizeof($I1llLL1)) {$IIIlI1L =$mod->Options->TTlTII1($modId); foreach($IIIlI1L as $name => $value) {if( in_array($name, $aAllowedOptions) && serialize($value) != serialize($I1llLL1[$name]['default_value']) ){if(!isset($I1llLLl[$modId])) {$I1llLLl[$modId] =array(); }$I1llLLl[$modId][$name] =$value; }}}}}file_put_contents( $II1l1Il .I5899, serialize(array('main' => $I1llLLl) +$I1llLIl) );$IIlILL1->add('options.txt'); }$IIlILL1->save(); TT1lIll($II1l1Il); rename($basePath .I5886 .$I1llLII, $GLOBALS['ROOT_PATH'] .'_mod_files/_upload/' .$I1llLII); return $GLOBALS[I5900] .'_mod_files/_upload/' .$I1llLII; }function import($params) {$basePath =$GLOBALS['ROOT_PATH'] .'_mod_files/_upload'; foreach(array('layout', I5901) as $name) {if(empty($params[$name])) {error_log('LAYOUTS IMPORT: missing "' .$name .'" param.'); return false; }}$params[I5901] =basename($params[I5901]); require_once $GLOBALS["FUNC_INCLUDES_PATH"]."func_file_system.php"; require_once $GLOBALS[I5902] .'PHPTar.php'; $II1l1Il =$basePath .'/tmp/tmp-' .rand(1000, 9999) .I5877 .rand(1000, 9999); mkdir($II1l1Il); $IIlILL1 =new PHPTar($basePath .I5886 .$params[I5901]); $IIlILL1->extract($II1l1Il); $I1llL1I =array(); $I1llL1l =array(); if(is_dir($II1l1Il)) {$dir =opendir($II1l1Il .'/layouts'); while(($filePath =readdir($dir)) !== false) {if($filePath == '.' || $filePath == I5903) {continue; }$I1llL1l[$filePath] =file_get_contents($II1l1Il .I5882 .$filePath); }closedir($dir); $I1llLLI =array(I5884, '_mod_files/_js'); if(!empty($params['images'])) {array_push($I1llLLI, '_img', 'ftpicons', I5885, '_mod_files/ce_images', '_mod_files/60', '_mod_files/smiles'); }foreach($I1llLLI as $source) {$aFiles =getFiles($II1l1Il .'/files/' .$source, true, false); foreach($aFiles as $path) {$path =mb_substr($path, mb_strlen($II1l1Il .'/files/')); $dir =dirname($path); if(!is_dir($GLOBALS[I5904] .I5886 .$dir)) {mkdir($GLOBALS[I5904] .I5886 .$dir, 0777, true); }if(!preg_match(I5887, $path)) {copy($II1l1Il .'/files/' .$path, $GLOBALS[I5904] .I5886 .$path); }}}if(is_dir($II1l1Il .'/files/custom')) {$aFiles =getFiles($II1l1Il .'/files/custom', true, false); foreach($aFiles as $path) {$path =mb_substr($path, mb_strlen($II1l1Il .'/files/custom/')); if( (($this->cms->Core->HostMode() &HOSTMODE_SHARED) != 0) ?!preg_match(I5887, $path) :(preg_match(I5887, $path) ?!file_exists($path) :true) ){$dir =dirname($path); if(!is_dir($GLOBALS[I5904] .I5905 .$dir)) {mkdir($GLOBALS[I5904] .I5905 .$dir, 0777, true); }copy($II1l1Il .'/files/custom/' .$path, $GLOBALS[I5904] .I5905 .$path); }}}if(!empty($params[I5889]) && is_dir($II1l1Il .'/templates')) {$aFiles =getFiles($II1l1Il .'/templates', true, false); foreach($aFiles as $path) {if(mb_substr($path, -4) != '.tpl' && mb_substr($path, -4) != I5906) {continue; }$path =mb_substr($path, mb_strlen($II1l1Il .I5895)); $file =basename($path); $dir =dirname($path); if(!is_dir($GLOBALS[I5904] .I5886 .$dir)) {mkdir($GLOBALS[I5904] .I5886 .$dir, 0777, true); }copy($II1l1Il .I5895 .$path, $GLOBALS[I5904] .I5886 .$path); $content =file_get_contents($GLOBALS[I5904] .I5886 .$path); $this->cms->Gui->_putFileContentToDb( $this->db, $dir .I5886, $file, time(), $content, preg_match('/\.lng$/', $file), true, false, true, false );}}if(!empty($params['options']) && file_exists($II1l1Il .I5899)) {$I1llL1I =unserialize(file_get_contents($II1l1Il .I5899)); if(is_array($I1llL1I) && is_array($I1llL1I['main']) && count($I1llL1I['main'])) {$aModules =$this->cms->Core->GetAllModules(); foreach($aModules as $modId => $mod) {if(isset($I1llL1I[I5907][$modId])) {foreach($I1llL1I[I5907][$modId] as $name => $value) {$mod->setOption($name, $value); }}}}$this->cms->Core->saveOptions(); }if((($this->cms->Core->HostMode() &HOSTMODE_SHARED) == 0)) {$oStorage =AMI::getResource('storage/fs'); $I1llL1L =new AMI_Tx_Package_Storage(); foreach(array('common_functions.php', 'front_functions.php') as $file) {$oArgs =new AMI_Tx_Cmd_Args( array( 'hypermod' => I5908, 'config' => '_design_code', 'pkgId' => '_design_code', I5909 => '_design_code', 'mode' => 'override', 'target' => $GLOBALS[I5904] .I5905 .$file, I5910 => $oStorage ));$I1llL1L->addCommand(I5911, $oArgs); $I1llL1L->start('design cleanup'); $I1llL1L->commit(); if(!file_exists($II1l1Il .'/files/dec_' .$file) || !file_exists($II1l1Il .'/files/reg_' .$file)) {continue; }$oArgs =new AMI_Tx_Cmd_Args( array( 'hypermod' => I5908, I5912 => '_design_code', 'pkgId' => '_design_code', I5909 => '_design_code', I5913 => 'override', 'handlerRegistrationSource' => $II1l1Il .'/files/reg_' .$file, 'handlerDeclarationSource' => $II1l1Il .I5914 .$file, 'target' => $GLOBALS[I5904] .I5905 .$file, I5910 => $oStorage ));$I1llL1L->addCommand(I5915, $oArgs); $I1llL1L->start(I5916); $I1llL1L->commit(); }}TT1lIll($II1l1Il); }else {error_log('LAYOUTS IMPORT: unable to extract archive.'); return false; }$I1llL11 =$this->cms->Core->GetModOption(I5897, 'mobile_layout_id'); if(!empty($params['delete_layouts'])) {$this->db->query('delete from `cms_layouts` where `lang` = "' .$this->cms->lang_data .'"'); }foreach($I1llL1l as $filename => $layout) {$I1llI1L =array(); $I1lllL1 =$this->TIT1l1l($layout, $I1llI1L); if($I1lllL1 >0) {continue; }$I1ll1II =$this->TIT1l11($I1llI1L, 1); $asql =array( I5865 => $this->cms->lang_data, "filename" => mb_substr($filename, 0, mb_strrpos($filename, ".")) )+$I1ll1II; $sql =$this->db->GenInsertSQL("cms_layouts", $asql); $this->db->query($sql); $id =$this->db->lastInsertId(); $I1ll1Il =array(); foreach($params[I5917] as $I1ll1IL => $I1ll1I1) {if($I1ll1I1 == $filename) {$I1ll1Il[] =$I1ll1IL; }if($I1ll1IL =$I1llL11) {$I1llL11 =$id; }}if(count($I1ll1Il) >0) {$asql =Array('lay_id' => $id); for ($i =1; $i <= $this->cms->PManager->GetProperty("template_blocks_number"); $i++) {if ($I1ll1II["lay_f" .$i ."_type"] != I5853) {$asql[I5918 .$i ."_body"] =$I1ll1II[I5918 .$i ."_body"]; $asql[I5918 .$i ."_body"] ="=|IF( block_mask & ( 1 << (" .$i .I5919 .$i ."_body,'" .$I1ll1II[I5918 .$i ."_body"] ."')"; }else {$asql[I5918 .$i ."_body"] =I5853; }}$sql =$this->db->GenUpdateSQL(I5920, $asql, 'WHERE `lay_id` in (' .implode(',', $I1ll1Il) .')'); $this->db->query($sql); if(is_array($I1llL1I[$filename]) && count($I1llL1I[$filename]) >0) {$rs =$this->db->select('SELECT `id`, `sb_data` FROM `cms_pages` WHERE `lay_id` = ' .$id); while($record =$rs->nextRecord()) {$oDB =new DB_Si(); $oDB->query( 'UPDATE `cms_pages` SET `sb_data` = \'' .serialize($I1llL1I[$filename] +unserialize($record['sb_data'])) .'\' WHERE `id` = ' .$record['id'] );}}}}$this->cms->Core->SetModOption(I5897, 'mobile_layout_id', $I1llL11); $this->cms->Core->SaveOptions(I5897); AMI::getResource(I5921)->reset(); $this->cms->Core->Cache->ClearCacheNow(); return true; }function TIT11IT($file) {require_once $GLOBALS[I5902] .'PHPTar.php'; $IIlILL1 =new PHPTar($file); return $this->TIT11II($IIlILL1->meta()); }function TIT11II($data) {$ret =array(); if(!is_string($data)) {return $ret; }$data =explode("\r\n", $data); foreach($data as $line) {$vars =explode('=', $line); if(count($vars) >1 && in_array($vars[0], $this->I1lI11l)) {$ret[$vars[0]] =$vars[1]; }}return $ret; }function TIT11Il($params) {$meta =I5872; foreach($params as $key => $value) {if(in_array($key, $this->I1lI11l)) {$meta .= $key .'=' .mb_substr($value, 0, 20) .I5922; }}return $meta; }}?>
