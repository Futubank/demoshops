<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       25448 xkqwkxiwkptklwpypqgxglzsnttuzrwmuqsrksyxywziwsinknwwqnzgitlmpkqrgpqwpnir
 */ ?><?php foreach(array(5963=>'',5964=>'PrHuG|HGQrZtMHnD',5965=>"ZJJHCQS|ZWtMHnD",5966=>"DZvQ",5967=>'wjzddqd|gzTo',5968=>'wid|iQIYQr`GOG',5969=>"ZWtMvZtQ",5970=>"MIGHrt",5971=>"",5972=>"tQxt",5973=>"fJt|QIZMJ",5974=>"?JMKQ?",5975=>"OQZSQr",5976=>"Hn|WOZnPQ",5977=>"ZWtMvQ",5978=>"tZYJQD",5979=>"LHMnD",5980=>"MS",5981=>"|JMDt%ZWtMvQ|Hff",5982=>"JZDtnZIQ",5983=>"ZWtMHn",5984=>"HYLQWt",5985=>"DQt",5986=>"ZGGJMQS|MS",5987=>"JQP|rQS",5988=>"JQP|SQJ",5989=>"WZnWQJ",5990=>"qigTb|gzddchRs",5991=>"WOZnPQ|DQttMnPD",5992=>"rQPMDtQr",5993=>'WZGtWOZ|DWrMGt',5994=>"rQPMDtQr|fHrI",5995=>"ZSv|ZSvQrtMDQrD",5996=>"vZrD",5997=>"0",5998=>"rQS",5999=>"|zWtMHnzWtMvZtQ",6000=>"DtZtuD|QrrHr",6001=>"CQYDMtQ",6002=>"WOQWKQS",6003=>"IQtOHS",6004=>"uDQrnZIQ",6005=>"GZDDCHrS",6006=>"DJZDOQD",6007=>"DtZtuD|PrG|rQDQt",6008=>"WrQZtQ",6009=>'QIZMJ',6010=>'JHPMn|fMQJS',6011=>'zuSMthYLQWt`GOG',6012=>"zsimN|gzTo|ccc",6013=>"fMrDtnZIQ",6014=>"wjzddqd|gzTo",6015=>"iHSuJQzSvzSvQrtMDQrD%|frHntzSSzSvQrtMDQrFHriQIYQr?DQnSMnP?QIZMJ?tH?",6016=>"ZSv|IZMJD",6017=>"WHIGZnB|urJ",6018=>"QIZMJ",6019=>"iZMJQr`GOG",6020=>"iHSuJQzSvzSvQrtMDQr%|zWtMHnzGGJB?DQnSMnP?QIZMJ?tH?") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleAdvAdvertisers extends CMS_ActModule {public $user; public $oEshop; function ModuleAdvAdvertisers(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_format.php"); $this->oEshop =NULL; }function _Init($IIll1l1 =Array(), $IIll1LI =I5963, $IIll1Ll =I5963, $aOptions =Array()) {$IIIIL11['default_prefix'] ='m'; $IIIIL11["lang_data"] =false; $IIIIL11['check_public'] =false; $IIIIL11[I5964] =Array("active_on", "active_off", "reset", "del"); $IIIIL11[I5965] =Array("activate", "add", "edit", "apply", I5966, "del", "reset"); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); if($this->cms->Core->IsInstalled("eshop_cart")){ if($this->cms->Core->Side == "admin"){ require_once $GLOBALS[I5967] .'EshopAdmin.php'; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init("eshop_item"); }}}function _InitAdmin() {parent::_InitAdmin(); require_once $GLOBALS[I5967] .'CMS_Member.php'; require_once $GLOBALS[I5967] .'Advertisers.php'; $none =array(); $this->user =new Advertisers($none); }function TTTlTI1() {parent::TTTlTI1(); require_once $GLOBALS[I5967] .I5968; require_once $GLOBALS[I5967] .'Advertisers.php'; $this->user =new Advertisers($GLOBALS["oSession"]); }function TTTlITT($IIIL11l, $cId, $cModule ="") {$id =intval($cId); if($this->side == "admin"){ switch ($IIIL11l) {case I5969: $this->_ActionActivate($cId, $cModule); break; case "reset": $this->_ActionReset($cId, $cModule); break; case "grp_active_on": $this->TIITTl1($this->aGroupIds, $cModule); break; case "grp_active_off": $this->TIITT1T($this->aGroupIds, $cModule); break; case "grp_reset": $this->TIITT1I($this->aGroupIds, $cModule); break; case I5970: $this->TTIITT1($cId, $cModule); break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}else{ switch ($IIIL11l) {case "change_settings": $this->TIITT1l($cId, $cModule); break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}}function TTTlIII() {parent::TTTlIII(); $this->filter->AddField("flt_lastname", "text", stripslashes(unhtmlentities($this->cms->Vars["flt_lastname"])), I5971, " like ", "m.lastname"); $this->filter->MoveField("flt_lastname",_MOVE_START); $this->filter->AddField("flt_firstname", I5972, stripslashes(unhtmlentities($this->cms->Vars["flt_firstname"])), I5971, " like ", "m.firstname"); $this->filter->MoveField("flt_firstname",_MOVE_START); $this->filter->AddField(I5973, I5972, stripslashes(unhtmlentities($this->cms->Vars[I5973])), I5971, " like ", "m.email"); $this->filter->MoveField(I5973,_MOVE_START); $this->filter->AddField("flt_username", I5972, stripslashes(unhtmlentities($this->cms->Vars["flt_username"])), I5971, I5974, "m.username"); $this->filter->MoveField("flt_username",_MOVE_START); }function TTTlI1I(&$vData) {$I1lLII1 =$this->user->getScripts($this->cms, "cms_adv_advertisers"); $vData["header_memeber_script"] =$I1lLII1[I5975]; $vData["check_member_script"] =$I1lLII1["check_form"]; if($this->action != "add") {$vData["on_change_member_script"] =$I1lLII1[I5976]; }$vData["member_form"] =$this->user->getForm($this->cms, $this->db, $this->itemData); if(!is_null($this->oEshop)){ $vData["curr_postfix"] =$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency); if(!empty($vData["curr_postfix"])) {$vData["curr_prefix"] =$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency); }}if(!isset($this->itemData[I5977])) $this->itemData[I5977] ="checked"; parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {$this->browser->InitSQL("m.id, m.username, m.firstname, m.lastname, m.email, m.company, (m.active & a.active) as active, date_format(m.date,'".$this->cms->DFMT["db"]."') as fdate, m.balance", Array(I5978=>Array("m"=>"cms_members", "a"=>"cms_adv_advertisers"), I5979=>Array("m|a"=>"a.id_member=m.id") ),"WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), I5971, "name", I5971, Array(I5977=>"(m.active & a.active)", "balance"=>"m.balance"), _DB_STRAIGHT_JOIN );$this->browser->AddSQLJoinedTables($this->cms->Core, "m", Array("a"=>"cms_adv_advertisers")); $aCustom["fields"] += Array( I5977=>Array("action"=>"flagicon", "value"=>1, I5980=>"act_id", "on"=>$this->moduleName."_list:active_on","off"=>$this->moduleName.I5981), "username"=>Array("action"=>"stripline", "size"=>50), I5982=>Array("action"=>"stripline", "size"=>50), "firstname"=>Array(I5983=>"stripline", "size"=>50), "balance"=>Array(I5983 => "callback", I5984=>&$this, "method"=>"_getBalanceCB"), "actions"=>Array(I5983=>"actions", I5985=>$this->moduleName."_list:icons_edit_reset_del", I5980=>Array("edit_id", "del_id", "reset_id")), );$aCustom[I5986] ="m.id"; $aCustom["legend"] =Array("onactive", "notactive", I5987, "leg_yellow", "leg_blue", "leg_edit", "leg_reset", I5988); $aCustom["form_data"]["buttons"] =Array("add", "apply", I5989, I5966); parent::TTTlI11($vData, $aCustom); }function TTTllTI(&$aCustom) {$this->SetBodyType("body_register"); parent::TTTllTI($aCustom); }function &TTTllTl(&$aCustom) {global $ROOT_PATH_WWW; return parent::TTTllTl($aCustom); }function TTTll1T(&$vData, &$aCustom) {$this->cms->SetsTemplate =$this->moduleName."_list"; if($this->cms->Member->isLoggedIn()){ $this->cms->Gui->AddGlobalVars(Array("FORM_MODE" => "EDIT")); $I1lLIlI =$this->cms->Member->getUserInfo(); $I1lLIll =Array( I5990 => "1", "EDIT_USERNAME" => "0" );$this->cms->Gui->addGlobalVars($I1lLIll); $this->cms->Member->setUsed("username", false); $I1lLIlL =I5991; $sql ="select count(*) as count from cms_adv_advertisers where id_member='".$this->cms->Member->getUserInfo(I5980)."'"; $this->db->query($sql); $this->db->next_record(); if($this->db->Record["count"] >0) $I1lLIlL =I5971; }else{ $this->cms->Member->setObligatory('password', true); $I1lLIlL =I5992; $IIlLIIL =Array(I5983=>"fill_front_data", I5980=>I5971, "data"=>&$vData, "custom"=>&$aCustom); $this->TTT1lI1($IIlLIIL); $I1lLIlI =$vData; $I1lLIlI["member_form"] =$this->cms->Member->getForm($this->cms, $this->db, $I1lLIlI); $I1lLIl1 =isset($I1lLIlI[I5993]) ?$this->cms->Member->getScripts($this->cms, I5963, $I1lLIlI) :$this->cms->Member->getScripts($this->cms); $vData["header_memeber_script"] =$I1lLIl1[I5975]; $vData["check_member_script"] =$I1lLIl1["check_form"]; $vData["on_change_member_script"] =$I1lLIl1[I5976]; }if(!empty($I1lLIlL)) {$vData[I5994] =$this->cms->TTITI1l($I1lLIlL, "form", $I1lLIlI); }}function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {$aData =Array(); $aData["front_link"] =$this->module->GetFrontLink(); $vRes["body"] =I5971; if($this->module->IsPresentInPMandPublic()) {$aData["style_selected"] =I5971; if($this->cms->ActivePage == I5995){ $I1lLILI =$this->cms->Gui->getAbs($this->moduleName."_list:special_selected_style", I5971); $aData["style_selected"] =$I1lLILI; }$userId =$this->cms->Member->getUserInfo(I5980); if($userId >0){ $sql ="select count(*) as count from cms_adv_advertisers where id_member=".intval($userId); $this->db->query($sql); $this->db->next_record(); if($this->db->Record["count"] <= 0) {$vRes[I5995][I5996] =$aData; $vRes[I5995]["default"] =$this->cms->Gui->get($this->moduleName."_list:special_menu_list", $aData); }}else {$vRes[I5995][I5996] =$aData; $vRes[I5995]["default"] =$this->cms->Gui->get($this->moduleName."_list:special_menu_list", $aData); }}}function _ActionActivate($cId, $cModule) {$active =I5997; if (isset($this->cms->VarsGet[I5969]) && $this->cms->VarsGet[I5969] == "on") {$active ="1"; }if($this->user->TTTT1II($this->cms, $this->db, $cId, $active)) {$this->cms->AddStatusMsg("status_activate"); if($active == 1) $this->TIITITT($cId); }else {$this->cms->AddStatusMsg("status_activate_fail", I5998); }$this->appliedId =$cId; $this->browser->SetApplied($this->db, $asql, $this->langData); }function TIITTl1(&$aGroupIds, $cModule) {$this->cms->VarsGet[I5969] ="on"; $this->TTTl1II($aGroupIds, $cModule, "_ActionActivate", "status_grp_activate"); }function TIITT1T(&$aGroupIds, $cModule) {$this->cms->VarsGet[I5969] ="off"; $this->TTTl1II($aGroupIds, $cModule, I5999, "status_grp_unactivate"); }function TTTll11($cId, $cModule) {$IlIl1LI =$this->cms->VarsPost; $id_user =$this->user->createUser($this->cms, $this->db, $IlIl1LI, false, false); if($id_user >0) {$this->appliedId =$id_user; $this->browser->SetApplied($this->db, $asql, $this->langData); $this->SetLastError(); $this->cms->AddStatusMsg("status_add"); }else {$this->itemData =removeSpecial($IlIl1LI, "slashes"); $this->SetLastError(1, "Adding failed"); $this->cms->AddStatusMsg(I6000, I5998); }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT m.*, a.active as adv_active FROM cms_members m ". "INNER JOIN cms_adv_advertisers a ON a.id_member=m.id ". "WHERE m.id='".$cId."'".$this->_ApplyFilters();; $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData[I6001] =$this->itemData["companyweb"]; $this->itemData["balance"] =formatNumber($this->itemData["balance"], 2, 2, false, true); $this->itemData[I5977] =$this->db->Record["adv_active"] ?I6002 :I5971; $ILLL1L1 =Array( "items" => I5971, "fields" => Array("balance" => Array(I5983 => "callback", I5984=>&$this, I6003=>"_getBalanceCB")), );$this->itemData["balance_history"] =$this->TTT1lT1($this->itemData["balance_history"], $ILLL1L1); }$this->cms->Gui->AddGlobalVars(Array(I5990 => "1")); }function TTTl1lI($cId, $cModule) {$IlIl1LI =$this->cms->VarsPost; if($IlIl1LI[I6004] == I5971) {unset($IlIl1LI[I6004]); $this->user->SetObligatory(I6004); }$sql ="SELECT balance FROM cms_members WHERE id='$cId'"; $this->db->query($sql); $this->db->next_record(); $I1lLILl =doubleval($this->cms->Vars["balance"] -$this->db->Record["balance"]); $id_user =$this->user->TTTT1T1($this->cms, $this->db, $cId, $IlIl1LI, true, "%%hist_balance_admin_form%%"); if($id_user >0) {$is_hash =!empty($this->cms->VarsPost["password_hash"]); if($is_hash || (!empty($this->cms->VarsPost[I6005]) && $this->cms->VarsPost[I6005]==$this->cms->VarsPost["password2"])) {$this->user->TTI1I1l(I6004, $this->cms->VarsPost[I6004]); $this->user->TTI1I1l(I5980, $cId); $this->user->setPass($this->db, $is_hash ?$this->cms->VarsPost["password_hash"] :$this->cms->VarsPost[I6005], $is_hash); }$this->appliedId =$id_user; $this->browser->SetApplied($this->db, $asql, $this->langData); if($I1lLILl != 0){ $sql ="insert into cms_adv_cash set lang='".$this->langData."', id_member='$id_user', id_campaign=0, price='$I1lLILl', description='%%order_balance_admin_form%%', date=NOW()"; $this->db->query($sql); }$I1lLILL =1; if($this->cms->VarsPost[I5977] == 1){ $sql ="SELECT active FROM cms_adv_advertisers WHERE id_member='$id_user'"; $this->db->query($sql); $this->db->next_record(); $I1lLILL =$this->db->Record[I5977]; }if($this->user->TTTT1II($this->cms, $this->db, $id_user, $this->cms->VarsPost[I5977]) && $I1lLILL == 0){ $this->TIITITT($id_user); }$this->SetLastError(); $this->cms->ClearMessages(); $this->cms->AddStatusMsg("status_apply"); }else {$this->itemData =removeSpecial($IlIl1LI, I6006); $this->SetLastError(2, "Apply failed"); $this->cms->AddStatusMsg(I6000, I5998); }}function _ActionDel($cId, $cModule) {$this->user->TTTT1IT($this->cms, $this->db, $cId); $this->cms->AddStatusMsg("status_del"); $this->SetLastError(); }function _ActionReset($cId, $cModule) {$this->user->TTI1lIl($this->cms, $this->db, $cId, true); $this->cms->AddStatusMsg("status_reset"); $this->appliedId =$cId; $this->browser->SetApplied($this->db, $asql, $this->langData); }function TIITT1I(&$aGroupIds, $cModule) {$this->TTTl1II($aGroupIds, $cModule, "_ActionReset", I6007); }function _getBalanceCB(&$vItem, &$vData) {if(!is_null($this->oEshop)) $vItem["balance"] =$this->oEshop->formatMoney(doubleval($vItem["balance"]), $this->oEshop->baseCurrency); else $vItem["balance"] =FormatNumber(doubleval($vItem["balance"]), 2, 2, false); }function TTT1ITI($cId, $cModule){ $I1lLIlI =$this->cms->VarsPost; if(isset($this->cms->VarsPost[I6008]) && $this->cms->VarsPost[I6008]==1) {$I1lLIlI["ip"] =getenv("REMOTE_ADDR"); if($this->cms->Member->createMember($this->cms, $this->db, $I1lLIlI, true)) {$this->cms->Member->verifyLogin($this->cms, $I1lLIlI[I6004], $I1lLIlI[I6005]); $this->cms->Member->updateCacheStatus(); $this->cms->AddStatusMsg("status_add"); if($this->TIITT11($this->cms->Member->getUserInfo(I5980))){ $this->cms->AddStatusMsg("status_advertiser_created"); }}else{ $I1lLIL1 =$this->cms->Member->TTI1I1I(); $field =$this->cms->Member->getLoginField(); if(in_array(I6009, $I1lLIL1)){ $field =I6009; }elseif(!in_array('username', $I1lLIL1)){ $field ='nickname'; }$this->cms->AddStatusMsg('status_found', 'red', I5963, I5963, array(I6010 => $this->cms->Messages['login_field_' .$field])); }}}function TIITT1l($cId, $cModule){ if($this->cms->VarsPost["conf"]==1 && $this->TIITT11($this->cms->Member->getUserInfo(I5980))){ $this->cms->AddStatusMsg("status_advertiser_created"); }else{ $this->cms->AddStatusMsg("status_update_fail", I5998); }}function TIITT11($idMember){ $sql ="select CONCAT(lastname, ' ', firstname, ' (', username, ')') as realusername from cms_members where id='".$idMember."'"; $this->db->query($sql); if($this->db->next_record()){ $IILIllL =array( "id_member" => $idMember, I5977 => 0, );$userName =$this->db->Record["realusername"]; $sql =$this->db->GenInsertSql("cms_adv_advertisers", $IILIllL); $this->db->query($sql); $I1lLI1I =$this->db->lastInsertId(); require_once $GLOBALS[I5967] .I6011; $this->ILLLLlI =new AuditObject($this->cms, $this->db); $this->ILLLLlI->Init($idMember, $this->moduleName, $userName); $this->ILLLLlI->SetOwner($idMember); $this->ILLLLlI->TTTT11T($idMember); $this->ILLLLlI->TTTT1l1("add"); $sql ="select * from cms_members where id=".intval($idMember); $this->db->query($sql); if($this->db->next_record()){ $this->cms->Gui->addBlock("adv_mails", $GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/letters/advertisement_" .$this->langData .".tpl"); $mailData =$this->db->Record; $mailData["SITE"] =$this->cms->Core->GetOption("company_url"); $mailData["MANAGE_URL"] =$GLOBALS[I6012].$this->module->GetAdminLink()."?action=locate&id=".$idMember."#anchor"; $mailData["ADVERTISER_NAME"] =$mailData[I5982]." ".$mailData[I6013]; $mailData["ADVERTISER_LOGIN"] =$mailData[I6004]; $ILLl1ll =$this->cms->Gui->get("adv_mails:adv_mail_header", $mailData). $this->cms->Gui->get("adv_mails:mail_advertiser_added", $mailData). $this->cms->Gui->get("adv_mails:adv_mail_footer", $mailData); require_once($GLOBALS[I6014]."Mailer.php"); $oMail =new Mailer(); $oMail->RecipientAddress =$this->cms->Core->GetOption("company_email"); $oMail->RecipientName =I5971; $oMail->SenderAddress =$this->cms->Core->GetOption("company_robot_email"); $oMail->SenderName =$this->cms->Core->GetOption("company_name"); $oMail->Subject =$this->cms->Gui->get("adv_mails:mail_advertiser_added_subject", $mailData); $oMail->Body =$ILLl1ll; $oMail->BodyFormat ="html"; $oMail->Prepare(); if(!$oMail->Send()){ trigger_error(I6015.$this->cms->Core->GetOption("company_email")." failed", E_USER_WARNING); }}return true; }return false; }function TIITITT($id_user){ $sql ="select * from cms_members where id=".intval($id_user); $this->db->query($sql); if($this->db->next_record()){ $this->cms->Gui->addBlock(I6016, $GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/letters/advertisement_" .$this->langData .".tpl"); $mailData =$this->db->Record; $mailData["SITE"] =$this->cms->Core->GetOption(I6017); $mailData["ADVERTISER_NAME"] =$mailData[I5982]." ".$mailData[I6013]; $mailData["ADVERTISER_LOGIN"] =$mailData[I6004]; $mailData["ADVERTISER_EMAIL"] =$mailData[I6018]; $ILLl1ll =$this->cms->Gui->get("adv_mails:adv_mail_header", $mailData). $this->cms->Gui->get("adv_mails:mail_advertiser_approved", $mailData). $this->cms->Gui->get("adv_mails:adv_mail_footer", $mailData); if(!empty($mailData["ADVERTISER_EMAIL"])){ require_once($GLOBALS[I6014].I6019); $oMail =new Mailer(); $oMail->RecipientAddress =$mailData["ADVERTISER_EMAIL"]; $oMail->RecipientName =$mailData["ADVERTISER_NAME"]; $oMail->SenderAddress =$this->cms->Core->GetOption("company_robot_email"); $oMail->SenderName =$this->cms->Core->GetOption("company_name"); $oMail->Subject =$this->cms->Gui->get("adv_mails:mail_advertiser_approved_subject", $mailData); $oMail->Body =$ILLl1ll; $oMail->BodyFormat ="html"; $oMail->Prepare(); if(!$oMail->Send()){ trigger_error(I6020.$mailData["ADVERTISER_EMAIL"]." failed", E_USER_WARNING); }}}}}