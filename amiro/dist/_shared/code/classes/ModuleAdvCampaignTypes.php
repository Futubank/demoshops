<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       43580 xkqwxrmimssmukylpxzqkzsmzpsmutsksxkpsxsrqpgtxskggrmxkqrwiwtzlzlxwtsxpnir
 */ ?><?php foreach(array(6093=>"",6094=>"SQfZuJt|GrQfMx",6095=>'qDOHGzSIMn`GOG',6096=>"'?HrSQr?YB?nZIQ",6097=>"?JMKQ?",6098=>"fJt|tBGQ|PrHuG",6099=>"=",6100=>"nZIQ",6101=>"fJt|GJZWQ|MS",6102=>"MSD|GJZWQD",6103=>"SZtQtH",6104=>"IHSuJQ",6105=>"MSD|GJZWQD|Zrr",6106=>"tBGQ|PrHuGD|Zrr",6107=>"0",6108=>"WHDt",6109=>"Wurr|GrQfMx",6110=>"vZJuQ",6111=>"MS|GJZWQD|Zrr",6112=>"MS|GJZWQD|SZtZ",6113=>"tBGQ|PrHuGD",6114=>"t`nZIQ",6115=>"fJZPMWHn",6116=>"Hff",6117=>'HYLQWt',6118=>'WZJJYZWK',6119=>'|PQtmSDgJZWQDwy',6120=>"ZWtMHn|QSMt",6121=>"Hn",6122=>"GuYJMDOQS",6123=>"JQP|QSMt",6124=>"ZGGJB",6125=>"HGt|SQf|IZx|vMQCD",6126=>"HGt|SQf|IZx|WJMWKD",6127=>"OZD|SurZtMHn",6128=>"HGt|SQf|JMfQtMIQ",6129=>"'",6130=>"ZJJHC|rQDQrvQ",6131=>"DQJQWtQS",6132=>"SZB",6133=>"?",6134=>"{",6135=>"IZx|vMQCD",6136=>"HGt|SQf|GrMHrMtB",6137=>"MS|GJZWQ",6138=>"tBGQ|PrHuG",6139=>"^",6140=>"IZx|MtQID",6141=>"YHSB|MtQID",6142=>"DQZrWO|fMQJS",6143=>"MS",6144=>"fJt|rQnQC",6145=>"Qxt|ZSv|ZuSMt",6146=>"YZnnQrD|nuI",6147=>"MtQI|",6148=>'YZJZnWQ',6149=>"t`MS",6150=>"fMQJSD",6151=>"|PQtmSwy",6152=>"WZJJYZWK",6153=>"ZWtMHn",6154=>"HYLQWt",6155=>"YZnnQr|tBGQ|",6156=>"YZnnQr|OQMPOt",6157=>'',6158=>"DtZtuD|nHWZDO",6159=>'tIG|WIGIZxvMQC',6160=>"tIG|WrQZtQSWIGPMS",6161=>'tIG|WrQZtQSWIGPMS',6162=>"<ZnWOHr",6163=>"tIG|WIGIZxvMQC",6164=>"IZx|WHDt|WJMWK",6165=>"WHDt|vMQC",6166=>"ZSv|WZIGZMPn|tBGQD",6167=>"YHSB",6168=>"1",6169=>'MS',6170=>'tIG|WIGPMS',6171=>"HdQDDMHn",6172=>"GJZWQ|OQMPOt",6173=>"'{{{",6174=>"'{",6175=>"MS|tBGQ",6176=>"=_szTq|zss}'",6177=>"IZx|vMQCD|SZB",6178=>"JZnP",6179=>"WID|ZSv|WZIGZMPnD",6180=>"ZSv|WZIGZMPnD",6181=>"izNzpq|URj",6182=>"QIZMJ",6183=>"uDQrnZIQ",6184=>"iZMJQr`GOG",6185=>"OtIJ",6186=>"iHSuJQzSvwZIGZMPnTBGQD%|FrHntzWtMHnzSS?DQnSMnP?QIZMJ?tH?",6187=>'tIG|nHYZnnQrD') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleAdvCampaignTypes extends CMS_ActModule {public $IIllLI1; public $I1lLllI; public $member; public $oEshop; public $I1lLlll; public $I1lLllL; public $I1lLll1; public $I1lLlLI; public $I1lLlLl; function ModuleAdvCampaignTypes(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->IIllLI1 =array(); $this->I1lLllI =array(); $this->member =&$cms->Member; $this->oEshop =NULL; $this->I1lLlll =""; $this->I1lLllL =""; $this->I1lLll1 =array(); $this->I1lLlLI =array(); $this->I1lLlLl =false; }function _Init($IIll1l1 =Array(), $IIll1LI =I6093, $IIll1Ll =I6093, $aOptions =Array()) {$IIIIL11["group_operations"] =Array("publish_on", "publish_off", "del"); $IIIIL11[I6094] ="t"; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); if($this->cms->Core->IsInstalled("eshop_cart")){ if($this->cms->Core->Side == "admin"){ require_once $GLOBALS['CLASSES_PATH'] .I6095; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init("eshop_item"); }else{ CreateEshop($this->cms); $this->oEshop =&$this->cms->Eshop; }$this->I1lLllL =$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency); if(!empty($this->I1lLllL)) {$this->I1lLlll =$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency); }}if(is_null($this->oEshop)){ require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_format.php"); }}function _InitAdmin() {parent::_InitAdmin(); $sql ="select * from cms_adv_places where lang='".$this->langData.I6096; $this->db->query($sql); while($this->db->next_record()) $this->IIllLI1[] =$this->db->Record; $sql ="select id, name from cms_adv_campaign_types_groups where lang='".$this->langData.I6096; $this->db->query($sql); while($this->db->next_record()) $this->I1lLllI[] =$this->db->Record; }function TTTlIII() {parent::TTTlIII(); $this->filter->AddField("flt_code", "text", stripslashes(unhtmlentities($this->cms->Vars["flt_code"])), I6093, I6097, "code"); $this->filter->MoveField("flt_code",_MOVE_START); if(empty($this->cms->Vars["flt_code"])) $this->filter->DisableFieldSQL("flt_code"); $groupId =intval(isset($this->cms->VarsPost[I6098]) ?$this->cms->VarsPost[I6098] :$this->cms->VarsGet[I6098]); $aGroups =Array(); $aGroups =$this->filter->TITI1TT($aGroups, Array($this->cms->Words["all"]=>0), 55); for($i =0; $i <count($this->I1lLllI); $i++) $aGroups =$this->filter->TITI1TT($aGroups, Array($this->I1lLllI[$i]["name"] => $this->I1lLllI[$i]["id"]), 500); $this->filter->AddField(I6098, "select", $groupId, I6093, I6099, "type_group", $aGroups); $this->filter->MoveField(I6098, _MOVE_START); if($groupId==0) $this->filter->DisableFieldSQL(I6098); $this->filter->AddField("flt_name", "text", stripslashes(unhtmlentities($this->cms->Vars["flt_name"])), I6093, I6097, I6100); $this->filter->MoveField("flt_name",_MOVE_START); if(empty($this->cms->Vars["flt_name"])) $this->filter->DisableFieldSQL("flt_name"); $placeId =intval(isset($this->cms->VarsPost["flt_place_id"]) ?$this->cms->VarsPost[I6101] :$this->cms->VarsGet[I6101]); $I1lLlLL =Array(); $I1lLlLL =$this->filter->TITI1TT($I1lLlLL, Array($this->cms->Words["all"]=>0), 55); for($i =0; $i <count($this->IIllLI1); $i++) $I1lLlLL =$this->filter->TITI1TT($I1lLlLL, Array($this->IIllLI1[$i][I6100] => $this->IIllLI1[$i]["id"]), 500); $this->filter->AddField(I6101, "select", $placeId, I6093, "like", I6102, $I1lLlLL); $this->filter->MoveField(I6101, _MOVE_START); $this->filter->TITIll1(I6101); if($placeId==0) {$this->filter->DisableFieldSQL(I6101); }else{ $this->filter->TITI1II(I6101, " OR ids_places like '%;".intval($placeId).";%'", "force"); }$this->filter->TITI1l1("datefrom"); $this->filter->TITI1l1(I6103); }function TTTlITT($IIIL11l, $cId, $cModule =I6093) {parent::TTTlITT($IIIL11l, $cId, $cModule); }function &TTTlI1T(&$aCustom) {return parent::TTTlI1T($aCustom); }function TTTlI1I(&$vData) {$vData["ids_places_arr"] =array(); $vData["id_places_arr"] =array(); for($i =0; $i <sizeof($this->IIllLI1); $i++){ $vData[$this->IIllLI1[$i]["source_type"] == I6104 ?"id_places_arr" :I6105][] =array( I6100 => $this->IIllLI1[$i][I6100], "value" => $this->IIllLI1[$i]["id"], "selected" => I6093 );}$vData["type_groups_arr"] =array(); for($i =0; $i <sizeof($this->I1lLllI); $i++){ $vData[I6106][] =array( I6100 => $this->I1lLllI[$i][I6100], "value" => $this->I1lLllI[$i]["id"], "selected" => I6093 );}$vData["max_items"] =I6107; $vData["opt_def_max_views"] =I6107; $vData["opt_def_max_clicks"] =I6107; $vData["opt_def_lifetime"] =I6107; $vData["opt_def_max_views_day"] =I6107; $vData[I6108] =I6107; $vData["cost_view"] =I6107; $vData["cost_click"] =I6107; $vData["curr_postfix"] =$this->I1lLllL; if(!empty($vData["curr_postfix"])) {$vData[I6109] =$this->I1lLlll; }parent::TTTlI1I($vData); $vData['form_width'] ='100%'; }function TTTlI11(&$vData, &$aCustom) {for($i =0; $i <sizeof($vData[I6105]); $i++){ $vData[I6105][$i]["selected"] =(mb_strpos($vData[I6102], ";".$vData[I6105][$i][I6110].";") !== false ?"selected" :I6093); $vData["ids_places_data"] .= $this->cms->Gui->get("adv_campaign_types_subform:ids_places_option", $vData[I6105][$i]); }for($i =0; $i <sizeof($vData[I6111]); $i++){ $vData[I6111][$i]["selected"] =(mb_strpos($vData[I6102], ";".$vData[I6111][$i][I6110].";") !== false ?"selected" :I6093); $vData[I6112] .= $this->cms->Gui->get("adv_campaign_types_subform:ids_places_option", $vData[I6111][$i]); }for($i =0; $i <sizeof($vData[I6106]); $i++){ $vData[I6106][$i]["selected"] =($vData["type_group"] == $vData[I6106][$i][I6110] ?"selected" :I6093); $vData[I6113] .= $this->cms->Gui->get("adv_campaign_types_subform:types_groups_option", $vData[I6106][$i]); }$this->browser->InitSQL("t.id, t.public, t.name, t.code, t.opt_def_max_views, t.opt_def_max_clicks, t.opt_def_lifetime_units, t.opt_def_lifetime, t.ids_places", "FROM cms_adv_campaign_types t", "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), I6093, I6114, "t.id desc" );$aCustom["fields"] += Array( "public"=>Array("action"=>I6115, I6110=>1, "id"=>"pub_id", "on"=>"adv_campaign_types_list:public_on",I6116=>"adv_campaign_types_list:public_off"), "opt_def_max_views"=>Array('action'=>'callback', I6117=>&$this, 'method'=>'_getOptViewsCB'), "opt_def_max_clicks"=>Array('action'=>I6118, I6117=>&$this, 'method'=>'_getOptClicksCB'), I6102=>Array('action'=>I6118, I6117=>&$this, 'method'=>I6119), "opt_def_lifetime"=>Array('action'=>I6118, I6117=>&$this, 'method'=>'_getOptLifetimeCB'), I6120=>Array("action"=>I6115, I6110=>I6093, "id"=>"edit_id", "on"=>"adv_campaign_types_list:edit",I6116=>I6093), "action_del"=>Array("action"=>I6115, I6110=>I6093, "id"=>"del_id", I6121=>"adv_campaign_types_list:del",I6116=>I6093) );$aCustom["applied_id"] ="t.id"; $aCustom["legend"] =Array(I6122, "notpublished", "leg_red", "leg_yellow", "leg_blue", I6123, "leg_del"); $aCustom["form_data"]["buttons"] =Array("add", I6124, "cancel", "save"); parent::TTTlI11($vData, $aCustom); }function _getIdsPlacesCB(&$aItem, &$aData){ $cnt =0; foreach(explode(';', $aItem[I6102]) as $val){ $val =intval($val); if($val >0) $cnt ++; }$aItem["num_places"] =I6093.$cnt; }function _getOptViewsCB(&$aItem, &$aData){ if($aItem[I6125] <= 0) $aItem[I6125] =$this->words["opt_unlimited"]; else $aItem[I6125] =I6093.intval($aItem[I6125]); }function _getOptClicksCB(&$aItem, &$aData){ if($aItem["opt_def_max_clicks"] <= 0) $aItem["opt_def_max_clicks"] =$this->words["opt_unlimited"]; else $aItem[I6126] =I6093.intval($aItem[I6126]); }function _getOptLifetimeCB(&$aItem, &$aData){ $aItem["has_duration"] =false; if($aItem["opt_def_lifetime"] <= 0) $aItem["opt_def_lifetime"] =$this->words["opt_unlimited"]; else{ $aItem[I6127] =true; $aItem["opt_def_lifetime"] =$this->words["opt_def_lifetime_".$aItem["opt_def_lifetime_units"]].": ".intval($aItem[I6128]); }$aItem["duration"] =$aItem[I6128]; }function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT t.* ". "FROM cms_adv_campaign_types t ". "WHERE t.id='".$cId.I6129.$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData["public"] =($this->itemData["public"] == 1) ?"checked": I6093; $this->itemData["allow_reserve"] =($this->itemData[I6130] == 1) ?"checked": I6093; foreach(explode(";", $this->itemData[I6102]) as $val){ $this->itemData["id_place_".$val] ="selected"; }$this->itemData["opt_def_lifetime_units_".$this->itemData["opt_def_lifetime_units"]] ="selected"; $this->itemData["opt_def_priority_".$this->itemData["opt_def_priority"]] =I6131; }}function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); }function _ActionDel($cId, $cModule) {parent::_ActionDel($cId, $cModule); }function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno'])){ $sql ="select ids_places, opt_def_max_views, opt_def_max_clicks, opt_def_lifetime, opt_def_lifetime_units, opt_def_priority, opt_def_max_views_day, max_items, material_type from cms_adv_campaign_types where id=".intval($cId); $this->db->query($sql); if($this->db->next_record()){ $I1lLlL1 =$this->db->Record; if(empty($I1lLlL1["opt_def_lifetime_units"])) $I1lLlL1["opt_def_lifetime_units"] =I6132; else if($I1lLlL1["opt_def_lifetime_units"] == "week"){ $I1lLlL1[I6128] *= 7; $I1lLlL1["opt_def_lifetime_units"] =I6132; }$I1lLlL1["end_date"] =intval($I1lLlL1[I6128]).I6133.$I1lLlL1["opt_def_lifetime_units"]; $ILLlIlL =array( "end_date"=>"=|DATE_ADD(start_date, INTERVAL ".$I1lLlL1["end_date"].I6134, "max_items"=>$I1lLlL1["max_items"], "material_type"=>$I1lLlL1["material_type"], I6135=>$I1lLlL1[I6125], "max_views_day"=>$I1lLlL1["opt_def_max_views_day"], "max_clicks"=>$I1lLlL1[I6126], "priority"=>$I1lLlL1[I6136], I6102=>$I1lLlL1[I6102], );$sql =$this->db->GenUpdateSql("cms_adv_campaigns", $ILLlIlL, "where id_type=".intval($cId)); $this->db->query($sql); }}}function TTT1IlI($aSql =Array(), $cId =0) {$name =$this->cms->VarsPost[I6100]; $I1lLl1I =$this->cms->VarsPost["material_type"] == "banner" ?$this->cms->VarsPost[I6102] :array($this->cms->VarsPost[I6137]); if($name != I6093 && is_array($I1lLl1I) && count($I1lLl1I) >0) {$aSql =Array( "public"=>intval($this->cms->VarsPost["public"]), I6100=>$name, "code"=>$this->cms->VarsPost["code"], I6138=>intval($this->cms->VarsPost[I6138]), I6130=>intval($this->cms->VarsPost[I6130]), "description"=>$this->cms->VarsPost["description"], "material_type" => $this->cms->VarsPost["material_type"], I6102=>I6139.implode(I6139, $I1lLl1I).I6139, I6108=>floatval($this->cms->VarsPost[I6108]), "cost_view"=>floatval($this->cms->VarsPost["cost_view"]), "cost_click"=>floatval($this->cms->VarsPost["cost_click"]), I6140=>intval($this->cms->VarsPost[I6140]), I6125=>intval($this->cms->VarsPost[I6125]), I6126=>intval($this->cms->VarsPost[I6126]), I6128=>intval($this->cms->VarsPost[I6128]), "opt_def_lifetime_units"=>$this->cms->VarsPost["opt_def_lifetime_units"], I6136=>intval($this->cms->VarsPost[I6136]), "opt_def_max_views_day"=>intval($this->cms->VarsPost["opt_def_max_views_day"]), );}$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TTTllTI(&$aCustom) {$this->SetBodyType(I6141); parent::TTTllTI($aCustom); }function TTTlIIl($IIlLlLI, $IIlLlLl, $defaultValue) {switch($IIlLlLI) {case "search_field": $this->filter->AddField("search_field", "text", isset($this->cms->Vars["search_field"]) ?$this->cms->Vars[I6142] :'', I6093, "like", I6114); break; case I6138: $sql ="select id, name from cms_adv_campaign_types_groups where lang='".$this->langData.I6096; $this->db->query($sql); while($this->db->next_record()){ $this->I1lLllI[] =$this->db->Record; }if(isset($this->cms->VarsPost[I6098])){ $groupId =$this->cms->VarsPost[I6098]; }elseif(isset($this->cms->VarsGet[I6098])){ $groupId =$this->cms->VarsGet[I6098]; }else{ $groupId =0; }$groupId =(int)$groupId; $aGroups =Array(); $aGroups =$this->filter->TITI1TT($aGroups, Array($this->cms->Words["all"]=>0), 55); for($i =0; $i <count($this->I1lLllI); $i++) $aGroups =$this->filter->TITI1TT($aGroups, Array($this->I1lLllI[$i][I6100] => $this->I1lLllI[$i][I6143]), 500); $this->filter->AddField(I6098, "select", $groupId, I6093, I6099, I6138, $aGroups); if($groupId==0) $this->filter->DisableFieldSQL(I6098); break; case "renew": if(empty($this->cms->VarsCookie["tmp_added"])){ $I1lLl1l =isset($this->cms->Vars["flt_renew"]) ?(int)$this->cms->Vars[I6144] :0; $this->filter->AddField(I6144, "hidden", $I1lLl1l, I6093, I6099, "t.id"); if($I1lLl1l<=0){ $this->filter->DisableFieldSQL(I6144); }else{ $this->filter->DisableFieldSQL(I6142); $this->filter->DisableFieldSQL(I6098); }}else{ $this->cms->Vars[I6144] =0; }break; }}function &TTTllTl(&$aCustom) {global $ROOT_PATH_WWW; if(!$this->member->isLoggedIn() || !$this->cms->Core->IsInstalled("srv_audit")) {$mMembers =&$this->cms->Core->GetModule("members"); $this->member->requireLogin($ROOT_PATH_WWW.$mMembers->GetFrontLink(), $ROOT_PATH_WWW.$this->module->GetFrontLink()); }else{ $sql ="select (m.active & a.active) as activity from cms_members m LEFT JOIN cms_adv_advertisers a ON m.id=a.id_member where m.id='".$this->member->getUserInfo('id').I6129; $this->db->query($sql); $this->db->next_record(); if($this->db->Record["activity"] != "1"){ $this->member->logout($this->cms); $mMembers =&$this->cms->Core->GetModule("members"); $this->member->requireLogin($ROOT_PATH_WWW.$mMembers->GetFrontLink(), $ROOT_PATH_WWW.$this->module->GetFrontLink()); }}return parent::TTTllTl($aCustom); }function TTTll1T(&$vData, &$aCustom) {if($this->cms->Core->IsInstalled(I6145)){ $this->I1lLlLl =&$this->GetExtension(I6145); $this->cms->Gui->addGlobalVars(Array("BANNERS_URL"=>$this->I1lLlLl->TITT1TI($this->cms, "adv_banners"))); $this->cms->Gui->addGlobalVars(Array("CAMPAIGNS_URL"=>$this->I1lLlLl->TITT1TI($this->cms, "adv_campaigns"))); }$I1lLl1L =array(); $sql ="select c.id as id_camapign, c.id_type, count(b.id) as banners_num from cms_adv_campaigns c left join cms_adv_banners b ON POSITION(CONCAT(';', c.id,';') in b.id_campaign)>0 where c.status='pending' and c.id_advertiser='".$this->member->getUserInfo('id')."' group by c.id"; $this->db->query($sql); while($this->db->next_record()){ $I1lLl1L[] =$this->db->Record["id_type"]; $this->I1lLll1[$this->db->Record["id_type"]] =$this->db->Record[I6146]; $this->I1lLlLI[$this->db->Record["id_type"]] =$this->db->Record["id_camapign"]; }$aDefault =Array(); foreach($this->IIllIL1 as $IIlL1L1 => $tmp) {$IIlL1Ll =$this->TTITTT1($aCustom, $IIlL1L1); switch($IIlL1L1) {case I6141: $IIlL1Ll["list_data"]["simple_prefix"] =I6147; $IIlL1Ll["simple_set_fields"] =Array(); $aDefault["page_item_type"] =I6141; $this->TTTllll($vData, $IIlL1Ll); $I1lLl11 =$this->module->GetOption("allow_renew_reserved") && isset($this->cms->Vars[I6144]) && $this->cms->Vars[I6144] >0; $I1lLLII ="(t.cost+t.cost_click+t.cost_view=0 OR t.cost+t.cost_click+t.cost_view<='".floatval($this->member->getUserInfo(I6148))."')"; $I1lLLIl =(count($I1lLl1L) >0 ?"IF(t.id in (".implode(',', $I1lLl1L)."), 1, 0)" :I6107); $this->browser->InitSQL("t.id, t.name, t.code, t.opt_def_lifetime_units, t.opt_def_lifetime, t.description, t.cost, t.cost_view, t.cost_click, ".$I1lLLII." as is_available, IF(t.cost_click>0, 1, 0) as hasMaxCostClick, IF(t.cost_view>0, 1, 0) as hasMaxCostView, ".($I1lLl11 ?0 :$I1lLLIl)." as is_reserved", "FROM cms_adv_campaign_types t LEFT JOIN cms_adv_campaigns c ON t.id=c.id_type", "WHERE t.public=1 ".($I1lLl11 ?I6093 :"AND t.allow_reserve=1 "). (!$this->module->GetOption("show_more_expensive_campaigns") ?" AND ".$I1lLLII.I6133 :I6093). (!$this->module->GetOption("show_reserved_campaigns") ?" AND NOT ".$I1lLLIl.I6133 :I6093). $this->_ApplyFilters().$this->TTTlIl1(), I6149, I6093 );$this->browser->AddSQLJoinedTables($this->cms->Core, 't', Array('c'=>"cms_adv_campaigns")); if(!isset($IIlL1Ll["fields"])){ $IIlL1Ll[I6150] =array(); }elseif(!is_array($IIlL1Ll[I6150])){ $IIlL1Ll[I6150] =array(); }$IIlL1Ll[I6150] += Array( I6143=>Array("action" => "callback", "object"=>&$this, "method"=>I6151), I6128=>Array('action'=>I6118, I6117=>&$this, 'method'=>'_getOptLifetimeCB'), I6108=>Array("action" => I6152, "object"=>&$this, "method"=>"_getCostCB"), "cost_view"=>Array(I6153 => I6152, "object"=>&$this, "method"=>"_getCostViewCB"), "cost_click"=>Array(I6153 => I6152, I6154=>&$this, "method"=>"_getCostClickCB"), );if(!empty($this->cms->VarsCookie["tmp_nobanners"])){ $I1lLLIL =I6093; $I1lLLI1 =unserialize(stripslashes(mb_substr(unhtmlentities($this->cms->VarsCookie["tmp_nobanners"]), 1))); if(is_array($I1lLLI1)) foreach($I1lLLI1 as $key => $value){ if(isset($this->words[I6155.intval($value[0])])){ $I1lLLIL .= "\\n".$this->words[I6155.$value[0]]. ($value[1] >0 ?", ".$this->words["banner_width"].I6133.$value[1] :I6093). ($value[2] >0 ?", ".$this->words[I6156].I6133.$value[2] :I6093); }}$this->cms->AddStatusMsg("status_nobanners", "red", I6093, I6093, array("allowed_banners" => $I1lLLIL)); SetLocalCookie('tmp_nobanners', I6157, time(), $this->cms->AdminPathWWW); SetLocalCookie('tmp_cmpgid', I6157, time(), $this->cms->AdminPathWWW); SetLocalCookie('tmp_cmpmaxclick', I6157, time(), $this->cms->AdminPathWWW); SetLocalCookie('tmp_cmpmaxview', I6157, time(), $this->cms->AdminPathWWW); }if(!empty($this->cms->VarsCookie["tmp_nocash"])){ $this->cms->AddStatusMsg(I6158, "red", I6093, I6093); SetLocalCookie('tmp_nocash', I6157, time(), $this->cms->AdminPathWWW); SetLocalCookie('tmp_cmpgid', I6157, time(), $this->cms->AdminPathWWW); SetLocalCookie('tmp_cmpmaxclick', I6157, time(), $this->cms->AdminPathWWW); SetLocalCookie(I6159, I6157, time(), $this->cms->AdminPathWWW); }if(!empty($this->cms->VarsCookie["tmp_added"])){ $I1lLLlI =I6093; if($this->I1lLlLl) $I1lLLlI =$GLOBALS["ROOT_PATH_WWW"].$this->I1lLlLl->TITT1TI($this->cms, "adv_campaigns")."?action=locate&id=".intval($this->cms->VarsCookie[I6160])."#anchor"; $this->cms->AddStatusMsg("status_add", I6093, I6093, I6093, array("campaign_url" => $I1lLLlI)); SetLocalCookie('tmp_added', I6157, time(), $this->cms->AdminPathWWW); SetLocalCookie(I6161, I6157, time(), $this->cms->AdminPathWWW); }break; }parent::TTTll1T($vData, $IIlL1Ll); }}function _getIdCB(&$vItem, &$vData) {if(isset($this->I1lLll1[$vItem[I6143]])) $vItem[I6146] =intval($this->I1lLll1[$vItem[I6143]]); else $vItem[I6146] =0; if($vItem["is_reserved"] && $this->I1lLlLI[$vItem[I6143]] >0 && $this->I1lLlLl) $vItem["CAMPAIGNS_URL"] =$this->I1lLlLl->TITT1TI($this->cms, "adv_campaigns")."?action=locate&id=".intval($this->I1lLlLI[$vItem[I6143]]).I6162; }function _getCostCB(&$vItem, &$vData) {if(!is_null($this->oEshop)) $vItem[I6108] =$this->oEshop->formatMoney(doubleval($vItem[I6108]), $this->oEshop->baseCurrency); else $vItem[I6108] =FormatNumber(doubleval($vItem[I6108]), 2, 2, false); $vItem["curr_postfix"] =$this->I1lLllL; $vItem[I6109] =$this->I1lLlll; if(isset($this->cms->VarsCookie["tmp_cmpgid"]) && $this->cms->VarsCookie["tmp_cmpgid"] == $vItem[I6143]){ $vItem["max_cost_view"] =unhtmlentities($this->cms->VarsCookie[I6163]); $vItem["max_cost_click"] =unhtmlentities($this->cms->VarsCookie["tmp_cmpmaxclick"]); }else{ $vItem["max_cost_view"] ="0.00"; $vItem[I6164] ="0.00"; }}function _getCostViewCB(&$vItem, &$vData) {if(!is_null($this->oEshop)) $vItem["cost_view"] =$this->oEshop->formatMoney(doubleval($vItem["cost_view"]), $this->oEshop->baseCurrency); else $vItem["cost_view"] =FormatNumber(doubleval($vItem[I6165]), 2, 2, false); }function _getCostClickCB(&$vItem, &$vData) {if(!is_null($this->oEshop)) $vItem["cost_click"] =$this->oEshop->formatMoney(doubleval($vItem["cost_click"]), $this->oEshop->baseCurrency); else $vItem["cost_click"] =FormatNumber(doubleval($vItem["cost_click"]), 2, 2, false); }function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {$aData =Array(); $I1lLLll =&$this->cms->Core->GetModule(I6166); $aData["front_link"] =$I1lLLll->GetFrontLink(); $I1lLILI =$this->cms->Gui->getAbs($this->moduleName."_list:special_selected_style", I6093); $aData["style_selected"] =I6093; if($this->cms->ActivePage == I6166) $aData["style_selected"] =$I1lLILI; $vRes[I6167] =I6093; if($this->member->isLoggedIn() && $I1lLLll->IsPresentInPMandPublic() && $this->cms->Core->IsInstalled("srv_audit")) {$sql ="select (m.active & a.active) as activity from cms_members m LEFT JOIN cms_adv_advertisers a ON m.id=a.id_member where m.id='".$this->member->getUserInfo('id').I6129; $this->db->query($sql); $this->db->next_record(); if($this->db->Record["activity"] == I6168){ $vRes[I6166]["vars"] =$aData; $vRes[I6166]["default"] =$this->cms->Gui->get($this->moduleName."_list:special_menu_list", $aData); }}}function TTT1ITI($cId, $cModule){ $cId =intval($cId); if($cId >0){ $userBalance =0; $sql ="select balance from cms_members where id='".$this->member->getUserInfo(I6169).I6129; $this->db->query($sql); if($this->db->next_record()){ $userBalance =floatval($this->db->Record["balance"]); }$sql ="select cost_view, cost_click, cost from cms_adv_campaign_types where id=".intval($cId); $this->db->query($sql); if($this->db->next_record()){ $I1lLLlL =$this->db->Record[I6108]+max($this->db->Record[I6165], $this->cms->VarsGet["max_cost_view"])+max($this->db->Record["cost_click"], $this->cms->VarsGet[I6164]); if($I1lLLlL >$userBalance){ SetLocalCookie(I6170, $cId, time()+3600, $this->cms->AdminPathWWW); SetLocalCookie('tmp_cmpmaxclick', $this->cms->VarsGet[I6164], time()+3600, $this->cms->AdminPathWWW); SetLocalCookie(I6159, $this->cms->VarsGet["max_cost_view"], time()+3600, $this->cms->AdminPathWWW); SetLocalCookie('tmp_nocash', '1', time()+3600, $this->cms->AdminPathWWW); $GLOBALS[I6171]->Location($GLOBALS["ROOT_PATH_WWW"].base64_decode($this->cms->VarsGet["url"])); }}if($this->module->GetOption("banners_required")){ $I1lLLl1 =false; $I1lLLLI =I6093; $sql ="select ids_places from cms_adv_campaign_types where id=".intval($cId); $this->db->query($sql); if($this->db->next_record()) $I1lLLLI =$this->db->Record[I6102]; $I1lLLLl =array(); foreach(explode(I6139, $I1lLLLI) as $placeId) if($placeId >0) $I1lLLLl[] =$placeId; $I1lLLI1 =array(); if(count($I1lLLLl) >0){ $I1lLLLL =array(); $I1lLLL1 =array(); $I1lLL1I =array(); $sql ="select place_type, place_width, place_height from cms_adv_places where (source_type='banner' OR source_type='modbanner') AND id in('".implode("', '", $I1lLLLl)."')"; $this->db->query($sql); while($this->db->next_record()){ $I1lLLI1[] =array($this->db->Record["place_type"], $this->db->Record["place_width"], $this->db->Record[I6172]); if($I1lLLLL !== false){ if($this->db->Record["place_width"] == 0) $I1lLLLL =false; else $I1lLLLL[] =$this->db->Record["place_width"]; }if($I1lLLL1 !== false){ if($this->db->Record[I6172] == 0) $I1lLLL1 =false; else $I1lLLL1[] =$this->db->Record[I6172]; }if($I1lLL1I !== false){ if($this->db->Record["place_type"] == 0) $I1lLL1I =false; else $I1lLL1I[] =$this->db->Record["place_type"]; }}$sql ="select count(*) as count from cms_adv_banners ". "where id_owner='".$this->member->getUserInfo(I6169)."' AND status=2". ($I1lLLLL !== false && count($I1lLLLL) >0 ?" AND (type=1 OR (width in('".implode("', '", $I1lLLLL).I6173 :I6093). ($I1lLLL1 !== false && count($I1lLLL1) >0 ?" AND (type=1 OR (height in('".implode("', '", $I1lLLL1).I6173 :I6093). ($I1lLL1I !== false && count($I1lLL1I) >0 ?" AND type in('".implode("', '", $I1lLL1I).I6174 :I6093); $this->db->query($sql); $this->db->next_record(); if($this->db->Record["count"] >0){ $I1lLLl1 =true; }}}else $I1lLLl1 =true; if($I1lLLl1){ $sql ="select * from cms_adv_campaign_types where id='".$cId.I6129; $this->db->query($sql); if($this->db->next_record()){ $I1lLL1l =$this->db->Record; $name =$I1lLL1l[I6100]; $tm ="0000-00-00 00:00:00"; $I1lLL1L =array(); if(empty($I1lLL1l["opt_def_lifetime_units"])) $I1lLL1l["opt_def_lifetime_units"] =I6132; else if($I1lLL1l["opt_def_lifetime_units"] == "week"){ $I1lLL1l[I6128] *= 7; $I1lLL1l["opt_def_lifetime_units"] =I6132; }$I1lLL1l["end_date"] =intval($I1lLL1l[I6128]).I6133.$I1lLL1l["opt_def_lifetime_units"]; if(!empty($name) && !empty($tm) && count($I1lLL1l) >0){ $aSql =array( "status" => "pending", "public"=>I6168, I6100=>$name, "id_owner" => $this->member->getUserInfo(I6169), I6175=>intval($cId), "start_date"=>$tm != '0000-00-00 00:00:00' ?DateTools::toMysqlDate($tm) :$tm, "end_date"=>$tm != '0000-00-00 00:00:00' ?I6176.DateTools::toMysqlDate($tm)."', INTERVAL ".$I1lLL1l["end_date"].I6134 :$tm, I6140=>$I1lLL1l[I6140], "material_type"=>$I1lLL1l["material_type"], I6135=>$I1lLL1l[I6125], I6177=>$I1lLL1l["opt_def_max_views_day"], "max_clicks"=>$I1lLL1l[I6126], "priority"=>$I1lLL1l[I6136], I6102=>$I1lLL1l[I6102], "id_advertiser"=>$this->member->getUserInfo(I6169), I6178 => $this->langData, I6108 => $I1lLL1l[I6108], I6165 => $I1lLL1l[I6165], "cost_click" => $I1lLL1l["cost_click"], "max_cost_view" => floatval($this->cms->VarsGet["max_cost_view"]), I6164 => floatval($this->cms->VarsGet[I6164]), );}$sql =$this->db->GenInsertSql(I6179, $aSql); $this->db->query($sql); $I1lLL11 =$this->db->lastInsertId(); SetLocalCookie('tmp_added', '1', time()+3600, $this->cms->AdminPathWWW); SetLocalCookie(I6161, $I1lLL11, time()+3600, $this->cms->AdminPathWWW); if($I1lLL1l[I6108] >0) $this->member->TTI1ll1($this->db, $this->member->GetUserInfo(I6143), $I1lLL1l[I6108], I6093, "user", "%%hist_balance_blocked_campaign%% ".$name); $I1lL1II =$this->cms->Core->GetModule(I6180); require_once $GLOBALS['CLASSES_PATH'] .'AuditObject.php'; $this->ILLLLlI =new AuditObject($this->cms, $this->db); $this->ILLLLlI->Init($I1lLL11, $I1lL1II->GetName(), $name); $this->ILLLLlI->SetOwner($this->member->getUserInfo(I6169)); $this->ILLLLlI->TTTT11T($this->member->getUserInfo(I6169)); $this->ILLLLlI->TTTT1l1("add"); $this->cms->Gui->addBlock("adv_mails", $GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/letters/advertisement_" .$this->langData .".tpl"); $mailData =$aSql; $mailData["SITE"] =$this->cms->Core->GetOption("company_url"); $userId =intval($this->member->getUserInfo(I6169)); $I1lL1Il =$this->cms->Core->GetModule(I6180); $mailData[I6181] =$GLOBALS["ADMIN_PATH_WWW"].$I1lL1Il->GetAdminLink()."?action=locate&id=".$I1lLL11.I6162; if($userId >0){ $sql ="select m.email, m.firstname, m.lastname, m.username from cms_members m where id=".$userId; $this->db->query($sql); if($this->db->next_record()){ $mailData["ADVERTISER_EMAIL"] =$this->db->Record[I6182]; $mailData["ADVERTISER_NAME"] =$this->db->Record["lastname"].I6133.$this->db->Record["firstname"]; $mailData["ADVERTISER_LOGIN"] =$this->db->Record[I6183]; }}$ILLl1ll =$this->cms->Gui->get("adv_mails:adv_mail_header", $mailData). $this->cms->Gui->get("adv_mails:mail_campaign_created", $mailData). $this->cms->Gui->get("adv_mails:adv_mail_footer", $mailData); require_once($GLOBALS["CLASSES_PATH"].I6184); $oMail =new Mailer(); $oMail->RecipientAddress =$this->cms->Core->GetOption("company_email"); $oMail->RecipientName =I6093; $oMail->SenderAddress =$this->cms->Core->GetOption("company_robot_email"); $oMail->SenderName =$this->cms->Core->GetOption("company_name"); $oMail->Subject =$this->cms->Gui->get("adv_mails:mail_campaign_created_subject", $mailData); $oMail->Body =$ILLl1ll; $oMail->BodyFormat =I6185; $oMail->Prepare(); if(!$oMail->Send()){ trigger_error(I6186.$this->cms->Core->GetOption("company_email")." failed", E_USER_WARNING); }}}else{ SetLocalCookie(I6170, $cId, time()+3600, $this->cms->AdminPathWWW); SetLocalCookie('tmp_cmpmaxclick', $this->cms->VarsGet[I6164], time()+3600, $this->cms->AdminPathWWW); SetLocalCookie(I6159, $this->cms->VarsGet["max_cost_view"], time()+3600, $this->cms->AdminPathWWW); SetLocalCookie(I6187, I6168.serialize($I1lLLI1), time()+3600, $this->cms->AdminPathWWW); }$GLOBALS[I6171]->Location($GLOBALS["ROOT_PATH_WWW"].base64_decode($this->cms->VarsGet["url"])); }}}