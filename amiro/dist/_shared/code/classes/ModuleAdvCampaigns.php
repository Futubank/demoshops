<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       30684 xkqwlwwxqsulzltuukrxstxnklywnzqyxyisxmrxuzpxssxirwpzstupquyupzugrxkxpnir
 */ ?><?php foreach(array(6203=>"",6204=>"GuYJMDO|Hff",6205=>'qDOHGzSIMn`GOG',6206=>"'?HrSQr?YB?nZIQ",6207=>"ZJJ",6208=>'rQfuDQS',6209=>"fJt|WIGP|DtZtuD",6210=>"fJt|WIGP|tBGQ|MS",6211=>"=",6212=>"?JMKQ?",6213=>"fJt|ZSvQrtMDQr|MS",6214=>":",6215=>"fJt|GJZWQ|MS",6216=>"W`MSD|GJZWQD",6217=>"SZtQtH",6218=>"DtZtuD",6219=>"ZSv|YZnnQrD",6220=>"MS",6221=>"DQJQWtQS",6222=>"vZJuQ",6223=>"MS|ZSvQrtMDQr",6224=>"W`MS",6225=>"YZnnQrD|nuI",6226=>"Y",6227=>"fJZPMWHn",6228=>'|WYFHrIZtdtZtuD',6229=>"IQtOHS",6230=>"Hn",6231=>"SQJ|MS",6232=>"JQPQnS",6233=>"JQP|rQS",6234=>"fHrI|SZtZ",6235=>"DZvQ",6236=>"ZJJHCQSyZnnQrD",6237=>"YZnnQr|CMStO",6238=>"DtZtuD|nH|YZnnQrD",6239=>"WHDt|vMQC",6240=>"IZx|WHDt|WJMWK",6241=>"WIGP|DtZtuD",6242=>"SY",6243=>"GuYJMW",6244=>"GJZWQ|OQMPOt",6245=>"'{{{",6246=>"'{",6247=>"^",6248=>"YZnnQrD",6249=>"'",6250=>"ZSv|IZMJD",6251=>"WHIGZnB|urJ",6252=>"Qxt|ZSv|ZuSMt",6253=>"<ZnWOHr",6254=>"QIZMJ",6255=>"zsVqRTmdqR|jhpmN",6256=>"zsVqRTmdqR|Nziq",6257=>"OtIJ",6258=>"iHSuJQzSvwZIGZMPnD%|zWtMHnzGGJB?DQnSMnP?QIZMJ?tH?",6259=>"WHnf|StMIQ",6260=>"ZSvQrtMDQr",6261=>"YZJZnWQ",6262=>"tBGQ",6263=>"SZB",6264=>"QnS|SZtQ",6265=>"nZIQ",6266=>"=_szTq|zss}'",6267=>"IZtQrMZJ|tBGQ",6268=>"IZx|WJMWKD",6269=>"MSD|GJZWQD") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleAdvCampaigns extends CMS_ActModule {public $IIllLI1; public $oEshop; public $I1lLlll; public $I1lLllL; function ModuleAdvCampaigns(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->IIllLI1 =array(); $this->oEshop =NULL; $this->I1lLlll =""; $this->I1lLllL =""; }function _Init($IIll1l1 =Array(), $IIll1LI =I6203, $IIll1Ll =I6203, $aOptions =Array()) {$IIIIL11['default_prefix'] ='c'; $IIIIL11["group_operations"] =Array("publish_on", I6204, "del"); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); if($this->cms->Core->IsInstalled("eshop_cart")){ if($this->cms->Core->Side == "admin"){ require_once $GLOBALS['CLASSES_PATH'] .I6205; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init("eshop_item"); $this->I1lLllL =$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency); if(!empty($this->I1lLllL)) {$this->I1lLlll =$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency); }}}if(is_null($this->oEshop)){ require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_format.php"); }}function _InitAdmin() {parent::_InitAdmin(); $sql ="select * from cms_adv_places where lang='".$this->langData.I6206; $this->db->query($sql); while($this->db->next_record()) $this->IIllLI1[] =$this->db->Record; }function TTTlIII() {parent::TTTlIII(); if($this->realSide == "front") return; $statusId =isset($this->cms->VarsPost["flt_cmpg_status"]) ?$this->cms->VarsPost["flt_cmpg_status"] :$this->cms->VarsGet["flt_cmpg_status"]; $aStatuses =Array(); $aStatuses =$this->filter->TITI1TT($aStatuses, Array($this->cms->Words[I6207]=>''), 55); $aStatuses =$this->filter->TITI1TT($aStatuses, Array($this->words["cmpg_status_pending"]=>'pending'), 55); $aStatuses =$this->filter->TITI1TT($aStatuses, Array($this->words["cmpg_status_refused"]=>I6208), 55); $aStatuses =$this->filter->TITI1TT($aStatuses, Array($this->words["cmpg_status_active"]=>'active'), 55); $aStatuses =$this->filter->TITI1TT($aStatuses, Array($this->words["cmpg_status_finished"]=>'finished'), 55); $this->filter->AddField(I6209, "select", $statusId, I6203, "like", "c.status", $aStatuses); $this->filter->MoveField(I6209, _MOVE_START); if($statusId=='') {$this->filter->DisableFieldSQL(I6209); }$typeId =intval(isset($this->cms->VarsPost[I6210]) ?$this->cms->VarsPost[I6210] :$this->cms->VarsGet[I6210]); $aTypes =Array(); $aTypes =$this->filter->TITI1TT($aTypes, Array($this->cms->Words[I6207]=>0), 55); $sql ="select id, name from cms_adv_campaign_types where lang='".$this->langData.I6206; $this->db->query($sql); while($this->db->next_record()){ $aTypes =$this->filter->TITI1TT($aTypes, Array($this->db->Record["name"] => $this->db->Record["id"]), 500); }$this->filter->AddField(I6210, "select", $typeId, I6203, I6211, "c.id_type", $aTypes); $this->filter->MoveField(I6210, _MOVE_START); if($typeId==0) {$this->filter->DisableFieldSQL(I6210); }$this->filter->AddField("flt_name", "text", stripslashes(unhtmlentities($this->cms->Vars["flt_name"])), I6203, I6212, "c.name"); $this->filter->MoveField("flt_name",_MOVE_START); if(empty($this->cms->Vars["flt_name"])) $this->filter->DisableFieldSQL("flt_name"); $I1lL1IL =unhtmlentities($this->cms->Vars[I6213]); $this->filter->AddField(I6213, "text", stripslashes($I1lL1IL), I6203, "like", "m.lastname"); $this->filter->MoveField(I6213, _MOVE_START); if(empty($this->cms->Vars[I6213])) $this->filter->DisableFieldSQL(I6213); else{ $I1lL1I1 =str_replace("*", I6214, $I1lL1IL); $this->filter->TITI1II(I6213, " OR m.firstname like '".$I1lL1I1."%' OR m.username like '".$I1lL1I1."%'", "force"); }$placeId =intval(isset($this->cms->VarsPost[I6215]) ?$this->cms->VarsPost[I6215] :$this->cms->VarsGet[I6215]); $I1lLlLL =Array(); $I1lLlLL =$this->filter->TITI1TT($I1lLlLL, Array($this->cms->Words[I6207]=>0), 55); for($i =0; $i <count($this->IIllLI1); $i++) $I1lLlLL =$this->filter->TITI1TT($I1lLlLL, Array($this->IIllLI1[$i]["name"] => $this->IIllLI1[$i]["id"]), 500); $this->filter->AddField(I6215, "select", $placeId, I6203, "like", I6216, $I1lLlLL); $this->filter->MoveField(I6215, _MOVE_START); $this->filter->TITIll1(I6215); if($placeId==0) {$this->filter->DisableFieldSQL(I6215); }else{ $this->filter->TITI1II(I6215, " OR c.ids_places like '%;".intval($placeId).";%'", "force"); }$this->filter->TITI1l1("datefrom"); $this->filter->TITI1l1(I6217); }function TTTlITT($IIIL11l, $cId, $cModule =I6203) {parent::TTTlITT($IIIL11l, $cId, $cModule); }function &TTTlI1T(&$aCustom) {return parent::TTTlI1T($aCustom); }function TTTlI1I(&$vData) {$vData["start_date"] =date($this->cms->DFMT["php"]." H:i:s"); if(!isset($this->itemData["status"])) $this->itemData[I6218] ="active"; parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {if($this->cms->Core->IsInstalled("ext_adv_audit")){ $ext =&$this->GetExtension("ext_adv_audit"); $this->cms->Gui->addGlobalVars(Array( "BANNERS_URL"=>$ext->TITT1TI($this->cms, I6219), "CAMPAIGN_TYPES_URL"=>$this->cms->Core->GetModFrontLink("adv_campaign_types"), ));}$sql ="select id, name from cms_adv_campaign_types where lang='".$this->langData.I6206; $this->db->query($sql); while($this->db->next_record()){ $tmp =array( "value" => $this->db->Record[I6220], "name" => $this->db->Record["name"], "selected" => $this->db->Record[I6220] == $this->itemData["id_type"] ?I6221 :I6203 );$vData["campaign_types"] .= $this->cms->Gui->get("adv_campaigns_subform:select_option", $tmp); }$sql ="select m.id, m.firstname, m.lastname from cms_members m LEFT JOIN cms_adv_advertisers a ON m.id=a.id_member where a.active & m.active AND a.id>0 AND m.lang='".$this->langData."' order by m.firstname, m.lastname"; $this->db->query($sql); while($this->db->next_record()){ $tmp =array( I6222 => $this->db->Record[I6220], "name" => $this->db->Record["firstname"]." ".$this->db->Record["lastname"], I6221 => $this->db->Record[I6220] == $this->itemData[I6223] ?I6221 :I6203 );$vData["advertisers"] .= $this->cms->Gui->get("adv_campaigns_subform:select_option", $tmp); }$this->browser->InitSQL("m.lastname, m.firstname, m.username, c.id, c.public, c.status, c.status_comment, c.name, IF(c.start_date!='0000-00-00 00:00:00', DATE_FORMAT(c.start_date,'".$this->cms->DFMT["db"]." %H:%i:%s'), '') AS start_date, IF(c.start_date!='0000-00-00 00:00:00', DATE_FORMAT(c.end_date,'".$this->cms->DFMT["db"]." %H:%i:%s'), '') AS end_date, IF(c.start_date=c.end_date and c.start_date<NOW() OR NOW()<c.end_date AND NOW()>c.start_date, 1, 0) as active_views, c.priority, IF(c.status='pending', 1, 0) as deletable, IF(c.status='active', 1, 0) as renewable, count(b.id) as banners_num, c.cost, c.cost_view, c.cost_click, c.max_cost_view, c.max_cost_click, IF(c.cost_click>0, 1, 0) as hascostclick, IF(c.cost_view>0, 1, 0) as hascostview, IF(c.max_cost_click>0, 1, 0) as hasmaxcostclick, IF(c.max_cost_view>0, 1, 0) as hasmaxcostview, c.id_type", "FROM (cms_adv_campaigns c LEFT JOIN cms_members m ON c.id_advertiser=m.id) LEFT JOIN cms_adv_banners b ON POSITION(CONCAT(';', c.id,';') in b.id_campaign)>0", "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), I6224, "c.name", "c.id desc", array("advertiser" => "m.lastname", I6225 => "=|banners_num") );$this->browser->AddSQLJoinedTables($this->cms->Core, "c", Array("m"=>"cms_adv_campaigns", I6226=>"cms_adv_banners")); $aCustom["fields"] += Array( "public"=>Array("action"=>I6227, I6222=>1, I6220=>"pub_id", "on"=>"adv_campaigns_list:public_on","off"=>"adv_campaigns_list:public_off"), I6218 => Array('action'=>'callback', 'object'=>&$this, 'method'=>I6228), "cost"=>Array("action" => "callback", "object"=>&$this, I6229=>"_getCostCB"), "action_edit"=>Array("action"=>I6227, I6222=>I6203, I6220=>"edit_id", I6230=>"adv_campaigns_list:edit","off"=>I6203), "action_del"=>Array("action"=>I6227, I6222=>I6203, I6220=>I6231, I6230=>"adv_campaigns_list:del","off"=>I6203) );$aCustom["applied_id"] =I6224; if($this->realSide == "front") $aCustom[I6232] =Array("leg_edit", "leg_del"); else $aCustom[I6232] =Array("published", "notpublished", I6233, "leg_yellow", "leg_blue", "leg_edit", "leg_del"); $aCustom[I6234]["buttons"] =Array("add", "apply", "cancel", I6235); parent::TTTlI11($vData, $aCustom); if((!isset($this->itemData) || !($this->itemData[I6220] >0) || $this->itemData["banners"] === false) && $this->realSide == "front"){ $vData["do_not_show_form"] =true; if($this->itemData[I6220] >0 && $this->itemData["banners"] === false){ $I1lLLIL =I6203; if(is_array($this->itemData[I6236])) foreach($this->itemData[I6236] as $key => $value){ if(isset($this->words["banner_type_".intval($value[0])])){ $I1lLLIL .= "\\n".$this->words["banner_type_".$value[0]]. ($value[1] >0 ?", ".$this->words[I6237]." ".$value[1] :I6203). ($value[2] >0 ?", ".$this->words["banner_height"]." ".$value[2] :I6203); }}$this->cms->AddStatusMsg(I6238, "red", I6203, I6203, array("allowed_banners" => $I1lLLIL)); unset($this->itemData[I6236]); }}}function TIITITI($cost){ return is_null($this->oEshop) ?FormatNumber(doubleval($cost), 2, 2, false) :$this->oEshop->formatMoney(doubleval($cost), $this->oEshop->baseCurrency); }function _getCostCB(&$vItem, &$vData) {$vItem["cost"] =$this->TIITITI($vItem["cost"]); $vItem[I6239] =$this->TIITITI($vItem[I6239]); $vItem["cost_click"] =$this->TIITITI($vItem["cost_click"]); $vItem["max_cost_view"] =$this->TIITITI($vItem["max_cost_view"]); $vItem[I6240] =$this->TIITITI($vItem[I6240]); }function _cbFormatStatus(&$aItem, &$aData){ if($aItem[I6218] == "finished" && empty($aItem["status_comment"])) $aItem["status_comment"] ="%%stat_finished_unknown%%"; $aItem[I6241] =$this->words["cmpg_status_".$aItem[I6218]]; }function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT c.id, c.ids_places, c.name, c.status, c.lang, c.public, c.id_type, c.id_advertiser, IF(c.start_date!='0000-00-00 00:00:00', DATE_FORMAT(c.start_date,'".$this->cms->DFMT["db"]." %H:%i:%s'), '') AS start_date, IF(c.start_date!='0000-00-00 00:00:00', DATE_FORMAT(c.end_date,'".$this->cms->DFMT[I6242]." %H:%i:%s'), '') AS end_date ". "FROM cms_adv_campaigns c ". "WHERE c.id='".$cId."'".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData[I6243] =($this->itemData[I6243] == 1) ?"checked": I6203; $this->itemData["banners"] =false; $I1lLLLl =array(); foreach(explode(";", $this->itemData["ids_places"]) as $placeId) if($placeId >0) $I1lLLLl[] =$placeId; $this->itemData[I6236] =array(); if(count($I1lLLLl) >0){ $I1lLLLL =array(); $I1lLLL1 =array(); $I1lLL1I =array(); $sql ="select place_type, place_width, place_height from cms_adv_places where (source_type='banner' OR source_type='modbanner') AND id in('".implode("', '", $I1lLLLl)."')"; $this->db->query($sql); while($this->db->next_record()){ $this->itemData[I6236][] =array($this->db->Record["place_type"], $this->db->Record["place_width"], $this->db->Record[I6244]); if($I1lLLLL !== false){ if($this->db->Record["place_width"] == 0) $I1lLLLL =false; else $I1lLLLL[] =$this->db->Record["place_width"]; }if($I1lLLL1 !== false){ if($this->db->Record[I6244] == 0) $I1lLLL1 =false; else $I1lLLL1[] =$this->db->Record[I6244]; }if($I1lLL1I !== false){ if($this->db->Record["place_type"] == 0) $I1lLL1I =false; else $I1lLL1I[] =$this->db->Record["place_type"]; }}$sql ="select id, name, id_campaign from cms_adv_banners ". "where id_owner='".$this->cms->Core->GetUserId()."' AND status=2". ($I1lLLLL !== false && count($I1lLLLL) >0 ?" AND (type=1 OR (width in('".implode("', '", $I1lLLLL).I6245 :I6203). ($I1lLLL1 !== false && count($I1lLLL1) >0 ?" AND (type=1 OR (height in('".implode("', '", $I1lLLL1).I6245 :I6203). ($I1lLL1I !== false && count($I1lLL1I) >0 ?" AND type in('".implode("', '", $I1lLL1I).I6246 :I6203); $this->db->query($sql); while($this->db->next_record()){ $II1II11 =array( I6222 => $this->db->Record[I6220], "name" => $this->db->Record["name"], I6221 => (mb_strpos($this->db->Record["id_campaign"], ";".$cId.I6247) !== false ?I6221 :I6203), );$this->itemData["banners"] .= $this->cms->Gui->get($this->moduleName."_subform:select_option", $II1II11); }}}}function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); }function _ActionDel($cId, $cModule) {parent::_ActionDel($cId, $cModule); }function TTTl1lI($cId, $cModule) {if($this->realSide == "front"){ $I1lL1lI =false; if(is_array($this->cms->VarsPost["banners"])){ $I1lL1ll =array(); foreach($this->cms->VarsPost[I6248] as $I1lL1lL) $I1lL1ll[] =intval($I1lL1lL); if(count($I1lL1ll) >0){ $sql ="update cms_adv_banners set id_campaign=CONCAT(SUBSTRING(id_campaign, 1, POSITION(';".$cId.";' in id_campaign)-1), SUBSTRING(id_campaign, POSITION(';".$cId.";' in id_campaign)+".(mb_strlen($cId)+1).")) where POSITION(';".$cId.";' in id_campaign)>0 AND id_owner='".$this->cms->Core->GetUserId()."'"; $this->db->query($sql); $sql ="update cms_adv_banners set id_campaign=CONCAT(id_campaign, IF(LENGTH(id_campaign)>0, '".$cId.";', ';".$cId.";')) WHERE POSITION(';".$cId.";' in id_campaign)<=0 AND id in('".implode("','", $I1lL1ll)."') and id_owner='".$this->cms->Core->GetUserId()."'"; $this->db->query($sql); $I1lL1lI =true; $this->cms->AddStatusMsg("status_apply"); }else{ $this->cms->AddStatusMsg("status_banners_not_selected", "red"); }}else{ $this->cms->AddStatusMsg("status_apply_fail", "red"); }}else{ $prevStatus =0; $sql ="select status from cms_adv_campaigns where id='".$cId.I6249; $this->db->query($sql); if($this->db->next_record()){ $prevStatus =$this->db->Record[I6218]; }parent::TTTl1lI($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno'])){ $sql ="update cms_adv_banners set id_owner='".$this->cms->VarsPost["advertiser"]."' where POSITION(';".$cId.";' in id_campaign)>0"; $this->db->query($sql); if($cId >0 && $prevStatus=='pending'){ $sql ="select * from cms_adv_campaigns where id='".$cId."' and id_owner>0"; $this->db->query($sql); if($this->db->next_record()){ if($this->db->Record[I6218] == 'active' || $this->db->Record[I6218] == I6208){ $this->cms->Gui->addBlock(I6250, $GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/letters/advertisement_" .$this->langData .".tpl"); $mailData =$this->db->Record; $mailData["SITE"] =$this->cms->Core->GetOption(I6251); $userId =intval($this->db->Record["id_owner"]); $I1lL1Il =$this->cms->Core->GetModule("adv_stats"); $mailData["STAT_LINK"] =$GLOBALS["ROOT_PATH_WWW"].$I1lL1Il->GetFrontLink(); if($this->cms->Core->IsInstalled(I6252)){ $I1lLlIL =&$this->GetExtension(I6252); $mailData["BANNER_LINK"] =$GLOBALS["ROOT_PATH_WWW"].$I1lLlIL->TITT1TI($this->cms, "adv_campaigns")."?action=locate&id=".intval($cId).I6253; }$mailData["note"] =stripslashes(unhtmlentities($this->cms->VarsPost["audit_comments"])); if($userId >0){ $sql ="select m.email, m.firstname, m.lastname, m.username from cms_members m where id=".$userId; $this->db->query($sql); if($this->db->next_record()){ $mailData["ADVERTISER_EMAIL"] =$this->db->Record[I6254]; $mailData["ADVERTISER_NAME"] =$this->db->Record["lastname"]." ".$this->db->Record["firstname"]; $mailData[I6255] =$this->db->Record["username"]; }}$ILLl1ll =$this->cms->Gui->get("adv_mails:adv_mail_header", $mailData). ($mailData[I6218] == I6208 ?$this->cms->Gui->get("adv_mails:mail_campaign_declined", $mailData) :$this->cms->Gui->get("adv_mails:mail_campaign_approved", $mailData)). $this->cms->Gui->get("adv_mails:adv_mail_footer", $mailData); if(!empty($mailData["ADVERTISER_EMAIL"])){ require_once($GLOBALS["CLASSES_PATH"]."Mailer.php"); $oMail =new Mailer(); $oMail->RecipientAddress =$mailData["ADVERTISER_EMAIL"]; $oMail->RecipientName =$mailData[I6256]; $oMail->SenderAddress =$this->cms->Core->GetOption("company_robot_email"); $oMail->SenderName =$this->cms->Core->GetOption("company_name"); $oMail->Subject =($mailData[I6218] == I6208 ?$this->cms->Gui->get("adv_mails:mail_campaign_declined_subject", $mailData) :$this->cms->Gui->get("adv_mails:mail_campaign_approved_subject", $mailData)); $oMail->Body =$ILLl1ll; $oMail->BodyFormat =I6257; $oMail->Prepare(); if(!$oMail->Send()){ trigger_error(I6258.$mailData["ADVERTISER_EMAIL"]." failed", E_USER_WARNING); }}}}}}}}function TTT1IlI($aSql =Array(), $cId =0) {$name =$this->cms->VarsPost["name"]; $tm =empty($this->cms->VarsPost["start_date"]) ?"0000-00-00 00:00:00" :DateTools::getCorrectUDate($this->cms->VarsPost["start_date"], $this->cms->DFMT["conf_dtime"]); $I1lL1l1 =empty($this->cms->VarsPost["end_date"]) ?I6203 :DateTools::getCorrectUDate($this->cms->VarsPost["end_date"], $this->cms->DFMT[I6259]); if($tm == "0000-00-00 00:00:00" && $this->cms->VarsPost[I6241] == "active"){ $tm =time(); if($this->cms->VarsPost["advertiser"] >0 && $this->cms->VarsPost["type"] >0){ $sql ="SELECT id, cost, name FROM cms_adv_campaign_types WHERE id = '".$this->cms->VarsPost["type"].I6249; $this->db->query($sql); $this->db->next_record(); $I1lL1LI =$this->db->Record[I6220]; $total =doubleval($this->db->Record["cost"]); $I1lL1Ll =$this->db->Record["name"]; $sql ="SELECT balance FROM cms_members WHERE id = '".$this->cms->VarsPost[I6260].I6249; $this->db->query($sql); $this->db->next_record(); $balance =doubleval($this->db->Record["balance"]); require_once $GLOBALS['CLASSES_PATH'] .'CMS_Member.php'; CMS_Member::unblockBalance($this->db, $this->cms->VarsPost[I6260], $total); CMS_Member::updateBalance($this->db, $this->cms->VarsPost[I6260], $balance, I6203, true, "admin", "%%hist_balance_campaign%% ".$I1lL1Ll); if($total >0){ $sql ="insert into cms_adv_cash set lang='".$this->langData."', id_member='".intval($this->cms->VarsPost[I6260])."', id_campaign='$I1lL1LI', price='$total', description='%%hist_balance_campaign%% $I1lL1Ll', date=NOW()"; $this->db->query($sql); }}}else if($this->cms->VarsPost[I6241] == "refused"){ if($this->cms->VarsPost[I6260] >0 && $this->cms->VarsPost["type"] >0){ $sql ="SELECT cost, name FROM cms_adv_campaign_types WHERE id = '".$this->cms->VarsPost["type"].I6249; $this->db->query($sql); $this->db->next_record(); $total =doubleval($this->db->Record["cost"]); $I1lL1Ll =$this->db->Record["name"]; $sql ="SELECT balance FROM cms_members WHERE id = '".$this->cms->VarsPost[I6260].I6249; $this->db->query($sql); $this->db->next_record(); $balance =doubleval($this->db->Record[I6261]); require_once $GLOBALS['CLASSES_PATH'] .'CMS_Member.php'; CMS_Member::updateBalance($this->db, $this->cms->VarsPost[I6260], $balance+$total, I6203, true, "admin", "%%hist_balance_campaign_declined%% ".$I1lL1Ll); }}$I1lLL1L =array(); if(!empty($this->cms->VarsPost[I6262])){ $sql ="select opt_def_max_views, opt_def_max_clicks, opt_def_max_views_day, opt_def_lifetime, opt_def_lifetime_units, opt_def_priority, ids_places, max_items, material_type from cms_adv_campaign_types where id=".intval($this->cms->VarsPost[I6262])." and lang='".$this->langData.I6249; $this->db->query($sql); if($this->db->next_record()) {$I1lLL1L =$this->db->Record; if(empty($I1lLL1L["opt_def_lifetime_units"])) $I1lLL1L["opt_def_lifetime_units"] =I6263; else if($I1lLL1L["opt_def_lifetime_units"] == "week"){ $I1lLL1L["opt_def_lifetime"] *= 7; $I1lLL1L["opt_def_lifetime_units"] =I6263; }$I1lLL1L[I6264] =intval($I1lLL1L["opt_def_lifetime"])." ".$I1lLL1L["opt_def_lifetime_units"]; }}if(!empty($name) && !empty($tm) && count($I1lLL1L) >0){ $aSql =array( I6243=>intval($this->cms->VarsPost[I6243]), I6218=>$this->cms->VarsPost[I6241], "name"=>$this->cms->VarsPost[I6265], "id_type"=>intval($this->cms->VarsPost[I6262]), "start_date"=>($tm != '0000-00-00 00:00:00' ?DateTools::toMysqlDate($tm) :$tm), I6264=>(!empty($I1lL1l1) ?DateTools::toMysqlDate($I1lL1l1) :($tm != '0000-00-00 00:00:00' ?I6266.DateTools::toMysqlDate($tm)."', INTERVAL ".$I1lLL1L[I6264].")" :$tm)), "max_items"=>$I1lLL1L["max_items"], I6267=>$I1lLL1L[I6267], "max_views"=>$I1lLL1L["opt_def_max_views"], "max_views_day"=>$I1lLL1L["opt_def_max_views_day"], I6268=>$I1lLL1L["opt_def_max_clicks"], "priority"=>$I1lLL1L["opt_def_priority"], "ids_places"=>$I1lLL1L[I6269], I6223=>$this->cms->VarsPost[I6260], "id_owner"=>$this->cms->VarsPost[I6260], );}$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }}