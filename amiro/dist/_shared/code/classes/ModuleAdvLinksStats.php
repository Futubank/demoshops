<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       35210 xkqwutkwklnlmytyrsinsisypxlpiglpmlmpwpuszylgtqptnmtrktiusgukttzygnuupnir
 */ ?><?php foreach(array(6289=>"PrHuG|HGQrZtMHnD",6290=>"fJt|rQGHrtYB",6291=>"fJt|PrHuGYB",6292=>"b+I+01?o%M%D",6293=>"b+I+01?00%00%00",6294=>"fJt|ZSv|YJHWK",6295=>"fJt|ZSv|nZIQ",6296=>"NhT?zjjhcqs",6297=>"DGQW|IHSuJQ|YHSB",6298=>"IHSuJQ|DGQWYJHWK",6299=>"GZPQD",6300=>"IHSuJQ|GZPQD",6301=>"?%?",6302=>"unKnHCn|IHSuJQ",6303=>"",6304=>"tQxt",6305=>"fJt|ZSv|urJ",6306=>"fJt|ZSv|GZPQ|urJ",6307=>"JMnK|DtZtD|IHSuJQD",6308=>"YBOHur",6309=>"DQJQWt",6310=>"YBIHSuJQD",6311=>"YBJMnKD",6312=>"SZBtH",6313=>"SZtQ",6314=>"ZSv|JMnKD|DtZtD",6315=>"WZJW|JZDt",6316=>"SZtZ",6317=>"SZB|tI",6318=>"RhhT|gzTo|ccc",6319=>"vMQCD",6320=>"`",6321=>"=_",6322=>"'?zNs?SZB='",6323=>"?}",6324=>"'?zNs?MS|JMnK='",6325=>"urJ",6326=>"IHS|nZIQ",6327=>"fuJJ|SZtQ",6328=>"OHur|HnJB",6329=>"{",6330=>"vZJuQ",6331=>"WHunt",6332=>"GZPQ|urJ|OZDO",6333=>"b+I+S?00%00%00",6334=>"25",6335=>"HGtMIMAQS|JZDt",6336=>"00+23",6337=>"WJMWKD",6338=>"IHSuJQ|nZIQ",6339=>"tMtJQ",6340=>"nZIQ",6341=>"```",6342=>"``",6343=>"SY",6344=>"bqzR}D`SZB{",6345=>"DGZn|WHJuIn|WHunt",6346=>"JMDt|SZtZ",6347=>"shNTdohc|whj|Nziq",6348=>"shNTdohc|whj|ihsd",6349=>"?ZD?SZB",6350=>"?ZD?vMQCD!?D`GZPQ|urJ!?D`IHS|nZIQ?ZD?IHSuJQ|nZIQ!?D`urJ!?D`nZIQ!?",6351=>"Wtr",6352=>"=_D`SZB?",6353=>"fMQJSD",6354=>"|WZJWuJZtQwTRwy",6355=>"IQtOHS",6356=>"HYLQWt",6357=>"ZWtMHn",6358=>"|PQtiHSuJQNZIQwy",6359=>"fHrI|SZtZ",6360=>"DuI|WJMWKD",6361=>"DuI|vMQCD",6362=>"DQJQWtQS") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleAdvLinksStats extends CMS_ActModule {public $IlL1LLL; public $IlL11II; public $dayFrom; public $dayTo; public $I1lL1LL; public $I1lL1L1; public $I1lL11I; public $I1lL11l; public $I1lL11L; function ModuleAdvLinksStats(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->IlL1LLL =0; $this->IlL11II =0; $this->I1lL11L =array(); }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {$IIIIL11[I6289] =Array(); $IIIIL11["lang_data"] =false; $IIIIL11["check_public"] =false; $IIIIL11["allowed_actions"] =Array("none"); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->IlL1LLL =isset($this->cms->VarsPost[I6290]) ?$this->cms->VarsPost[I6290] :$this->cms->VarsGet[I6290]; if(empty($this->IlL1LLL)) $this->IlL1LLL =0; if(!isset($this->cms->VarsPost[I6290]) && !isset($this->cms->VarsGet[I6290])) $this->IlL1LLL =3; else if(empty($this->IlL1LLL)) $this->IlL1LLL =0; $this->IlL11II =isset($this->cms->VarsPost["flt_groupby"]) ?$this->cms->VarsPost["flt_groupby"] :$this->cms->VarsGet["flt_groupby"]; if(!isset($this->cms->VarsPost["flt_groupby"]) && !isset($this->cms->VarsGet[I6291])) $this->IlL11II =3; else if(empty($this->IlL11II)) $this->IlL11II =0; $this->dayFrom =isset($this->cms->VarsPost["dayfrom"]) ?$this->cms->VarsPost["dayfrom"] :$this->cms->VarsGet["dayfrom"]; if(empty($this->dayFrom)) $this->dayFrom =date($this->cms->DFMT["php"], strtotime(date(I6292))); $this->dayTo =isset($this->cms->VarsPost["dayto"]) ?$this->cms->VarsPost["dayto"] :$this->cms->VarsGet["dayto"]; if(empty($this->dayTo)) $this->dayTo =date($this->cms->DFMT["php"], strtotime(date(I6293, strtotime("+1 month")))-1); $this->I1lL1LL =isset($this->cms->VarsPost["flt_adv_page_url"]) ?$this->cms->VarsPost["flt_adv_page_url"] :$this->cms->VarsGet["flt_adv_page_url"]; $this->I1lL1L1 =isset($this->cms->VarsPost[I6294]) ?$this->cms->VarsPost[I6294] :$this->cms->VarsGet[I6294]; $this->I1lL11I =isset($this->cms->VarsPost["flt_adv_url"]) ?$this->cms->VarsPost["flt_adv_url"] :$this->cms->VarsGet["flt_adv_url"]; $this->I1lL11l =isset($this->cms->VarsPost["flt_adv_name"]) ?$this->cms->VarsPost[I6295] :$this->cms->VarsGet[I6295]; $this->TIITITl(); }function _InitAdmin() {parent::_InitAdmin(); $IIlLL1I =$this->module->GetOption("proc_statistics_by"); if(defined("DAEMON_LOGIN_OK")){ if(in_array("daemon", $IIlLL1I)){ $this->TIITIII(); $this->TIITIIl(); print "OK"; }else{ print I6296; }exit; }else if(in_array("admin", $IIlLL1I)){ $this->TIITIII(); $this->TIITIIl(); }}function TIITITl(){ $I1lL111 =$this->cms->Gui->ParseLangFile("templates/lang/ce_specblocks.lng"); $I1l1III =array(); foreach($this->cms->Core->GetProperty("spec_blocks") as $sbName => $null){ if($sbName != I6297) $I1l1III[$sbName] =$I1lL111[I6298]." : ".$I1lL111[$sbName]; }asort($I1l1III); $I1l1IIl =array(); foreach ($this->cms->Core->GetAllModules() as $oModule){ if(is_object($oModule) && $oModule->IsInstalled() && $oModule->IsFrontAllowed()){ if($oModule->Name == I6299){ $I1l1IIl[I6299] =$I1lL111[I6300]; continue; }$moduleName =$oModule->Name; $res =$oModule->GetOption("admin_menu_caption"); $I1l1IIL =""; $ownerName =$oModule->GetOwnerName(); if(!empty($ownerName)){ $ownerData =$this->cms->Core->OwnerGetData($ownerName); $I1l1IIL =$ownerData["admin_menu_caption"]; }if($oModule->HaveParent()){ while($oModule->HaveParent()){ $oModule =$oModule->TTlIIIT(); }$res =$oModule->GetOption("admin_menu_caption").I6301.$res; }$I1l1IIl[$moduleName] =(!empty($I1l1IIL) ?$I1l1IIL.I6301 :"").$res; }}asort($I1l1IIl); $this->I1lL11L =$I1l1III +$I1l1IIl; }function TIITIT1($modName){ return isset($this->I1lL11L[$modName]) ?$this->I1lL11L[$modName] :$this->words[I6302]; }function TTTlIII() {parent::TTTlIII(); $this->filter->TITI1l1("datefrom"); $this->filter->TITI1l1("dateto"); $I1l1II1 =unhtmlentities($this->cms->Vars[I6295]); $this->filter->AddField(I6295, "text", stripslashes($I1l1II1), I6303, "like", "s.name"); $this->filter->MoveField(I6295, _MOVE_START); if(empty($this->cms->Vars[I6295])) $this->filter->DisableFieldSQL(I6295); $I1l1II1 =unhtmlentities($this->cms->Vars["flt_adv_url"]); $this->filter->AddField("flt_adv_url", I6304, stripslashes($I1l1II1), I6303, "like", "s.url"); $this->filter->MoveField("flt_adv_url", _MOVE_START); if(empty($this->cms->Vars["flt_adv_url"])) $this->filter->DisableFieldSQL(I6305); $I1l1II1 =unhtmlentities($this->cms->Vars["flt_adv_page_url"]); $this->filter->AddField("flt_adv_page_url", I6304, stripslashes($I1l1II1), I6303, "like", "s.page_url"); $this->filter->MoveField(I6306, _MOVE_START); if(empty($this->cms->Vars[I6306])) $this->filter->DisableFieldSQL(I6306); $I1l1IlI =Array(); $I1l1IlI =$this->filter->TITI1TT($I1l1Ill, Array($this->cms->Words["all"]=>0), 55); $I1l1IlL =$this->module->GetOption(I6307); foreach($this->I1lL11L as $modName => $modCaption){ if(in_array($modName, $I1l1IlL)) $I1l1IlI =$this->filter->TITI1TT($I1l1IlI, Array($modCaption=>$modName), 55); }$this->filter->AddField(I6294, "select", $this->I1lL1L1, I6303, "=", "s.mod_name", $I1l1IlI); $this->filter->MoveField(I6294, _MOVE_START); $this->filter->TITIll1(I6294); if(empty($this->I1lL1L1)) $this->filter->DisableFieldSQL(I6294); $IlL1L1l =Array(); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words[I6308]=>0), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["byday"]=>1), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["byweek"]=>2), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["bymonth"]=>3), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["byyear"]=>4), 55); $this->filter->AddField(I6290, I6309, $this->IlL1LLL, I6303, "=", "id", $IlL1L1l); $this->filter->MoveField(I6290, _MOVE_START); $this->filter->DisableFieldSQL(I6290); $IlL11Il =Array(); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byall"]=>0), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["bypages"]=>1), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words[I6310]=>2), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words[I6311]=>3), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byhrefs"]=>4), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byperiod"]=>5), 55); $this->filter->AddField(I6291, I6309, $this->IlL11II, I6303, "=", "id", $IlL11Il); $this->filter->MoveField(I6291, _MOVE_START); $this->filter->DisableFieldSQL(I6291); $this->filter->AddField(I6312, "date", $this->dayTo, time(), "<=", "s.day"); $this->filter->MoveField(I6312, _MOVE_START); $this->filter->AddField("dayfrom", I6313, $this->dayFrom, time(), ">=", "s.day"); $this->filter->MoveField("dayfrom", _MOVE_START); }function TIITIIT(){ list($usec, $sec) =explode(" ", microtime()); return((float)$usec +(float)$sec); }function TIITIII(){ $vData =array(); if($this->cms->Core->ReadOption($vData, I6314, "calc_last")){ $vData["value"] =intval($vData["value"]); if($vData["value"]+7200 >time()) return; }$this->cms->Core->WriteOption(I6314, I6315, time()); $GLOBALS["conn"]->SetBenchType('LONG'); $dbi =new db_si; $I1l1Il1 =0; $I1l1ILI =$this->TIITIIT(); $I1l1ILl =2.00; $I1l1ILL =1; $I1l1IL1 =500; $I1l1I1I =150; $I1l1I1l =$this->module->GetOption("front_links_stats_unique"); if($I1l1I1l){ $I1l1I1L =array(); $I1l1I11 =array(); $I1l1lII =3600; $I1l1lIl =0; $sql ="select data from cms_adv_links_stats_tmp where type='users' order by id desc"; $this->db->query($sql); if($this->db->next_record()){ $I1l1lIL =unserialize($this->db->Record[I6316]); if(is_array($I1l1lIL) && sizeof($I1l1lIL) == 2) list($I1l1I1L, $I1l1I11) =$I1l1lIL; unset($I1l1lIL); $sql ="delete LOW_PRIORITY from cms_adv_links_stats_tmp where type='users'"; $this->db->query($sql); }}$I1l1lI1 =array(); $I1l1llI =-1; $sql ="select *, UNIX_TIMESTAMP(day) as day_tm from cms_adv_links_stats_tmp order by day"; $this->db->query($sql); while($this->db->next_record()){ set_time_limit(60); if($I1l1I1l){ if(!isset($I1l1I1L[$this->db->Record["user_ip"]]) || $I1l1I1L[$this->db->Record["user_ip"]]+$I1l1lII <$this->db->Record[I6317]){ $I1l1I1L[$this->db->Record["user_ip"]] =$this->db->Record[I6317]; $I1l1I11[$this->db->Record["user_ip"]] =array(); }$I1l1lIl =max($I1l1lIl, $this->db->Record[I6317]); }$I1llLI1 =$this->db->Record["page_url"]; if(mb_strpos($I1llLI1, $GLOBALS["ROOT_PATH_WWW"]) === 0) $I1llLI1 =mb_substr($I1llLI1, mb_strlen($GLOBALS[I6318])); $I1l1lll =md5($I1llLI1); if(mb_strlen($I1llLI1) >255) $I1llLI1 =mb_substr($I1llLI1, 0, 252)."..."; $fieldName =$this->db->Record["type"] == "click" ?"clicks" :I6319; $I1l1llL =unserialize($this->db->Record[I6316]); for($i =0; $i <sizeof($I1l1llL); $i++){ if($I1l1Il1 == 0 || $I1l1Il1 %$I1l1IL1 == 0){ print " "; ob_flush(); if($this->TIITIIT() -$I1l1ILI >= $I1l1ILl){ sleep($I1l1ILL); $I1l1ILI =$this->TIITIIT(); set_time_limit(60); }}$I1l1Il1++; if($I1l1I1l){ if(isset($I1l1I11[$this->db->Record["user_ip"]][$I1l1lll.".".$I1l1llL[$i]["id_link"].I6320.$fieldName])) continue; else $I1l1I11[$this->db->Record["user_ip"]][$I1l1lll.I6320.$I1l1llL[$i]["id_link"].I6320.$fieldName] =1; }$I1l1ll1 =$I1l1llL[$i]["url"]; if(mb_strlen($I1l1ll1) >255) $I1l1ll1 =mb_substr($I1l1ll1, 0, 252)."..."; $I1l1lLI =array($fieldName => I6321.$fieldName."+1"); $I1l1lLl ="where page_url_hash='".$I1l1lll."' AND id_link='".$I1l1llL[$i]["id_link"].I6322.$this->db->Record["date_only"]."' AND hour='".$this->db->Record["hour_only"]."'"; $sql =$dbi->GenUpdateSql("cms_adv_links_stats", $I1l1lLI, $I1l1lLl, DBC_LOW_PRI); $dbi->query($sql); if($dbi->affectedRows() <= 0){ if($fieldName == I6319){ $I1l1lLL =md5($I1l1llL[$i]["url"]."::".$I1l1llL[$i]["name"]); $I1l1lL1 =$I1l1llL[$i]["name"]; $I1l1lL1 =trim(strip_tags($I1l1lL1)); if(empty($I1l1lL1)){ if(preg_match('/<img[^>]*?src\s*?=\s*?("[^">]*?"|\'[^\'>]*?\'|[^ >]*?)[^>]*?>/si', $I1l1llL[$i]["name"], $matches)){ $I1l1lL1 ="[IMG]: ".trim($matches[1], "\r\n '\""); if(preg_match('/<img[^>]*?(?:(?:alt|title)\s*?=\s*?("[^">]*?"|\'[^\'>]*?\'|[^ >]*?))/si', $matches[0], $matches)){ $I1l1lL1 .= I6323.trim($matches[1], "\r\n '\"").")"; }}}}else if($fieldName == "clicks"){ $sql ="select mod_name, url, name, id_link_only from cms_adv_links_stats where page_url_hash='".$I1l1lll.I6324.$I1l1llL[$i]["id_link"]."' order by full_date desc limit 1"; $dbi->query($sql); if($dbi->next_record()){ $I1l1llL[$i]["mod_name"] =$dbi->Record["mod_name"]; $I1l1ll1 =$dbi->Record[I6325]; $I1l1lL1 =$dbi->Record["name"]; $I1l1lLL =$dbi->Record["id_link_only"]; }else continue; }$IILIllL =array( "page_url" => mysql_real_escape_string($I1llLI1), "page_url_hash" => $I1l1lll, I6326 => $I1l1llL[$i][I6326], "id_link" => $I1l1llL[$i]["id_link"], "id_link_only" => $I1l1lLL, I6325 => mysql_real_escape_string($I1l1ll1), "name" => mysql_real_escape_string($I1l1lL1), I6327 => $this->db->Record["day"], "day" => $this->db->Record["date_only"], "hour" => $this->db->Record[I6328], I6319 => $fieldName == I6319 ?1 :0, "clicks" => $fieldName == "clicks" ?1 :0, );$sql =$dbi->GenInsertSql("cms_adv_links_stats", $IILIllL, DBC_LOW_PRI); $dbi->query($sql); }}array_push($I1l1lI1, intval($this->db->Record["id"])); if(sizeof($I1l1lI1) >= $I1l1I1I){ $sql ="delete LOW_PRIORITY from cms_adv_links_stats_tmp where id in (".implode(',', $I1l1lI1).")"; $dbi->query($sql); }if($I1l1I1l && $I1l1llI != $this->db->Record[I6328]){ if($I1l1llI >= 0){ foreach($I1l1I1L as $I1l1l1I => $I1l1l1l){ if($I1l1l1l+$I1l1lII <$I1l1lIl){ unset($I1l1I1L[$I1l1l1I]); if(isset($I1l1I11[$I1l1l1I])) unset($I1l1I11[$I1l1l1I]); }}}$I1l1llI =$this->db->Record[I6328]; }}if(sizeof($I1l1lI1) >0){ $sql ="delete LOW_PRIORITY from cms_adv_links_stats_tmp where id in (".implode(',', $I1l1lI1).I6329; $dbi->query($sql); }if($I1l1I1l){ foreach($I1l1I1L as $I1l1l1I => $I1l1l1l){ if($I1l1l1l+$I1l1lII <$I1l1lIl){ unset($I1l1I1L[$I1l1l1I]); if(isset($I1l1I11[$I1l1l1I])) unset($I1l1I11[$I1l1l1I]); }}if(sizeof($I1l1I1L) >0){ $IILIllL =array( "type" => "users", I6316 => mysql_real_escape_string(serialize(array($I1l1I1L, $I1l1I11))) );$sql =$dbi->GenInsertSql("cms_adv_links_stats_tmp", $IILIllL, DBC_LOW_PRI); $dbi->query($sql); }}$this->cms->Core->DeleteOption(I6314, I6315); }function TIITIIl(){ $dbi =new db_si; $vData =array(); if($this->cms->Core->ReadOption($vData, I6314, "calc_old_last")){ $vData[I6330] =intval($vData[I6330]); if($vData[I6330]+7200 >time()) return; }$this->cms->Core->WriteOption(I6314, "calc_old_last", time()); $I1l1l1L =intval($this->module->GetOption("days_to_keep_hour_stats")); if($I1l1l1L >0){ $sql ="select count(*) as count from cms_adv_links_stats where day<DATE_ADD(NOW(), INTERVAL -".$I1l1l1L." DAY) and hour!=25"; $this->db->query($sql); $this->db->next_record(); $I1l1l11 =I6303; $I1l1LII =false; if($this->db->Record[I6331] >0){ $sql ="select page_url, page_url_hash, mod_name, id_link, url, name, UNIX_TIMESTAMP(full_date) as full_date, day, sum(views) as views, sum(clicks) as clicks from cms_adv_links_stats where day<DATE_ADD(NOW(), INTERVAL -".$I1l1l1L." DAY) and hour!=25 group by day, page_url_hash, mod_name, id_link order by day"; $this->db->query($sql); $cnt =0; while($this->db->next_record()){ $cnt++; $IILIllL =array( "page_url" => mysql_real_escape_string($this->db->Record["page_url"]), I6332 => $this->db->Record[I6332], I6326 => $this->db->Record[I6326], "id_link" => $this->db->Record["id_link"], I6325 => mysql_real_escape_string($this->db->Record[I6325]), "name" => mysql_real_escape_string($this->db->Record["name"]), I6327 => date(I6333, $this->db->Record["full_name"]), "day" => $this->db->Record["day"], "hour" => I6334, I6319 => $this->db->Record[I6319], "clicks" => $this->db->Record["clicks"], );$sql =$dbi->GenInsertSql("cms_adv_links_stats", $IILIllL, DBC_LOW_PRI); $dbi->query($sql); $I1l1LII =false; if($I1l1l11 != $this->db->Record["day"]){ if(!empty($I1l1l11)){ $I1l1LII =true; $sql ="delete LOW_PRIORITY from cms_adv_links_stats where day='".$I1l1l11."' and hour!=25"; $dbi->query($sql); }$I1l1l11 =$this->db->Record["day"]; }}if(!$I1l1LII && !empty($I1l1l11)){ $sql ="delete LOW_PRIORITY from cms_adv_links_stats where day='".$I1l1l11."' and hour!=25"; $dbi->query($sql); }}}$I1l1LIl =false; if($this->cms->Core->ReadOption($vData, I6314, I6335)){ $vData[I6330] =intval($vData[I6330]); if(time() -$vData[I6330] >345600 ){$I1l1LIL =getdate(); if($I1l1LIL["wday"] == 0 && $I1l1LIL["hours"] <8 || $I1l1LIL["wday"] >0 && $I1l1LIL["wday"] <4) $I1l1LIl =true; }}else $I1l1LIl =true; if($I1l1LIl){ $sql ="optimize table cms_adv_links_stats_tmp"; $dbi->query($sql); $sql ="optimize table cms_adv_links_stats"; $dbi->query($sql); $this->cms->Core->WriteOption(I6314, I6335, time()); }$this->cms->Core->DeleteOption(I6314, "calc_old_last"); }function _procHourCB(&$vItem, &$vData){ $vItem["hour"] =$vItem["hour"] >23 ?I6336 :sprintf("%02s", $vItem["hour"]); }function _calculateCTRCB(&$vItem, &$vData){ $vItem["ctr"] =sprintf('%.02f', min(100, ($vItem[I6319] >0 ?$vItem[I6337]/$vItem[I6319] :0)*100)); }function _getModuleNameCB(&$vItem, &$vData){ $vItem[I6338] =$this->TIITIT1($vItem[I6338]); }function _getPageUrlCB(&$vItem, &$vData){ $aData[I6325] =$aData["title"] =$aData["name"] =$vItem["page_url"]; if(empty($aData["name"])) $aData[I6339] =$aData["name"] ="/"; $maxLen =60; if(mb_strlen($aData["name"]) >$maxLen+3){ $aData["name"] =mb_substr($aData[I6340], 0, $maxLen/2)."...".mb_substr($aData[I6340], -$maxLen/2); }$aData[I6325] =$GLOBALS[I6318].$aData[I6325]; $vItem["page_url"] =$this->cms->Gui->get("adv_links_stats_list:new_wnd_url", $aData); }function _getUrlCB(&$vItem, &$vData){ $aData[I6325] =$aData[I6339] =$aData[I6340] =$vItem[I6325]; if(empty($aData[I6340])) $aData[I6339] =$aData[I6340] ="/"; $maxLen =60; if(mb_strlen($aData[I6340]) >$maxLen+3){ $aData[I6340] =mb_substr($aData[I6340], 0, $maxLen/2).I6341.mb_substr($aData[I6340], -$maxLen/2); }if(!preg_match('/^javascript:/si', $aData[I6325])){ if(!preg_match('/^https?:\/\//si', $aData[I6325])) $aData[I6325] =$GLOBALS[I6318].$aData[I6325]; $vItem[I6325] =$this->cms->Gui->get("adv_links_stats_list:new_wnd_url", $aData); }else{ $vItem[I6325] =$this->cms->Gui->get("adv_links_stats_list:plain_url", $aData); }}function &TTTlI1T(&$aCustom) {return parent::TTTlI1T($aCustom); }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {$IlL11II =I6303; $IlL1LLL =I6303; $I1l1LI1 ="DATE_FORMAT(s.day,'".$this->cms->DFMT["db"]."')"; $I1l1LlI ="sum(s.views)"; $I1l1Lll ="sum(s.clicks)"; $I1l1LlL ="s.id/s.id*IF(sum(views)=0,0,sum(clicks)/sum(views))"; $I1l1Ll1 =I6303; switch($this->IlL1LLL){ case 0: $IlL1LLL ="s.day, s.hour"; break; case 1: $IlL1LLL ="s.day"; break; case 2: $dfmt =$this->cms->DFMT["db"]; $dfmt =str_replace(array("%d", I6342), array(I6303, I6303), $dfmt); $dfmt =trim($dfmt, I6320); $I1l1LI1 ="DATE_FORMAT(s.day,'".$dfmt."')"; $IlL1LLL ="YEAR(s.day), WEEK(s.day)"; $I1l1Ll1 =", WEEK(s.day) as week"; break; case 3: $dfmt =$this->cms->DFMT[I6343]; $dfmt =str_replace(array("%d", I6342), array(I6303, I6303), $dfmt); $dfmt =trim($dfmt, I6320); $I1l1LI1 ="DATE_FORMAT(s.day,'".$dfmt."')"; $IlL1LLL ="YEAR(s.day), MONTH(s.day)"; break; case 4: $I1l1LI1 =I6344; $IlL1LLL =I6344; break; }$aCustom["list_data"]["span_column_count"] =6; if($this->IlL1LLL >0){ $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_HOUR" => 1)); $aCustom["list_data"][I6345] -= 1; $I1l1LlI ="sum(s.views)"; $I1l1Lll ="sum(s.clicks)"; $I1l1LlL ="s.id/s.id*IF(sum(views)=0,0,sum(clicks)/sum(views))"; }if($this->IlL1LLL == 2){ $this->cms->Gui->addGlobalVars(array("HAS_FLD_WEEK" => 1)); }$aCustom[I6346]["groupBy"] =$this->IlL11II; switch($this->IlL11II){ case 1: $IlL11II ="s.page_url_hash"; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_MODS" => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_URL" => 1)); $this->cms->Gui->addGlobalVars(array(I6347 => 1)); $aCustom[I6346][I6345] -= 3; break; case 2: $IlL11II ="s.mod_name"; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PAGE" => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_URL" => 1)); $this->cms->Gui->addGlobalVars(array(I6347 => 1)); $aCustom[I6346][I6345] -= 3; break; case 3: $IlL11II ="s.page_url_hash, s.id_link"; $this->cms->Gui->addGlobalVars(array(I6348 => 1)); $aCustom[I6346][I6345] -= 1; break; case 4: $IlL11II ="s.id_link_only"; $this->cms->Gui->addGlobalVars(array(I6348 => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PAGE" => 1)); $aCustom[I6346][I6345] -= 2; break; case 5: $IlL11II =I6303; $this->cms->Gui->addGlobalVars(array(I6348 => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PAGE" => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_URL" => 1)); $this->cms->Gui->addGlobalVars(array(I6347 => 1)); $aCustom[I6346][I6345] -= 4; break; default: $IlL11II ="s.page_url_hash, s.mod_name, s.id_link"; break; }$I1l1LLI =$this->browser->SortDim == "asc" ?"asc" :"desc"; $this->browser->InitSQL("s.id, ".$I1l1LI1.I6349.$I1l1Ll1.", ".($this->IlL1LLL >0 ?I6303 :"s.hour, ").$I1l1Lll." as clicks, ".$I1l1LlI.I6350.$I1l1LlL." as ctr", "FROM cms_adv_links_stats s", "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), $IlL1LLL.(!empty($IlL1LLL) && !empty($IlL11II) ?", " :I6303).$IlL11II, "s.day, s.hour, s.page_url, s.mod_name, s.url, s.name", "s.day, s.hour, s.views, s.clicks", array(I6351 => "=|ctr", I6337 => "=|clicks", I6319 => "=|views", "day" => I6352.$I1l1LLI.", s.hour", "hour" => "=|s.hour ".$I1l1LLI.", s.day") );$aCustom[I6353] += Array( I6337 => Array("action"=>"callback", "object"=>&$this, "method"=>I6354), "hour" => Array("action"=>"callback", "object"=>&$this, I6355=>"_procHourCB"), "page_url" => Array("action"=>"callback", I6356=>&$this, I6355=>"_getPageUrlCB"), I6325 => Array("action"=>"callback", I6356=>&$this, I6355=>"_getUrlCB"), I6338 => Array(I6357=>"callback", I6356=>&$this, I6355=>I6358), );$aCustom["applied_id"] ="s.id"; $aCustom["legend"] =Array(); $aCustom[I6359]["buttons"] =Array(); $sql ="select sum(s.views) as sviews, sum(s.clicks) as sclicks FROM cms_adv_links_stats s where 1 ".$this->_ApplyFilters().$this->TTTlIl1(); $this->db->query($sql); if($this->db->next_record()){ $aCustom[I6346]["sum_views"] =$this->db->Record["sviews"]; $aCustom[I6346][I6360] =$this->db->Record["sclicks"]; $aCustom[I6346]["sum_ctr"] =sprintf('%.02f', min(100, ($aCustom[I6346]["sum_views"] >0 ?$aCustom[I6346][I6360]/$aCustom[I6346][I6361] :0)*100)); }parent::TTTlI11($vData, $aCustom); }function getLinkStatsModulesCB($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues"){ switch($IIL1l1I){ case "getallvalues": $rec =array(); foreach($this->I1lL11L as $modName => $modCaption){ $numRows ++; $res[] =array( I6340 => $modName, "caption" => $modCaption, "selected" => (is_array($cData[I6330]) && in_array($modName, $cData[I6330]) ?I6362 :I6303) );}if($numRows == 0){ return false; }break; case "getvalue": $res =$cData[I6330]; break; case "correctvalue": $res =array(); foreach($this->module->GetOption(I6307) as $modName) $res[] =$modName; break; case "apply": break; }return true; }}?>