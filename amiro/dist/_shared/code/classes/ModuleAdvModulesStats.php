<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       46098 xkqwnmksziiminpnntwgptmpglrsykizwsiwpspstzqrkutnzsuxtyrymnmwplmiwnqzpnir
 */ ?><?php foreach(array(6363=>"",6364=>"nHnQ",6365=>'fJt|rQGHrtYB',6366=>'fJt|PrHuGYB',6367=>'SZBfrHI',6368=>'-1?IHntO',6369=>'fJt|ZSv|GJZWQD',6370=>"GrHW|DtZtMDtMWD|YB",6371=>"ZSIMn",6372=>"DtZt|frHnt|IHSuJQD",6373=>"ZSv|IHSuJQD",6374=>"ZSIMn|IQnu|WZGtMHn",6375=>"unKnHCn|IHSuJQ",6376=>"IHSuJQ|",6377=>"IHSuJQ|unKnHCn",6378=>"fJt|ZSv|MtQI",6379=>"ZJJ",6380=>"fJt|IHSuJQD",6381=>"D`IHSuJQ|nZIQ",6382=>"DQJQWt?MS!?nZIQ?frHI?WID|ZSv|GJZWQD?COQrQ?GuYJMW=1?ZnS?DHurWQ|tBGQ='IHSuJQ'?HrSQr?YB?nZIQ",6383=>"fJt|ZSv|GJZWQD",6384=>"fJt|ZSvQrtMDQr|MS",6385=>":",6386=>"fHrWQ",6387=>"YBBQZr",6388=>"fJt|rQGHrtYB",6389=>"YBIHSuJQD",6390=>"fJt|PrHuGYB",6391=>"SZtQ",6392=>"@=",6393=>"b+I+01?o%M%D",6394=>"-1?IHntO",6395=>"YBCQQK",6396=>"YBZJJ",6397=>"=",6398=>"DQJQWt?MS!?nZIQ?frHI?WID|ZSv|GJZWQD?COQrQ?GuYJMW=1?zNs?DHurWQ|tBGQ='IHSuJQ'?HrSQr?YB?nZIQ",6399=>"D`MS|GJZWQ",6400=>"YHSB|MtQID",6401=>"'",6402=>"JMDt|SZtZ",6403=>"``",6404=>"'{",6405=>"shNTdohc|whj|ohUR",6406=>"DGZn|WHJuIn|WHunt",6407=>"D`MS|GJZWQ!?D`IHSuJQ|nZIQ!?D`MS|MtQI",6408=>"ZDW",6409=>"D`OHur!?",6410=>"?ZD?vMQCD!?D`IHSuJQ|nZIQ?ZD?IHSuJQ|nZIQ!?D`MtQI|nZIQ?ZD?MtQI|nZIQ!?G`nZIQ?ZD?GJZWQ|nZIQ!?",6411=>"FRhi?WID|ZSv|IHSuJQD|DtZtD?D?jqFT?lhmN?WID|ZSv|GJZWQD?G?hN?D`MS|GJZWQ=G`MS",6412=>"'?ZnS?D`IHSuJQ|nZIQ?Mn?}'",6413=>"'!'",6414=>"D`SZB!?D`OHur!?D`MS|GJZWQ!?D`IHSuJQ|nZIQ!?D`MS|MtQI",6415=>"GJZWQ|nZIQ",6416=>"=_WJMWKD",6417=>"!?D`OHur",6418=>'G',6419=>"WZJJYZWK",6420=>"OHur",6421=>"fMQJSD",6422=>"IHSuJQ|nZIQ",6423=>"|PQtiHSuJQNZIQFrHntwy",6424=>"0",6425=>"DQJQWt?DuI}D`vMQCD{?ZD?DvMQCD!?DuI}D`WJMWKD{?ZD?DWJMWKD?FRhi?WID|ZSv|IHSuJQD|DtZtD?D?COQrQ?D`MS|HCnQr='",6426=>"DuI|vMQCD",6427=>':`02f',6428=>"vMQCD",6429=>"ZSv|IHSuJQD|DtZtD",6430=>"vZJuQ",6431=>"ZSv|IHSuJQD|nZIQD",6432=>"IZx|SZB",6433=>"DQJQWt?SZB!?OHur?frHI?WID|ZSv|IHSuJQD|DtZtD?HrSQr?YB?SZB?SQDW!?OHur?SQDW?JMIMt?1",6434=>"IZx|OHur",6435=>"frHI?WID|ZSv|IHSuJQD|DtZtD|tIG?",6436=>"SQJQtQ?frHI?WID|ZSv|IHSuJQD|DtZtD|tIG?COQrQ?YHSB|tBGQ='",6437=>"'?ZnS?SZB='",6438=>"IHS|nZIQ",6439=>"frHI?WID|ZSv|IHSuJQD|DtZtD|tIG?COQrQ?DtZt|GrHWQDDQS,=1?",6440=>"s",6441=>"SZB",6442=>"OHur|HnJB",6443=>"WHunt",6444=>"WID|ZSv|IHSuJQD|DtZtD",6445=>"'?ZnS?IHSuJQ|nZIQ='",6446=>"SZtQ|HnJB",6447=>"MS|MtQI",6448=>"uGSZtQ?WID|ZSv|IHSuJQD|DtZtD|tIG?DQt?DtZt|GrHWQDDQS=1?COQrQ?YHSB|tBGQ='",6449=>"'?ZnS?MS|MtQI='",6450=>"?COQrQ?MS?Mn}",6451=>"uGSZtQ?WID|ZSv|IHSuJQD|DtZtD?DQt?MS|HCnQr='",6452=>"MS|HCnQr",6453=>"{",6454=>"SQJQtQ?frHI?WID|ZSv|IHSuJQD|DtZtD|tIG?COQrQ?WHuntQr|GrHWQDDQS=1?zNs?DtZt|GrHWQDDQS=1",6455=>"mNdqRT?jhc|gRmhRmTb?mNTh?WID|ZSv|IHSuJQD|DtZtD?DQt?MS|GJZWQ='",6456=>"MS|GJZWQ",6457=>"'!?IHSuJQ|nZIQ='",6458=>"SQJQtQ?jhc|gRmhRmTb?frHI?WID|ZSv|IHSuJQD|DtZtD?COQrQ?SZB='",6459=>"HGtMIMAQS|JZDt",6460=>"HGtMIMAQ?tZYJQ?WID|ZSv|IHSuJQD|DtZtD|tIG",6461=>"HGtMIMAQ?tZYJQ?WID|ZSv|IHSuJQD|DtZtD",6462=>"WZJW|HJS|JZDt",6463=>"YHSB",6464=>"vZrD",6465=>"DuI}D`vMQCD{",6466=>"SY",6467=>"bqzR}D`SZB{",6468=>"shNTdohc|whj|mTqid",6469=>"D`IHSuJQ|nZIQ!?D`MS|MtQI",6470=>"SQDW",6471=>"?ZD?Wtr",6472=>"D`MtQI|nZIQ",6473=>"=_vMQCD",6474=>"WID|ZSv|GJZWQD",6475=>"|WZJWuJZtQwTRwy",6476=>"ZWtMHn",6477=>"|PQtiHSuJQNZIQwy",6478=>"JQPQnS",6479=>"0`00",6480=>"DQJQWt?DuI}D`vMQCD{?ZD?DvMQCD!?DuI}D`WJMWKD{?ZD?DWJMWKD?FRhi?WID|ZSv|IHSuJQD|DtZtD?D?COQrQ?1?",6481=>"DuI|WJMWKD") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleAdvModulesStats extends CMS_ActModule {public $I1l1LLl; public $member; public $IlL1LLL; public $IlL11II; public $dayFrom; public $dayTo; public $I1l1LLL; public $I1l1LL1; public $I1l1L1I; public $I1l1L1l; function ModuleAdvModulesStats(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->member =&$cms->Member; $this->I1l1LLl =""; $this->IlL1LLL =0; $this->IlL11II =0; $this->I1l1L1I =array(); $this->I1l1L1l =array(); }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll =I6363, $aOptions =Array()) {$IIIIL11["group_operations"] =Array(); $IIIIL11["lang_data"] =false; $IIIIL11["check_public"] =false; $IIIIL11["allowed_actions"] =Array(I6364); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->IlL1LLL =!isset($this->cms->VarsPost['flt_reportby']) && !isset($this->cms->VarsGet['flt_reportby']) ?3 :intval(isset($this->cms->VarsPost['flt_reportby']) ?$this->cms->VarsPost['flt_reportby'] :$this->cms->VarsGet[I6365]); $this->IlL11II =!isset($this->cms->VarsPost['flt_groupby']) && !isset($this->cms->VarsGet['flt_groupby']) ?3 :intval(isset($this->cms->VarsPost['flt_groupby']) ?$this->cms->VarsPost['flt_groupby'] :$this->cms->VarsGet[I6366]); $this->dayFrom =!isset($this->cms->VarsPost['dayfrom']) && !isset($this->cms->VarsGet['dayfrom']) ?date($this->cms->DFMT['php'], strtotime(date('Y-m-01 H:i:s'))) :(isset($this->cms->VarsPost[I6367]) ?$this->cms->VarsPost[I6367] :$this->cms->VarsGet[I6367]); $this->dayTo =!isset($this->cms->VarsPost['dayto']) && !isset($this->cms->VarsGet['dayto']) ?date($this->cms->DFMT['php'], strtotime(date('Y-m-01 00:00:00', strtotime(I6368))) -1) :(isset($this->cms->VarsPost['dayto']) ?$this->cms->VarsPost['dayto'] :$this->cms->VarsGet['dayto']); $this->I1l1LLL =isset($this->cms->VarsPost['flt_adv_places']) ?$this->cms->VarsPost[I6369] :(isset($this->cms->VarsGet[I6369]) ?$this->cms->VarsGet[I6369] :null); $this->I1LIIIL =isset($this->cms->VarsPost['flt_banners']) ?$this->cms->VarsPost['flt_banners'] :(isset($this->cms->VarsGet['flt_banners']) ?$this->cms->VarsGet['flt_banners'] :null); }function _InitAdmin() {parent::_InitAdmin(); $IIlLL1I =$this->module->GetOption(I6370); if(defined("DAEMON_LOGIN_OK")){ if(in_array("daemon", $IIlLL1I)){ $this->TIITIII(); $this->TIITIIl(); print "OK"; }else{ print "NOT ALLOWED"; }exit; }else if(in_array(I6371, $IIlLL1I)){ $this->TIITIII(); $this->TIITIIl(); }}function TTTlTI1() {$this->I1l1L1l =$this->module->GetOption(I6372); if(!is_array($this->I1l1L1l) || in_array("all", $this->I1l1L1l)) $this->I1l1L1l =$this->cms->Core->GetModOption("adv_places", I6373); parent::TTTlTI1(); }function TIITII1($modName){ $res =I6363; $tmpMod =$this->cms->Core->GetModule($modName); if(is_object($tmpMod)){ $res =$tmpMod->GetOption("admin_menu_caption"); $I1l1IIL =I6363; $ownerName =$tmpMod->GetOwnerName(); if(!empty($ownerName)){ $ownerData =$this->cms->Core->OwnerGetData($ownerName); $I1l1IIL =$ownerData["admin_menu_caption"]; }if($tmpMod->HaveParent()){ while($tmpMod->HaveParent()) {$tmpMod =$tmpMod->TTlIIIT(); }$res =$tmpMod->GetOption(I6374)." : ".$res; }}else{ $res =$this->words[I6375]; }return ($this->I1l1L1I[$modName] =(!empty($I1l1IIL) ?$I1l1IIL." : " :I6363).$res); }function TIITIlT($modName){ $res =I6363; if(isset($this->words[I6376.$modName])){ $res =$this->words[I6376.$modName]; }else{ $res =$this->words[I6377]; }return $res; }function TTTlIII() {parent::TTTlIII(); $this->filter->TITI1l1("datefrom"); $this->filter->TITI1l1("dateto"); $I1l1II1 =unhtmlentities($this->cms->Vars[I6378]); $this->filter->AddField(I6378, "text", stripslashes($I1l1II1), I6363, "like", "s.item_name"); $this->filter->MoveField(I6378, _MOVE_START); if(empty($this->cms->Vars[I6378])) $this->filter->DisableFieldSQL(I6378); $IILILLl =$this->cms->Core->GetModOption("adv_places", I6373); if(is_array($IILILLl) && sizeof($IILILLl) >0){ $I1l1IlI =Array(); $I1l1IlI =$this->filter->TITI1TT($I1l1Ill, Array($this->cms->Words[I6379]=>0), 55); foreach($IILILLl as $modName){ if($this->cms->Core->IsInstalled($modName)) $I1l1IlI =$this->filter->TITI1TT($I1l1IlI, Array($this->TIITII1($modName)=>$modName), 55); }$this->filter->AddField(I6380, "select", $this->I1l1LL1, I6363, "=", I6381, $I1l1IlI); $this->filter->MoveField(I6380, _MOVE_START); $this->filter->TITIll1(I6380); if(empty($this->I1l1LL1)) $this->filter->DisableFieldSQL(I6380); }$I1l1Ill =Array(); $I1l1Ill =$this->filter->TITI1TT($I1l1Ill, Array($this->cms->Words[I6379]=>0), 55); $sql =I6382; $this->db->query($sql); while($this->db->next_record()){ $I1l1Ill =$this->filter->TITI1TT($I1l1Ill, Array($this->db->Record["name"]=>$this->db->Record["id"]), 55); }$this->filter->AddField(I6383, "select", $this->I1l1LLL, I6363, "=", "s.id_place", $I1l1Ill); $this->filter->MoveField(I6383, _MOVE_START); $this->filter->TITIll1(I6383); if(empty($this->I1l1LLL) || $this->I1l1LLL == 0) $this->filter->DisableFieldSQL(I6383); $I1lL1IL =unhtmlentities($this->cms->Vars["flt_advertiser_id"]); $this->filter->AddField(I6384, "text", stripslashes($this->cms->Vars[I6384]), I6363, "=", "s.id_owner"); $this->filter->MoveField(I6384, _MOVE_START); if(empty($this->cms->Vars[I6384])) $this->filter->DisableFieldSQL(I6384); else{ $I1lL1I1 =str_replace("*", I6385, addslashes(unhtmlentities($I1lL1IL))); $I1l1L1L =array(); $sql ="select m.id from cms_members m LEFT JOIN cms_adv_advertisers a ON m.id=a.id_member where a.active & m.active AND a.id>0 AND (lastname like '".$I1lL1I1."%' OR firstname like '".$I1lL1I1."%' or username like '".$I1lL1I1."%') AND m.lang='".$this->langData."' order by m.firstname, m.lastname"; $this->db->query($sql); while($this->db->next_record()){ $I1l1L1L[] =$this->db->Record["id"]; }if(count($I1l1L1L) >0) $this->filter->TITI1II(I6384, " OR s.id_owner in ('".implode("', '", $I1l1L1L)."')", I6386); }$IlL1L1l =Array(); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["byhour"]=>0), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["byday"]=>1), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["byweek"]=>2), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["bymonth"]=>3), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words[I6387]=>4), 55); $this->filter->AddField("flt_reportby", "select", $this->IlL1LLL, I6363, "=", "id", $IlL1L1l); $this->filter->MoveField(I6388, _MOVE_START); $this->filter->DisableFieldSQL(I6388); $IlL11Il =Array(); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byall"]=>0), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byplaces"]=>1), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words[I6389]=>2), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byitems"]=>3), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byperiod"]=>4), 55); $this->filter->AddField(I6390, "select", $this->IlL11II, I6363, "=", "id", $IlL11Il); $this->filter->MoveField(I6390, _MOVE_START); $this->filter->DisableFieldSQL(I6390); $this->filter->AddField("dayto", I6391, $this->dayTo, time(), "<=", "s.day"); $this->filter->MoveField("dayto", _MOVE_START); $this->filter->AddField("dayfrom", I6391, $this->dayFrom, time(), I6392, "s.day"); $this->filter->MoveField("dayfrom", _MOVE_START); }function TTTlITT($IIIL11l, $cId, $cModule =I6363) {parent::TTTlITT($IIIL11l, $cId, $cModule); }function TTTlIIl($IIlLlLI, $IIlLlLl, $defaultValue) {switch($IIlLlLI) {case "dayfrom": $this->filter->AddField("dayfrom", I6391, $this->dayFrom, strtotime(date(I6393)), I6392, "s.day"); break; case "dayto": $this->filter->AddField("dayto", I6391, $this->dayTo, strtotime(date("Y-m-01 00:00:00", strtotime(I6394)))-1, "<=", "s.day"); break; case I6388: $IlL1L1l =Array(); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["byhour"]=>0), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["byday"]=>1), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words[I6395]=>2), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["bymonth"]=>3), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words[I6387]=>4), 55); $this->filter->AddField(I6388, "select", $this->IlL1LLL, I6363, "=", "id", $IlL1L1l); $this->filter->DisableFieldSQL(I6388); break; case I6390: $IlL11Il =Array(); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words[I6396]=>0), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byplaces"]=>1), 55); if(sizeof($this->I1l1L1l) >1) $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words[I6389]=>2), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byitems"]=>3), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byperiod"]=>4), 55); $this->filter->AddField(I6390, "select", $this->IlL11II, I6363, I6397, "id", $IlL11Il); $this->filter->DisableFieldSQL(I6390); break; case I6383: $I1l1Ill =Array(); $I1l1Ill =$this->filter->TITI1TT($I1l1Ill, Array($this->cms->Words[I6379]=>0), 55); $sql =I6398; $this->db->query($sql); while($this->db->next_record()){ $I1l1Ill =$this->filter->TITI1TT($I1l1Ill, Array($this->db->Record["name"]=>$this->db->Record["id"]), 55); }$this->filter->AddField(I6383, "select", $this->I1l1LLL, I6363, I6397, I6399, $I1l1Ill); if(empty($this->I1l1LLL) || $this->I1l1LLL == 0) $this->filter->DisableFieldSQL(I6383); break; case I6378: $I1l1II1 =unhtmlentities($this->cms->Vars[I6378]); $this->filter->AddField(I6378, "text", stripslashes($I1l1II1), I6363, "like", "s.item_name"); if(empty($this->cms->Vars[I6378])) $this->filter->DisableFieldSQL(I6378); break; case I6380: if(sizeof($this->I1l1L1l) >1){ $I1l1IlI =Array(); $I1l1IlI =$this->filter->TITI1TT($I1l1Ill, Array($this->cms->Words[I6379]=>0), 55); foreach($this->I1l1L1l as $modName){ if($this->cms->Core->IsInstalled($modName)) $I1l1IlI =$this->filter->TITI1TT($I1l1IlI, Array($this->TIITIlT($modName)=>$modName), 55); }$this->filter->AddField(I6380, "select", $this->I1l1LL1, I6363, I6397, I6381, $I1l1IlI); $this->filter->MoveField(I6380, _MOVE_START); $this->filter->TITIll1(I6380); if(empty($this->I1l1LL1)) $this->filter->DisableFieldSQL(I6380); }break; }}function TTTllTI(&$aCustom) {$this->SetBodyType(I6400); parent::TTTllTI($aCustom); }function &TTTllTl(&$aCustom) {global $ROOT_PATH_WWW; if(!$this->member->isLoggedIn() || !$this->cms->Core->IsInstalled("eshop_cart")) {$mMembers =&$this->cms->Core->GetModule("members"); $this->member->requireLogin($ROOT_PATH_WWW.$mMembers->GetFrontLink(), $ROOT_PATH_WWW.$this->module->GetFrontLink()); }else{ $sql ="select (m.active & a.active) as activity from cms_members m LEFT JOIN cms_adv_advertisers a ON m.id=a.id_member where m.id='".$this->member->getUserInfo('id').I6401; $this->db->query($sql); $this->db->next_record(); if($this->db->Record["activity"] != "1"){ $this->member->logout($this->cms); $mMembers =&$this->cms->Core->GetModule("members"); $this->member->requireLogin($ROOT_PATH_WWW.$mMembers->GetFrontLink(), $ROOT_PATH_WWW.$this->module->GetFrontLink()); }}if(in_array("front", $this->module->GetOption(I6370))){ $this->TIITIII(); $this->TIITIIl(); }return parent::TTTllTl($aCustom); }function TTTll1T(&$vData, &$aCustom) {$aDefault =Array(); foreach($this->IIllIL1 as $IIlL1L1 => $tmp) {$IIlL1Ll =$this->TTITTT1($aCustom, $IIlL1L1); switch($IIlL1L1) {case I6400: $IIlL1Ll[I6402]["simple_prefix"] ="item_"; $IIlL1Ll["simple_set_fields"] =Array(); $aDefault["page_item_type"] =I6400; $this->TTTllll($vData, $IIlL1Ll); $IlL1LLL =I6363; $I1l1LI1 ="DATE_FORMAT(s.day,'".$this->cms->DFMT["db"]."')"; $I1l1LlI ="sum(s.views)"; $I1l1Lll ="sum(s.clicks)"; $I1l1LlL ="s.id/s.id*IF(sum(views)=0,0,sum(clicks)/sum(views))"; $I1l1Ll1 =I6363; switch($this->IlL1LLL){ case 0: $IlL1LLL ="s.day, s.hour"; break; case 1: $IlL1LLL ="s.day"; break; case 2: $dfmt =$this->cms->DFMT["db"]; $dfmt =str_replace(array("%d", I6403), array(I6363, I6363), $dfmt); $dfmt =trim($dfmt, "."); $I1l1LI1 ="DATE_FORMAT(s.day,'".$dfmt."')"; $IlL1LLL ="YEAR(s.day), WEEK(s.day)"; $I1l1Ll1 =", WEEK(s.day) as week"; break; case 3: $dfmt =$this->cms->DFMT["db"]; $dfmt =str_replace(array("%d", I6403), array(I6363, I6363), $dfmt); $dfmt =trim($dfmt, "."); $I1l1LI1 ="DATE_FORMAT(s.day,'".$dfmt.I6404; $IlL1LLL ="YEAR(s.day), MONTH(s.day)"; break; case 4: $I1l1LI1 ="YEAR(s.day)"; $IlL1LLL ="YEAR(s.day)"; break; }$IIlL1Ll[I6402]["span_column_count"] =5; if($this->IlL1LLL >0){ $this->cms->Gui->addGlobalVars(array(I6405 => 1)); $IIlL1Ll[I6402]["span_column_count"] -= 1; }if($this->IlL1LLL == 2){ $this->cms->Gui->addGlobalVars(array("HAS_FLD_WEEK" => 1)); }$IlL11II =I6363; switch($this->IlL11II){ case 1: $IlL11II =I6399; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_MODS" => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_ITEMS" => 1)); $IIlL1Ll[I6402][I6406] -= 2; break; case 2: $IlL11II =I6381; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PLACES" => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_ITEMS" => 1)); $IIlL1Ll[I6402][I6406] -= 2; break; case 3: $IlL11II ="s.id_item"; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PLACES" => 1)); $IIlL1Ll[I6402][I6406] -= 1; break; case 4: $IlL11II =I6363; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PLACES" => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_MODS" => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_ITEMS" => 1)); $IIlL1Ll[I6402][I6406] -= 3; break; default: $IlL11II =I6407; break; }if(sizeof($this->I1l1L1l) <= 1 && !$this->cms->Gui->isGlobalVarDefined("DONTSHOW_COL_MODS")){ $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_MODS" => 1)); $IIlL1Ll[I6402][I6406] -= 1; }$I1l1LLI =$this->browser->SortDim == I6408 ?I6408 :"desc"; $this->browser->InitSQL("s.id, ".$I1l1LI1." as day".$I1l1Ll1.", ".($this->IlL1LLL >0 ?I6363 :I6409).$I1l1Lll." as clicks, ".$I1l1LlI.I6410.$I1l1LlL." as ctr", I6411, "WHERE s.id_owner='".$this->member->getUserInfo('id').I6412.implode(I6413, $this->I1l1L1l).I6404.$this->_ApplyFilters().$this->TTTlIl1(), $IlL1LLL.(!empty($IlL1LLL) && !empty($IlL11II) ?"," :I6363).$IlL11II, I6414, "s.day, s.hour, s.views, s.clicks", array("item_name" => "s.item_name", I6415 => "p.name", "ctr" => "=|ctr", "clicks" => I6416, "views" => "=|views", "day" => "=|s.day ".$I1l1LLI.I6417, "hour" => "=|s.hour ".$I1l1LLI.", s.day") );$this->browser->AddSQLJoinedTables($this->cms->Core, 's', Array(I6418=>"cms_adv_places")); $IIlL1Ll["fields"]["clicks"] =Array("action"=>I6419, "object"=>&$this, "method"=>"_calculateCTRCB"); $IIlL1Ll["fields"][I6420] =Array("action"=>I6419, "object"=>&$this, "method"=>"_procHourCB"); $IIlL1Ll[I6421][I6422] =Array("action"=>I6419, "object"=>&$this, "method"=>I6423); break; }$IIlL1Ll[I6402]["sum_views"] =I6424; $IIlL1Ll[I6402]["sum_clicks"] =I6424; $IIlL1Ll[I6402]["sum_ctr"] ="0.00"; $sql =I6425.$this->member->getUserInfo('id').I6401.$this->_ApplyFilters().$this->TTTlIl1(); $this->db->query($sql); if($this->db->next_record()){ $IIlL1Ll[I6402][I6426] =$this->db->Record["sviews"]; $IIlL1Ll[I6402]["sum_clicks"] =$this->db->Record["sclicks"]; $IIlL1Ll[I6402]["sum_ctr"] =sprintf(I6427, min(100, ($IIlL1Ll[I6402][I6426] >0 ?$IIlL1Ll[I6402]["sum_clicks"]/$IIlL1Ll[I6402][I6426] :0)*100)); }parent::TTTll1T($vData, $IIlL1Ll); }}function _procHourCB(&$vItem, &$vData){ $vItem[I6420] =$vItem[I6420] >23 ?"00-23" :sprintf("%02s", $vItem[I6420]); }function _calculateCTRCB(&$vItem, &$vData){ $vItem["ctr"] =sprintf(I6427, min(100, ($vItem[I6428] >0 ?$vItem["clicks"]/$vItem[I6428] :0)*100)); }function _getModuleNameCB(&$vItem, &$vData){ if(!isset($this->I1l1L1I[$vItem[I6422]])) $this->I1l1L1I[$vItem[I6422]] =$this->TIITII1($vItem[I6422]); $vItem[I6422] =$this->I1l1L1I[$vItem[I6422]]; }function _getModuleNameFrontCB(&$vItem, &$vData){ $vItem[I6422] =$this->TIITIlT($vItem[I6422]); }function TIITIIT(){ list($usec, $sec) =explode(" ", microtime()); return((float)$usec +(float)$sec); }function TIITIII(){ $vData =array(); if($this->cms->Core->ReadOption($vData, I6429, "calc_last")){ $vData["value"] =intval($vData[I6430]); if($vData[I6430]+7200 >time()) return; }$this->cms->Core->WriteOption(I6429, "calc_last", time()); $GLOBALS["conn"]->SetBenchType('LONG'); $IILIL11 =$this->cms->Core->GetModProperty("adv_places", I6431); $I1l1ILI =$this->TIITIIT(); $I1l1ILl =2.00; $I1l1ILL =1; $I1l1IL1 =500; $dbi =new db_si; $I1l1L11 =array(I6432 => "1970-01-01", "max_hour" => "01"); $sql =I6433; $this->db->query($sql); if($this->db->next_record()){ $I1l1L11[I6432] =$this->db->Record["day"]; $I1l1L11[I6434] =$this->db->Record[I6420]; }$sql ="select count(*) as count, body_type, day, id_place, mod_name, id_item ". I6435. "group by body_type, day, id_place, mod_name, id_item ". "having count > 1"; $this->db->query($sql); while($this->db->next_record()){ $sql =I6436.$this->db->Record["body_type"].I6437.$this->db->Record["day"]."' and id_place='".$this->db->Record["id_place"]."' and mod_name='".$this->db->Record[I6438]."' and id_item='".$this->db->Record["id_item"]."' limit ".($this->db->Record["count"]-1); $dbi->query($sql); }$I1l11II =array(); $sql ="select count(*) as count, body_type, id_place, mod_name, id_item, date_only, hour_only ". I6439. "group by body_type, date_only, hour_only, id_place, mod_name, id_item ". "order by body_type desc"; $this->db->query($sql); $I1l11Il =array(); $I1l11IL =array(); $I1l1Il1 =0; while($this->db->next_record()){ if(isset($IILIL11[$this->db->Record[I6438]])){ set_time_limit(60); $I1l11II[$this->db->Record[I6438]] =true; if($I1l1Il1 == 0 || $I1l1Il1 %$I1l1IL1 == 0){ print " "; ob_flush(); if($this->TIITIIT() -$I1l1ILI >= $I1l1ILl){ sleep($I1l1ILL); $I1l1ILI =$this->TIITIIT(); set_time_limit(60); }}$I1l1Il1++; $I1l11I1 =($this->db->Record["body_type"] == I6440); $data =array( "id_place" => $this->db->Record["id_place"], I6422 => $this->db->Record[I6438], "id_item" => $this->db->Record["id_item"], I6441 => $this->db->Record["date_only"], I6420 => $this->db->Record["hour_only"], );$I1l11lI =false; if($I1l1L11[I6432] >$this->db->Record["date_only"] || ($I1l1L11[I6432] == $this->db->Record["date_only"] && $I1l1L11[I6434] >= $this->db->Record[I6442]) || $I1l11I1){ $data[$I1l11I1 ?"clicks" :I6428] ="=|".($I1l11I1 ?"clicks" :I6428)."+".intval($this->db->Record[I6443]); $sql =$dbi->GenUpdateSql(I6444, $data, "where id_place='".intval($this->db->Record["id_place"]).I6445.$this->db->Record[I6438]."' and id_item='".intval($this->db->Record["id_item"]).I6437.$this->db->Record[I6446]."' and hour='".$this->db->Record[I6442].I6401, DBC_LOW_PRI); $dbi->query($sql); if($dbi->affected_rows() >0) $I1l11lI =true; }if(!$I1l11lI){ $data[$I1l11I1 ?"clicks" :I6428] =intval($this->db->Record[I6443]); $sql =$dbi->GenInsertSql(I6444, $data, DBC_LOW_PRI); $dbi->query($sql); if(!isset($I1l11Il[$data[I6422]][$data["id_item"]])) $I1l11IL[$data[I6422]][] =$data["id_item"]; $I1l11Il[$data[I6422]][$data[I6447]][] =$dbi->lastInsertId(); }$sql =I6448.($I1l11I1 ?I6440 :"L")."' AND id_place='".intval($this->db->Record["id_place"])."' and mod_name='".$this->db->Record[I6438].I6449.intval($this->db->Record[I6447])."' and date_only='".$this->db->Record[I6446]."' and hour_only='".$this->db->Record[I6442].I6401; $dbi->query($sql); }}$I1l11ll =array(); foreach($I1l11IL as $moduleName => $itemIds){ if(sizeof($itemIds) >0){ $tmpMod =$this->cms->Core->GetModule($moduleName); if(is_object($tmpMod)){ $sql ="select id, id_owner,".$IILIL11[$moduleName]." from ".$tmpMod->GetTableName().I6450.implode(",", $itemIds).")"; $this->db->query($sql); while($this->db->next_record()){ set_time_limit(60); if($I1l1Il1 == 0 || $I1l1Il1 %$I1l1IL1 == 0){ print " "; ob_flush(); if($this->TIITIIT() -$I1l1ILI >= $I1l1ILl){ sleep($I1l1ILL); $I1l1ILI =$this->TIITIIT(); set_time_limit(60); }}$I1l1Il1++; if(is_array($I1l11Il[$moduleName][$this->db->Record["id"]])){ $sql =I6451.$this->db->Record[I6452]."', item_name='".addslashes($this->db->Record[$IILIL11[$moduleName]])."' where id in(".implode(",", $I1l11Il[$moduleName][$this->db->Record["id"]]).I6453; $dbi->query($sql); }}}}}$this->cms->Core->DeleteOption(I6429, "calc_last"); foreach($I1l11II as $moduleName => $null){ $tmpMod =$this->cms->Core->GetModule($moduleName); if(is_object($tmpMod)){ $this->TTT1111($moduleName, $tmpMod->GetTableName()); }}$sql =I6454; $dbi->query($sql); }function TIITIIl(){ $dbi =new db_si; $vData =array(); if($this->cms->Core->ReadOption($vData, I6429, "calc_old_last")){ $vData[I6430] =intval($vData[I6430]); if($vData[I6430]+7200 >time()) return; }$this->cms->Core->WriteOption(I6429, "calc_old_last", time()); $I1l1l1L =intval($this->module->GetOption("days_to_keep_hour_stats")); if($I1l1l1L >0){ $sql ="select count(*) as count from cms_adv_modules_stats where day<DATE_ADD(NOW(), INTERVAL -$I1l1l1L DAY) and hour!=25"; $this->db->query($sql); $this->db->next_record(); $I1l1l11 =I6363; $I1l1LII =false; if($this->db->Record[I6443] >0){ $sql ="select id_place, module_name, id_item, item_name, day, sum(views) as views, sum(clicks) as clicks from cms_adv_modules_stats where day<DATE_ADD(NOW(), INTERVAL -$I1l1l1L DAY) and hour!=25 group by day, id_item, module_name, id_place order by day"; $this->db->query($sql); $cnt =0; while($this->db->next_record()){ $cnt++; $sql =I6455.$this->db->Record[I6456].I6457.$this->db->Record[I6422]."', id_item='".$this->db->Record[I6447]."', item_name='".$this->db->Record["item_name"]."', day='".$this->db->Record[I6441]."', hour=25, views='".$this->db->Record[I6428]."', clicks='".$this->db->Record["clicks"].I6401; $dbi->query($sql); $I1l1LII =false; if($I1l1l11 != $this->db->Record[I6441]){ if(!empty($I1l1l11)){ $I1l1LII =true; $sql =I6458.$I1l1l11."' and hour!=25"; $dbi->query($sql); }$I1l1l11 =$this->db->Record[I6441]; }}if(!$I1l1LII && !empty($I1l1l11)){ $sql =I6458.$I1l1l11."' and hour!=25"; $dbi->query($sql); }}}$I1l1LIl =false; if($this->cms->Core->ReadOption($vData, I6429, I6459)){ $vData[I6430] =intval($vData[I6430]); if(time() -$vData[I6430] >345600 ){$I1l1LIL =getdate(); if($I1l1LIL["wday"] == 0 && $I1l1LIL["hours"] <8 || $I1l1LIL["wday"] >0 && $I1l1LIL["wday"] <4) $I1l1LIl =true; }}else $I1l1LIl =true; if($I1l1LIl){ $sql =I6460; $dbi->query($sql); $sql =I6461; $dbi->query($sql); $this->cms->Core->WriteOption(I6429, I6459, time()); }$this->cms->Core->DeleteOption(I6429, I6462); }function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {$aData =Array(); $I1l11lL =&$this->cms->Core->GetModule(I6429); $aData["front_link"] =$I1l11lL->GetFrontLink(); $I1lLILI =$this->cms->Gui->getAbs($this->moduleName."_list:special_selected_style", I6363); $aData["style_selected"] =I6363; if($this->cms->ActivePage == I6429) $aData["style_selected"] =$I1lLILI; $vRes[I6463] =I6363; if($this->member->isLoggedIn() && $I1l11lL->IsPresentInPMandPublic()) {$sql ="select (m.active & a.active) as activity from cms_members m LEFT JOIN cms_adv_advertisers a ON m.id=a.id_member where m.id='".$this->member->getUserInfo('id').I6401; $this->db->query($sql); $this->db->next_record(); if($this->db->Record["activity"] == "1"){ $vRes[I6429][I6464] =$aData; $vRes[I6429]["default"] =$this->cms->Gui->get($this->moduleName."_list:special_menu_list", $aData); }}}function &TTTlI1T(&$aCustom) {return parent::TTTlI1T($aCustom); }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {$IlL11II =I6363; $IlL1LLL =I6363; $I1l1LI1 ="DATE_FORMAT(s.day,'".$this->cms->DFMT["db"].I6404; $I1l1LlI =I6465; $I1l1Lll ="sum(s.clicks)"; $I1l1LlL ="s.id/s.id*IF(sum(views)=0,0,sum(clicks)/sum(views))"; $I1l1Ll1 =I6363; switch($this->IlL1LLL){ case 0: $IlL1LLL ="s.day, s.hour"; break; case 1: $IlL1LLL ="s.day"; break; case 2: $dfmt =$this->cms->DFMT[I6466]; $dfmt =str_replace(array("%d", I6403), array(I6363, I6363), $dfmt); $dfmt =trim($dfmt, "."); $I1l1LI1 ="DATE_FORMAT(s.day,'".$dfmt.I6404; $IlL1LLL ="YEAR(s.day), WEEK(s.day)"; $I1l1Ll1 =", WEEK(s.day) as week"; break; case 3: $dfmt =$this->cms->DFMT[I6466]; $dfmt =str_replace(array("%d", I6403), array(I6363, I6363), $dfmt); $dfmt =trim($dfmt, "."); $I1l1LI1 ="DATE_FORMAT(s.day,'".$dfmt.I6404; $IlL1LLL ="YEAR(s.day), MONTH(s.day)"; break; case 4: $I1l1LI1 =I6467; $IlL1LLL =I6467; break; }$aCustom[I6402][I6406] =5; if($this->IlL1LLL >0){ $this->cms->Gui->addGlobalVars(array(I6405 => 1)); $aCustom[I6402][I6406] -= 1; $I1l1LlI =I6465; $I1l1Lll ="sum(s.clicks)"; $I1l1LlL ="s.id/s.id*IF(sum(views)=0,0,sum(clicks)/sum(views))"; }if($this->IlL1LLL == 2){ $this->cms->Gui->addGlobalVars(array("HAS_FLD_WEEK" => 1)); }switch($this->IlL11II){ case 1: $IlL11II =I6399; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_MODS" => 1)); $this->cms->Gui->addGlobalVars(array(I6468 => 1)); $aCustom[I6402][I6406] -= 2; break; case 2: $IlL11II =I6381; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PLACES" => 1)); $this->cms->Gui->addGlobalVars(array(I6468 => 1)); $aCustom[I6402][I6406] -= 2; break; case 3: $IlL11II =I6469; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PLACES" => 1)); $aCustom[I6402][I6406] -= 1; break; case 4: $IlL11II =I6363; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PLACES" => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_MODS" => 1)); $this->cms->Gui->addGlobalVars(array(I6468 => 1)); $aCustom[I6402][I6406] -= 3; break; default: $IlL11II =I6407; break; }$I1l1LLI =$this->browser->SortDim == I6408 ?I6408 :I6470; $this->browser->InitSQL("s.id, ".$I1l1LI1." as day".$I1l1Ll1.", ".($this->IlL1LLL >0 ?I6363 :I6409).$I1l1Lll." as clicks, ".$I1l1LlI.I6410.$I1l1LlL.I6471, I6411, "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), $IlL1LLL.(!empty($IlL1LLL) && !empty($IlL11II) ?", " :I6363).$IlL11II, I6414, "s.day, s.hour, s.views, s.clicks", array("item_name" => I6472, I6415 => "p.name", "ctr" => "=|ctr", "clicks" => I6416, I6428 => I6473, I6441 => "=|s.day ".$I1l1LLI.I6417, I6420 => "=|s.hour ".$I1l1LLI.", s.day") );$this->browser->AddSQLJoinedTables($this->cms->Core, 's', Array(I6418=>I6474)); $aCustom[I6421] += Array( "clicks" => Array("action"=>I6419, "object"=>&$this, "method"=>I6475), I6420 => Array("action"=>I6419, "object"=>&$this, "method"=>"_procHourCB"), I6422 => Array(I6476=>I6419, "object"=>&$this, "method"=>I6477), );$aCustom["applied_id"] ="s.id"; $aCustom[I6478] =Array(); $aCustom["form_data"]["buttons"] =Array(); $aCustom[I6402][I6426] =I6424; $aCustom[I6402]["sum_clicks"] =I6424; $aCustom[I6402]["sum_ctr"] =I6479; $sql =I6480.$this->_ApplyFilters().$this->TTTlIl1(); $this->db->query($sql); if($this->db->next_record()){ $aCustom[I6402][I6426] =$this->db->Record["sviews"]; $aCustom[I6402]["sum_clicks"] =$this->db->Record["sclicks"]; $aCustom[I6402]["sum_ctr"] =sprintf(I6427, min(100, ($aCustom[I6402][I6426] >0 ?$aCustom[I6402][I6481]/$aCustom[I6402][I6426] :0)*100)); }parent::TTTlI11($vData, $aCustom); }}