<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       28249 xkqwyxytlrkwgnttisirmgxqtiuspsxkyiilkyprkxyiznsqwlwniylnnytkiqgygunipnir
 */ ?><?php foreach(array(6482=>"",6483=>"fJt|nZIQ",6484=>"SZtQtH",6485=>"IHSuJQ|tBGQ|ZJJHCQS",6486=>"IHSuJQD|SZtZ",6487=>"ZSv|IHSuJQD",6488=>"GJZWQ|OQMPOt",6489=>"WOQWKQS",6490=>"0",6491=>"nZIQ",6492=>"ZSvQrtMDQrD",6493=>"IHSuJQ|nZIQ|",6494=>"vZJuQ",6495=>"IHSuJQ|nZIQ",6496=>"ZSv|GJZWQD|DuYfHrI%IHSuJQ|HGtMHn",6497=>"MS!?GuYJMW!?nZIQ!?SQDWrMGtMHn!?DHurWQ|tBGQ!?MS|MtQI!?IHSuJQ|nZIQ!?YrHCDQ|IHSQ!?MS|GZPQ!?MS|SQfZuJt|MtQI!?GHDtfMx",6498=>"MS?SQDW",6499=>"MS",6500=>'IQtOHS',6501=>"QSMt|MS",6502=>"ZWtMHn",6503=>"Hff",6504=>"JQP|rQS",6505=>"fHrI|SZtZ",6506=>"DZvQ",6507=>"DQJQWt?IHSuJQ|nZIQ?frHI?WID|ZSv|GJZWQD?COQrQ?DHurWQ|tBGQ=\"IHSYZnnQr\"?ZnS?MS=",6508=>"dqjqwT?[?",6509=>"GuYJMW",6510=>"DOHC|unMEuQ",6511=>"DQJQWtQS",6512=>"YrHCDQ|IHSQ",6513=>"^",6514=>"IHSuJQ",6515=>"HGt|SQf|IZx|vMQCD",6516=>"DtZrt|SZtQ",6517=>"HGt|SQf|JMfQtMIQ",6518=>"=_szTq|zss}'",6519=>"DHurWQ|tBGQ",6520=>"GrMHrMtB",6521=>"ZSvQrtMDQr",6522=>"YJuQ",6523=>"MS|HCnQr",6524=>"IHSYZnnQr",6525=>"uDQ|DtZtMDtMWD",6526=>"GHDtfMx",6527=>'DIZJJ',6528=>"mmjmjj1",6529=>"'?ZnS?GuYJMW=1",6530=>"RhhT|gzTo|ccc",6531=>"ZSIMn|IQnu|WZGtMHn",6532=>"ZSv|GJZWQD",6533=>"hGtMHnDiHSuJQNZIQ",6534=>"MtQI",6535=>"JMDt",6536=>"DGQW|IHSuJQ|YHSB",6537=>"dGQWyJHWKNZIQ",6538=>"mtQImS",6539=>"?ZnS?DHurWQ|tBGQ='IHSuJQ'?ZnS?}JHWZtQ}'^",6540=>"^'!?IHSuJQ|nZIQ{@0",6541=>"?hR?JHWZtQ}'^",6542=>"nHt|ZSvQrt",6543=>"nH|ZSvQrt|GJZWQD",6544=>"'?COQrQ?MS=",6545=>"GHDDMYJQ|ZSv|IHSuJQD",6546=>"PQtvZJuQ",6547=>"WHrrQWtvZJuQ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleAdvPlaces extends CMS_ActModule {public $I1l1LLl; function ModuleAdvPlaces(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->I1l1LLl =""; }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll =I6482, $aOptions =Array()) {$IIIIL11["group_operations"] =Array("publish_on", "publish_off", "del"); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin() {parent::_InitAdmin(); }function TTTlIII() {parent::TTTlIII(); $this->filter->AddField(I6483, "text", stripslashes(unhtmlentities($this->cms->Vars[I6483])), I6482, " like ", "name"); $this->filter->MoveField(I6483,_MOVE_START); if(empty($this->cms->Vars[I6483])) $this->filter->DisableFieldSQL(I6483); $this->filter->TITI1l1("datefrom"); $this->filter->TITI1l1(I6484); }function TTTlITT($IIIL11l, $cId, $cModule =I6482) {parent::TTTlITT($IIIL11l, $cId, $cModule); }function &TTTlI1T(&$aCustom) {return parent::TTTlI1T($aCustom); }function TTTlI1I(&$vData) {$vData[I6485] =false; $vData[I6486] =array(); if(is_array($this->module->GetOption(I6487)) && sizeof($this->module->GetOption(I6487)) >0){ $vData[I6485] =true; foreach($this->module->GetOption(I6487) as $modName){ if($this->cms->Core->IsInstalled($modName)) $vData[I6486][] =array("value" => $modName, "name" => $this->TIITII1($modName)); }}if(!isset($vData["place_width"])){ $vData["place_width"] =0; $vData[I6488] =0; }if(!isset($vData["show_unique"])){ $vData["show_unique"] ="checked"; $vData["click_unique"] =I6489; }$vData["start_date"] =date($this->cms->DFMT["php"]." H:i:s"); $vData["opt_def_lifetime"] =I6490; $sql ="select m.id, m.firstname, m.lastname from cms_members m LEFT JOIN cms_adv_advertisers a ON m.id=a.id_member where a.active & m.active AND a.id>0 AND m.lang='".$this->langData."' order by m.firstname, m.lastname"; $this->db->query($sql); while($this->db->next_record()){ $tmp =array( "value" => $this->db->Record["id"], I6491 => $this->db->Record["firstname"]." ".$this->db->Record["lastname"], "selected" => I6482 );$vData[I6492] .= $this->cms->Gui->get("adv_places_subform:select_option", $tmp); }$vData["auto_campaign"] =$this->module->GetOption("auto_create_campaign"); parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {if($vData[I6485]){ for($i =0; $i <sizeof($vData[I6486]); $i++){ $vData[I6486][$i]["selected"] =$vData[I6493.$vData[I6486][$i][I6494]] == "selected" ?"selected" :I6482; $vData[I6495] .= $this->cms->Gui->get(I6496, $vData[I6486][$i]); }}$this->browser->InitSQL(I6497, "FROM cms_adv_places ", "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), I6482, I6491, I6498 );$aCustom["fields"] += Array( "public"=>Array("action"=>"flagicon", I6494=>1, I6499=>"pub_id", "on"=>"adv_places_list:public_on","off"=>"adv_places_list:public_off"), "source_type"=>Array('action'=>'callback', 'object'=>&$this, I6500=>'_getSourceTypesCB'), "action_edit"=>Array("action"=>"flagicon", I6494=>I6482, I6499=>I6501, "on"=>"adv_places_list:edit","off"=>I6482), "action_del"=>Array(I6502=>"flagicon", I6494=>I6482, I6499=>"del_id", "on"=>"adv_places_list:del",I6503=>I6482) );$aCustom["applied_id"] =I6499; $aCustom["legend"] =Array("published", "notpublished", I6504, "leg_yellow", "leg_blue", "leg_edit", "leg_del"); $aCustom[I6505]["buttons"] =Array("add", "apply", "cancel", I6506); parent::TTTlI11($vData, $aCustom); }function _getSourceTypesCB(&$aItem, &$aData){ $aItem["source_type"] =$this->words["source_type_".$aItem["source_type"]]; }function TIITIlI($cId){ $cId =intval($cId); $sql =I6507.$cId; $this->db->query($sql); if($this->db->next_record()){ foreach(explode(";", $this->db->Record[I6495]) as $modName){ $modName =trim($modName); if(!empty($modName)) $this->cms->Core->Cache->ClearAdd($modName); }}}function _ActionPublish($cId, $cModule){ parent::_ActionPublish($cId, $cModule); $this->TIITIlI($cId); }function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql =I6508. "FROM cms_adv_places ". "WHERE id='".$cId."'".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData["public"] =($this->itemData[I6509] == 1) ?I6489: I6482; $this->itemData["show_default"] =($this->itemData["show_default"] == 1) ?I6489: I6482; $this->itemData["is_topline"] =($this->itemData["is_topline"] == 1) ?I6489: I6482; $this->itemData[I6510] =($this->itemData[I6510] == 1) ?I6489: I6482; $this->itemData["click_unique"] =($this->itemData["click_unique"] == 1) ?I6489: I6482; $this->itemData["source_type_".$this->itemData["source_type"]] =I6511; $this->itemData["place_type_".$this->itemData["place_type"]] =I6511; foreach(explode(";", $this->itemData[I6495]) as $val){ $this->itemData[I6493.$val] =I6511; }foreach(explode(";", $this->itemData[I6512]) as $val){ $this->itemData["browse_mode_".$val] =I6511; }}}function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); $II1LLLL =$this->GetLastError(); $placeID =intval($this->db->lastInsertId()); $this->TIITIlI($placeID); if(empty($II1LLLL['errno']) && $this->cms->VarsPost["create_campaign"] == 1 && $placeID >0){ $IIlLLLL =array( I6509 => 1, I6491 => $this->cms->VarsPost[I6491], "ids_places" => I6513.$placeID.I6513, "max_items" => 0, "material_type" => $this->cms->VarsPost["source_type"] == I6514 ?I6514 :"banner", I6515 => 0, "opt_def_max_clicks" => 0, "opt_def_lifetime" => $this->cms->VarsPost["opt_def_lifetime"], "opt_def_lifetime_units" => $this->cms->VarsPost["opt_def_lifetime_units"], "opt_def_priority" => 1, "opt_def_max_views_day" => 0, "lang" => $this->langData, );$sql =$this->db->GenInsertSql("cms_adv_campaign_types", $IIlLLLL); $this->db->query($sql); $I1l11l1 =intval($this->db->lastInsertId()); $tm =DateTools::getCorrectUDate($this->cms->VarsPost[I6516], $this->cms->DFMT["conf"]); if(empty($IIlLLLL["opt_def_lifetime_units"])) $IIlLLLL["opt_def_lifetime_units"] ="day"; else if($IIlLLLL["opt_def_lifetime_units"] == "week"){ $IIlLLLL["opt_def_lifetime"] *= 7; $IIlLLLL["opt_def_lifetime_units"] ="day"; }$I1l11LI =intval($IIlLLLL[I6517])." ".$IIlLLLL["opt_def_lifetime_units"]; $IIlLLLL =array( I6509 => 1, I6491 => $this->cms->VarsPost[I6491], "id_type" => $I1l11l1, I6516 => DateTools::toMysqlDate($tm), "end_date" => I6518.DateTools::toMysqlDate($tm)."', INTERVAL ".$I1l11LI.")", "max_items" => 0, "material_type" => $this->cms->VarsPost[I6519] == I6514 ?I6514 :"banner", "max_views"=>0, "max_views_day"=>0, "max_clicks"=>0, I6520=>1, "ids_places"=>I6513.$placeID.I6513, "id_advertiser"=>$this->cms->VarsPost["advertiser"], "id_owner"=>$this->cms->VarsPost[I6521], "status"=>"pending", "lang" => $this->langData, );$sql =$this->db->GenInsertSql("cms_adv_campaigns", $IIlLLLL); $this->db->query($sql); $this->cms->AddStatusMsg("status_campaign_created"); }}function _ActionDel($cId, $cModule) {$this->TIITIlI($cId); parent::_ActionDel($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno'])){ $sql ="update cms_adv_groups set adv_places=REPLACE(adv_places, ';".intval($cId).";', ';') where adv_places like '%;".intval($cId).";%'"; $this->db->query($sql); if($this->db->affected_rows() >0) $this->cms->AddStatusMsg("status_updated_groups", "blue", I6482, I6482, Array("num" => $this->db->affected_rows().I6482)); $sql ="delete from cms_adv_groups where adv_places=';'"; $this->db->query($sql); if($this->db->affected_rows() >0) $this->cms->AddStatusMsg("status_deleted_groups", I6522, I6482, I6482, Array("num" => $this->db->affected_rows().I6482)); }}function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); $this->TIITIlI($cId); }function TTT1Tl1($cId, $cModule, $condition =''){ $sql ="update cms_adv_campaigns set id_owner=id_advertiser"; $this->db->query($sql); $I1l11Ll =array(); $sql ="select b.id, c.id_owner from cms_adv_campaigns c left join cms_adv_banners b ON POSITION(CONCAT(';',c.id,';') IN b.id_campaign)>0 where c.id_owner!=b.id_owner"; $this->db->query($sql); while($this->db->next_record()){ $I1l11Ll[$this->db->Record[I6499]] =$this->db->Record[I6523]; }foreach($I1l11Ll as $I1l11LL => $I1l11L1){ $sql ="update cms_adv_banners set id_owner=".intval($I1l11L1)." where id=".intval($I1l11LL); $this->db->query($sql); }}function TTT1IlI($aSql =Array(), $cId =0) {$name =$this->cms->VarsPost[I6491]; $I1l111I =$this->cms->VarsPost[I6519]; $moduleName =$this->cms->VarsPost[I6495]; $I1l111l =$this->cms->VarsPost[I6512]; $I1l111L =$this->cms->VarsPost["place_type"]; if(($name != I6482) && ($I1l111I == "banner" || is_array($moduleName) && count($moduleName) >0 && (is_array($I1l111l) && count($I1l111l) >0 || $I1l111I == I6524))) {$aSql =Array( I6491=>$name, "show_default"=>intval($this->cms->VarsPost["show_default"]), "is_topline"=>intval($this->cms->VarsPost["is_topline"]), I6525=>intval($this->module->GetOption(I6525)), I6510=>intval($this->cms->VarsPost[I6510]), "click_unique"=>intval($this->cms->VarsPost["click_unique"]), "description"=>$this->cms->VarsPost["description"], I6526=>$this->cms->VarsPost[I6526], I6519=>$I1l111I, I6495=>(is_array($moduleName) && count($moduleName) >0 ?I6513.implode(I6513, $moduleName).I6513 :I6482), I6512=>(is_array($I1l111l) && count($I1l111l) >0 ?I6513.implode(I6513, $I1l111l).I6513 :I6482), "place_type"=>$this->cms->VarsPost["place_type"], "place_width"=>intval(abs($this->cms->VarsPost["place_width"])), I6488=>intval(abs($this->cms->VarsPost[I6488])), I6509=>intval($this->cms->VarsPost[I6509]), );}$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TTTlIT1(&$aCustom, $cType =I6527, $IIlLI11 ='', $IIlLlII ='_small') {parent::TTTlIT1($aCustom, $cType, $IIlLI11, $IIlLlII); }function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {$vRes["body"] =I6482; if(!isset($GLOBALS["IILILL1"])) $GLOBALS[I6528] =0; if($this->module->issetOption("adv_place_sb")){ $placeID =intval($this->module->GetOption("adv_place_sb")); if($placeID >0){ $sql ="select id from cms_adv_places where id=".$placeID." and lang='".$this->langData.I6529; $this->db->query($sql); if($this->db->next_record()){ $vRes["body"] =$this->cms->Gui->getAbs($this->moduleName.":adv_body", array("id_place" => intval($placeID), "view_url" => $GLOBALS[I6530], "cnt" => ++$GLOBALS[I6528])); }else $vRes["body"] =I6482; }}}function TIITII1($modName){ $res =I6482; $tmpMod =$this->cms->Core->GetModule($modName); $res =$tmpMod->GetOption("admin_menu_caption"); $I1l1IIL =I6482; $ownerName =$tmpMod->GetOwnerName(); if(!empty($ownerName)){ $ownerData =$this->cms->Core->OwnerGetData($ownerName); $I1l1IIL =$ownerData["admin_menu_caption"]; }if($tmpMod->HaveParent()){ while($tmpMod->HaveParent()) {$tmpMod =$tmpMod->TTlIIIT(); }$res =$tmpMod->GetOption(I6531)." : ".$res; }return (!empty($I1l1IIL) ?$I1l1IIL." : " :I6482).$res; }function getOptionsPlacesCB($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues"){ if(!$IIL1lL1["SimpleMode"] || !$this->cms->Core->IsInstalled(I6532)) return false; $I1l1111 =false; if($IIL1lL1[I6533] != I6532 && !preg_match('/\_cat$/', $IIL1lL1[I6533])){ if($IIL1lL1[I6533] == "eshop_item" || $IIL1lL1[I6533] == "kb_item" || $IIL1lL1[I6533] == "portfolio_item") $I1l1111 =str_replace(I6534, "cat", $IIL1lL1[I6533]); else $I1l1111 =$IIL1lL1[I6533]."_cat"; if(!$this->cms->Core->IsInstalled($I1l1111)) $I1l1111 =false; }if($IIL1lL1[I6533] != I6532 && (!is_array($this->module->GetOption(I6487)) || !(in_array($IIL1lL1[I6533], $this->module->GetOption(I6487)) || $I1l1111 && in_array($I1l1111, $this->module->GetOption(I6487))))) return false; $I1LIIII ="specblock"; if($IIL1lL1[I6533] != I6532){ if($cData[I6491] == "adv_place_list") $I1LIIII =I6535; else if($cData[I6491] == "adv_place_details") $I1LIIII ="details"; }if($IIL1lL1["SpecBlockName"] == I6536 && $I1LIIII == "specblock" || $IIL1lL1[I6537] != I6536 && $I1LIIII != "specblock") return false; switch($IIL1l1I){ case "getallvalues": $rec =array(); if($IIL1lL1[I6533] == I6532) $sql ="select id, name from cms_adv_places where lang='".$this->langData."' AND (is_used!=1 OR id_page=".intval($IIL1lL1[I6538])." AND spec_block_name='".$IIL1lL1[I6537]."') and source_type='banner'"; else $sql ="select id, name from cms_adv_places where lang='".$this->langData."'".I6539.$IIL1lL1[I6533].I6540.($I1l1111 ?I6541.$I1l1111.I6540 :I6482).") and locate(';".$I1LIIII.";', browse_mode)>0"; $this->db->query($sql); $res[] =array(I6491 => "-1", "caption" => $this->words[I6542], I6511 => I6482); $numRows =0; while($this->db->next_record()){ $numRows ++; $res[] =array(I6491 => $this->db->Record[I6499], "caption" => $this->db->Record[I6491], I6511 => ($cData[I6494] == $this->db->Record[I6499] ?($IIL1lL1["SimpleMode"] ?I6511 :"1") :I6482) );}if($numRows == 0){ $res[0]["caption"] =$this->words[I6543]; }break; case "getvalue": $res =$cData[I6494]; break; case "correctvalue": $res =-1; break; case "apply": if($IIL1lL1[I6533] == I6532){ $sql ="update cms_adv_places set id_page=0, spec_block_name='', is_used=0 where id_page=".intval($IIL1lL1[I6538])." AND spec_block_name='".$IIL1lL1[I6537]."'"; $this->db->query($sql); if($cData[I6494] >0){ $sql ="update cms_adv_places set id_page=".intval($IIL1lL1[I6538]).", spec_block_name='".$IIL1lL1[I6537]."', is_used=1 where id=".intval($cData[I6494]); $this->db->query($sql); }}else{ if($cData[I6494] >0){ $I1l111l =I6513.$I1LIIII.I6513; $sql ="select browse_mode_inuse from cms_adv_places where id=".intval($cData[I6494]); $this->db->query($sql); if($this->db->next_record()){ $I1l111l =$this->db->Record["browse_mode_inuse"]; if(mb_strpos($I1l111l, I6513.$I1LIIII.I6513) === false) $I1l111l =I6513.$I1LIIII.(!empty($I1l111l) && $I1l111l[0] == I6513 ?I6482 :I6513).$I1l111l; }$sql ="update cms_adv_places set id_page=".intval($IIL1lL1[I6538]).", spec_block_name='".$IIL1lL1[I6537]."', is_used=1, browse_mode_inuse='".$I1l111l.I6544.intval($cData[I6494]); $this->db->query($sql); }}break; }return true; }function getOptionsModulesCB($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues"){ switch($IIL1l1I){ case "getallvalues": $rec =array(); $numRows =0; $aAllowedModules =$this->module->GetProperty(I6545); $aAllowedModules =array_unique(array_merge($aAllowedModules, AMI_Ext::getSupportedModules('ext_adv', false))); foreach($aAllowedModules as $modName){ if($this->cms->Core->IsInstalled($modName) || AMI_ModDeclarator::getInstance()->isRegistered($modName)){ $numRows++; $res[] =array( I6491 => $modName, "caption" => $this->TIITII1($modName), I6511 => (is_array($cData[I6494]) && in_array($modName, $cData[I6494]) ?I6511 :I6482) );}}if($numRows == 0){ return false; }break; case I6546: $res =$cData[I6494]; break; case "correctvalue": $res =array(); foreach($this->module->GetOption(I6487) as $modName) $res[] =$modName; break; case "apply": break; }return true; }function getOptionsModColsCB($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues"){ switch($IIL1l1I){ case "getallvalues": if(is_array($this->module->GetOption(I6487)) && in_array($IIL1lL1[I6533], $this->module->GetOption(I6487))) return true; else return false; break; case I6546: $res =$cData[I6494]; break; case I6547: break; case "apply": break; }return true; }function getOptionsUseStatisticsCB($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues"){ switch($IIL1l1I){ case "getallvalues": return true; break; case I6546: $res =$cData[I6494]; break; case I6547: break; case "apply": $sql ="update cms_adv_places set use_statistics=".intval($cData[I6494]); $this->db->query($sql); break; }return true; }function getOptionsAllowedFrontStatModulesCB($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues"){ switch($IIL1l1I){ case "getallvalues": $rec =array(); $numRows =0; foreach($this->module->GetProperty(I6545) as $modName){ if($this->cms->Core->IsInstalled($modName)){ $numRows++; $res[] =array( I6491 => $modName, "caption" => $this->TIITII1($modName), I6511 => (is_array($cData[I6494]) && in_array($modName, $cData[I6494]) ?I6511 :I6482) );}}if($numRows == 0){ return false; }break; case I6546: $res =$cData[I6494]; break; case I6547: $res =array(); foreach($this->module->GetOption(I6487) as $modName) $res[] =$modName; break; case "apply": break; }return true; }}