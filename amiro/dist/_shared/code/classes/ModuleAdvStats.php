<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       44106 xkqwttzltsxyuysigpqrslzkrqwzmppkytwriwprgupriytrrgwxkuxsxptgqmqzgxxipnir
 */ ?><?php foreach(array(6548=>"",6549=>"nHnQ",6550=>'fJt|rQGHrtYB',6551=>'fJt|PrHuGYB',6552=>'SZBfrHI',6553=>'-1?IHntO',6554=>'fJt|ZSv|GJZWQD',6555=>"QDOHG|MtQI",6556=>"szqihN|jhpmN|hk",6557=>"ZSIMn",6558=>"fJt|YZnnQrD",6559=>'rQD',6560=>"ZJJ",6561=>"DQJQWt?G`MS!?G`nZIQ?frHI?WID|ZSv|GJZWQD?G?jqFT?lhmN?WID|ZSv|WZIGZMPnD?W?hN?ghdmTmhN}whNwzT}'^'!G`MS!'^'{?mN?W`MSD|GJZWQD{@0?COQrQ?G`GuYJMW=1?ZnS?G`DHurWQ|tBGQ,='IHSuJQ'?ZnS?W`MSD|GJZWQD,=''?ZnS?W`GuYJMW=1?ZnS?}W`DtZtuD='ZWtMvQ'?hR?W`DtZtuD='fMnMDOQS'{?PrHuG?YB?G`MS?HrSQr?YB?G`nZIQ",6562=>"=",6563=>"fJt|ZSvQrtMDQr|MS",6564=>"MS",6565=>"YBOHur",6566=>"fJt|rQGHrtYB",6567=>"YBYZnnQrD",6568=>"fJt|PrHuGYB",6569=>"SZBtH",6570=>"SZBfrHI",6571=>"SZtQ",6572=>"YBSZB",6573=>"YBZJJ",6574=>"fJt|ZSv|GJZWQD",6575=>"DQJQWt?G`MS!?G`nZIQ?frHI?WID|ZSv|GJZWQD?G?jqFT?lhmN?WID|ZSv|WZIGZMPnD?W?hN?ghdmTmhN}whNwzT}'^'!G`MS!'^'{?mN?W`MSD|GJZWQD{@0?COQrQ?G`GuYJMW=1?zNs?G`DHurWQ|tBGQ,='IHSuJQ'?zNs?W`MSD|GJZWQD,=''?zNs?W`GuYJMW=1?zNs?}W`DtZtuD='ZWtMvQ'?hR?W`DtZtuD='fMnMDOQS'{?zNs?W`MS|ZSvQrtMDQr='",6576=>"D`MS|GJZWQ",6577=>"?hR??'",6578=>"IQIYQrD",6579=>"1",6580=>"Wurr|GHDtfMx",6581=>"MtQI|",6582=>"SY",6583=>"``",6584=>"shNTdohc|whj|ohUR",6585=>"shNTdohc|whj|wigpd",6586=>"JMDt|SZtZ",6587=>"SQDW",6588=>"?ZD?WJMWKD!?",6589=>"'?zNs?Y`MS|HCnQr='",6590=>"GJZWQ|nZIQ",6591=>"=_WJMWKD",6592=>"WHDt|WJMWKD",6593=>"OHur",6594=>"WID|ZSv|YZnnQrD",6595=>"fMQJSD",6596=>"IQtOHS",6597=>"|GrHWoHurwy",6598=>"DuI|WHDt|vMQCD",6599=>"0",6600=>'MS',6601=>"DuI|WJMWKD",6602=>"DuI|vMQCD",6603=>"WHDt|DWJMWKD",6604=>"vMQCD",6605=>':`02f',6606=>"vZJuQ",6607=>"IZx|SZB",6608=>"SZB",6609=>"OZvMnP?WHunt?@?1",6610=>"MS|GJZWQ",6611=>"'?JMIMt?",6612=>"HrSQr?YB?tBGQ",6613=>"MS|WZIGZMPn",6614=>"SZtQ|HnJB",6615=>"-",6616=>"'?ZnS?MS|YZnnQr='",6617=>"'",6618=>"'?ZnS?SZtQ|HnJB='",6619=>"MS|YZnnQr",6620=>"ZSv|DtZtD",6621=>"'!?MS|WZIGZMPn='",6622=>"WJMWKD",6623=>"HGtMIMAQS|JZDt",6624=>"DtBJQ|DQJQWtQS",6625=>"SQfZuJt",6626=>"DuI}D`vMQCD{",6627=>"D`SZB!?D`OHur",6628=>"'{",6629=>"DGZn|WHJuIn|WHunt",6630=>"D`MS|WZIGZMPn",6631=>"D`MS!?",6632=>"?ZD?WHDt|vMQCD!?",6633=>"!?",6634=>"WZIGZMPn|nZIQ",6635=>"=_vMQCD",6636=>"!?D`OHur",6637=>'W',6638=>"WZJJYZWK",6639=>"HYLQWt",6640=>"ZGGJMQS|MS",6641=>"DuI|WHDt|WJMWKD",6642=>"DWJMWKD") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleAdvStats extends CMS_ActModule {public $I1l1LLl; public $member; public $I1LIIIl; public $IlL1LLL; public $IlL11II; public $dayFrom; public $dayTo; public $I1l1LLL; public $I1LIIIL; public $oEshop; public $I1lLlll; public $I1lLllL; function ModuleAdvStats(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->member =&$cms->Member; $this->I1l1LLl =""; $this->IlL1LLL =0; $this->IlL11II =0; $this->oEshop =NULL; $this->I1lLlll =""; $this->I1lLllL =I6548; }function _Init($IIll1l1 =Array(), $IIll1LI =I6548, $IIll1Ll =I6548, $aOptions =Array()) {$IIIIL11["group_operations"] =Array(); $IIIIL11["lang_data"] =false; $IIIIL11["check_public"] =false; $IIIIL11["allowed_actions"] =Array(I6549); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->IlL1LLL =!isset($this->cms->VarsPost['flt_reportby']) && !isset($this->cms->VarsGet['flt_reportby']) ?3 :intval(isset($this->cms->VarsPost['flt_reportby']) ?$this->cms->VarsPost['flt_reportby'] :$this->cms->VarsGet[I6550]); $this->IlL11II =!isset($this->cms->VarsPost['flt_groupby']) && !isset($this->cms->VarsGet['flt_groupby']) ?2 :intval(isset($this->cms->VarsPost['flt_groupby']) ?$this->cms->VarsPost['flt_groupby'] :$this->cms->VarsGet[I6551]); $this->dayFrom =!isset($this->cms->VarsPost['dayfrom']) && !isset($this->cms->VarsGet['dayfrom']) ?date($this->cms->DFMT['php'], strtotime(date('Y-m-01 H:i:s'))) :(isset($this->cms->VarsPost[I6552]) ?$this->cms->VarsPost[I6552] :$this->cms->VarsGet[I6552]); $this->dayTo =!isset($this->cms->VarsPost['dayto']) && !isset($this->cms->VarsGet['dayto']) ?date($this->cms->DFMT['php'], strtotime(date('Y-m-01 00:00:00', strtotime(I6553))) -1) :(isset($this->cms->VarsPost['dayto']) ?$this->cms->VarsPost['dayto'] :$this->cms->VarsGet['dayto']); $this->I1l1LLL =isset($this->cms->VarsPost['flt_adv_places']) ?$this->cms->VarsPost[I6554] :(isset($this->cms->VarsGet[I6554]) ?$this->cms->VarsGet[I6554] :null); $this->I1LIIIL =isset($this->cms->VarsPost['flt_banners']) ?$this->cms->VarsPost['flt_banners'] :(isset($this->cms->VarsGet['flt_banners']) ?$this->cms->VarsGet['flt_banners'] :null); if($this->cms->Core->IsInstalled(I6555)){ if($this->cms->Core->Side == "admin"){ require_once $GLOBALS['CLASSES_PATH'] .'EshopAdmin.php'; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init(I6555); }else{ CreateEshop($this->cms); $this->oEshop =&$this->cms->Eshop; }$this->I1lLllL =$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency); if(!empty($this->I1lLllL)) {$this->I1lLlll =$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency); }}}function _InitAdmin() {parent::_InitAdmin(); $IIlLL1I =$this->module->GetOption("proc_statistics_by"); if(defined(I6556)){ if(in_array("daemon", $IIlLL1I)){ $this->TIITIII(); $this->TIITIIl(); print "OK"; }else{ print "NOT ALLOWED"; }$GLOBALS['conn']->Out(); die; }elseif(in_array(I6557, $IIlLL1I)){ $this->TIITIII(); $this->TIITIIl(); }}function TTTlTI1() {parent::TTTlTI1(); }function TTTlIII() {parent::TTTlIII(); $this->filter->TITI1l1("datefrom"); $this->filter->TITI1l1("dateto"); $this->filter->AddField("flt_banners", "text", stripslashes($this->cms->Vars[I6558]), I6548, "=", "s.id_banner"); $this->filter->MoveField(I6558,_MOVE_START); $this->filter->TITIll1(I6558); if(empty($this->cms->Vars[I6558])) $this->filter->DisableFieldSQL(I6558); else{ $I1lLI1l =$this->filter->GetLikeSQL(addslashes(unhtmlentities($this->cms->Vars[I6558])), 'name'); $sql ="select id from cms_adv_banners where 1".$I1lLI1l[I6559]; $this->db->query($sql); $I1lLI1L =I6548; while($this->db->next_record()) $I1lLI1L .= " OR  '".$this->db->Record["id"]."'=s.id_banner"; if(!empty($I1lLI1L)) $this->filter->TITI1II(I6558, $I1lLI1L, "force"); }$I1l1Ill =Array(); $I1l1Ill =$this->filter->TITI1TT($I1l1Ill, Array($this->cms->Words[I6560]=>0), 55); $sql =I6561; $this->db->query($sql); while($this->db->next_record()){ $I1l1Ill =$this->filter->TITI1TT($I1l1Ill, Array($this->db->Record["name"]=>$this->db->Record["id"]), 55); }$this->filter->AddField("flt_adv_places", "select", $this->I1l1LLL, I6548, I6562, "s.id_place", $I1l1Ill); $this->filter->MoveField("flt_adv_places", _MOVE_START); $this->filter->TITIll1("flt_adv_places"); if(empty($this->I1l1LLL) || $this->I1l1LLL == 0) $this->filter->DisableFieldSQL("flt_adv_places"); $I1lL1IL =unhtmlentities($this->cms->Vars[I6563]); $this->filter->AddField(I6563, "text", stripslashes($this->cms->Vars[I6563]), I6548, I6562, "c.id_advertiser"); $this->filter->MoveField(I6563, _MOVE_START); if(empty($this->cms->Vars[I6563])) $this->filter->DisableFieldSQL(I6563); else{ $I1lL1I1 =str_replace("*", "%", addslashes($I1lL1IL)); $I1l1L1L =array(); $sql ="select m.id from cms_members m LEFT JOIN cms_adv_advertisers a ON m.id=a.id_member where a.active & m.active AND a.id>0 AND (lastname like '".$I1lL1I1."%' OR firstname like '".$I1lL1I1."%' or username like '".$I1lL1I1."%') AND m.lang='".$this->langData."' order by m.firstname, m.lastname"; $this->db->query($sql); while($this->db->next_record()){ $I1l1L1L[] =$this->db->Record[I6564]; }if(count($I1l1L1L) >0) $this->filter->TITI1II(I6563, " OR c.id_advertiser in ('".implode("', '", $I1l1L1L)."')", "force"); }$IlL1L1l =Array(); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words[I6565]=>0), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["byday"]=>1), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["byweek"]=>2), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["bymonth"]=>3), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["byyear"]=>4), 55); $this->filter->AddField(I6566, "select", $this->IlL1LLL, I6548, I6562, I6564, $IlL1L1l); $this->filter->MoveField(I6566, _MOVE_START); $this->filter->DisableFieldSQL(I6566); $IlL11Il =Array(); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byall"]=>0), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byplaces"]=>1), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["bycampaigns"]=>2), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words[I6567]=>3), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byperiod"]=>4), 55); $this->filter->AddField("flt_groupby", "select", $this->IlL11II, I6548, I6562, I6564, $IlL11Il); $this->filter->MoveField("flt_groupby", _MOVE_START); $this->filter->DisableFieldSQL(I6568); $this->filter->AddField("dayto", "date", $this->dayTo, time(), "<=", "s.day"); $this->filter->MoveField(I6569, _MOVE_START); $this->filter->AddField("dayfrom", "date", $this->dayFrom, time(), ">=", "s.day"); $this->filter->MoveField(I6570, _MOVE_START); }function TTTlITT($IIIL11l, $cId, $cModule =I6548) {parent::TTTlITT($IIIL11l, $cId, $cModule); }function TTTlIIl($IIlLlLI, $IIlLlLl, $defaultValue) {switch($IIlLlLI) {case I6570: $this->filter->AddField(I6570, "date", $this->dayFrom, strtotime(date("Y-m-01 H:i:s")), ">=", "s.day"); break; case I6569: $this->filter->AddField(I6569, I6571, $this->dayTo, strtotime(date("Y-m-01 00:00:00", strtotime("+1 month")))-1, "<=", "s.day"); break; case I6566: $IlL1L1l =Array(); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words[I6565]=>0), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words[I6572]=>1), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["byweek"]=>2), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["bymonth"]=>3), 55); $IlL1L1l =$this->filter->TITI1TT($IlL1L1l, Array($this->words["byyear"]=>4), 55); $this->filter->AddField(I6566, "select", $this->IlL1LLL, I6548, I6562, I6564, $IlL1L1l); $this->filter->DisableFieldSQL(I6566); break; case I6568: $IlL11Il =Array(); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words[I6573]=>0), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byplaces"]=>1), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["bycampaigns"]=>2), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words[I6567]=>3), 55); $IlL11Il =$this->filter->TITI1TT($IlL11Il, Array($this->words["byperiod"]=>4), 55); $this->filter->AddField(I6568, "select", $this->IlL11II, I6548, I6562, I6564, $IlL11Il); $this->filter->DisableFieldSQL(I6568); break; case I6574: $I1l1Ill =Array(); $I1l1Ill =$this->filter->TITI1TT($I1l1Ill, Array($this->cms->Words[I6560]=>0), 55); $sql =I6575.$this->member->getUserInfo('id')."' group by p.id order by p.name"; $this->db->query($sql); while($this->db->next_record()){ $I1l1Ill =$this->filter->TITI1TT($I1l1Ill, Array($this->db->Record["name"]=>$this->db->Record[I6564]), 55); }$this->filter->AddField(I6574, "select", $this->I1l1LLL, I6548, I6562, I6576, $I1l1Ill); if(empty($this->I1l1LLL) || $this->I1l1LLL == 0) $this->filter->DisableFieldSQL(I6574); break; case I6558: $this->filter->AddField(I6558, "text", $this->cms->Vars[I6558], I6548, I6562, "s.id_banner"); if(empty($this->cms->Vars[I6558])) $this->filter->DisableFieldSQL(I6558); else{ $I1lLI1l =$this->filter->GetLikeSQL(addslashes(unhtmlentities($this->cms->Vars[I6558])), 'name'); $sql ="select id from cms_adv_banners where 1".$I1lLI1l[I6559]; $this->db->query($sql); $I1lLI1L =I6548; while($this->db->next_record()) $I1lLI1L .= I6577.$this->db->Record[I6564]."'=s.id_banner"; if(!empty($I1lLI1L)) $this->filter->TITI1II(I6558, $I1lLI1L, "force"); }}}function TTTllTI(&$aCustom) {$this->SetBodyType("body_items"); parent::TTTllTI($aCustom); }function &TTTllTl(&$aCustom) {global $ROOT_PATH_WWW; if(!$this->member->isLoggedIn() || !$this->cms->Core->IsInstalled("eshop_cart")) {$mMembers =&$this->cms->Core->GetModule(I6578); $this->member->requireLogin($ROOT_PATH_WWW.$mMembers->GetFrontLink(), $ROOT_PATH_WWW.$this->module->GetFrontLink()); }else{ $sql ="select (m.active & a.active) as activity from cms_members m LEFT JOIN cms_adv_advertisers a ON m.id=a.id_member where m.id='".$this->member->getUserInfo('id')."'"; $this->db->query($sql); $this->db->next_record(); if($this->db->Record["activity"] != I6579){ $this->member->logout($this->cms); $mMembers =&$this->cms->Core->GetModule(I6578); $this->member->requireLogin($ROOT_PATH_WWW.$mMembers->GetFrontLink(), $ROOT_PATH_WWW.$this->module->GetFrontLink()); }}if(in_array("front", $this->module->GetOption("proc_statistics_by"))){ $this->TIITIII(); $this->TIITIIl(); }return parent::TTTllTl($aCustom); }function TTTll1T(&$vData, &$aCustom) {$aDefault =Array(); foreach($this->IIllIL1 as $IIlL1L1 => $tmp) {$IIlL1Ll =$this->TTITTT1($aCustom, $IIlL1L1); switch($IIlL1L1) {case "body_items": $IIlL1Ll["list_data"][I6580] =$this->I1lLllL; $IIlL1Ll["list_data"]["curr_prefix"] =$this->I1lLlll; $IIlL1Ll["list_data"]["simple_prefix"] =I6581; $IIlL1Ll["simple_set_fields"] =Array(); $aDefault["page_item_type"] ="body_items"; $this->TTTllll($vData, $IIlL1Ll); $IlL1LLL =I6548; $I1l1LI1 ="DATE_FORMAT(s.day,'".$this->cms->DFMT[I6582]."')"; $I1l1LlI ="sum(s.views)"; $I1l1Lll ="sum(s.clicks)"; $I1l1LlL ="s.id/s.id*IF(sum(views)=0,0,sum(clicks)/sum(views))"; $I1LIII1 ="sum(s.views*c.cost_view)"; $I1LIIlI ="sum(s.clicks*c.cost_click)"; $I1l1Ll1 =I6548; switch($this->IlL1LLL){ case 0: $IlL1LLL ="s.day, s.hour"; break; case 1: $IlL1LLL ="s.day"; break; case 2: $dfmt =$this->cms->DFMT[I6582]; $dfmt =str_replace(array("%d", I6583), array(I6548, I6548), $dfmt); $dfmt =trim($dfmt, "."); $I1l1LI1 ="DATE_FORMAT(s.day,'".$dfmt."')"; $IlL1LLL ="YEAR(s.day), WEEK(s.day)"; $I1l1Ll1 =", WEEK(s.day) as week"; break; case 3: $dfmt =$this->cms->DFMT[I6582]; $dfmt =str_replace(array("%d", I6583), array(I6548, I6548), $dfmt); $dfmt =trim($dfmt, "."); $I1l1LI1 ="DATE_FORMAT(s.day,'".$dfmt."')"; $IlL1LLL ="YEAR(s.day), MONTH(s.day)"; break; case 4: $I1l1LI1 ="YEAR(s.day)"; $IlL1LLL ="YEAR(s.day)"; break; }$IIlL1Ll["list_data"]["span_column_count"] =5; if($this->IlL1LLL >0){ $this->cms->Gui->addGlobalVars(array(I6584 => 1)); $IIlL1Ll["list_data"]["span_column_count"] -= 1; }if($this->IlL1LLL == 2){ $this->cms->Gui->addGlobalVars(array("HAS_FLD_WEEK" => 1)); }$IlL11II =I6548; switch($this->IlL11II){ case 1: $IlL11II =I6576; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_CMPGS" => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_BANNERS" => 1)); $IIlL1Ll["list_data"]["span_column_count"] -= 2; break; case 2: $IlL11II ="s.id_campaign"; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PLACES" => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_BANNERS" => 1)); $IIlL1Ll["list_data"]["span_column_count"] -= 2; break; case 3: $IlL11II ="s.id_banner"; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PLACES" => 1)); $this->cms->Gui->addGlobalVars(array(I6585 => 1)); $IIlL1Ll["list_data"]["span_column_count"] -= 2; break; case 4: $IlL11II =I6548; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PLACES" => 1)); $this->cms->Gui->addGlobalVars(array(I6585 => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_BANNERS" => 1)); $IIlL1Ll[I6586]["span_column_count"] -= 3; break; default: $IlL11II ="s.id_place, s.id_campaign, s.id_banner"; break; }$I1l1LLI =$this->browser->SortDim == "asc" ?"asc" :I6587; $this->browser->InitSQL("s.id, ".$I1l1LI1." as day".$I1l1Ll1.", ".($this->IlL1LLL >0 ?I6548 :"s.hour, ").$I1l1Lll.I6588.$I1l1LlI." as views, ".$I1LIII1." as cost_views, ".$I1LIIlI." as cost_clicks, b.name as banner_name, c.name as campaign_name, p.name as place_name, ".$I1l1LlL." as ctr", "FROM ((cms_adv_stats s LEFT JOIN cms_adv_banners b ON s.id_banner=b.id) LEFT JOIN cms_adv_places p ON s.id_place=p.id) LEFT JOIN cms_adv_campaigns c ON s.id_campaign=c.id", "WHERE c.id_advertiser=".$this->member->getUserInfo('id')." and c.id_owner='".$this->member->getUserInfo('id').I6589.$this->member->getUserInfo('id')."' ".$this->_ApplyFilters().$this->TTTlIl1(), $IlL1LLL.(!empty($IlL1LLL) && !empty($IlL11II) ?"," :I6548).$IlL11II, "s.day, s.hour, s.id_place, s.id_campaign, s.id_banner", "s.day, s.hour, s.views, s.clicks", array("banner_name" => "b.name", "campaign_name" => "c.name", I6590 => "p.name", "ctr" => "=|ctr", "clicks" => I6591, "views" => "=|views", "cost_views" => "=|cost_views", I6592 => "=|cost_clicks", "day" => "=|s.day ".$I1l1LLI.", s.hour", I6593 => "=|s.hour ".$I1l1LLI.", s.day") );$this->browser->AddSQLJoinedTables($this->cms->Core, 's', Array('b'=>I6594, 'c'=>"cms_adv_campaigns", 'p'=>"cms_adv_places")); $IIlL1Ll[I6595]["clicks"] =Array("action"=>"callback", "object"=>&$this, I6596=>"_calculateCTRCB"); $IIlL1Ll[I6595][I6593] =Array("action"=>"callback", "object"=>&$this, I6596=>I6597); $IIlL1Ll[I6595]["cost_views"] =Array("action"=>"callback", "object"=>&$this, I6596=>"_calculateCostViewsCB"); $IIlL1Ll[I6595][I6592] =Array("action"=>"callback", "object"=>&$this, I6596=>"_calculateCostClicksCB"); break; }$IIlL1Ll[I6586][I6598] ="0"; $IIlL1Ll[I6586]["sum_cost_clicks"] ="0"; $IIlL1Ll[I6586]["sum_views"] =I6599; $IIlL1Ll[I6586]["sum_clicks"] =I6599; $IIlL1Ll[I6586]["sum_ctr"] ="0.00"; $sql ="select sum(s.views) as sviews, sum(s.clicks) as sclicks, sum(s.views*c.cost_view) as cost_sviews, sum(s.clicks*c.cost_click) as cost_sclicks FROM ((cms_adv_stats s LEFT JOIN cms_adv_banners b ON s.id_banner=b.id) LEFT JOIN cms_adv_places p ON s.id_place=p.id) LEFT JOIN cms_adv_campaigns c ON s.id_campaign=c.id where c.id_advertiser=".$this->member->getUserInfo(I6600)." and c.id_owner='".$this->member->getUserInfo(I6600).I6589.$this->member->getUserInfo(I6600)."' ".$this->_ApplyFilters().$this->TTTlIl1(); $this->db->query($sql); if($this->db->next_record()){ $IIlL1Ll[I6586]["sum_views"] =$this->db->Record["sviews"]; $IIlL1Ll[I6586][I6601] =$this->db->Record["sclicks"]; $IIlL1Ll[I6586]["sum_ctr"] =sprintf('%.02f', min(100, ($IIlL1Ll[I6586]["sum_views"] >0 ?$IIlL1Ll[I6586][I6601]/$IIlL1Ll[I6586][I6602] :0)*100)); $IIlL1Ll[I6586][I6598] =sprintf('%.02f', $this->db->Record["cost_sviews"]); $IIlL1Ll[I6586]["sum_cost_clicks"] =sprintf('%.02f', $this->db->Record[I6603]); }parent::TTTll1T($vData, $IIlL1Ll); }}function _procHourCB(&$vItem, &$vData){ $vItem[I6593] =$vItem[I6593] >23 ?"00-23" :sprintf("%02s", $vItem[I6593]); }function _calculateCTRCB(&$vItem, &$vData){ $vItem["ctr"] =sprintf('%.02f', min(100, ($vItem[I6604] >0 ?$vItem["clicks"]/$vItem[I6604] :0)*100)); }function _calculateCostViewsCB(&$vItem, &$vData){ $vItem["cost_views"] =sprintf('%.02f', $vItem["cost_views"]); }function _calculateCostClicksCB(&$vItem, &$vData){ $vItem[I6592] =sprintf(I6605, $vItem[I6592]); }function TIITIIT(){ list($usec, $sec) =explode(" ", microtime()); return((float)$usec +(float)$sec); }function TIITIII(){ $vData =array(); if($this->cms->Core->ReadOption($vData, "adv_stats", "calc_last")){ $vData["value"] =intval($vData[I6606]); if($vData[I6606]+7200 >time()) return; }$this->cms->Core->WriteOption("adv_stats", "calc_last", time()); $GLOBALS["conn"]->SetBenchType('LONG'); $I1l1ILI =$this->TIITIIT(); $I1l1ILl =2.00; $I1l1ILL =1; $I1l1IL1 =500; $dbi =new db_si; $I1l1L11 =array(I6607 => "1970-01-01", "max_hour" => "01"); $sql ="select day, hour from cms_adv_stats order by day desc, hour desc limit 1"; $this->db->query($sql); if($this->db->next_record()){ $I1l1L11[I6607] =$this->db->Record[I6608]; $I1l1L11["max_hour"] =$this->db->Record[I6593]; }$sql ="select count(*) as count, type, day, id_place, id_campaign, id_banner ". "from cms_adv_stats_tmp ". "group by type, day, id_place, id_campaign, id_banner ". I6609; $this->db->query($sql); while($this->db->next_record()){ $sql ="delete from cms_adv_stats_tmp where type='".$this->db->Record["type"]."' and day='".$this->db->Record[I6608]."' and id_place='".$this->db->Record[I6610]."' and id_campaign='".$this->db->Record["id_campaign"]."' and id_banner='".$this->db->Record["id_banner"].I6611.($this->db->Record["count"]-1); $dbi->query($sql); }$sql ="select count(*) as count, type, id_place, id_campaign, id_banner, date_only, hour_only ". "from cms_adv_stats_tmp ". "group by type, date_only, hour_only, id_place, id_campaign, id_banner ". I6612; $this->db->query($sql); $I1l1Il1 =0; while($this->db->next_record()){ set_time_limit(60); if($I1l1Il1 == 0 || $I1l1Il1 %$I1l1IL1 == 0){ print " "; ob_flush(); if($this->TIITIIT() -$I1l1ILI >= $I1l1ILl){ sleep($I1l1ILL); $I1l1ILI =$this->TIITIIT(); set_time_limit(60); }}$I1l1Il1++; $what =$this->db->Record["type"] == "click" ?"clicks" :I6604; $data =array( I6610 => $this->db->Record[I6610], I6613 => $this->db->Record[I6613], "id_banner" => $this->db->Record["id_banner"], I6608 => $this->db->Record["date_only"], I6593 => $this->db->Record["hour_only"], );$I1l11lI =false; if($I1l1L11[I6607] >$this->db->Record[I6614] || ($I1l1L11[I6607] == $this->db->Record[I6614] && $I1l1L11["max_hour"] >= $this->db->Record["hour_only"]) || $what == "clicks"){ $data[$what] ="=|".$what.I6615.intval($this->db->Record["count"]); $sql =$dbi->GenUpdateSql("cms_adv_stats", $data, "where id_place='".intval($this->db->Record[I6610])."' and id_campaign='".intval($this->db->Record[I6613]).I6616.intval($this->db->Record["id_banner"])."' and day='".$this->db->Record[I6614]."' and hour='".$this->db->Record["hour_only"].I6617, DBC_LOW_PRI); $dbi->query($sql); if($dbi->affected_rows() >0) $I1l11lI =true; }if(!$I1l11lI){ $data[$what] =intval($this->db->Record["count"]); $sql =$dbi->GenInsertSql("cms_adv_stats", $data, DBC_LOW_PRI); $dbi->query($sql); }$sql ="delete from cms_adv_stats_tmp where type='".$this->db->Record["type"].I6618.$this->db->Record[I6614]."' and hour_only='".$this->db->Record["hour_only"]."' and id_place='".intval($this->db->Record[I6610])."' and id_campaign='".intval($this->db->Record[I6613]).I6616.intval($this->db->Record[I6619]).I6617; $dbi->query($sql); }$this->cms->Core->DeleteOption("adv_stats", "calc_last"); }function TIITIIl(){ $dbi =new db_si; $vData =array(); if($this->cms->Core->ReadOption($vData, "adv_stats", "calc_old_last")){ $vData[I6606] =intval($vData[I6606]); if($vData[I6606]+7200 >time()) return; }$this->cms->Core->WriteOption(I6620, "calc_old_last", time()); $I1l1l1L =intval($this->module->GetOption("days_to_keep_hour_stats")); if($I1l1l1L >0){ $sql ="select count(*) as count from cms_adv_stats where day<DATE_ADD(NOW(), INTERVAL -$I1l1l1L DAY) and hour!=25"; $this->db->query($sql); $this->db->next_record(); $I1l1l11 =I6548; $I1l1LII =false; if($this->db->Record["count"] >0){ $sql ="select id_place, id_campaign, id_banner, day, sum(views) as views, sum(clicks) as clicks from cms_adv_stats where day<DATE_ADD(NOW(), INTERVAL -$I1l1l1L DAY) and hour!=25 group by day, id_banner, id_campaign, id_place order by day"; $this->db->query($sql); $cnt =0; while($this->db->next_record()){ $cnt++; $sql ="INSERT LOW_PRIORITY INTO cms_adv_stats set id_place='".$this->db->Record[I6610].I6621.$this->db->Record[I6613]."', id_banner='".$this->db->Record[I6619]."', day='".$this->db->Record[I6608]."', hour=25, views='".$this->db->Record[I6604]."', clicks='".$this->db->Record[I6622].I6617; $dbi->query($sql); $I1l1LII =false; if($I1l1l11 != $this->db->Record[I6608]){ if(!empty($I1l1l11)){ $I1l1LII =true; $sql ="delete LOW_PRIORITY from cms_adv_stats where day='".$I1l1l11."' and hour!=25"; $dbi->query($sql); }$I1l1l11 =$this->db->Record[I6608]; }}if(!$I1l1LII && !empty($I1l1l11)){ $sql ="delete LOW_PRIORITY from cms_adv_stats where day='".$I1l1l11."' and hour!=25"; $dbi->query($sql); }}}$I1l1LIl =false; if($this->cms->Core->ReadOption($vData, I6620, I6623)){ $vData[I6606] =intval($vData[I6606]); if(time() -$vData[I6606] >345600 ){$I1l1LIL =getdate(); if($I1l1LIL["wday"] == 0 && $I1l1LIL["hours"] <8 || $I1l1LIL["wday"] >0 && $I1l1LIL["wday"] <4) $I1l1LIl =true; }}else $I1l1LIl =true; if($I1l1LIl){ $sql ="optimize table cms_adv_stats_tmp"; $dbi->query($sql); $sql ="optimize table cms_adv_stats"; $dbi->query($sql); $this->cms->Core->WriteOption(I6620, I6623, time()); }$this->cms->Core->DeleteOption(I6620, "calc_old_last"); }function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {$aData =Array(); $I1LIIll =&$this->cms->Core->GetModule(I6620); $aData["front_link"] =$I1LIIll->GetFrontLink(); $I1lLILI =$this->cms->Gui->getAbs($this->moduleName."_list:special_selected_style", I6548); $aData[I6624] =I6548; if($this->cms->ActivePage == I6620) $aData[I6624] =$I1lLILI; $vRes["body"] =I6548; if($this->member->isLoggedIn() && $I1LIIll->IsPresentInPMandPublic()) {$sql ="select (m.active & a.active) as activity from cms_members m LEFT JOIN cms_adv_advertisers a ON m.id=a.id_member where m.id='".$this->member->getUserInfo(I6600).I6617; $this->db->query($sql); $this->db->next_record(); if($this->db->Record["activity"] == I6579){ $vRes[I6620]["vars"] =$aData; $vRes[I6620][I6625] =$this->cms->Gui->get($this->moduleName."_list:special_menu_list", $aData); }}}function &TTTlI1T(&$aCustom) {return parent::TTTlI1T($aCustom); }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {$aCustom[I6586][I6580] =$this->I1lLllL; $aCustom[I6586]["curr_prefix"] =$this->I1lLlll; $IlL11II =I6548; $IlL1LLL =I6548; $I1l1LI1 ="DATE_FORMAT(s.day,'".$this->cms->DFMT[I6582]."')"; $I1l1LlI =I6626; $I1l1Lll ="sum(s.clicks)"; $I1l1LlL ="s.id/s.id*IF(sum(views)=0,0,sum(clicks)/sum(views))"; $I1LIII1 ="sum(s.views*c.cost_view)"; $I1LIIlI ="sum(s.clicks*c.cost_click)"; $I1l1Ll1 =I6548; switch($this->IlL1LLL){ case 0: $IlL1LLL =I6627; break; case 1: $IlL1LLL ="s.day"; break; case 2: $dfmt =$this->cms->DFMT[I6582]; $dfmt =str_replace(array("%d", I6583), array(I6548, I6548), $dfmt); $dfmt =trim($dfmt, "."); $I1l1LI1 ="DATE_FORMAT(s.day,'".$dfmt.I6628; $IlL1LLL ="YEAR(s.day), WEEK(s.day)"; $I1l1Ll1 =", WEEK(s.day) as week"; break; case 3: $dfmt =$this->cms->DFMT[I6582]; $dfmt =str_replace(array("%d", I6583), array(I6548, I6548), $dfmt); $dfmt =trim($dfmt, "."); $I1l1LI1 ="DATE_FORMAT(s.day,'".$dfmt.I6628; $IlL1LLL ="YEAR(s.day), MONTH(s.day)"; break; case 4: $I1l1LI1 ="YEAR(s.day)"; $IlL1LLL ="YEAR(s.day)"; break; }$aCustom[I6586]["span_column_count"] =5; if($this->IlL1LLL >0){ $this->cms->Gui->addGlobalVars(array(I6584 => 1)); $aCustom[I6586][I6629] -= 1; $I1l1LlI =I6626; $I1l1Lll ="sum(s.clicks)"; $I1l1LlL ="s.id/s.id*IF(sum(views)=0,0,sum(clicks)/sum(views))"; }if($this->IlL1LLL == 2){ $this->cms->Gui->addGlobalVars(array("HAS_FLD_WEEK" => 1)); }switch($this->IlL11II){ case 1: $IlL11II =I6576; $this->cms->Gui->addGlobalVars(array(I6585 => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_BANNERS" => 1)); $aCustom[I6586][I6629] -= 2; break; case 2: $IlL11II =I6630; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PLACES" => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_BANNERS" => 1)); $aCustom[I6586][I6629] -= 2; break; case 3: $IlL11II ="s.id_banner"; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PLACES" => 1)); $this->cms->Gui->addGlobalVars(array(I6585 => 1)); $aCustom[I6586][I6629] -= 2; break; case 4: $IlL11II =I6548; $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_PLACES" => 1)); $this->cms->Gui->addGlobalVars(array(I6585 => 1)); $this->cms->Gui->addGlobalVars(array("DONTSHOW_COL_BANNERS" => 1)); $aCustom[I6586][I6629] -= 3; break; default: $IlL11II ="s.id_place, s.id_campaign, s.id_banner"; break; }$I1l1LLI =$this->browser->SortDim == "asc" ?"asc" :I6587; $this->browser->InitSQL(I6631.$I1l1LI1." as day".$I1l1Ll1.", ".($this->IlL1LLL >0 ?I6548 :"s.hour, ").$I1l1Lll.I6588.$I1l1LlI." as views, ".$I1LIII1.I6632.$I1LIIlI." as cost_clicks, b.name as banner_name, c.name as campaign_name, p.name as place_name, ".$I1l1LlL." as ctr", "FROM ((cms_adv_stats s LEFT JOIN cms_adv_banners b ON s.id_banner=b.id) LEFT JOIN cms_adv_campaigns c ON s.id_campaign=c.id) LEFT JOIN cms_adv_places p ON s.id_place=p.id", "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), $IlL1LLL.(!empty($IlL1LLL) && !empty($IlL11II) ?I6633 :I6548).$IlL11II, "s.day, s.hour, s.id_place, s.id_campaign, s.id_banner", "s.day, s.hour, s.views, s.clicks", array("banner_name" => "b.name", I6634 => "c.name", I6590 => "p.name", "ctr" => "=|ctr", I6622 => I6591, I6604 => I6635, "cost_views" => "=|cost_views", I6592 => "=|cost_clicks", I6608 => "=|s.day ".$I1l1LLI.I6636, I6593 => "=|s.hour ".$I1l1LLI.", s.day") );$this->browser->AddSQLJoinedTables($this->cms->Core, 's', Array('b'=>I6594, I6637=>"cms_adv_campaigns", 'p'=>"cms_adv_places")); $aCustom[I6595] += Array( I6622 => Array("action"=>I6638, "object"=>&$this, I6596=>"_calculateCTRCB"), "cost_views" => Array("action"=>I6638, I6639=>&$this, I6596=>"_calculateCostViewsCB"), I6592 => Array("action"=>I6638, I6639=>&$this, I6596=>"_calculateCostClicksCB"), I6593 => Array("action"=>I6638, I6639=>&$this, I6596=>I6597), );$aCustom[I6640] ="s.id"; $aCustom["legend"] =Array(); $aCustom["form_data"]["buttons"] =Array(); $aCustom[I6586][I6598] =I6599; $aCustom[I6586][I6641] =I6599; $aCustom[I6586][I6602] =I6599; $aCustom[I6586][I6601] =I6599; $aCustom[I6586]["sum_ctr"] ="0.00"; $sql ="select sum(s.views) as sviews, sum(s.clicks) as sclicks, sum(s.views*c.cost_view) as cost_sviews, sum(s.clicks*c.cost_click) as cost_sclicks FROM ((cms_adv_stats s LEFT JOIN cms_adv_banners b ON s.id_banner=b.id) LEFT JOIN cms_adv_campaigns c ON s.id_campaign=c.id) LEFT JOIN cms_adv_places p ON s.id_place=p.id where 1 ".$this->_ApplyFilters().$this->TTTlIl1(); $this->db->query($sql); if($this->db->next_record()){ $aCustom[I6586][I6602] =$this->db->Record["sviews"]; $aCustom[I6586][I6601] =$this->db->Record[I6642]; $aCustom[I6586]["sum_ctr"] =sprintf(I6605, min(100, ($aCustom[I6586][I6602] >0 ?$aCustom[I6586][I6601]/$aCustom[I6586][I6602] :0)*100)); $aCustom[I6586][I6598] =sprintf(I6605, $this->db->Record["cost_sviews"]); $aCustom[I6586][I6641] =sprintf(I6605, $this->db->Record[I6603]); }parent::TTTlI11($vData, $aCustom); }}