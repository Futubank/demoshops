<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       66321 xkqwkpznwsqsyismisyxuwpsugulriwyqnygzzsxytplkprymmqnurswkulywtyizslkpnir
 */ ?><?php foreach(array(6925=>'OHDtiHSQ',6926=>'',6927=>'PQn|DuYJMnK',6928=>'SQfZuJt|GrQfMx',6929=>'OQZSQr',6930=>'uDQ|GHDMtMHnD',6931=>'|zGGJBwZtFMJtQrD',6932=>"?",6933=>'IQIYQrD',6934=>'uDQr',6935=>'3?CQQK',6936=>'SZtQfrHI',6937=>'fJt|WZt|MS',6938=>'?JMKQ?',6939=>'?=?',6940=>'OMSSQn',6941=>'fSZtQ|DtZrt',6942=>'WZGtMHn',6943=>'RqihTq|zssR',6944=>'MtQI|JMDt',6945=>'SY',6946=>'tZYJQD',6947=>"nZIQ",6948=>'GuYJMW',6949=>'GuY|MS',6950=>'WnZIQ',6951=>'ZWtMHn',6952=>'ZnnHunWQ',6953=>'vZJuQ',6954=>'Hff',6955=>'|ZSIMnRHCwy',6956=>'Hn',6957=>'GuYJMDOQS',6958=>'JQP|SQJ',6959=>'YuttHnD',6960=>'YHSB|MtQIs',6961=>'YHSB|urPQnt|MtQID',6962=>'YHSB|urPQnt|WZtD',6963=>'Qnv~DQDDMHn',6964=>"GZPQ|MtQI|tBGQ",6965=>"|DEJ",6966=>'Qxt|rDD',6967=>"OQZSQr",6968=>"coqRq?Zr`MS='",6969=>"ZWtMHn",6970=>"MS",6971=>"YHSB",6972=>"SQtMZJD",6973=>"!?",6974=>"coqRq?1?",6975=>"SQtZMJD",6976=>'YHSB|fHrI',6977=>'JMfQ|tMIQ',6978=>'WuDtHI|fMQJSD',6979=>'nZIQ',6980=>'|JMDt%fMQJS|',6981=>'RhhT|gzTo|ccc',6982=>' ',6983=>"YHSB|MtQIs",6984=>"tHG|JMnK",6985=>"ZutOHr",6986=>'|Hff',6987=>"SY",6988=>"?zd?Zr?",6989=>'rQvMQCQS',6990=>"GuYJMW",6991=>"dqjqwT?Zr`[?",6992=>"?coqRq?Zr`MS?=?",6993=>'SZtQ|QnS',6994=>'ZutOHr',6995=>'MG',6996=>'WZt|MS',6997=>"fMJQ|",6998=>"SQtZMJD|JMnK",6999=>"SZtQ",7000=>"MtQI",7001=>'nuJJ',7002=>"?hRsqR?yb?",7003=>"DuYMtQI|",7004=>"WZt|MS",7005=>'Qxt|MIZPQD',7006=>"ZSS|DuYMtQI|SZtZ",7007=>"MtQI|JMDt",7008=>"DuYMtQI",7009=>"JMDt",7010=>"DIZJJ|WZtQPHrB|MSD",7011=>"nH|WZtD",7012=>"JMDt|SZtZ",7013=>"W`",7014=>"?zNs?MS?mN}'",7015=>"Zr`[?",7016=>"DQJQWt",7017=>'hRsqR?yb?',7018=>"ZSv|WHuntQr|MS",7019=>"WZtD|nuI",7020=>"MtQI|GMWturQD",7021=>"WZJJYZWK",7022=>"fMQJSD",7023=>"HYLQWt",7024=>"frHnt|JMnK",7025=>"GrQvwZtmS",7026=>"MS|WZt",7027=>"WZt|SQtZMJ",7028=>"",7029=>'ihsUjq|gmwTURqd|gzTo',7030=>'ZttZWOIQnt',7031=>'IZx|uGJHZS|DMAQ',7032=>'ISZtQ',7033=>'IHSuJQ',7034=>'WID|fMJQD',7035=>'fMJQnZIQ',7036=>"coqRq?MS?=?",7037=>'DMAQ',7038=>'GMWturQ',7039=>'|IDPD`JnP',7040=>'DtZtuD|QrrHr',7041=>'GOG',7042=>'DtZtuD|ZSS',7043=>'DuGGHrt|rMPOtD',7044=>'vpJHYVZrD',7045=>'QIZMJ',7046=>'~\~`[$~',7047=>'MS|WZt',7048=>'wjzddqd|gzTo',7049=>'OHDt',7050=>'DQJQWt',7051=>"coqRq?.MS|WZt.?=?",7052=>'WZt') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} if (!defined('HOSTMODE_SHARED')) {define('HOSTMODE_SHARED', 0x2); }if (!function_exists(I6925)) {function hostMode() {static $mode =false; if ($mode === false) {$mode =$GLOBALS['_h']['mode'] == 'single' ?0 :HOSTMODE_SHARED; }return $mode; }}class ModuleClassifieds extends CMS_ActModule {public $IlIllI1; public $I1LIIl1; public $I1LIILI; public $I1LIILl; public $I1LIILL; public $II1lllI; public $I1Lllll; public $I1LII1I; public $I1LlllL; public $IlIlLIL; public $II11ll1; public $I1Llll1; public $I1LllLI; function ModuleClassifieds(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->II1lllI =array ();}function _Init($IIll1l1 =array(), $IIll1LI ='', $IIll1Ll =I6926, $aOptions =array ()){$IIIIL11 =array ('group_operations' => array ('publish_on', 'publish_off', 'del', I6927, 'gen_keywords', "index_details", "no_index_details", 'move_position'), I6928 => 'ar', 'use_id_page' => true, 'use_options_form' => true, 'name_field_name' => I6929, 'description_field_name' => 'body', 'picture_cat' => $this->module->GetProperty('picture_cat'), I6930 => true );$aOptions += $IIIIL11; $catModuleName =$this->module->GetName() .'_cat'; $this->I1LII1I =$this->cms->Core->IsInstalled($catModuleName) && $this->module->IssetAndTrueOption('use_categories'); if ($this->I1LII1I) {$this->IlIllI1 =new CategoriesFunctionsClassifieds($this->cms, $this, $catModuleName); }else {$this->IlIllI1 =new CMS_CategoriesFunctionsStub($this->cms, $this, $catModuleName); }parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->II11ll1 =empty($this->IlIlLIL['id']) ?0 :$this->IlIlLIL['id']; $this->IlIllI1->_Init(); $this->IlIllI1->TTIT1IT(I6931); $this->I1Lllll =&$this->cms->Core->GetModule('files'); if (CheckProbability(0.03)) {$I1LllLl =$this->module->GetOption('autodeletion_period'); if (mb_strpos($I1LllLl, '0 ') !== 0) {$sql ="DELETE FROM " .$this->module->GetTableName() .I6932 ."WHERE `date_end` < DATE_SUB(NOW(), INTERVAL " .$I1LllLl .")"; $this->db->execute($sql); }}require_once $GLOBALS['FUNC_INCLUDES_PATH'] .'func_gui.php'; }function _InitAdmin() {global $oSession; parent::_InitAdmin(); $vMod =&$this->cms->Core->GetModule(I6933); $this->cms->Gui->AddGlobalVars(array ('members_link' => $vMod->GetAdminLink())); $this->cms->SetsTemplate =$this->moduleName .'_list'; if (is_object($oSession)) {$this->IlIlLIL =$oSession->GetVar('user'); }else if (function_exists('admSession')) {$session =admSession(); $this->IlIlLIL =$session->GetVar(I6934); }else {$this->IlIlLIL =array ();}}function TTTlTI1() {global $oSession; parent::TTTlTI1(); $this->IlIlLIL =$oSession->IsSessionStarted() && $oSession->memberId >0 ?$oSession->GetVar(I6934) :array ();$this->I1LIIl1 =$this->module->GetOption('show_subitems'); $this->I1LIILl =$this->module->GetOption('subitems_splitter_period'); $this->I1LIILL =$this->module->GetOption('subitems_cols'); $this->cms->SetsTemplate =$this->moduleName .'_list'; if ($this->I1LII1I) {$this->TIITl1T(); }$this->I1LlllL ="AND NOW() BETWEEN ar.date_start AND ar.date_end"; $this->I1Llll1 =array ('1 day', '3 day', '1 week', '2 week', I6935, '1 month', '3 month', '6 month' );}function TTTlITT($IIIL11l, $cId, $cModule ="") {parent::TTTlITT($IIIL11l, $cId, $cModule); }function GetHtml(&$aCustom) {return parent::GetHtml($aCustom); }function TTTlIII() {parent::TTTlIII(); $this->filter->UpdateFieldDBName(I6936, 'date_start'); $this->filter->UpdateFieldDBName('dateto', 'date_start'); if($this->IlIllI1->TTTlIII('flt_cat_id')) {$this->filter->MoveField(I6937, _MOVE_START); $this->filter->Captions[I6937] =$this->words[I6937]; }$this->filter->AddField('flt_header', 'text', isset($this->cms->Vars['flt_header']) ?stripslashes(unhtmlentities($this->cms->Vars['flt_header'])) :I6926, I6926, I6938, I6929); $this->filter->AddField('flt_ip', 'text', isset($this->cms->Vars['flt_ip']) ?stripslashes(unhtmlentities($this->cms->Vars['flt_ip'])) :I6926, I6926, I6939, 'INET_NTOA(`ip`)'); if (empty($this->cms->Vars['flt_ip'])) {$this->filter->DisableFieldSQL('flt_ip'); }}function _ApplyCatFilters($prefix =I6926, $bodyType =I6926, $IIlLLl1 =true) {$res =I6926; if ($this->side == 'front' && !$this->IlIllI1->IILLL11) {$res =" AND NOW() BETWEEN ar.`date_start` AND ar.`date_end`"; }$res .= parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); return $res; }function TTTlIIl($IIlLlLI, $IIlLlLl, $defaultValue) {switch($IIlLlLI) {case 'date_from': if( $IIlLlLl != I6926 && isset($this->cms->VarsGet['date_to']) && $IIlLlLl == $this->cms->VarsGet['date_to'] ){$utime =DateTools::isvaliddate($IIlLlLl, $this->cms->DFMT['conf']); $this->filter->AddField($IIlLlLI, I6940, $IIlLlLl); if($utime){ $this->I1LlllL =" AND '" .DateTools::toMysqlDate($utime) ."' BETWEEN `date_start` AND `date_end`"; }}break; case 'date_to': if($IIlLlLl != I6926){ $this->filter->AddField($IIlLlLI, I6940, $IIlLlLl); }}}function _ApplyFilters($prefix =I6926, $bodyType =I6926, $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1).$this->I1LlllL; return $res; }function TTTlI1I(&$vData) {if ($this->action != 'edit') {$time =time(); $vData[I6941] =date($this->cms->DFMT['php'], $time); $vData['fdate_end'] =date($this->cms->DFMT["php"], strtotime($this->module->GetOption('default_life_time'), $time)); }$vData['max_attachment_size'] =getBytesAsText($this->module->GetOption('max_upload_size'), $this->words, 1); $customFields =$this->module->GetOption('custom_fields'); $vData['custom_fields'] =I6926; if (sizeof($customFields)) {$I1LllLL =sizeof($this->itemData) ?unserialize($this->itemData['custom_fields']) :array ();$captions =$this->cms->Gui->ParseLangFile($GLOBALS['LOCAL_FILES_REL_PATH'] .'_admin/templates/lang/options/classifieds_rules_values.lng'); foreach ($customFields as $customField) {$customField ='custom_fields_' .$customField; $vData['custom_fields'] .= $this->cms->Gui->getAbs($this->moduleName .'_subform:custom_field_row', array (I6942 => $captions[$customField], 'name' => $customField, 'value' => isset($I1LllLL[$customField]) ?stripslashes($I1LllLL[$customField]) :I6926 ));}}if (sizeof($this->itemData)) {unset($this->itemData['custom_fields']); }else {$vData['ip'] =getenv(I6943); }parent::TTTlI1I($vData); $vData['form_width'] ='100%'; }function TTTlI1l() {$res =false; if(parent::TTTlI1l()) {$res =$this->IlIllI1->TTTlI1l(); }return $res; }function TTTlI11(&$vData, &$aCustom) {$aCatSql =Array(); $aCatSql['join_to_alias'] ='ar'; $this->IlIllI1->TTIT1lT(I6944, $aCatSql); $this->browser->InitSQL( "ar.*, " ."DATE_FORMAT(ar.date_start,'" .$this->cms->DFMT['db'] ."') AS fdate_start, DATE_FORMAT(ar.date_end, '" .$this->cms->DFMT[I6945] ."') AS fdate_end " .$aCatSql["select"], array ('tables' => array ('ar' => $this->module->GetTableName()) +$aCatSql[I6946], 'joins' => $aCatSql['joins'] ),"WHERE 1 " .$this->_ApplyFilters() .$this->TTTlIl1(), "", I6947, "ar.date_start ASC", $aCatSql["order_replace"] );if (!empty($aCatSql[I6946])) {$this->browser->AddSQLJoinedTables($this->cms->Core, 'ar', $aCatSql[I6946]); }$aCustom['fields'] += array (I6948 => array ('action' => 'flagicon', 'value' => 1, 'id'=>I6949, 'on' => $this->moduleName .'_list:public_on', 'off' => $this->moduleName .'_list:public_off'), I6950 => array ('action' => 'stripline', 'size' => 35), 'author' => array (I6951 => 'stripline', 'size' => 35), I6929 => array (I6951 => 'stripline', 'size' => 35), I6952 => array (I6951 => 'stripline', 'size' => 145), 'action_edit' => array (I6951 => 'flagicon', I6953 => I6926, 'id' => 'edit_id', 'on' => $this->moduleName .'_list:edit', I6954 => I6926), 'action_view' => array (I6951 => 'callback', 'object' => &$this, 'method' => I6955), 'action_del' => array (I6951 => 'flagicon', I6953 => I6926, 'id' => 'del_id', I6956 => $this->moduleName .'_list:del', I6954 => I6926) );$aCustom['applied_id'] ='ar.id'; $aCustom['legend'] =array (I6957, 'notpublished', 'leg_yellow', 'leg_blue', 'leg_edit', I6958, 'leg_attach', 'leg_noattach', 'leg_bold'); $aCustom['form_data'][I6959] =Array('add', 'apply', 'cancel', 'save'); $this->IlIllI1->TTTlI11($vData, $aCustom); parent::TTTlI11($vData, $aCustom); }function TTTllTI(&$aCustom) {$flag =true; $I1LII1L =false; $cat =$this->IlIllI1->TTTllTI($aCustom); if($cat != -1) {if($this->id >0) {$this->SetBodyType(I6960); $flag =false; $I1LII1L =true; }else {if($cat === 0) {$this->SetBodyType('body_urgent_cats'); $this->SetBodyType('body_cats'); $this->bodyType ='body_cats'; $flag =false; }else {if($this->id != -1) {$this->SetBodyType('body_items'); $this->SetBodyType(I6961); $this->SetBodyType('body_form'); }else {$this->SetBodyType(I6960); $flag =false; $I1LII1L =true; }}}if($cat !== false) {if($flag && $this->module->GetOption('multicat')) {$this->SetBodyType('body_urgent_cats'); $this->SetBodyType('body_cats'); if ($this->bodyType == I6962) {$this->bodyType ='body_cats'; }}if($I1LII1L && $this->module->GetOption('multicat_in_body_details')) {$this->SetBodyType(I6962); $this->SetBodyType('body_cats'); if ($this->bodyType == I6962) {$this->bodyType ='body_cats'; }}}}parent::TTTllTI($aCustom); }function TTTlllT(&$vData) {parent::TTTlllT($vData); }function TTTll1T(&$vData, &$aCustom) {$aDefault =array ();$this->TTT11ll(); $I1LllL1 =AMI::getSingleton(I6963)->isLoggedIn(); if ($I1LllL1) {$vData['author'] =$this->IlIlLIL['username']; }else {$vData['author'] =I6926; }foreach ($this->IIllIL1 as $IIlL1L1 => $tmp) {$this->lIlLL11 =false; $IIlL1Ll =$this->TTITTT1($aCustom, $IIlL1L1, false); switch($IIlL1L1) {case "body_cats": case I6962: $IIlL1Ll[I6964] =$IIlL1L1; $IIlL1Ll['show_urgent_elements'] =$this->cms->Core->getModOption($this->IlIllI1->catModuleName, 'show_urgent_elements'); $IIlL1Ll["_sql"]["select"] .= ", c.adv_place AS cat_adv_place"; if (!$this->IlIllI1->IILLL11) {$IIlL1Ll["_sql"]["join"] .= " LEFT JOIN " .$this->module->GetTableName() ." ar ON c.id = ar.id_cat"; $IIlL1Ll[I6965]["group"] ="ar.id_cat"; }if (isset($this->ext['ext_rss'])) {$I1LII11 =$this->ext['ext_rss']->IL1LI11; $this->ext[I6966]->IL1LI11 =false; }$this->IlIllI1->TTTll1T($vData, $IIlL1Ll); break; case "body_itemD": $aDefault[I6964] ="body_itemD"; $IIlL1Ll += $aDefault; if($this->module->issetAndTrueOption('display_inactive_by_direct_link')){ $this->I1LlllL =I6926; }$IIlL1Ll["simple_set_fields"] =Array(I6967, "announce", "body"); $this->IlIllI1->TTTll1T($vData, $IIlL1Ll); $aCatSql =Array(); $this->IlIllI1->TTIT1lT("item_details", $aCatSql); $sql ="SELECT ar.*, ". "DATE_FORMAT(ar.date_start, '".$this->cms->DFMT["db"]."') AS fdate ". "FROM " .$this->module->GetTableName() ." AS ar ". I6968.$this->id."'".$aCatSql["where"].$this->_ApplyFilters(); $IIlL1Ll["fields"]["detials"] =Array(I6969=>"callback", "object"=>&$this, "method"=>"_GetItemCB"); $this->db->query($sql); $vData[I6970] =$this->id; break; case "body_items": case I6961: case "body_filtered": $aDefault[I6964] =$IIlL1L1; $aDefault["simple_set_fields"] =Array("announce", I6967, I6971); $IIlL1Ll += $aDefault; $this->TTTllll($vData, $IIlL1Ll); $aCatSql =Array(); $IIL1II1 ="item_list"; if($IIlL1L1 == "body_filtered") {$IIL1II1 ="item_filtered"; }$IIlL1Ll["fields"][I6972] =Array(I6969=>"callback", "object"=>&$this, "method"=>"_GetItemCB"); $this->IlIllI1->TTIT1lT($IIL1II1, $aCatSql); $this->browser->InitSQL("ar.*, (LENGTH(ar.body) > 0) AS body_notempty, ". "DATE_FORMAT(ar.date_start, '".$this->cms->DFMT["db"]."') AS fdate".$aCatSql["select"].I6973. "ar.date_start as m_date, date_start as c_date ", "FROM " .$this->module->GetTableName() ." AS ar ".$aCatSql["join"], I6974.$aCatSql["where"].$this->_ApplyFilters(I6926, $IIlL1L1 == I6961 ?$IIlL1L1 :I6926).$this->TTTlIl1(), "", $this->browser->TI1TTlT() );$this->browser->AddSQLJoinedTables($this->cms->Core, 'ar', $aCatSql["tables"]); $this->lIlLL11 =true; $IIlL1Ll["isAdvertisementSupported"] =true; if(!$this->IlIllI1->TTTll1T($vData, $IIlL1Ll)) {$IIlL1Ll[I6964] ="body_empty"; }else{ $this->TTTlll1($this->IlIllI1->catModuleName); $this->TTT11ll(); $procData =array("cat_adv_place" => $vData['cat_adv_place']); $procData[I6970] =$vData["cat_id"]; $this->_getCatAdvPlaceCB($procData, $procData, I6975); $vData['cat_adv_place'] =$procData["cat_adv_place"]; $vData['cat_adv_counter'] =$procData["cat_adv_counter"]; $this->TTTlll1($this->moduleName); $this->TTT11ll(); }break; case I6976: $IIlL1Ll['page_item_type'] =I6976; if ($this->module->GetOption('front_allow_to_add')) {if ($I1LllL1 || !$this->module->GetOption('front_allow_to_add_registered_only')) {$I1Lll1I =$this->module->GetOption('default_life_time'); $time =time ();foreach ($this->I1Llll1 as $index => $period) {if (strtotime($period, $time) >= strtotime($I1Lll1I, $time)) {break; }}$index++; $vData[I6977] =I6926; for ($i =0 ;$i <$index ;$i++) {$vData[I6977] .= $this->cms->Gui->getAbs($this->moduleName .'_list:option_row', array (I6953 => $i, 'selected' => $i <$index-1 ?I6926 :' selected', I6942 => $this->words['life_time_' .$i] ));}$customFields =$this->module->GetOption(I6978); $I1LllLL =isset($vData[I6978]) ?unserialize($vData[I6978]) :array ();$vData[I6978] =I6926; if (sizeof($customFields)) {$captions =$this->cms->Gui->ParseLangFile($GLOBALS['LOCAL_FILES_REL_PATH'] .'_admin/templates/lang/options/classifieds_rules_values.lng'); foreach ($customFields as $customField) {$customField ='custom_fields_' .$customField; $vData[I6978] .= $this->cms->Gui->getAbs($this->moduleName .'_list:custom_field', array (I6942 => $captions[$customField], I6979 => $customField, I6953 => isset($I1LllLL[$customField]) ?stripslashes($I1LllLL[$customField]) :I6926 ));}}if ($vData['allow_attach'] =$this->module->GetOption('front_allow_attach')) {$vData['max_attachment_size'] =getBytesAsText($this->module->GetOption('max_upload_size'), $this->words, 1); }if ($vData['allow_attach_images'] =$this->module->GetOption('front_allow_attach_images')) {$aPictures =$this->TITTl1T(); if (sizeof($aPictures['enabled'])) {foreach ($aPictures['enabled'] as $key => $name) {$vData['field_' .$name] =$this->cms->Gui->get($this->moduleName .I6980 .$name, $vData); }}}$vData['form'] =$this->cms->Gui->get($this->moduleName .'_list:form', $vData); }else {$mMembers =$this->cms->Core->GetModule(I6933); $vData['register_link'] =$mMembers->GetFrontLink(); $vData['wantsurl'] =rawurlencode($GLOBALS[I6981] .$GLOBALS['vGlobVars']['script_full_link'] .(mb_strpos($GLOBALS['vGlobVars']['script_full_link'], I6982) === false ?I6982 :'&') .'#form'); $vData['form'] =$this->cms->Gui->get($this->moduleName .'_list:register_to_add_classifieds', $vData); }}break; }$this->lIlLL11 =false; parent::TTTll1T($vData, $IIlL1Ll); if (isset($I1LII11)) {$this->ext[I6966]->IL1LI11 =$I1LII11; unset($I1LII11); }}}function TTT1lTl($IIl1II1, &$record, &$vData, &$aData) {parent::TTT1lTl($IIl1II1, $record, $vData, $aData); switch($IIl1II1) {case I6983: $vData["item_link"] =$this->cms->Gui->get($this->moduleName."_list:itemD_item_link", $vData); $this->IlIllI1->TTT1lTl($IIl1II1, $record, $vData, $aData); $vData["top_link"] =$this->cms->TTITI1l("itemD", I6984, $vData); $vData["date"] =$this->cms->TTITI1l("itemD", "date", $record["fdate"]); if(!empty($record[I6985])) {$vData[I6985] =$this->cms->TTITI1l("itemD", I6985, $record); }break; }}function _adminRowCB(&$aItem, &$aData) {$aItem['action_view'] =$this->cms->Gui->get($this->moduleName .'_list:icon_file' .($aItem['id_file'] ?I6926 :I6986), $aItem); if (!$aItem['reviewed']) {$aItem['style'] .= '_b'; }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT ar.*, DATE_FORMAT(ar.date_start,'" .$this->cms->DFMT[I6987]."') AS fdate_start, DATE_FORMAT(ar.date_end,'".$this->cms->DFMT[I6987]."') AS fdate_end , ". "IF(ar.public > 0, ' checked', '') AS public, INET_NTOA(ar.`ip`) `ip` ". "FROM " .$this->module->GetTableName() .I6988. I6968.$cId."'".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData["announce"] =$this->cms->htmlchars($this->itemData["announce"]); $this->itemData[I6971] =$this->cms->htmlchars($this->itemData[I6971]); if (!$this->itemData['reviewed']) {$sql =$this->db->genUpdateSQL($this->module->GetTableName(), array (I6989 => 1), "WHERE id = " .$cId); $this->db->execute($sql, DBC_RAW_QUERY); }}}function _ActionDel($cId, $cModule) {$sql ="SELECT public, id_cat FROM " .$this->module->GetTableName() ." WHERE id='".$cId."'"; $this->db->query($sql); if($this->db->next_record()){ $this->IlIllI1->TTIT1ll($cId, $cModule, $this->db->Record[I6990], $this->db->Record["id_cat"]); parent::_ActionDel($cId, $cModule); $err =$this->GetLastError(); if (empty($err["errno"])) {$this->IlIllI1->_ActionDel($cId, $cModule); }}}function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); if (empty($this->errno) && $this->appliedId >0) {$this->IlIllI1->TTTll11($cId, $cModule); $this->TIITlll(); if ($this->realSide == 'front') {$this->TIITll1($this->I1LllLI); }}}function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); if (empty($this->errno)) {$this->IlIllI1->TTTl1lI($cId, $cModule); $this->TIITlll(); }}function _ActionPublish($cId, $cModule) {$this->IlIllI1->TTIT1ll($cId, $cModule); parent::_ActionPublish($cId, $cModule); if (!$this->errno && $this->cms->Vars['publish'] == I6956 && $this->db->affectedRows() && $this->module->GetOption('notify_author_when_published')) {$aCatSql =array ('join_to_alias' => 'ar'); $side =$this->cms->Core->Side; $this->cms->Core->Side ='front'; $this->IlIllI1->TTIT1lT('small_list', $aCatSql); $this->cms->Core->Side =$side; $sql =I6991 .$aCatSql['select'] ." FROM " .$this->module->GetTableName() ." ar" .$aCatSql['join'] .I6992 .intval($cId); if ($aSQL =$this->db->getRecord($sql)) {$this->TIITll1($aSQL); }}$this->IlIllI1->_ActionPublish($cId, $cModule); }function TTT1Tl1($cType, $cModule, $condition =I6926) {$res =$this->IlIllI1->TTT1Tl1($cType, $cModule); if (!$res) {parent::TTT1Tl1($cType, $cModule, $condition); }}function TTT1IlI($aSQL =array (),$cId =0) {$header =$this->cms->VarsPost[I6929]; $announce =$this->cms->VarsPost[I6952]; if (!empty($header) && !empty($announce)) {$aSQL =array ('date_start' => DateTools::toMysqlDate(DateTools::getCorrectUDate($this->cms->VarsPost['date_start'], $this->cms->DFMT['conf'])), 'date_end' => DateTools::toMysqlDate(DateTools::getCorrectUDate($this->cms->VarsPost[I6993] .' 23:59:59', $this->cms->DFMT['conf_dtime'])), I6929 => $header, I6952 => $announce, 'body' => $this->cms->VarsPost['body'], I6994 => $this->cms->VarsPost[I6994], 'email' => $this->cms->VarsPost['email'], I6948 => intval($this->cms->VarsPost[I6948]) );if ($this->realSide != 'front') {$aSQL[I6989] =1; }if ($this->action == 'add') {$aSQL[I6995] ="=|INET_ATON('" .getenv(I6943) ."')"; }$customFields =$this->module->GetOption(I6978); if (sizeof($customFields)) {$data =array ();foreach ($customFields as $customField) {$customField ='custom_fields_' .$customField; $data[$customField] =$this->cms->VarsPost[$customField]; }$aSQL[I6978] =addslashes(serialize($data)); }if (!empty($this->cms->Vars['skip_cats']) && isset($this->cms->VarsPost[I6996])) {unset($this->cms->VarsPost['catname']); $this->IlIllI1->varName =I6996; }$this->IlIllI1->TTT1IlI($aSQL, $cId); if ($this->realSide == 'front' && $this->module->GetOption('front_allow_attach_images')) {$aPictures =$this->TITTl1T(); foreach ($aPictures["enabled"] as $ILLL1l1) {$ILLL1LI =I6997.$ILLL1l1; if ($_FILES[$ILLL1LI][I6947] != "") {$ILLL1Ll =$GLOBALS['CUSTOM_PICTURES_HTTP_PATH'] .$this->moduleName .'/'; $ILLL1LL =$GLOBALS['ROOT_PATH'] .$ILLL1Ll; $filename =$this->cms->TTITI11(time() .stripslashes($_FILES[$ILLL1LI][I6979])); if ($this->cms->doUploadImage($_FILES[$ILLL1LI], $ILLL1LL.$filename)) {$this->cms->Vars[$ILLL1l1] =$ILLL1Ll .$filename; $this->cms->VarsPost[$ILLL1l1] =$this->cms->Vars[$ILLL1l1]; }}}}}$this->I1LllLI =$aSQL =parent::TTT1IlI($aSQL, $cId); return $aSQL; }function _GetDetailsLinkCB(&$aItem, &$aData) {if(!empty($aItem[I6971])) {$aItem[I6998] =1; }}function TIITIll(&$aItem, &$aData, $setPrefix =I6926) {static $customFields; if (!isset($customFields)) {$customFields =$this->module->GetOption(I6978); }$aItem["date"] =$aItem["fdate"]; $aItem["date"] =$this->cms->TTITI1l("item", I6999, $aItem); if($aItem["body_notempty"]) {$aItem["more"] =$this->cms->TTITI1l("item", "more", $aItem); }if (!empty($aItem[I6985])) {$aItem[I6985] =$this->cms->TTITI1l(I7000, I6985, $aItem); }if (sizeof($customFields) && $aItem[I6978]) {$I1Lll1l =unserialize($aItem[I6978]); foreach ($customFields as $customField) {$customField ='custom_fields_' .$customField; if (isset($I1Lll1l[$customField])) {$aItem[$customField] =stripslashes($I1Lll1l[$customField]); }}}}function _GetItemCB(&$aItem, &$aData) {$this->TIITIll($aItem, $aData); }function TIITIl1(&$IIL1lLI, $IIl1II1 =I6926) {$this->lIlLL11 =false; $II11L1L =" ar.urgent DESC, ar.".$this->module->GetOption("front_subitem_sort_col").I6932.$this->module->GetOption("front_subitem_sort_dim"); $fields ="SELECT ar.id, ar.id_cat, ar.author, ar.announce, ar.sublink, ar.body, ar.header, ". "(LENGTH(ar.body) > 0) AS body_notempty, ". "DATE_FORMAT(ar.date_start, '".$this->cms->DFMT[I6987]."') AS fdate, ar.adv_place, ar.urgent "; foreach($this->options["item_pictures"] as $fieldName) {if(!empty($fieldName) && $fieldName != I7001 && $fieldName != -222222){ $fields .= ", ar.ext_".$fieldName; }}$fields .= " FROM " .$this->module->GetTableName() ." AS ar WHERE "; if($this->I1LIIl1 >0) {$sql =$fields."ar.id_cat='__id_cat__'".$this->_ApplyFilters(I6926, $IIl1II1, false).I7002.$II11L1L." LIMIT ".$this->I1LIIl1; }else {$sql =$fields."ar.id_cat IN('".implode("','", $IIL1lLI)."')".$this->_ApplyFilters(I6926, $IIl1II1, false)." ORDER BY ar.id_cat ASC, ".$II11L1L; }$this->I1LIILI =$this->IlIllI1->TTIITTI($sql, $IIL1lLI, "__id_cat__"); $this->lIlLL11 =true; }function _DrawSubItemsCB(&$aItem, &$aData) {$I1LIlIl =$this->I1LIILI[$aItem[I6970]]; $aItem["item_list"] =""; if(is_array($I1LIlIl)) {$k =0; $numRows =sizeof($I1LIlIl); $vData["simple_prefix"] =I7003; $I1LIlIL =$this->options["name_field_name"]; $this->options["name_field_name"] =I6967; $IIllLII =$this->TTT11ll(); foreach($I1LIlIl as $index=>$aSubItem) {$k++; $aTmp["active_item_type"] ="body_items"; $aTmp[I7004] =$aItem[I6970]; $aTmp["cat_sublink"] =$aItem["sublink"]; $this->_GetNavDataCB($aSubItem, $aTmp); $aSubItem += $this->IIllllL; $IIlLIIL =Array(I6969=>"_GetPicturesCB", "data"=> $_data =array(&$aSubItem, &$aData)); $this->TTT1lI1($IIlLIIL, array(I7005)); $aSubItem[I6967] =$this->cms->TTITI1l("subitem", I6967, $aSubItem); $aSubItem["announce"] =$this->cms->TTITI1l("subitem", "announce", $aSubItem); $IIlLIIL =Array(I6969=>I7006, "item_data"=>&$aSubItem); $this->TTT1lI1($IIlLIIL); $this->TIITIll($aSubItem, $aData, I7003); if(isset($aSubItem["adv_place"])){ if($IIllLII) $this->TTT111l($aSubItem, "adv", $aSubItem[I6970]); else unset($aSubItem["adv_place"]); }$aItem[I7007] .= $this->cms->TTITI1l("subitem", "row", $aSubItem); if($k >0 && $k != $numRows) {if((($k %$this->I1LIILL) == 0)) {$aItem[I7007] .= $this->cms->TTITI1l("subitem", "Vsplitter", $aItem); }elseif($k >1) {$aItem[I7007] .= $this->cms->TTITI1l(I7008, "Hsplitter", $aItem); }if($this->I1LIILl && $k%$this->I1LIILl == 0 ){$aItem[I7007] .= $this->cms->TTITI1l(I7008, "nSplitter", ""); }}}$this->options["name_field_name"] =$I1LIlIL; $aItem[I7007] =$this->cms->TTITI1l(I7008, I7009, $aItem); }}function TTTlIT1(&$aCustom, $cType ="small", $IIlLI11 ="", $IIlLlII ="_small") {$this->IlIllI1->TTTlITl($aCustom, $cType, $IIlLI11, $IIlLlII, true); $html =parent::TTTlIT1($aCustom, $cType, $IIlLI11, $IIlLlII); $this->IlIllI1->TTTlITl($aCustom, $cType, $IIlLI11, $IIlLlII, false); return $html; }function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {$I1LIlI1 =$this->module->GetOption("small_number_items"); $I1LIllI =$this->module->GetOption(I7010); $I1LIlll =$this->module->GetOption("small_number_categories"); $this->TTT11ll(); $this->TTT11ll($this->IlIllI1->catModuleName); $mode ="no_cats"; if( $this->cms->Core->IsInstalled($this->IlIllI1->catModuleName) && $this->module->issetAndTrueOption('use_categories') ){$mode ="cats_ids"; $I1LIllL =is_array($I1LIllI); if(!$I1LIllL || ($I1LIllL && sizeof($I1LIllI) == 0)) {if(empty($I1LIllI)) {if(empty($I1LIlll)) {$mode =I7011; }else {$mode ="cats_num"; }}else {$I1LIllI =Array($I1LIllI); }}}$I1LIll1 =I6932; if(!empty($I1LIlI1)) {$I1LIll1 =" LIMIT ".$I1LIlI1; }$aDefault =Array(); $aDefault["simple_set_fields"] =Array("announce"); $aCustom += $aDefault; $aDefault[I7012]["splitter_prefix"] ="small_"; $aCustom[I7012] += $aDefault[I7012]; $I1LIlLI =" ar.".$this->module->GetOption("small_items_sort_col").I6932.$this->module->GetOption("small_items_sort_dim"); if ($this->I1LII1I && ($mode == 'cats_num' || $mode == 'cats_ids')) {$I1LIlLl =in_array('at_spec_block', $this->IlIllI1->IILI1LI->GetAOption('show_urgent_elements')); $sql ="SELECT c.id AS cat_id, c.sublink AS cat_sublink, c.name AS cat_name, c.announce AS cat_announce, c.urgent " ."FROM " .$this->IlIllI1->IILLLl1 ." AS c WHERE 1". $this->_ApplyCatFilters('c', I6926, !$I1LIlLl); $I1LIlLL =I7002 .($I1LIlLl ?'c.urgent DESC, ' :I6926) .I7013.$this->module->GetOption("small_categories_sort_col").I6932.$this->module->GetOption("small_categories_sort_dim"); if($mode == "cats_num") {$sql .= $I1LIlLL." LIMIT ".$I1LIlll; }else {$sql .= I7014.implode("','", $I1LIllI)."')".$I1LIlLL; }$this->db->query($sql); $aCatIds =Array(); while($this->db->next_record()) {$aCatIds[] =$this->db->Record[I7004]; $this->II1lllI["aCats"][$this->db->Record[I7004]] =$this->db->Record; }}$I1LIlL1 =in_array('at_spec_block', $this->module->GetAOption('show_urgent_elements')); if($mode == I7011) {$aCatSql =Array(); $this->IlIllI1->TTIT1lT('small_list', $aCatSql); }$IILL1ll =$this->options["use_id_page"]; $this->options["use_id_page"] =false; switch($mode) {case I7011: $this->options['use_id_page'] =$IILL1ll; $this->browser->InitSQL(I7015 .$aCustom["sql_addon"]["select"] .", date_format(ar.date_start,'".$this->cms->DFMT[I6987]."') as date_start ".$aCatSql[I7016], "FROM " .$this->module->GetTableName() .I6988.$aCatSql["join"], I6974.$this->_ApplyFilters(I6926, I6926, !$I1LIlL1).$aCatSql["where"], "", $I1LIlLI );$this->browser->SetForceRules(I7017 .$I1LIlLI, $I1LIll1); $this->browser->AddSQLJoinedTables($this->cms->Core, 'ar', $aCatSql["tables"]); if ($I1LIlL1) {$this->browser->TI1TII1(array ('ar.urgent DESC')); }if($this->TTT11ll()) $aCustom["fields"][I7018] =Array(I6969=>"callback", "object"=>&$this, "method"=>"_GetSmallAdvCounter"); break; case I7019: case "cats_ids": $aItems =Array(); if(sizeof($aCatIds) >0) {$ILLILlL =I6991 .$aCustom["sql_addon"][I7016] .", date_format(ar.date_start,'".$this->cms->DFMT[I6987]."') as fdate "; foreach($this->options[I7020] as $fieldName) {if(!empty($fieldName) && $fieldName != I7001 && $fieldName != -222222){ $ILLILlL .= ", ar.ext_".$fieldName; }}if ($I1LIlL1) {$I1LIlLI =' ar.urgent DESC, ' .$I1LIlLI; }foreach($aCatIds as $catId) {$sql =$ILLILlL." FROM " .$this->module->GetTableName() ." AS ar INNER JOIN " .$this->IlIllI1->IILLLl1 ." AS c ON c.id=ar.id_cat WHERE ar.id_cat='".$catId."' ".$this->_ApplyFilters(I6926, I6926, !$I1LIlL1).I7002.$I1LIlLI.$I1LIll1; $this->db->query($sql); while($this->db->next_record()) {$aItems[] =$this->db->Record +$this->II1lllI["aCats"][$this->db->Record["id_cat"]]; }}}require_once $GLOBALS['CLASSES_PATH'] .'CMS_IteratorArray.php'; $I1LIl1I =true; $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray($aItems); $this->browser->InitSQL(I6970, "FROM " .$this->IlIllI1->IILLLl1 .I6932, I6974 );$this->browser->SetForceRules("", I6932); $aCustom["fields"] += Array("cat_detials" => Array(I6969=>I7021, "object"=>&$this, "method"=>"_GetSmallCatDetailsCB")); $this->II1lllI["prevCatId"] =-1; if($this->TTT11ll()) $aCustom[I7022][I7018] =Array(I6969=>I7021, "object"=>&$this, "method"=>"_GetSmallAdvCounter"); break; }$this->options["use_id_page"] =$IILL1ll; $aCustom[I7022] += Array(I6972 => Array(I6969=>I7021, I7023=>&$this, "method"=>"_GetSmallDetailsCB")); parent::TTTll1I($vRes, $aCustom, $cType, $IIlLlII); if(isset($I1LIl1I)) {$this->db =new DB_si; }}function _GetSmallDetailsCB(&$aItem, &$aData) {$aItem[I6999] =$aItem["fdate"]; $aItem[I6999] =$this->cms->TTITI1l("small", I6999, $aItem); $aItem[I7024] =$aData[I7024]; $aItem[I6967] =$this->cms->TTITI1l("small", I6967, $aItem); $aItem["more"] =$this->cms->TTITI1l("small", "more", $aItem); }function _GetSmallCatDetailsCB(&$aItem, &$aData) {if($this->II1lllI[I7025] != $aItem["id_cat"]) {$this->II1lllI[I7025] =$aItem["id_cat"]; $tmp =Array("active_item_type"=>"body_cats"); $tmp2 =Array(I6970=>$aItem[I7026], "sublink"=>$aItem["cat_sublink"]); $this->_GetNavDataCB($tmp2, $tmp); $aItem[I7024] =$aData[I7024]; $aItem["cat_nav_data"] =$tmp2["nav_data"]; $aItem[I7027] =$this->cms->TTITI1l("small", I7027, $aItem); if($this->TTT11ll($this->IlIllI1->catModuleName)){ $I1LIl1l =$this->IIllII1; $I1LIl1L =$aItem[I7018]; $this->IIllII1 =$this->IlIllI1->catModuleName; $aData["adv_counter_prefix"] ="cat_"; $aItem[I7018] =$aItem[I7026]; $this->_GetSmallAdvCounter($aItem, $aData); $aItem[I7018] =$I1LIl1L; unset($aData["adv_counter_prefix"]); $this->IIllII1 =$I1LIl1l; }}else {$aItem[I7027] =I7028; }}function TTT11IT($IILILIL) {$navData =parent::TTT11IT($IILILIL); $navData += $this->IlIllI1->TTT11IT($IILILIL); return $navData; }function correctStopArgNames($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues"){ return $this->IlIllI1->correctStopArgNames($cData, $IIL1lL1, $res, $aData, $IIL1l1I); }function TTT1II1(&$db, &$aParams) {$aVars =parent::TTT1II1($db, $aParams) +$this->IlIllI1->TTT1II1($db, $aParams); return $aVars; }function TIITlll($fileId =0) {if (!$fileId) {$sql ="SELECT `id_file` FROM " .$this->module->GetTableName() ." WHERE id = " .$this->appliedId; $fileId =intval($this->db->getValue($sql)); }if (isset($this->cms->VarsPost['delete_attachment'])) {$sql ="SELECT `filename` FROM `cms_files` WHERE id = " .$fileId; if ($fileName =$this->db->getValue($sql)) {$sql ="DELETE FROM `cms_files` WHERE id = " .$fileId; $this->db->execute($sql); $sql =$this->db->genUpdateSQL($this->module->GetTableName(), array ('id_file' => 0), "WHERE id = " .$this->appliedId); $this->db->execute($sql); @unlink($GLOBALS[I7029] .$this->I1Lllll->GetOption('files_path') .$fileName); }}elseif (isset($_FILES[I7030]['tmp_name']) && is_uploaded_file($fileName =$_FILES[I7030]['tmp_name']) && ($this->side == 'front' ?$this->module->GetOption('front_allow_attach') :true) ){$fileSize =@filesize($fileName); if ($fileSize >0) {if ($fileSize <= $this->module->GetOption(I7031)) {$originalFileName =$_FILES[I7030][I6979]; $extension =mb_strtolower(mb_substr(strrchr($originalFileName, '.'), 1)); $found =false; foreach ($this->module->GetOption('forbidden_attachment_extensions') as $ext) {if ($ext == $extension) {$found =true; break; }}if ($found) {$this->cms->AddStatusMsg('warn_forbidden_file_extension', 'red'); }else {$sql ="SELECT id FROM `cms_ftypes` WHERE concat(';', extensions) LIKE '%;" .addslashes($extension) .";%'"; $fileType =intval($this->db->getValue($sql)); $aSQL =array ('ftype' => $fileType, I6979 => $originalFileName, 'cdate' => '=|NOW()', I7032 => '=|NOW()', I7033 => 'files', 'lang' => $this->langData );if ($fileId) {$this->cms->VarsPost['delete_attachment'] =1; $this->TIITlll($fileId); }$sql =$this->db->genInsertSQL(I7034, $aSQL); $this->db->execute($sql); $fileId =$this->db->lastInsertId(); $newFileName =$this->moduleName .'_' .$fileId .'_' .$originalFileName .$this->I1Lllll->GetOption('extension'); $newFileName =$this->cms->TTITI11(stripslashes($newFileName)); if ($this->cms->doUploadFile( $_FILES[I7030], $GLOBALS[I7029] .$this->I1Lllll->GetOption('files_path') .$newFileName) ){$aSQL =array (I7035 => addslashes($newFileName), 'filesize' => $fileSize, 'original_fname' => $originalFileName );$sql =$this->db->genUpdateSQL( I7034, $aSQL, "WHERE id = " .$fileId );$this->db->execute($sql); $aSQL =array ('id_file' => $fileId); $sql =$this->db->genUpdateSQL( $this->module->GetTableName(), $aSQL, I7036 .$this->appliedId );$this->db->execute($sql); }else {$this->cms->AddStatusMsg('warn_attachment_failed', 'red'); }}}else {$this->cms->AddStatusMsg('warn_attachment_size', 'red', I6926, I6926, array (I7037 => getBytesAsText($this->module->GetOption(I7031), $this->words, 1) ));}}}}function TITTl1T() {$aRes =array ();$aRes['enabled'] =$this->module->IssetOption('item_pictures') ?$this->module->GetAOption('item_pictures') :array ();$aRes['disabled'] =array_diff(array (I7038, 'popup_picture', 'small_picture'), $aRes['enabled']); return $aRes; }function TTT1ITI($cId, $cModule) {$langFile =$this->cms->Gui->ParseLangFile('templates/lang/_' .$this->moduleName .I7039); $this->cms->AddMessages($langFile); if (!$this->module->GetOption('front_allow_to_add') || !($this->II11ll1 || !$this->module->GetOption('front_allow_to_add_registered_only')) ){$this->cms->AddStatusMsg('status_not_allowed_to_add_from_front', 'red'); return; }if (empty($this->cms->VarsPost[I6929]) || empty($this->cms->VarsPost[I6952]) || ($this->I1LII1I ?empty($this->cms->VarsPost[I6996]) :false) || ($this->II11ll1 ?false :empty($this->cms->VarsPost[I6994])) ){$this->cms->AddStatusMsg(I7040, 'red'); return; }if ($this->I1LII1I) {$categoryId =intval($this->cms->VarsPost[I6996]); $sql ="SELECT 1 FROM cms_classifieds_cat c WHERE id = " .$categoryId .$this->_ApplyCatFilters('c', I6960, false); if (!$this->db->getValue($sql)) {$this->cms->AddStatusMsg(I7040, 'red'); return; }}else {$categoryId =0; }$public =$this->cms->VarsPost[I6948] =intval($this->module->GetOption('front_add_as_published')); if ($this->II11ll1) {$this->cms->VarsPost[I6994] =$this->IlIlLIL['username']; }$this->cms->VarsPost['id_cat'] =$categoryId; $this->cms->Vars['skip_cats'] =true; $this->cms->VarsPost[I6952] =nl2br($this->cms->htmlchars($this->cms->VarsPost[I6952])); $I1Lll1L =intval($this->cms->VarsPost[I6977]); $I1Lll1L =$this->I1Llll1[isset($this->I1Llll1[$I1Lll1L]) ?$I1Lll1L :0]; $time =time(); $this->cms->VarsPost['date_start'] =date($this->cms->DFMT[I7041], $time); $this->cms->VarsPost[I6993] =date($this->cms->DFMT["php"], strtotime($I1Lll1L, $time)); $action =$this->action; $ILLLILI =$this->cms->Gui->debug; $this->action ='add'; $this->cms->Gui->debug =array ();$this->cms->PushFrontSettings($this->db, $this->langData); require_once $GLOBALS['CLASSES_PATH'] .'Admin.php'; $adm =new Admin($this->cms->Core); $adm->constructorPostActions(); $adm->InitFromObject($this->cms, $this->module); $cms =clone($this->cms); $this->cms =&$adm; $this->cms->Messages =$cms->Messages; $this->cms->Messages[I7042] =$cms->Messages[$public ?I7042 :'status_add_after_moderation']; $this->cms->SuppressStatusErrors =true; $this->realSide ='front'; $this->_InitAdmin(); if ($this->module->issetAndTrueProperty('support_rights')){ $I1Lll11 =1; $this->module->SetProperty('support_rights', false); }$this->TTTll11(0, $cModule); if (isset($I1Lll11)) {$this->module->SetProperty(I7043, true); }$I1LlLII =$adm->SysStatusMsgs; $I1LlLIl =$adm->StatusMsgs; $this->cms =&$cms; $this->cms->PopFrontSettings($this->db, $this->langData); $this->forceRedirect =true; $this->cms->VarsGet =array ('status_msg' => serialize(array ('sys' => $I1LlLII, 'plain' => $I1LlLIl))); $this->cms->ActiveScript =preg_replace('/\&_id\=\d+/', I6926, $GLOBALS[I7044]['script_full_link']); if ($this->appliedId) {$this->IIlll1L ='&_id=' .$this->appliedId; }$this->cms->Gui->debug =$ILLLILI; }function TIITll1($aSQL){ $senderEmail =$this->TTI1TTl(); if(empty($senderEmail)){ return; }$IlI1LL1 =I6926; if($this->realSide == 'admin'){ if($this->module->GetOption('notify_author_when_published')){ $IlI1LL1 =$aSQL[I7045]; }}elseif($this->module->GetOption('notify_admin_on_submission')){ $IlI1LL1 =$this->module->GetOption('noticiation_email'); }if(empty($IlI1LL1)){ return; }$this->cms->Gui->addBlock('_classifieds_email', '_local/_admin/templates/letters/classifieds_mail.tpl'); $html =I6926; if ($aSQL[I6978]) {$customFields =unserialize(stripslashes($aSQL[I6978])); $captions =$this->cms->Gui->ParseLangFile($GLOBALS['LOCAL_FILES_REL_PATH'] .'_admin/templates/lang/options/classifieds_rules_values.lng'); foreach ($customFields as $name => $value) {$html .= $this->cms->Gui->getAbs('_classifieds_email:custom_field', array (I6942 => $captions[$name], I6953 => unhtmlentities(stripslashes($value)) ));}}$mailData =array ('site_path' => preg_replace(array ('/^\w+\:\/\//', I7046), I6926, $GLOBALS[I6981]), 'link' => $GLOBALS[I6981] .$this->module->GetFrontLink(), I6994 => removeSpecial($aSQL[I6994]), I7045 => removeSpecial($aSQL[I7045]), I6929 => unhtmlentities($aSQL[I6929]), I6978 => $html, 'body' => removeSpecial(str_replace('<br />', I6926, $this->cms->VarsPost[I6952])) );if ($this->I1LII1I) {$mailData += array ('id_cat' => $aSQL[I7047], 'section_link' => $aSQL['cat_sublink'], 'cat_name' => unhtmlentities($aSQL['cat_name']) );}require_once $GLOBALS[I7048] .'Mailer.php'; $tpl =$this->realSide == 'front' ?'admin' :'front'; $oMail =new Mailer(); $oMail->SenderAddress =$senderEmail; $oMail->Subject =$this->cms->Gui->get('_classifieds_email:' .$tpl .'_subject', $mailData); $oMail->Body =trim($this->cms->Gui->get('_classifieds_email:' .$tpl .'_body', $mailData)); $oMail->CopyAddress =I6926; $oMail->BodyFormat ='plain'; $oMail->Prepare(); $oMail->RecipientAddress =$IlI1LL1; $oMail->Send(); }function TTI1TTl() {static $domain; if ($this->cms->Core->HostMode() &HOSTMODE_SHARED) {if (!isset($domain)) {$domain =parse_url($GLOBALS[I6981]); $domain =mb_strtolower($domain[I7049]); if (mb_substr_count ($domain, '.') >1) {$domain =preg_replace('/^www[^\.]*\./', I6926, $domain); }}$senderEmail =$this->module->getOption('from_mbox') .'@' .$domain; }else {$senderEmail =$this->cms->Core->GetOption('company_robot_email'); }return $senderEmail; }function TIITl1T($force =false) {$sql ="SELECT MIN(`date_end`) " ."FROM " .$this->module->GetTableName() .I6932 ."WHERE `lang` = '" .$this->langData ."' AND `public` = 1 AND `date_end` >= NOW()"; $value =$this->db->getValue($sql); if ($value) {$this->cms->Core->Cache->SetForceExpireTime($this->module->GetName(), strtotime($value)); }elseif ($force) {$this->cms->Core->Cache->ClearAdd($this->module->GetName()); $this->cms->Core->Cache->ClearCacheNow(); }}function TTT1TTI(&$IIl1ll1, $prefix) {if ($this->I1LII1I) {$IIl1ll1[I7050] .= ", id_cat"; }}function TTT1TTl(&$record) {if ($this->I1LII1I) {$this->IlIllI1->catId =$record[I7047]; }}}class CategoriesFunctionsClassifieds extends CMS_CategoriesFunctions {public $I1LI1Ll =false; function CategoriesFunctionsClassifieds(&$cms, &$oModule, $IILL11I) {parent::CMS_CategoriesFunctions($cms, $oModule, $IILL11I); $this->I1LI1Ll =$this->cms->Core->GetModOption($IILL11I, 'show_counters'); }function _GetCategoryCB(&$aItem, &$aData) {if ($this->I1LI1Ll) {$sql ="SELECT COUNT(1) " ."FROM " .$this->IILLLLI .I6932 .I7051 .$aItem['id'] ." AND `public` = 1 AND NOW() BETWEEN `date_start` AND `date_end`"; $aItem['num_items'] =intval($this->module->db->getValue($sql)); $aItem['num_items'] =$this->cms->TTITI1l(I7052, 'num_items', $aItem); $aItem['cat_counter'] =$this->cms->TTITI1l(I7052, 'counter', $aItem); }parent::_GetCategoryCB($aItem, $aData); }function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); return $this->catId == $this->IILLLLl ?null :$this->IILLLLl; }}