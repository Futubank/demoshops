<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       72484 xkqwztqsztkmxwxprlgwpsgrpzuyyixmkkuuptwsiurrssnstxqilnksmiktnitkxuugpnir
 */ ?><?php foreach(array(7056=>'ZSIMn',7057=>'SQJ',7058=>'Qxt|IHSuJQ',7059=>'MS|Qxt|IHSuJQ',7060=>'IHSuJQD',7061=>'smdgjzb|ihsUjq|whj',7062=>'mN|ToRqzs',7063=>'JQP|GHDt|IQDDZPQ',7064=>'OMSSQn',7065=>'',7066=>'SQfZuJt|GrQfMx',7067=>"Qxt|IHSuJQ?mN?}'",7068=>'SZtQfrHI',7069=>'DKMG|IHSuJQ|fMJtQr',7070=>'?zNs?',7071=>'YuttHnD',7072=>'GrQvMQC',7073=>'DZvQ',7074=>'MS|GZrQnt',7075=>"dqjqwT?.MS.?FRhi?.WID|SMDWuDDMHn.?coqRq?.MS|Qxt|IHSuJQ.?=?",7076=>"dqjqwT?.IDP|MS.?FRhi?.WID|SMDWuDDMHn.?coqRq?.MS|Qxt|IHSuJQ.?=?",7077=>'fHrI|SZtZ',7078=>'|JMDt%GZtO|IHSuJQ',7079=>'IHSuJQ',7080=>"dqjqwT?.MS.!?.IQDDZPQ.!?.MS|Qxt|IHSuJQ.?FRhi?.WID|SMDWuDDMHn.?",7081=>"coqRq?.MS|Qxt|IHSuJQ.?=?",7082=>'|JMDt%GZtO|OQZSQr',7083=>'GZtO',7084=>"",7085=>'SS',7086=>'SS_S',7087=>"S`SZtQ?SQDW",7088=>'HrSQr|DEJ',7089=>"[",7090=>'fJZPMWHn',7091=>'|JMDt%GuYJMW|Hn',7092=>'DtrMGJMnQ',7093=>'Hn',7094=>'vZJuQ',7095=>'ZWtMHn|rQGJB',7096=>'Hff',7097=>'|JMDt%QSMt',7098=>'|JMDt%SQJ',7099=>'WZJJYZWK',7100=>'S`MS',7101=>'Qxt|IHSuJQ|WZGtMHn',7102=>'ZWtMHn',7103=>'MG',7104=>'ZutOHr',7105=>'truQ',7106=>'JQP|BQJJHC',7107=>'WZnWQJ',7108=>'ZWtMHn|SQJ',7109=>'IQDDZPQ',7110=>'rQGJB',7111=>'ZSS',7112=>'QSMt',7113=>'SZtQ',7114=>'RqihTq|zssR',7115=>".IDP|MS.!?.MS|IQIYQr.?.IDP|MS|IQIYQr.!?.ZutOHr.?.IDP|ZutOHr.!?.SZtQ.?.IDP|SZtQ.!?.Qxt|IHSuJQ.?",7116=>"coqRq?.MS.?=?",7117=>'ZJJ',7118=>'MS',7119=>'GOG|StMIQ',7120=>'|rHHt|MS',7121=>'.MS|Qxt|IHSuJQ.?=?',7122=>".Qxt|IHSuJQ.?=?'",7123=>'JZnP|SZtZ',7124=>'GuYJMDO',7125=>"?zNs?.Qxt|IHSuJQ.?=?'",7126=>'IDP|ZutOHr',7127=>"dqjqwT?.MS.?.IDP|MS.!?.MS|IQIYQr.?.IDP|MS|IQIYQr.!?.ZutOHr.?.IDP|ZutOHr.!?.Qxt|IHSuJQ.?",7128=>"'?zNs?.Qxt|IHSuJQ.?=?'",7129=>"'?zNs?.MS|Qxt|IHSuJQ.?=?",7130=>"?zNs?.JZnP.?=?'",7131=>'WHuntQrD',7132=>"dqjqwT?.MS|Qxt|IHSuJQ.!?.Qxt|IHSuJQ.!?izX}.SZtQ.{?.IDP|SZtQ.!?whUNT}.MS.{?.WHunt|WOMJSrQn.!?dUi}.GuYJMW.{?.WHunt|GuYJMW|WOMJSrQn.?",7133=>"coqRq?.Qxt|IHSuJQ.?=?'",7134=>"?pRhUg?yb?.MS|Qxt|IHSuJQ.",7135=>".MS|Qxt|IHSuJQ.?=?",7136=>"?zNs?",7137=>'YHSB|fHrI',7138=>'MS|IQIYQr',7139=>'I`',7140=>"S`[!?",7141=>'WID|IQIYQrD',7142=>'S_I',7143=>"coqRq?S`.MS|Qxt|IHSuJQ.?=?",7144=>"?zNs?S`.Qxt|IHSuJQ.?=?'",7145=>'S',7146=>'rHCD',7147=>'JMDt|SZtZ',7148=>'fMQJSD',7149=>'OtIJ',7150=>'fZJDQ',7151=>'CZtWO|WHIIQntD',7152=>'fHrI',7153=>'RhhT|gzTo|ccc',7154=>' ',7155=>'trQQ|JQvQJ',7156=>'IQIYQrD',7157=>'uDQr|MS',7158=>'|JMDt%MtQI|ZutOHr',7159=>'Qnv~DQDDMHn',7160=>'DtZtuD|QrrHr',7161=>'GHDtQS|YY|WHSQ',7162=>"'?",7163=>'DHurWQ|ZGG|MS',7164=>'WHunt|WOMJSrQn',7165=>'WID|SMDWuDDMHn',7166=>'!',7167=>'=_Nhc}{',7168=>'JZDt|IDP|MS',7169=>'CZtWOQr|QIZMJ',7170=>'?#',7171=>'`JnP',7172=>'JMnK',7173=>'DMtQ|GZtO',7174=>'wjzddqd|gzTo',7175=>'QIZMJ',7176=>"coqRq?D`.MS|Qxt|IHSuJQ.?=?",7177=>"?zNs?D`.Qxt|IHSuJQ.?=?'",7178=>'@',7179=>'|SMDWuDDMHn|QIZMJ',7180=>'CCC|rHHt',7181=>'IQDDZPQ|DWrZG',7182=>'DuYLQWt',7183=>'wid|iZMJeuQuQ`GOG',7184=>'KQB',7185=>'fHruI|Qxt') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleDiscussion extends CMS_Discussion {public $fltExtModuleId; public $fltExtModule; public $I1LlLIL; public $IIL1llI; public $I1LlLI1; public $I1LlLlI; public $I1LlLll; public $_popup; public $I1LlLlL; public $I1LlLl1; public $I1LlLLI; protected $parentId =0; protected $I1LlLLl =0; protected $I1LlLLL =FALSE; private $I1LlLL1 =array(); function ModuleDiscussion(&$cms, &$db, &$cModule) {parent::CMS_Forum($cms, $db, $cModule); }function _Init($IIll1l1 =array (),$IIll1LI ='', $IIll1Ll ='', $aOptions =array ()){if ($this->side == I7056) {$this->module->SetOption('sys_user_as_administration', $this->cms->Core->GetModOption('ext_discussion')); }$IIIIL11 =array ('name_field_name' => 'message', 'announce_field_name' => 'message', 'group_operations' => array ('publish_on', 'publish_off', I7057), 'default_prefix' => 'd' );$aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->I1LlLll =0; }function _InitAdmin() {global $CLASSES_PATH; parent::_InitAdmin(); $this->fltExtModule =isset($this->cms->Vars[I7058]) ?$this->cms->Vars[I7058] :null; if ($this->fltExtModule && $this->cms->Core->IsInstalled($this->fltExtModule)) {$this->II11IL1 =$this->cms->Core->TTlI1T1($this->fltExtModule, 'use_tree_view'); }$this->fltExtModuleId =isset($this->cms->Vars[I7059]) ?intval($this->cms->Vars[I7059]) :0; $this->I1LlLlI =array ();AMI::addResourceMapping(require($CLASSES_PATH .'60/resourceMapping.60.php')); $this->I1LlLI1 =array_keys(AMI::getSingleton('ext_disucssion/service')->getAllowedModules()); $aMods =array_keys($this->I1LlLI1); foreach ($aMods as $index => $name) {$name =$this->I1LlLI1[$index]; if ($this->cms->Core->IsInstalled($name)) {$aCaption =array ();$tmpMod =&$this->cms->Core->GetModule($name); if ($this->fltExtModuleId && $this->fltExtModule == $name) {$this->cms->Gui->AddGlobalVars(array ('element_admin_link' => $tmpMod->GetAdminLink())); }$ownerName =$tmpMod->GetOwnerName(); if (!in_array($ownerName, array (I7060, 'core'))) {$ownerData =$this->cms->Core->OwnerGetData($ownerName); $aCaption[] =$ownerData['admin_menu_caption']; }$aCaption[] =$this->cms->GetModHeader($tmpMod); while ($tmpMod->HaveParent()) {$tmpMod =&$tmpMod->TTlIIIT(); $aCaption[] =$this->cms->GetModHeader($tmpMod); }$this->I1LlLlI[$name] =implode(' :: ', $aCaption); }else {unset($this->I1LlLI1[$index]); }}$this->cms->Gui->AddGlobalVars(array (I7061 => empty($this->fltExtModule), I7062 => (boolean)$this->fltExtModuleId, ));if (!$this->fltExtModuleId) {$this->options['group_operations'] =array (I7057); }}function TTTlTI1() {parent::TTTlTI1(); $this->I1LlLl1 =$this->module->issetOption('watch_comments') && $this->module->GetOption('watch_comments') && (sizeof($this->IlIlLIL) && empty($this->IlIlLIL['email']) ?false :true); }function TTT11Tl(&$IILILII) {if ($this->side == I7056 && !$this->fltExtModuleId) {$IILILII =array (I7063, 'leg_del'); }}function TTTlIII($II11l1L =TRUE) {parent::TTTlIII(); $this->_popup =!empty($this->cms->Vars['popup']) && !empty($this->cms->Vars[I7058]) && !empty($this->cms->Vars[I7059]); if ($this->_popup) {$this->filter->AddField('popup', 'hidden', 1, 1); $this->filter->AddField(I7058, I7064, $this->cms->Vars[I7058], '', ' = ', $this->options['default_prefix'] .I7058); }else {$aModules =array ();foreach ($this->I1LlLlI as $name => $caption) {$aModules =$this->filter->TITI1TT($aModules, array ($caption => $name), 45, false); }$aModules =$this->filter->TITI1TT($aModules, array ($this->cms->Words['all'] => I7065), 45, false); $this->filter->AddField(I7058, 'select', isset($this->cms->Vars[I7058]) ?$this->cms->Vars[I7058] :null, I7065, '=', $this->options['default_prefix'] .I7058, $aModules); $this->filter->MoveField(I7058, _MOVE_START); if(empty($this->cms->Vars[I7058])){ $this->filter->TITI1II(I7058, " OR " .$this->options[I7066].I7067 .implode("','", $this->I1LlLI1) ."')" );}elseif($this->fltExtModule == I7065){ $this->filter->DisableFieldSql(I7058); }}$this->filter->AddField(I7059, I7064, $this->fltExtModuleId, 0, ' = ', $this->options[I7066] .I7059); $this->II11llL =(boolean)$this->fltExtModuleId; if ($this->fltExtModuleId) {parent::TTTlIII(false); }else {$this->filter->DisableFieldSQL(I7059); }$this->filter->AddField('flt_reset_parent', I7064, 0); $this->filter->UpdateFieldDBName(I7068, $this->options[I7066] .'date'); $this->filter->UpdateFieldDBName('dateto', $this->options[I7066] .'date'); }function _ApplyFilters($prefix =I7065, $bodyType =I7065, $IIlLLl1 =true) {$res =I7065; if ($bodyType != I7069) {$p =empty($prefix) ?I7065 :$prefix .'.'; $res =I7070 .$p .'`id_parent` ' .($this->fltExtModuleId ?'!' :I7065) .'= 0'; }$res .= parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); return $res; }function TTTlI11(&$vData, &$aCustom) {$aCustom['form_data'][I7071] =array ('add', 'apply', 'cancel', 'save', I7072); $this->cms->Gui->AddGlobalVars(array ('POPUP_MODE' => $this->_popup)); if ($this->fltExtModuleId && !in_array($this->cms->Vars['action'], array ('quote', 'reply', I7073, 'edit'))) {$this->cms->Vars['action'] =$this->action ='edit'; if (empty($this->I1LlLlL)) {if($this->II11lLI){ $parentId =(int)$this->cms->Vars['flt_id_parent']; if(!$parentId && isset($this->cms->Vars[I7074])){ $parentId =(int)$this->cms->Vars[I7074]; }$sql =I7075 .$this->fltExtModuleId ." AND `id_parent` = " .$parentId ." ORDER BY `id` DESC LIMIT 1"; if(!$parentId){ $id =$this->db->getValue($sql); $sql =I7075 .$this->fltExtModuleId ." AND `id_parent` = " .$id ." ORDER BY `id` DESC LIMIT 1"; }}else{ $sql =I7076 .$this->fltExtModuleId ." AND `id_parent` = 0 LIMIT 1"; }$id =$this->db->getValue($sql); }else {$id =$this->I1LlLlL; $this->cms->Vars['flt_reset_parent'] =0; }if ($id) {if($this->II11l1l){ unset($aCustom['form_data'][I7071][array_search('cancel', $aCustom['form_data'][I7071])]); }else{ $this->TTTl1Tl($id, I7065); unset($aCustom[I7077][I7071][array_search('add', $aCustom[I7077][I7071])]); $vData['use_action_apply'] =1; if (is_array($this->itemData)) {$vData =array_merge($vData, $this->itemData); }}}$vData[I7059] =$this->fltExtModuleId; }$path =array ();if ($this->fltExtModule) {$path[] =$this->cms->Gui->getAbs($this->moduleName .I7078, array (I7079 => $this->fltExtModule, 'caption' => $this->I1LlLlI[$this->fltExtModule] ));if ($this->fltExtModuleId) {$sql =I7080 .I7081 .$this->fltExtModuleId ." AND `id_parent` = 0"; if ($row =$this->db->getRecord($sql)) {$path[] =$this->cms->Gui->get($this->moduleName .I7082, $row); }}$aCustom['list_data']['path'] =implode($this->cms->Gui->getAbs($this->moduleName .'_list:path_splitter', I7065), $path); }else {$aCustom['list_data'][I7083] =I7065; }$II11L1I =$this->fltExtModuleId ?$this->cms->DFMT['db_dtime'] :str_replace(':%s', I7065, $this->cms->DFMT['db_dtime']); if ($this->fltExtModuleId) {$this->browser->InitSQL( "d.*, DATE_FORMAT(d.date, '" .$II11L1I ."') AS fdate, DATE_FORMAT(d.msg_date, '" .$II11L1I ."') AS fmsg_date", 'FROM `cms_discussion` d', "WHERE 1 ".$this->_ApplyFilters('d').$this->TTTlIl1(), I7084, "name", "d.date desc" );$this->browser->AddSQLJoinedTables($this->cms->Core, 'd', array ('dd' => $this->module->GetTableName())); }else {$this->browser->InitSQL( "d.*, DATE_FORMAT(d.date, '" .$II11L1I ."') AS fdate, DATE_FORMAT(d.msg_date, '" .$II11L1I ."') AS fmsg_date, dd.message last_message", array ('tables' => array ('d' => $this->module->GetTableName(), I7085 => $this->module->GetTableName() ),'joins' => array ('dd|d' => 'dd.id = d.msg_id'), 'joins_types' => array (I7086 => 'LEFT OUTER') ),"WHERE 1 ".$this->_ApplyFilters('d').$this->TTTlIl1(), I7084, "name", I7087 );$this->browser->AddSQLJoinedTables($this->cms->Core, 'd', array (I7085 => $this->module->GetTableName())); }if ($this->fltExtModuleId && $this->II11IL1) {if ($this->id) {$id =$this->id; }else {$sql ="SELECT id FROM `cms_discussion` d WHERE 1 " .$this->_ApplyFilters().$this->TTTlIl1() ." LIMIT 1"; $id =intval($this->db->getValue($sql)); }$this->TTIlTlI($id); if (!$this->II11I11) {$this->II11I11 =$id; }$vData['_ROOT_ID'] =$this->II11I11; if ($this->TTIlIIT($this->II11I11)) {$this->II11lI1 =$this->browser->SQLData[I7088]; $res =$this->TTIlIII($this->II11I11, I7065); }else {$res =array ('rows' => array ());}$db =clone($this->db); require_once $GLOBALS['CLASSES_PATH'] .'CMS_IteratorArray.php'; $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray($res['rows']); $this->db->IlI1Lll =$this->II11llI; $this->db->IIIll1L =false; $this->browser->lll1IIL =false; $this->browser->InitSQL(I7089, "FROM xxx", "WHERE 1"); }$aFields =array ('public' => array ('action' => I7090, 'value' => 1, 'id' => 'pub_id', 'on' => $this->moduleName .I7091, 'off' => $this->moduleName .'_list:public_off') );if ($this->fltExtModuleId) {$aFields += array ('author' => array ('action' => I7092, 'size' => 35), );}else {$aFields += array ('topic' => array ('action' => I7092, 'size' => 145), );}$aFields += array ('action_post_message' => array ('action' => I7090, 'value' => I7065, 'id' => 'reply_id', I7093 => $this->moduleName .'_list:post_message', 'off' => I7065), 'action_quote' => array ('action' => I7090, I7094 => I7065, 'id' => 'quote_id', I7093 => $this->moduleName .'_list:quote', 'off' => I7065), I7095 => array ('action' => I7090, I7094 => I7065, 'id' => 'reply_id', I7093 => $this->moduleName .'_list:reply', I7096 => I7065), 'action_edit' => array ('action' => I7090, I7094 => I7065, 'id' => 'edit_id', I7093 => $this->moduleName .I7097, I7096 => I7065), 'action_del' => array ('action' => I7090, I7094 => I7065, 'id' => 'del_id', I7093 => $this->moduleName .I7098, I7096 => I7065) );$aCustom['fields'] += $aFields; $aCustom['fields']['bold'] =array ('action' => I7099, 'object' => &$this, 'method' => '_GetAdminItemCB'); $aCustom['applied_id'] =I7100; if (sizeof($this->itemData)) {if($this->II11lLI){ $this->cms->Vars['id'] =$this->I1LlLLl ?$this->I1LlLLl :$this->itemData['id']; }$vData[I7074] =$this->itemData[I7074]; $vData[I7058] =$this->itemData[I7058]; $vData[I7101] =$this->I1LlLlI[$this->itemData[I7058]]; if($this->II11l1I){ $vData['id'] =$this->itemData['id']; }if ($this->cms->Vars[I7102] == 'quote' || $this->cms->Vars[I7102] == 'reply') {$vData['fdate'] =date($this->cms->DFMT['php_dtime']); }}else {if($this->parentId){ $vData[I7074] =$this->parentId; }$vData[I7103] =getenv('REMOTE_ADDR'); $this->itemData['id_member'] =$vData['id_member'] =$this->IlIlLIL['id']; $vData[I7104] =$this->TTI1TII(); $vData['fdate'] =date($this->cms->DFMT['php_dtime']); }$vData['noindex_external_links'] =$this->module->GetOption('noindex_external_links') ?I7105 :'false'; $aCustom['legend'] =array ('published', 'notpublished', I7106, 'leg_blue', 'leg_reply', 'leg_edit', 'leg_del'); if($this->II11lL1){ $vData[I7107] ='disabled'; }parent::TTTlI11($vData, $aCustom); if (isset($db)) {$this->db =$db; }}function _GetAdminItemCB(&$aItem, &$aData) {foreach (array (I7104, 'msg_author') as $k) {if (isset($aItem[$k])) {$this->TTI1TIl($aItem[$k]); }}$this->TTIl11l($aItem); if (empty($this->fltExtModule)) {$aItem[I7101] =$this->I1LlLlI[$aItem[I7058]]; }if (empty($this->fltExtModuleId)) {$aItem['last_message'] =$this->cms->stripLine(TlTllI1($aItem['last_message']), 1024); $aItem[I7108] =$this->cms->Gui->get($this->moduleName .'_list:action_del', $aItem); }else if ($aItem['count_children']) {$aItem[I7108] =$this->cms->Gui->get($this->moduleName .'_list:action_del_with_children', $aItem); }$aItem['message'] =$this->cms->stripLine(TlTllI1($aItem[I7109]), 1024); if (!empty($aItem['tree_level'])) {$aItem[I7109] =str_repeat('&nbsp; ', $aItem['tree_level']) .$aItem[I7109]; }}function TTTlITT($IIIL11l, $cId, $cModule =I7065) {$I1LlL1I =$IIIL11l; $this->TTIlTlI($cId); switch ($this->side) {case I7056: if ($cId >0) {$this->TTIl111($cId); switch ($IIIL11l) {case 'quote': case I7110: $this->TTIlIlI($IIIL11l, $cId); break; }}else if ($this->fltExtModuleId) {$this->I1LlLll =$this->fltExtModuleId; }break; }if ($cId >0) {switch ($IIIL11l) {case 'update_member': $this->TTI1TTT($cId); break; case 'delete_member': $this->TTI1TTI($cId); break; }}parent::TTTlITT($IIIL11l, $cId, $cModule); if( $this->II11l1l || !$this->II11lLl || $this->side !== I7056 || ($I1LlL1I === I7110 && $this->cms->Vars[I7102] === I7110) ){return; }$parentId =(int)$this->cms->Vars['flt_id_parent']; $I1LlL1l =FALSE; switch($IIIL11l){ case 'none': case I7111: case 'apply': if($IIIL11l === 'apply' && $this->cms->Vars[I7102] !== 'apply'){ break; }$cId =$parentId; $IIIL11l =I7110; $mode ='ADD'; $this->II11lL1 =TRUE; $this->II11l1I =$this->cms->Vars[I7102] === I7073; $I1LlL1l =TRUE; break; case I7112: $IIIL11l =I7110; $mode ='EDIT'; $this->II11l1I =TRUE; $I1LlL1l =TRUE; break; }if($I1LlL1l){ $this->II11l1l =TRUE; $this->TTIlIlI($IIIL11l, $cId); $this->TTTl1Tl($cId, $cModule); $this->cms->Gui->addGlobalVars(array('FORM_MODE' => $mode)); }}function TTT1IlI($aSql =array (),$cId =0) {require_once $GLOBALS['FUNC_INCLUDES_PATH'] .'func_convert.php'; if ($cId) {$sql ="SELECT `public` FROM `cms_discussion` WHERE `id` = " .$cId; $this->IlIlLIl =$this->db->getValue($sql); }$extModule =$this->cms->VarsPost[I7058]; $message =$this->cms->VarsPost[I7109]; $this->I1LlLll =intval($this->cms->VarsPost[I7059]); $this->_public =intval($this->cms->VarsPost['public']); if (!empty($this->I1LlLll) && !empty($extModule) && !empty($message)) {$message =removeSpecial($message, 'slashes'); $this->TTI1TIT($message, $this->cms->Core->GetModOption($extModule), (bool)sizeof($this->IlIlLIL)); $aSql =array (I7109 => addslashes(TlTllIl($this->cms->htmlchars($message), true, $this->module->GetOption('noindex_external_links'), $this->IlIlLlI)), I7059 => $this->I1LlLll, I7058 => $extModule, I7074 => intval($this->cms->VarsPost[I7074]) );if (!empty($this->cms->VarsPost[I7104])) {$aSql[I7104] =$this->cms->VarsPost[I7104]; }$aSql[empty($this->cms->VarsPost['id']) ?I7113 :'modified_date'] ='=|NOW()'; if ($this->action == I7111) {$aSql['public'] =$this->_public; $aSql[I7103] ="=|INET_ATON('" .getenv(I7114) ."')"; if (!empty($this->cms->VarsPost['id_member'])) {$aSql['id_member'] =intval($this->cms->VarsPost['id_member']); }}}$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); if (empty($this->errno) && $this->appliedId >0) {if ($this->_public) {$sql ="SELECT `id_parent`, " .$this->appliedId .I7115 ."FROM `cms_discussion` " ."WHERE `id` = " .$this->appliedId; if ($aSQL =$this->db->getRecord($sql)) {$parentId =intval($aSQL[I7074]); $this->clearFrontCache($aSQL[I7058]); unset($aSQL[I7074], $aSQL[I7058]); $limit =1000; do {$I1LlL1L =$parentId; $sql ="SELECT `id_parent` FROM `cms_discussion` WHERE `id` = " .$parentId; $parentId =intval($this->db->getValue($sql)); }while ($parentId >0 && --$limit >0); if ($limit >0) {$sql =$this->db->genUpdateSQL('cms_discussion', $aSQL, I7116 .$I1LlL1L); $this->db->execute($sql); }else {trigger_error('Message nesting is greater than ' .$limit); }}$this->TTI1Tl1($this->IlIlLIL['id'], 1); }$this->TTIlT1I('+1', $this->_public ?'both' :I7117); if (isset($this->cms->VarsPost['is_reply'])) {$this->I1LlLlL =$this->appliedId; AMI_Registry::set('PAM_no_appliedId_needed', true); }}}function TTTl1lI($cId, $cModule) {$aItem =$this->TTIlT1T($cId); $this->cms->VarsPost[I7113] =date($this->cms->DFMT['php_dtime'], strtotime($aItem[I7113])); parent::TTTl1lI($cId, $cModule); if (empty($this->errno) && $this->appliedId >0) {$this->TTIlITI($aItem, intval(isset($this->cms->VarsPost['public']))); $this->clearFrontCache($aItem[I7058]); $this->TIITl1l(); $this->cms->Vars[I7118] =$this->appliedId; AMI_Registry::set('PAM_no_appliedId_needed', true); }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $cId =intval($cId); $sql ="SELECT d.*, DATE_FORMAT(d.date, '" .$this->cms->DFMT["db_dtime"] ."') AS fdate, ". "IF(d.public > 0, 'checked', '') `public`, INET_NTOA(`ip`) `ip` " ."FROM `cms_discussion` AS d " ."WHERE d.id = " .$cId .$this->_ApplyFilters(I7065, empty($this->cms->Vars['flt_reset_parent']) ?I7065 :I7069); $this->db->query($sql); if ($this->itemData =$this->db->nextRecord()) {$I1LlL11 =$this->cms->Vars[I7102] == 'quote' || $this->cms->Vars[I7102] == I7110; if($I1LlL11 || $this->II11l1l){ $this->itemData[I7113] =date($this->cms->DFMT[I7119]); $this->itemData[I7109] =$I1LlL11 || $this->II11lLL ?'[Q="' .$this->itemData[I7104] .'"]' .TlITI1l($this->itemData[I7109], true) .'[/Q]' :TlITI1l($this->itemData[I7109], true); if (empty($this->cms->Vars['flt_reset_parent'])) {$aItem =$this->itemData; $this->TTIl11l($aItem); $this->TTIlTlI($cId); $this->itemData[I7120] =$this->II11I11; $this->itemData['_parent_id'] =$cId; $this->itemData['is_async'] =$aItem['is_async'] =$this->II11lLI; $this->itemData['answer_for'] =$this->cms->Gui->get($this->moduleName .'_subform:answer_for', $aItem); }else {$this->itemData[I7109] =I7065; }$this->itemData[I7074] =$cId; $this->itemData['id_member'] =$this->IlIlLIL[I7118]; $this->itemData[I7104] =$this->TTI1TII(); $this->itemData[I7118] =0; }else {if($this->II11lLI){ $this->I1LlLLl =$this->itemData[I7118]; }$this->itemData[I7109] =TlITI1l($this->itemData[I7109], true); }}elseif($this->II11lLI && $this->fltExtModuleId){ $this->parentId =$cId; }}function _ActionDel($cId, $cModule) {$result =null; if ($this->fltExtModuleId) {$aItem =$this->TTIlT1T($cId); if(sizeof($aItem) >0) {$IIl1lIL =$this->TTIlITl($aItem); if (!sizeof($this->aGroupIds)) {$this->cms->AddStatusMsg('status_del'); }if (sizeof($this->aGroupIds) ?$cId == $this->aGroupIds[sizeof($this->aGroupIds) -1] :true) {$this->I1LlLll =$this->fltExtModuleId; $this->TIITl1l(); }$I1Ll1II =$aItem[I7058]; $result =$IIl1lIL; }}else {$this->TTIl111($cId); $I1Ll1Il =$this->options[I7066]; $this->options[I7066] =I7065; $this->TTI1T1T("`id` = " .$cId .$this->_ApplyFilters(I7065, I7069), -1); $this->options[I7066] =$I1Ll1Il; parent::_ActionDel($cId, $cModule); if (empty($this->errno)) {$aCondition =array (I7121 .intval($this->IlIlLll[I7059]), I7122 .$this->IlIlLll[I7058] ."'" );if ($this->options[I7123]) {$aCondition[] ="`lang` = '" .$this->langData ."'"; }$condition =implode(" AND ", $aCondition); $sql ="DELETE FROM `cms_discussion` WHERE " .$condition; $this->db->execute($sql); $I1Ll1II =$this->IlIlLll[I7058]; }}if (isset($I1Ll1II)) {$this->clearFrontCache($I1Ll1II); }return $result; }function _ActionPublish($cId, $cModule) {$aItem =$this->TTIlT1T($cId); if ($aItem) {$this->I1LlLll =$aItem[I7059]; $this->clearFrontCache($aItem[I7058]); $public =intval($this->cms->Vars[I7124] == I7093); $this->appliedId =$cId; $this->TTIlITI($aItem, $public); if (sizeof($this->aGroupIds) ?$cId == $this->aGroupIds[sizeof($this->aGroupIds) -1] :true) {$this->I1LlLll =$this->fltExtModuleId; $this->TIITl1l(); }}parent::_ActionPublish($cId, $cModule); }function TIITl1I($I1Ll1IL) {$res =false; $sql ="SELECT `count_children` FROM `cms_discussion` WHERE id = " .$I1Ll1IL; if ($this->db->getValue($sql) === '0') {$sql ="DELETE FROM `cms_discussion` WHERE id = " .$I1Ll1IL; $this->db->execute($sql); $res =true; }return $res; }function TIITl1l() {$realSide =$this->side; $this->side ='front'; $sql ="SELECT MAX(`date`) `msg_date` " ."FROM `cms_discussion` d " .I7081 .$this->I1LlLll .I7125 .$this->fltExtModule ."'" .$this->_ApplyFilters(); $this->side =$realSide; if ($record =$this->db->getRecord($sql)) {$this->TIITl11($record +array (I7059 => $this->I1LlLll)); }else {$aSQL =array ('msg_id' => 0, 'msg_id_member' => 0, I7126 => I7065, 'msg_date' => '0000-00-00 00:00:00', 'last_msg_id' => 0, 'last_msg_date' => '0000-00-00 00:00:00' );$sql =$this->db->genUpdateSQL('cms_discussion', $aSQL, I7116 .$this->II11I11); $this->db->execute($sql); }}function TIITl11($record, $I1Ll1I1 =false) {$I1Ll1lI =$record[I7059]; if (empty($record[I7058])) {$record[I7058] =$this->fltExtModule; }unset($record[I7059]); $sql =I7127 ."FROM `cms_discussion` " ."WHERE `date` = '" .$record['msg_date'] .I7128 .$record[I7058] .I7129 .$I1Ll1lI .I7130 .$this->langData ."' AND `public` = 1"; if ($aSQL =$this->db->getRecord($sql)) {unset($record[I7058]); $aSQL += $record; }else {$aSQL =array ('msg_id' => 0, 'msg_id_member' => 0, I7126 => I7065, 'msg_date' => '0000-00-00 00:00:00', 'last_msg_id' => 0, 'last_msg_date' => '0000-00-00 00:00:00' );}if ($I1Ll1I1) {$this->TTIlTlT($this->II11I11); }$aSQL[I7126] =addslashes($aSQL[I7126]); $sql =$this->db->genUpdateSQL('cms_discussion', $aSQL, I7116 .$this->II11I11); $this->db->execute($sql); }function TTT1Tl1($cType, $cModule, $II11l1L =TRUE) {switch ($cType) {case I7131: foreach ($this->I1LlLI1 as $extModule) {$this->TTI1TI1(); $fltExtModuleId =$this->fltExtModuleId; $this->fltExtModuleId =-1; $sql =I7132 ."FROM `cms_discussion` d " .I7133 .$extModule ."' " .$this->_ApplyFilters() .I7134; $this->fltExtModuleId =$fltExtModuleId; $rs =&$this->db->select($sql); while ($record =$rs->nextRecord()) {$this->TTI1TI1(); $this->fltExtModule =$extModule; $sql ="SELECT `id` FROM `cms_discussion` " ."WHERE " .I7135 .$record[I7059] .I7136 .I7122 .$extModule ."' AND `id_parent` = 0"; $rs1 =&$this->db->select($sql); while (list ($this->II11I11) =$rs1->nextRecord(MYSQL_NUM)) {$this->TIITl11($record, true); }}}parent::TTT1Tl1($cType, $cModule, false); $this->cms->AddStatusMsg('status_repair_counters', 'blue'); break; default: parent::TTT1Tl1($cType, $cModule); }}function TTTllTI(&$aCustom) {$this->SetBodyType('body_items'); $this->SetBodyType(I7137); parent::TTTllTI($aCustom); }function TTTll1T(&$vData, &$aCustom) {$I1Ll1ll =array(); if(isset($this->db->Record['sm_data'])){ $I1Ll1ll =$this->db->Record['sm_data']; }$I1LllL1 =AMI::getSingleton('env/session')->isLoggedIn(); if ($I1LllL1) {$vData[I7104] =$this->TTI1TII(); $vData['id_member'] =$this->II11ll1 =$this->IlIlLIL[I7118]; }else {$vData[I7104] =I7065; $vData[I7138] =0; }$vData['display_add_message_bnt'] =$I1LllL1 || !$this->module->GetOption('add_messages_by_registered_only'); foreach ($this->IIllIL1 as $IIlL1L1 => $tmp) {$aDefault =array ();$IIlL1Ll =$this->TTITTT1($aCustom, $IIlL1L1, false); switch ($IIlL1L1) {case 'body_items': $aDefault['page_item_type'] =$IIlL1L1; $IIlL1Ll += $aDefault; $this->TTTllll($vData, $IIlL1Ll); $I1Ll1lL =I7065; $select =I7065; if(sizeof($this->IlIlLL1) >0){ $this->IlIlL1L =$this->cms->Member->TTI1l1l($this->cms); if(is_object($this->IlIlL1L)){ $this->IlIlL1L->TITIIIl($select, I7139, 'body_items'); }$I1Ll1lL =DB_Query::getSnippet(", DATE_FORMAT(m.date, %s) `registration_date`, m.photo `avatar`, m.forum_sign, m.posts_count, m.companyweb member_site, m.source_app_user_id, m.source_app_id, m.rating_value as user_rating_value, m.rating_count as user_rating_count " .$select) ->q(str_replace(':%s', I7065, $this->cms->DFMT['db_dtime'])); }$this->browser->InitSQL( I7140 ."DATE_FORMAT(d.`date`, '" .str_replace(':%s', I7065, $this->cms->DFMT["db_dtime"]) ."') `fdate`, " ."UNIX_TIMESTAMP(d.date) `unixtime`" .(is_object($I1Ll1lL) ?$I1Ll1lL->get() :I7065), $I1Ll1lL ?array( 'tables' => array('d' => 'cms_discussion', 'm' => I7141), 'joins' => array('m|d' => 'm.id = d.id_member'), 'joins_types' => array(I7142 => 'LEFT OUTER') ):"FROM `cms_discussion` d ", I7143 .$this->fltExtModuleId .I7144 .$this->fltExtModule ."'" .$this->_ApplyFilters() .$this->TTTlIl1(), I7065, $this->browser->TI1TTlT() );$this->browser->lll1Ill =$this->module->issetAndTrueOption('forum_pager_page_number_as_bound'); if($I1Ll1lL){ $this->browser->AddSQLJoinedTables($this->cms->Core, I7145, array('m' => I7141)); }if ($this->II11IL1) {if ($this->id) {$id =$this->id; }else {$sql ="SELECT id FROM `cms_discussion` d " .I7143 .$this->fltExtModuleId .I7144 .$this->fltExtModule ."' " .$this->_ApplyFilters().$this->TTTlIl1() ." LIMIT 1"; $id =intval($this->db->getValue($sql)); }if ($id) {$this->TTIlTlI($id); $this->_public =1; if ($this->TTIlIIT($this->II11I11)) {$this->II11lI1 =$this->browser->SQLData[I7088]; $this->isFront =true; $res =$this->TTIlIII($this->II11I11, I7065); $this->isFront =false; unset($this->_public); if($I1Ll1lL){ $I1Ll1l1 =array(); foreach($res[I7146] as $index => $aRecord){ if(!empty($aRecord[I7138])){ $userId =(int)$aRecord[I7138]; if(empty($I1Ll1l1[$userId])){ $I1Ll1l1[$userId] =array(); }$I1Ll1l1[$userId][] =$index; }}if(sizeof($I1Ll1l1)){ $oQuery =DB_Query::getSnippet( "SELECT id id_member%s " ."FROM `cms_members` m WHERE id IN (%s)" )->plain($I1Ll1lL) ->implode(array_keys($I1Ll1l1)); $oDB =AMI::getSingleton('db'); $oRS =$oDB->select($oQuery); foreach($oRS as $aRecord){ foreach($I1Ll1l1[$aRecord[I7138]] as $index){ $res[I7146][$index] =array_merge($res[I7146][$index], $aRecord); }}}}}else {unset($this->_public); $res =array (I7146 => array ());}}else {$res =array (I7146 => array ());$this->II11llI =0; }$db =clone($this->db); require_once $GLOBALS['CLASSES_PATH'] .'CMS_IteratorArray.php'; $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray($res[I7146]); $this->db->IlI1Lll =$this->II11llI; $this->db->IIIll1L =false; $this->browser->lll1IIL =false; $this->browser->InitSQL(I7089, "FROM xxx", "WHERE 1"); }$IIlL1Ll['simple_set_fields'] =array ('fdate'); $IIlL1Ll[I7147]['offset_link'] =$aCustom['real_nav_data'] .'forum_ext=1&offset=[START]#forum'; if (!empty($this->cms->Vars['go_last_page'])) {$this->browser->lll1IlL =true; }$IIlL1Ll[I7148][I7118] =array (I7102 => I7099, 'object' => &$this, 'method' => '_GetFrontItemCB'); $IIlL1Ll[I7147]['display_add_message_bnt'] =$vData['display_add_message_bnt']; break; case I7137: $aEvent =array(); AMI_Event::fire('v5_internal_init_form_spam_protection', $aEvent, $this->fltExtModule); $sql ="SELECT `id` FROM `cms_discussion` d " .I7143 .$this->fltExtModuleId .I7144 .$this->fltExtModule ."' AND `id_parent` = 0"; $vData[I7074] =$vData['id_absolute_parent'] =intval($this->db->getValue($sql)); if(empty($this->I1LlLL1)){ $varName ='EXTENSION_TWIST_PREVENTION_DISCUSSION_HTML_' .mb_strtoupper($this->fltExtModule); $vData['discussion_twist_html'] =$this->cms->Gui->isGlobalVarDefined($varName) ?$this->cms->Gui->getGlobalVar($varName) :I7065; $varName ='EXTENSION_TWIST_PREVENTION_DISCUSSION_SCRIPT_' .mb_strtoupper($this->fltExtModule); $vData['discussion_twist_script'] =$this->cms->Gui->isGlobalVarDefined($varName) ?$this->cms->Gui->getGlobalVar($varName) :I7065; }else{ $vData['discussion_twist_html'] =$this->I1LlLL1[I7149]; $vData['discussion_twist_script'] =$this->I1LlLL1['js']; }$vData['noindex_external_links'] =$this->module->GetOption('noindex_external_links') ?I7105 :I7150; $IIlL1Ll['page_item_type'] =I7137; if ($vData['display_add_message_bnt']) {$vData['script_quote_message'] =$this->cms->Gui->get($this->moduleName .'_list:script_quote_message', $vData); $this->TTI1TT1($vData); $vData[I7151] =$this->I1LlLl1; if(AMI::getOption('members','user_source_app')){ $vData['user_source_app_buttons'] =AMI::getSingleton('user_source_app')->getButtons(); }$vData[I7152] =$this->cms->Gui->get($this->moduleName .'_list:form', $vData); }else {$vMod =&$this->cms->Core->GetModule('members'); if (!$this->IlIlLLL) {$vData['register_link'] =$this->IlIlLLl; $vData['wantsurl'] =rawurlencode($GLOBALS[I7153] .$GLOBALS['vGlobVars']['script_full_link'] .(mb_strpos($GLOBALS['vGlobVars']['script_full_link'], I7154) === false ?I7154 :'&') .'display_form=1#forumForm'); $vData[I7152] =$this->cms->Gui->get($this->moduleName .'_list:register_to_add_message', $vData); }}break; }if(sizeof($I1Ll1ll)){ $this->db->Record['sm_data'] =$I1Ll1ll; }parent::TTTll1T($vData, $IIlL1Ll); if (isset($db)) {$this->db =$db; }}}function _GetFrontItemCB(&$aItem, &$aData) {parent::_GetFrontItemCB($aItem, $aData); if($aItem[I7138]){ $this->TTI1Tll($aItem, $aData); }if (!empty($aItem[I7155])) {$aItem['tree_offset'] =$this->cms->Gui->getAbs($this->moduleName .'_list:tree_offset', array ('tree_offset' => $aItem[I7155] *10)); }if($aItem['source_app_id'] && AMI::getOption(I7156,'user_source_app')){ $I1Ll1LI =AMI::getSingleton('user_source_app'); $aItem['user_source_app_icon'] =$I1Ll1LI->getDriverIcon($I1Ll1LI->getDriverNameById($aItem['source_app_id']), array(I7157 => $aItem['source_app_user_id'])); }$I1LllL1 =AMI::getSingleton('env/session')->isLoggedIn(); if($I1LllL1 && !empty($aItem[I7138]) && $this->cms->Core->isInstalled('private_messages') && $this->cms->Core->IsPresentInPMandPublic('private_messages')){ $oPrivateMessagesView =AMI::getSingleton('private_messages/service/view'); $aItem['send_private_message_link'] =$oPrivateMessagesView->getUserSendMessageLink($aItem[I7138], $this->cms->lang); }$aItem['forum_script_link'] =AMI_PageManager::hasModPublicPage('forum', $this->cms->lang) ?AMI_PageManager::getModLink('forum', $this->cms->lang) :null; $aItem[I7104] =$this->cms->Gui->getAbs($this->moduleName .I7158, $aItem); $aEvent =array('aItem' => $aItem); AMI_Event::fire('ON_AMI_DISCUSSION_ITEM_ROW', $aEvent, 'discussion'); $aItem =$aEvent['aItem']; }public function isMessagePublished(){ return $this->I1LlLLL; }function extFrontActionAdd() {if (!$this->fltExtModuleId) {return 0; }$I1LllL1 =AMI::getSingleton(I7159)->isLoggedIn(); if (!$I1LllL1 && $this->module->GetOption('add_messages_by_registered_only')) {$this->cms->AddStatusMsg('status_not_allowed_to_add_messages', 'red'); return false; }$author =$I1LllL1 ?$this->TTI1TII() :$this->cms->VarsPost[I7104]; $memberId =$I1LllL1 ?$this->IlIlLIL[I7118] :0; $sourceAppId =$I1LllL1 ?$this->IlIlLIL['source_app_id'] :0; $message =trim($this->cms->VarsPost[I7109]); if (empty($author) || empty($message)) {$this->cms->AddStatusMsg(I7160, 'red'); return false; }$I1Ll1Ll =$this->cms->Core->GetModOption('ext_discussion', 'publish_from_authorized'); $I1Ll1LL =$this->cms->Core->GetModOption('ext_discussion', 'publish_from_not_authorized'); if($I1LllL1 && $I1Ll1Ll){ $I1Ll1L1 =1; }elseif(!$I1LllL1 && $I1Ll1LL){ $I1Ll1L1 =1; }else{ $I1Ll1L1 =0; }require_once $GLOBALS['FUNC_INCLUDES_PATH'] .'func_convert.php'; $message =TlTllIl($this->cms->htmlchars(removeSpecial($message, 'slashes')), true, $this->module->GetOption('noindex_external_links'), $this->IlIlLlI); if(!$this->TTI1TlI($message)){ $this->cms->Gui->AddGlobalVars( array( I7161 => AMI_Lib_String::jParse(removeSpecial(trim($this->cms->VarsPost[I7109]), 'slashes')) ));return false; }$message =addslashes($message); if (empty($this->cms->VarsPost['id_update'])) {$I1Ll11I =$this->options["check_public"]; $this->options["check_public"] =false; $sql ="SELECT `id` FROM `cms_discussion` d " .I7081 .$this->fltExtModuleId .I7125 .$this->fltExtModule ."' " .$this->_ApplyFilters() ." LIMIT 1"; $this->_firstMessageId =intval($this->db->getValue($sql)); if (empty($this->cms->VarsPost['realAnswer'])) {$fltExtModuleId =$this->fltExtModuleId; $this->fltExtModuleId =0; $sql ="SELECT `id` FROM `cms_discussion` d " .I7081 .$fltExtModuleId .I7125 .$this->fltExtModule .I7162 .$this->_ApplyFilters() ." LIMIT 1"; $this->fltExtModuleId =$fltExtModuleId; $parentId =intval($this->db->getValue($sql)); }else {$parentId =intval($this->cms->VarsPost[I7074]); }if (!$this->_firstMessageId && $I1Ll1L1) {$parentId =0; }$this->options["check_public"] =$I1Ll11I; $this->I1LlLLL =$I1Ll1L1; $aSQL =array (I7103 => "=|INET_ATON('" .getenv(I7114) ."')", I7074 => $parentId, I7138 => $memberId, I7163 => $sourceAppId, I7104 => $author, 'public' => $I1Ll1L1, I7113 => '=|NOW()', I7059 => $this->fltExtModuleId, I7058 => $this->fltExtModule );if ($this->options[I7123]) {$aSQL['lang'] =$this->langData; }if (!$parentId) {$I1Ll11l =AMI_PageManager::getPageItemData(); $aSQL[I7109] =$I1Ll11l['header']; $I1Ll11L =$aSQL +array (I7164 => 1, 'count_public_children' => $I1Ll1L1 ?1 :0, 'msg_id_member' => $aSQL[I7138], I7126 => $aSQL[I7104] ,'msg_date' => '=|NOW()' );$I1Ll11L[I7113] ='=|DATE_SUB(NOW(), INTERVAL 1 second)'; $I1Ll111 =$I1Ll11L['public']; $I1Ll11L['public'] =1; $sql =$this->db->genInsertSQL('cms_discussion', $I1Ll11L); $this->db->execute($sql); $I1Ll11L['public'] =$I1Ll111; $aSQL[I7074] =$this->db->lastInsertId(); }$aSQL[I7109] =$message; $sql =$this->db->genInsertSQL(I7165, $aSQL); $this->db->execute($sql); $this->appliedId =$this->db->lastInsertId(); if ($this->appliedId) {if($I1Ll1L1){ if ($parentId) {$aParentIds =$this->TTIlTll($this->appliedId); $I1Ll11L =array (I7164 => '=|count_children+1', 'count_public_children' => '=|count_public_children+1' );$sql =$this->db->genUpdateSQL(I7165, $I1Ll11L, 'WHERE id IN (' .implode(I7166, $aParentIds) .')'); $this->db->execute($sql); $I1LLIII =array_pop($aParentIds); }else {$I1LLIII =$aSQL[I7074]; }if($memberId){ $this->TTI1Tl1($memberId, 1); }$I1Ll11L =array ('msg_id' => $this->appliedId, 'msg_id_member' => $aSQL[I7138], I7126 => $aSQL[I7104], 'msg_date' => I7167, 'last_msg_id' => $this->appliedId, 'last_msg_date' => I7167 );$sql =$this->db->genUpdateSQL(I7165, $I1Ll11L, 'WHERE `id` = ' .$I1LLIII); $this->db->execute($sql); }else{ if ($parentId) {$aParentIds =$this->TTIlTll($this->appliedId); $I1Ll11L =array (I7164 => '=|count_children+1', I7168 => $this->appliedId, 'last_msg_date' => I7167 );$sql =$this->db->genUpdateSQL(I7165, $I1Ll11L, 'WHERE id IN (' .implode(I7166, $aParentIds) .')'); $this->db->execute($sql); }}if ($this->I1LlLl1 && $I1Ll1L1) {$this->TIIT1TI($aSQL); }$this->TIIT1TT($aSQL); $this->cms->AddStatusMsg($I1Ll1L1 ?'status_add' :'status_add_wait_approve'); if(AMI::getOption(I7156,'user_source_app')){ $aUserInfo =$this->cms->Member->getUserInfo(); if(!AMI::getSingleton('user_source_app')->checkValidMail($aUserInfo['email'])){ $this->I1LlLl1 =false; }}if ($I1Ll1L1 && $this->I1LlLl1 && !empty($this->cms->VarsPost[I7151]) && ($memberId ?!empty($this->IlIlLIL['email']) :(empty($this->cms->VarsPost[I7169]) ?false :isEmail($this->cms->VarsPost[I7169])) )){$I1LLIIl =true; if (!$memberId) {$sql ="SELECT 1 FROM `cms_members` WHERE `email` = '" .$this->cms->VarsPost[I7169] ."' LIMIT 1"; if ($this->db->getValue($sql)) {$I1LLIIl =false; }}if ($I1LLIIl) {$aSQL =array (I7059 => $this->fltExtModuleId, I7058 => $this->fltExtModule, I7138 => $memberId, );if (!$memberId) {$aSQL += array ('name' => $author, 'email' => $author .I7170 .$this->cms->VarsPost[I7169] .'>', 'key' => md5(mt_rand()) );}$sql =$this->db->genInsertSQL('cms_discussion_subscribers', $aSQL); $this->db->execute($sql, DBC_NO_HALT); }$this->cms->addStatusMsg('status_subscribed_to_thread'); }}else {$this->cms->AddStatusMsg(I7160); }}else {$this->TTIlIlT($message); }return $this->appliedId; }function TIIT1TT($aSQL) {$senderEmail =$this->TTI1TTl(); $I1LLIIL =$this->module->GetOption('forum_webmaster_email'); if (empty($I1LLIIL) || empty($senderEmail) || !$this->module->GetOption('notify_admin_about_new_message')) {return false; }if (isset($aSQL['header'])) {$topic =$this->cms->VarsPost['header']; }else {$I1Ll11l =AMI_PageManager::getPageItemData(); $aSQL[I7109] =$topic; }$d =$this->cms->Gui->ParseLangFile('templates/lang/' .$this->fltExtModule .I7171); $vMod =&$this->cms->Core->GetModule(I7156); $I1LLII1 =$vMod->IsPresentInPMandPublic() ?$vMod->GetFrontLink() :I7065; $I1LLIlI =mb_strlen($this->IlIlLLl) ?false :true; $mailData =array ('subject' => $d['new_discussion_message_mail_subject'], I7104 => removeSpecial($aSQL[I7104]), 'members_link' => $I1LLII1, I7138 => $I1LLIlI? 0 :$aSQL[I7138], 'body' => removeSpecial($this->cms->VarsPost[I7109]), I7172 => $GLOBALS[I7153] .AMI_Registry::get('page/scriptLink'), 'topic' => removeSpecial($topic), 'target' => 'element', I7173 => preg_replace(array ('/^\w+\:\/\//', '/\/.*$/'), I7065, $GLOBALS[I7153]) );$this->cms->Gui->addBlock('_forum_email', '_local/_admin/templates/letters/forum_mail.tpl'); require_once $GLOBALS[I7174] .'Mailer.php'; $oMail =new Mailer(); $oMail->SenderAddress =$senderEmail; $oMail->Subject =$this->cms->Gui->get('_forum_email:subject_discussion_message', $mailData); $oMail->Body =trim($this->cms->Gui->get('_forum_email', $mailData)); $oMail->CopyAddress =I7065; $oMail->BodyFormat ='plain'; $oMail->Prepare(); $oMail->RecipientAddress =$I1LLIIL; $oMail->Send(); return true; }function clearFrontCache($moduleName) {$IlllIlL =array ($moduleName); $module =&$this->cms->Core->GetModule($moduleName); if($module){ if ($module->issetProperty('clear_cache_on_discussion_post')) {$IlllIlL =array_merge($IlllIlL, $module->GetProperty('clear_cache_on_discussion_post')); }foreach ($IlllIlL as $moduleName) {$this->cms->Core->Cache->ClearAdd($moduleName); if ($module->issetAndTrueOption('show_forum_link_in_small') && $module->issetProperty('spec_blocks')) {$this->cms->Core->Cache->ClearAdd(I7117, 0, I7065, I7065, $module->GetProperty('spec_blocks')); }}$this->cms->Core->Cache->ClearCacheNow(); }}function TIIT1TI($aSQL) {$this->I1LlLLI =I7065; $memberId =$aSQL[I7138]; if ($memberId ?!empty($this->IlIlLIL[I7175]) :(empty($this->cms->VarsPost[I7169]) ?false :isEmail($this->cms->VarsPost[I7169])) ){$this->I1LlLLI =$memberId ?$this->IlIlLIL[I7175] :$this->cms->VarsPost[I7169]; }$sql ="SELECT m.id, m.email member_email, s.email, m.username, s.name, s.key " ."FROM `cms_discussion_subscribers` s " ."LEFT JOIN `cms_members` m ON m.id = s.id_member " .I7176 .$aSQL[I7059] .I7177 .$aSQL[I7058] ."'"; $rs =&$this->db->select($sql); $aRecipients =array ();while (list ($memberId, $I1LLIll, $email, $username, $name, $key) =$rs->nextRecord(MYSQL_NUM)) {if (!in_array($this->I1LlLLI, array ($I1LLIll, $email))) {$name =$username == I7065 ?$name :$username; $aRecipients[$username == I7065 ?$email :($username .I7170 .($I1LLIll == I7065 ?$email :$I1LLIll) .I7178)] =array ('recipient_username' => $name, 'key' => $key, I7175 => rawurlencode(preg_replace('/.*<([^>]+)>$/', '\1', $email)) );}}if ($I1LLIlL =(sizeof($aRecipients) >0)) {$vMod =&$this->cms->Core->GetModule($aSQL[I7058]); $this->cms->Gui->addBlock(I7179, '_local/_admin/templates/letters/discussion_mail.tpl'); require_once $GLOBALS[I7174] .'Mailer.php'; require_once $GLOBALS['FUNC_INCLUDES_PATH'] .'func_convert.php'; $oMail =new Mailer(); $mailData =array (I7180 => $GLOBALS[I7153], 'url' => $vMod->GetFrontLink() .'?id=' .$this->appliedId, I7109 => strip_tags(TlTllI1(removeSpecial($aSQL[I7109]))), I7104 => removeSpecial($aSQL[I7104]), I7118 => $this->appliedId, I7173 => preg_replace(array ('/^\w+\:\/\//', '/\/.*$/'), I7065, $GLOBALS[I7153]), I7181 => preg_replace("/([^\n\r]+).*/s", '\\1', trim($this->cms->stripLine(strip_tags(TlTllI1(removeSpecial($aSQL[I7109]))), 20))) );$oMail->SenderAddress =$this->TTI1TTl(); $oMail->BodyFormat ='plain'; $oMail->Prepare(); $IlI1LLl =array ('lang' => $this->langData, I7182 => addslashes($this->cms->Gui->get('_discussion_email:subject', $mailData)), 'headers' => addslashes(serialize($oMail->_Headers)), 'body' => addslashes($this->cms->Gui->get('_discussion_email:body', $mailData)) );require_once $GLOBALS[I7174] .I7183; CMS_MailQueue::addLetter($this->db, $IlI1LLl, $aRecipients); }if ($I1LLIlL) {require_once $GLOBALS[I7174] .'CMS_BackgroundProcess.php'; $process =new CMS_BackgroundProcess(); $process->registerHandler('CMS_MailQueue::processQueue', I7065); $process->process(); }}function extFrontActionStopWatching() {$memberId =isset($this->IlIlLIL[I7118]) ?$this->IlIlLIL[I7118] :0; if (!$memberId && isset($this->cms->VarsGet['key']) && isset($this->cms->VarsGet[I7175])) {$sql ="DELETE FROM `cms_discussion_subscribers` WHERE `key` = '" .addslashes($this->cms->VarsGet[I7184]) ."' AND `email` LIKE '%" .addslashes(rawurldecode($this->cms->VarsGet[I7175])) ."%'"; }elseif ($memberId && !isset($this->cms->VarsGet[I7184]) && !isset($this->cms->VarsGet[I7175])) {$sql ="DELETE FROM `cms_discussion_subscribers` WHERE `id_member` = " .$memberId; }if (isset($sql)) {$this->db->execute($sql); }$this->cms->AddStatusMsg('status_unsubscribed_thread'); $this->TTI1TlT(array (I7185 => 1)); }function &TTTllTl(&$aCustom){ $this->IIllL1L =false; $aData =parent::TTTllTl($aCustom); $this->IIllL1L =true; return $aData; }public function TIIT1Tl($I1LlLL1){ $this->I1LlLL1 =$I1LlLL1; }}