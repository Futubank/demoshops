<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       110428 xkqwisgwkqklrmrlysrtzxpuxskpwzurslqszrisgyrmzswrkkqixypkynnmtpntsnpipnir
 */ ?><?php foreach(array(7208=>'qDOHGzSIMn`GOG',7209=>'iHSuJQTZxQD`GOG',7210=>'iHSuJQTZxwJZDDQD`GOG',7211=>'',7212=>"ZSIMn|MnMt|HrSQr",7213=>'GMWturQ|WZt',7214=>"MnDtruWtMHnD|Hn",7215=>'fHrWQ|WZt|MS',7216=>"'",7217=>"PQtgZtO",7218=>"|DQZrWONHSQwy",7219=>"ZJJ|WOMJSD",7220=>"rQDuJt",7221=>"MS",7222=>"",7223=>"uDQ|DOMGGMnP|IHSuJQ",7224=>'SZtQfrHI',7225=>"?zNs?MS#@'",7226=>"MS|GZrQnt",7227=>'1',7228=>"GuYJMW",7229=>"DGQWMZJ|fJZP|JMDt",7230=>"GZrQnt",7231=>"MD|WOMJSD",7232=>"GZrQnt|DQJQWtYHx",7233=>"WZt|MS",7234=>"GrMWQ|fMQJS",7235=>"GrMWQ|MnfH",7236=>"|WurrQnWBVZrDwy",7237=>"GrMWQD|vZrD",7238=>"GrMWQ",7239=>"GrMWQ|WZGtMHn",7240=>"DQJQWtQS|fMQJS",7241=>"GrMWQ|fMQJS|JMDt",7242=>"MD|rHHt",7243=>"'?zNs?W`MS|DMtQ,='",7244=>"W`MS|DMtQ",7245=>"HGtMHnD|fHrI",7246=>"FRhi?.",7247=>".JZnP.?=?'",7248=>".MS.?=?",7249=>"MS|SMDWHunt|DQJQWt",7250=>'SMDWHuntD|IHSuJQ|ZSSHn',7251=>"|DuYfHrI%SMDWHuntD|IHSuJQ|ZSSHn",7252=>"MS|DOMGGMnP|tBGQ",7253=>"coqRq?.JZnP.?=?'",7254=>"|DOMGGMnP|tBGQD.?",7255=>".",7256=>".nZIQ.",7257=>"WtrJ|fMQJS|vZJuQ",7258=>"DOMGGMnP|tBGQ|WtrJ",7259=>"DOMGGMnP|IHSuJQ|ZSSHn",7260=>"|DuYfHrI%DOMGGMnP|IHSuJQ|ZSSHn",7261=>"SZtZDQt",7262=>"dqjqwT?[?FRhi?",7263=>"GHDtfMx",7264=>"fMQJSD|DOZrQS",7265=>"fMQJSD|WZGtMHnD",7266=>"ZWtMHn",7267=>'WuDtHI|nuI|tZYD',7268=>"fJt|nZIQ",7269=>"fJt|MS|QxtQrnZJ",7270=>"DQJQWt",7271=>"fJt|SZtZDQt|MS",7272=>"nZIQ",7273=>"SZtZDQt|HGtMHnD",7274=>"GZrQnt|MS",7275=>"WZt`GuYJMW",7276=>'WZt|GuYJMW',7277=>'GuY|MS',7278=>'nZIQ',7279=>'ZWtMHn',7280=>'DMAQ',7281=>'HYLQWt',7282=>'IQtOHS',7283=>"JMDt|SZtZ",7284=>'WZJJYZWK',7285=>"nHtGuYJMDOQS",7286=>'JQPQnS',7287=>"JQP|SQJ",7288=>"WZnWQJ",7289=>"SZtZDQt|MS",7290=>"SQDWrMGtMHn",7291=>"IHSMfMQS|SZtQ",7292=>"=_Nhc}{",7293=>"mNNqR?lhmN?",7294=>"|WZtD?COQrQ?MS=",7295=>"MDgmsDwOZnPQS",7296=>"SZtZDQt|SZtZ",7297=>'Hn',7298=>"ZJJHC|WZt|frZWtMHn",7299=>'YHtO',7300=>'<',7301=>"IuJtM|DMtQD",7302=>'rQS',7303=>"ZffQWtQS",7304=>"GrMWQD",7305=>"|MS|DMtQ",7306=>"!",7307=>"{!",7308=>"ZJJ|Zrr",7309=>'MS|HrMPMnZJ',7310=>"CZtQrIZrKD",7311=>"+1",7312=>"tZx|WJZDD|tBGQ",7313=>"|WZtD.?",7314=>"'?",7315=>"ZdEJ",7316=>"{",7317=>"UgszTq?",7318=>"DQJQWt?MS?frHI?",7319=>"WHunt|WOMJSD",7320=>"W2",7321=>"tBGQ",7322=>"MtQI|tBGQ",7323=>"sqjqTq?FRhi?",7324=>"DuYMtQID|SQJQtQS",7325=>"IHvQ",7326=>"MS|DMtQ",7327=>"WuDtHI",7328=>"OQZSQr",7329=>'ZJJ|GZrQntD',7330=>'ZJJ|GZrQntD!?',7331=>'HqnPMnQ',7332=>"ZJJHC|frZWtMHn",7333=>"Hn|DGQWMZJ",7334=>"|WZtD?COQrQ?}MS='",7335=>"DQJQWt?[?frHI?",7336=>"fMQJSD|fMJtQr",7337=>"MnDtruWt",7338=>"ZgrMWQDdEJ",7339=>'MS|DOMGGMnP|tBGQ',7340=>"HJSwHuntwOMJSD",7341=>"'{",7342=>"HJSguYJMW",7343=>"MSdMtQ",7344=>"MS|SMDWHunt",7345=>"HJSgZrQntmS",7346=>"GrMWQDwOZnPQS",7347=>"|ZGGJB5",7348=>"nQCmSdMtQ",7349=>"nQCgZrQntmSdMtQ",7350=>"|ZSS1",7351=>'WZt|nZIQ',7352=>"JQvQJ",7353=>"@",7354=>"WZt|DQJQWt",7355=>"tMtJQ",7356=>"ZJt",7357=>"vZJuQ",7358=>"GZPQ|MD|JZDt",7359=>"|JMDt%MWHnD|QSMt",7360=>"ZWtMHnD",7361=>"IHSuJQ|nZIQ",7362=>"]IMSSHt^]nYDG^",7363=>"PQtZJJvZJuQD",7364=>"HGtMHn|WY",7365=>"HGtMHn|DQJQWt|WZt",7366=>"PQtvZJuQ",7367=>"DQJQWtQSwHnSMtMHn",7368=>"?zd?.DQJQWtQS.?",7369=>"coqRq?",7370=>"COQrQ",7371=>"?jmimT?",7372=>"?}",7373=>"ZYD",7374=>'nZIQ|fMQJS|nZIQ') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopCat extends CMS_ActModule {public $oEshop; public $I1LLlII; public $I1LLlIl; public $I1LLlIL; public $I1LLlI1; public $cid; public $I1LLllI; public $I1LLlll; public $I1IL1Ll; public $I1LLllL; public $datasets; public $ILLILIL; public $I1LLll1; public $I1LLlLI; public $_useShippingModule; public $I1LLlLl; public $I1LLlLL; public $I1LLlL1; public $I1LLl1I; public $I1LLl1l =false; function ModuleEshopCat(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); if($this->cms->Core->Side!="admin") {CreateEshop($cms); $this->oEshop =&$cms->Eshop; }else {require_once $GLOBALS['CLASSES_PATH'] .I7208; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init($this->moduleName); require_once $GLOBALS['CLASSES_PATH'] .I7209; require_once $GLOBALS['CLASSES_PATH'] .I7210; $this->I1LLlII =new ModuleTaxClasses($cms, $db, $cModule); }$this->I1LLllL =Array(); $this->datasets =Array(); $this->ILLILIL =Array(); $this->I1LLll1 =""; $this->I1LLlLI =""; $this->KeepItemCatId =false; }function _Init($IIll1l1 =Array(), $IIll1LI =I7211, $IIll1Ll =I7211, $aOptions =Array()) {$IIIIL11['default_prefix'] ='cat'; $IIIIL11["multi_sites"] =true; $IIIIL11["use_options_form"] =true; $IIIIL11[I7212] =Array("form", "filter"); $IIIIL11["use_positions"] =true; $IIIIL11["picture_cat"] =$this->module->Ill1llL->GetProperty(I7213); $IIIIL11["use_details_noindex"] =false; if(in_array('ext_images',$this->cms->Core->TTlI1TI('eshop_item', 'extensions'))){ $IIIIL11["additional_extensions"] =array('ext_images'); }$aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->I1LLlL1 =0; if($this->module->IssetOption("num_special_flags")) {$this->I1LLlL1 =$this->module->GetOption("num_special_flags"); }}function TIIT11I() {$this->oEshop->init($this->moduleName); $this->oEshop->TT1l11l($this->options["multi_sites"], $this->siteId); $this->tree =&$this->oEshop->tree; $this->TT11TTT(); $this->I1LLlI1 =$this->oEshop->ILlLLLL->GetOption(I7214); if($this->I1LLlI1) {$this->cms->Gui->AddGlobalVars(Array('INSTRUCTIONS_ON' => "1")); }$this->I1LLllI =Array(); $this->cid =0; if(AMI::getSingleton('env/async50')->isActive()){ $this->cid =(int)(isset($this->cms->Vars['force_cat_id']) ?$this->cms->Vars[I7215] :AMI_Filter::getFieldValue('category', 0)); }elseif(!empty($this->cms->Vars['cat_id'])){ $this->cid =(int)$this->cms->Vars['cat_id']; }$this->I1LLlll =" AND lang='".$this->langData.I7216; $this->I1IL1Ll =Array(); $this->I1LLlLL =null; }function TT11TTT() {$this->tree->setCallbackObject($this); $this->tree->setCallbackMethod("createChildsArrayFlt", "_treeArrayCB"); $this->tree->setCallbackMethod("getAllParents", "_createPathCB"); $this->tree->setCallbackMethod(I7217, "_getPathCB"); $this->tree->setCallbackMethod("getNode", "_getNodeRecordCB"); $this->tree->setCallbackMethod("searchNode", I7218); $this->tree->setCallbackMethod("getAllChilds", "_getAllChildsCB"); $this->tree->TI11IIT("name_dataset", "c.name, c.dataset_id"); }function _getAllChildsCB(&$res, &$rec, &$info){ if(!is_array($res)){ $res =array(); }$res[I7219] .= (empty($res[I7219]) ?"" :",").$rec["id"]; if($rec["ispricechanged"]){ $res[I7220]["prices"] .= (empty($res[I7220]["prices"]) ?"" :",").$rec[I7221]; if(!is_array($res[I7220]["all_arr"]) || !in_array($rec[I7221], $res[I7220]["all_arr"])){ $res[I7220]["all"] .= (empty($res[I7220]["all"]) ?I7222 :",").$rec[I7221]; $res[I7220]["all_arr"][] =$rec[I7221]; }}return true; }function _InitAdmin() {parent::_InitAdmin(); require_once $GLOBALS['CLASSES_PATH'] .I7208; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->TIIT11I(); $_moduleName =$this->oEshop->ownerName ."_shipping_methods"; $isInstalled =$this->cms->Core->IsInstalled($_moduleName); $this->_useShippingModule =$isInstalled && $this->cms->Core->GetModOption($_moduleName, I7223); if ($isInstalled) {$this->I1LLlLl =$this->oEshop->TT11llT(); }if($this->filter->issetField(I7224)){ $this->filter->TITI1l1(I7224); }if($this->filter->issetField('dateto')){ $this->filter->TITI1l1('dateto'); }$this->filter->IL11l1L =array('limit'); }function TTTlTI1() {parent::TTTlTI1(); $this->TIIT11I(); }function _ApplyFilters($prefix =I7211, $bodyType =I7211, $IIlLLl1 =true) {$res =I7222; if($this->action == "del_all") {$res =I7225.$this->oEshop->rootCatId."' "; }$res .= parent::_ApplyFilters($prefix, $bodyType); return $res; }function TTTlI1l() {$res =false; if(parent::TTTlI1l()) {$res =($this->cid >0); }return $res; }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); $this->tree->initResult(false); $res =$this->tree->getNode($this->cid); if($res === false) {$this->cid =0; }if($this->action == "edit") {$I1LLl1L =$this->id; $vData["id_parent"] =$this->itemData["id_parent"]; if(isset($this->cms->Vars[I7226]) && $this->cms->Vars[I7226] >0){ $vData[I7226] =$this->cms->Vars[I7226]; }}else {$I1LLl1L =-1; if(isset($this->cms->Vars["parent"]) && $this->cms->Vars["parent"] >0) {$vData[I7226] =$this->cms->Vars["parent"]; }elseif($this->cid >0) {$vData[I7226] =$this->cid; }else {$vData[I7226] =$this->oEshop->rootCatId; }}$allowFloat =$this->oEshop->isFractionAllowed; if($allowFloat){ $vData['ESHOP_ALLOW_FRACTION'] =I7227; if(isset($this->itemData['allow_fraction']) && $this->itemData['allow_fraction'] === I7227){ $this->itemData['allow_fraction'] ='checked'; }}$vData[I7228] ="checked"; $vData["price_list_checked"] =I7222; $vData["num_decimal_digit"] =$this->oEshop->numberDecimals; $vData["price"] =0; if($this->I1LLlL1) {$this->I1LLl1I =$this->cms->Gui->ParseLangFile($GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/lang/".$this->oEshop->ownerName."_cat.lng"); }else {$this->I1LLl1I =Array(); }$value =isset($this->itemData["special_flag"]) ?$this->itemData["special_flag"] :0; $vData[I7229] =TIIlTII($this->cms->Gui, $this->moduleName."_subform", 0, $this->I1LLlL1 -1, $this->I1LLl1I, $value); $this->oEshop->ILlLLLL->PushPager($this->cms->Pager); $this->oEshop->ILlLLLL->InitPager($this->cms->Pager, I7222, $this->oEshop->ILlLLLL->GetOption("front_page_sort_col"), $this->oEshop->ILlLLLL->GetOption("front_page_sort_dim")); $datasets =array(); $this->oEshop->tree->sqlOrderEnable(); $this->tree->createChildsArrayFlt("name_dataset"); $this->tree->initResult(Array(I7230=>I7222, "selected_id"=>$vData[I7226], "aCatsNames"=>&$this->I1LLllI, "current_id"=>$I1LLl1L, "datasets" => &$datasets)); $this->I1IL1Ll[I7231] =false; $this->I1IL1Ll["level"] =0; $ILLILI1 =Array(); $this->tree->setCallbackMethod("buildTreeOnChildsArray", "_buildTreeOnChildsArrayCB"); $ILLILI1 =$this->tree->buildTreeOnChildsArray(); $this->oEshop->tree->sqlOrderDisable(); $this->oEshop->ILlLLLL->PopPager($this->cms->Pager); if(($this->action == "edit" && $this->itemData[I7221] == $this->oEshop->rootCatId) || !is_array($ILLILI1)) {$vData[I7232] =$this->cms->Gui->getAbs($this->moduleName."_subform:parent_noselectbox", Array(I7230=>$this->oEshop->rootParentCatId)); }else {$vData[I7232] =$this->cms->Gui->get($this->moduleName."_subform:parent_selectbox", $ILLILI1); $counter =0; if(!isset($vData["cat_datasets"])){ $vData["cat_datasets"] =I7211; }foreach($datasets as $catid => $I1LLl11){ $I1LLLII =array(I7221 => $counter, I7233 => $catid, "dataset_id" => $I1LLl11); $vData["cat_datasets"] .= $this->cms->Gui->get($this->moduleName."_subform:dataset_js", $I1LLLII); $counter++; }}$vData["price_caption"] =I7222; $vData[I7234] =I7222; $vData["other_prices_disabled"] =I7222; $vData["num_prices"] =$this->oEshop->numPrices; $vData["prices_vars"] =I7222; if (true) {if($this->action != "edit") {$this->tree->initResult(false); $this->itemData =$this->tree->getNode($vData[I7226], I7235); if($this->db->next_record()) {$this->itemData =$this->db->Record; }}if($this->oEshop->otherPricesEnabled) {$vData["other_prices_disabled"] =I7222; $vData["prices_fields"] =implode(",", $this->oEshop->priceFields); if($this->oEshop->currencyEnable) {$this->oEshop->setCallbackObject($this); $this->oEshop->setCallbackMethod("getCurrencyList", I7236); $vData["currency_vars"] =I7222; $I1LLLIl =Array(); $this->oEshop->getCurrencyList($vData["currency_vars"]); $this->oEshop->setCallbackMethod("getCurrencyList", "_getCurrencySelectCB"); }for($i=0;$i<$this->oEshop->numPrices;$i++) {$ILLILI1 =Array(); $priceNum =$this->oEshop->priceFields[$i]; $vData[I7237] .= "var price".$priceNum.";\n"; $ILLILI1["selected_field"] =$this->oEshop->baseCurrency; if(isset($this->itemData["price".$priceNum])) {$I1LLLIL =$this->oEshop->TT11TlT($this->itemData[I7238.$priceNum]); if($I1LLLIL["currency"] != I7222) {$ILLILI1["selected_field"] =$I1LLLIL["currency"]; }}else {unset($this->itemData[I7238.$priceNum]); }if(isset($this->itemData["price_caption".$priceNum])) {$ILLILI1[I7239] =$this->itemData[I7239.$priceNum]; unset($this->itemData[I7239.$priceNum]); }else {$ILLILI1[I7239] =I7222; }$ILLILI1["price_number"] =$priceNum; $ILLILI1["price_value"] =$I1LLLIL[I7238]; if($this->oEshop->currencyEnable) {$ILLILI1["currency_select_row"] =I7222; $this->oEshop->getCurrencyList($ILLILI1); $ILLILI1["currency_select"] =$this->cms->Gui->get($this->moduleName."_subform:currency_select", $ILLILI1); $ILLILI1["currency_select_row"] =I7222; if($I1LLLIL["currency"] != I7222){ $ILLILI1["selected_field"] =$I1LLLIL["db_currency"]; }else{ $ILLILI1[I7240] =$this->oEshop->baseCurrency; }$this->oEshop->getCurrencyList($ILLILI1); $ILLILI1["db_currency_select"] =$this->cms->Gui->get($this->moduleName."_subform:db_currency_select", $ILLILI1); }$vData[I7239] .= $this->cms->Gui->get($this->moduleName."_subform:price_caption", $ILLILI1); $vData[I7234] .= $this->cms->Gui->get($this->moduleName."_subform:price_value_field", $ILLILI1); }$vData[I7241] =$this->cms->Gui->get($this->moduleName."_subform:price_value_field_list", $vData); }}if(is_array($this->itemData)){ $vData =array_merge($vData, $this->itemData); }if($this->oEshop->ILlLL1I->IsInstalled()) {$vData["price_list_checkbox"] =$this->cms->Gui->get($this->moduleName."_subform:price_list_checkbox", $vData); }if($this->options["multi_sites"] && (($this->itemData[I7242] && $this->siteId >0) || (isset($this->itemData["id_site"]) && $this->itemData["id_site"] == 0) || $this->siteId == 0)) {$IILIlL1 =($this->siteId >0) *$this->siteId +($this->siteId == 0) *$this->itemData["id_site"]; $this->tree->addFilter(I7242, "c.is_root='1' AND c.id_site!='".$this->siteId.I7243.$this->itemData["id_site"].I7216); $filterEnabled =false; if($this->tree->TI11I1T("id_site")) {$filterEnabled =true; $this->tree->TI11Il1("id_site"); }$I1LLLI1 =Array(); $this->tree->initResult($I1LLLI1); $this->tree->TI11IIT("id_site", I7244); $I1LLLI1 =$this->tree->searchNode("id_site"); $this->tree->TI11I1I(I7242); if($filterEnabled) {$this->tree->TI11Ill("id_site"); }$this->TTT11TI($vData, $IILIlL1, $this->itemData[I7242], $I1LLLI1); }$this->cms->Gui->addBlock("options_form", "templates/_mod_options_form.tpl"); $vData[I7245] =$this->cms->Gui->get(I7245, $vData); $mModule =&$this->cms->Core->GetModule($this->oEshop->ownerName ."_discounts"); $vData["discounts_link"] =$mModule->GetAdminLink(); $I1LLLlI =$this->itemData["id_discount"]; $sql ="SELECT `id`, `name`, `amount`, `type` " .I7246 .$this->oEshop->dbTablePrefix ."_discounts` " ."WHERE `id` = '" .$I1LLLlI .I7216; if ($I1LLLlI >0 && $this->db->query($sql) && $this->db->next_record()) {$I1LLLlI =$this->db->Record[I7221]; }else {$this->itemData["id_discount"] =$I1LLLlI =0; }$I1LLLll =array ("select" => "`id`, `name`, `amount`, `type` ", "from" => "`" .$this->oEshop->dbTablePrefix ."_discounts`", "where" => I7247 .$this->langData ."' AND `condition` != 'global' AND `id_parent` = 0", "order" => "`name`" );if ($I1LLLlI >0) {$I1LLLll["selectedCondition"] =I7248 .$I1LLLlI; }$aCustom =array ("ctrl_field_name" => "id_discount", "ctrl_field_value" => $I1LLLlI, "ctrl_field_name_select" => I7249, "tpl_list_postfix" => "list_ctrl_discount_list" );if($this->cms->Core->IsInstalled($this->oEshop->ownerName .'_discounts')){ $vData[I7250] =$this->cms->Gui->getAbs($this->moduleName.I7251, array ('discount_ctrl' => $this->TIIIT1I("show_discounts_in_admin", $I1LLLll, $aCustom +$vData, "_GetListCtrlHtmlCB") ));}if ($this->_useShippingModule) {$I1LLLlL =array ();$mModule =&$this->cms->Core->GetModule($this->oEshop->ownerName ."_shipping_types"); $vData["shipping_types_link"] =$I1LLLlL["shipping_types_link"] =$mModule->GetAdminLink(); $shippingTypeId =isset($this->itemData[I7252]) ?$this->itemData[I7252] :($this->action == "edit" && isset($this->cms->Vars[I7252]) ?$this->cms->Vars[I7252] :0); $I1LLLlL["shipping_type_name"] =I7222; $I1LLLlL[I7252] =$this->itemData[I7252] =0; if ($shippingTypeId >0) {$sql ="SELECT `id`, `name` FROM `" .$this->oEshop->dbTablePrefix ."_shipping_types` " .I7253 .$this->langData ."' AND `id` = '" .$shippingTypeId .I7216; $this->db->query($sql); if ($this->db->next_record()) {$I1LLLlL[I7252] =$this->db->Record[I7221]; $I1LLLlL["shipping_type_name"] =$this->db->Record["name"]; }}$sql ="SELECT `id`, `name`, `hidden` " .I7246 .$this->oEshop->dbTablePrefix .I7254 ."WHERE `id` = '" .$shippingTypeId .I7216; if ($shippingTypeId >0 && $this->db->query($sql) && $this->db->next_record()) {$I1LLLlL[I7252] =$shippingTypeId =$this->db->Record[I7221]; }else {$I1LLLlL[I7252] =$this->itemData[I7252] =$shippingTypeId =0; }$I1LLLll =array ("select" => "`id`, `name`", "from" => I7255 .$this->oEshop->dbTablePrefix ."_shipping_types`", "where" => I7247 .$this->langData ."' AND `hidden` = 0", "order" => I7256 );if ($shippingTypeId >0) {$I1LLLll["selectedCondition"] =I7248 .$shippingTypeId; }$aCustom =array ("ctrl_name" => "shipping_type", "ctrl_field_name" => I7252, I7257 => $shippingTypeId, "ctrl_field_name_select" => "id_shipping_type_select", "tpl_list_postfix" => "list_ctrl_shipping_type_list" );$I1LLLlL[I7258] =$this->TIIIT1I("show_shipping_types_in_admin", $I1LLLll, $aCustom +$I1LLLlL); $vData[I7259] =$this->cms->Gui->get($this->moduleName.I7260, $I1LLLlL); }else {$vData[I7259] =I7222; }$this->I1LLlIl =false; $this->I1LLlIL =true; if($this->cms->Core->IsInstalled($this->oEshop->ownerName .'_tax_classes')){ $this->I1LLlII->TIl1I1I($this, $this->action, $vData, $this->itemData); }$IL1ILLl =array(); $vData["dataset_name"] =$this->words["unknown"]; $sql =I7222; if(isset($this->cms->Vars[I7261]) && $this->cms->Vars[I7261] >0){ $sql ="SELECT * FROM ".$this->oEshop->dbTablePrefix."_datasets where id='".intval($this->cms->Vars[I7261])."' AND lang='".$this->langData.I7216; }elseif ($this->action == "edit") {$I1LLLl1 =$this->itemData; }else{ $sql =I7262.$this->oEshop->dbTablePrefix."_datasets where is_sys=1 AND lang='".$this->langData.I7216; }if($sql){ $this->db->query($sql); if($this->db->next_record()){ $I1LLLl1["dataset_id"] =intval($this->db->Record[I7221]); $I1LLLl1["dataset_data"] =serialize(array( "postfix" => $this->db->Record[I7263], "name" => $this->db->Record["name"], "fields_map" => $this->db->Record["fields_map"], I7264 => $this->db->Record[I7264], "fields_filter" => $this->db->Record["fields_filter"], "fields_show_empty" => $this->db->Record["fields_show_empty"], I7265 => unserialize($this->db->Record[I7265]), "sku_map" => $this->db->Record["sku_map"] ));$vData["dataset_name"] =$this->db->Record["name"]; }}$IIlLIIL =Array(I7266=>"set_dataset", I7221=>0, "item_data"=>&$I1LLLl1, "custom"=>&$IL1ILLl); $this->TTT1lI1($IIlLIIL); $vData["hasCustomFieldsTabs"] =isset($IL1ILLl[I7267]) && $IL1ILLl[I7267] >0; $vData['form_width'] ='100%'; }function TTTlIII() {parent::TTTlIII(); $this->filter->AddField("flt_name", "text", isset($this->cms->Vars[I7268]) ?stripslashes(unhtmlentities($this->cms->Vars[I7268])) :I7211, I7222, " like ", "cat.name"); $this->filter->AddField( 'flt_id_external', 'text', isset($this->cms->Vars[I7269]) ?stripslashes(unhtmlentities($this->cms->Vars[I7269])) :I7211, I7211, ' like ', 'cat.id_external'); $aCats =Array(); $aCats =$this->filter->TITI1TT($aCats, Array($this->cms->Words["all"]=>0), 55); $num =sizeof($this->I1LLllI); for($i=0;$i<$num;$i++) {$aCats =$this->filter->TITI1TT($aCats, Array($this->I1LLllI[$i]["name"]=>$this->I1LLllI[$i][I7221]), 500); }$this->filter->AddField(I7233, I7270, $this->cid, I7222, "=", "cat.id_parent", $aCats); $this->filter->MoveField(I7233, _MOVE_START); if(!AMI::getSingleton('env/async50')->isActive()){ $this->filter->TITIll1(I7233); }if($this->cid==0) {$this->filter->DisableFieldSQL(I7233); }$aDatasets =Array(); $aDatasets =$this->filter->TITI1TT($aDatasets, Array($this->cms->Words["all"]=>0), 55); $sql ="select id, name from ".$this->oEshop->dbTablePrefix."_datasets where lang='".$this->langData."' order by id"; $this->db->query($sql); while($this->db->next_record()){ $aDatasets =$this->filter->TITI1TT($aDatasets, Array($this->db->Record["name"] => $this->db->Record[I7221]), 500); }$this->filter->AddField("flt_dataset_id", I7270, isset($this->cms->VarsPost[I7271]) ?$this->cms->VarsPost[I7271] :null, I7222, "=", "cat.dataset_id", $aDatasets); $this->filter->MoveField(I7271, _MOVE_START); $this->filter->TITIll1(I7271); if(empty($this->cms->VarsPost[I7271])) {$this->filter->DisableFieldSQL(I7271); }}function TTTlI11(&$vData, &$aCustom) {$vData["base_currency"] =$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency) .$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency); if($this->cid >0) {$I1LLLLI =$this->oEshop->ILlLLLL->GetOption("path_settings"); $I1LLLLl =$this->oEshop->ILlLLLL->GetOption('path_settings_strip_text'); $I1LLLLL =$this->cms->Gui->getAbs($this->moduleName."_list:path_root_item", I7222); $this->tree->initResult($I1LLLLL); $aCustom["list_data"]["path"] =$this->tree->getPath($this->cid, "name", I7272, abs((int)$I1LLLLI[0]), abs((int)$I1LLLLI[1]), abs((int)$I1LLLLI[3]), abs((int)$I1LLLLI[2]), $I1LLLLl); }else {$this->cms->Gui->AddGlobalVars(Array('PARENT_COL' => I7227)); }$joinCondition =I7222; if($this->siteId >0) {$joinCondition .= " AND cat.id_site=parent.id_site"; }$sql ="select id, name from ".$this->oEshop->dbTablePrefix."_datasets where lang='".$this->langData."' order by is_sys desc, id"; if(isset($this->cms->Vars[I7261]) && $this->cms->Vars[I7261] >0){ $I1LLLL1 =$this->cms->Vars[I7261]; $this->cms->Gui->AddGlobalVars(Array('RELOAD_MODE' => "1")); }else{ $I1LLLL1 =isset($this->itemData["dataset_id"]) ?$this->itemData["dataset_id"] :null; }$this->db->query($sql); if(!isset($vData[I7273])){ $vData[I7273] =I7211; }while($this->db->next_record()){ $this->datasets[$this->db->Record[I7221]] =$this->db->Record[I7272]; $IIII111 =array("value" => $this->db->Record[I7221], I7272 => $this->db->Record[I7272], "selected" => $this->db->Record[I7221] == $I1LLLL1 ?"selected" :I7222); $vData[I7273] .= $this->cms->Gui->get($this->moduleName."_subform:dataset_option", $IIII111); }$this->browser->InitSQL("cat.id, cat.id_parent AS parent_id, cat.name,". "cat.announce, parent.name AS parentname, ". "cat.public AS cat_public, cat.count_childs, cat.count_public_childs, cat.instruct, cat.position, cat.dataset_id", "FROM ".$this->oEshop->dbTablePrefix."_cats cat LEFT JOIN ".$this->oEshop->dbTablePrefix."_cats parent ON cat.id_parent=parent.id".$joinCondition, " WHERE 1=1 ".$this->_ApplyFilters()." ".$this->filter->GetFilterSql(), I7222, "parentname", "cat.id desc", Array(I7274=>"cat.id_parent", "parentname"=>"parent.name", "cat_public"=>I7275), _DB_STRAIGHT_JOIN );$this->browser->AddSQLJoinedTables($this->cms->Core, 'cat', Array('parent'=>$this->oEshop->dbTablePrefix.'_cats')); $aCustom['fields'] += Array( I7276=>Array('action'=>'flagicon', 'value'=>1, 'id'=>I7277, 'on'=>$this->moduleName.'_list:public_on','off'=>$this->moduleName.'_list:public_off'), I7278=>Array('action'=>'stripline', 'size'=>50), 'parentname'=>Array(I7279=>'stripline', 'size'=>50), 'announce'=>Array(I7279=>'stripline', I7280=>80), 'instruct'=>Array(I7279=>'flagicon', 'value'=>1, 'off'=>$this->moduleName.'_list:operation_off', 'on'=>$this->moduleName.'_list:operation_on'), 'dataset_id'=>Array(I7279=>'callback', I7281=>&$this, 'method'=>'_datasetCB'), 'actions'=>Array(I7279=>'callback', I7281=>&$this, I7282=>'_actionsRow'), );$aCustom['applied_id'] ='cat.id'; $aCustom['legend'] =Array(); if($this->oEshop->itemCountersEnable) {$aCustom[I7283]["counter_product_header"] =$this->cms->Gui->getAbs($this->moduleName."_list:counter_product_header"); $aCustom['fields']['all_count'] =Array(I7279=>I7284, I7281=>&$this, I7282=>'_itemCountersRow'); }$aCustom['legend'][] ="published"; $aCustom['legend'][] =I7285; $aCustom['legend'][] ="leg_red"; $aCustom['legend'][] ="leg_yellow"; $aCustom[I7286][] ="leg_blue"; if($this->I1LLlI1) {$aCustom[I7286][] ="leg_operation_on"; $aCustom[I7286][] ="leg_operation_off"; }$aCustom[I7286][] ="leg_edit"; $aCustom[I7286][] =I7287; $aCustom["form_data"]["buttons"] =Array("add", "apply", I7288, "save"); parent::TTTlI11($vData, $aCustom); }function _datasetCB(&$aItem, &$aData){ if($aItem["dataset_id"] >0 && !empty($this->datasets[$aItem["dataset_id"]])) $aItem["dataset_name"] =$this->datasets[$aItem[I7289]]; else $aItem["dataset_name"] =I7222; }function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $this->tree->initResult(false); $this->itemData =$this->tree->getNode($cId, "edit"); if(is_array($this->itemData)) {$this->itemData["announce"] =$this->cms->htmlchars($this->itemData["announce"]); $this->itemData[I7290] =$this->cms->htmlchars($this->itemData[I7290]); if($this->I1LLlI1) {$this->itemData["instruction"] =$this->cms->htmlchars($this->itemData["instruction"]); }else {unset($this->itemData["instruction"]); }if($this->oEshop->otherPricesEnabled) {$this->itemData["update_checkboxes"] =$this->cms->Gui->getAbs($this->moduleName."_subform:update_checkboxes", I7222); }}}function TTIT11I($cId, $public, $parentCatPublic, $I1LLL1I, $action) {if($this->oEshop->itemCountersEnable) {if($public) {if($action == "publish") {$I1LLL1I =$this->oEshop->TT11I1T($cId); }if($I1LLL1I >0 || $parentCatPublic == 0) {$aSql =$this->oEshop->TT11I1I("+".$I1LLL1I, I7228); $aSql[I7228] =1; $aSql["modified_date"] ="=|NOW()"; $this->tree->TI11l11($cId, $aSql, true); }else {$this->tree->TI11l1T($cId, Array(I7228=>1, I7291=> "=|NOW()")); }}else {$this->tree->TI11l1I($cId, Array(I7228=>0, "count_public_childs"=>0, I7291=> "=|NOW()")); if($I1LLL1I >0) {$aSql =$this->oEshop->TT11I1I("-".$I1LLL1I, I7228); $aSql[I7291] =I7292; $this->tree->TI11l11($cId, $aSql, false); }}}else {if($public) {if($parentCatPublic) {$this->tree->TI11l1T($cId, Array(I7228=>1, I7291=> I7292)); }else {$this->tree->TI11l11($cId, Array(I7228=>1, I7291=> I7292), true); }}else {$this->tree->TI11l1I($cId, Array(I7228=>0, I7291=> I7292)); }}}function _ActionPublish($cId, $cModule) {$public =(isset($this->cms->Vars["publish"]) && $this->cms->Vars["publish"] == "on") ?1 :0; $I1LLL1l =true; if($public || $this->oEshop->itemCountersEnable) {$I1LLL1I =0; $this->tree->addJoinedTable("c2", I7293.$this->oEshop->dbTablePrefix."_cats AS c2 ON c.id_parent = c2.id"); $this->tree->TI11II1(); $I1LLL1L =$this->tree->getNode($cId, "counters_info"); $this->tree->TI11IlT(); if(is_array($I1LLL1L)) {$I1LLL11 =$I1LLL1L["cat_public"]; $parentCatPublic =$I1LLL1L["cat_parent_public"]; $parentCatId =$I1LLL1L[I7226]; $I1LLL1I =$I1LLL1L["count_public_childs"]; if($I1LLL11 == $public) {$I1LLL1l =false; }}}if($I1LLL1l) {$this->TTIT11I($cId, $public, $parentCatPublic, $I1LLL1I, "publish"); $this->cms->AddStatusMsg("status_publish"); $this->appliedId =$cId; $this->browser->SetApplied($this->db, $asql, $this->langData); }}function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); AMI_Eshop::updateCatProps(substr($this->oEshop->dbTablePrefix, 4), $this->appliedId); if($this->oEshop->ILlL1lI && $this->I1IL1Ll["isRootChanged"]) {$this->oEshop->TT1l11l($this->options["multi_sites"], $this->siteId, true); }}function TTTl1lI($cId, $cModule) {$I1LL1II =$this->tree->TI11lIl($cId); if($this->KeepItemCatId) {$sql ="SELECT id_parent, public, allow_fraction FROM ".$this->oEshop->dbTablePrefix."_cats WHERE id='".$cId."' AND lang='".$this->langData.I7216; $this->db->query($sql); if($this->db->next_record()) {$this->cms->Vars[I7230] =$this->cms->VarsPost[I7230] =$this->db->Record[I7226]; $this->cms->Vars[I7228] =$this->cms->VarsPost[I7228] =$this->db->Record[I7228]; }}parent::TTTl1lI($cId, $cModule); AMI_Eshop::updateCatProps(substr($this->oEshop->dbTablePrefix, 4), $cId); $I1LL1Il =!empty($this->cms->VarsPost["dataset_child"]); if($I1LL1Il){ $sql ="select dataset_id, dataset_data from ".$this->oEshop->dbTablePrefix.I7294.intval($cId); $this->db->query($sql); if($this->db->next_record()){ $ILLlIII =$this->db->Record; }else{ $ILLlIII =array(I7289 => "0", "dataset_data" => I7222); }}if($this->I1IL1Ll["isPIDsChanged"] || $I1LL1Il){ $ret =trim($this->tree->TI11lII($cId)); $ret =$cId.(empty($ret) ?I7222 :",").$ret; $I1LL1IL =array(); if($this->I1IL1Ll[I7295]){ $I1LL1IL["all_parents"] ="=|REPLACE(all_parents, ',".$I1LL1II.",', ',".$this->I1LLll1.",')"; }if($I1LL1Il){ $I1LL1IL[I7289] =$ILLlIII[I7289]; $I1LL1IL[I7296] =addslashes($ILLlIII[I7296]); }$sql =$this->db->GenUpdateSQL(I7222.$this->oEshop->dbTablePrefix."_cats", $I1LL1IL, "WHERE id in (".$ret.")"); $this->db->query($sql); }if (sizeof($this->I1IL1Ll) >0) {extract($this->I1IL1Ll); }if ($oldPublic != $public) {$this->cms->Vars['publish'] =$public ?I7297 :null; $this->_ActionPublish($cId, $cModule); }$this->cms->Vars["allow_cat_fraction"] =intval(!empty($this->cms->Vars["allow_fraction"])); $sql ="UPDATE `".$this->oEshop->dbTablePrefix."_items` SET allow_fraction = ".intval($this->cms->Vars[I7298])." WHERE id_category = '".$cId.I7216; $this->db->query($sql); $I1LL1I1 =Array(); $I1LL1lI =true; if($this->oEshop->ILlL1lI) {if(isset($newIdSite) && $newIdSite != $idSite) {$I1LL1I1 += Array("id_site"=>$newIdSite); $I1LL1lI =false; }}$this->tree->TI11Il1("_id_site"); if ($this->oEshop->itemCountersEnable) {if ($oldParentId != $parent) {$IIL1ILL =$this->oEshop->TT11I1I('+', I7299, array ('count_childs' => $oldCountChilds, 'count_public_childs' => $oldCountPublicChilds ));$this->tree->TI11l11($parent, $IIL1ILL, true); foreach ($IIL1ILL as $key => $value) {$IIL1ILL[$key] =str_replace(array ('+', '-', I7300), array (I7300, '+', '-'), $value); }$this->tree->TI11l11($oldParentId, $IIL1ILL, true); }}else {if($oldPublic != $public) {if($public) {if($parentCatPublic) {$this->tree->TI11l1T($cId, Array(I7228=>1)); }else {$this->tree->TI11l11($cId, Array(I7228=>1), true); }}else {$I1LL1lI =false; $I1LL1I1 += Array(I7228=>0, "count_public_childs"=>0); }}if($oldParentId != $parent) {if(!$newParentPublic && $public && !$I1LL1lI) {$I1LL1lI =false; $I1LL1I1 += Array(I7228=>0, "count_public_childs"=>0); }}}if($this->oEshop->ILlL1lI && $isRootChanged) {$this->oEshop->TT1l11l($this->options[I7301], $this->siteId, true); }$I1LL1ll =$this->TIIT111($this->oEshop->otherPricesEnabled && !empty($this->cms->VarsPost["update_all"]), $pricesChanged, $aPrices, $catIds); $I1LL1lL =$catIds; if($this->oEshop->otherPricesEnabled && !empty($this->cms->VarsPost["update_all"])) {$I1LL1I1 += Array( I7238 => $price0, "lang"=>$this->langData );$isError =false; if (!is_array($aPricesSql)) {$aPricesSql =array ();$isError =true; }if (!is_array($aPrices)) {$aPrices =array ();$isError =true; }if ($isError) {$this->cms->AddStatusMsg('status_wrong_category_price', I7302); }$I1LL1I1 += $aPricesSql; $I1LL1I1 += $aPrices; $I1LL1lI =false; }$I1LL1l1 =$this->TIIT11l($I1LL1ll, $I1LL1I1, $I1LL1lI); if($I1LL1l1["affected"] >0) $this->cms->AddStatusMsg("status_subcat_apply", "blue", I7222, I7222, Array("num" => $I1LL1l1[I7303].I7222)); if($this->oEshop->ILlL1lI && $newIdSite != $idSite) {$I1LL1LI =Array("id_site"=>$newIdSite); if(empty($I1LL1lL)) $I1LL1lL =$this->tree->TI11lII($this->appliedId); if($I1LL1lL != I7222) {$I1LL1lL .=",".$this->appliedId; }else {$I1LL1lL =$this->appliedId; }$sql =$this->db->GenUpdateSQL(I7222.$this->oEshop->dbTablePrefix."_items", $I1LL1LI, "WHERE lang='".$this->langData."' AND id_category IN(".$I1LL1lL.")"); $this->db->query($sql); }if($pricesChanged) {if($I1LL1ll["prices"] != I7222) $I1LL1ll["prices"] .=",".$this->appliedId; else $I1LL1ll[I7304] =$this->appliedId; if($I1LL1ll["all"] != I7222) $I1LL1ll["all"] .= ",".$this->appliedId; else $I1LL1ll["all"] =$this->appliedId; }$this->TIIITIl($I1LL1ll); $this->tree->TI11Ill(I7305); if($this->oEshop->otherPricesEnabled && !empty($I1LL1ll[I7304])) {$I1LL1Ll =Array(); for($i=0;$i<$this->oEshop->numPrices;$i++) {$numPrice =I7238.$this->oEshop->priceFields[$i]; $aTmp =$this->oEshop->TT11TlT($aPrices[$numPrice]); $aPrices[$this->oEshop->priceFields[$i]] =str_replace(I7238, "\$price", $aTmp[I7238]); $I1LL1LL =$this->oEshop->TT11IlI($aPrices[$numPrice]); $I1LL1Ll[$this->oEshop->priceFields[$i]] =$I1LL1LL["php"]; }$I1LL1L1 =($this->cms->VarsPost["update_force"]); $aOrders =I7222; $II11LLI =I7222; if($this->oEshop->TT11Il1($I1LL1Ll, $aOrders)) {$one =1; foreach($aOrders as $index => $numPrice) {if(empty($numPrice)) {continue; }$ILLIlII =$numPrice -1; $I1LL1LL =$this->oEshop->TT11TlT($aPrices[$numPrice]); $I1LL11I =$I1LL1LL[I7238]; if($I1LL11I == I7222) {if($I1LL1L1) {$II11LLI .= I7238.$numPrice."=NULL,"; }else {$II11LLI .= I7238.$numPrice."=IF( (price_mask & ".($one << $ILLIlII).") > 0, NULL, price".$numPrice."),"; }}elseif(is_numeric($I1LL11I)) {}else {$expr =$this->oEshop->TT11IlI($aPrices[I7238.$numPrice]); if($I1LL1L1) {$II11LLI .= I7238.$numPrice."=".$expr["mysql"].I7306; }else {$II11LLI .= I7238.$numPrice."=IF( (price_mask & ".($one << $ILLIlII).") > 0, ".$expr["mysql"].", price".$numPrice.I7307; }}}}if(isset($priceMask)){ $II11LLI .= $I1LL1L1 ?"price_mask=" .$priceMask :"price_mask=(price_mask & " .$priceMask.")"; }}$this->TIIITTI($this->oEshop->otherPricesEnabled && !empty($I1LL1ll[I7304]), $I1LL1ll, rtrim($II11LLI, ',')); $this->TIIITTl(); if ($this->_useShippingModule) {$this->TIIITT1(); }if (isset($this->cms->VarsPost["tax_apply_to_products"])) {$this->TIIITIT(); }}function TIIT11l($I1LL11l, &$I1LL1I1, &$I1LL1lI) {$res =array(); if(!isset($I1LL11l["all_arr"]) || !is_array($I1LL11l["all_arr"])) $I1LL11l["all_arr"] =array(); if(count($I1LL11l["all_arr"]) >0) if(!$I1LL1lI){ $this->tree->TI11l1T($I1LL11l[I7308], $I1LL1I1); $I1LL1lI =false; }$res[I7303] =count($I1LL11l[I7308]); return $res; }function TIIT111($I1LL11L, $I1LL111, &$aPrices, &$I1L1III, $I1L1IIl =false){ $res =Array(); if($I1LL11L || $I1L1IIl){ if($I1LL11L){ if(!$I1LL111) {$this->tree->TI11III("for_update", "1 as ispricechanged"); }}$this->I1LLllL =array(); $ret =$this->tree->getAllChilds($this->appliedId, "for_update"); if(is_array($ret[I7220])) $res =$ret[I7220]; if(isset($res[I7219])) $I1L1III =$res[I7219]; else $I1L1III =I7222; }return $res; }private function TIIITTT($I1L1IIL, $I1L1II1){ $I1L1IlI =array(); $sql ="SELECT cc.id AS id_copy, co.id AS id_original FROM ".$this->oEshop->dbTablePrefix."_items cc LEFT JOIN ".$this->oEshop->dbTablePrefix."_items co ON cc.id_source=co.id WHERE cc.id_source>0 AND co.id_category IN (".$I1L1IIL.")"; $this->db->query($sql); while($this->db->next_record()){ if($I1L1II1){ if(!in_array($this->db->Record['id_copy'], $I1L1IlI)){ $I1L1IlI[] =$this->db->Record['id_copy']; }}else{ $I1L1Ill =$this->db->Record[I7309]; if(!isset($I1L1IlI[$I1L1Ill])){ $I1L1IlI[$I1L1Ill] =array(); }$I1L1IlI[$I1L1Ill][] =$this->db->Record['id_copy']; }}return $I1L1IlI; }function TIIITTI($I1L1IlL, &$I1LL1ll, $II11LLI){ if($I1L1IlL) {if(!empty($I1LL1ll[I7304])) $I1L1Il1[I7304] =explode(I7306, $I1LL1ll[I7304]); else $I1L1Il1[I7304] =array(); if(!empty($I1LL1ll["watermarks"])) $I1L1Il1["watermarks"] =explode(I7306, $I1LL1ll["watermarks"]); else $I1L1Il1[I7310] =array(); $I1L1IlI =$this->TIIITTT($I1LL1ll["all"], false); $sql ="SELECT items.id, items.id_category, items.ext_popup_picture, items.ext_picture, items.ext_small_picture ". "FROM ".$this->oEshop->dbTablePrefix."_items items WHERE items.lang='".$this->langData."' AND items.id_category IN(".$I1LL1ll["all"].") AND id_source=0 ORDER BY items.id_category"; $this->db->query($sql); $numItems =$this->db->num_rows(); $numItemsLeft =$numItems; if($numItems >0) {$numItemsLeft --; $itemIds ="-1"; $I1L1ILI =800; $num =0; $I1L1ILl =-1; $I1L1ILL =$this->cms->Core->GetOption("script_time_limit"); $db2 =new DB_si; $I1L1IL1 ="UPDATE LOW_PRIORITY ".$this->oEshop->dbTablePrefix."_items SET %s WHERE id IN(%s)"; while($this->db->next_record()) {$I1L1I1I =10*intval(in_array($this->db->Record["id_category"], $I1L1Il1[I7310]))+intval(in_array($this->db->Record["id_category"], $I1L1Il1[I7304])); if($I1L1ILl == -1) $I1L1ILl =$I1L1I1I; if($I1L1ILl == $I1L1I1I){ $this->TIIITII($I1L1I1I, $this->db->Record); $itemIds .= I7306.$this->db->Record[I7221]; if(isset($I1L1IlI[$this->db->Record[I7221]]) && sizeof($I1L1IlI[$this->db->Record[I7221]]) >0){ $itemIds .= I7306 .implode(',', $I1L1IlI[$this->db->Record[I7221]]); }$num++; }$I1L1I1l =false; if($numItemsLeft == 0 || $num == $numItems || $num >$I1L1ILI || $I1L1ILl != $I1L1I1I) {$sql =sprintf($I1L1IL1, $this->TIIITI1($II11LLI, $I1L1ILl), $itemIds); $db2->query($sql); $num =1; $itemIds =I7311; set_time_limit($I1L1ILL); if($I1L1ILl != $I1L1I1I) $I1L1I1l =true; $I1L1ILl =$I1L1I1I; }if($I1L1I1l){ $this->TIIITII($I1L1I1I, $this->db->Record); $itemIds .= I7306.$this->db->Record[I7221]; if(isset($I1L1IlI[$this->db->Record[I7221]]) && sizeof($I1L1IlI[$this->db->Record[I7221]]) >0){ $itemIds .= I7306 .implode(',', $I1L1IlI[$this->db->Record[I7221]]); }$num++; }}$sql ="SELECT id FROM ".$this->oEshop->dbTablePrefix."_items LIMIT 1"; $db2->query($sql); }}}function TIIITTl() {if (!isset($this->cms->VarsPost["discount_apply_to_subcategories"]) && (!$this->_useShippingModule || !isset($this->cms->VarsPost["shipping_type_apply_to_subcategories"])) && !isset($this->cms->VarsPost["tax_apply_to_subcategories"]) ){return; }$this->I1LLlLL =$this->tree->TI11llT($this->id); if (mb_strlen($this->I1LLlLL) <1) {return; }$I1L1I1L =$this->cms->VarsPost[I7252] ?$this->cms->VarsPost[I7252] :$this->I1LLlLl; $I1L1I11 =array(); if (isset($this->cms->VarsPost["discount_apply_to_subcategories"])) {$I1L1I11[] ="`id_discount` = '" .$this->cms->VarsPost["id_discount"] .I7216; }if ($this->_useShippingModule && isset($this->cms->VarsPost["shipping_type_apply_to_subcategories"])) {$I1L1I11[] ="`id_shipping_type` = '" .$I1L1I1L .I7216; }if (isset($this->cms->VarsPost["tax_apply_to_subcategories"])) {$I1L1lII =$this->I1LLlII->TIl1I1l($this->action, $this->cms->VarsPost); $I1L1I11[] ="tax_class_type = '".$I1L1lII["aSql"][I7312].I7216. ", id_tax_class = '".$I1L1lII["aSql"]["id_tax_class"].I7216; }if (sizeof($I1L1I11)) {$sql ="UPDATE `" .$this->oEshop->dbTablePrefix .I7313 ."SET ".implode(I7306, $I1L1I11)." ". "WHERE `id` IN (" .$this->I1LLlLL .")"; $this->db->query($sql); }}function TIIITT1() {if (!isset($this->cms->VarsPost["shipping_type_apply_to_products"])) {return; }$I1IILLL =isset($this->cms->VarsPost["shipping_type_apply_to_subcategories"]) ?(is_null($this->I1LLlLL) ?$this->tree->TI11llT($this->id) :$this->I1LLlLL) :I7222; $I1IILLL =$this->appliedId .(mb_strlen($I1IILLL) >0 ?I7306 .$I1IILLL :I7222); $I1L1IlI =$this->TIIITTT($I1IILLL, true); $sql ="UPDATE `" .$this->oEshop->dbTablePrefix ."_items` " ."SET `id_shipping_type` = '" .$this->cms->VarsPost[I7252] .I7314 ."WHERE `id_category` IN (" .$I1IILLL .")". (sizeof($I1L1IlI) >0 ?' OR id IN (' .implode($I1L1IlI) .')' :I7211); $this->db->query($sql); }function TIIITIT() {if (!isset($this->cms->VarsPost["tax_apply_to_products"])) {return; }$I1IILLL =isset($this->cms->VarsPost["tax_apply_to_subcategories"]) ?(is_null($this->I1LLlLL) ?$this->tree->TI11llT($this->id) :$this->I1LLlLL) :I7222; $I1IILLL =$this->appliedId .(mb_strlen($I1IILLL) >0 ?I7306 .$I1IILLL :I7222); $I1L1lII =$this->I1LLlII->TIl1I1l($this->action, $this->cms->VarsPost); $I1L1IlI =$this->TIIITTT($I1IILLL, true); $sql ="UPDATE `" .$this->oEshop->dbTablePrefix ."_items` " ."SET `tax_class_type` = '".$I1L1lII[I7315][I7312]."',". "`id_tax_class` = '".$I1L1lII[I7315]["id_tax_class"].I7314. "WHERE `id_category` IN (" .$I1IILLL .I7316. (sizeof($I1L1IlI) >0 ?' OR id IN (' .implode($I1L1IlI) .')' :I7211); $this->db->query($sql); }function TIIITII($fmt, &$vData) {}function TIIITIl(&$I1LL1ll) {}function TIIITI1(&$II11LLI, $fmt){ return $II11LLI; }function TTTlITT($IIIL11l, $cId, $cModule =I7211) {switch($IIIL11l) {case "del_confirm": $this->TIIITlT($cId); break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); }}function TTT1Tl1($cType, $cModule, $condition =I7211) {switch($cType) {case "counters": $sql =I7317.$this->oEshop->dbTablePrefix."_cats SET count_childs=0, count_public_childs=0, public=IF(public !=0, 1, 0) WHERE lang='".$this->langData.I7216; $this->db->query($sql); $sql ="SELECT c.id, count(i.id) as count_childs, SUM(IF(i.public !=0, 1, 0)*c.public) AS count_public_childs FROM ".$this->oEshop->dbTablePrefix."_cats c". " INNER JOIN ".$this->oEshop->dbTablePrefix."_items i ON i.id_category=c.id AND i.lang=c.lang". " WHERE c.lang='".$this->langData."' GROUP BY c.id"; $this->db->query($sql); $db2 =new DB_si; while($this->db->next_record()) {$sql =I7317.$this->oEshop->dbTablePrefix."_cats SET count_childs='".$this->db->Record["count_childs"]."', count_public_childs='".$this->db->Record["count_public_childs"]."' WHERE id='".$this->db->Record[I7221].I7216; $db2->query($sql); set_time_limit(30); }$this->TTIlTlT(0, $this->langData); $this->cms->AddStatusMsg('status_repair_counters', 'blue'); break; default: parent::TTT1Tl1($cType, $cModule, $condition); if (empty($condition)) {$sql =I7318.$this->oEshop->dbTablePrefix."_cats WHERE lang='".$this->langData.I7216; $this->db->query($sql); $I1L1lIl =array(); while($this->db->next_record()){ $I1L1lIl[] =$this->db->Record[I7221]; }for($i =0; $i <sizeof($I1L1lIl); $i++){ $I1L1lIL =$this->tree->TI11lIl($I1L1lIl[$i]); $sql =$this->db->GenUpdateSQL($this->oEshop->dbTablePrefix."_cats", array("all_parents" => I7306.$I1L1lIL.I7306), "WHERE id='".$I1L1lIl[$i].I7216); $this->db->query($sql); }}}}function TTIlTlT($parentId, $langData) {$db =new DB_si(); $sql ="SELECT id, count_childs, count_public_childs FROM ".$this->oEshop->dbTablePrefix."_cats WHERE id_parent='".$parentId."' AND lang='".$langData.I7216; $db->query($sql); $res =Array('count_childs'=>0, 'count_public_childs'=>0); while($db->next_record()) {$aCounters =$this->TTIlTlT($db->Record[I7221], $langData); $res[I7319] += $db->Record[I7319] +$aCounters[I7319]; $res["count_public_childs"] += $db->Record["count_public_childs"] +$aCounters["count_public_childs"]; }$sql =I7317.$this->oEshop->dbTablePrefix."_cats SET count_childs=count_childs+".$res[I7319].", count_public_childs=count_public_childs+".$res["count_public_childs"]." WHERE id='".$parentId.I7216; $db->query($sql); return $res; }function TIIITlT($cId) {if($cId >0) {$this->tree->TI11IIT("del_parent_info", "c.name, c.count_childs, c.count_public_childs, parent.name AS parent, c.id_site"); $this->tree->addJoinedTable(I7320, I7293.$this->oEshop->dbTablePrefix."_cats AS parent ON c.id_parent = parent.id"); $this->tree->TI11II1(); $I1LLL1L =$this->tree->getNode($cId, "del_parent_info"); $this->tree->TI11IlT(); if(is_array($I1LLL1L) && $I1LLL1L[I7226] >0){ $id_parent =$I1LLL1L[I7226]; $parent =$I1LLL1L[I7230]; $name =$I1LLL1L[I7272]; $II1111L =$I1LLL1L[I7319]; $I1LLL1I =$I1LLL1L["count_public_childs"]; $siteId =$I1LLL1L["id_site"]; if($this->cms->Vars[I7321] == "del") {$I1L1lI1 =$this->tree->TI11lII($cId); if($I1L1lI1 != I7222) {$I1L1lI1 .= I7306; }$I1L1lI1 .= $cId; $itemIds =$this->oEshop->TT111lT($I1L1lI1, Array("item_type")); $I1L1llI =sizeof($itemIds["fields"]); $this->TIIITl1($I1L1lI1, $itemIds); if($I1L1llI >0) {$itemData =Array(); foreach($itemIds["fields"] as $ILL11lL=>$itemType) {$itemData[$itemType[I7322]][] =$ILL11lL; }foreach($itemData as $itemType=>$aIds) {$I1L1lll =Array(I7322=>$itemType); $this->oEshop->TTT1lI1("after_del", $aIds, $I1L1lll, $this->oEshop->NONE); }}$sql ="DELETE FROM ".$this->oEshop->dbTablePrefix."_items WHERE id_category IN(".$I1L1lI1.I7316; $this->db->query($sql); $I1L1llL =$this->db->affected_rows(); if($this->cms->Vars["parent_skip"]) {$I1L1lI1 =str_replace(I7306.$cId, I7222, $I1L1lI1); $I1L1lI1 =str_replace($cId, I7222, $I1L1lI1); }if (!empty($I1L1lI1)) {$sql =I7323.$this->oEshop->dbTablePrefix."_cats WHERE id IN(".$I1L1lI1.I7316; $this->db->query($sql); $I1L1ll1 =$this->db->affected_rows() -1; $this->cms->AddStatusMsg("cat_deleted2", I7222, I7222, I7222, Array(I7272=>$name ,I7230=>$parent)); if($I1L1ll1 >0) {$this->cms->AddStatusMsg("subcat_deleted", I7222, I7222, I7222, Array("num"=>$I1L1ll1.I7222)); }}if($I1L1llL >0) {$this->cms->AddStatusMsg(I7324, I7222, I7222, I7222, Array("num"=>$I1L1llL.I7222)); }$aSql =$this->oEshop->TT11I1I("-", "both", Array("count_public_childs"=>$I1LLL1I, I7319=>$II1111L)); $this->tree->TI11l11($id_parent, $aSql, true); }elseif($this->cms->Vars[I7321] == I7325) {$I1L1lLI =intval($this->cms->Vars[I7226]); if($I1L1lLI >0) {$this->tree->TI11IIT("public_name", "public, name, id_site"); $this->TIIITlI("public_name"); $I1LLL1L =$this->tree->getNode($I1L1lLI, "public_name"); if(is_array($I1LLL1L)) {$parent =$I1LLL1L[I7272]; $parentPublic =$I1LLL1L[I7228]; $I1LL1I1 =Array(); $I1L1lLl =false; if($this->oEshop->ILlL1lI) {$I1L1lLL =$I1LLL1L[I7326]; $this->TIIIT1T($I1LL1I1, $cId, $I1L1lLL, $siteId); $I1L1lLl =($siteId != $I1L1lLL); $isRootChanged =isset($I1LL1I1[I7242]); }$I1L1lL1 =I7222; if(!$parentPublic) {$I1L1l1I =0; $I1L1lL1 =$this->tree->TI11l1I($cId, Array(I7228=>"0") +$I1LL1I1, "nodes_id"); $I1L1lLl =false; }else {$I1L1l1I =$I1LLL1I; }$this->TIIITll($I1LLL1L, $I1L1lL1, $cId); if($I1L1lLl) {$I1L1lL1 =$this->tree->TI11l1I($cId, $I1LL1I1, "nodes_id"); }if($siteId != $I1L1lLL && $I1L1lL1 != I7222) {$sql =I7317.$this->oEshop->dbTablePrefix."_items SET id_site='".$I1L1lLL."' WHERE id_category IN(".$I1L1lL1.I7316; $this->db->query($sql); }$sql =I7323.$this->oEshop->dbTablePrefix."_cats WHERE id = '".$cId.I7216; $this->db->query($sql); $sql =I7317.$this->oEshop->dbTablePrefix."_items SET id_category = '".$I1L1lLI."' WHERE id_category = '".$cId.I7216; $this->db->query($sql); $_tmp =I7222; $this->TTT1ll1($_tmp, $I1L1lLI, "apply", true); $sql =I7317.$this->oEshop->dbTablePrefix."_cats SET id_parent = '".$I1L1lLI."' WHERE id_parent = '".$cId.I7216; $this->db->query($sql); $this->cms->AddStatusMsg("cat_deleted", I7222, I7222, I7222, Array(I7272=>$name ,I7230=>$parent)); $aSql =$this->oEshop->TT11I1I("-", "both", Array("count_public_childs"=>$I1LLL1I, I7319=>$II1111L)); $this->tree->TI11l11($id_parent, $aSql, true); $aSql =$this->oEshop->TT11I1I("+", "both", Array("count_public_childs"=>$I1L1l1I, I7319=>$II1111L)); $this->tree->TI11l11($I1L1lLI, $aSql, true); }}}}}}function TIIITlI($name) {}function TIIITll($I1LLL1L, $I1L1lL1, $cId) {}function TIIITl1(&$I1L1lI1, &$itemIds){ $IIlLIIL =Array(I7266=>"process_del_cats", I7221=>$cId, I7327=>Array("del_cats" => $I1L1lI1, "del_items" => $itemIds)); $this->TTT1lI1($IIlLIIL); }function _ActionDel($cId, $cModule) {if($this->action == "del") {$form =Array(); $form[I7221] =$cId; $I1L1l1l =Array(); $I1L1l1L =I7222; $this->tree->setCallbackMethod("buildTreeOnChildsArray", "_popupBuildTreeOnChildsArrayCB"); $this->tree->createChildsArrayFlt(I7272); $this->tree->initResult(Array("cat_select"=>I7222, "selected_id"=>$cId)); $ILLILI1 =$this->tree->buildTreeOnChildsArray(); $form["content"] =$this->cms->Gui->getAbs($this->moduleName."_subform:del_popup_form", $form +$ILLILI1); $form[I7328] =$this->cms->Words["eshop_delete_form"]; $form["form_align"] ="align=center"; $IILIIIL ="del_popup"; parent::TTT1I1I($form, $IILIIIL); }}function TTTl1IT($cId, $cModule) {$sql =I7323.$this->oEshop->dbTablePrefix."_items WHERE lang='".$this->langData.I7216.(($this->options[I7301])? " AND id_site='".$this->siteId.I7314: I7222); $this->db->query($sql); if($this->oEshop->itemCountersEnable) {$sql =I7317.$this->oEshop->dbTablePrefix."_cats SET count_public_childs=0, count_childs=0 WHERE id = '".$this->oEshop->rootCatId.I7216; $this->db->query($sql); }parent::TTTl1IT($cId, $cModule); }function TTT1Il1(&$aSql) {$aResult =parent::TTT1Il1($aSql); $I1L1l11 =isset($aSql['all_parents']) ?explode(',', $aSql[I7329]) :array(); $I1L1LII =1; for($i =0; $i <sizeof($I1L1l11); $i++){ if(!empty($I1L1l11[$i])){ $I1L1LII++; }}$aResult[1] =max(1, 6-$I1L1LII); if($aSql[I7226] >0 && $aSql[I7226] != $this->oEshop->rootParentCatId) {$this->tree->initResult(false); $res =$this->tree->getNode($aSql[I7226], "sublink"); if($res !== false) {$aResult[0] =$res["sublink"]; }}return $aResult; }function TTT1TT1(&$aGroupIds, $cModule, $IIl1l1l =I7211){ $pfx =$this->options['default_prefix']; parent::TTT1TT1( $aGroupIds, $cModule, $IIl1l1l .', ' .$pfx .I7330 .$pfx .'id_parent' );}function TTT1IlI($aSql =Array(), $cId =0) {$aEvent =array( 'modId' => $this->moduleName, 'catId' => $cId, 'aData' => &$aSql, I7331 => $this );AMI_Event::fire('v5_on_before_prepare_cat_data', $aEvent, AMI_Event::MOD_ANY); $parent =intval($this->cms->VarsPost[I7230]); if($this->I1LLl1l && $cId && $parent == $cId){ $parent =0; }$subLink =$this->cms->VarsPost["sublink"]; $this->cms->VarsPost["is_price_list"] =intval(!empty($this->cms->VarsPost["is_price_list"])); $public =intval($this->cms->VarsPost[I7228]); $ILLIII1 =intval(!empty($this->cms->VarsPost[I7332])); $siteId =-1; if($this->siteId >0) {$siteId =$this->siteId; }else {if(isset($this->cms->VarsPost[I7326])) {$siteId =intval($this->cms->VarsPost[I7326]); }}$price =$this->oEshop->TT111IT($this->cms->VarsPost); if(!empty($this->cms->VarsPost[I7272]) && ($parent >= 0) && is_array($price)) {$price0 =doubleval($this->cms->VarsPost[I7238]); $aSql[I7272] =$this->cms->VarsPost[I7272]; $aSql[I7289] =intval($this->cms->VarsPost[I7261]); $aSql[I7296] =I7222; TlT1IIT(Array("announce", I7290, "is_price_list"), $this->cms->VarsPost, $aSql, ($this->action == "apply")); $I1L1LIl =0; if(isset($this->cms->VarsPost["on_special"]) && is_array($this->cms->VarsPost[I7333])) {foreach($this->cms->VarsPost[I7333] as $ILLIIL1 => $value) {$I1L1LIl =($I1L1LIl |intval($value)); }}$aSql[I7226] =$parent; $aSql[I7238] =$price0; $aSql[I7332]= $ILLIII1; $aSql[I7228] =$public; $aSql["lang"] =$this->langData; if($this->I1LLlL1 >0) {$aSql["special_flag"] =$I1L1LIl; }if($cId >0 && empty($aSql[I7289])){ $sql ="select dataset_id, id='".$parent."' as parent from ".$this->oEshop->dbTablePrefix.I7334.$cId."' OR id='".$parent."') AND (dataset_id > 0) ORDER BY parent ASC"; $this->db->query($sql); if($this->db->next_record()){ $aSql[I7289] =intval($this->db->Record[I7289]); $aSql[I7296] =array(); }}$sql =I7222; $aSql[I7296] =array(); if($aSql[I7289] >0) $sql ="select * from ".$this->oEshop->dbTablePrefix."_datasets where id=".intval($aSql[I7289]); else $sql =I7335.$this->oEshop->dbTablePrefix."_datasets where is_sys=1 AND lang='".$this->langData.I7216; $this->db->query($sql); if($this->db->next_record()){ $aSql[I7289] =intval($this->db->Record[I7221]); $aSql[I7296] =addslashes(serialize(array( I7263 => $this->db->Record[I7263], I7272 => $this->db->Record[I7272], "fields_map" => $this->db->Record["fields_map"], I7264 => $this->db->Record[I7264], "fields_filter" => $this->db->Record[I7336], "fields_show_empty" => $this->db->Record["fields_show_empty"], I7265 => unserialize($this->db->Record[I7265]), "sku_map" => $this->db->Record["sku_map"]))); }if($this->I1LLlI1) {$this->cms->VarsPost[I7337] =intval($this->cms->VarsPost[I7337]); TlT1IIT(Array(I7337, "instruction"), $this->cms->VarsPost, $aSql, ($this->action == "apply")); }$this->I1IL1Ll["price0"] =$price0; if($this->oEshop->otherPricesEnabled) {$aSql += $price; $this->I1IL1Ll["aPrices"] =$price; $this->I1IL1Ll[I7338] =$this->oEshop->TT11IIT(I7239, $this->cms->VarsPost); $aSql += $this->I1IL1Ll[I7338]; }$this->tree->TI11Il1(I7305); if($this->action == "apply") {$sql ="SELECT id_parent, id_discount, id_shipping_type FROM ".$this->oEshop->dbTablePrefix."_cats WHERE id='".$cId.I7216; $this->db->query($sql); if($this->db->next_record()) {$I1L1LIL =$this->db->Record[I7226]; $I1L1LI1 =$this->db->Record['id_discount']; $I1L1LlI =$this->db->Record[I7339]; $this->I1IL1Ll["priceMask"] =$priceMask =$this->oEshop->TT111Il($price); $this->I1IL1Ll["oldParentId"] =$parent; $this->I1IL1Ll["oldPublic"] =true; $this->I1IL1Ll["parentPublic"] =true; $this->I1IL1Ll[I7340] =0; $this->I1IL1Ll["oldCountPublicChilds"] =0; $this->I1IL1Ll[I7230] =$parent; $I1L1Lll =I7222; if($this->oEshop->otherPricesEnabled) {for($i=0;$i<$this->oEshop->numPrices;$i++) {$I1L1Lll .= " OR (c.price".$this->oEshop->priceFields[$i]."!='".$this->I1IL1Ll["aPrices"][I7238.$this->oEshop->priceFields[$i]].I7341; }if($I1L1Lll != I7222) {$I1L1Lll =", ( (0=1)".$I1L1Lll.") AS prices_cnange"; }}if($I1L1LIL >0) {$this->tree->TI11IIT("apply1", "c.id_site, c.is_root, c.id_parent, c.count_childs, c.count_public_childs, c.public, c2.id_site AS parent_id_site, c2.public AS parent_public, c2.id_discount, c2.id_shipping_type".$I1L1Lll); $this->tree->addJoinedTable(I7320, I7293.$this->oEshop->dbTablePrefix."_cats AS c2 ON c.id_parent = c2.id"); $this->tree->TI11II1(); $I1LLL1L =$this->tree->getNode($cId, "apply1"); $this->tree->TI11IlT(); if(is_array($I1LLL1L)){ $this->I1IL1Ll["oldParentId"] =$I1LLL1L[I7226]; $this->I1IL1Ll[I7340] =$I1LLL1L[I7319]; $this->I1IL1Ll["oldCountPublicChilds"] =$I1LLL1L["count_public_childs"]; $this->I1IL1Ll[I7342] =$I1LLL1L[I7228]; $this->I1IL1Ll["parentPublic"] =$I1LLL1L["parent_public"]; $this->I1IL1Ll["parentIdSite"] =$I1LLL1L["parent_id_site"]; $this->I1IL1Ll[I7343] =$I1LLL1L[I7326]; $this->I1IL1Ll["_isRoot"] =$I1LLL1L[I7242]; if (!isset($this->cms->VarsPost["from_backend"]) || isset($this->cms->VarsPost["id_discount"])) {$aSql["id_discount"] =isset($this->cms->VarsPost[I7344]) ?intval($this->cms->VarsPost[I7344]) :($I1L1LI1 ?$I1L1LI1 :$I1LLL1L[I7344]); }if (!isset($this->cms->VarsPost["from_backend"]) || isset($this->cms->VarsPost[I7252])) {$aSql[I7252] =isset($this->cms->VarsPost[I7252]) ?intval($this->cms->VarsPost[I7252]) :($I1L1LlI ?$I1L1LlI :$I1LLL1L[I7252]); }}}else {$this->tree->TI11IIT("apply1", "c.id_site, c.is_root, c.count_childs, c.count_public_childs, c.public, c.id_discount, c.id_shipping_type".$I1L1Lll); $I1LLL1L =$this->tree->getNode($cId, "apply1"); if(is_array($I1LLL1L)){ $this->I1IL1Ll[I7340] =$I1LLL1L[I7319]; $this->I1IL1Ll["oldCountPublicChilds"] =$I1LLL1L["count_public_childs"]; $this->I1IL1Ll[I7342] =$I1LLL1L[I7228]; $this->I1IL1Ll[I7343] =$I1LLL1L[I7326]; $this->I1IL1Ll["_isRoot"] =$I1LLL1L[I7242]; if (!isset($this->cms->VarsPost["from_backend"]) || isset($this->cms->VarsPost[I7344])) {$aSql[I7344] =isset($this->cms->VarsPost[I7344]) ?intval($this->cms->VarsPost[I7344]) :($I1L1LI1 ?$I1L1LI1 :$I1LLL1L[I7344]); }if (!isset($this->cms->VarsPost["from_backend"]) || isset($this->cms->VarsPost[I7252])) {$aSql[I7252] =isset($this->cms->VarsPost[I7252]) ?intval($this->cms->VarsPost[I7252]) :($I1L1LlI ?$I1L1LlI :$I1LLL1L[I7252]); }}$this->I1IL1Ll[I7345] =$this->I1IL1Ll[I7230] =0; $this->I1IL1Ll["parentIdSite"] =0; }if(isset($I1LLL1L["prices_cnange"]) && $I1LLL1L["prices_cnange"] >0) {$this->I1IL1Ll["pricesChanged"] =1; }else {$this->I1IL1Ll[I7346] =0; }$this->I1IL1Ll[I7228] =$public; if($this->I1IL1Ll[I7345] == $parent) {$this->I1IL1Ll[I7340] =0; $this->I1IL1Ll[I7295] =0; }else {$this->I1IL1Ll[I7295] =1; }$this->I1LLll1 =$this->tree->TI11lIl($parent, true); $this->I1IL1Ll["newParentIdSite"] =$this->I1IL1Ll["parentIdSite"]; $this->I1IL1Ll["newParentPublic"] =$this->I1IL1Ll["parentPublic"]; if($this->I1IL1Ll[I7345] != $parent) {$this->tree->TI11IIT(I7347, "c.public, c.id_site"); $I1LLL1L =$this->tree->getNode($parent, I7347); $this->I1IL1Ll["newParentPublic"] =false; if(is_array($I1LLL1L)) {$this->I1IL1Ll["newParentPublic"] =$I1LLL1L[I7228]; $this->I1IL1Ll["newParentIdSite"] =$I1LLL1L[I7326]; }}if($this->oEshop->ILlL1lI) {$this->I1IL1Ll[I7348] =$this->I1IL1Ll[I7343]; if($siteId == -1) {$siteId =$this->I1IL1Ll[I7343]; }if($this->I1IL1Ll["newParentIdSite"] != $this->I1IL1Ll[I7343] || ($this->I1IL1Ll[I7343] != $siteId)) {if($this->I1IL1Ll["newParentIdSite"] >0) {$this->TIIIT1T($aSql, $cId, $this->I1IL1Ll["newParentIdSite"], $siteId); }else {if($this->I1IL1Ll["parentIdSite"] >0) {$this->TIIIT1T($aSql, $cId, $this->I1IL1Ll[I7349], $siteId); }else {$this->TIIIT1T($aSql, $cId, $this->I1IL1Ll[I7349], $siteId); }}}if(isset($aSql[I7326])) {$this->I1IL1Ll[I7348] =$aSql[I7326]; }$this->I1IL1Ll["isRootChanged"] =(isset($aSql[I7242]) && ($aSql[I7242] != $this->I1IL1Ll["_isRoot"])); }}else {if (isset($this->cms->VarsPost[I7344])) {$aSql[I7344] =intval($this->cms->VarsPost[I7344]); }if ($this->_useShippingModule && isset($this->cms->VarsPost[I7252])) {$aSql[I7252] =intval($this->cms->VarsPost[I7252]); }}}elseif($this->action == "add") {$this->I1IL1Ll["isRootChanged"] =false; if($this->oEshop->ILlL1lI) {$this->tree->TI11IIT(I7350, I7244); $I1LLL1L =$this->tree->getNode($parent, I7350); $this->TIIIT1T($aSql, 0, $I1LLL1L[I7326], $siteId); $this->I1IL1Ll["isRootChanged"] =!empty($aSql[I7242]); }$this->I1LLll1 =$this->tree->TI11lIl($parent, true); $aSql["all_parents"] =I7306.$this->I1LLll1.I7306; if (isset($this->cms->VarsPost[I7344]) && $this->cms->VarsPost[I7252]) {$aSql[I7344] =intval($this->cms->VarsPost[I7344]); $aSql[I7252] =intval($this->cms->VarsPost[I7252]); }else {if ($parent >0) {$sql ="SELECT id_discount, id_shipping_type FROM " .$this->oEshop->dbTablePrefix ."_cats WHERE id = '" .$cId .I7216; $this->db->query($sql); if ($this->db->next_record()) {$id_discount =$this->db->Record[I7344]; $id_shipping_type =$this->db->Record[I7252]; }}if (isset($this->cms->VarsPost[I7344]) || isset($id_discount)) {$aSql[I7344] =isset($this->cms->VarsPost[I7344]) ?intval($this->cms->VarsPost[I7344]) :$id_discount; }if (isset($this->cms->VarsPost[I7252]) || isset($id_shipping_type)) {$aSql[I7252] =isset($this->cms->VarsPost[I7252]) ?intval($this->cms->VarsPost[I7252]) :$id_shipping_type; }}}$this->tree->TI11Ill(I7305); if($this->cid >0) {$this->cid =$parent; }}$I1L1lII =$this->I1LLlII->TIl1I1l($this->action, $this->cms->VarsPost, $aSql, $cId); $aSql =$I1L1lII[I7315]; $this->ILLILIL =array (I7351 => $aSql[I7278]); $this->cms->IIIlL11 =true; $aSql =parent::TTT1IlI($aSql, $cId); $this->cms->IIIlL11 =false; return $aSql; }function TIIIT1T(&$aSql, $cId, $I1L1LlL, $I1L1Ll1) {if(empty($I1L1LlL)) {$aSql[I7242] =0; $aSql[I7326] =0; if(!empty($I1L1Ll1)) {$I1L1LLI =$this->oEshop->TT111TI($I1L1Ll1); if($I1L1LLI >0) {if($I1L1LLI == $cId) {$aSql[I7326] =$I1L1Ll1; $aSql[I7242] =1; }}else {$aSql[I7326] =$I1L1Ll1; $aSql[I7242] =1; }}}else {$aSql[I7242] =0; $aSql[I7326] =$I1L1LlL; }}function _treeArrayCB(&$II11L1l, &$record, &$Il11L1l) {$II11L1l[] =Array(I7221=>$record[I7221], I7272=>$record[I7272], I7289=>$record[I7289]); }function _buildTreeOnChildsArrayCB(&$res, &$child, &$Il11L1l) {$indent =str_repeat("&middot;&nbsp;", $Il11L1l["level"]); if($res["current_id"] == $child[I7221]) {$this->I1IL1Ll["level"] =$Il11L1l[I7352]; $this->I1IL1Ll[I7231] =true; }elseif($this->I1IL1Ll[I7231]) {if($this->I1IL1Ll[I7352] >= $Il11L1l[I7352]) {$this->I1IL1Ll[I7231] =false; }}if(!$this->I1IL1Ll[I7231]) {$res[I7230] .= "<option value=\"".$child[I7221]."\"".(($res["selected_id"] == $child[I7221])?" selected":I7222).I7353.$indent.$this->cms->stripLine($child[I7272], 50, true); $res["datasets"][$child[I7221]] =$child[I7289]; }$res["aCatsNames"][] =Array(I7221=>$child[I7221], I7272=>($indent.$this->cms->stripLine($child[I7272],60))); return true; }function _popupBuildTreeOnChildsArrayCB(&$res, &$child, &$Il11L1l) {if($res["selected_id"] == $child[I7221]) {return false; }$indent =str_repeat("&middot;&nbsp;", $Il11L1l[I7352]); $res[I7354] .= "<option value=\"".$child[I7221]."\">".$indent.$this->cms->stripLine($child[I7272], 50, true); return true; }function _getPathCB(&$res, $itemId, $itemName, $stripItemName, &$Il11L1l) {if($Il11L1l["skip_item"]) {$res .= $this->cms->Gui->getAbs($this->moduleName."_list:path_skip_item", Array(I7355=>$stripItemName)); }else {if($Il11L1l["is_current"]) {$res .= $this->cms->Gui->getAbs($this->moduleName."_list:path_item_current", Array(I7221=>$itemId, I7355=>$stripItemName, "alt" =>$itemName)); }else {$res .= $this->cms->Gui->getAbs($this->moduleName."_list:path_item_link", Array(I7221=>$itemId, I7355=>$stripItemName, I7356=>$itemName)); }}return true; }function _getNodeRecordCB(&$res, &$record, &$Il11L1l) {$res =$record; }function _currencyVarsCB(&$result, $code, $currency) {$result .= ", 'cur_".jparse($code)."':".$currency["exchange"]; }function _getCurrencySelectCB(&$result, $code, $currency) {$name =$currency[I7272]; if($currency[I7272] == I7222) {$name =$this->cms->Words["unknown"]; }$result[I7272] =$name; $result[I7357] =$code; $result["selected"] =($result[I7240]==$code)?"selected":I7222; $result["currency_select_row"] .= $this->cms->Gui->get($this->moduleName."_subform:currency_select_row", $result); }function _searchNodeCB(&$res, &$record, &$Il11L1l) {if($record[I7326] >0 ){$res[] =$record[I7326]; }return true; }function TTTllTT(&$vData) {$vData[I7358] =($this->browser->getPagesCount() == ($this->browser->getActivePage() +1)); }function _itemCountersRow(&$aItem, &$aData) {$aItem["all_count"] =$aItem[I7319]; $aItem["public_count"] =$aItem["count_public_childs"]; $aItem["counter_product_row"] =$this->cms->Gui->get($this->moduleName."_list:counter_product_row", $aItem); }function _actionsRow(&$aItem, &$aData) {$links["del_id"] =$links["edit_id"] =$links["pub_id"] =$aItem[I7221]; if($aItem[I7221] != $this->oEshop->rootCatId) {$aItem["actions"] =$this->cms->Gui->get($this->moduleName.I7359, $links); $aItem["actions"] .= $this->cms->Gui->get($this->moduleName."_list:icon_del_popup", $links); }else {$aItem["actions"] =$this->cms->Gui->get($this->moduleName."_list:icons_edit_deloff", $links); $aItem[I7360] .= $this->cms->Gui->get($this->moduleName."_list:icon_none", $links); }}function TTT1II1(&$db, &$aParams) {$aParams[I7361] =$this->oEshop->getCommonModuleName("_item"); $this->ILLILIL =isset($this->ILLILIL[I7351]) ?array (I7351 => $this->ILLILIL[I7351]) :array ();$this->ILLILIL += parent::TTT1II1($db, $aParams); $this->ILLILIL += $this->oEshop->TT111lI($db, $this->ILLILIL["cat_name"], $this->ILLILIL["splitter"], $this->I1LLll1); return $this->ILLILIL; }function _htmlTitleBuildTreeOnChildsArrayCB(&$res, &$child, &$Il11L1l) {$res[] =$child[I7272]; return true; }function _buildTreeOnChildsArrayOptionCB(&$res, &$child, &$Il11L1l) {$indent =str_repeat(I7362, $Il11L1l[I7352]); $res["res"][] =array( I7272 => $child[I7221], "caption" => $indent.$this->cms->stripLine($child[I7272], 50, true), "selected" => (($res[I7357] == $child[I7221]) ?"selected" :I7222) );return true; }function getOptionsModColsCB($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I =I7363){ switch($IIL1l1I){ case I7363: $res =Array(); if(!is_array($this->I1LLlLI)) {$this->I1LLlLI =$this->cms->Gui->ParseLangFile("templates/lang/".$this->oEshop->ownerName."_cat.lng"); }$this->tree->TI11IIT("option_cb", "c.name"); $this->tree->createChildsArrayFlt(I7364); $this->tree->initResult(Array("res"=>Array(), I7357=>$cData[I7357])); $this->tree->setCallbackMethod("buildTreeOnChildsArray", "_buildTreeOnChildsArrayOptionCB"); $ILLILI1 =$this->tree->buildTreeOnChildsArray(); $res[] =array( I7272 => 0, "caption" => $this->I1LLlLI[I7365], "selected" => (($cData[I7357] == 0) ?"selected" :I7222) );$res =array_merge($res, $ILLILI1["res"]); break; case "correctvalue": break; case I7366: $res =$cData[I7357]; break; }return true; }function TIIIT1I($optionName, $I1LLLll, $aCustom, $callback =I7222) {$count =$this->module->GetOption($optionName); if ($count <0) {if (isset($I1LLLll["where"]) && !is_array($I1LLLll["where"])) {$I1LLLll["where"] =(array)$I1LLLll["where"]; }if (isset($I1LLLll[I7367])) {$I1LLLll["where"][] =$I1LLLll[I7367]; }}elseif ($count >0) {$I1LLLll["limit"] =$count; }$sql ="SELECT " .$I1LLLll[I7270] .(isset($I1LLLll[I7367]) ?", " .$I1LLLll[I7367] .I7368 :I7222) ." FROM " .$I1LLLll["from"] ." " .(isset($I1LLLll["where"]) ?I7369 .(is_array($I1LLLll["where"]) ?"(" .implode(") AND (", $I1LLLll["where"]) .I7316 :$I1LLLll[I7370]) :I7222 ).(isset($I1LLLll["order"]) ?" ORDER BY " .$I1LLLll["order"] :I7222) .(isset($I1LLLll["limit"]) ?I7371 .$I1LLLll["limit"] :I7222) .(isset($I1LLLll["tail"]) ?" " .$I1LLLll["tail"] :I7222); $this->db->query($sql); $aList =array ();while ($this->db->next_record()) {if (method_exists($this, $callback)) {$this->$callback($this->db->Record); }$aList[] =$this->db->Record; }if ($count <0 && count($aList) >0) {$aCustom += $aList[0]; }return $this->TTT1lIT($aList, $count, $aCustom); }function _GetListCtrlHtmlCB(&$aItem) {$aItem[I7272] .= I7372 .($aItem["amount"] == 0 ?$this->words["combined"] :$aItem["amount"] ." " .($aItem[I7321] == I7373 ?$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency) .$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency) :"%")) .I7316; unset($aItem["amount"], $aItem[I7321]); }function TTT1TTI(&$IIl1ll1, $prefix) {$IIl1ll1['select'] .= ', all_parents'; }function TTT1TTl(&$record) {$this->ILLILIL[I7351] =$record[$this->options[I7374]]; $this->I1LLll1 =trim($record[I7329], ','); }}