<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       43643 xkqwklxwpgwmkyupymqynixsrimnqugwuiirkinkrwsptuskwzzyisktkyggimlwuknkpnir
 */ ?><?php foreach(array(7378=>'',7379=>"SZtZ",7380=>'Qxt|',7381=>'wjzddqd|gzTo',7382=>'Qxt|MIZPQD',7383=>'|MtQI',7384=>' ',7385=>'+',7386=>'FRhi?fZKQ|tZYJQ',7387=>'KQB',7388=>'DIZJJ|WHIGZrQ|JMnK',7389=>'O',7390=>'G',7391=>'vMQC',7392=>'MS',7393=>'DKu',7394=>'CQMPOt',7395=>'nuI|fMJQD',7396=>"FRhi?.",7397=>'MtQI|tBGQ',7398=>'PrHuG',7399=>"ZWtMHn",7400=>"WuDtHI",7401=>'^',7402=>'MD|GrHG',7403=>'fnuI',7404=>'DMIGJQ|fMQJSD',7405=>'SQtZMJD|MS',7406=>"ZSS|QxtQntMHn|DEJ",7407=>'M',7408=>'DQJQWt',7409=>"{",7410=>'W',7411=>'ZnnHunWQ',7412=>'SQDWrMGtMHn',7413=>'MtQI|rQWHrS',7414=>'|GS',7415=>'rQDt',7416=>'WuDtHI|fMQJS|',7417=>'|JMDt%',7418=>'Qxt|rZtMnP',7419=>'rHC',7420=>'WZGtMHn',7421=>'GrHSuWtD|EuZntMtB',7422=>'JMnK|DOHC|OMSSQn',7423=>'?',7424=>'HYLQWt',7425=>'WZtMS',7426=>'nZv|SZtZ',7427=>'-_-',7428=>"MS",7429=>'|JMDt%ZSS|tH|WZrt',7430=>'YHSB|MtQID',7431=>'GrHGgrQf',7432=>'GrHGQrtB|WZGtMHn',7433=>'ZJJ',7434=>'SMDGJZB|SMffQrQnt',7435=>'JMnK',7436=>'WHIGZrQwJQZr',7437=>'GrHSuWtD',7438=>"coqRq?M`MS?=?",7439=>'rQS',7440=>'OMSSQn',7441=>'eUqRb|dTRmNp',7442=>'rQturn',7443=>'|',7444=>']JZB|MS=',7445=>'SZtZDQt|MS') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopCompare extends CMS_ActModule {public $I1L1LLl; public $I1L1LLL; public $I1L1LL1; public $oEshop; public $I1L1L1I; public $I1L1L1l; public $I1L1L1L; public $I1L1L11; public $I1L11II; public $I1L11Il; public $I1L11IL; public $I1L11I1; function ModuleEshopCompare(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); CreateEshop($cms); $this->oEshop =&$cms->Eshop; $this->oSession =&$GLOBALS['oSession']; $this->I1L1LLl =$this->module->GetOption('items_to_compare'); $this->I1L1L1l =null; $this->I1L1L1L =array ();}function _Init($IIll1l1 =array (),$IIll1LI =I7378, $IIll1Ll =I7378, $aOptions =array ()){$aOptions += array ('default_prefix' => 'i'); parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $IIlLIIL =Array("action"=>"_OverrideGenPicModName", I7379=> $_data =array('eshop_item')); parent::TTT1lI1($IIlLIIL, array('ext_images')); }function TTTlTI1() {parent::TTTlTI1(); $this->oEshop->init($this->moduleName); if (isset($this->ext['ext_' .$this->oEshop->ownerName .'_custom_fields'])) {$this->I1L1L1l =&$this->ext[I7380 .$this->oEshop->ownerName .'_custom_fields']; }$this->cms->SetsTemplate =$this->moduleName .'_list'; require_once $GLOBALS['CLASSES_PATH'] .'EshopCompareSet.php'; require_once $GLOBALS[I7381] .'EshopCompareSetItem.php'; if($this->oSession->IssetVar('compare')){ $this->I1L1L1I =$this->oSession->GetVar('compare'); }else{ $this->I1L1L1I =new EshopCompareSet(); }$this->I1L1L1I->owner =$this->oEshop->ownerName; $this->I1L1L1I->cms =&$this->cms; $this->I1L1L1I->init(); $this->I1L1LLL =$this->module->GetOption('price_to_display'); $this->I1L1LL1 =$this->module->GetOption('allow_different_datasets'); }function TTTllTI(&$aCustom) {$this->SetBodyType('body_items'); parent::TTTllTI($aCustom); }function _genLinkToPic($curModule, $cPicType, $cOrigPicPath, $origFileLevel, $cPicPath, $cRecID, &$vRes, $lnkAddon =false) {$IIlLIIL =Array("action"=>"_genLinkToPic", I7379=> $_data =array($this->oEshop->ownerName .'_item', $cPicType, $cOrigPicPath, $origFileLevel, $cPicPath, $cRecID, &$vRes, $lnkAddon)); parent::TTT1lI1($IIlLIIL, array(I7382)); return $vRes['_return']; }function TTTlIT1(&$aCustom, $cType ='small', $IIlLI11 =I7378, $IIlLlII ='_small') {if (!$this->cms->Core->IsPresentInPMandPublic($this->moduleName)) {return array ('body' => I7378); }$this->cms->InitNavSettings($this->oEshop->ownerName .I7383); require_once $GLOBALS[I7381] .'CMS_IteratorArray.php'; $db =clone($this->db); $this->db =new CMS_IteratorArray($this->module); $products =$this->I1L1L1I->getItemsAbs(); $aCustom['qty'] =$qty =sizeof($products); $I1L11lI =array ();$indices =array_keys($products); foreach ($indices as $index) {$id =$products[$index]->data['id']; if (isset($I1L11lI[$id])) {$I1L11lI[$id]++; unset($products[$index]); }else {$I1L11lI[$id] =1; }}$rows =array ();$keys =array ();foreach ($products as $product) {$vNavData =$this->cms->ApplyNav($product->data); if (mb_substr($vNavData['nav_data'], -1) == I7384) {$vNavData['nav_data'] =mb_substr($vNavData['nav_data'], 0, -1); }$rows[] =array_merge($product->data, $vNavData, array ('prop_qty' => $I1L11lI[$product->data['id']])); $keys[] =$product->getKey() .I7385 .$product->data['dataset_id']; }SetLocalCookie('cms_compare', implode(';', $keys), time() +31622400, I7378, true); $this->db->SetArray($rows); $this->browser->InitSQL('*', I7386, 'WHERE 1'); $this->browser->SetForceRules(' ', ' '); $I1L11ll =I7378; foreach ($keys as $key) {$I1L11ll .= $this->cms->Gui->getAbs($this->moduleName .'_list:compare_products', array (I7387 => $key)); }$aCustom['products_to_compare'] =$this->cms->Gui->getAbs($this->moduleName .'_list:products_to_compare' .($qty ?I7378 :'_empty'), array ('qty' => $qty)); $aCustom[I7388] =$qty >1 ?$this->cms->Gui->getAbs($this->moduleName .'_list:small_compare_link', array ('compare_link' => $this->module->GetFrontLink() .$this->TIIIIT1() )):I7378; $aCustom['small_clear_link'] =$qty ?$this->cms->Gui->getAbs($this->moduleName .'_list:small_clear_link', array ()):I7378; $aRes =parent::TTTlIT1($aCustom, $cType, $IIlLI11, $IIlLlII); $this->db =$db; return $aRes; }function TTTllIl(&$aData, &$aCustom) {$this->cms->InitNavSettings($this->oEshop->ownerName .I7383); require_once $GLOBALS[I7381] .'CMS_IteratorArray.php'; if (isset($this->cms->VarsGet['p']) && isset($this->cms->VarsGet['v'])) {$I1L11lL =empty($this->cms->VarsGet['h']) ?array() :explode(';', $this->cms->VarsGet[I7389]); $view =$this->cms->VarsGet['v']; if (preg_match('/^(\d+\-\d+\-\d+\;)*\d+\-\d+\-\d+/', $this->cms->VarsGet['p']) && mb_strlen($view)) {$this->I1L1L1I->items[$this->I1L1L1I->owner] =array ();$this->cms->VarsGet['products'] =$this->cms->VarsGet[I7390]; $this->TIIIT11(false); $indices =array_keys($I1L11lL); foreach ($indices as $i) {$v =$I1L11lL[$i]; if (is_numeric($v)) {$I1L11lL[$i] ='custom_field_' .$v; }elseif (!preg_match('/^[\w\-]+$/', $v)) {unset($I1L11lL[$i]); }else {$I1L11lL[$i] =str_replace(I7385, '_', $v); }}$customData =array ('hidden' => $I1L11lL, I7391 => 'all' );if (in_array($view, array ('all', 'common', 'different'))) {$customData[I7391] =$view; }$this->I1L1L1I->customData[$this->I1L1L1I->owner] =$customData; $this->TIIIIII(); }}$products =$this->I1L1L1I->getItems(); $I1L11l1 =sizeof($products); if ($I1L11l1 <2) {$this->cms->AddStatusMsg($I1L11l1 ?'warn_insufficient_quantity' :'warn_empty_list', 'red'); $db =clone($this->db); $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray(array ());parent::TTTllIl($aData, $aCustom); $this->db =$db; return; }$rows =array ();$this->I1L11Il =array ();$this->I1L1L1L =array ();foreach ($products as $product) {$rows[] =$product->data; $this->I1L11Il[$product->data['id']][] =$product->getKey(); $this->I1L1L1L[$product->data['dataset_id']][] =$product->data[I7392]; }$this->I1L11II =array ('price' => $this->words['price'], 'description' => $this->words['description'], I7393 => $this->words[I7393] );if ($this->cms->Core->IsInstalled('ext_rating')) {$this->I1L11II['votes_rate'] =$this->words['votes_rate']; }$I1L11LI =array ('eshop_goods' => array (I7394 => $this->words[I7394], 'size' => $this->words['size'] ),'eshop_digitals' => array ('eshop_digitals_count' => $this->words[I7395], 'eshop_digitals_size' => $this->words['files_size'] ),'eshop_account' => array ());$I1L11Ll =array ();$sql ="SELECT DISTINCT `item_type` ". I7396 .$this->oEshop->dbTablePrefix ."_items` " ."WHERE `id` IN (" .implode(',', array_keys($this->I1L11Il)) .")"; $this->db->query($sql); while ($this->db->next_record()) {$this->I1L11II += $I1L11LI[$this->db->Record[I7397]]; $I1L11Ll[] =$this->db->Record[I7397]; }$I1L11LL =array ();$this->I1L11IL =array ();$this->I1L1L11 =array ();if (!is_null($this->I1L1L1l)) {$ILL1lIL =&$this->I1L1L1l->ILL1lIL; }else {$ILL1lIL =array ();}$addSql =Array('select' => I7378, 'from' => I7378, 'join' => I7378, 'where' => I7378, I7398 => I7378, 'order' => I7378); $sql ="SELECT DISTINCT c.id, c.dataset_id, c.dataset_data ". I7396 .$this->oEshop->dbTablePrefix ."_items` i " ."LEFT JOIN `" .$this->oEshop->dbTablePrefix ."_cats` c ON c.id = i.id_category " ."WHERE i.id IN (" .implode(',', array_keys($this->I1L11Il)) .")"; $this->db->query($sql); $this->I1L11I1 =array ();$I1L11L1 =array_keys($this->I1L11II); while ($this->db->next_record()) {$this->I1L11IL[$this->db->Record['dataset_id']] =$this->db->Record; $IIlLIIL =Array(I7399=>"set_dataset", "item_data"=>&$this->db->Record); $this->TTT1lI1($IIlLIIL); $IIlLIIL =Array(I7399=>"add_extention_sql", "id"=>$this->db->Record[I7392], I7379=>&$addSql, I7400=>array('page_item_type'=>'body_itemD')); $this->TTT1lI1($IIlLIIL); unset($_custom); $datasetId =$this->db->Record['dataset_id']; $this->I1L1L11[$datasetId] =$this->db->Record[I7392]; $data =unserialize($this->db->Record['dataset_data']); $I1L111I =sizeof($ILL1lIL) ?explode(I7401, mb_substr($data['fields_shared'], 1, -1)) :array ();$this->I1L11I1[$datasetId] =$I1L11L1; foreach ($I1L111I as $I1L111l) {$field ='custom_field_' .$ILL1lIL[$I1L111l]['fnum']; $this->I1L11I1[$datasetId][] =$field; if (isset($ILL1lIL[$I1L111l]) && $ILL1lIL[$I1L111l]['public'] && !$ILL1lIL[$I1L111l][I7402]) {$this->I1L11II[$field] =$ILL1lIL[$I1L111l]['name'][$this->langData]; }}if (sizeof($this->I1L1L1L) >1 && $this->I1L1L1I->customData[$this->I1L1L1I->owner][I7391] == 'common') {if (in_array('eshop_digitals', $I1L11Ll)) {unset($this->I1L11II['eshop_digitals_count'], $this->I1L11II['eshop_digitals_size'], $this->I1L11II[I7394], $this->I1L11II['size']); }continue; }$I1L111I =is_array($data['fields_captions']) ?array_keys($data['fields_captions']) :array ();foreach ($I1L111I as $I1L111l) {$field ='custom_field_' .(isset($ILL1lIL[$I1L111l]) ?$ILL1lIL[$I1L111l][I7403] :I7378); $this->I1L11I1[$datasetId][] =$field; if (isset($ILL1lIL[$I1L111l]) && $ILL1lIL[$I1L111l]['public'] && !$ILL1lIL[$I1L111l][I7402]) {$this->I1L11II[$field] =$data['fields_captions'][$I1L111l]; }}}$ILl11LI =$this->I1L11II; foreach ($this->I1L1L1I->customData[$this->I1L1L1I->owner]['hidden'] as $columnName) {unset($ILl11LI[$columnName]); }if (sizeof($ILl11LI)) {$this->I1L11II =$ILl11LI; }else {$this->I1L1L1I->customData[$this->I1L1L1I->owner]['hidden'] =array ();$this->TIIIIII(); }if (!is_null($this->I1L1L1l) && is_array($this->I1L1L1l->II1lllI[I7404])) {$fields =$this->I1L1L1l->II1lllI[I7404]; foreach ($fields as $customData) {$I1L11LL[$customData['name']] =isset($this->I1L11II[$customData['name']]) && $customData['has_details'] ?$this->cms->Gui->getAbs($this->moduleName .'_list:caption_details', array (I7405 => 'ext_custom_' .$customData['num'])) :I7378; }}$this->oEshop->ILLlllI =I7378; $I1L111L =array ();$I1L1111 =array ();$I11IIII =array ();$frontLink =$this->module->GetFrontLink(); $I11IIIl =array ();foreach ($this->I1L1L1L as $datasetId => $I11IIIL) {$IIlLIIL =Array(I7399=>"set_dataset", "item_data"=>&$this->I1L11IL[$datasetId]); $this->TTT1lI1($IIlLIIL); $I11III1 =array ();foreach ($I11IIIL as $productId) {$keys =$this->I1L11Il[$productId]; foreach ($keys as $k => $key) {list(, $keys[$k]) =explode(I7385, $key); }$I11III1 =array_merge($I11III1, $keys); }$I11III1 =array_diff(array_unique($I11III1), array (0)); if (sizeof($I11III1)) {$IIlLIIL =Array( I7399=>I7406, "item_data"=>&$addSql, I7379=>&$addSql, I7400=>array ('sql_type' => 'prop_join', 'prefix' => I7407, 'propIdList' => implode(',', $I11III1) ));$this->TTT1lI1($IIlLIIL); }unset($_custom); $this->browser->PageSize =0; $this->browser->InitSQL( "i.*, i." .$this->I1L1LLL ." AS price0". $addSql[I7408] .$this->oEshop->getPriceFields("i.price%d, c.price_caption%d, SUBSTRING(c.price%d, INSTR(c.price%d, '#')+1) AS currency%d") .", c.id AS catid, c.sublink AS cat_sublink, c.dataset_id", "FROM ".$this->oEshop->dbTablePrefix."_items i INNER JOIN ".$this->oEshop->dbTablePrefix."_cats AS c ON i.id_category=c.id " .$addSql['join'], "WHERE 1".$this->_ApplyFilters(). " AND i.id IN (" .implode(',', array_unique($I11IIIL)) .I7409, "", "name" );$this->browser->SetForceRules(' ', ' '); $this->browser->AddSQLJoinedTables($this->cms->Core, I7407, array (I7410 => $this->oEshop->dbTablePrefix .'_cats', I7390 => $this->oEshop->dbTablePrefix .'_props' ));$this->browser->ProcessSQL($this->db); $I11IIlI =true; $I11IIll =true; while ($this->db->next_record()) {$record =$this->db->Record; if (!empty($record['announce']) && $this->module->issetAndTrueOption('fill_empty_description') && (mb_strlen(trim(strip_tags($record[I7411]))) && ($b =array_key_exists('description', $record) && !mb_strlen(trim(strip_tags($record['description'])))) || (array_key_exists('body', $record) && !mb_strlen(trim(strip_tags($record['body'])))) )){$record[$b ?I7412 :'body'] =$record[I7411]; }$IIlLIIL =Array(I7399=>"prepare_record", "item_data"=>&$record, I7400=>array('record_type' => I7413)); $this->TTT1lI1($IIlLIIL); $names =array_keys($record); foreach ($names as $name) {if (is_numeric($name)) {unset($record[$name]); }elseif ($I11IIlI) {$I11IIlI =false; $I1L1111[$datasetId][] =$name; }}$this->_getRowCB($record, $aData); if (isset($record['_pd']['isnot_all']) && is_array($record['_pd']['isnot_all'])) {$I11IIIl += $record[I7414]['isnot_all']; }if (isset($record[I7414]['record'])) {unset($record[I7414]['record'][I7392], $record[I7414]['record'][I7415], $record[I7414]['record']['price']); foreach ($record[I7414]['record'] as $I11IIlL => $I11IIl1) {if (is_numeric($I11IIlL)) {continue; }if (mb_strpos($I11IIlL, 'prop_') === 0) {$I11IILI =intval(mb_substr($I11IIlL, 5)); $I11IILl =I7416 .$I11IILI; }else {$I11IILI =$I11IILl =$I11IIlL; }if ($I11IIll) {$this->I1L11II[$I11IILl] =trim($record[I7414]['captions'][$I11IILI]); }$record[$I11IILl] =$I11IIl1; }$I11IIll =false; }$I1L1L1I =unserialize(serialize($this->I1L1L1I)); $this->I1L1L1I->remove($record[I7387]); $record['link_to_delete'] =$frontLink .$this->TIIIIT1(); $this->I1L1L1I =$I1L1L1I; $I1L111L[$datasetId][] =$record; }}if(!sizeof($I1L111L)){ $this->cms->AddStatusMsg('warn_empty_list', 'red'); return; }$I11IILL =array_unique($this->I1L11II); if (sizeof($I11IILL) != sizeof($this->I1L11II)) {$I11IIL1 =array ();$ILl11LI =array_diff_assoc($this->I1L11II, $I11IILL); foreach ($ILl11LI as $field => $caption) {$I11IIL1[$field] =array_search($caption, $this->I1L11II); }$this->I1L11II =$I11IILL; foreach ($I1L111L as $datasetId => $records) {foreach ($records as $index => $record) {foreach ($record as $field => $value) {if (isset($I11IIL1[$field])) {if (empty($record[$I11IIL1[$field]])) {$I1L111L[$datasetId][$index][$I11IIL1[$field]] =$record[$record[$field]]; }unset($I1L111L[$datasetId][$index][$field]); }}}}}$fields =array_keys($this->I1L11II); foreach ($fields as $field) {$setName =$this->moduleName .I7417 .(isset($I11IIIl[$field]) ?($I11IIIl[$field] ?'characteristic_' .$field :'characteristic') :'characteristic_' .$field); if ($this->cms->Gui->issetSet($setName)) {$I11IIII[$field] =$setName; }else {unset($this->I1L11II[$field]); }}if (isset($I11IIII['votes_rate'])) {$I11II1I =$this->cms->Core->GetModOption(I7418, 'rating_decimal_places'); }$I11II1l =array ();foreach ($I1L111L as $datasetId => $records) {foreach ($records as $record) {if(isset($record[I7414])){ $pd =$record[I7414]; unset($record[I7414]); }$record =array_map('trim', $record); if(isset($pd)){ $record[I7414] =$pd; unset($pd); }foreach ($I11IIII as $field => $setName) {if ($field == 'votes_rate') {$record[$field] =round($record[$field], $I11II1I); }$record[$field] =trim($this->cms->Gui->getAbs($I11IIII[$field], array('value' => $record[$field]))); }$I11II1l[] =$record; }}unset($I1L111L, $records, $record); $I11II1L =sizeof($I11II1l); $rows =array ();$row =$this->cms->Gui->getAbs($this->moduleName .'_list:cell_select_all_products', array ('products_quantity' => $I11II1L)); for ($rowIndex =0 ;$rowIndex <$I11II1L ;$rowIndex++) {$vars =array_merge($I11II1l[$rowIndex], array ('popup_picture' => $this->cms->Gui->get($this->moduleName .'_list:popup_picture', $I11II1l[$rowIndex]) ));$row .= $this->cms->Gui->get($this->moduleName .'_list:cell_product_top', $vars); }$rows[] =array (I7419 => $row); $I11II11 =array_keys($I11II1l[0]); $counter =0; $I11IlII =$this->I1L1L1I->customData[$this->I1L1L1I->owner][I7391] == 'different'; $I11IlIl =false; foreach ($this->I1L11II as $field => $caption) {$value =$this->TIIIIIl((string)$I11II1l[0][$field]); $I11IlIL =true; for ($rowIndex =1 ;$rowIndex <$I11II1L ;$rowIndex++) {if ($this->TIIIIIl((string)$I11II1l[$rowIndex][$field]) != $value) {$I11IlIL =false; break; }}if ($I11IlII && $I11IlIL) {continue; }$I11IlIl =$I11IlIl || $I11IlIL; $row =$this->cms->Gui->getAbs($this->moduleName .'_list:cell_characteristic_caption', array ('num' => $counter +1, 'column_name' => $field, I7420 => $caption, 'caption_details' => $I1L11LL[$field], 'same' => intval($I11IlIL) ));for ($rowIndex =0 ;$rowIndex <$I11II1L ;$rowIndex++) {$row .= $this->cms->Gui->getAbs($this->moduleName .'_list:cell_characteristic', array ('value' => empty($I11II1l[$rowIndex][$field]) ?'&nbsp;
                ' :$I11II1l[$rowIndex][$field])); }$counter++; $rows[] =array (I7419 => $row, '_style' => $this->cms->Gui->getAbs($this->moduleName .'_list:item_row_style' .($I11IlIL ?'_same' :I7378), array ('cnt' => $counter )));}$this->IlLl11L =array (I7421 => $I11II1L, 'parameters_quantity' => $counter, 'severalDatasets' => sizeof($this->I1L1L1L) >1, 'same_presence' => $I11IlIl );$I1L1L1I =unserialize(serialize($this->I1L1L1I)); $this->I1L1L1I->customData[$this->I1L1L1I->owner]['hidden'] =array ();$this->IlLl11L[I7422] =$frontLink .$this->TIIIIT1(); $this->I1L1L1I =$I1L1L1I; unset($I1L1L1I); $db =clone($this->db); $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray($rows); parent::TTTllIl($aData, $aCustom); $this->db =$db; }function TTTll1T(&$vData, &$aCustom) {$this->TTT11ll(); foreach($this->IIllIL1 as $IIlL1L1 => $tmp) {$IIlL1Ll =$this->TTITTT1($aCustom, $IIlL1L1); switch ($IIlL1L1) {case 'body_items': $this->oEshop->ILLllI1 =$this->oEshop->ILlLL1l->GetOption('show_currency_signs'); $this->browser->InitSQL('*', I7386, 'WHERE 1'); $this->browser->SetForceRules(I7423, I7423); $IIlL1Ll['fields']['other'] =array ('action' => 'callback', I7424 => &$this, 'method' => '_getFinalRowCB'); break; }}parent::TTTll1T($vData, $IIlL1Ll); }function _getRowCB(&$aItem, &$aData) {static $counter, $I11IlI1; if (!isset($counter)) {$counter =0; $I11IlI1 =array ();}$aItem['num'] =++$counter; $aItem['itemid'] =$aItem[I7392]; $vNavData[I7425] =$aItem[I7425]; $vNavData['catid_sublink'] =$aItem['cat_sublink']; $vNavData[I7392] =$aItem[I7392]; $vNavData['id_sublink'] =$aItem['sublink']; $vNavData =$this->cms->ApplyNav($vNavData); if (mb_substr($vNavData[I7426], -1) == I7384) {$vNavData[I7426] =mb_substr($vNavData[I7426], 0, -1); }$aItem =array_merge($aItem, $vNavData); if ($this->I1L1LLL == 'price') {$priceNum =0; $price =$this->oEshop->TITTITI($aItem, $aItem, 'itemD', 'compare'); }else {$price =str_replace('+|++|+', I7427, $this->oEshop->TITTITl($aItem, $aItem, 'itemD', 'compare')); $price =explode(I7427, mb_substr($price, 3, -3)); $price =$price[($priceNum =mb_substr($this->I1L1LLL, -1)) -1]; }$aItem[I7387] =$this->I1L11Il[$aItem[I7392]][isset($I11IlI1[$aItem[I7392]]) ?sizeof($I11IlI1[$aItem[I7392]]) :0]; $I11IlI1[$aItem[I7392]][] =1; $datasetId =$aItem['dataset_id']; $IIlLIIL =Array(I7399=>"get_if_dataset_has_props", I7428=>$datasetId, "item_data"=>&$I11IllI); $this->TTT1lI1($IIlLIIL); $aItem['price_num'] =$priceNum; $aItem['add_to_cart'] =$I11IllI['has_props'] ?I7378 :$this->cms->Gui->get($this->moduleName .I7429, $aItem); $aItem[I7414] =array ();$IIlLIIL =Array(I7399=>"apply_vars", I7428=>$aItem[I7392], "item_data"=>&$aItem, I7379=>&$aItem, I7400=>array('page_item_type' => 'body_itemD')); $this->TTT1lI1($IIlLIIL); $this->oEshop->TT1111T(I7430, $aItem, $aItem); if (isset($aItem['propId']) && !is_null($this->I1L1L1l)) {$propData =array ('itemId' => $aItem[I7392], 'propId' => $aItem['propId'], I7431 => 'item'); $aPropRes =$aNone =array ();$this->I1L1L1l->ProcessAction($a ='get_prop_desc', 0, $aNone, $propData, $aPropRes); $aItem['property_caption'] =$this->cms->Gui->getAbs($this->moduleName .'_list:property_caption', array (I7432 => trim(TlTll11( $aItem['propId'], $this->I1L1L1l, $aPropRes['desc_arr'], $this->moduleName .'_list' ))));}else {$aItem[I7432] =I7378; }$keys =array_keys($this->I1L11II); foreach ($keys as $key) {if (!in_array($key, $this->I1L11I1[$datasetId])) {$aItem[$key] =I7378; }}$IIlLIIL =Array(I7399=>"_GetPicturesCB", I7379=> $_data =array(&$aItem, &$aData)); parent::TTT1lI1($IIlLIIL, array(I7382)); }function _getFinalRowCB(&$aItem, &$aData) {static $flag; if (!isset($flag)) {$flag =1; $aData =array_merge($aData, $this->IlLl11L); $views =array (I7433 => $this->words['display_all'], 'common' => $this->words['display_common'], 'different' => $this->words[I7434] );$I11Illl =I7378; $frontLink =$this->module->GetFrontLink(); $count =0; $qty =sizeof($views); foreach ($views as $view => $caption) {$count++; if ($view == 'common' && !$this->IlLl11L['severalDatasets']) {continue; }$selected =$view != $this->I1L1L1I->customData[$this->I1L1L1I->owner][I7391] ?I7378 :'_selected'; $I11Illl .= $this->cms->Gui->getAbs($this->moduleName .'_list:compare_options_row' .$selected, array (I7435 => $frontLink .$this->TIIIIT1($view), I7420 => $caption ));if ($count <$qty) {$I11Illl .= $this->cms->Gui->getAbs($this->moduleName .'_list:compare_options_row_splitter', array ());}}$aData['compare_option_cell'] =$this->cms->Gui->getAbs($this->moduleName .'_list:compare_option_cell', array ('compare_options' => $I11Illl ));$aData['hidden_characteristics'] =sizeof($this->I1L1L1I->customData[$this->I1L1L1I->owner]['hidden']) >0; }}function TIIIT1l() {if (!isset($this->cms->VarsGet['action'])) {return; }switch ($this->cms->VarsGet['action']) {case 'compare': $this->TIIIT11(); break; case I7436: $this->TIIIITI(); break; }}function TTTlITT($IIIL11l, $cId, $cModule =I7378) {if (isset($this->cms->Vars['cAction'])) {$I11IllL =true; switch ($this->cms->Vars['cAction']) {case 'hide_characteristics': $this->TIIIITT(); break; default: $I11IllL =false; break; }if ($I11IllL) {$this->cms->Core->Cache->Disable(); }$this->TIIIITl($this->module->GetFrontLink() .$this->TIIIIT1()); }parent::TTTlITT($IIIL11l, $cId, $cModule); }function TIIIT11($I11Ill1 =true) {if (!isset($this->cms->VarsGet['products'])) {return; }$products =mb_strpos($this->cms->VarsGet[I7437], I7401) === false ?array ($this->cms->VarsGet[I7437]) :explode(I7401, $this->cms->VarsGet[I7437]); $I11IlLI =0; foreach ($products as $product) {$product =explode(I7385, $product); if ($this->I1L1L1I->total() <$this->I1L1LLl) {if (sizeof($product) == 3) {$id =abs(intval($product[0])); $propId =abs(intval($product[1])); $datasetId =abs(intval($product[2])); $sql ="SELECT i.id, i.name, i.sublink id_sublink, i.id_category catid, c.sublink catid_sublink, c.dataset_id " .I7396 .$this->oEshop->dbTablePrefix ."_items` i " ."LEFT JOIN `" .$this->oEshop->dbTablePrefix ."_cats` c ON c.id = i.id_category " .I7438 .$id; $this->db->query($sql); if (!$this->db->next_record() || $datasetId != $this->db->Record['dataset_id']) {return; }require_once $GLOBALS[I7381] .'EshopCompareSetItem.php'; $item =new EshopCompareSetItem(); $data =$this->db->Record; $data['propId'] =$propId; $item->set($data); $qty =$this->I1L1L1I->total(); if ($this->I1L1L1I->add($item, !$this->I1L1LL1)) {$I11IlLI =$qty >= $this->I1L1L1I->total() ?1 :$I11IlLI +1; }}}else {if ($I11Ill1) {$this->cms->AddStatusMsg('warn_max_items_to_compare', I7439); }break; }}$this->TIIIIII(); if ($I11IlLI && $I11Ill1) {$this->cms->AddStatusMsg($I11IlLI == 1 ?'item_added_to_comparison' :'items_added_to_comparison'); }if ($I11Ill1) {$this->cms->Core->Cache->Disable(); }}function TIIIITT() {if (!isset($this->cms->VarsPost['parameter']) || !is_array($parameters =$this->cms->VarsPost['parameter'])) {return; }$this->I1L1L1I->customData[$this->I1L1L1I->owner][I7440] =array_unique(array_merge($this->I1L1L1I->customData[$this->I1L1L1I->owner][I7440], $parameters)); $this->oSession->SetVar('compare', $this->I1L1L1I); }function TIIIITI() {if (sizeof($this->I1L1L1I->items[$this->I1L1L1I->owner])) {$this->I1L1L1I->items[$this->I1L1L1I->owner] =array ();$this->I1L1L1I->customData[$this->I1L1L1I->owner][I7440] =array ();$this->TIIIIII(); $this->cms->Core->Cache->Disable(); }}function TIIIITl($I11IlLl =null) {if (is_null($I11IlLl)) {$I11IlLL =parse_url(mb_strlen($_SERVER['REQUEST_URI']) ?$_SERVER['REQUEST_URI'] :preg_replace('/^d*\;/', I7378, $_SERVER[I7441])); parse_str($I11IlLL['query'], $get); mb_internal_encoding('UTF-8'); $url =!isset($this->cms->VarsGet['skipReturn']) ?preg_replace('/action=[^\&]+(\&)?/', I7378, $get[I7442]) :$GLOBALS['ROOT_PATH_WWW'] .($this->cms->Core->GetOption('allow_multi_lang') ?$this->langData .'/' :I7378); }else {$url =$I11IlLl; }$null =null; doRedirect301($url, $null); }function TIIIIT1($view =false) {$products =$this->I1L1L1I->getItemsAbs(); $p =array ();foreach ($products as $key => $product) {$p[] =$product->getKey() .I7385 .$product->data['dataset_id']; }$h =$this->I1L1L1I->customData[$this->I1L1L1I->owner][I7440]; foreach ($h as $i => $v) {if (mb_strpos($v, I7416) === 0) {$h[$i] =mb_substr($v, 13); }else {$h[$i] =str_replace(I7443, I7385, $v); }}return '?p=' .implode(I7401, $p) .'&h=' .implode(I7401, $h) .'&v=' .(!$view ?$this->I1L1L1I->customData[$this->I1L1L1I->owner][I7391] :$view) .$this->TIIIIIT(); }private function TIIIIIT(){ return empty($this->cms->Vars['lay_id']) ?I7378 :(I7444 .$this->cms->Vars['lay_id']); }function TIIIIII() {$this->oSession->SetVar('compare', $this->I1L1L1I); $I11IlL1 ='cache'; $IllIILl =array ();if ($this->oSession->IssetVar($I11IlL1)) {$IllIILl =$this->oSession->GetVar($I11IlL1); }$IllIILl['empty_comparison'] =$this->I1L1L1I->total() == 0; $this->oSession->SetVar($I11IlL1, $IllIILl); $products =$this->I1L1L1I->getItems(); $keys =array ();foreach ($products as $key => $product) {$keys[] =$key .I7385 .$product->data[I7445]; }SetLocalCookie('cms_compare', implode(I7401, $keys), time() +31622400, I7378, true); }function TIIIIIl($string) {$string =preg_replace('/([\x00-\x2f]|[\x3a-\x40])/s', I7423, unhtmlentities(strip_tags($string))); $string =preg_replace(array ('/&raquo/si', '/&laquo/si'), I7378, $string); return mb_strtolower(trim(preg_replace(array ('/\s+/s'), I7423, $string))); }}