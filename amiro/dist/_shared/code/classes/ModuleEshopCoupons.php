<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       23911 xkqwislgpqktkurzymntnqixptixxqtqltumxksmgnkynnyqtsxqrsninwnupiimgwskpnir
 */ ?><?php foreach(array(7446=>'qDOHGzSIMn`GOG',7447=>'WOQWK|GuYJMW',7448=>'PrHuG|HGQrZtMHnD',7449=>'QSMt',7450=>'tMIQ|JMIMtQS',7451=>'SZtQtH',7452=>'fJt|WHuGHn',7453=>'fJt|WZt|MS',7454=>'WOQWKYHx',7455=>'SQfZuJt|GrQfMx',7456=>'fJt|uDQrnZIQ',7457=>'',7458=>'?',7459=>'SY',7460=>'tZYJQD',7461=>'W`MS|IQIYQr?=?I`MS',7462=>'|SMDWHuntD',7463=>'I_S',7464=>'W',7465=>'LHMnD',7466=>'LHMnD|tBGQD',7467=>'HrSQr|rQGJZWQ',7468=>'vZJuQ',7469=>'Hff',7470=>'SQJ|MS',7471=>'WZJJYZWK',7472=>'JQP|rQS',7473=>'fHrI|SZtZ',7474=>'DZvQ',7475=>'MS|QxtQrnZJ',7476=>'uDQrnZIQ',7477=>"tGJ|JMDt|GHDtfMx",7478=>'MS|IQIYQr',7479=>'coqRq?1',7480=>'YMnS|IQIYQr',7481=>'Tmiq|jmimTqs',7482=>'mjJJjmJ',7483=>'SMDWHunt',7484=>':',7485=>'WHuGHn',7486=>"'",7487=>'ZWtMvZtMHnD|JQft',7488=>'SZtQ|QnS',7489=>'ZuSMt|HCnQr',7490=>'nuIYQr|Hf|WHuGHnD',7491=>'DuYZWtMHn',7492=>'MS|WrQZtMHn|tBGQ',7493=>'MS|WrQZtMHn|tBGQ|',7494=>'WHuGHnD|WrQZtMHn',7495=>'WZt|MS',7496=>'SMPMtD|JQttQrD',7497=>':0',7498=>'JZnP',7499=>"coqRq?.MS.?mN?}") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopCoupons extends CMS_ActModule {public $oEshop; public $IlIllI1; public $I11Il1I; public $I11Il1l; function ModuleEshopCoupons(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); if ($this->cms->Core->Side == 'admin') {require_once $GLOBALS['CLASSES_PATH'] .I7446; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init($this->moduleName); }else {CreateEshop($cms); $this->oEshop =&$cms->Eshop; }$this->IlIllI1 =new CMS_CategoriesFunctions($this->cms, $this, $this->oEshop->ownerName .'_coupons_cat'); }function _Init($IIll1l1 =array (),$IIll1LI ='', $IIll1Ll ='', $aOptions =array ()){$IIIIL11 =array ('lang_data' => true, I7447 => false, 'default_prefix' => 'c', 'use_id_page' => false, 'use_positions' => false, I7448 => array ('del', 'generate_coupons'), 'allowed_actions' => array ('add', I7449, 'apply', 'save', 'del', 'generate') );$aOptions += $IIIIL11; $this->I11Il1I =$this->module->GetOption(I7450); parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->IlIllI1->_Init(); $this->IlIllI1->IILL1lL =true; $this->IlIllI1->IILL1l1 =true; $this->IlIllI1->IILLL1l ='cc'; $this->IlIllI1->TTIT1IT('_ApplyCatFilters'); }function _InitAdmin(){ parent::_InitAdmin(); if(!$this->I11Il1I){ if($this->filter->issetField('datefrom')){ $this->filter->TITI1l1('datefrom'); }if($this->filter->issetField(I7451)){ $this->filter->TITI1l1(I7451); }$this->filter->IL11l1L =array('limit'); }}function TTTlIII() {parent::TTTlIII(); $this->filter->AddField('flt_coupon', 'text', isset($this->cms->Vars['flt_coupon']) ?stripslashes(unhtmlentities($this->cms->Vars[I7452])) :'', '', ' like ', 'coupon'); $this->filter->MoveField(I7452, _MOVE_START); if ($this->IlIllI1->TTTlIII(I7453)) {$this->filter->MoveField(I7453, _MOVE_START); }if ($this->I11Il1I) {$this->filter->UpdateFieldDBName('datefrom', 'c.date_start'); $this->filter->UpdateFieldDBName(I7451, 'c.date_start'); }$this->filter->AddField('flt_used', I7454, isset($this->cms->Vars['flt_used']) ?$this->cms->Vars['flt_used'] :null, '0', ' > ', $this->options[I7455] .'activations_left'); if (empty($this->cms->Vars['flt_used'])) {$this->filter->TITI1II('flt_used', ' OR ' .$this->options[I7455] .'activations_left IS NULL'); }else {$this->filter->DisableFieldSQL('flt_used'); }$this->filter->AddField('flt_username', 'text', isset($this->cms->Vars['flt_username']) ?stripslashes(unhtmlentities($this->cms->Vars[I7456])) :'', '', ' like ', 'm.username'); if (empty($this->cms->Vars[I7456])) {$this->filter->DisableFieldSQL(I7456); }}function _ApplyFilters($prefix =I7457, $bodyType =I7457, $IIlLLl1 =true) {$I11Il1L =$prefix; if (empty($I11Il1L)) {$I11Il1L =$this->options[I7455]; }$I11Il1L =str_replace('.', I7457, $I11Il1L); $res =" AND " .$I11Il1L .".target = 'eshop'" .parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); return $res; }function _ApplyCatFilters($prefix =I7457, $bodyType =I7457, $IIlLLl1 =true) {$res =$this->_ApplyFilters($prefix, $bodyType, $IIlLLl1); return $res; }function TTTlI11(&$vData, &$aCustom) {$username =I7457; if (is_array($this->itemData)) {if (!empty($this->itemData['id_member'])) {$sql ="SELECT firstname, lastname, username FROM cms_members WHERE id = " .$this->itemData['id_member']; if ($record =$this->db->getRecord($sql)) {$username =$record['username'] .', ' .$record['firstname'] .I7458 .$record['lastname']; }}}$select =$this->I11Il1I ?", DATE_FORMAT(c.date_start, '" .$this->cms->DFMT['db'] ."') fdate_start, DATE_FORMAT(c.date_end, '" .$this->cms->DFMT[I7459] ."') fdate_end": I7457; $I11Il11 =array ();$I11Il11['join_to_alias'] ='c'; $this->IlIllI1->TTIT1lT('item_list', $I11Il11); $I11ILII =array (I7460 => array ('m' => 'cms_members'), 'joins' => array ('cc|m' => I7461), 'joins_types' => array ('cc|m' => 'LEFT OUTER') );$I11ILIl =array (I7460 => array ('d' => $this->oEshop->dbTablePrefix .I7462), 'joins' => array ('m|d' => 'd.id_coupon_cat = cc.id'), 'joins_types' => array (I7463 => 'LEFT OUTER') );$this->browser->InitSQL( "c.*" .$select .$I11Il11['select'] .', m.username, d.amount, d.type, COUNT(d.id) discount', array (I7460 => array (I7464 => $this->oEshop->dbTablePrefix .'_coupons') +$I11Il11[I7460] +$I11ILII[I7460] +$I11ILIl[I7460], 'joins' => $I11Il11['joins'] +$I11ILII['joins'] +$I11ILIl[I7465], 'joins_types' => array ('c|' .$this->IlIllI1->IILLL1l => 'INNER') +$I11ILII['joins_types'] +$I11ILIl[I7466] ),"WHERE 1 " .$this->_ApplyFilters() .$this->TTTlIl1(), 'c.id', 'coupon', 'c.id DESC', $I11Il11[I7467] );$this->browser->AddSQLJoinedTables($this->cms->Core, I7464, $I11Il11[I7460] +$I11ILII[I7460] +$I11ILIl[I7460]); $aCustom['fields'] += array ('action_edit' => array ('action' => 'flagicon', I7468 => I7457, 'id' => 'edit_id', 'on' => $this->moduleName .'_list:edit', I7469 => I7457 ),'action_del' => array ('action' => 'flagicon', I7468 => I7457, 'id' => I7470, 'on' => $this->moduleName .'_list:del', I7469 => I7457 ),'type' => array ('action' => I7471, 'object' => &$this, 'method' => '_adminListRowCB') );$aCustom['legend'] =array (I7472, 'leg_yellow', 'leg_blue', 'leg_edit', 'leg_del'); $aCustom[I7473]['buttons'] =array ('add', 'apply', 'cancel', I7474); $aCustom['applied_id'] ='c.id'; $this->IlIllI1->TTTlI11($vData, $aCustom); $this->TIIIII1($vData); $vData['allow_generation'] =sizeof($this->IlIllI1->IILL1IL) >0; $this->TIIIIlT($vData); if ($this->action != I7449) {$this->TIIIIlI($vData); }$vData['id_external'] =isset($this->itemData[I7475]) ?$this->itemData[I7475] :I7457; parent::TTTlI11($vData, $aCustom); }function TIIIII1(&$vData) {$aListData =array ("audit_current_owner" => isset($this->itemData['id_member']) ?$this->itemData['id_member'] :null, "audit_current_owner_name" => isset($this->itemData[I7476]) ?$this->itemData[I7476] :null );$aCustomData =array ("tpl_hidden_field_postfix" => ':audit_owner_hidden', "tpl_row_postfix" => ':audit_owner_row', I7477 => ':audit_owner_list', "tpl_single_item_postfix" => ':audit_owner_single', "last_edited_id" => isset($this->itemData[I7478]) ?$this->itemData[I7478] :null, "list_data" => $aListData );$this->module->PushPager($this->browser); $this->browser->InitSQL('`id`, `username`, `firstname`, `lastname`', array (I7460 => array ('m' => 'cms_members')), I7479); $this->browser->SetForceRules('ORDER BY `username` ASC'); $vData['coupon_owner'] =$this->TTT1lII($this->db, $this->module->GetOption('owners_list_size'), $aCustomData); $this->module->PopPager($this->browser); }function TIIIIlT(&$vData) {$this->IlIllI1->TTIT1Il(); $this->I11Il1l =array ();if (sizeof($this->IlIllI1->IILL1IL) >0) {$ids =array ();foreach ($this->IlIllI1->IILL1IL as $row) {$ids[] =$row['id']; }$sql ="SELECT `id`, `bind_member` FROM `" .$this->oEshop->dbTablePrefix ."_coupons_cats` WHERE `id` IN (" .implode(',', $ids). ")"; $rs =&$this->db->select($sql); while ($record =$rs->nextRecord()) {$this->I11Il1l[$record['id']] =$record[I7480]; }$vData['js_cat_ids'] =implode(',', array_keys($this->I11Il1l)); $vData['js_cat_bind_member_data'] =implode(',', $this->I11Il1l); }}function TIIIIlI(&$vData) {if ($this->I11Il1I) {$this->cms->Gui->addGlobalVars(array (I7481 => true)); $vData['fdate_start'] =date($this->cms->DFMT['php'], time()); $vData['fdate_end'] =date($this->cms->DFMT['php'], $GLOBALS[I7482]); }}function _adminListRowCB(&$aItem, &$aData) {if (is_null($aItem['activations_left'])) {$aItem['activations_left'] =$this->words['unlimited']; }switch (intval($aItem['discount'])) {case 0: $aItem[I7483] ='-'; break; case 1: $aItem[I7483] =$aItem['amount'] .I7458 .($aItem['type'] == 'abs' ?$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency) .$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency) :I7484); break; default: $aItem[I7483] =$this->words['multiple']; break; }}function TTTlITT($IIIL11l, $cId, $cModule =I7457) {switch ($IIIL11l) {case 'generate': $this->TIIIIll(); $IIIL11l =I7457; break; case 'delete_member': if ($this->side == 'admin') {$this->TIIIIl1($cId); $IIIL11l =I7457; }break; }parent::TTTlITT($IIIL11l, $cId, $cModule); }function TTT1IlI($aSQL =array (),$cId =0) {$coupon =$this->cms->VarsPost[I7485]; if (!empty($coupon)) {$sql ="SELECT 1 " ."FROM `" .$this->oEshop->dbTablePrefix ."_coupons` " ."WHERE `coupon` = '" .$coupon .I7486 .($cId ?" AND id != '" .$cId .I7486 :I7457); if ($this->db->getValue($sql)) {$this->cms->AddStatusMsg('status_duplicate_coupon', 'red'); return array ();}$aSQL =array (I7485 => $coupon, I7478 => $this->cms->VarsPost['audit_new_owner'], I7487 => mb_strlen(trim($this->cms->VarsPost[I7487])) >0 ?$this->cms->VarsPost[I7487] :'=|NULL' );foreach (array ('date_start', 'date_end') as $field) {$udate =$this->I11Il1I ?DateTools::getCorrectUDate($this->cms->VarsPost[$field], $this->cms->DFMT['conf']) :($field == I7488 ?$GLOBALS[I7482] :strtotime(date('Y-m-d'))); $aSQL[$field] =DateTools::toMysqlDate($udate); }}$this->IlIllI1->TTT1IlI($aSQL, $cId); $aSQL =parent::TTT1IlI($aSQL, $cId); return $aSQL; }function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); if (empty($this->errno) && $this->appliedId >0) {$this->IlIllI1->TTTll11($cId, $cModule); }}function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); if (empty($this->errno)) {$this->IlIllI1->TTTl1lI($cId, $cModule); }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $select =$this->I11Il1I ?", DATE_FORMAT(c.date_start, '" .$this->cms->DFMT[I7459] ."') fdate_start, DATE_FORMAT(c.date_end, '" .$this->cms->DFMT[I7459] ."') fdate_end " :I7457; $sql ="SELECT c.*, m.username " .$select ."FROM " .$this->oEshop->dbTablePrefix ."_coupons AS c " ."LEFT OUTER JOIN `cms_members` m ON c.id_member = m.id " ."WHERE c.id='" .$cId.I7486 .$this->_ApplyFilters(); $record =$this->db->getRecord($sql); if ($record) {$this->itemData =$record; $this->itemData[I7489] =$this->itemData[I7478]; }}function TIIIIll() {$IlLI11l =array ('id_length', 'id_splitter', 'id_splitter_period', 'id_splitter_period', I7490); $I11ILIL =array ('sequent_numbers', 'digits', 'letters', 'digits_letters'); if (empty($this->cms->Vars[I7491])) {$this->IlIllI1->TTIT1Il(); if (sizeof($this->IlIllI1->IILL1IL) <1) {return; }$this->cms->Gui->delScript(); $this->cms->Gui->addScript("jsapi.php"); $this->cms->Gui->addScript($GLOBALS['CURRENT_SKIN_PATH'].'_js/ami.admin.js'); $this->cms->Gui->addScript('calendar_js.php'); $this->cms->Gui->addGlobalVars(array (I7481 => $this->I11Il1I)); $IIl1LIl =array (I7492 => I7457); $this->TIIIII1($IIl1LIl); $this->TIIIIlT($IIl1LIl); $this->TIIIIlI($IIl1LIl); $I11ILI1 =$this->module->GetOption(I7492); foreach ($I11ILIL as $I11ILlI) {$IIl1LIl[I7492] .= $this->cms->Gui->getAbs($this->moduleName .'_subform:option_row', array (I7468 => $I11ILlI, 'selected' => $I11ILlI != $I11ILI1 ?I7457 :' selected', 'caption' => $this->words[I7493 .mb_strtoupper($I11ILlI)] ));}$num =$this->module->GetOption('default_number_of_activations'); if ($num) {$IIl1LIl['number_of_activations_1'] =' checked'; $IIl1LIl['default_number_of_activations'] =$num; }else {$IIl1LIl['number_of_activations_0'] =' checked'; }foreach ($IlLI11l as $optionName) {$IIl1LIl[$optionName] =$this->module->GetOption($optionName); }$this->IlIllI1->TTIT1I1($IIl1LIl); $vData =array ('popup_title' => $this->words['coupons_creation'], 'header' => $this->words[I7494], 'content' => $this->cms->Gui->get($this->moduleName .'_subform:popup_content', $IIl1LIl) );$this->TTT1I1I($vData, 'coupons_genegating_popup', $this->moduleName .'_subform'); die; }$IlLI11l =array_merge($IlLI11l, array (I7495, I7492, 'number_of_activations', 'number_of_activations_num')); if ($this->I11Il1I) {$IlLI11l =array_merge($IlLI11l, array ('date_start', I7488)); }if ($catId =intval($this->cms->Vars[I7495])) {$sql ="SELECT `bind_member` FROM `" .$this->oEshop->dbTablePrefix ."_coupons_cats` WHERE `id` = " .$catId; if ($this->db->getValue($sql)) {$IlLI11l[] ='audit_new_owner'; }}foreach ($IlLI11l as $IlL1Ll1) {if (!isset($this->cms->Vars[$IlL1Ll1])) {return; }$$IlL1Ll1 =$this->cms->Vars[$IlL1Ll1]; }$audit_new_owner =intval($this->cms->Vars['audit_new_owner']); if (!in_array($id_creation_type, $I11ILIL)) {$id_creation_type =$this->module->GetOption(I7492); }$id_length =intval($id_length); if ($id_length <4 || $id_length >128) {$id_length =$this->module->GetOption('id_length'); }$id_splitter_period =intval($id_splitter_period); $number_of_coupons =intval($number_of_coupons); if ($number_of_coupons <1) {$number_of_coupons =$this->module->GetOption(I7490); }$number_of_activations =intval($number_of_activations); if ($number_of_activations) {$number_of_activations =abs(intval($number_of_activations_num)); }switch ($id_creation_type) {case 'sequent_numbers': $alphabet =I7457; $sql ="SELECT MAX(`coupon`) FROM `" .$this->oEshop->dbTablePrefix ."_coupons` c WHERE 1 " .$this->_ApplyFilters(); $id =floatval(preg_replace('/\D/', I7457, $this->db->getValue($sql))) +1; break; case 'letters': $alphabet ='abcdefghijklmnopqrstuvwxyz'; break; case I7496: $alphabet ='0123456789abcdefghijklmnopqrstuvwxyz'; break; default: $alphabet ='0123456789'; break; }$alphabetLength =mb_strlen($alphabet) -1; $splitterLength =mb_strlen($id_splitter); $I11ILll =$id_splitter_period >0 && $id_splitter_period <$id_length; $I1II1Ll =0; $I11ILlL =0; $I11ILl1 =$id_creation_type == 'sequent_numbers'; $time =strtotime(date('Y-m-d')); do {$ids =array ();$qty =$number_of_coupons -$I11ILlL; for ($i =0 ;$i <$qty ;$i++) {if ($I11ILl1) {$coupon =sprintf(I7497 .$id_length .'.0f', $id); $id =floatval($id +floatval(1)); }else {$coupon =I7457; for ($j =0 ;$j <$id_length ;$j++) {$coupon .= $alphabet[mt_rand(0, $alphabetLength)]; }}if ($I11ILll) {$coupon =mb_substr(chunk_split($coupon, $id_splitter_period, $id_splitter), 0, -$splitterLength); }$aSQL =array ('id_cat' => $cat_id, 'target' => 'eshop', I7485 => $coupon, I7498 => $this->langData, I7478 => intval($audit_new_owner) );foreach (array ('date_start', I7488) as $field) {$udate =$this->I11Il1I ?DateTools::getCorrectUDate($$field, $this->cms->DFMT['conf']) :($field == I7488 ?$GLOBALS[I7482] :$time); $aSQL[$field] =DateTools::toMysqlDate($udate); }if ($number_of_activations) {$aSQL[I7487] =$number_of_activations; }$sql =$this->db->genInsertSQL($this->oEshop->dbTablePrefix .'_coupons', $aSQL); if ($this->db->rawExecute($sql)) {$insertId =intval($this->db->lastInsertId()); if ($insertId != $I1II1Ll) {$ids[] =$insertId; $I1II1Ll =$insertId; }}}$count =sizeof($ids); if ($count >0 &$this->options['use_id_external'] && $this->options['generate_id_external']) {$sql =$this->db->genUpdateSQL($this->oEshop->dbTablePrefix .'_coupons', array (I7475 => "=|CONCAT('" .addslashes($this->options['auto_gen_id_external']) ."', `id`)" ),I7499 .implode(',', $ids) .")"); $this->db->execute($sql); }$I11ILlL += $count; }while ($I11ILlL <$number_of_coupons); $this->SetRedirect(true); }function TIIIIl1($memberId) {$sql ="DELETE FROM `" .$this->oEshop->dbTablePrefix ."_coupons` WHERE `id_member` = " .intval($memberId); $this->db->execute($sql); }}