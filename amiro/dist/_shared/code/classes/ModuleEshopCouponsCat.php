<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       7986 xkqwrltllnyxmyzqysyrmktqlrpxtiqpngsxzzkqmxmmykpkgzygyzgyixqxrqltynxipnir
 */ ?><?php foreach(array(7500=>'qDOHGzSIMn`GOG',7501=>'MS|GZPQ|IHSuJQ|nZIQ',7502=>'uDQ|HGtMHnD|fHrI',7503=>'JMIMt',7504=>'fJt|YMnS|IQIYQr',7505=>'',7506=>'SQfZuJt|GrQfMx',7507=>"SQfZuJt|GrQfMx",7508=>'ZWtMHn',7509=>'HYLQWt',7510=>'YMnS|IQIYQr',7511=>'?WOQWKQS',7512=>"mN?}",7513=>"|SMDWHuntD.?",7514=>"coqRq?.MS.?mN?}") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopCouponsCat extends CMS_CategoriesModule {public $oEshop; function ModuleEshopCouponsCat(&$cms, &$db, &$cModule) {parent::CMS_CategoriesModule($cms, $db, $cModule); if ($this->cms->Core->Side == 'admin') {require_once $GLOBALS['CLASSES_PATH'] .I7500; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init($this->moduleName); }else {CreateEshop($cms); $this->oEshop =&$cms->Eshop; }}function _Init($IIll1l1 =array (),$IIll1LI ='', $IIll1Ll ='', $aOptions =array ()){$IIIIL11 =array (I7501 => $this->oEshop->ownerName .'_coupons', 'use_id_page' => false, I7502 => false, 'default_prefix' => 'cc', 'description_field_name' => 'description', 'announce_field_name' => '', 'picture_cat' => $this->oEshop->ownerName .'_coupons', 'use_positions' => false, 'use_details_noindex' => false );$aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin(){ parent::_InitAdmin(); if($this->filter->issetField('datefrom')){ $this->filter->TITI1l1('datefrom'); }if($this->filter->issetField('dateto')){ $this->filter->TITI1l1('dateto'); }$this->filter->IL11l1L =array(I7503); }function TTTlIII() {parent::TTTlIII(); $aSelect =array ();$aSelect =$this->filter->TITI1TT($aSelect, array($this->cms->Words['all'] => '')); $aSelect =$this->filter->TITI1TT($aSelect, array ($this->words['bind_member_1'] => 1), 10); $aSelect =$this->filter->TITI1TT($aSelect, array ($this->words['bind_member_0'] => 0), 10); $this->filter->AddField(I7504, 'select', isset($this->cms->Vars[I7504]) ?$this->cms->Vars[I7504] :null, '', '=', 'bind_member', $aSelect); if(empty($this->cms->Vars[I7504])){ $this->filter->DisableFieldSQL(I7504); }}function _ApplyFilters($prefix =I7505, $bodyType =I7505, $IIlLLl1 =true) {$I11Il1L =$prefix; if (empty($I11Il1L)) {$I11Il1L =$this->options['default_prefix']; }$I11Il1L =str_replace('.', I7505, $I11Il1L); $res =" AND " .$I11Il1L .".target = 'eshop'" .parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); return $res; }function TTTlI11(&$vData, &$aCustom) {$prefix =$this->options[I7506]; $this->browser->InitSQL($prefix."*", "FROM ".$this->IIL1l1l.$this->IIL1LII, "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), "", $this->options[I7507]."name" );$aCustom['suppress_cat_sql_init'] =1; $aCustom['fields'] += array ('description' => array (I7508 => 'stripline', 'size' => 150), 'id' => array (I7508 => 'callback', I7509 => &$this, 'method' => '_adminListRowCB') );parent::TTTlI11($vData, $aCustom); }function _adminListRowCB(&$aItem, &$aData) {$aItem['bind_member'] =$this->words['bind_member_' .$aItem[I7510]]; }function TTT1IlI($aSQL =array(), $cId =0, $fields =array ('announce', 'body')) {if (!empty($this->cms->VarsPost['name'])) {$aSQL += array (I7510 => empty($this->cms->VarsPost[I7510]) ?0 :1, );}$aSQL =parent::TTT1IlI($aSQL, $cId, array ('description')); return $aSQL; }function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); if (sizeof($this->itemData)) {$this->itemData[I7510] =$this->itemData[I7510] ?I7511 :I7505; }}function _ActionDel($cId, $cModule) {$this->TIIII1T($cId); parent::_ActionDel($cId, $cModule); }function TTTl1I1(&$aGroupIds, $cModule) {$this->TIIII1T($aGroupIds); parent::TTTl1I1($aGroupIds, $cModule); }function _ActionPublish($cId, $cModule) {if ($this->cms->Vars['publish'] != 'on') {$this->TIIII1T($cId); }parent::_ActionPublish($cId, $cModule); }function TTTl11T(&$aGroupIds, $cModule) {$this->TIIII1T($aGroupIds); parent::TTTl11T($aGroupIds, $cModule); }function TTT1Tl1($cType, $cModule, $condition =I7505) {if ($cType != 'counters') {parent::TTT1Tl1($cType, $cModule, $condition); }}function TIIII1T($ids) {$condition ="WHERE `id_coupon_cat` " .(is_array($ids) ?I7512 .implode(',', $ids) .")" :"= " .$ids); $sql ="SELECT DISTINCT `id_parent` FROM `" .$this->oEshop->dbTablePrefix .I7513 .$condition; $rs =&$this->db->select($sql); if ($rs->numRows() >0) {$sql ="DELETE FROM `" .$this->oEshop->dbTablePrefix .I7513 .$condition; $this->db->execute($sql); $ids =array ();while ($record =$rs->nextRecord()) {$ids[] =$record['id_parent']; }$sql ="SELECT `id_parent` " ."FROM `" .$this->oEshop->dbTablePrefix .I7513 ."WHERE `id_parent` IN (" .implode(',', $ids) .") " ."GROUP BY `id_parent`"; $rs =&$this->db->select($sql); while (list ($id) =$rs->nextRecord(MYSQL_NUM)) {unset($ids[array_search($id, $ids)]); }if (sizeof($ids) >0) {$sql ="DELETE FROM `" .$this->oEshop->dbTablePrefix .I7513 .I7514 .implode(',', $ids) .")"; $this->db->execute($sql); }}}}