<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       24985 xkqwnrinlzgrnnimspmxmlxgpxsxurrpkiptuwugzynttsxlygqwgwuzwzzltrnlmlstpnir
 */ ?><?php foreach(array(7515=>'',7516=>"GuYJMDO|Hff",7517=>"DD|ZGGJB",7518=>"SQJ",7519=>'DD|ZGGJB',7520=>"SZtQtH",7521=>"?JMKQ?",7522=>"fJt|nZIQ",7523=>"SZtQ",7524=>"FRhi?",7525=>'fMQJSD',7526=>'IQtOHS',7527=>'HYLQWt',7528=>'vZJuQ',7529=>'Hff',7530=>'MD',7531=>'MD|DIZJJ|YZDQ',7532=>'Hn',7533=>'DtrMG|tZPD',7534=>'Qn',7535=>'HGtMHn|DQJQWtQS',7536=>'nZIQ',7537=>'HGtMHnD|JMDt',7538=>'DGQW|nHtGuYJMDOQS',7539=>'JQP|SQJ',7540=>"YuttHnD",7541=>"QxWOZnPQ",7542=>"",7543=>"ZWtMHnD",7544=>"DMIGJQ",7545=>"YZDQ|WHSQ",7546=>"nZIQ",7547=>'rZtQ',7548=>'ZWtMHn',7549=>'DMIGJQ|DQt|fMQJSD',7550=>"rZtQ",7551=>"nuI",7552=>'MD|YZDQ|DIZJJ',7553=>"|WurrQnWB?",7554=>'WOQWKQS',7555=>"rZtQ|SMDZYJQS",7556=>'GuYJMDO',7557=>"'",7558=>"MS",7559=>"'?coqRq?MS='",7560=>'QrrHr|WHSQ',7561=>"WHSQ",7562=>"YJuQ",7563=>"?coqRq?MS#@'",7564=>"WHSQ|SMPMt",7565=>"GrQfMx",7566=>"WHnf",7567=>"MS|QxtQrnZJ",7568=>'WHSQ') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopCurrency extends CMS_ActModule {public $I11ILLI; public $lastUpdate; public $I11ILLl; public $I11ILLL; public $I11ILL1; public $I11IL1I; public $oEshop; public $I11IL1l; public $numberDecimals; function ModuleEshopCurrency(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->I11ILLL =0; $this->I11IL1I =false; $this->I11ILL1 =Array(); if($this->cms->Core->Side!="admin") {CreateEshop($cms); $this->oEshop =&$cms->Eshop; }$this->numberDecimals =$this->module->GetOption("number_decimal_digits"); }function _Init($IIll1l1 =Array(), $IIll1LI =I7515, $IIll1Ll =I7515, $aOptions =Array()) {$IIIIL11["stop_use_sublinks"] =false; $IIIIL11["check_public"] =false; $IIIIL11['group_operations'] =Array("publish_on", I7516, "del"); $IIIIL11["allowed_actions"] =Array("publish", "activate", I7517, "add", "edit", "apply", "save", I7518); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->oEshop->init($this->moduleName); $this->oEshop->TT1l11l($this->options["multi_sites"], $this->siteId); $this->I11ILLL =$this->oEshop->TT11TlI($this->oEshop->baseCurrency); $this->I11IL1l =null; }function _InitAdmin() {parent::_InitAdmin(); require_once $GLOBALS['CLASSES_PATH'] .'EshopAdmin.php'; $this->oEshop =new EshopAdmin($this->cms, $this->words); }function TTTlITT($IIIL11l, $cId, $cModule =I7515) {$id =intval($cId); switch ($IIIL11l) {case 'activate': $this->_ActionActivate($id, $cModule); break; case I7519: $this->TIIII1I($id, $cModule); break; case 'currency_update': $this->TIIII1l($cModule); break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function TTTlIII() {parent::TTTlIII(); if($this->filter->issetField("datefrom")) $this->filter->TITI1l1("datefrom"); if($this->filter->issetField("dateto")) $this->filter->TITI1l1(I7520); $this->filter->AddField("flt_code", "text", stripslashes(unhtmlentities($this->cms->Vars["flt_code"])), "", I7521, "code"); $this->filter->MoveField("flt_code",_MOVE_START); $this->filter->AddField("flt_name", "text", stripslashes(unhtmlentities($this->cms->Vars[I7522])), "", I7521, "name"); }function TTTlI1I(&$vData) {$vData['on_small'] ='checked'; $vData[I7523] =date($this->cms->DFMT["php"]); parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {$this->browser->InitSQL("id, code, name, exchange, code_digit, DATE_FORMAT(last_update,'".$this->cms->DFMT["db"]."') AS udate, last_update, on_small, is_base, is_small_base", I7524.$this->oEshop->dbTablePrefix."_currency ", "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), "", "name" );$aCustom[I7525] =Array( 'exchange'=>Array('action'=>'callback', 'object'=>&$this, I7526=>'_FormatExchange'), 'actions'=>Array('action'=>'callback', I7527=>&$this, I7526=>'_CreateActions'), 'on_small'=>Array('action'=>'flagicon', I7528=>1, 'id'=>'pub_id', 'on'=>$this->moduleName.'_list:spec_public_on',I7529=>$this->moduleName.'_list:spec_public_off'), 'is_base'=>Array('action'=>'flagicon', I7528=>1, I7530=>'spec_act2_id', 'on'=>$this->moduleName.'_list:spec2_active_on',I7529=>$this->moduleName.'_list:spec2_active_off'), I7531=>Array('action'=>'flagicon', I7528=>1, 'id'=>'spec_act_id', I7532=>$this->moduleName.'_list:spec_active_on',I7529=>$this->moduleName.'_list:spec_active_off'), 'code'=>Array('action'=>I7533), 'name'=>Array('action'=>'stripline', 'size'=>25), );foreach(array($this->langData, I7534) as $lang){ $sql ="SELECT * FROM cms_es_currencies_list WHERE lang = '" .$lang ."' OR lang = 'en' ORDER BY `name` ASC"; $this->db->query($sql); $list =I7515; if($this->db->numRows() <1){ continue; }while ($this->db->next_record()) {$aRecord =$this->db->Record; if ($vData['code_digit'] == $aRecord['code_digit']) {$aRecord[I7535] =" selected"; }$aRecord['name_full'] =$aRecord['name']; $aRecord['name'] =$this->cms->stripLine($aRecord[I7536] .($aRecord['country_name'] ?' - ' .$aRecord['country_name'] :I7515), 50); $list .= $this->cms->Gui->get($this->moduleName.'_subform:option_row', $aRecord); }$vData[I7537] =$list; break; }unset($list); $aCustom['applied_id'] ='id'; $aCustom['legend'] =Array('spec_published', I7538, "leg_red", 'leg_yellow', 'leg_blue', 'leg_edit', I7539); if(is_object($this->filter)) {$this->filter->UpdateField("offset", $this->browser->Position); $aCustom['list_data']['filter_hidden_fields'] =$this->filter->GetFieldsAsHidden(); }$aCustom["form_data"][I7540] =Array("add", "apply", "cancel", "save"); parent::TTTlI11($vData, $aCustom); }function _FormatExchange(&$aItem, &$aData){ $aItem[I7541] =FormatNumber($aItem[I7541], $this->numberDecimals, $this->numberDecimals, true, true); if($aItem["is_base"] == 1) $aItem["disabled"] =" disabled"; else $aItem["disabled"] =I7542; }function _CreateActions(&$aItem, &$aData){ $aItem["edit_id"] =$aItem["del_id"] =$aItem['id']; if ($aItem["is_base"] == 1) {$aItem[I7543] =$this->cms->Gui->get($this->moduleName.'_list:icons_edit_deloff', $aItem); $aItem[I7543] .= $this->cms->Gui->get($this->moduleName.'_list:icon_none', $aItem); }else {$aItem[I7543] =$this->cms->Gui->get($this->moduleName.'_list:icons_edit_del', $aItem); }if($aItem["row_index"] == 1) {$style =$this->browser->style[I7544]; if($aData["_num_rows"]%2) $style =$this->browser->style["even"]; $aData["style"] =$style; }}function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {$this->numberDecimals =$this->module->GetOption('number_decimal_digits'); $sql ="SELECT exchange FROM ".$this->oEshop->dbTablePrefix."_currency WHERE lang='".$this->langData."' AND is_small_base=1"; $this->db->query($sql); if($this->db->next_record()){ $this->I11ILLI =$this->db->Record[I7541]; if($this->I11ILLI <= 0) $this->I11ILLI =1; $sql ="SELECT code, exchange as rate, name, prefix, postfix FROM ".$this->oEshop->dbTablePrefix."_currency WHERE on_small='1' AND is_small_base='1' ".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->I11ILL1 =Array( I7545=>$this->db->Record["code"], "base_rate"=>$this->db->Record["rate"], "base_name"=>$this->db->Record[I7546], "base_prefix"=>$this->db->Record["prefix"], "base_postfix"=>$this->db->Record["postfix"] );}$this->browser->InitSQL("id, is_base, code, exchange as rate, name, prefix, postfix, UNIX_TIMESTAMP(last_update) AS ulast_update, date_format(last_update,'".$this->cms->DFMT["db"]."') as date ", I7524.$this->oEshop->dbTablePrefix."_currency ", "WHERE on_small='1' ".$this->_ApplyFilters().$this->TTTlIl1(), I7542, I7546 );$aCustom[I7525][I7547] =Array('action'=>'callback', I7527=>&$this, I7526=>'_GetSmallDetailsRate'); $aCustom[I7525]['ulast_update'] =Array(I7548=>'callback', I7527=>&$this, I7526=>'_ProcessSmallDetailsDate'); $aCustom['list_data']['last_update'] =&$this->I11ILLl; $aCustom[I7549] =Array(I7546, "code", "exchange_rate", I7523, "prefix", "postfix"); parent::TTTll1I($vRes, $aCustom, $cType, $IIlLlII); }}function _GetSmallDetailsRate(&$aItem, &$aData){ $aItem += $this->I11ILL1; if ($this->I11ILLI >0) {$aItem[I7550] =FormatNumber((double)$this->I11ILLI/$aItem[I7550], $this->numberDecimals, $this->numberDecimals); }$aItem[I7550] =$this->cms->Gui->get($this->moduleName."_list:small_rate", $aItem); }function _ProcessSmallDetailsDate(&$aItem, &$aData){ if($aItem["ulast_update"] >$this->lastUpdate){ $this->lastUpdate =$aItem["ulast_update"]; $this->I11ILLl =date($this->cms->DFMT["php"], $this->lastUpdate); }}function TTTll11($cId, $cModule) {$sql ="SELECT count(*) AS num FROM ".$this->oEshop->dbTablePrefix."_currency WHERE lang='".$this->langData."' AND code like '".$this->cms->VarsPost['code']."'"; $this->db->query($sql); if($this->db->next_record()) {if($this->db->Record[I7551] == 1){ $this->cms->AddStatusMsg("status_currency_add_exist", "red"); }else{ parent::TTTll11($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno']) && $this->appliedId >0){ if(intval($this->cms->VarsPost['is_base']) == 1){ $this->TIIII11($this->appliedId); }if(intval($this->cms->VarsPost[I7552]) == 1){ $sql ="UPDATE ".$this->oEshop->dbTablePrefix."_currency SET is_small_base='0' WHERE lang='".$this->langData."'"; $this->db->query($sql); $sql ="UPDATE ".$this->oEshop->dbTablePrefix."_currency SET is_small_base='1' WHERE id='".$this->appliedId."'"; $this->db->query($sql); }}}}}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT *, DATE_FORMAT(last_update,'".$this->cms->DFMT["db"]."') AS fdate ". I7524.$this->oEshop->dbTablePrefix.I7553. "WHERE id='".$cId."'".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData['on_small'] =($this->itemData['on_small'] == 1) ?I7554: I7515; $this->itemData['is_base'] =($this->itemData['is_base'] == 1) ?I7554: I7515; $this->itemData[I7552] =($this->itemData[I7531] == 1) ?I7554: I7515; $this->itemData[I7541] =FormatNumber($this->itemData[I7541], $this->numberDecimals, $this->numberDecimals, true, true); $this->itemData[I7523] =date($this->cms->DFMT["php"]); if($this->itemData["is_base"]) {$this->itemData[I7555] ="disabled"; $this->itemData["is_base_disabled"] ="disabled"; }}}function TTTl1lI($cId, $cModule) {$sql ="SELECT count(*) AS num FROM ".$this->oEshop->dbTablePrefix."_currency WHERE lang='".$this->langData."' AND code like '".$this->cms->VarsPost['code']."' and id<>'".$cId."'"; $this->db->query($sql); if($this->db->next_record()) {if($this->db->Record[I7551] == 1){ $this->cms->AddStatusMsg("status_currency_add_exist", "red"); }else{ parent::TTTl1lI($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno']) && $this->appliedId >0){ if(intval($this->cms->VarsPost['is_base']) == 1){ $this->TIIII11($this->appliedId); }if(intval($this->cms->VarsPost[I7552]) == 1){ $sql ="UPDATE ".$this->oEshop->dbTablePrefix."_currency SET is_small_base='0' WHERE lang='".$this->langData."'"; $this->db->query($sql); $sql ="UPDATE ".$this->oEshop->dbTablePrefix."_currency SET is_small_base='1' WHERE id='".$this->appliedId."'"; $this->db->query($sql); }}}}}function _ActionPublish($cId, $cModule) {$this->TTT1IIT(($this->cms->Vars[I7556]==I7532), $cId, $this->module->GetTableName(), 'on_small', 'status_publish'); $this->SetLastError(); }function _ActionActivate($cId, $cModule) {$sql ="UPDATE ".$this->oEshop->dbTablePrefix."_currency SET is_small_base='0' WHERE id<>'".$cId.I7557.$this->_ApplyFilters(); $this->db->query($sql); $sql ="UPDATE ".$this->oEshop->dbTablePrefix."_currency SET is_small_base='1' WHERE id='".$cId.I7557; $this->db->query($sql); $this->SetLastError(); $this->cms->AddStatusMsg('status_activate'); $asql =false; $this->appliedId =$cId; $this->browser->SetApplied($this->db, $asql, $this->langData); $this->TTT1I1T(); }function TIIII1I($cId, $cModule) {if(is_array($this->cms->Vars["id"]) && sizeof($this->cms->Vars[I7558] >0)){ $I11IL1L =0; foreach($this->cms->Vars[I7558] as $key => $id) {$id =intval($id); $rate =doubleval(str_replace(",", ".", $this->cms->VarsPost[I7541.$id])); $rate =FormatNumber($rate, $this->numberDecimals, $this->numberDecimals, true, true); if($rate >0) {$sql ="UPDATE ".$this->oEshop->dbTablePrefix."_currency SET exchange='".$rate.I7559.$id.I7557; $this->db->query($sql); $I11IL1L += $this->db->affected_rows(); }}$this->cms->AddStatusMsg("status_currency_apply2", "blue", I7542, I7542, Array(I7551 => $I11IL1L.I7542)); }$this->SetLastError(); }function TTTl1I1(&$aGroupIds, $cModule) {$index =array_search($this->I11ILLL, $aGroupIds); if($index !== false) {unset($aGroupIds[$index]); }parent::TTTl1I1($aGroupIds, $cModule); }function TIIII1l() {$aResult =$this->oEshop->TT11TT1(true, true); if (1 || $result == true) {if (count($aResult) >0) {for ($i =0; $i <count($aResult); $i++) {$aTemp =$aResult[$i]; if($aTemp["code"] != $this->oEshop->baseCurrency) {if ($aTemp['success'] != 1) {if ($aTemp[I7560] !== 0) {if ($aTemp['code_digit'] == 0) {$aTemp[I7560] =5; }$errorCode =$this->words['status_currency_update_error_'.$aTemp[I7560]]; }else {$errorCode =I7542; }$this->cms->AddStatusMsg("status_currency_updated_fail", "red", I7542, I7542, Array(I7561=>$aTemp['code'], I7546=>$this->oEshop->getCurrencyName($aTemp['code']), "error"=>$errorCode)); }else {$this->cms->AddStatusMsg("status_currency_updated", I7562, I7542, I7542, Array(I7561=>$aTemp['code'], I7546=>$this->oEshop->getCurrencyName($aTemp['code']))); }}}}else {$this->cms->AddStatusMsg("status_currency_update_error_4", "red"); }}}function TIIII11($cId){ $sql ="SELECT exchange FROM ".$this->oEshop->dbTablePrefix."_currency WHERE is_base=0 AND id='".$cId."' AND lang='".$this->langData.I7557; $this->db->query($sql); if($this->db->next_record()) {$exchange =$this->db->Record[I7541]; $sql ="UPDATE ".$this->oEshop->dbTablePrefix."_currency SET is_base='0', exchange=exchange/".$exchange.I7563.$cId."' AND lang='".$this->langData.I7557; $this->db->query($sql); $sql ="UPDATE ".$this->oEshop->dbTablePrefix."_currency SET is_base=1, exchange=1 WHERE id='".$cId.I7557; $this->db->query($sql); $this->cms->AddStatusMsg('status_activate'); }}function TTT1IlI($aSql =Array(), $cId =0) {$error =true; $code =$this->cms->VarsPost[I7561]; $code_digit =$this->cms->VarsPost[I7564]; $exchange =$this->cms->VarsPost[I7541]; $aSql =Array(); if($this->I11IL1I && isset($this->cms->VarsPost[I7541]) && $this->cms->VarsPost[I7541] >0) {$error =false; }else {if(($code != I7515) && (($exchange >0) || !isset($this->cms->VarsPost[I7541]))) {$error =false; $aSql =Array( I7546 => $this->cms->VarsPost[I7546], I7561 => $code, I7564 => $code_digit, );if(isset($this->cms->VarsPost["on_small"])) {$aSql["on_small"] =$this->cms->VarsPost["on_small"]; }if(isset($this->cms->VarsPost["prefix"])) {$aSql[I7565] =$this->cms->VarsPost[I7565]; }if(isset($this->cms->VarsPost["postfix"])) {$aSql["postfix"] =$this->cms->VarsPost["postfix"]; }}}if(!$error) {$aSql["last_update"] =DateTools::toMysqlDate(DateTools::getCorrectUDate($this->cms->VarsPost[I7523], $this->cms->DFMT[I7566])); if(isset($this->cms->VarsPost[I7541])) {$aSql[I7541] =doubleval(str_replace(",", ".", $this->cms->VarsPost[I7541])); $aSql[I7541] =FormatNumber($aSql[I7541], $this->numberDecimals, $this->numberDecimals, true, true); }if(isset($this->cms->VarsPost["id_external"])) {$aSql["id_external"] =$this->cms->VarsPost[I7567]; }if($this->options['lang_data']) {$aSql['lang'] =$this->langData; }}return $aSql; }function getOptionsCB($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ='getallvalues') {switch($IIL1l1I) {case 'getallvalues': $res =array ();if (!is_array($this->I11IL1l)) {$this->I11IL1l =array ();$sql ="SELECT `code`, `name` FROM " .$this->oEshop->dbTablePrefix ."_currency WHERE `lang` = '" .$this->langData .I7557; $rs =&$this->db->select($sql); while ($record =$rs->nextRecord()) {$this->I11IL1l[] =array (I7536 => $record['code'], 'caption' => $record[I7536], 'selected' => $record[I7568] != $cData[I7528] ?I7515 :'selected' );}}$res =$this->I11IL1l; break; case 'correctvalue': $aIds =array ();foreach ($this->I11IL1l as $aData) {$aIds[] =$aData[I7536]; }$res =in_array($cData[I7528], $aIds) ?$cData[I7528] :0; break; case 'getvalue': $res =$cData[I7528]; break; }return true; }}