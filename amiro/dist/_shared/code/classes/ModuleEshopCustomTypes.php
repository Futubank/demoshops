<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       55073 xkqwmlxxxlzmyipmlkxutspngkpyliykzypmtygmgkxkyxzxsriiniyyyzlytisqwrkypnir
 */ ?><?php foreach(array(7569=>"tQxt",7570=>"SHuYJQ",7571=>"fJZPIZG",7572=>"GuYJMDO",7573=>"SQJ",7574=>'SQfZuJt|GrQfMx',7575=>'Qnv~rQEuQDt',7576=>'G',7577=>'fJt|DBD|nZIQ',7578=>'?JMKQ?',7579=>"ZJJ",7580=>"",7581=>'fJt|MD|GrHG',7582=>"fJt|MD|GrHG",7583=>"MS",7584=>"fJt|SZtZDQt|MS",7585=>"?hR?W`MS?Mn?}",7586=>"SZtQtH",7587=>'P',7588=>"ZSIMn|fHrI|3",7589=>'GrMWQ|JMDt|MnDtZJJQS',7590=>'fHrI|CMStO',7591=>'rQf|tZYJQ|nuI',7592=>"nZIQ",7593=>"DQJQWtQS",7594=>"fnuI",7595=>'SZtZDQtD',7596=>'MS',7597=>'DQJQWtQS',7598=>'',7599=>"1",7600=>'rQZJFMQJSD',7601=>"WZGtMHn",7602=>"JZDt|fJZP|nuI",7603=>"fJZPD|SZtZ",7604=>"0",7605=>"W",7606=>'W',7607=>'ZWtMHn',7608=>'|JMDt%GuYJMW|Hn',7609=>'HYLQWt',7610=>'IQtOHS',7611=>'vZJuQ|tBGQ',7612=>'|WuDtNZIQwy',7613=>'WZJJYZWK',7614=>'JQP|rQS',7615=>"fHrI|SZtZ",7616=>"DZvQ",7617=>"|JMDt%MWHnD|QSMt",7618=>'DBD|nZIQ',7619=>"ftBGQ",7620=>"SQfZuJt|WZGtMHn",7621=>"coqRq?MS='",7622=>"ftBGQ|",7623=>"SMDZYJQ|nHMnSQx",7624=>"DOHC|IQtOHS",7625=>"MD|JMnK",7626=>"ZSIMn|fHrI|",7627=>"^YHSB|MtQID^",7628=>"YHSB|tBGQ",7629=>"DOHC|YHSB|tBGQ",7630=>"^YHSB|WZtD|JMDt^",7631=>"WOQWKQS",7632=>"MD|GrHG",7633=>"GHDtfMx",7634=>"WuDtHI|tBGQ|HCnQr",7635=>"rQf|DHrt",7636=>"ZSIMn|fMJtQr",7637=>"fJZP",7638=>"rQf|tZYJQ|nuI",7639=>"rQf|DQt",7640=>"zjTqR?Tzyjq?",7641=>"m11m1jm",7642=>'QrrnH',7643=>"rQf|vZJuQ",7644=>"rQJZtQS|MtQID",7645=>"DWZJZr",7646=>"=''",7647=>"|WZtD?DQt?",7648=>"dqjqwT?MS?FRhi?",7649=>"vZJuQ|tBGQ",7650=>"ZJtQr",7651=>"?",7652=>"SQDWrMYQ?",7653=>'WZtQPHrB',7654=>"FMQJS",7655=>"|WZtD?sRhg?",7656=>"sqdwRmyq?",7657=>"|WZtD",7658=>"coqRq?.MS.?=?",7659=>"FRhi?",7660=>"fJZP|",7661=>"rQf|rQfQrQnWQ",7662=>"rQf|tZYJQ|nuI|tBGQ",7663=>"GuYJMW",7664=>"fJZP|WZGt|",7665=>"GrQfMx",7666=>"u",7667=>"SQDWrMGtMHn",7668=>"tQxt|WHIGZrMDHn",7669=>"ZSIMn|fHrI",7670=>'nZIQ',7671=>"rQJ|WZt|MtQI|HrSQr",7672=>'MtQI',7673=>"rQf|tZYJQ|nuI|DHrt",7674=>"DtZtuD|ZSS|fZMJ",7675=>"PQtZJJvZJuQD",7676=>"|WuDtHI|tBGQD?",7677=>"WHrrQWtvZJuQ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopCustomTypes extends CMS_ActModule{ public $oEshop; public $I11IL11; protected $I11I1II; protected $IL1IlLL; function ModuleEshopCustomTypes(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->I11IL11 =array("char" => "text", I7569 => "mediumtext", "int" => "int(11)", "float" => I7570, "date" => "datetime", "picture" => "varchar(128) not null default ''", I7571 => "bigint(64) unsigned not null default 0", "related_items" => I7569, "related_cats" => I7569, "ref_reference" => "int(11) not null default 0", "ref_set" => I7569); }function _Init($IIll1l1 =Array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =Array()) {$IIIIL11["allowed_actions"] =Array(I7572, "add", "edit", "apply", "save", I7573); $IIIIL11["group_operations"] =Array("publish_on", "publish_off", I7573); $IIIIL11["lang_data"] =false; $IIIIL11[I7574] ='c'; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin() {parent::_InitAdmin(); require_once $GLOBALS['CLASSES_PATH'] .'EshopAdmin.php'; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init($this->moduleName); $this->oEshop->TT1l11l($this->options["multi_sites"], $this->siteId); }function TTTlIII() {parent::TTTlIII(); $oRequest =AMI::getSingleton(I7575); $this->filter->AddField( 'flt_fnum', 'text', $oRequest->get('flt_fnum', '', array(I7576, 'g')), '', ' like ', 'c.fnum' );$this->filter->AddField( I7577, 'text', $oRequest->get(I7577, '', array(I7576, 'g')), '', I7578, 'c.fnum' );$I11I1Il =$oRequest->get('flt_admin_form', '', array(I7576, 'g')); $IL1Ll1L =array(); $IL1Ll1L =$this->filter->TITI1TT($IL1Ll1L, Array($this->cms->Words[I7579]=>0), 55); $IL1Ll1L =$this->filter->TITI1TT($IL1Ll1L, Array($this->words["flt_admin_form_yes"]=>1), 55); $IL1Ll1L =$this->filter->TITI1TT($IL1Ll1L, Array($this->words["flt_admin_form_no"]=>2), 55); $this->filter->AddField("flt_admin_form", "select", $I11I1Il, I7580, "=", "IF(c.admin_form=0, 2, 1)", $IL1Ll1L); $this->filter->MoveField("flt_admin_form", _MOVE_START); if($I11I1Il == 0) $this->filter->DisableFieldSQL("flt_admin_form"); $I11I1IL =$oRequest->get(I7581, '', array(I7576, 'g')); $I11I1I1 =array(); $I11I1I1 =$this->filter->TITI1TT($I11I1I1, Array($this->cms->Words[I7579]=>0), 55); $I11I1I1 =$this->filter->TITI1TT($I11I1I1, Array($this->words["is_prop_no"]=>1), 55); $I11I1I1 =$this->filter->TITI1TT($I11I1I1, Array($this->words["is_prop_yes"]=>2), 55); $this->filter->AddField(I7582, "select", $I11I1IL, I7580, "=", "c.is_prop+1", $I11I1I1); $this->filter->MoveField(I7582, _MOVE_START); if($I11I1IL == 0) $this->filter->DisableFieldSQL(I7582); $aDatasets =Array(); $aDatasets =$this->filter->TITI1TT($aDatasets, Array($this->cms->Words[I7579]=>0), 55); $sql ="select id, name, fields_map from ".$this->oEshop->dbTablePrefix."_datasets where lang='".$this->langData."' order by id"; $this->db->query($sql); $fieldsMap =I7580; $I11I1II =isset($this->cms->Vars['flt_dataset_id']) ?(int)$this->cms->Vars['flt_dataset_id'] :null; while($this->db->next_record()){ $aDatasets =$this->filter->TITI1TT($aDatasets, Array($this->db->Record["name"] => $this->db->Record[I7583]), 500); if($this->db->Record[I7583] == $I11I1II){ $fieldsMap =$this->db->Record["fields_map"]; }}$I11I1II =$oRequest->get('flt_dataset_id', '', array(I7576, 'g')); $this->I11I1II =(int)$I11I1II; $this->filter->AddField(I7584, "select", $I11I1II, I7580, "=", "c.id", $aDatasets); $this->filter->MoveField(I7584, _MOVE_START); $this->filter->TITIll1(I7584); if($this->cms->Vars[I7584]==0) {$this->filter->DisableFieldSQL(I7584); }else{ $I11I1lI =array(); foreach(explode(";", $fieldsMap) as $I11I1ll){ if(!empty($I11I1ll) && $I11I1ll >0 && $I11I1ll <100000){ $I11I1lI[] =$I11I1ll; }}if(sizeof($I11I1lI) >0) $this->filter->TITI1II(I7584, I7585.implode(",", $I11I1lI).")", "force"); else $this->filter->DisableFieldSQL(I7584); }$this->filter->TITI1l1("datefrom"); $this->filter->TITI1l1(I7586); $this->filter->AddField('mode', 'hidden', $oRequest->get('mode', '', array(I7587, I7576))); }function TTTlI1I(&$vData) {$vData["body_type_body_items"] ="selected"; $vData["body_type_body_cats"] ="selected"; $vData["body_type_body_search"] ="selected"; $vData["show_body_type_body_itemD"] ="selected"; if($this->action != "edit") {$vData[I7588] ="selected"; $vData["user_form"] ="checked"; }$vData[I7589] =$this->cms->Core->IsInstalled($this->oEshop->ownerName .'_price_list'); $vData['show_body_type_size'] =$vData[I7589] ?5 :4; $vData['category_custom_types_allowed'] =$this->module->IssetAndTrueOption("category_custom_types_allowed") ?1 :0; $vData['type_owner'] ='item'; parent::TTTlI1I($vData); $vData[I7590] ='100%'; }function TTTlI11(&$vData, &$aCustom) {$sql ="select r.table_num, r.name, r.ftype, c.id as fnum from ".$this->oEshop->dbTablePrefix."_ref_types r LEFT JOIN ".$this->oEshop->dbTablePrefix."_custom_types c ON r.table_num=c.ref_table_num group by r.table_num order by r.table_num"; $this->db->query($sql); $I11I1lL =array(); $ILL11LL =isset($this->itemData[I7591]) ?$this->itemData[I7591] :0; while($this->db->next_record()){ $ILLI1lI =unserialize($this->db->Record["name"]); if(!is_array($ILLI1lI)) $ILLI1lI =array(); if(isset($ILLI1lI[$this->langData])) $name =$ILLI1lI[$this->langData]; else $name =$this->words["unknown"]; $I11I1lL[$name] =array("value" => intval($this->db->Record["table_num"]), I7592 => str_replace("'", "\\'", unhtmlentities($name)), "ftype" => $this->db->Record["ftype"], I7593 => $ILL11LL == intval($this->db->Record["table_num"]) ?"1" :"0", "field_id" => $this->db->Record[I7594]); }ksort($I11I1lL); if(!isset($vData['reference_options'])){ $vData['reference_options'] =''; }foreach($I11I1lL as $null => $IL1I1LL) $vData["reference_options"] .= $this->cms->Gui->get($this->moduleName."_subform:reference_option", $IL1I1LL); $sql ="select id, name, fields_map, fields_shared from ".$this->oEshop->dbTablePrefix."_datasets where lang='".$this->langData."'"; $this->db->query($sql); $vData["datasets_comment_required"] =1; if(!isset($vData[I7595])){ $vData[I7595] =''; }while($this->db->next_record()){ $selected =!empty($this->itemData[I7583]) && mb_strpos($this->db->Record["fields_map"], ";".$this->itemData[I7583].";") !== false; if($this->I11I1II){ $selected =$selected || ($this->I11I1II == $this->db->Record[I7596]); }$I11I1l1 =array( 'value' => $this->db->Record[I7596], 'name' => $this->db->Record['name'], 'selected' => $selected ?I7597 :'' );if($I11I1l1[I7593] == I7593){ $vData["datasets_comment_required"] =0; }$vData["datasets"] .= $this->cms->Gui->get($this->moduleName."_subform:dataset_option", $I11I1l1); $_id =isset($this->itemData[I7596]) ?$this->itemData[I7596] :I7598; if(mb_strpos($this->db->Record["fields_shared"], ";".$_id.";") !== false){ $vData["is_field_shared"] =I7599; }else{ $vData["is_field_shared"] ="0"; }}if(!$GLOBALS["I11I1LI"]){ $vData["datasets_required"] =1; }if(!isset($vData[I7600])){ $vData[I7600] =I7598; }$sql ="select id, name, default_caption from ".$this->oEshop->dbTablePrefix."_custom_types order by fnum"; $this->db->query($sql); while($this->db->next_record()){ $I11I1Ll =unserialize($this->db->Record[I7592]); if(is_array($I11I1Ll)) $this->db->Record[I7592] =$I11I1Ll[$this->langData]; $I11I1LL =unserialize($this->db->Record["default_caption"]); if(is_array($I11I1LL)) $this->db->Record["default_caption"] =$I11I1LL[$this->langData]; $fieldData =array(I7583 => $this->db->Record[I7583], I7592 => $this->db->Record[I7592], I7601 => $this->db->Record["default_caption"]); $vData["realFields"] .= $this->cms->Gui->get($this->moduleName."_subform:real_field", $fieldData); }if(!isset($vData["HASFMPROP"])){ $sql ="select count(*) as count from ".$this->oEshop->dbTablePrefix."_custom_types where ftype='flagmap' && is_prop=1"; $this->db->query($sql); $this->db->next_record(); if($this->db->Record["count"] >0){ $vData["HASFMPROP"] =I7599; }}if(!isset($vData["last_flag_num"])) $vData[I7602] =1; if(!isset($vData['flag_set'])){ $vData['flag_set'] =I7598; }for($i =1; $i <= $vData[I7602]; $i++){ $ILL111I =array("flag_selected" => !empty($vData["flags_data"]) && $vData[I7603][$i]["u"] ?I7599 :"0", "flag_filter_selected" => !empty($vData[I7603]) && $vData[I7603][$i]["f"] ?I7599 :I7604, "flag_splitter_selected" => !empty($vData[I7603]) && $vData[I7603][$i]["s"] ?I7599 :I7604, "flag_capt" => !empty($vData[I7603][$i]["c"]) ?$vData[I7603][$i][I7605] :I7580); $vData["flag_set"] .= $this->cms->Gui->get($this->moduleName."_subform:flag_item", $ILL111I); }$this->browser->InitSQL("c.id, c.public, c.fnum, c.sys_name, c.ftype, c.value_type, c.name, c.default_caption, c.is_prop, count(d.id) as datasets", "FROM ".$this->oEshop->dbTablePrefix."_custom_types c LEFT JOIN ".$this->oEshop->dbTablePrefix."_datasets d ON position(CONCAT(';',c.id,';') in d.fields_map)>0", "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), "c.id", "c.fnum" );$this->browser->AddSQLJoinedTables($this->cms->Core, I7606, Array('d'=>$this->oEshop->dbTablePrefix."_datasets")); $aCustom['fields'] =Array( 'public'=>Array(I7607=>'flagicon', 'value'=>1, I7596=>'pub_id', 'on'=>$this->moduleName.I7608,'off'=>$this->moduleName.'_list:public_off'), 'fnum'=>Array(I7607=>'callback', I7609=>&$this, 'method'=>'_fieldNumCB'), 'sys_name'=>Array(I7607=>'callback', I7609=>$this, I7610=>'_SysNameCB'), 'ftype'=>Array(I7607=>'callback', I7609=>&$this, I7610=>'_fieldTypeCB'), I7611=>Array(I7607=>'callback', I7609=>&$this, I7610=>'_valueTypeCB'), 'name'=>Array(I7607=>'callback', I7609=>&$this, I7610=>I7612), 'default_caption'=>Array(I7607=>'callback', I7609=>&$this, I7610=>'_custDefCaptCB'), 'actions'=>Array(I7607=>I7613, I7609=>&$this, I7610=>'_actionsRow'), );$aCustom['applied_id'] ='c.id'; $aCustom['legend'] =Array(I7614, 'leg_yellow', 'leg_blue', 'leg_edit', 'leg_del'); $aCustom[I7615]["buttons"] =Array("add", "apply", "cancel", I7616); parent::TTTlI11($vData, $aCustom); }function _actionsRow(&$aItem, &$aData) {$links["del_id"] =$links["edit_id"] =$links["pub_id"] =$aItem[I7583]; $aItem["actions"] =$this->cms->Gui->get($this->moduleName.I7617, $links); $aItem["actions"] .= $this->cms->Gui->get($this->moduleName."_list:del", $links); }function _fieldNumCB(&$aItem, &$aData){ $aItem[I7594] =($aItem["is_prop"] ?"prop_" :I7580).intval($aItem[I7594]); }function _SysNameCB(&$aItem, &$aData){ $aItem[I7618] =($aItem['is_prop'] ?'prop_' :I7598) .$aItem[I7618]; }function _fieldTypeCB(&$aItem, &$aData){ $aItem["ftype"] =$this->words["ftype_".$aItem[I7619]]; }function _valueTypeCB(&$aItem, &$aData){ $aItem["value_type"] =$this->words["value_type_".$aItem["value_type"]]; }function _custNameCB(&$aItem, &$aData){ $data =unserialize($aItem[I7592]); $found =false; if(is_array($data)){ if(!empty($data[$this->langData])){ $aItem[I7592] =$this->cms->stripLine($data[$this->langData], 25); $found =true; }}if(!$found){ $aItem[I7592] =$this->words["unknown"]; }}function _custDefCaptCB(&$aItem, &$aData){ $data =unserialize($aItem[I7620]); $found =false; if(is_array($data)){ if(!empty($data[$this->langData])){ $aItem[I7620] =$this->cms->stripLine($data[$this->langData], 25); $found =true; }}if(!$found){ $aItem[I7620] =$this->words["unknown"]; }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT * ". "FROM ".$this->oEshop->dbTablePrefix."_custom_types ". I7621.$cId."'".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData["public"] =$this->itemData["public"] ?"checked" :I7580; $this->itemData[I7622.$this->itemData[I7619]] =I7593; $this->itemData["value_type_".$this->itemData["value_type"]] =I7593; $this->itemData["default_gui_type_".$this->itemData["default_gui_type"]] =I7593; $this->itemData["filter_existent_items_".$this->itemData["filter_existent_items"]] =I7593; $this->itemData["text_comparison_".$this->itemData["text_comparison"]] =I7593; $this->itemData["disable_noindex"] =!empty($this->itemData[I7623]) ?"checked" :I7598; $this->itemData["flagmap_method_".$this->itemData["flagmap_method"]] =I7593; $this->itemData["show_method_".$this->itemData[I7624]] =I7593; $this->itemData["is_prop_".($this->itemData["is_prop"] ?"yes" :"no")] =I7593; $this->itemData[I7625] =$this->itemData[I7625] ?"checked" :I7580; $this->itemData["no_rest"] =$this->itemData["no_rest"] ?"checked" :I7580; $this->itemData[I7626.$this->itemData["admin_form"]] =I7593; $this->itemData["user_form"] =$this->itemData["user_form"] ?"checked" :I7580; $this->itemData["show_empty_in_search"] =$this->itemData["show_empty_in_search"] ?"checked" :I7580; $this->itemData["body_type_body_items"] =mb_strpos($this->itemData["body_type"], I7627) !== false ?I7593 :I7580; $this->itemData["body_type_body_cats"] =mb_strpos($this->itemData["body_type"], ";body_cats;") !== false ?I7593 :I7580; $this->itemData["body_type_body_itemD"] =mb_strpos($this->itemData[I7628], ";body_itemD;") !== false ?I7593 :I7580; $this->itemData["body_type_body_search"] =mb_strpos($this->itemData[I7628], ";body_search;") !== false ?I7593 :I7580; $this->itemData["show_body_type_body_items"] =mb_strpos($this->itemData[I7629], I7627) !== false ?I7593 :I7580; $this->itemData["show_body_type_body_cats"] =mb_strpos($this->itemData[I7629], ";body_cats;") !== false ?I7593 :I7580; $this->itemData["show_body_type_body_itemD"] =mb_strpos($this->itemData[I7629], ";body_itemD;") !== false ?I7593 :I7580; $this->itemData["show_body_type_body_search"] =mb_strpos($this->itemData[I7629], ";body_search;") !== false ?I7593 :I7580; $this->itemData["show_body_type_price_list"] =mb_strpos($this->itemData[I7629], ";price_list;") !== false ?I7593 :I7580; $this->itemData["show_body_type_cats_list"] =mb_strpos($this->itemData[I7629], I7630) !== false ?I7593 :I7580; $this->itemData["show_body_type_body_catD"] =mb_strpos($this->itemData[I7629], ";body_catD;") !== false ?I7593 :I7580; $this->itemData["isnot_all"] =$this->itemData["isnot_all"] ?I7631 :I7580; $this->itemData["ITISPROP"] =$this->itemData["is_prop"]; if($this->itemData[I7619] == I7571 && $this->itemData["is_prop"]) $this->itemData["HASFMPROP"] =0; if($this->itemData[I7632]) $this->itemData[I7594] ="prop_".$this->itemData[I7594]; $data =unserialize($this->itemData[I7592]); $found =false; if(is_array($data)){ if(!empty($data[$this->langData])){ $this->itemData[I7592] =$data[$this->langData]; $found =true; }}if(!$found){ $this->itemData[I7592] =I7580; }$data =unserialize($this->itemData[I7620]); $found =false; if(is_array($data)){ if(!empty($data[$this->langData])){ $this->itemData[I7620] =$data[$this->langData]; $found =true; }}if(!$found){ $this->itemData[I7620] =I7580; }$data =unserialize($this->itemData["prefix"]); $found =false; if(is_array($data)){ if(!empty($data[$this->langData])){ $this->itemData["prefix"] =$data[$this->langData]; $found =true; }}if(!$found){ $this->itemData["prefix"] =I7580; }$data =unserialize($this->itemData[I7633]); $found =false; if(is_array($data)){ if(!empty($data[$this->langData])){ $this->itemData[I7633] =$data[$this->langData]; $found =true; }}if(!$found){ $this->itemData[I7633] =I7580; }$data =unserialize($this->itemData["description"]); $found =false; if(is_array($data)){ if(!empty($data[$this->langData])){ $this->itemData["description"] =$this->cms->htmlchars($data[$this->langData]); $found =true; }}if(!$found){ $this->itemData["description"] =I7580; }if ($this->itemData[I7632]) {$this->itemData['category_custom_types_allowed'] =0; }elseif ($this->module->IssetAndTrueOption("category_custom_types_allowed")) {$this->itemData['category_custom_types_allowed'] =1; if ($this->itemData["type_owner"] == 'category') {$this->itemData["custom_type_owner_cat"] =I7597; $this->itemData[I7634] ='custom_type_owner_cat'; }else {$this->itemData["custom_type_owner_item"] =I7597; $this->itemData[I7634] ='custom_type_owner_item'; }}$data =unserialize($this->itemData["default_params"]); if(is_array($data)){ if(!empty($data[I7635])) $this->itemData["ref_table_num_sort_".$data[I7635]] =I7593; if(!empty($data["ref_sort_method"])) $this->itemData["ref_table_num_sort_method_".$data["ref_sort_method"]] =I7593; if(!empty($data[I7636])) $this->itemData[I7636] =$data[I7636] ?I7631 :I7580; if(is_array($data["flag"][$this->langData])){ $this->itemData[I7602] =1; for($i =1; $i <= sizeof($data["flag"][$this->langData]); $i++){ if($data["flag"][$this->langData][$i]["u"] || $data[I7637][$this->langData][$i]["f"] || $data[I7637][$this->langData][$i][I7605]) $this->itemData[I7602] =$i; $this->itemData[I7603] =$data[I7637][$this->langData]; }}}unset($this->itemData["default_params"]); }}function TTTll11($cId, $cModule){ parent::TTTll11($cId, $cModule); $II1LLLL =$this->GetLastError(); $I11I1L1 =I7580; if(empty($II1LLLL['errno']) && $cId == 0 && $this->appliedId >0){ $sql ="select fnum, sys_name, ftype, value_type, ref_table_num, default_params, is_prop, default_caption from ".$this->oEshop->dbTablePrefix."_custom_types where id=".intval($this->appliedId); $this->db->query($sql); if($this->db->next_record()){ $I11I1L1 =$this->db->Record[I7620]; $ILLI11I =$this->db->Record[I7594]; $IL1IlLL =$this->db->Record[I7618]; $fieldName =($this->db->Record[I7632] == I7599 ?"prop_" :"custom_field_").$ILLI11I; $fieldType =I7580; $ILL11LL =$this->db->Record["value_type"] == "scalar" ?I7580 :intval($this->db->Record[I7638]); if($this->db->Record["value_type"] == "ref_reference"){ $fieldType =$this->I11IL11["ref_reference"]; }else if($this->db->Record["value_type"] == I7639){ $fieldType =$this->I11IL11[I7639]; }else{ $fieldType =$this->I11IL11[$this->db->Record[I7619]]; }if(!empty($fieldName) && !empty($fieldType)){ $this->db->setSafeSQLOptions("alter"); if($this->db->Record[I7632] == I7599){ $sql ="ALTER TABLE ".$this->oEshop->dbTablePrefix."_props ADD ".$fieldName." ".$fieldType; $this->db->query($sql); }else{ if($this->module->IssetAndTrueOption("category_custom_types_allowed") && ($this->cms->VarsPost[I7634] == 'category')){ $sql ="ALTER TABLE ".$this->oEshop->dbTablePrefix."_cats ADD ".$fieldName." ".$fieldType; }else{ $sql =I7640.$this->oEshop->dbTablePrefix."_items ADD ".$fieldName." ".$fieldType; }$this->db->query($sql); }}if($this->cms->VarsPost[I7619] == I7571 && $this->db->Record[I7632] != I7599){ $this->fn->TITTTII($this->oEshop->dbTablePrefix, $this->appliedId, $ILLI11I, 0); }}$ILLlIIL =(is_array($this->cms->VarsPost["datasets"]) ?$this->cms->VarsPost["datasets"] :array()); foreach($ILLlIIL as $datasetId){ AMI_Eshop::updateCatProps(substr($this->oEshop->dbTablePrefix, 4), null, $datasetId); }if(!$GLOBALS[I7641]){ $I11I1L1 =unserialize($I11I1L1); if(is_array($I11I1L1)) $I11I1L1 =$I11I1L1[$this->langData]; $this->fn->TITTTlI($ILLlIIL, $this->oEshop->dbTablePrefix, $this->appliedId, $I11I1L1); }if(sizeof($ILLlIIL) >0) $this->fn->TITTTlT($this->oEshop->dbTablePrefix, $ILLlIIL); }}function TTTl1lI($cId, $cModule) {$ILLI11I =0; $IL1IlLL =I7598; $fieldType =I7580; $I11I11I =I7580; $ILL11LL =I7580; $ILL11LI =false; $sql ="select fnum, sys_name, ftype, value_type, ref_table_num, default_params, is_prop from ".$this->oEshop->dbTablePrefix."_custom_types where id=".intval($cId); $this->db->query($sql); if($this->db->next_record()){ $ILLI11I =$this->db->Record[I7594]; $IL1IlLL =$this->db->Record[I7618]; $fieldType =$this->db->Record[I7619]; $I11I11I =$this->db->Record["value_type"]; $ILL11LL =$this->db->Record[I7638]; $ILL11LI =$this->db->Record[I7632]; $ILLI11L =unserialize($this->db->Record["default_params"]); if(!is_array($ILLI11L) || !is_array($ILLI11L[I7637])) $ILLI11L =array(I7637 => array()); $ILLI1LL =0; foreach($ILLI11L[I7637] as $lang => $data) if(is_array($data)) $ILLI1LL= max($ILLI1LL, ceil(sizeof($data)/63)); }parent::TTTl1lI($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL[I7642]) && $ILLI11I >0){ $I11I11l =true; if($this->cms->VarsPost["modify_data"]){ if($fieldType != $this->cms->VarsPost[I7619]){ if($this->cms->VarsPost["value_type"] == "scalar" && ($I11I11I == "scalar" || $I11I11I == I7643)) if($fieldType != I7571 && $fieldType != "related_items" && $fieldType != "related_cats" && $this->cms->VarsPost["value_type"] != I7571 && $this->cms->VarsPost["value_type"] != I7644 && $this->cms->VarsPost["value_type"] != "related_cats") $I11I11l =false; }else{ if($this->cms->VarsPost["value_type"] == "scalar" && ($I11I11I == I7645 || $I11I11I == I7643)) $I11I11l =false; else if($this->cms->VarsPost["value_type"] != I7645 && $this->cms->VarsPost["value_type"] == $I11I11I && $this->cms->VarsPost[I7638] == $ILL11LL) $I11I11l =false; }}if($I11I11l){ if($ILL11LI){ $sql ="UPDATE LOW_PRIORITY ".$this->oEshop->dbTablePrefix."_props set prop_".$ILLI11I.I7646; $this->db->query($sql); }else{ if($this->cms->VarsPost[I7634] == 'category'){ $sql ="UPDATE LOW_PRIORITY ".$this->oEshop->dbTablePrefix."_cats set custom_field_".$ILLI11I.I7646; }else{ $sql ="UPDATE LOW_PRIORITY ".$this->oEshop->dbTablePrefix."_items set custom_field_".$ILLI11I.I7646; }$this->db->query($sql); }if($fieldType == I7571 && $ILL11LI){ for($i =1; $i <= $ILLI1LL; $i++){ $fields[] ="custom_field_".$ILLI11I."_".$i.I7646; }if(sizeof($fields) >0){ if($this->cms->VarsPost[I7634] == 'category'){ $sql ="UPDATE LOW_PRIORITY ".$this->oEshop->dbTablePrefix.I7647.implode(",", $fields); }else{ $sql ="UPDATE LOW_PRIORITY ".$this->oEshop->dbTablePrefix."_items set ".implode(",", $fields); }$this->db->query($sql); }}if($ILL11LI){ $sql =I7648.$this->oEshop->dbTablePrefix."_props LIMIT 1"; $this->db->query($sql); }else{ if($this->cms->VarsPost[I7634] == 'category'){ $sql =I7648.$this->oEshop->dbTablePrefix."_cats LIMIT 1"; }else{ $sql =I7648.$this->oEshop->dbTablePrefix."_items LIMIT 1"; }$this->db->query($sql); }}if($fieldType != $this->cms->VarsPost[I7619] || $I11I11I != $this->cms->VarsPost[I7649]){ $fieldName =($ILL11LI ?"prop_" :"custom_field_").$ILLI11I; $fieldType =I7580; if($this->cms->VarsPost[I7649] == "ref_reference"){ $fieldType =$this->I11IL11["ref_reference"]; }else if($this->cms->VarsPost[I7649] == I7639){ $fieldType =$this->I11IL11[I7639]; }else{ $fieldType =$this->I11IL11[$this->cms->VarsPost[I7619]]; }if(!empty($fieldName) && !empty($fieldType)){ $this->db->setSafeSQLOptions(I7650); if($ILL11LI){ $sql =I7640.$this->oEshop->dbTablePrefix."_props MODIFY ".$fieldName." ".$fieldType; $this->db->query($sql); }else{ if($this->cms->VarsPost[I7634] == 'category'){ $sql =I7640.$this->oEshop->dbTablePrefix."_cats MODIFY ".$fieldName.I7651.$fieldType; }else{ $sql =I7640.$this->oEshop->dbTablePrefix."_items MODIFY ".$fieldName.I7651.$fieldType; }$this->db->query($sql); }}}if($this->cms->VarsPost[I7619] == I7571 && !$ILL11LI){ $this->fn->TITTTII($this->oEshop->dbTablePrefix, $cId, $ILLI11I, $ILLI1LL); }$ILLlIIL =(is_array($this->cms->VarsPost["datasets"]) ?$this->cms->VarsPost["datasets"] :array()); foreach($ILLlIIL as $datasetId){ AMI_Eshop::updateCatProps(substr($this->oEshop->dbTablePrefix, 4), null, $datasetId); }if(!$GLOBALS[I7641]){ $sql ="select default_caption from ".$this->oEshop->dbTablePrefix."_custom_types where id=".intval($cId); $this->db->query($sql); if($this->db->next_record()) $I11I1L1 =unserialize($this->db->Record[I7620]); if(is_array($I11I1L1)) $I11I1L1 =$I11I1L1[$this->langData]; $this->fn->TITTTlI($ILLlIIL, $this->oEshop->dbTablePrefix, $cId, $I11I1L1); }if(sizeof($ILLlIIL) >0) $this->fn->TITTTlT($this->oEshop->dbTablePrefix, $ILLlIIL); }}function _ActionDel($cId, $cModule) {$ILLI11I =0; $ILL11LI =0; $sql ="select fnum, is_prop, type_owner from ".$this->oEshop->dbTablePrefix."_custom_types where id=".intval($cId); $this->db->query($sql); if($this->db->next_record()){ $ILLI11I =$this->db->Record[I7594]; $ILL11LI =$this->db->Record[I7632]; $I11I11L =$this->db->Record["type_owner"]; }parent::_ActionDel($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL[I7642]) && $ILLI11I >0){ $this->db->setSafeSQLOptions("describe"); if($ILL11LI){ $sql =I7652.$this->oEshop->dbTablePrefix."_props"; $this->db->query($sql); $ILLIL11 =array(); while($this->db->next_record()) if($this->db->Record["Field"] == "prop_".$ILLI11I) $ILLIL11[] =$this->db->Record["Field"]; }else{ if($I11I11L == I7653){ $sql =I7652.$this->oEshop->dbTablePrefix."_cats"; }else{ $sql =I7652.$this->oEshop->dbTablePrefix."_items"; }$this->db->query($sql); $ILLIL11 =array(); while($this->db->next_record()) if($this->db->Record["Field"] == "custom_field_".$ILLI11I || mb_strpos($this->db->Record[I7654], "custom_field_".$ILLI11I."_") === 0) $ILLIL11[] =$this->db->Record[I7654]; }for($i =0; $i <sizeof($ILLIL11); $i++){ if(!empty($ILLIL11[$i])){ $this->db->setSafeSQLOptions(I7650); $this->db->setSafeSQLOptions("drop"); if($ILL11LI) $sql =I7640.$this->oEshop->dbTablePrefix."_props DROP ".$ILLIL11[$i]; elseif($I11I11L == I7653){ $sql =I7640.$this->oEshop->dbTablePrefix.I7655.$ILLIL11[$i]; }else{ $sql =I7640.$this->oEshop->dbTablePrefix."_items DROP ".$ILLIL11[$i]; }$this->db->query($sql); }}$this->fn->TITTTIl($this->oEshop->dbTablePrefix, $cId); }}function TTT1IlI($aSql =array(), $cId =0){ if($this->cms->VarsPost[I7632] == I7599) if($this->cms->VarsPost[I7619] == I7644 || $this->cms->VarsPost[I7619] == "related_cats" || $this->cms->VarsPost[I7649] == "ref_reference" || $this->cms->VarsPost[I7649] == I7639) $this->cms->VarsPost[I7632] =I7604; $IL1IlLL =mb_strtolower(mb_substr(trim($this->cms->VarsPost[I7618]), 0, 16)); if($cId == 0){ $ILLI1IL =0; $this->db->setSafeSQLOptions("describe"); if($this->cms->VarsPost[I7632] == I7599){ $sql =I7656.$this->oEshop->dbTablePrefix."_props"; $this->db->query($sql); while($this->db->next_record()){ if(mb_strpos($this->db->Record[I7654], "prop_") === 0){ $ILLI1IL =max($ILLI1IL, intval(mb_substr($this->db->Record[I7654], 5))); }}}else{ $sql =I7656.$this->oEshop->dbTablePrefix."_items"; $this->db->query($sql); while($this->db->next_record()){ if(mb_strpos($this->db->Record[I7654], "custom_field_") === 0){ $ILLI1IL =max($ILLI1IL, intval(mb_substr($this->db->Record[I7654], 13))); }}$sql =I7656.$this->oEshop->dbTablePrefix.I7657; $this->db->query($sql); while($this->db->next_record()){ if(mb_strpos($this->db->Record[I7654], "custom_field_") === 0){ $ILLI1IL =max($ILLI1IL, intval(mb_substr($this->db->Record[I7654], 13))); }}}$ILLI1IL++; if($IL1IlLL == I7598){ $IL1IlLL =($this->cms->VarsPost['is_prop'] ?'prop_' :I7598 ).$ILLI1IL; }}if(!preg_match('/^[a-z0-9\_]+$/', $IL1IlLL)){ $this->cms->AddStatusMsg('status_invalid_sys_name', 'black'); if($cId){ $sql ="SELECT `fnum` " ."FROM " .$this->oEshop->dbTablePrefix ."_custom_types " .I7658 .$cId; $this->db->query($sql); $this->db->next_record(); $IL1IlLL =$this->db->Record['fnum']; }else{ $IL1IlLL =$ILLI1IL; }}$name =$this->cms->VarsPost[I7592]; $default_caption =$this->cms->VarsPost[I7620]; if($name != I7598 && $default_caption != I7598){ $oQuery =DB_Query::getSnippet( "SELECT 1 " ."FROM " .$this->oEshop->dbTablePrefix ."_custom_types " ."WHERE `sys_name` = %s" .($cId ?" AND `id` != " .$cId :I7598) )->q($IL1IlLL); $oDB =AMI::getSingleton('db'); $I11I111 =$oDB->select($oQuery); if($I11I111->count()){ if($cId){ $IL1IlLL .= '_' .$cId; }else{ $sql ="SELECT max(`id`) `next` " .I7659 .$this->oEshop->dbTablePrefix ."_custom_types"; $this->db->query($sql); $this->db->next_record(); $IL1IlLL .= '_' .((int)$this->db->Record['next'] +1); }}$this->IL1IlLL =$IL1IlLL; $I11lIII =0; for($i =1; $i <= intval($this->cms->VarsPost["flags_number"]); $i++){ if(intval($this->cms->VarsPost[I7660.$i]) || intval($this->cms->VarsPost["flag_filter_".$i]) || intval($this->cms->VarsPost["flag_splitter_".$i]) || !empty($this->cms->VarsPost["flag_capt_".$i])) $I11lIII =$i; }$this->cms->VarsPost["flags_number"] =$I11lIII; $I11lIIl =false; if(($this->cms->VarsPost[I7649] == I7643 || $this->cms->VarsPost[I7649] == I7661 || $this->cms->VarsPost[I7649] == I7639)){ if($this->cms->VarsPost["ref_table_num_type"] == I7599 && intval($this->cms->VarsPost[I7638]) <= 0) $I11lIIl =true; else if($this->cms->VarsPost["ref_table_num_type"] == "2" && empty($this->cms->VarsPost["ref_table_num_new"])) $I11lIIl =true; if(!$I11lIIl && $this->cms->VarsPost[I7662] == "2"){ $I11lIIL =array(I7592 => $this->cms->VarsPost["ref_table_num_new"], I7620 => $this->cms->VarsPost["ref_table_num_new"], I7619 => $this->cms->VarsPost[I7619], "sys_alias" => I7580, I7663 => I7599); $I11lII1 =$this->fn->TTT1IlI($this->oEshop->dbTablePrefix, $I11lIIL); if($this->fn->TITTTTT($this->oEshop->dbTablePrefix, $I11lII1)){ $this->cms->VarsPost[I7638] =$I11lII1["table_num"]; }else $I11lIIl =true; }if($this->cms->VarsPost[I7619] == I7571){ $ILLI1LI =I7580; $ILLI1Ll =array(); for($i =1; $i <= intval($this->cms->VarsPost["flags_number"]); $i++){ $ILLI1LI .= ($this->cms->VarsPost[I7660.$i] == I7599 || $this->cms->VarsPost["flag_filter_".$i] == I7599 || $this->cms->VarsPost["flag_splitter_".$i] == I7599 || !empty($this->cms->VarsPost[I7664.$i])) ?I7599 :I7604; $ILLI1Ll[$i] =$this->cms->VarsPost[I7664.$i]; }$ILLI1LI =preg_replace('/^([10]*?)0*$/', "\\1", $ILLI1LI); $this->fn->TITTTIT($this->oEshop->dbTablePrefix, $this->cms->VarsPost[I7638], $ILLI1LI, $ILLI1Ll); }}if(!$I11lIIl){ if($cId == 0){ $ILLI1I1 =array(); $ILLI1lI =array(); $I11lIlI =array(); $I11lIll =array(); }else{ $sql ="select name, default_caption, description, prefix, postfix from ".$this->oEshop->dbTablePrefix."_custom_types where id=".intval($cId); $this->db->query($sql); if($this->db->next_record()){ $ILLI1lI =unserialize($this->db->Record[I7592]); if(!is_array($ILLI1lI)) $ILLI1lI =array(); $ILLI1I1 =unserialize($this->db->Record[I7620]); if(!is_array($ILLI1I1)) $ILLI1I1 =array(); $I11lIlL =unserialize($this->db->Record[I7633]); if(!is_array($I11lIlL)) $I11lIlL =array(); $I11lIl1 =unserialize($this->db->Record[I7665]); if(!is_array($I11lIl1)) $I11lIl1 =array(); $I11lIlI =unserialize($this->db->Record["description"]); if(!is_array($I11lIlI)) $I11lIlI =array(); $I11lIll =unserialize($this->db->Record["default_params"]); if(!is_array($I11lIll)) $I11lIll =array(); }}$ILLI1lI[$this->langData] =stripslashes($name); $ILLI1I1[$this->langData] =stripslashes($default_caption); $I11lIl1[$this->langData] =stripslashes($this->cms->VarsPost[I7665]); $I11lIlL[$this->langData] =stripslashes($this->cms->VarsPost[I7633]); $I11lIlI[$this->langData] =stripslashes($this->cms->VarsPost["description"]); if($this->cms->VarsPost[I7619] == I7571){ for($i =1; $i <= intval($this->cms->VarsPost["flags_number"]); $i++){ $I11lIll[I7637][$this->langData][$i] =array(I7666 => intval($this->cms->VarsPost[I7660.$i]), "f" => intval($this->cms->VarsPost["flag_filter_".$i]), "s" => intval($this->cms->VarsPost["flag_splitter_".$i]), I7605 => $this->cms->VarsPost[I7664.$i]); }}$aSql =Array( I7618 => $IL1IlLL, I7592=>addslashes(serialize($ILLI1lI)), I7663=>$this->cms->VarsPost[I7663] == 1 ?I7599 :I7604, I7667=>addslashes(serialize($I11lIlI)), I7620=>addslashes(serialize($ILLI1I1)), I7665=>addslashes(serialize($I11lIl1)), I7633=>addslashes(serialize($I11lIlL)), I7619=>$this->cms->VarsPost[I7619], I7649=>$this->cms->VarsPost[I7649], I7638=>$this->cms->VarsPost[I7638], I7632=>$this->cms->VarsPost[I7632], I7625=>$this->cms->VarsPost[I7625] ?I7599 :I7604, "no_rest"=>$this->cms->VarsPost["no_rest"] ?I7599 :I7604, "default_gui_type"=>$this->cms->VarsPost["default_gui_type"], I7668=>$this->cms->VarsPost[I7668], I7623=>$this->cms->VarsPost[I7623], "flagmap_method"=>$this->cms->VarsPost["flagmap_method"], I7624=>$this->cms->VarsPost[I7624], "isnot_all"=>intval($this->cms->VarsPost["isnot_all"]), I7669 => intval($this->cms->VarsPost[I7669]), "user_form" => intval($this->cms->VarsPost["user_form"]), "show_empty_in_search" => intval($this->cms->VarsPost["show_empty_in_search"]), "filter_existent_items" => intval($this->cms->VarsPost["filter_existent_items"]) );if(isset($this->cms->VarsPost["related_cats_items_num"])){ $aSql["rel_cat_item_num"] =$this->cms->VarsPost["related_cats_items_num"]; switch($this->cms->VarsPost["related_cats_items_sort_field"]){ case 'price': $aSql["rel_cat_item_field"] ='price'; break; default: $aSql["rel_cat_item_field"] =I7670; break; }switch ($this->cms->VarsPost["related_cats_items_sort_order"]){ case 'up': $aSql["rel_cat_item_order"] ='0'; break; default: $aSql[I7671] ='1'; break; }}$aSql['type_owner'] =$this->cms->VarsPost[I7634]; if(!$aSql['type_owner']){ $aSql['type_owner'] =I7672; }if(is_array($this->cms->VarsPost[I7628])){ for($b =0; $b <sizeof($this->cms->VarsPost[I7628]); $b++){ $aSql[I7628] .= ";".$this->cms->VarsPost[I7628][$b]; }}if(is_array($this->cms->VarsPost[I7629])){ for($b =0; $b <sizeof($this->cms->VarsPost[I7629]); $b++){ $aSql[I7629] .= ";".$this->cms->VarsPost[I7629][$b]; }}$aSql[I7628] .= ";"; $aSql[I7629] .= ";"; $I11lIll =array_merge($I11lIll, array(I7636 => $this->cms->VarsPost[I7636], I7635 => $this->cms->VarsPost[I7673], "ref_sort_method" => $this->cms->VarsPost["ref_table_num_sort_method"])); $aSql["default_params"] =addslashes(serialize($I11lIll)); if($cId == 0) $aSql[I7594] =intval($ILLI1IL); }else{ $this->SetLastError(1, "Reference creation failed"); $this->cms->AddStatusMsg(I7674, "red"); }}$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function getListReferencesRambler($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues"){ $I11lILI =array(); $I11lILI[I7649] =I7643; $I11lILI[I7632] =I7604; $I11lILI[I7619] ="char"; return $this->TIIIlTT($cData, $IIL1lL1, $res, $IIL1l1I, $I11lILI); }function TIIIlTT($cData, $IIL1lL1, &$res, $IIL1l1I ="getallvalues", $I11lILI){ switch($IIL1l1I){ case I7675: $res =array(); $I11lILl =I7599; foreach ($I11lILI as $field => $value) $I11lILl .= " AND ".$field." = '".$value."' "; $sql ="SELECT fnum, name ". I7659.$this->oEshop->dbTablePrefix.I7676. "WHERE ".$I11lILl.$this->_ApplyFilters(); $this->db->query($sql); while($this->db->next_record()) {$itemData =$this->db->Record; $data =unserialize($itemData[I7592]); $found =false; if(is_array($data)){ if(!empty($data[$this->langData])){ $itemData[I7592] =$data[$this->langData]; $found =true; }}if($found){ $res[] =array(I7592 => $itemData[I7594], I7601 => $itemData[I7592], I7593 => ($cData["value"] == $itemData[I7594] ?($IIL1lL1["SimpleMode"] ?I7593 :I7599) :I7580)); }}if (count($res) == 0) $res[] =array(I7592 => "-1", I7601 => "data_exchange_no_reference", I7593 => ($cData["value"] == -1 ?($IIL1lL1["SimpleMode"] ?I7593 :I7599) :I7580)); break; case "getvalue": $res =$cData["value"]; break; case I7677: $res =-1; break; case "apply": break; }return true; }}