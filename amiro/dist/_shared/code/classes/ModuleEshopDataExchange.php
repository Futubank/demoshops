<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       159801 xkqwrxmnzzkqwurzimlkqgprpptsgmzuqnzimsyqltntknzwprqmuyknsluntigmtmttpnir
 */ ?><?php foreach(array(7730=>'',7731=>"WZJJYZWKD",7732=>"GrQGZrQ|MIZPQD",7733=>"|grHWQDDRQfQrQnWQD",7734=>"SQJQtQ|WZtQPHrMQD",7735=>"|sQJQtQmtQID",7736=>"HYLQWt|MD|WZtQPHrB",7737=>"|grHWQDDhrSQrD",7738=>"",7739=>"QDOHG|GZrZID",7740=>'WuDtHIFMQJSD',7741=>'Qxt|',7742=>'IHSuJQD',7743=>'QxtQnDMHn',7744=>'GrQfMx',7745=>"QxtQrnZJ|rHHt|MS",7746=>"Qxt|",7747=>"SQJQtQ|IHSQ",7748=>"SQJ|ZJJ",7749=>"SQJ|WHnfMrI",7750=>'IZxCMStO',7751=>"|IZxOQMPOt",7752=>"|fMJQD",7753=>"|SMPMtZJD",7754=>"GrHWQDD|WurrQnWMQD",7755=>'Qxt|rQMnSQx',7756=>"MtQIwHuntQrDqnZYJQ",7757=>"MtQID",7758=>"|HrSQr",7759=>"WurrQnWB",7760=>"GrHWQDD|MtQID",7761=>"'",7762=>"ZuSMt|HCnQr",7763=>'DKMG|WHIIHn',7764=>"|SQ|tIG",7765=>"dqjqwT?MS?FRhi?",7766=>'^',7767=>"!",7768=>"GrHWQDD|rQfQrQnWQD",7769=>"|rQfQrQnWQ",7770=>"DBD|ZJMZD",7771=>"tZYJQ|nuI",7772=>"WOZr",7773=>"WID|",7774=>"MS",7775=>"|WurrQnWB?coqRq?",7776=>"ZGGJB",7777=>"MS|QxtQrnZJ",7778=>"SZtZ|tBGQ",7779=>'SZtZ|tBGQ',7780=>"nHnQ",7781=>"OtIJ|SQDWrMGtMHn",7782=>"SQJ",7783=>'tBGQ',7784=>'|SMDWZrS',7785=>"IQtZ|uGSZtQ",7786=>"uDQ|HGtMHnD|fHrI",7787=>"|MtQID",7788=>"~",7789=>"fHrWQ|HvQrCrMtQ",7790=>"DtHrQ|nZIQ",7791=>'|GW',7792=>'GHGuG',7793=>"fHrWQ|rQCrMtQ",7794=>"MS|GZrQnt|QxtQrnZJ",7795=>"JZnP",7796=>'MS|QxtQrnZJ',7797=>"|WZtD",7798=>"ms|qXTqRNzj",7799=>"?zNs?JZnP='",7800=>"Hn|DGQWMZJ",7801=>"nuIYQr",7802=>"|uDQrD",7803=>"PQt|MtQI|MS",7804=>"fMQJSD",7805=>"MIZPQD",7806=>"ZSS",7807=>"QSMt",7808=>"IZG|SY|tH|fHrI",7809=>'}\S-{$~DM',7810=>"nQC|fMQJSD",7811=>"rQfQrQnWQ",7812=>"DQt",7813=>"nZIQ",7814=>"GrMWQ|vZJuQ",7815=>'nZIQ',7816=>"GrMWQ|SY|fMQJS",7817=>"tZx|fMQJS|nZIQ",7818=>'GrMWQ',7819=>"SMDWHunt",7820=>"WOZrPQ",7821=>'IuJtMGJQ|DQJQWtMHn',7822=>'rZGMS|DI|SZtZ',7823=>'SQDWrMGtMHn',7824=>'oTij|md|zUThpqN',7825=>'DI|SZtZ',7826=>"MIGHrt|IHSuJQ|fHrI",7827=>"|DuYfHrI%MIGHrt|IHSuJQ|fHrI",7828=>"HrSQr|SZtQ|frHI",7829=>"QxGHrt|IHSuJQ|nZIQ",7830=>"|DuYfHrI%QxGHrt|",7831=>"WurrQnt|MS",7832=>"MD|WOMJSD",7833=>"\"",7834=>"Qxt|SZtZ",7835=>"QDOHG|MtQI",7836=>'bZnSQx`wuDtHI',7837=>"|SZtZ|QxWOZnPQ",7838=>"?zNs?",7839=>"'{",7840=>"MS|WZtQPHrB",7841=>"SQfZuJt|GrQfMx",7842=>'SQfZuJt|GrQfMx',7843=>"HrSQr|SZtQ|tH",7844=>"?zNs?DtZtuD?mN}'",7845=>"`",7846=>"MS|IQIYQr=",7847=>"||jhdT",7848=>"JZnP='",7849=>"GuYJMW",7850=>'MS|GZrQnt',7851=>'fMQJSD',7852=>"dqjqwT?.MS.?FRhi?",7853=>'EuHtQ',7854=>'DtQG',7855=>'*&',7856=>'SZtZ|DHurWQ|ftG',7857=>"tIG|nZIQ",7858=>"rQS",7859=>'UTF+8',7860=>'SZtZ|IQtZ|WDv',7861=>'WOQWKQS',7862=>'rQS',7863=>'MD|GrMWQ|JMDt',7864=>'ZnnHunWQ',7865=>'MtQID',7866=>'DKu',7867=>'DOMGGMnP',7868=>'MS|tZx|WJZDD',7869=>'IZx|EuZntMtB',7870=>"sqdwRmyq?",7871=>'JZnP',7872=>'RZGMS',7873=>'fMQJS',7874=>'SQfZuJtRuJQD',7875=>'fMJQ',7876=>'iqTz`wdV%%',7877=>'gRmwq|Tbgq',7878=>'WZGtMHn',7879=>'CMAZrSprHuGD',7880=>'!?',7881=>'RqFqRqNwq',7882=>'RhhT|gzTo',7883=>'CMAZrS|MIZPQ|DHurWQ|IHSuJQ',7884=>'wzTzjhp',7885=>'FUNw|mNwjUsqd|gzTo',7886=>'CMAZrS|SY|WHJD',7887=>'PrHuG|',7888=>'PrHuG',7889=>'WHJuIn',7890=>'DZIQ|WHJuIn|GrQv',7891=>'OMSSQn',7892=>'vZJuQ',7893=>'?DQJQWtQS',7894=>'|DuYfHrI%',7895=>'DGJMttQr',7896=>'WHrrQDGHnSQnWQ|WHJ',7897=>'&',7898=>'CMAZrS|tZY|WHntQnt',7899=>'fMQJS|',7900=>'nuI',7901=>'"',7902=>'WuDtHI',7903=>'tBGQD',7904=>'|',7905=>'wzTqphRb',7906=>'?WOQWKQS',7907=>'DQJQWtQS',7908=>'\n',7909=>'nuIYQr',7910=>':04S',7911=>'WHGB',7912=>'QxtrZ|GZrZIQtQrD',7913=>'HGQrZtMHn',7914=>'MIZPQ',7915=>'*',7916=>'nH|WHrrQDGHnSQnWQ',7917=>'WHIIHn|GrMWQ|tBGQ*',7918=>'MIGHrt|SrMvQr',7919=>'MtQI|fMQJSD|IZG',7920=>'!',7921=>'CMAZrS|vZJuQ|',7922=>'WJZDD|GZrZIQtQrD',7923=>'fMQJSD|IZG',7924=>'YMP|vZJuQ',7925=>'CAwHJuInD',7926=>'WZtD|',7927=>'ftBGQ',7928=>'rQJZtQS|MtQID',7929=>'DGQWMZJ|fJZP',7930=>'vZJuQD',7931=>'MtQI|JMnKD',7932=>'tZYJQ|nuI',7933=>'rQf|DQt',7934=>'rQf|vZJuQ',7935=>'CMAZrS|DGJMttQr',7936=>'PrHuGDTHhGtMHnD',7937=>'zNNhUNwq',7938=>'md|sqjqTqs',7939=>'sqdwRmgTmhN',7940=>'dmaq',7941=>'WJZDD',7942=>'oTij|kqbchRsd',7943=>'mizpq|dizjj',7944=>'smdwhUNT',7945=>"FRhi?",7946=>"'{?",7947=>'DWZJZr') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} define('MULTIPLE_SELECTION_REFERENCE_RECORD_LIMIT', 300); define('MAX_EXTRA_PRICE', 16); class ModuleEshopDataExchange extends CMS_DataExchangeModule {public $I11lLII; public $I11lLIl; public $oEshop; public $I11lLIL =true; public $I11lLI1 =I7730; public $I11lLlI; public $I11lLll; public $I11lLlL; public $I11lLl1; public $I11lLLI; public $I11lLLl =array(); public $I11lLLL =false; public $I11lLL1; public $I11lL1I; public $I11lL1l; public $I11lL1L; public $I11lL11; public $I11l1II; public $I11l1Il; public $I11l1IL; public $I11l1I1; public $I11l1lI; public $I11l1ll; public $I11l1lL; public $I11l1l1; public $I11l1LI; public $I11l1Ll =false; public $I11l1LL; public $I11l1L1; public $I11l11I; public $I11l11l; public $I11l11L; public $I11l111; public $I11LIII; public $I11LIIl; public $I11LIIL; public $I11LII1; public $I11LIlI; public $II1lLLI; public $I11LIll; public $I11LIlL; protected $I11LIl1 =array('HTML_TITLE', 'HTML_KEYWORDS', 'HTML_DESCRIPTION', 'HTML_IS_AUTOGEN'); function ModuleEshopDataExchange(&$cms, &$db, &$cModule) {parent::CMS_DataExchangeModule($cms, $db, $cModule); $this->II1lII1[I7731] += Array( "prepare_categories"=>"_PrepareCategories", "prepare_cat_images"=>"_PrepareCatImages", I7732=>"_PrepareImages", "prepare_files"=>"_PrepareFiles", "process_references"=>I7733, "delete_references"=>"_DeleteReferences", "process_categories"=>"_ProcessCategories", I7734=>"_DeleteCategories", "process_items"=>"_ProcessItems", "delete_items"=>I7735, "process_currencies"=>"_ProcessCurrencies", "delete_currency"=>"_DeleteCurrencies", I7736=>"_ObjectIsCategory", "process_users"=>"_ProcessUsers", "process_orders"=>I7737, );$this->I11lLlI =Array(); $this->I11lLll =Array(); $this->I11lLlL =Array(); $this->I11lLl1 ="eshop"; $this->I11lLLI =""; $this->I11lLL1 =""; $this->I11lL1I =""; $this->_useNumberGtd =false; $this->_useManufacturers =false; $this->_numberGtdField =I7738; $this->_manufacturersField =I7738; $this->I11lL11 =Array(); $this->_refTablesId =Array(); $this->I11l1II =Array(); $this->I11l1Il =Array(); $this->I11l1I1 =I7738; $this->I11lL1l =Array(); $this->I11lL1L =Array(); $this->I11l1ll =Array(); $this->I11l1lL =false; $this->I11l1l1 =29; $this->I11l1LI =Array(); $this->I11l1LL =Array(); $this->I11l1L1 =Array(); $this->I11l11I =true; $this->I11l11L =0; $this->I11l111 =0; $this->I11LIII =false; $this->I11LIIl =Array(); $this->I11LIIL =false; $this->I11LII1 =array ();$this->I11LIlI =array ();$this->II1lLLI =false; $this->I11LIlL =false; }function _Init($IIll1l1 =Array(), $IIll1LI =I7738, $IIll1Ll =I7738, $aOptions =Array()) {parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); if($this->module->IssetOption("destination_cat_id")) {$this->I11lLIl =intval($this->TTII111("destination_cat_id")); }else {}if(isset($this->cms->Vars["cat_id"])) {$this->I11lLIl =intval($this->cms->Vars["cat_id"]); }$this->II1lII1 += Array(I7739=>Array("destination_cat_id"=>$this->I11lLIl)); }function _InitAdmin() {parent::_InitAdmin(); require_once $GLOBALS['CLASSES_PATH'] .'EshopAdmin.php'; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init($this->moduleName); $this->oEshop->TT1l11l($this->options["multi_sites"], $this->siteId); $this->oEshop->tree->setCallbackObject($this); $this->oEshop->tree->setCallbackMethod("createChildsArrayFlt", "_treeArrayCB"); $this->oEshop->tree->setCallbackMethod("buildTreeOnChildsArray", "_buildTreeOnChildsArrayCB"); $this->I11lLl1 =$this->oEshop->ownerName; $this->I11LIll =array ('lang' => array (),I7740 => array (),'customFieldsReferenceData' => array (),'defaultRules' => array ());$I11LILI =array ('customFieldsEnabled' => array ('extension' => I7741 .$this->oEshop->ownerName .'_custom_fields', I7742 => array ('item' => $this->oEshop->ownerName .'_item') ),'imagesEnabled' => array (I7743 => 'ext_images', I7742 => array ('item' => $this->oEshop->ownerName .'_item') ));foreach ($I11LILI as $var => $aParams) {$this->I11LIll[$var] =array ();foreach ($aParams[I7742] as $key => $moduleName) {$enabled =false; if ($this->cms->Core->IsInstalled($moduleName)) {$enabled =in_array($aParams[I7743], $this->cms->Core->GetModOption($moduleName, 'extensions')); }if ($enabled) {$this->I11LIll[$var][] =$key; }}}}function _InitImport(&$aParams) {$res =true; $dbTablePrefix =(empty($aParams[I7744]) ?I7730 :$aParams[I7744]); switch($aParams["action"]) {case "common": $res =parent::_InitImport($aParams); $this->II1lllI["vars_post"] =$this->cms->VarsPost; $this->II1lllI["vars"] =$this->cms->Vars; $this->I11lLII =$this->TTII111(I7745); $this->I11lLII =$this->I11lLII[$this->langData]; $this->I11l1IL =$this->TTII111("references_tables_map"); $this->TIIIlII(); $aTmp =$this->cms->TTITITT(); $this->I11l1LI =array_flip($aTmp); if(isset($this->I11l1LI["id_external"])) {unset($this->I11l1LI["id_external"]); }unset($aTmp); $I11LILl =&$this->cms->Core->GetModule($this->oEshop->ownerName."_cat"); if($I11LILl->IsInstalled()){ $this->II1lLlI =in_array(I7746.$this->oEshop->ownerName."_cat_external_link", $I11LILl->GetAOption("extensions")); }unset($I11LILl); break; case "prepare_categories": $this->TTII1T1($this->oEshop->ownerName."_cat"); if($this->IIlIIIL[I7747] == "del_in_cat") {$res =$this->TTII1IT($this->oEshop->ownerName."_cat", "cat_fields_map", $dbTablePrefix); if ($this->IIlIIIL["cat_id"] == $this->II1llIL->Engine->oEshop->rootCatId) {$this->TTII1Il(I7748, 0); }elseif (isset($this->IIlIIIL["cat_id"])){ $this->cms->Vars["type"] ="del"; $this->cms->Vars["parent_skip"] =true; $this->II1llIL->Engine->TTTlITT(I7749, $this->IIlIIIL["cat_id"]); }$this->TTII1II(); }break; case I7732: $I11LILL =array('picture', 'popup_picture', 'small_picture'); foreach($I11LILL as $I11LIL1){ $this->I11lLLl[$I11LIL1] =array( I7750 => $this->cms->Core->GetModOption($this->oEshop->ownerName."_item", $I11LIL1."_maxwidth"), 'maxheight' => $this->cms->Core->GetModOption($this->oEshop->ownerName."_item", $I11LIL1.I7751) );}$this->I11lLLL =$this->cms->Core->GetModOption($this->oEshop->ownerName."_item", 'generate_bigger_image'); break; case "prepare_files": if(!$this->cms->Core->IsInstalled($this->oEshop->ownerName."_digitals") || !$this->cms->Core->IsInstalled($this->oEshop->ownerName.I7752)) {$res =false; }else {$this->I11lLL1 =$this->cms->Core->GetModOption($this->oEshop->ownerName."_digitals", "eshop_files_path"); $this->I11lL1I =$this->cms->Core->GetModOption($this->oEshop->ownerName."_digitals", "eshop_files_extension"); $res =$this->TTII1IT($this->oEshop->ownerName.I7753, "digitals_fields_map"); $this->II1llIL->SetOption("import_path", $this->I11lLL1); $this->I11lLL1 =$GLOBALS["PRIVATE_PATH"].$this->I11lLL1; if ($this->II1lLLI) {$this->II1llIL->Engine->options['lang_data'] =false; }}break; case I7754: $res =$this->TTII1IT($this->oEshop->ownerName."_currency", "currencies_fields_map"); break; case "process_references": $res =$this->TTII1IT($this->oEshop->ownerName."_reference", "references_fields_map", $dbTablePrefix); break; case "process_categories": $res =$this->TTII1IT($this->oEshop->ownerName."_cat", "cat_fields_map", $dbTablePrefix); $this->TIIIlI1("id_external"); if (is_object($this->II1llIL->Engine->ext[I7755])) {unset($this->II1llIL->Engine->ext[I7755]); }break; case "process_items": $res =$this->TTII1IT($this->oEshop->ownerName."_item", "item_fields_map", $dbTablePrefix); $this->TIIIlI1("id_external"); $this->I1IL1Ll[I7756] =$this->II1llIL->Engine->oEshop->itemCountersEnable; $this->II1llIL->Engine->oEshop->itemCountersEnable =false; if (is_object($this->II1llIL->Engine->ext[I7755])) {unset($this->II1llIL->Engine->ext[I7755]); }if($this->IIlIIIL[I7747] == "notmodif_items" || $this->IIlIIIL[I7747] == "owner_notmodif_items") {$sql ="select NOW() as timebeforeimport"; $this->db->query($sql); $this->db->next_record(); $this->I11l111 =$this->db->Record["timebeforeimport"]; }if($this->IIlIIIL[I7747] == I7757 && empty($this->skipDellAll)) {$this->TTII1Il(I7748, 0); }$IIlLIIL =Array("action"=>"prepare_to_import", "id"=>0); $this->II1llIL->Engine->TTT1lI1($IIlLIIL); break; case "process_users": $this->I11l11l =$this->TTII111("user_password_postfix"); $res =$this->TTII1IT($this->oEshop->ownerName."_user", "user_fields_map"); $this->TTII1T1($this->oEshop->ownerName."_user"); $this->II1llIL->Engine->user->setObligatory(Array()); break; case "process_orders": $res =$this->TTII1IT($this->oEshop->ownerName.I7758, "order_fields_map"); break; }return $res; }function TTII1I1(&$aParams) {$res =parent::TTII1I1($aParams); if($res) {switch($aParams["action"]) {case "process_eshop_order": $this->TIIIlI1("code"); $this->I11l1LL[I7759] =$this->I11l1ll[$this->II1llIL->Engine->defaultCurrency]; $this->I11l1LL["document_currency_code"] =$this->TTIlTTT($this->II1ll1L."_", "recipient_order_currency"); $this->I11l1LL["currency_id_external"] =$this->GetIdExternal(I7759, $this->I11l1LL["document_currency_code"], "code"); break; }}return $res; }function _FinalImport(&$aParams) {switch($aParams["action"]) {case "common": parent::_FinalImport($aParams); break; case "prepare_categories": break; case I7732: break; case I7760: if($this->IIlIIIL[I7747] == "notmodif_items") {$this->II1llIL->Engine->options["sql"] =array("where" => " AND modified_date < '".$this->I11l111.I7761); $this->TTII1Il(I7749, 0); }else if($this->IIlIIIL[I7747] == "owner_notmodif_items" && $this->I11l111 != 0) {$this->II1llIL->Engine->options["sql"]["where"] =" AND modified_date < '".$this->I11l111.I7761; if ($this->IIlIIIL[I7762] == 0) {$sess =admSession(); $this->IIlIIIL[I7762] =$sess->GetUserInfo("id"); }$this->II1llIL->Engine->options["sql"]["where"] .= " AND id_owner = '".$this->IIlIIIL[I7762].I7761; $this->TTII1Il(I7749, 0); }$this->TTII1II(); if (empty($aParams[I7763])) {if($this->TTII1IT($this->oEshop->ownerName."_cat", "cat_fields_map")) {$this->II1llIL->Engine->TTT1Tl1("counters", I7738); $this->TTII1II(); }}if($this->I11LIII && $this->I11LIIL) {$sql ="SELECT DISTINCT `external_rel_id` FROM " .$this->oEshop->dbTablePrefix .I7764; $rs =&$this->db->select($sql); $numRows =$rs->numRows(); $I11LI1I =0; while (list ($I11LI1l) =$rs->nextRecord(MYSQL_NUM)) {set_time_limit($this->I11l1l1); $sql ="SELECT `cms_id` FROM " .$this->oEshop->dbTablePrefix ."_de_tmp WHERE `external_rel_id` = '" .addslashes($I11LI1l) .I7761; $rs1 =&$this->db->select($sql); $ids =array ();while (list ($id) =$rs1->nextRecord(MYSQL_NUM)) {$ids[] =$id; }$I11LI1L =unserialize($I11LI1l); $I11LI11 =array ();foreach ($I11LI1L as $fieldName => $fieldData) {$I11LlII =explode($fieldData['splitter'], $fieldData['value']); $aTmp =array ();foreach ($I11LlII as $I11LlIl) {if ($I11LlIl != I7730) {$aTmp[] =$I11LlIl; }}set_time_limit($this->I11l1l1); $sql =I7765.$this->oEshop->dbTablePrefix."_items WHERE `id_external` IN ('" .implode("','", $aTmp) ."')"; $rs1 =&$this->db->select($sql); $aTmp =array ();while (list ($id) =$rs1->nextRecord(MYSQL_NUM)) {$aTmp[] =$id; }$I11LlIL =';' .implode(I7766, $aTmp) .I7766; foreach ($fieldData['fields'] as $I11LlI1) {$I11LI11[] =$I11LlI1 ."='" .$I11LlIL .I7761; }set_time_limit($this->I11l1l1); $sql ="UPDATE " .$this->oEshop->dbTablePrefix ."_items SET " .implode(I7767, $I11LI11)." WHERE id IN (" .implode(',', $ids). ")"; $this->db->execute($sql); }$this->TTII1Tl(++$I11LI1I, $numRows); }}break; case "prepare_files": case I7768: case "process_categories": case I7754: $this->TTII1II(); break; }return true; }function TIIIlIT() {if(!$this->I11LIIL) {$this->db->setSafeSQLOptions("create"); $sql ="CREATE TEMPORARY TABLE IF NOT EXISTS `".$this->oEshop->dbTablePrefix."_de_tmp` (`cms_id` int(11) unsigned NOT NULL, `external_rel_id` text NOT NULL, KEY `i_external_rel_id` (`external_rel_id`(255)))"; $this->db->query($sql); $this->I11LIIL =true; }}function TIIIlII() {$I11LllI =$this->cms->Core->IsInstalled($this->oEshop->ownerName.I7769); if($I11LllI && $this->cms->Core->IsInstalled(I7746.$this->oEshop->ownerName."_custom_fields")) {$this->I11l1I1 =$this->cms->Core->GetModOption($this->oEshop->ownerName.I7769, "table_name"); $sql ="SELECT * FROM ".$this->oEshop->dbTablePrefix."_ref_types ORDER BY id"; $this->db->query($sql); while ($this->db->next_record()) {$ILlL1l1 =$this->db->Record; if (!empty($ILlL1l1[I7770])) {$this->I11lL11[$this->db->Record[I7770]] =sprintf("%04d", $ILlL1l1["table_num"]); }else {$this->I11lL11[$ILlL1l1["table_num"]] =sprintf("%04d", $ILlL1l1[I7771]); }}$I11Llll ="custom_field_"; }if($this->cms->Core->IsInstalled(I7746.$this->oEshop->ownerName."_custom_fields")) {$this->I11l1lI =$this->cms->Core->GetModOption(I7746.$this->oEshop->ownerName."_custom_fields", "custom_types"); if(is_array($this->I11l1lI)) {$I11LllL =Array(I7772, "set"); foreach($this->I11l1lI as $index=>$I11Lll1) {$index++; $this->I11lL1L[$index.I7738] =$I11Llll.$index; if(in_array($I11Lll1[0], $I11LllL)) {$this->I11lL1l[$index.I7738] =$I11LllI; }else {$this->I11lL1l[$index.I7738] =true; }}}}}function TIIIlIl($I11LlLI) {$this->I11l1II[$I11LlLI] =false; if(isset($this->I11lL11[$this->I11l1IL[$I11LlLI]["id"]])) {$tableName =$this->I11lL11[$this->I11l1IL[$I11LlLI]["id"]]; if($tableName != I7738) {$sql ="SELECT id, name, id_external FROM ".I7773.$this->I11l1I1.$tableName." WHERE " .($this->II1lLLI ?I7730 :"lang='".$this->langData."' AND ") ."id_external!=''"; $this->db->query($sql); while($this->db->next_record()) {$this->I11l1Il[$this->I11l1IL[$I11LlLI][I7774]][$this->db->Record["id_external"]] =Array(I7774=>$this->db->Record[I7774], "name"=>$this->db->Record["name"]); }$this->I11l1II[$I11LlLI] =true; }}}function TIIIlI1($keyField) {if(!$this->I11l1lL) {$sql ="SELECT id, id_external, code FROM ".$this->oEshop->dbTablePrefix.I7775 .($this->II1lLLI ?I7730 :"lang='".$this->langData."' AND ") .$keyField."!=''"; $this->db->query($sql); while($this->db->next_record()) {$this->I11l1ll[$this->db->Record[$keyField]] =$this->db->Record; }$this->I11l1lL =true; }}function _ProcessCurrencies(&$aData) {set_time_limit($this->I11l1l1); $this->TIIIlI1("id_external"); $this->TTII11T($this->II1llIl, $aData); $action =($this->cms->VarsPost[I7774] >0) ?I7776 :"add"; if(!isset($this->II1lIl1[$action])) {$action ="none"; }if($action == I7776) {$this->II1llIL->Engine->I11IL1I =!isset($aData["CODE"]); $this->TTII1Il($action, $this->cms->VarsPost[I7774]); $this->II1llIL->Engine->I11IL1I =false; }elseif($action == "add") {$this->TTII1Il($action, $this->cms->VarsPost[I7774]); }if($this->TTII1lT($this->II1llIL, $action, I7738, $this->cms->VarsPost[I7777]) && $action <> "none") {$this->I11l1ll[stripslashes($this->cms->VarsPost[I7777])] =Array(I7774=>$this->II1llIL->Engine->appliedId, "code"=>mb_substr($this->cms->VarsPost["code"], 0, 3)); }}function _DeleteCurrencies(&$aData, &$II1L1II) {set_time_limit($this->I11l1l1); $this->TIIIlI1(I7777); foreach($II1L1II as $extId) {$id =$this->TIIIl11($extId); if(!empty($id)) {$aIds[] =$id; unset($this->I11l1ll[$extId]); }}parent::TTIlTTI($aData, $aIds); }function _ProcessReferences(&$aData) {set_time_limit($this->I11l1l1); if(!isset($this->I11l1II[$aData["data_type"]])) {$this->TIIIlIl($aData[I7778]); }$I11LlLl =sprintf('REFERENCE_NAME_%04d', $this->I11l1IL[$aData[I7778]][I7774]); if(isset($this->II1llIl[$I11LlLl]['splitter'])) {$aItems =explode($this->II1llIl[$I11LlLl]['splitter'], $aData[$I11LlLl]); foreach($aItems as $key => $value) {$aItems[$key] =array('data_type' => $aData[I7779], $I11LlLl => $value, 'ID_EXTERNAL' => $value); }}else {$aItems =array($aData); }foreach($aItems as $aData) {if(isset($this->I11l1II[$aData[I7778]]) && $this->I11l1II[$aData[I7778]]) {$this->TTII11T($this->II1llIl, $aData, true, Array(I7778=>$aData[I7778])); $this->cms->Vars["flt_table_name"] =intval($this->I11lL11[$this->I11l1IL[$aData[I7778]][I7774]]); $action =($this->cms->VarsPost[I7774] >0) ?I7776 :"add"; if(isset($this->II1lIl1[$action]) && $this->cms->Vars["name"] <> I7738) {$this->TTII1Il($action, $this->cms->VarsPost[I7774]); }else {$action =I7780; }if($this->TTII1lT($this->II1llIL, $action, I7738, $this->cms->VarsPost[I7777]) && $action <> I7780) {$this->I11l1Il[$this->I11l1IL[$aData[I7778]][I7774]][stripslashes($this->cms->VarsPost[I7777])] =Array(I7774=>$this->II1llIL->Engine->appliedId, "name"=>$this->cms->VarsPost["name"]); }}}}function _DeleteReferences(&$aData, &$II1L1II) {set_time_limit($this->I11l1l1); if(!isset($this->I11l1II[$aData[I7778]])) {$this->TIIIlIl($aData[I7778]); }if(isset($this->I11l1II[$aData[I7778]]) && $this->I11l1II[$aData[I7778]]) {$aIds =Array(); foreach($II1L1II as $extId) {$id =$this->TIIIl1l($aData[I7778], $extId); if(!empty($id)) {$aIds[] =$id; unset($this->I11l1Il[$this->I11l1IL[$aData[I7778]][I7774]][$extId]); }}$this->cms->Vars["flt_table_name"] =intval($this->I11lL11[$this->I11l1IL[$aData[I7778]][I7774]]); parent::TTIlTTI($aData, $aIds); }}function _ProcessCategories(&$aData, $keepItemCatId =false) {set_time_limit($this->I11l1l1); $this->TTII11T($this->II1llIl, $aData); $II1L1lI =stripslashes($this->cms->VarsPost[I7777]); if(isset($this->I11lLlL[$II1L1lI]) && $this->I11lLlL[$II1L1lI] >0) {$action =I7780; $this->I11lLlL[$II1L1lI]--; }else {if ($keepItemCatId) {$this->II1llIL->Engine->KeepItemCatId =true; }$action =(isset($this->I11lLll[$this->cms->VarsPost[I7774]])) ?"add" :I7776; if($action == I7776) {$this->cms->VarsPost["skip_sublink_changing"] =true; if (!empty($this->IIlIIIL["meta_update"]) && empty($this->cms->VarsPost["sublink"]) && empty($this->cms->VarsPost["html_title"]) && empty($this->cms->VarsPost["html_keywords"]) && empty($this->cms->VarsPost[I7781])) {$this->II1llIL->Engine->options["use_options_form"] =false; }}$this->TTII1Il(I7776, $this->cms->VarsPost[I7774]); }$this->TTII1lT($this->II1llIL, $action, I7738, $this->cms->VarsPost[I7777]); }function _DeleteCategories(&$aData, &$II1L1II) {set_time_limit($this->I11l1l1); foreach($II1L1II as $extId) {$aIds[] =$this->TIIIlll($extId); }$this->cms->Vars["type"] ="del"; $I11LlLL =$this->II1llll["del"]; $this->II1llll[I7782] =I7749; parent::TTIlTTI($aData, $aIds); $this->II1llll[I7782] =$I11LlLL; }function _ProcessItems(&$aData, $keepItemCatId =false) {set_time_limit($this->I11l1l1); $this->TTII11T($this->II1llIl, $aData, true, Array(I7777=>$aData["ID_EXTERNAL"])); $IIlLIIL =Array("action"=>I7760, I7774=>I7738, "data"=>&$this->cms->VarsPost); $this->TTT1lI1($IIlLIIL); $action =($this->cms->VarsPost[I7774] >0) ?I7776 :"add"; if ($action == I7776 && $keepItemCatId) {$this->II1llIL->Engine->KeepItemCatId =true; }$aEvent =array( I7783 => 'import', 'driver' => $this->II1lIlL, 'modId' => $this->module->II1llIL->Name, 'aItem' => &$this->cms->VarsPost, I7784 => FALSE );AMI_Event::fire('v5_on_dataexchange_item', $aEvent, AMI_Event::MOD_ANY); if(!empty($aEvent[I7784])){ $action ='skip_item'; }if(isset($this->II1lIl1[$action])){ $oldValue =$this->II1llIL->Engine->options["use_options_form"]; if($action == I7776) {$this->cms->VarsPost["skip_sublink_changing"] =true; if (!empty($this->IIlIIIL[I7785]) && empty($this->cms->VarsPost["sublink"]) && empty($this->cms->VarsPost["html_title"]) && empty($this->cms->VarsPost["html_keywords"]) && empty($this->cms->VarsPost[I7781])) {$this->II1llIL->Engine->options["use_options_form"] =false; }}$this->TTII1Il($action, $this->cms->VarsPost[I7774]); $this->II1llIL->Engine->options[I7786] =$oldValue; if($this->I11LIII && !empty($this->I11LIIl)) {$this->TIIIlIT(); $sql ="INSERT ".$this->oEshop->dbTablePrefix."_de_tmp VALUES ('" .($this->cms->VarsPost[I7774] ?$this->cms->VarsPost[I7774] :$this->II1llIL->Engine->appliedId) ."', '".addslashes(serialize($this->I11LIIl))."')"; $this->db->query($sql); $this->I11LIIl =Array(); }}else {$action =I7780; }$this->TTII1lT($this->II1llIL, $action, I7738, $this->cms->VarsPost[I7777]); }function _DeleteItems(&$aData, &$II1L1II) {set_time_limit($this->I11l1l1); $prefix =empty($aData[I7744]) ?I7730 :$aData[I7744]; $aIds =Array(); foreach($II1L1II as $extId) {$aIds[] =$this->TIIIl1T($extId, $prefix .$this->oEshop->dbTablePrefix.I7787); }parent::TTIlTTI($aData, $aIds); }function _PrepareImages($aData) {set_time_limit($this->I11l1l1); if(isset($aData["tmp_file_name"])) {$source =$aData["tmp_file_name"]; }else {$source =$aData["file_name"]; }$I11LlL1 =$GLOBALS["CUSTOM_PICTURES_PATH"].$this->I11lLl1.I7788; if(isset($aData["store_name"])) $I11LlL1 .= basename($aData["store_name"]); else $I11LlL1 .= basename($aData["file_name"]); if(!isset($aData["force_overwrite"])) $aData[I7789] =$this->I11l11I; if(!file_exists($I11LlL1) || $aData[I7789]) if(file_exists($this->importPath.$source)) {$res =$this->cms->TTITlTl($this->importPath.$source, $I11LlL1); $this->TIIIllT($I11LlL1); }}function _PrepareCatImages($aData) {set_time_limit($this->I11l1l1); if(isset($aData["tmp_file_name"])) {$source =$aData["tmp_file_name"]; }else {$source =$aData["file_name"]; }$I11LlL1 =$GLOBALS["CUSTOM_PICTURES_PATH"].$this->I11lLLI.I7788; if(isset($aData[I7790])) $I11LlL1 .= basename($aData[I7790]); else $I11LlL1 .= basename($aData["file_name"]); if(!isset($aData[I7789])) $aData[I7789] =$this->I11l11I; if(!file_exists($I11LlL1) || $aData[I7789]) if(file_exists($this->importPath.$source)) {$res =$this->cms->TTITlTl($this->importPath.$source, $I11LlL1); }}function TIIIllT($I11LlL1){ $aPathInfo =pathinfo($I11LlL1); $I11Ll1I =$GLOBALS["CUSTOM_PICTURES_PATH"].$this->I11lLl1."/generated/"; $I11Ll1l =array( 'picture' => I7791, 'popup_picture' => I7730, 'small_picture' => '_sm' );$aSrcImageSize =AMI_Lib_Image::imageGetSize($I11LlL1); if(is_array($aSrcImageSize)){ foreach($this->I11lLLl as $I11LIL1 => $I11Ll1L){ $maxWidth =$I11Ll1L[I7750]; $maxHeight =$I11Ll1L['maxheight']; if(!$maxWidth || !$maxHeight){ continue; }$width =$aSrcImageSize[0] ?$aSrcImageSize[0] :$maxWidth; $height =$aSrcImageSize[1] ?$aSrcImageSize[1] :$maxHeight; if( $width >$maxWidth || $height >$maxHeight || ($width <$maxWidth && $height <$maxHeight && $this->I11lLLL && mb_strpos($I11LIL1, I7792) === false )){if($width /$maxWidth >= $height /$maxHeight){ $height =ceil($height *$maxWidth /$width); $width =$maxWidth; }else{ $width =ceil($width *$maxHeight /$height); $height =$maxHeight; }}@unlink($I11Ll1I.$aPathInfo['filename'].'_'.$width.'x'.$height.$I11Ll1l[$I11LIL1].'.'.$aPathInfo[I7743]); }}}function _PrepareFiles($aData) {set_time_limit($this->I11l1l1); $this->TTII11T($this->II1llIl, $aData); $this->cms->VarsPost[I7793] =1; $this->TTII1Il(I7776, $this->cms->VarsPost[I7774]); if($this->TTII1lT($this->II1llIL, I7776, I7738, $this->cms->VarsPost[I7777])) {$this->I11l1L1[$this->cms->VarsPost["id_object_external"]][] =$this->II1llIL->Engine->appliedId; $this->TTII1Il("activate", $this->II1llIL->Engine->appliedId); }}function _PrepareCategories($aData, $keepItemCatId =false) {set_time_limit($this->I11l1l1); $prefix =empty($aData[I7744]) ?I7730 :(preg_match('/^' .$aData[I7744] .'/', $this->oEshop->dbTablePrefix) ?I7730 :$aData[I7744]); $catId =$this->TIIIlll($aData[I7777]); if($keepItemCatId) {$sql ="SELECT id_parent FROM ".$prefix .$this->oEshop->dbTablePrefix."_cats" ." WHERE id='".$catId.I7761 .($this->II1lLLI ?" AND lang='".$this->langData.I7761 :I7730); $this->db->query($sql); $this->db->next_record(); $parentCatId =$this->db->Record["id_parent"]; }if(empty($parentCatId)) {$parentCatId =$this->TIIIlll($aData[I7794]); if (intval($parentCatId) == 0) {$parentCatId =$this->TIII1TT(); }}if($catId == 0) {if(isset($this->II1lIl1["add"])) {$aSql =Array("id_parent"=>$parentCatId, "public"=>0, "name"=>$this->TTII11I($aData[I7777]), I7777=>$this->TTII11I($aData[I7777]), I7795=>$this->langData, "all_parents"=>I7767.$this->oEshop->tree->TI11lIl($parentCatId, true).I7767); $sql =$this->db->GenInsertSQL($prefix .$this->oEshop->dbTablePrefix."_cats", $aSql); if($this->db->query($sql)) {$newId =$this->db->lastInsertId(); $this->I11lLlI[$aData[I7777]] =$newId; $this->I11lLll[$newId] =true; if ($this->I11lLI1 != I7730) {$sql =$this->db->GenInsertSQL($this->I11lLI1 .$prefix .$this->oEshop->dbTablePrefix .'_cats', array ('id' => $newId, I7796 => $aSql[I7796], 'id_parent' => $parentCatId ));$this->db->execute($sql); }else {$sql ="UPDATE ".$prefix .$this->oEshop->dbTablePrefix."_cats SET position=id WHERE id='".$newId.I7761; $this->db->query($sql); }}}else {if(isset($this->I11lLlL[$aData[I7777]])) {$this->I11lLlL[$aData[I7777]]++; }else {$this->I11lLlL[$aData[I7777]] =1; }}}else {if(isset($this->II1lIl1[I7776]) && !isset($this->I11lLlL[$aData[I7777]])) {if (empty($this->I11lLI1)) {$aSql =Array("id_parent"=>$parentCatId); if($parentCatId != $catId){ $sql =$this->db->GenUpdateSQL($prefix .$this->oEshop->dbTablePrefix.I7797, $aSql, "WHERE id=".$catId); $this->db->query($sql); }else{ $parentCatId =0; }}}else {if(isset($this->I11lLlL[$aData[I7777]])) {$this->I11lLlL[$aData[I7777]]++; }else {$this->I11lLlL[$aData[I7777]] =1; }}}return true; }function _ProcessUsers(&$aData) {set_time_limit($this->I11l1l1); $this->TTII11T($this->II1llIl, $aData, true, Array(I7777=>$aData["ID_EXTERNAL"])); $action =($this->cms->VarsPost[I7774] >0) ?I7776 :"import"; if(isset($this->II1lIl1[$action])){ $this->TTII1Il($action, $this->cms->VarsPost[I7774]); }else {$action =I7780; }$this->TTII1lT($this->II1llIL, $action, I7738, $this->cms->VarsPost[I7777]); }function TIIIllI(&$aData, &$II1L1II) {set_time_limit($this->I11l1l1); $aIds =Array(); foreach($II1L1II as $extId) {$aIds[] =$this->TIIIl1T($extId, $this->oEshop->dbTablePrefix."_users"); }parent::TTIlTTI($aData, $aIds); }function _ProcessOrders(&$aData) {set_time_limit($this->I11l1l1); $this->TTII11T($this->II1llIl, $aData, true, Array(I7777=>$aData[I7798])); $action =($this->cms->VarsPost[I7774] >0) ?I7776 :I7738; if(isset($this->II1lIl1[$action])){ $this->TTII1Il($action, $this->cms->VarsPost[I7774]); }else {$action =I7780; }$this->TTII1lT($this->II1llIL, $action, I7738, $this->cms->VarsPost[I7777]); }function _ObjectIsCategory($II1LI1I) {return ($this->TIIIlll($II1LI1I) >0); }function TIIIlll($II1LI1I) {$res =0; if(isset($this->I11lLlI[$II1LI1I])) {$res =$this->I11lLlI[$II1LI1I]; }elseif($II1LI1I === $this->I11lLII) {$res =$this->I11lLIl; }else {if($this->II1lLlI) {$this->II1lLI1->Init($II1LI1I, $this->oEshop->ownerName."_cat"); if($this->II1lLI1->TTTT1Il()) {$res =$this->II1lLI1->TITIlT1(); $this->I11lLlL[$II1LI1I] =2147483647; $this->II1lLI1->Free(); }}if($res == 0){ $prefix =$this->I11lLI1 != I7730 ?(mb_strpos($this->oEshop->dbTablePrefix, $this->I11lLI1) !== 0 ?$this->I11lLI1 :I7730) :I7730; $sql ="SELECT id, id_external FROM " .$prefix .$this->oEshop->dbTablePrefix."_cats WHERE id_external='".$this->TTII11I($II1LI1I).I7761 .($this->I11lLIL ?" AND lang='".$this->langData.I7761 :I7730); $this->db->query($sql); if($this->db->next_record()) {$res =$this->db->Record[I7774]; }}if($res >0) {$this->I11lLlI[$II1LI1I] =$res; }}return $res; }function TIIIll1($II1LI1I) {$res =$this->I11lLIl; $sql ="SELECT id_category FROM ".$this->oEshop->dbTablePrefix."_items WHERE id_external='".$this->TTII11I($II1LI1I).I7761 .($this->II1lLLI ?" AND lang='".$this->langData.I7761 :I7730); $this->db->query($sql); if($this->db->next_record()) {$res =$this->db->Record["id_category"]; }return $res; }function TIIIl1T($II1LI1I, $tableName, $I11Ll11 =I7738) {$res =0; if($II1LI1I != I7738) {$sql =I7765.$tableName." WHERE id_external='".$this->TTII11I($II1LI1I).I7761 .($this->I11lLIL ?I7799.$this->langData.I7761 :I7730); $this->db->query($sql); if($this->db->next_record()) {$res =$this->db->Record[I7774]; }}return $res; }function TIIIl1I($II1LI1I, $tableName) {$res =0; if ($II1LI1I != I7738) {$sql ="SELECT id_member FROM ".$tableName." WHERE id_external='".$this->TTII11I($II1LI1I).I7761; $this->db->query($sql); if($this->db->next_record()) {$res =$this->db->Record["id_member"]; }}return $res; }function TIIIl1l($dataType, $extId) {$res =0; $I11LLII =$this->I11l1IL[$dataType][I7774]; if(isset($this->I11l1Il[$I11LLII][$extId])) {$res =$this->I11l1Il[$I11LLII][$extId][I7774]; }return $res; }function TIIIl11($extId) {$res =0; if(isset($this->I11l1ll[$extId])) {$res =$this->I11l1ll[$extId][I7774]; }return $res; }function TTII11l(&$aMap, $fieldName, &$fieldValue, &$IIll1lL, $params =Array()) {$II1L1IL =true; switch($aMap[$fieldName]["operation"]) {case I7800: if($aMap[$fieldName]["pre_operation"]) {$II1L1lL =Array($fieldName => $aMap[$fieldName]["pre_operation"]); $this->TTII11l($II1L1lL, $fieldName, $fieldValue, $IIll1lL, $params); }$II1L1IL =false; foreach($aMap[$fieldName]["fields"] as $II1L1I1) {$IIll1lL[$II1L1I1][$aMap[$fieldName]["number"]] =$fieldValue << $aMap[$fieldName][I7801]; }break; case "curr_rate": if($fieldValue >0) {$fieldValue =1/$fieldValue; }break; case "get_curr_id": $IIll1lL[I7777] =$fieldValue; $fieldValue =$this->TIIIl11($fieldValue); break; case "get_ref_id": $IIll1lL[I7777] =$fieldValue; $fieldValue =$this->TIIIl1l($params[I7778], $fieldValue); break; case "get_user_id": $IIll1lL[I7777] =$fieldValue; $fieldValue =$this->TIIIl1I($fieldValue, $this->oEshop->dbTablePrefix.I7802); break; case "get_order_id": $IIll1lL[I7777] =$fieldValue; $fieldValue =$this->TIIIl1T($fieldValue, $this->oEshop->dbTablePrefix."_orders"); break; case "get_cat_id": $IIll1lL[I7777] =$fieldValue; case "get_parent_cat_id": $fieldValue =$this->TIIIlll($fieldValue); if (intval($fieldValue) == 0) $fieldValue =$this->TIII1TT(); break; case I7803: $IIll1lL[I7777] =$fieldValue; $fieldValue =$this->TIIIl1T($fieldValue, $this->oEshop->dbTablePrefix.I7787); break; case "id_related": $II1L1IL =false; if($fieldValue != I7738 && !empty($aMap[$fieldName]["fields"])) {$this->I11LIIl[$fieldName]["value"] =$fieldValue; $this->I11LIIl[$fieldName]["fields"] =$aMap[$fieldName][I7804]; $this->I11LIIl[$fieldName]["splitter"] =$aMap[$fieldName]["splitter"]; $this->I11LIII =true; }break; case "image": if(file_exists($GLOBALS["CUSTOM_PICTURES_PATH"].$this->I11lLl1.I7788.$fieldValue)) {$fieldValue =$GLOBALS["CUSTOM_PICTURES_HTTP_PATH"].$this->I11lLl1.I7788.$fieldValue; $this->TTII1lT($this->II1llIL, "add", "images", $fieldValue); }else {$this->II1llIL->Engine->SetLastError(1, "image not found"); $this->TTII1lT($this->II1llIL, "add", I7805, $fieldValue); $this->II1llIL->Engine->SetLastError(); $fieldValue =I7738; }break; case "cat_image": if(!empty($fieldValue)){ $I11LLIl =!empty($this->I11lLLI) ?I7788 :I7738; if(file_exists($GLOBALS["CUSTOM_PICTURES_PATH"].$this->I11lLLI.$I11LLIl.$fieldValue) && !is_dir($GLOBALS["CUSTOM_PICTURES_PATH"].$this->I11lLLI.$I11LLIl.$fieldValue)) {$fieldValue =$GLOBALS["CUSTOM_PICTURES_HTTP_PATH"].$this->I11lLLI.$I11LLIl.$fieldValue; $this->TTII1lT($this->II1llIL, I7806, "cat_images", $fieldValue); }else {$this->II1llIL->Engine->SetLastError(1, "image not found"); $this->TTII1lT($this->II1llIL, I7806, "cat_images", $fieldValue); $this->II1llIL->Engine->SetLastError(); $fieldValue =I7738; }}break; case "get_cat_fields": $this->II1llIL->Engine->ProcessAction($a =I7807, $IIll1lL[I7774]); $I11LLIL =Array(); $itemData =$this->II1llIL->Engine->itemData; foreach($IIll1lL as $key=>$value) if(!isset($itemData[$key]) && isset($aMap[$fieldName]["new_fields"][$key])) $itemData[$key] =$IIll1lL[$key]; foreach($itemData as $key=>$value) {if(isset($aMap[$fieldName]["map_value_db_to_form"][$key][$value])) {$value =$aMap[$fieldName]["map_value_db_to_form"][$key][$value]; }if(isset($aMap[$fieldName]["map_db_to_form"][$key])) {$key =$aMap[$fieldName][I7808][$key]; }if(!is_numeric($key) && !isset($aMap[$fieldName]["new_fields"][$key]) && !isset($aMap[$fieldName]["skip_field"][$key])) {if(preg_match('/^'.$aMap[$fieldName]["price_db_field"].I7809, $key, $matches)){ $prices =$this->oEshop->TT11TlT($value); $I11LLIL[$aMap[$fieldName]["price_db_field"].$matches[1]] =$prices[$aMap[$fieldName]["price_db_field"]]; $I11LLIL[$aMap[$fieldName]["currency_db_field"].$matches[1]] =$prices[$aMap[$fieldName]["currency_db_field"]]; }else{ if(isset($this->I11l1LI[$key])) {$value =unhtmlentities($value); }$I11LLIL[$key] =$value; }}else if(isset($aMap[$fieldName][I7810][$key])) $I11LLIL[$key] =$IIll1lL[$key]; }$IIll1lL =$I11LLIL; $II1L1IL =false; break; case "add_files": $I11LLI1 =Array(); foreach($fieldValue as $index=>$I11LLlI) {$fileId =$this->TIIIl1T($I11LLlI, $this->oEshop->dbTablePrefix.I7752); if($fileId >0) {$I11LLI1[] =$fileId; }}$IIll1lL[$aMap[$fieldName]["file_ids_name"]] =implode(I7767, $I11LLI1); $IIll1lL[$aMap[$fieldName]["item_type_name"]] =(sizeof($I11LLI1) >0) ?"eshop_digitals" :I7738; $II1L1IL =false; break; case I7811: $II1L1IL =false; if(isset($this->I11lL1l[$aMap[$fieldName]["name"]]) && $this->I11lL1l[$aMap[$fieldName]["name"]]) {$I11LLll =true; if(is_numeric($aMap[$fieldName]["name"])) {switch($this->I11l1lI[$aMap[$fieldName]["name"]-1][0]) {case I7772: case I7812: $I11LLlL =$this->I11l1lI[$aMap[$fieldName]["name"]-1][1]; break; default: $I11LLll =false; }}else {$I11LLlL =$aMap[$fieldName]["name"]; }if($I11LLll) {if(isset($this->I11l1Il[$I11LLlL][$fieldValue])) {$fieldValue =$this->I11l1Il[$I11LLlL][$fieldValue]["name"]; $IIll1lL[$this->I11lL1L[$aMap[$fieldName]["name"]]] =$fieldValue; }}else {$IIll1lL[$this->I11lL1L[$aMap[$fieldName][I7813]]] =$fieldValue; }}break; case "cat_prices": $I11LLl1 =&$aMap[$fieldName]["map"]; $this->TTII1l1($I11LLl1); foreach($fieldValue as $priceNum=>$Il111lI) {if($priceNum >0) {$I11LLLI =$this->TTII11T($I11LLl1, $Il111lI, false); $IIll1lL[$aMap[$fieldName]["price_caption_field_name"].$priceNum] =$I11LLLI["price_caption"]; $IIll1lL[$aMap[$fieldName]["price_currency_field_name"].$priceNum] =$I11LLLI["currency_code"]; $IIll1lL[$aMap[$fieldName]['price_db_currency_field_name'] .$priceNum] =$I11LLLI['db_currency']; $IIll1lL[$aMap[$fieldName]["price_value_field_name"].$priceNum] =$I11LLLI[I7814]; }}$II1L1IL =false; break; case "get_item_fields": $this->II1llIL->Engine->itemData =array(); $this->II1llIL->Engine->ProcessAction($a =I7807, $IIll1lL[I7774]); $I11LLIL =Array(); foreach($this->II1llIL->Engine->itemData as $key=>$value) {if(!is_numeric($key)) {if(isset($aMap[$fieldName]["skip_field"][$key])) {continue; }if(isset($aMap[$fieldName][I7808][$key])) {$key =$aMap[$fieldName][I7808][$key]; }if(isset($aMap[$fieldName]["map_value_db_to_form"][$key][$value])) {$value =$aMap[$fieldName]["map_value_db_to_form"][$key][$value]; }if(isset($this->I11l1LI[$key]) || ($this->I11l1Ll && ($key == I7815 || substr($key, 0, 13) == 'custom_field_'))){ $value =unhtmlentities($value); }$I11LLIL[$key] =$value; }}$aFields =$IIll1lL; foreach($aMap[$fieldName]["map"] as $IL1lIL1=>$I11LLLl) {if(isset($aFields[$IL1lIL1])) {$aFields[$I11LLLl] =$aFields[$IL1lIL1]; }else {$aFields[$I11LLLl] =$I11LLIL[$IL1lIL1]; }$aFields["_".$IL1lIL1] =$I11LLIL[$IL1lIL1]; }if(is_array($fieldValue)) {$I11LLLL =$aMap[$fieldName]["price_field"]; $aFields[$I11LLLL] =$fieldValue; $I11LLL1 =$aMap[$fieldName][I7816]; if(isset($I11LLIL[$aMap[$fieldName][I7816]])) {$aFields[$I11LLLL][0][$aMap[$fieldName][I7816]."0"] =$I11LLIL[$aMap[$fieldName][I7816]]; }for($i=0;$i<$this->II1llIL->Engine->oEshop->numPrices;$i++) {$numPrice =$this->II1llIL->Engine->oEshop->priceFields[$i]; $I11LLL1 =$aMap[$fieldName][I7816].$numPrice; if(isset($I11LLIL[$I11LLL1])) {$aFields[$I11LLLL][$numPrice][$I11LLL1] =$I11LLIL[$I11LLL1]; }}$I11LL1I =$this->TTII11T($this->II1llIl, $aFields, false); $IIll1lL += $I11LL1I; }$IIll1lL += $I11LLIL; $II1L1IL =false; break; case "item_prices": $taxType =$aMap[$fieldName]["tax_type_field_value"]; $IIll1lL[$aMap[$fieldName]["tax_type_field_name"]] =$taxType; $tax =isset($IIll1lL[$aMap[$fieldName][I7817]]) ?$IIll1lL[$aMap[$fieldName][I7817]] :null; $I11LL1l =$tax; if(isset($IIll1lL["tax_old"])) {$I11LL1l =$IIll1lL["tax_old"]; }$IIll1lL[$aMap[$fieldName]["charge_tax_type_field_name"]] =$this->II1llIL->Engine->chargeTaxType; $I11LLl1 =&$aMap[$fieldName]["map"]; $this->TTII1l1($I11LLl1); foreach($fieldValue as $priceNum=>$Il111lI) {$I11LLLI =$this->TTII11T($I11LLl1, $Il111lI, false); if(isset($I11LLLI[I7818])){ if($I11LLLI[I7818] === I7730){ $price =null; }else{ $I11LLLI["price"] =str_replace(I7767, ".", $I11LLLI["price"]); $price =doubleval($I11LLLI["price"]); $discount =doubleval($I11LLLI[I7819]); if($discount != 0) {$price =$this->II1llIL->Engine->oEshop->TT11ITI($price, $discount); }if($this->II1llIL->Engine->chargeTaxType == "detach" && $I11LLLI["with_tax"] == "false") {$price =$this->II1llIL->Engine->oEshop->TT11T1l($price, $tax, $taxType, "charge", 1, true); }elseif($this->II1llIL->Engine->chargeTaxType == I7820 && $I11LLLI["with_tax"] == "true") {$price =$this->II1llIL->Engine->oEshop->TT11T1l($price, $tax, $taxType, "detach"); }}}else {$price =str_replace(I7767, ".", $Il111lI[$aMap[$fieldName]["price_value_field_name"].$priceNum]); if($tax != $I11LL1l && $this->II1llIL->Engine->chargeTaxType == "detach") {$price =$this->II1llIL->Engine->oEshop->TT11T1l($price, $I11LL1l, $taxType, "detach"); $price =$this->II1llIL->Engine->oEshop->TT11T1l($price, $tax, $taxType, I7820, 1, true); }}$IIll1lL[$aMap[$fieldName]["use_formula_field_name"].$priceNum] =$I11LLLI["use_formula_value"]; if($priceNum >0) {$IIll1lL[$aMap[$fieldName]["price_value_field_name"].$priceNum] =$price; }else {$IIll1lL[$aMap[$fieldName]["price_value_field_name"]] =$price; }}$II1L1IL =false; break; case "get_curr_code": $fieldValue =$this->I11l1ll[$fieldValue]["code"]; break; case "password": $IIll1lL[mb_strtolower($fieldName).$this->I11l11l] =$fieldValue; $II1L1IL =false; break; case I7821: if ($fieldValue != I7730 && !empty($aMap[$fieldName]['fields'])) {$this->TIII1TI($fieldName, $fieldValue, $aMap, $IIll1lL, $params); }break; case 'item_links': if($this->I11LIlL && $fieldValue != I7730){ $ids =array(); foreach(explode('|', $fieldValue) as $I11LL1L){ if(isset($this->I11lLlI[$I11LL1L])){ $ids[] =$this->I11lLlI[$I11LL1L]; }}$fieldValue =implode(',', $ids); }break; case I7822: $II1L1IL =false; if(empty($IIll1lL['sm_data'])){ $IIll1lL['sm_data'] =array( 'title' => I7730, 'keywords' => I7730, I7823 => I7730, 'is_kw_manual' => '1', 'filled' => '1' );}if($fieldName === I7824){ $fieldName ='HTML_IS_KW_MANUAL'; $fieldValue =$fieldValue == 'true' ?'0' :'1'; }$IIll1lL[I7825][mb_strtolower(mb_substr($fieldName, 5))] =$fieldValue; break; default: $II1L1IL =parent::TTII11l($aMap, $fieldName, $fieldValue, $IIll1lL, $params); }return $II1L1IL; }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); $this->oEshop->tree->createChildsArrayFlt(I7813); $this->oEshop->tree->initResult(Array("categories_list"=>I7738, "selected_id"=>$this->I11lLIl)); $this->oEshop->I1IL1Ll["is_childs"] =false; $this->oEshop->I1IL1Ll["level"] =0; $ILLILI1 =Array(); $ILLILI1 =$this->oEshop->tree->buildTreeOnChildsArray(); $vData += $ILLILI1; if(!isset($vData[I7826])){ $vData[I7826] =I7738; }$vData[I7826] .= $this->cms->Gui->get($this->moduleName.I7827, $vData); $vData[I7828] =I7738; $vData["order_date_to"] =date($this->cms->DFMT["php"]); }function TTTlI11(&$vData, &$aCustom) {foreach($this->aExportModules as $modName) {$vData[I7829] =$modName; $vData["export_".$modName."_form"] =$this->cms->Gui->get($this->moduleName.I7830.$modName."_form", $vData); }parent::TTTlI11($vData, $aCustom); }function _treeArrayCB(&$II11L1l, &$record, &$Il11L1l) {$II11L1l[] =Array(I7774=>$record[I7774], I7813=>$record[I7813]); }function _buildTreeOnChildsArrayCB(&$res, &$child, &$Il11L1l) {$indent =str_repeat("&middot;&nbsp;", $Il11L1l["level"]); if(isset($res["current_id"]) && ($res[I7831] == $child[I7774])) {$this->I1IL1Ll["level"] =$Il11L1l["level"]; $this->I1IL1Ll["is_childs"] =true; }elseif(isset($this->I1IL1Ll["is_childs"]) && $this->I1IL1Ll[I7832]) {if($this->I1IL1Ll["level"] >= $Il11L1l["level"]) {$this->I1IL1Ll[I7832] =false; }}if(!isset($this->I1IL1Ll[I7832]) || !$this->I1IL1Ll[I7832]) {$res["categories_list"] .= "<option value=\"".$child[I7774].I7833.(($res["selected_id"] == $child[I7774])?" selected":I7738).">".$indent.$this->cms->stripLine($child[I7813], 50, true); }return true; }function TTII1TI($id, $II1ILLL, &$aData, $II1IL1l, $II1IL1L) {$aData += $this->I11l1LL; $this->II1llIL->Engine->oEshop->pushCurrencyData($aData["ext_data"][I7759], $aData[I7834]["base_currency"]["code"]); $aData["document_currency_rate"] =$this->II1llIL->Engine->oEshop->convertCurrency(1, $this->II1llIL->Engine->defaultCurrency, $this->I11l1LL["document_currency_code"]); $this->II1llIL->Engine->oEshop->TT11T1T(); return parent::TTII1TI($id, $II1ILLL, $aData, $II1IL1l, $II1IL1L); }function TTIIl1l($II1ILLL, &$aParams, $I11LL11 =array()) {$filter =I7738; switch($II1ILLL) {case I7835: case $this->oEshop->ownerName."_item": if(($this->cms->VarsGet['export_driver'] == 'YandexEshopDriver') && (mb_substr($I11LL11['export_type'], 0, 13) == I7836)){ $I11L1II =true; $I11L1Il =$this->cms->VarsGet["yandex_field"]; $I11L1IL =$this->cms->VarsGet["yandex_values"]; if($I11L1Il && $I11L1IL){ $I11L1I1 =$this->TIII1Tl(); if(!in_array($I11L1Il, $I11L1I1)){ $I11L1II =false; }else{ $I11L1lI =array(); if(!is_array($I11L1IL)){ $I11L1lI[] =$I11L1IL; }else{ $I11L1lI =$I11L1IL; }}}else{ $I11L1II =false; }if(!$I11L1II){ if($this->cms->Core->IssetModOption($this->oEshop->ownerName."_data_exchange", "YandexEshopDriver_yandex_custom_field") && $this->cms->Core->IssetModOption($this->oEshop->ownerName.I7837, "YandexEshopDriver_yandex_custom_field_values")){ $I11L1Il =$this->cms->Core->GetModOption($this->oEshop->ownerName.I7837, "YandexEshopDriver_yandex_custom_field"); $I11L1ll =$this->cms->Core->GetModOption($this->oEshop->ownerName.I7837, "YandexEshopDriver_yandex_custom_field_values"); $I11L1lI =explode(I7767, $I11L1ll); }}if($I11L1Il && is_array($I11L1lI) && sizeof($I11L1lI)){ $I11L1lI =array_map("mysql_real_escape_string", $I11L1lI); $filter .= I7838.$aParams["default_prefix"]."`".$I11L1Il."` IN ('".implode("','",$I11L1lI).I7839; }}$aParams["join"] ="JOIN ".$this->oEshop->dbTablePrefix."_cats AS c ON c.id=".$aParams["default_prefix"].I7840; $filter .= " AND c.public=1"; $I11L1lL =$this->cms->Core->GetModOption($this->oEshop->ownerName.I7837, "export_positive_price"); if($I11L1lL) {$filter .= I7838.$aParams["default_prefix"]."price >0 and ".$aParams[I7841]."price is NOT NULL "; }if(!$this->cms->Core->GetModOption('eshop_item', 'item_links_allowed') || !$this->module->GetOption('export_item_links')){ $filter .= I7838 .$aParams[I7842] ."id_source = 0"; }break; case "eshop_order": case $this->oEshop->ownerName.I7758: if(!empty($aParams[I7828])) {$date =DateTools::getCorrectUDate($aParams[I7828], $this->cms->DFMT["conf"]); $date =DateTools::toMysqlDate($date); $filter .= " AND order_date>='".$date.I7761; }if(!empty($aParams[I7843])) {$date =DateTools::getCorrectUDate($aParams[I7843], $this->cms->DFMT["conf"]); $date =DateTools::toMysqlDate($date); $filter .= " AND order_date<='".$date.I7761; }$I11L1l1 =$this->TTIlTTT($this->II1ll1L."_", "recipient_order_statuses"); if(sizeof($I11L1l1) >0) {$filter .= I7844.implode("','", $I11L1l1).I7839; }break; case "eshop_user": case $this->oEshop->ownerName."_user": $prefix =$this->II1llIL->Engine->options[I7841]; $alias =I7738; if ($prefix != I7738) {$alias =" AS ".str_replace(I7845, I7738, $prefix); }$aParams[I7841] ="eu."; $aParams["join"] =" INNER JOIN cms_members ".$alias." ON ".$aParams[I7841].I7846.$prefix."id "; break; }$aParams["where"] .= $filter; $sql =parent::TTIIl1l($II1ILLL, $aParams); return $sql; }function GetIdExternal($module, $id, $II1IL11 =I7774) {return parent::GetIdExternal($this->oEshop->ownerName."_".$module, $id, $II1IL11); }function TIII1TT() {if ($this->lostCatId == 0) {set_time_limit($this->I11l1l1); $aData =array(); $aData[I7813] =$this->words["import_category_name"]; $aData[I7777] =I7847; $aData[I7794] =I7738; $aData["id_shipping_type"] =0; $catId =$this->TIIIlll($aData[I7777]); $parentCatId =$this->TIIIlll($aData[I7794]); $this->lostCatId =$catId; if($this->lostCatId == 0) {$I11L1LI =mb_strpos($this->oEshop->dbTablePrefix, 'ids_') === 0; $prefix =$I11L1LI ?mb_substr($this->oEshop->dbTablePrefix, 4) :$this->oEshop->dbTablePrefix; $sql ="select id from " .$prefix ."_shipping_types where " .($this->II1lLLI ?I7848.$this->langData."' AND " :I7730) ."hidden =1"; $this->db->query($sql); $this->db->next_record(); $aData["id_shipping_type"] =$this->db->Record[I7774]; $aSql =Array("id_parent" => $parentCatId, I7849 => 0, I7813 => $aData[I7813], I7777 => $this->TTII11I($aData[I7777]), I7795 => $this->langData, "id_shipping_type" => $aData["id_shipping_type"], "all_parents"=>I7767.$this->oEshop->tree->TI11lIl($parentCatId, true).I7767); $sql =$this->db->GenInsertSQL($prefix.I7797, $aSql); if($this->db->query($sql)) {$this->lostCatId =$this->db->lastInsertId(); if ($this->II1lLLI) {if ($I11L1LI) {$aSQL =array ('id' => $this->lostCatId, I7796 => $aSql[I7796], I7850 => $parentCatId );$sql =$this->db->GenInsertSQL($this->oEshop->dbTablePrefix.I7797, $aSQL); $this->db->execute($sql); }}else {$sql ="UPDATE " .$prefix ."_cats SET position=id WHERE id='".$this->lostCatId.I7761; $this->db->query($sql); }}$this->TTII1lT($this->II1llIL, "init", "create_lost_category", I7738, true); }}return $this->lostCatId; }function TIII1TI($fieldName, &$fieldValue, $aMap, &$IIll1lL, $params) {$return =false; if (isset($params[I7779]) && isset($this->I11l1IL[$params[I7779]])) {$this->I11LIlI[$aMap[$fieldName][I7851][0]] =(int)$this->I11l1IL[$params[I7779]]['id']; }else if (isset($this->I11LIlI[$aMap[$fieldName][I7851][0]])) {$prefix =mb_strpos($this->oEshop->dbTablePrefix, 'ids_') !== 0 ?$this->oEshop->dbTablePrefix :mb_substr($this->oEshop->dbTablePrefix, 4); $I11L1Ll =$prefix ."_reference_" .sprintf('%04d', $this->I11LIlI[$aMap[$fieldName][I7851][0]]); if (!array_key_exists($fieldName, $this->I11LII1)) {$sql ="SELECT COUNT(1) FROM " .$I11L1Ll ." WHERE `lang` = '" .$this->langData .I7761; if ($this->db->getValue($sql) <= MULTIPLE_SELECTION_REFERENCE_RECORD_LIMIT) {$this->I11LII1[$fieldName] =array ();$sql ="SELECT `id`, `id_external` FROM " .$I11L1Ll ." WHERE `lang` = '" .$this->langData .I7761; $rs =&$this->db->select($sql); while (list ($id, $value) =$rs->nextRecord(MYSQL_NUM)) {$this->I11LII1[$fieldName][$id] =$value; }}else {$this->I11LII1[$fieldName] =null; }}$ids =array ();$fieldValue =explode($aMap[$fieldName]['splitter'], $fieldValue); if (!is_null($this->I11LII1[$fieldName])) {foreach ($fieldValue as $value) {if (in_array($value, $this->I11LII1[$fieldName])) {$ids[] =array_search($value, $this->I11LII1[$fieldName]); }}}else {for ($i =0, $q =sizeof($fieldValue) ;$i <$q ;$i++) {$fieldValue[$i] =addslashes($fieldValue[$i]); }$sql =I7852 .$I11L1Ll ." WHERE `lang` = '" .$this->langData ."' AND value_1 IN (" .implode(',', array_map(array(AMI::getSingleton('db'), I7853), $fieldValue)) .")"; $rs =&$this->db->select($sql); while (list ($id) =$rs->nextRecord(MYSQL_NUM)) {$ids[] =$id; }}$ids =implode(I7766, array_unique($ids)); $fieldValue =I7766 .($ids != I7730 ?$ids .I7766 :I7730); }}function TIII1Tl(){ static $I11L1LL; if (!is_array($I11L1LL)) {$I11L1LL =array(); $sql ="DESCRIBE `".$this->oEshop->dbTablePrefix."_items`"; $rs =&$this->db->select($sql); while ($record =$rs->nextRecord()) {$I11L1LL[] =$record['Field']; }sort($I11L1LL); }return $I11L1LL; }function TTIlTIT($wizardDrivers, &$vData) {parent::TTIlTIT($wizardDrivers, $vData); if (sizeof($wizardDrivers) == 0) {return; }$step =isset($this->cms->Vars[I7854]) ?intval($this->cms->Vars[I7854]) :0; if ($step >3) {$step =0; }$vData['wizardStep'] =$step; $vData['data_meta_csv'] ='[]'; $vData['data_first_line'] =I7855; if ($step >0) {$vData['driver_selection_disabled'] =' disabled'; if($step == 1 && $this->IIlIIIL["data_source_type_v2"] == 'file') {$this->IIlIIIL[I7856] =I7730; if(!empty($_FILES["data_source_file_v2"][I7813])) {$extension =mb_strtolower(mb_substr(strrchr($_FILES["data_source_file_v2"][I7813], I7845), 1)); if($extension == 'csv') {$II1lL1L =$_FILES["data_source_file_v2"][I7857]; $tmp =str_replace("\\", I7788, $II1lL1L); $pos =mb_strrpos($tmp, I7788); if($pos === false) {$fileName =$II1lL1L; }else {$fileName =mb_substr($tmp, $pos +1); }$fileName =$this->cms->TTITI11(stripslashes($_FILES["data_source_file_v2"][I7813])); $newfilename =$this->importPath.$fileName; if($this->cms->doUploadFile($_FILES["data_source_file_v2"], $newfilename)) {$this->IIlIIIL[I7856] =$fileName; $this->cms->AddStatusMsg("status_file_ftp_add"); }else {$this->cms->AddStatusMsg($errMsg, I7858); }}else {$this->cms->AddStatusMsg("status_file_type_fail", I7858); }}else {$this->cms->AddStatusMsg("status_file_uploaded_fail", I7858); }}if ($this->IIlIIIL[I7856] != I7730) {$II1lL1L =$this->importPath .$this->IIlIIIL[I7856]; if (is_readable($II1lL1L)) {$I11L1L1 =fopen($II1lL1L, 'r'); for($IIIlLIl =0, $line; $IIIlLIl <2 && ($line =fgetcsv($I11L1L1, 60000, $this->IIlIIIL['delim'])); $IIIlLIl++) {foreach($line as $key => $value) {$value =mb_convert_encoding($value, I7859, 'CP1251'); if(mb_strlen($value) >100) {$value =mb_substr($value, 0, 100) .'...'; }$line[$key] =htmlentities($value, 0, I7859); }if(strpos($line[0], 'META.CSV::') === 0) {$line[0] =mb_substr($line[0], mb_strlen('META.CSV::')); $vData[I7860] =json_encode($line); }else {if($vData['data_first_line'] == I7855) {$vData['data_first_line'] =json_encode($line); }}}fclose($I11L1L1); $this->I11LIll['file'] =$II1lL1L; $vData['data_source_ftp_checked'] =I7861; $vData[I7856] =$this->IIlIIIL[I7856]; }else {$this->cms->AddStatusMsg('status_file_not_found', 'red'); }}if (!sizeof($this->I11LIll['imagesEnabled'])) {$this->cms->AddStatusMsg('warn_wizard_no_images_extension', I7862); }if (!sizeof($this->I11LIll['customFieldsEnabled'])) {$this->cms->AddStatusMsg('warn_wizard_no_custom_fields_extension', I7862); }}$I11L11I =array ();$html =I7730; $I11L11l =$this->II1lIlL; $I11L11L =array ();$I11L111 =array ('cats' => array ('public', I7863, 'special_flag', I7850, I7815, 'ext_picture', 'ext_popup_picture', 'ext_small_picture', I7864, I7823, I7818, 'id_discount', 'id_shipping_type', 'tax_class_type', 'id_tax_class' ),I7865 => array ('public', 'on_special', 'id_category', 'date', I7815, I7818, I7866, 'ext_picture', 'ext_popup_picture', 'ext_small_picture', I7864, 'special_announce', I7823, I7867, 'shipping_type', 'discount', 'discount_type', 'tax_class_type', I7868, 'tax', 'tax_type', 'charge_tax_type', 'id_shipping_type', I7869, 'weight', 'size', 'rest' ));$ILL11L1 =array ('cats' => array (),I7865 => array ());foreach (array_keys($ILL11L1) as $groupName) {$sql =I7870 .$this->oEshop->dbTablePrefix .'_' .$groupName; $rs =&$this->db->select($sql); while ($record =$rs->nextRecord()) {$field =$record['Field']; $name ='field_' .$groupName .'_' .$field; if (!isset($this->I11LIll[I7871][$name])) {if (false && preg_match('/^price(\d+)$/', $field, $matches)) {$this->I11LIll[I7871][$name] =$this->I11LIll[I7871]['field_' .$groupName .'_other_price'] .' ' .$matches[1]; }else {continue; }}$ILL11L1[$groupName][] =$field; }}foreach ($I11L111 as $table => $aFields) {$aTmp =array ();foreach ($aFields as $field) {if (in_array($field, $ILL11L1[$table])) {$aTmp[] =$field; }}$ILL11L1[$table] =array_merge($aTmp, array_diff($ILL11L1[$table], $aTmp)); }foreach ($wizardDrivers as $driverName) {$this->II1lIlL =$driverName; if (mb_substr($this->II1lIlL, 0, 5) == I7872) {$this->II1lIlL =mb_substr($this->II1lIlL, 5); }if (in_array($this->II1lIlL, $I11L11L)) {continue; }$I11L11L[] =$this->II1lIlL; switch ($step) {case 0: break; case 1: $I111III =$this->TTII111('wizard_db_cols'); foreach ($ILL11L1 as $groupName => $aFields) {$fields =I7730; foreach ($aFields as $field) {if (isset($this->I11LIll[I7871]['field_' .$groupName .'_' .$field])) {$aData =array ('group' => $groupName, I7873 => $field, I7861 => isset($I111III[$groupName][$field]) ?' checked' :I7730, 'caption' => $this->I11LIll[I7871]['field_' .$groupName .'_' .$field] );$fields .= $this->cms->Gui->get($this->moduleName .'_subform:wizard_option_value_step1', $aData); }}$aData =array ('group' => $groupName, I7851 => $fields, 'caption' => $this->I11LIll[I7871]['group_' .$groupName] );$html .= $this->cms->Gui->get($this->moduleName .'_subform:wizard_option_group_step1', $aData); }break; case 2: $I111IIl =array_merge_recursive($this->I11LIll[I7874], $this->TTII111('wizard_custom_rules')); foreach (array ('imagesEnabled' => 'IMAGE') as $var => $group) {if (!sizeof($this->I11LIll[$var])) {unset($I111IIl[$group]); }}$I11L11I['wizardMaxFileColumn'] =-1; if (isset($this->I11LIll[I7875])) {$file =$this->I11LIll[I7875]; if (is_file($file) && is_readable($file) && ($fp =@fopen($file, 'r'))) {$aMeta =fgetcsv($fp, 60000, $this->IIlIIIL['delim']); TlT1lT1($aMeta); fclose($fp); if (is_array($aMeta)) {$this->I11LIll['meta'] =array ();$I11L11I['wizardMaxFileColumn'] =sizeof($aMeta) -1; foreach ($aMeta as $column => $fields) {if ($column == 0) {if (mb_strpos($fields, I7876) !== 0) {unset($this->I11LIll['meta']); break; }$fields =mb_substr($fields, mb_strlen(I7876)); }$fields =explode('|', $fields); foreach ($fields as $field) {if ($field != I7730) {$this->I11LIll['meta'][$field] =$column; }}}if (sizeof($this->I11LIll['meta'])) {$this->cms->AddStatusMsg('status_meta_data_is_used', 'blue'); }}}}$II11IlL =$this->TTII111('fields_map'); $I111IIL =array ();$I111II1 =array ();$I111IlI =array ();$I111Ill =array ();$I111IlL =array ();$I11L11I['wizardDefaultRuleTypes'] =I7730; $I11L11I['meta_alert'] =false; foreach ($I111IIl as $groupName => $IllLlLI) {$fields =I7730; if ($groupName != I7877) {$optionSource =isset($II11IlL[$groupName]) ?$II11IlL[$groupName] :array(); $fields .= $this->TIII1T1($II11IlL, $optionSource, $groupName, $IllLlLI, $I11L11I, $I111IIL, $I111II1, $I111IlL); }else {if (empty($II11IlL[$groupName][1])) {$II11IlL[$groupName][1] =array ();ksort($II11IlL[$groupName]); }foreach ($II11IlL[$groupName] as $priceNumber => $optionSource) {$I111Ill[] =$priceNumber; $fields .= $this->TIII1T1($II11IlL, $optionSource, $groupName, $IllLlLI, $I11L11I, $I111IIL, $I111II1, $I111IlL, $priceNumber); }}$aData =array ('group' => $groupName, 'caption' => $this->I11LIll[I7871]['group_' .$groupName], I7851 => $fields); $html .= $this->cms->Gui->get($this->moduleName .'_subform:wizard_option_group_step2', $aData); $I111IlI[$groupName] =$aData[I7878]; $html .= $this->cms->Gui->getAbs($this->moduleName .'_subform:wizard_option_group_splitter_step2', array ());}$I11L11I['wizardDisabledNames'] =sizeof($I111IIL) ?I7761 .implode("', '", array_keys($I111IIL)) .I7761 :I7730; $I11L11I['wizardDisabledNamesValues'] =I7730; $I11L11I[I7879] =I7761 .implode("', '", array_keys($I111IlI)) .I7761; $I11L11I['wizardGroupsCaptions'] =I7761 .implode("', '", $I111IlI) .I7761; $I11L11I['wizardExtraPrices'] =implode(I7880, $I111Ill); $I11L11I['wizardSpecialFlags'] =implode(I7880, $I111IlL); $I11L11I['wzNewRuleGroup'] =I7730; $I11L11I['max_extra_price'] =MAX_EXTRA_PRICE; foreach ($I111IlI as $value => $caption) {if ($value != 'IMAGE' && $value != I7881) {$I11L11I['wzNewRuleGroup'] .= $this->cms->Gui->getAbs($this->moduleName .'_subform:wizard_option_row', array ('value' => $value, I7878 => $caption)); }}foreach ($I111IIL as $values) {$I11L11I['wizardDisabledNamesValues'] .= $this->cms->Gui->getAbs($this->moduleName .'_subform:wizard_disabled_names_values_step2', array ('values' => implode("', '", $values))); }$I11L11I['wizardUsedRules'] =sizeof($I111II1) ?I7761 .implode("', '", $I111II1) .I7761 :I7730; $len =mb_strlen($GLOBALS[I7882]); $I11L11I[I7883] =mb_substr($GLOBALS['CUSTOM_PICTURES_PATH'], $len) .$this->I11lLl1 .'/'; $I11L11I['wizard_image_source_upload'] =mb_substr($this->importPath, $len); if ($I11L11I['meta_alert']) {$this->cms->AddStatusMsg('status_wizard_meta_warning', I7862); $I11L11I['meta_alert'] =$this->cms->Gui->getAbs($this->moduleName .'_subform:wizard_meta_alert_step2', array ());}break; case 3: $I111IIl =array_merge_recursive($this->I11LIll[I7874], $this->TTII111('wizard_custom_rules')); $II11IlL =$this->TTII111('fields_map'); $aRows =array ();$I111Il1 =array ();$I111ILI =isset($II11IlL[I7884]['PRICE']) || isset($II11IlL['CATEGORY'][I7877]); unset($II11IlL[I7884]['PRICE'], $II11IlL['CATEGORY'][I7877]); foreach ($I111IIl as $groupName => $IllLlLI) {foreach ($IllLlLI as $FIELD => $aRule) {$I111ILl =$I111ILI && ($groupName == I7877); if (isset($II11IlL[$groupName][$FIELD]) || $I111ILl) {if ($I111ILl) {if(!empty($II11IlL[$groupName])){ foreach ($II11IlL[$groupName] as $priceNumber => $optionSource) {$this->TIII1IT( $optionSource[$FIELD], $I111IIl, $groupName, $FIELD, $aRows, $I111Il1, $priceNumber );}}}else {$optionSource =$II11IlL[$groupName][$FIELD]; $this->TIII1IT($optionSource, $I111IIl, $groupName, $FIELD, $aRows, $I111Il1); }}}}require_once $GLOBALS[I7885] .'func_array.php'; sortMultiArray($aRows, 'column', SORT_NUMERIC); $I11L11I['wzMaxCol'] =sizeof($aRows) ?($aRows[sizeof($aRows) -1]['column']) :-1; $aRows =array_merge($aRows, $I111Il1); $id =0; $I111ILL =$this->TTII111(I7886); $I111IL1 =$this->TTII111('wizard_correspondence'); $I111I1I =array ();$I111I1l =array ();$I111I1L =array ();$rowsCount =sizeof($aRows) -1; $I111I11 =-1; $line =0; foreach ($aRows as $index => $row) {$row['size'] =0; $row['id'] =++$id; $row['group_caption'] =$this->I11LIll[I7871][I7887 .$row['group']]; if (empty($row['field_caption'])) {$row['field_caption'] =isset($this->I11LIll[I7871]['field_' .$row[I7888] .'_' .$row[I7873]]) ?$this->I11LIll[I7871]['field_' .$row[I7888] .'_' .$row[I7873]] :$I111IIl[$row[I7888]][$row[I7873]][I7878]; }if (isset($row['column'])) {$I111I1L[$row[I7889]][$row[I7888]][] =$row[I7873]; $row['same_column_next'] =$index <$rowsCount ?$row[I7889] == (isset($aRows[$index +1][I7889]) ?$aRows[$index +1][I7889] :null) :false; $row['same_column_prev'] =$row[I7889] == $I111I11; $row['same_column_both'] =$row['same_column_next'] && $row[I7890]; if ($row['same_column_next'] && !$row[I7890]) {$i =$index; while ($i <$rowsCount) {if ($row[I7889] == $aRows[$i +1][I7889]) {$i++; }else {break; }}$row['same_column_count'] =$i -$index +1; $I111I1l[$id] =range($id, $id +$row['same_column_count'] -1); }if (!$row[I7890]) {$line++; $I111I1I[] =$id; }}else {$line++; $row['same_column_next'] =false; $row[I7890] =false; $row[I7891] =$row[I7873] == I7877; }$row['class'] ='row' .($line %2 ?1 :2); $I111I11 =isset($row[I7889]) ?$row[I7889] :null; $row['options'] =I7730; foreach ($I111ILL as $table => $aFields) {$aFields =array_keys($aFields); foreach ($aFields as $field) {if (in_array($field, $ILL11L1[$table])) {$value =$table .'_' .$field; $aOption =array (I7892 => $value, I7878 => strip_tags($this->I11LIll[I7871][I7887 .$table] .' : ' .$this->I11LIll[I7871]['field_' .$table .'_' .$field]), 'selected' => empty($I111IL1[$row[I7888]][$row[I7873]]) || !in_array($value, $I111IL1[$row[I7888]][$row[I7873]]) ?I7730 :I7893 );$row['options'] .= $this->cms->Gui->get($this->moduleName .'_subform:wizard_option_row', $aOption); $row['size']++; }}}$row['correspondence_col'] =$this->cms->Gui->get($this->moduleName .I7894 .(!empty($row['correspondence']) ?'wizard_correspondence_col_step3' :'wizard_hidden_correspondence_col_step3'), $row); if (!empty($row['ask_splitter'])) {$row[I7895] ='|'; if (isset($this->I11LIll['groupsToOptions'][$row[I7888]]) && $this->module->issetOption($this->I11LIll['groupsToOptions'][$row[I7888]]) ){$aOption =$this->module->GetOption($this->I11LIll['groupsToOptions'][$row[I7888]]); if (isset($aOption[$row[I7873]]) && isset($aOption[$row[I7873]][I7895])) {$row[I7895] =$aOption[$row[I7873]][I7895]; }}$row[I7896] .= $this->cms->Gui->get($this->moduleName .'_subform:wizard_splitter_correspondence_col_step3', $row); }$html .= $this->cms->Gui->get($this->moduleName .'_subform:wizard_option_row_step3', $row); }$I11L11I['trRealRowsIds'] =implode(I7880, $I111I1I); $aTmp =array ();foreach ($I111I1l as $id => $ids) {$aTmp[] =$id .':[' .implode(I7880, $ids) .I7897; }$I11L11I['trRowsGroups'] =implode(I7880, $aTmp); unset($aTmp); $this->cms->Core->WriteOption($this->moduleName, 'column_order', I7730, implode(',', array_keys($I111I1L))); $this->cms->Core->WriteOption($this->moduleName, 'column_rules', I7730, serialize($I111I1L)); break; }}$vData[I7898] =$this->cms->Gui->getAbs($this->moduleName .'_subform:wizard_option_step' .$step, array ('html' => $html) +$I11L11I); $this->II1lIlL =$I11L11l; }function TIII1T1($II11IlL, $optionSource, $groupName, $IllLlLI, &$I11L11I, &$I111IIL, &$I111II1, &$I111IlL, $priceNumber =0) {$fields =$priceNumber == 0 ?I7730 :$this->cms->Gui->getAbs($this->moduleName .'_subform:wizard_option_value_price_header_step2', array ('price_number' => $priceNumber)); $I111lII =0; $I111lIl =sizeof($IllLlLI); foreach ($IllLlLI as $field => $aRule) {$I111lII++; $optionValue =isset($optionSource[$field]) ?$optionSource[$field] :null; if (isset($aRule[I7878])) {$caption =$aRule[I7878]; }else if ($groupName == I7877 && is_numeric($field)) {$caption =$this->I11LIll[I7871][I7899 .$groupName] .' ' .$field; }else {$caption =$this->I11LIll[I7871][I7899 .$groupName .'_' .$field]; }$fieldName =($priceNumber == 0 ?I7730 :'[' .$priceNumber .I7897) .'[' .$field .I7897; if ($groupName == I7881 && isset($optionValue[I7900])) {$optionValue[I7892] =$optionValue[I7900]; }$aData =array ('price_type_last' => $priceNumber == 0 || $I111lII <$I111lIl ?I7730 :' last="1"', 'price_num_attr' => $priceNumber == 0 ?I7730 :' price_num="' .$priceNumber .I7901, 'price_num' => $priceNumber, I7888 => $groupName, I7873 => $fieldName, 'title' => $field, I7861 => isset($optionValue) ?' checked' :I7730, I7878 => $caption, I7783 => I7730, I7892 => isset($optionValue[I7892]) ?$optionValue[I7892] :I7730, 'disabled_value' => I7730, I7902 => isset($aRule[I7878]), 'meta_alert' => I7730 );if (isset($aRule['types'])) {$I111lIL =$I11L11I['wizardDefaultRuleTypes'] == I7730 && sizeof($aRule['types']) == 2; $size =sizeof($aRule[I7903]); $I111lI1 =$size >0; if ($I111lI1 && $size <2) {list ($key, )=each ($aRule[I7903]); $I111lI1 =$key == I7889; }if ($I111lI1) {$I111llI =false; foreach ($aRule[I7903] as $type => $I111lll) {if (!$I111lll) {$I111IIL['wizard_type_' .$groupName .$fieldName][] =$type; }$selected =$type == $optionValue[I7783]; if ($selected && !$I111lll) {$aData['disabled_value'] =' disabled'; }if (isset($this->I11LIll['meta']) && ($selected || empty($optionValue[I7783]))) {$I111llL =$groupName .I7904 .($priceNumber == 0 ?I7730 :$priceNumber .I7904) .$field; $index =isset($this->I11LIll['meta'][$I111llL]) ?$this->I11LIll['meta'][$I111llL] :false; if($type == I7889){ if(isset($optionValue)){ $I111llI =($index === false || $aData[I7892] != $index || $aData[I7892] >$I11L11I['wizardMaxFileColumn']); }else{ $I111llI =($index !== false); }}else{ $I111llI =(($index !== false) && (($type != I7889) || ($aData[I7892] != $index))); }if ($I111llI && $groupName == I7877) {if (!isset($II11IlL[I7884]['PRICE']) && !isset($II11IlL[I7905][I7877])) {$I111llI =false; }}$aData['meta_alert_attributes'] =I7730; if ($I111llI) {$aData['meta_alert_attributes'] =$this->cms->Gui->getAbs($this->moduleName .I7894 .($index === false ?'wizard_meta_alert_attributes_excess_step2' :'wizard_meta_alert_attributes_step2'), array ());if ($index !== false) {$type =I7889; $aData[I7861] =I7906; $aData[I7892] =$index; }else {$aData[I7861] =I7730; }}$I11L11I['meta_alert'] =$I11L11I['meta_alert'] || $I111llI; }$aData[I7783] .= $this->cms->Gui->getAbs($this->moduleName .'_subform:wizard_option_row', array (I7892 => $type, I7878 => $this->I11LIll[I7871]['wizard_mapping_type_' .$type], I7907 => $selected ?I7893 :I7730 ));if ($I111llI) {break; }}if ($I111lIL && !$I111llI) {$I11L11I['wizardDefaultRuleTypes'] =str_replace(I7893, I7730, str_replace(array ("\n", "\r", '\n\n'), I7908, $aData[I7783])); }}}if (isset($aRule['class']) && $aRule['class'] == 'special_flag') {$I111IlL[] =$aRule['class_parameters'][I7909]; }if (isset($this->I11LIll['customFieldsReferenceData'][$field]) && $this->I11LIll['customFieldsReferenceData'][$field][I7783] != 'scalar') {$I11LLlL ='REFERENCE_NAME_' .sprintf(I7910, $this->I11LIll['customFieldsReferenceData'][$field]['table_num']); $aOption =$this->module->GetOption('references_fields_map'); $aOption =empty($aOption[$I11LLlL]) ?array ('operation' => I7911) :$aOption[$I11LLlL]; $aData['extra_options'] =$this->cms->Gui->getAbs($this->moduleName .'_subform:wizard_option_row', array (I7892 => I7911, I7907 => $aOption['operation'] === I7911 ?I7893 :I7730, I7878 => $this->I11LIll[I7871]['wizard_reference_operation_copy'])) .$this->cms->Gui->getAbs($this->moduleName .'_subform:wizard_option_row', array (I7892 => 'reference', I7907 => $aOption['operation'] === 'reference' ?I7893 :I7730, I7878 => $this->I11LIll[I7871]['wizard_reference_operation_reference'])); $aData[I7912] =$this->cms->Gui->getAbs($this->moduleName .'_subform:wizard_reference_extra_parameters_step2', $aData +array ('ref_field' => $I11LLlL)); }else if ($groupName == 'IMAGE') {$aOption =$this->module->GetOption('item_fields_map'); $aOption =isset($aOption[$field]) ?$aOption[$field] :array (I7913 => I7911); $aData['extra_options'] =$this->cms->Gui->getAbs($this->moduleName .'_subform:wizard_option_row', array (I7892 => I7911, I7907 => $aOption[I7913] === I7911 ?I7893 :I7730, I7878 => $this->I11LIll[I7871][I7883])) .$this->cms->Gui->getAbs($this->moduleName .'_subform:wizard_option_row', array (I7892 => 'image', I7907 => $aOption[I7913] === I7914 ?I7893 :I7730, I7878 => $this->I11LIll[I7871]['wizard_image_source_upload'])); $aData[I7912] =$this->cms->Gui->get($this->moduleName .'_subform:wizard_image_extra_parameters_step2', $aData); }$fields .= $this->cms->Gui->get($this->moduleName .'_subform:wizard_option_value_step2', $aData); $I111II1[] ='wizard_' .$groupName .I7915 .$field .I7897; }return $fields; }function TIII1IT($optionSource, $I111IIl, $groupName, $FIELD, &$aRows, &$I111Il1, $priceNumber =0) {if (isset($this->I11LIll[I7874][$groupName][$FIELD]) && sizeof($this->I11LIll[I7874][$groupName][$FIELD][I7903]) <2) {list ($key, )=each($this->I11LIll[I7874][$groupName][$FIELD][I7903]); if ($key === 'add_price_type') {return; }}if ($optionSource[I7783] == I7889) {$field =mb_strtolower($FIELD); $aRows[] =($priceNumber == 0 ?array ():array ('field_caption' => $this->I11LIll[I7871][I7899 .$groupName .I7904 .$FIELD] .' ' .$priceNumber)) +array (I7889 => $optionSource[I7892], I7888 => $groupName, I7873 => ($priceNumber == 0 ?I7730 :$priceNumber) .$FIELD, 'correspondence' => $priceNumber == 0 && empty($I111IIl[$groupName][$FIELD][I7916]) && mb_strpos($FIELD, 'CUSTOM_FIELD_') !== 0, 'field_value' => $priceNumber == 0 ?($groupName == I7884 ?'items_' :'cats_') .mb_strtolower($FIELD) :I7917 .$FIELD .I7897, 'ask_splitter' => (isset($this->I11LIll[I7740][$field]) && $this->I11LIll[I7740][$field]['ftype'] == 'related_items') || (isset($this->I11LIll['customFieldsReferenceData'][$FIELD]) && $this->I11LIll['customFieldsReferenceData'][$FIELD][I7783] == 'ref_set') );}else if ($priceNumber == 0) {$I111Il1[] =array (I7888 => $groupName, I7873 => $FIELD, 'correspondence' => true); }}function TTIIl1I() {if (empty($this->IIlIIIL['import_driver'])) {return; }$this->itemData['import_driver'] =$this->IIlIIIL[I7918]; $step =intval($this->IIlIIIL[I7854]); $this->TIII1II(); switch ($step) {case 1: $I111ll1 =mb_strtolower(preg_replace('/^Rapid/', I7730, $this->IIlIIIL[I7918])) .I7904; $II1L1LL =$I111ll1 .'wizard_first_backup'; $this->cms->Core->ReadOption($aOption, $this->moduleName, $II1L1LL); if (!is_array($aOption)) {$aOptions =array ();foreach (array ($I111ll1 .'fields_map', $I111ll1 .'fields_map_ini', 'references_tables_map', 'currencies_fields_map', 'references_fields_map', 'cat_fields_map', 'digitals_fields_map', I7919 )as $optionName) {$aOptions[$optionName] =$this->module->GetOption($optionName); }$this->cms->Core->WriteOption($this->moduleName, $II1L1LL, I7730, serialize($aOptions)); }break; case 2: if ($this->TIII1Il(I7886)) {$ILL11L1 =array ('cats' => array (),I7865 => array ());foreach (array_keys($ILL11L1) as $groupName) {$I111lLI ='wizard_' .$groupName; if (isset($this->IIlIIIL[$I111lLI]) && is_array ($this->IIlIIIL[$I111lLI])) {foreach (array_keys($this->IIlIIIL[$I111lLI]) as $field) {$ILL11L1[$groupName][$field] =1; }}}$this->TIII1I1(I7886, $ILL11L1); }break; case 3: if ($this->TIII1Il('fields_map') && $this->TIII1Il('wizard_custom_rules')) {$IllLlLI =array ();$I111lLl =array ();$I111lLL =explode(I7920, $this->IIlIIIL['wzSpecialFlags']); foreach (array_keys($this->I11LIll[I7874]) as $groupName) {if (isset($this->IIlIIIL['wizard_type_' .$groupName]) && is_array($this->IIlIIIL['wizard_type_' .$groupName])) {foreach ($this->IIlIIIL['wizard_type_' .$groupName] as $field => $type) {$IllLlLI[$groupName][$field] =array (I7783 => $type, I7892 => $this->IIlIIIL[I7921 .$groupName][$field] );if (isset($this->I11LIll[I7874][$groupName][$field]['class'])) {$IllLlLI[$groupName][$field]['class'] =$this->I11LIll[I7874][$groupName][$field]['class']; if(isset($this->I11LIll[I7874][$groupName][$field]['class_parameters'])){ $IllLlLI[$groupName][$field][I7922] =$this->I11LIll[I7874][$groupName][$field][I7922]; }}if (!isset($this->I11LIll[I7874][$groupName][$field]) && $groupName != I7877) {$I111lLl[$groupName][$field] =array (I7903 => array (I7889 => true, I7892 => true), I7878 => $this->IIlIIIL['wizard_' .$groupName][$field] );if (preg_match('/^ONSPECIAL(\d+)$/', $field, $matches) && in_array($matches[1], $I111lLL)) {$I111lLl[$groupName][$field]['class'] ='special_flag'; $I111lLl[$groupName][$field][I7922] =array (I7909 => $matches[1]); }}}}}if (isset($IllLlLI[I7877])) {$I111lL1 =array ();foreach ($IllLlLI[I7877] as $priceNum => $I111l1I) {$I111lL1[$priceNum] =array ();foreach ($I111l1I as $paramName => $aValues) {if (is_array($aValues)) {foreach ($aValues as $key => $value) {$I111lL1[$priceNum][$key][$paramName] =$value; }}}}$IllLlLI[I7877] =$I111lL1; }$this->TIII1I1(I7923, $IllLlLI); $this->TIII1I1('wizard_custom_rules', $I111lLl); if (isset($this->IIlIIIL['wizard_extra']) && is_array($this->IIlIIIL['wizard_extra'])) {$I111l1l =array ('IMAGE' => I7919, I7905 => 'references_fields_map', I7884 => 'references_fields_map' );$aOptions =array ();$I111l1L =false; foreach ($this->IIlIIIL['wizard_extra'] as $groupName => $aMapping) {if (isset($I111l1l[$groupName])) {$optionName =$I111l1l[$groupName]; if (empty($aOptions[$optionName])) {$aOptions[$optionName] =$this->module->GetOption($optionName); }foreach ($aMapping as $FIELD => $value) {if ($groupName == 'IMAGE') {if (isset($aOptions[$optionName][$FIELD])) {$aOptions[$optionName][$FIELD][I7913] =$value; }}else {if (empty($aOptions[$optionName][$FIELD])) {$aOptions[$optionName][$FIELD] =array (I7851 => I7815); }$aOptions[$optionName][$FIELD][I7913] =$value; $I111l1L =true; }}}}if ($I111l1L) {foreach ($aOptions as $optionName => $I111l11) {$this->module->SetOption($optionName, $I111l11); }$this->cms->Core->SaveOptions($this->moduleName); }}}break; case 4: if ($this->TIII1Il(I7923) && !empty($this->IIlIIIL)) {$this->II1lIlL =mb_strtolower(preg_replace('/^Rapid/', I7730, $this->IIlIIIL[I7918])); $II11IlL =$this->TTII111(I7923); $this->TIII1I1('wizard_correspondence', $this->IIlIIIL['wizard']); $this->cms->Core->ReadOption($I111LII, $this->moduleName, 'column_order'); $this->cms->Core->ReadOption($I111I1L, $this->moduleName, 'column_rules'); $I111I1L =unserialize($I111I1L['big_value']); $I111LIl =$I111I1L; if ($I111LII[I7924] != $this->IIlIIIL['wzColumns']) {$I111LII =explode(I7920, $I111LII[I7924]); $I111LIL =explode(I7920, $this->IIlIIIL['wzColumns']); $I111LI1 =array_diff_assoc($I111LIL, $I111LII); foreach ($I111LI1 as $I111LlI) {$I111Lll =$I111LII[array_search($I111LlI, $I111LIL)]; $I111LIl[$I111LlI] =$I111LIl[$I111Lll]; unset($I111LIl[$I111Lll]); foreach ($I111I1L[$I111Lll] as $groupName => $aFields) {$I111LlL =$groupName != I7877; foreach ($aFields as $field) {if ($I111LlL) {$II11IlL[$groupName][$field][I7892] =$I111LlI; $I111Ll1 =true; }else if (preg_match('/^(\d+)([\W][\W_\d]*)$/', $field, $matches)) {$II11IlL[$groupName][$matches[1]][$matches[2]][I7892] =$I111LlI; $I111Ll1 =true; }}}}if ($I111Ll1) {$this->cms->Core->WriteOption($this->moduleName, 'column_order', I7730, $this->IIlIIIL[I7925]); }}$I111lLl =$this->TTII111('wizard_custom_rules'); $I111IL1 =$this->IIlIIIL['wizard']; $I111l1l =array (I7905 => 'cat_fields_map', I7884 => I7919 );$aOptions =array ();foreach ($this->I11LIll['groupsToOptions'] +array (I7881 => array ('references_tables_map', 'references_fields_map')) as $IIL11II => $I111LLI) {if (!is_array($I111LLI)) {$I111LLI =array ($I111LLI); }foreach ($I111LLI as $I111LLl) {$aOptions[$I111LLl] =$this->module->GetOption($I111LLl); }}foreach ($II11IlL as $groupName => $IllLlLI) {if (isset($I111l1l[$groupName])) {foreach ($IllLlLI as $IIL11II => $aRule) {if (isset($I111IL1[$groupName][$IIL11II])) {$aFields =$I111IL1[$groupName][$IIL11II]; $I111LLL =array ();if (isset($I111lLl[$groupName][$IIL11II]['class'])) {$I111LL1 =$I111lLl[$groupName][$IIL11II]; $aRule += array ('class' => $I111LL1['class']); if (isset($I111LL1[I7922])) {$aRule += array (I7922 => $I111LL1[I7922]); }}foreach ($aFields as $field) {$I111L1I =mb_substr($field, 0, 5) != I7926; $I111LLl =$I111L1I ?I7919 :'cat_fields_map'; $field =preg_replace('/^[^_]+_/', I7730, $field); if (isset($aRule['class'])) {$I111LLL[$aRule['class']][$I111LLl][] =$field; }else if (isset($this->I11LIll[I7740][$field]) && $this->I11LIll[I7740][$field][I7927] == 'related_items') {if ($I111L1I) {$I111LLL['related_items'][$I111LLl][] =$field; }}else if (empty($aOptions[$I111LLl][$IIL11II]) || (isset($aOptions[$I111LLl][$IIL11II][I7913]) && ($aOptions[$I111LLl][$IIL11II][I7913] == I7911)) ){$I111LLL['common'][$I111LLl][] =$field; }}foreach ($I111LLL as $I111L1l => $I111L1L) {foreach ($I111L1L as $I111LLl => $aFields) {switch ($I111L1l) {case 'common': $aData =array (I7913 => I7911, I7851 => $aFields );break; case I7928: $aData =array (I7913 => 'id_related', I7851 => $aFields, I7895 => isset($this->IIlIIIL['wizard_splitter'][$groupName][$IIL11II]) ?$this->IIlIIIL['wizard_splitter'][$groupName][$IIL11II] :'|' );break; case I7929: $aData =array (I7913 => 'on_special', I7909 => '0', 'pre_operation' => array (I7913 => 'replace', I7930 => array ('true' => '1', 'false' => '0' )),I7851 => $aFields );break; case I7931: $aData =array (I7913 => I7931, I7851 => $aFields );break; }if (isset($aRule[I7922])) {$aData =array_merge($aData, $aRule[I7922]); }$aOptions[$I111LLl][$IIL11II] =$aData; }}if (isset($this->I11LIll['customFieldsReferenceData'][$IIL11II]) && $this->I11LIll['customFieldsReferenceData'][$IIL11II][I7783] != 'scalar') {$II11ILL =$this->I11LIll['customFieldsReferenceData'][$IIL11II][I7932]; $I111L11 ='CUSTOM_' .sprintf(I7910, $II11ILL); $I11LLlL ='REFERENCE_NAME_' .sprintf(I7910, $II11ILL); $type =$this->I11LIll['customFieldsReferenceData'][$IIL11II][I7783]; switch ($type) {case 'ref_value': case I7933: if(!isset($II11IlL[I7881][$I111L11])){ $II11IlL[I7881][$I111L11] =array (I7815 => $I11LLlL, I7900 => $II11IlL[$groupName][$IIL11II][I7892] );}else{ $II11IlL[I7881][$I111L11][I7900] .= I7920 .$II11IlL[$groupName][$IIL11II][I7892]; }$aOptions['references_tables_map']['REFERENCE_' .$I111L11] =array (I7783 => 'regular', 'id' => $II11ILL );if ($type == I7934) {$aOptions['references_fields_map'][$I11LLlL] =array (I7913 => isset($aOptions['references_fields_map'][$I11LLlL][I7913]) ?$aOptions['references_fields_map'][$I11LLlL][I7913] :I7911, I7851 => I7815 );}else {$field =mb_strtolower($IIL11II); $I1111II =$this->I11LIll['groupsToOptions'][$groupName]; $splitter =isset($this->IIlIIIL[I7935][$groupName][$IIL11II]) ?$this->IIlIIIL[I7935][$groupName][$IIL11II] :'|'; $aOptions['references_fields_map'][$I11LLlL] =array (I7913 => I7821, I7851 => array($field, I7815), I7895 => $splitter );$aOptions[$I1111II][$I11LLlL] =array (I7913 => I7911, I7851 => $field );$aOptions[$I1111II][$IIL11II] =array (I7913 => I7821, I7851 => $field, I7895 => $splitter );}break; break; }}}}}}foreach ($aOptions as $I111LLl => $I111LLI) {$this->module->SetOption($I111LLl, $I111LLI); }$this->TIII1I1(I7923, $II11IlL); $this->TIII1I1('fields_map_ini', TlT1TTl($II11IlL), true); $this->cms->Core->SaveOptions($this->moduleName); $this->cms->AddStatusMsg('wizard_is_finished'); $this->cms->VarsGet[I7856] =$this->cms->Vars[I7856]; $this->forceRedirect =true; }break; }}function TIII1II() {$this->I11LIll[I7936] =array (I7905 => 'cat_fields_map', I7884 => I7919 );$this->I11LIll[I7874] =array (I7905 => array ('ID_EXTERNAL' => array (I7903 => array (I7889 => true, I7892 => true), I7916 => true), 'ID_PARENT_EXTERNAL' => array (I7903 => array (I7889 => true, I7892 => true), I7916 => true), 'DESCRIPTION' => array (I7903 => array (I7889 => true, I7892 => true)), I7937 => array (I7903 => array (I7889 => true, I7892 => true)), 'FULL_DESCRIPTION' => array (I7903 => array (I7889 => true, I7892 => true)), 'IS_DELETED' => array (I7903 => array (I7889 => true, I7892 => true)), I7877 => array (I7903 => array ('add_price_type' => false)) ),I7884 => array ('ID_PARENT_EXTERNAL' => array (I7903 => array (I7889 => true, I7892 => true), I7916 => true), I7938 => array (I7903 => array (I7889 => true, I7892 => true)), 'ONSPECIAL0' => array (I7903 => array (I7889 => true, I7892 => true), 'class' => I7929, I7922 => array (I7909 => '0')), 'ID_EXTERNAL' => array (I7903 => array (I7889 => true, I7892 => true), I7916 => true), I7939 => array (I7903 => array (I7889 => true, I7892 => true)), I7937 => array (I7903 => array (I7889 => true, I7892 => true)), 'NAME_FULL' => array (I7903 => array (I7889 => true, I7892 => true)), 'MAIN_PRICE' => array (I7903 => array (I7889 => true, I7892 => true)), 'DISCOUNT' => array (I7903 => array (I7889 => true, I7892 => true)), 'TAX' => array (I7903 => array (I7889 => true, I7892 => true)), I7940 => array (I7903 => array (I7889 => true, I7892 => true)), 'WEIGHT' => array (I7903 => array (I7889 => true, I7892 => true)), 'REST' => array (I7903 => array (I7889 => true, I7892 => true)), 'CODE' => array (I7903 => array (I7889 => true, I7892 => true)), 'ITEM_LINKS' => array (I7903 => array (I7889 => true, I7892 => true), I7941 => I7931, I7916 => true), 'PRICE' => array (I7903 => array ('add_price_type' => false)), 'SUBLINK' => array(I7903 => array(I7889 => true, I7892 => true), I7916 => true), 'HTML_TITLE' => array (I7903 => array (I7889 => true, I7892 => true), I7916 => true), I7942 => array (I7903 => array (I7889 => true, I7892 => true), I7916 => true), 'HTML_DESCRIPTION' => array (I7903 => array (I7889 => true, I7892 => true), I7916 => true), I7824 => array (I7903 => array (I7889 => true, I7892 => true), I7916 => true), ),'IMAGE' => array ('IMAGE_MAIN' => array (I7903 => array (I7889 => true, I7892 => true)), 'IMAGE_POPUP' => array (I7903 => array (I7889 => true, I7892 => true)), I7943 => array (I7903 => array (I7889 => true, I7892 => true)) ),I7877 => array (I7939 => array(I7903 => array(I7889 => true, I7892 => true)), 'CURRENCY_CODE' => array(I7903 => array(I7889 => true, I7892 => true)), 'PRICE_TYPE_CURRENCY_CODE' => array(I7903 => array(I7889 => true, I7892 => true)), 'USE_FORMULA' => array(I7903 => array(I7889 => true, I7892 => true)), 'PRICE' => array(I7903 => array(I7889 => true, I7892 => true)), I7944 => array(I7903 => array(I7889 => true, I7892 => true)), 'WITH_TAX' => array(I7903 => array(I7889 => true, I7892 => true)) ));$this->I11LIll[I7871] =$this->cms->Gui->parseLangFile('templates/lang/' .$this->oEshop->ownerName .'_data_exchange_wizard.lng'); if (!sizeof($this->I11LIll['imagesEnabled'])) {unset( $this->I11LIll[I7871]['field_cats_ext_picture'], $this->I11LIll[I7871]['field_cats_ext_small_picture'], $this->I11LIll[I7871]['field_cats_ext_popup_picture'], $this->I11LIll[I7871]['field_items_ext_picture'], $this->I11LIll[I7871]['field_items_ext_small_picture'], $this->I11LIll[I7871]['field_items_ext_popup_picture'] );}if (sizeof($this->I11LIll['customFieldsEnabled'])) {$I1111Il =array ('item' => I7884, 'category' => I7905); $sql ="SELECT `name`, `fnum`, `ftype`, `value_type`, `ref_table_num`, `type_owner` " .I7945 .$this->oEshop->dbTablePrefix ."_custom_types " ."WHERE `ftype` NOT IN ('flagmap', 'related_cats') AND `value_type` IN ('scalar', 'ref_value', 'ref_set') AND `is_prop` = 0 AND `type_owner` IN ('" .implode("', '", $this->I11LIll['customFieldsEnabled']). I7946. "ORDER BY `fnum` ASC"; $rs =&$this->db->select($sql); while ($record =$rs->nextRecord()) {$caption =unserialize($record[I7815]); if (isset($caption[$this->langData])) {$field ='custom_field_' .$record['fnum']; $aData =array (I7878 => $caption[$this->langData], I7783 => $this->I11LIll[I7871]['custom_field_' .$record[I7927]], I7927 => $record[I7927] );$this->I11LIll[I7740][$field] =$aData; $FIELD =mb_strtoupper($field); $this->I11LIll['customFieldsReferenceData'][$FIELD] =array (I7783=> $record['value_type'], I7932 => $record['ref_table_num']); $target =$I1111Il[$record['type_owner']]; $this->I11LIll[I7874][$target][$FIELD] =array (I7903 => $record['value_type'] == I7947 ?array (I7889 => true, I7892 => true) :array (I7889 => true) );$this->I11LIll[I7871][I7899 .$target .I7904 .$FIELD] =$this->cms->Gui->get($this->moduleName .'_subform:wizard_option_value_custom_field_step12', $aData); }}}}function TIII1Il($optionName) {$optionName =mb_strtolower(preg_replace('/^Rapid/', I7730, $this->IIlIIIL[I7918])) .I7904 .$optionName; $res =$this->module->issetOption($optionName); return $res; }function TIII1I1($optionName, $value) {$optionName =mb_strtolower(preg_replace('/^Rapid/', I7730, $this->IIlIIIL[I7918])) .I7904 .$optionName; $this->module->SetOption($optionName, $value); $this->cms->Core->SaveOptions($this->moduleName); }function TTII111($optionName, $II1L1l1 =false){ $aOptions =parent::TTII111($optionName, $II1L1l1); if($this->II1lLLI && $optionName == I7919){ foreach($this->I11LIl1 as $field){ if(isset($aOptions[$field])){ $aOptions[$field][I7913] =I7822; }}}return $aOptions; }}