<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       38268 xkqwpluswulpluynllsikgtmuspgkrkwskxkunzmsizxlkilrkxixtysiirspytswwuqpnir
 */ ?><?php foreach(array(8069=>"fMJQD",8070=>"~",8071=>"fMJQ|MSD",8072=>"MS",8073=>"SQJ",8074=>"IHvQ",8075=>"funW|PuM`GOG",8076=>'IHvQ',8077=>"|zWtMHniHvQ",8078=>"SZtQtH",8079=>"nuI|fMJQD",8080=>"OttG%~~",8081=>"uDQ|JMnK|WOQWKQS",8082=>"Qf`JZnP='",8083=>"|DuYfHrI%HGtMHnD",8084=>"",8085=>"SY|StMIQ",8086=>"?zNs?Qf`MS?mN}'",8087=>"GZPQ|DHrt|SMI",8088=>"GZPQ|DHrt|WHJ",8089=>"DQJQWtQS|fMJQD",8090=>"ZWtMvZtQ",8091=>"|fMJQD",8092=>"'{",8093=>'fMQJSD',8094=>'IQtOHS',8095=>'DMAQ',8096=>'|grHWQDDmWHnD',8097=>'|grHWQDDFMJQDMAQ',8098=>"fMJQ|MS",8099=>'ZGGJMQS|MS',8100=>'JQP|YJuQ',8101=>"WZnWQJ",8102=>"YPWHJHr",8103=>'<F0F0F0',8104=>"ftGPQtfMJQ`GOG IHSuJQ=QDOHG]MS=",8105=>"fMJQ|nZIQ|DOHrt",8106=>"QSMt|MWHn",8107=>"\"?YHrSQr=0?ZJt=\"",8108=>"ZWt|MS",8109=>"|JMDt%ZWtMvQ|Hff",8110=>"fMJQDMAQ",8111=>"ZWtMvQ",8112=>"'",8113=>"|fMJQD?coqRq?MS='",8114=>"UgszTq?",8115=>"YHtO",8116=>"!?fMJQD|DMAQ=+1",8117=>"Hn",8118=>"DtZtuD|ZWtMvZtQ",8119=>"QDOHG|fMJQD|GZtO",8120=>"DtZtuD|fMJQ|QxMDtD",8121=>'ffMJQnZIQ',8122=>"QxtQrnZJ|JMnK",8123=>"OHDt",8124=>"rQS",8125=>'fMJQ|SQDWr',8126=>"MD|QxtQrnZJ|fMJQ",8127=>"JZnP",8128=>'nZIQ',8129=>"ZSS|tH|JMDt",8130=>"HnJB|ZJJ",8131=>"ftBGQ",8132=>'ftBGQ',8133=>"nZIQ",8134=>"'?zNs?JZnP='",8135=>"gRmVzTq|gzTo",8136=>'ZWtMvQ',8137=>"ISZtQ",8138=>'QD|fMJQD|',8139=>"GZtO",8140=>"HnJB|GuYJMW") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopFiles extends CMS_ActModule {public $lIIII1l; public $itemId; public $ILLlI1I; public $oEshop; public $lIIII1L; function ModuleEshopFiles(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); }function _Init($IIll1l1 =Array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =Array()) {$modFiles =&$this->cms->Core->GetModule(I8069); $this->lIIII1l =$GLOBALS["ROOT_PATH_WWW"].$modFiles->GetOption("icons_path"); $this->lIIII1l =trim($this->lIIII1l); $this->lIIII1l =str_replace("\\", "/", $this->lIIII1l); if($this->lIIII1l[mb_strlen($this->lIIII1l)-1] != I8070) $this->lIIII1l .= I8070; if(isset($this->cms->Vars["itemId"]) && $this->cms->Vars["itemId"] != "") $this->itemId =$this->cms->Vars["itemId"]; else $this->itemId =0; if(isset($this->cms->Vars[I8071]) && $this->cms->Vars[I8071] != "") $this->ILLlI1I =explode(",", $this->cms->Vars[I8071]); else $this->ILLlI1I =Array(); $IIIIL11["stop_use_sublinks"] =false; $IIIIL11["stop_arg_names"] =array(I8072=>"eshop_currency"); $IIIIL11["check_public"] =false; $IIIIL11["group_operations"] =Array("move", I8073); $IIIIL11["allowed_actions"] =Array("add", "edit", "apply", I8073, I8074, "remove", "activate"); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->lIIII1L =&$this->cms->Core->GetModule($this->oEshop->ownerName."_digitals"); }function _InitAdmin() {require_once($GLOBALS["FUNC_INCLUDES_PATH"].I8075); parent::_InitAdmin(); require_once $GLOBALS['CLASSES_PATH'] .'EshopAdmin.php'; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init($this->moduleName); $this->oEshop->TT1l11l($this->options["multi_sites"], $this->siteId); }function TTTlITT($IIIL11l, $cId, $cModule ='') {$id =intval($cId); switch ($IIIL11l) {case I8076: $this->_ActionMove($cId, $cModule); break; case 'remove': $this->TIIlTTT($cId, $cModule); break; case 'free_download': $this->TIIlTTl($cId, $cModule); break; case 'activate': $this->_ActionActivate($cId, $cModule); break; case 'grp_move': $this->TIII111($this->aGroupIds, $cModule); break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function TIII111(&$aGroupIds, $cModule) {$this->TTTl1II($aGroupIds, $cModule, I8077, "status_grp_move"); }function GetHtml(&$aCustom) {return parent::GetHtml($aCustom); }function TTlTll1() {parent::TTlTll1(); }function TTTlIII() {parent::TTTlIII(); if($this->filter->issetField("datefrom")) $this->filter->TITI1l1("datefrom"); if($this->filter->issetField("dateto")) $this->filter->TITI1l1(I8078); }function _ApplyFilters($prefix ='', $bodyType ='', $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); return $res; }function &TTTlI1T(&$aCustom) {$data =parent::TTTlI1T($aCustom); $data["js_functions"] =$this->cms->Gui->get($this->moduleName.":js_files", $data); $data["selected_files_list"] =$this->cms->Gui->get($this->moduleName.":selected_files_list", $data); $data["scripts"] =$this->cms->Gui->getScripts(); $data["metas"] =$this->cms->Gui->getMetas(); $data["status"] =$this->cms->GetStatusMessages(); global $conn; print $this->cms->Gui->get($this->moduleName, $data); $conn->Out(); die(); }function TTTlI1I(&$vData) {$vData[I8079] =0; $vData["item_id"] =$this->itemId; $vData["active"] ="checked"; $vData["external_link"] =I8080; $vData["external_link_checkbox"] =""; $vData["use_link_disabled"] =""; $vData[I8081] =""; parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {if($this->module->GetOption("allow_external_files")) {$vData["external_link_checkbox"] =$this->cms->Gui->get($this->moduleName."_subform:external_link_checkbox", $vData); }$lIIII11 =I8082.$this->langData."'"; if(empty($vData["ftype"])){ $this->db->query("SELECT id, name FROM cms_ftypes order by id"); if($this->db->num_rows()) while($this->db->next_record()) $data["options"] .= $this->cms->Gui->getAbs($this->moduleName.I8083, Array(I8072 => $this->db->Record[I8072], "type" => $this->db->Record["name"])); $vData["ftype"] =$this->cms->Gui->get($this->moduleName."_subform:ftype", $data); }$sql =I8084; if(sizeof($this->ILLlI1I) >0){ $sql ="SELECT ef.id, ef.is_external_file, ef.active, ef.id_product, ef.original_fname, ef.filesize, ef.name, ef.free_download, DATE_FORMAT(ef.cdate, '".$this->cms->DFMT["db_dtime"]."') AS fcdate, ". "DATE_FORMAT(ef.mdate, '".$this->cms->DFMT[I8085]."') as fmdate, ". "cft.name as cftname, cft.icon as cftpicon FROM ".$this->oEshop->dbTablePrefix."_files ef ". "LEFT JOIN cms_ftypes as cft ON cft.id=IF(ef.ftype > 0, ef.ftype, 1000) WHERE ".$lIIII11.I8086.implode("','", $this->ILLlI1I)."') ORDER BY ef.".$this->module->GetOption("page_sort_col")." ".$this->module->GetOption(I8087); }elseif($this->itemId >0){ $sql ="SELECT ef.id, ef.is_external_file, ef.active, ef.id_product, ef.original_fname, ef.free_download, ef.filesize, ef.name, DATE_FORMAT(ef.cdate, '".$this->cms->DFMT[I8085]."') AS fcdate, ". "DATE_FORMAT(ef.mdate, '".$this->cms->DFMT[I8085]."') as fmdate, ". "cft.name as cftname, cft.icon as cftpicon FROM ".$this->oEshop->dbTablePrefix."_files ef ". "LEFT JOIN cms_ftypes as cft ON cft.id=IF(ef.ftype > 0, ef.ftype, 1000) WHERE ".$lIIII11." AND ef.id_product='".$this->itemId."' ORDER BY ef.".$this->module->GetOption(I8088)." ".$this->module->GetOption(I8087); }else{ $vData["selected_files"] =$this->cms->Gui->getAbs($this->moduleName.":selected_files_list_empty"); }if(!empty($sql)){ $this->db->query($sql); if($this->db->num_rows() >0) {$this->ILLlI1I =Array(); while($this->db->next_record()){ $lIIIlII =$this->db->Record; $lIIIlII["is_selected_in_use"] =true; $this->ILLlI1I[] =$lIIIlII[I8072]; $this->_ProcessID($lIIIlII, $vData); $this->_ProcessOriginalFname($lIIIlII, $vData); $this->_ProcessIcons($lIIIlII, $vData); $this->_ProcessFilesize($lIIIlII, $vData); $vData[I8089] .= $this->cms->Gui->get($this->moduleName.":selected_row", $lIIIlII); }$vData["selected_files_header"] =$this->cms->Gui->getAbs($this->moduleName.":selected_files_header", I8084); $vData[I8079] =$this->db->num_rows(); }else{ $vData[I8089] =$this->cms->Gui->getAbs($this->moduleName.":selected_files_list_empty"); }}if($this->action == I8090) {$this->appliedId =0; }$vData[I8071] =implode(",", $this->ILLlI1I); $this->browser->InitSQL("ef.id, ef.active, ef.name, ef.free_download, ef.id_product, ef.name, ef.original_fname, ef.filesize, ". "DATE_FORMAT(ef.cdate, '".$this->cms->DFMT[I8085]."') AS fcdate, ". "DATE_FORMAT(ef.mdate, '".$this->cms->DFMT[I8085]."') as fmdate, ". "cft.icon as cftpicon, cft.name as cftname", Array('tables' => Array('ef'=>$this->oEshop->dbTablePrefix.I8091, 'cft'=>'cms_ftypes'), 'joins'=>Array('ef|cft'=>'cft.id=IF(ef.ftype > 0, ef.ftype, 1000)') ),"WHERE ".$lIIII11." AND ef.id_product=0".(sizeof($this->ILLlI1I) >0 ?" AND ef.id NOT IN('".implode("','", $this->ILLlI1I).I8092 :I8084), I8084, "cdate", I8084, I8084, _DB_STRAIGHT_JOIN );$this->browser->AddSQLJoinedTables($this->cms->Core, 'ef', Array('cft'=>'cms_ftypes')); $aCustom[I8093] =Array( 'id'=>Array('action'=>'callback', 'object'=>&$this, I8094=>'_ProcessID'), 'name'=>Array('action'=>'stripline', I8095=>160), 'original_fname'=>Array('action'=>'callback', 'object'=>&$this, I8094=>'_ProcessOriginalFname'), 'cftpname'=>Array('action'=>'callback', 'object'=>&$this, I8094=>I8096), 'filesize'=>Array('action'=>'callback', 'object'=>&$this, I8094=>I8097), 'free_download' => Array("action"=>"flagicon", "value"=>1, I8072=>I8098, "on"=>"_list:free_download_on","off"=>"_list:free_download_off") );$aCustom[I8099] ='ef.id'; $aCustom['legend'] =Array('leg_red', 'leg_yellow', I8100, 'leg_free_download_on', 'leg_free_download_off'); if(is_object($this->filter)) {$this->filter->UpdateField("offset", $this->browser->Position); $aCustom['list_data']['filter_hidden_fields'] =$this->filter->GetFieldsAsHidden(); }$aCustom["form_data"]["buttons"] =Array("add", "apply", I8101); if(is_array($this->ILLlI1I) >0 && in_array($this->appliedId, $this->ILLlI1I)) $this->appliedId =0; parent::TTTlI11($vData, $aCustom); }function _ProcessID(&$aItem, &$aData){ static $i =0; static $j =0; if($this->cms->Vars["action"] == "edit" && $this->cms->Vars[I8072] == $aItem[I8072]) {$aItem["bgcolor"] ='#FFF2D9'; }elseif($aItem[I8072] == $this->appliedId) {$aItem[I8102] ='#DDE7F8'; }elseif(($aItem["is_selected_in_use"] && $j%2) || (!$aItem["is_selected_in_use"] && $i%2)){ $aItem[I8102] =''; }else {$aItem[I8102] =I8103; }$aItem["is_selected_in_use"] ?$j++ :$i++; $aItem["view_link"] =I8104.$aItem[I8072]; }function _ProcessOriginalFname(&$aItem, &$aData){ $aItem["file_name_short"] =$this->cms->stripLine($aItem["original_fname"], 160); $aItem[I8105] =$this->cms->Gui->get($this->moduleName."_list:item_add_link", $aItem); }function _ProcessIcons(&$aItem, &$aData){ $aItem["edit_icon"] =I8084; if(!$aItem["is_external_file"] || $this->module->GetOption("allow_external_files")) {$aItem[I8106] =$this->cms->Gui->get($this->moduleName.":edit_icon", $aItem); }$aItem["ficon"] ="<img src=\"".$this->lIIII1l.$aItem["cftpicon"].I8107.$aItem["cftname"]."\">"; $aItem["ficon"] =$this->cms->Gui->get($this->moduleName."_list:item_add_icon_link", $aItem); $aItem[I8108] =$aItem[I8098] =$aItem[I8072]; if($aItem["free_download"]) {$aItem["free_download_icon"] =$this->cms->Gui->get($this->moduleName."_list:free_download_on", $aItem); }else {$aItem["free_download_icon"] =$this->cms->Gui->get($this->moduleName."_list:free_download_off", $aItem); }if($aItem["active"]) {$aItem["active"] =$this->cms->Gui->get($this->moduleName."_list:active_on", $aItem); }else {$aItem["active"] =$this->cms->Gui->get($this->moduleName.I8109, $aItem); }}function _ProcessFilesize(&$aItem, &$aData){ if($aItem["filesize"] <0) {$aItem["size"] =$this->words["unknown"]; }else {$aItem["size"] =getBytesAsText($aItem[I8110], $this->words, 1); }}function _ActionMove($cId, $cModule) {$sql ="SELECT active, filesize FROM ".$this->oEshop->dbTablePrefix."_files WHERE id='".$cId."' AND lang='".$this->langData."' AND id_product=0"; $this->db->query($sql); if($this->db->next_record()){ if(!in_array($cId, $this->ILLlI1I)) {$this->ILLlI1I[] =$cId; }if($this->itemId >0) {$fileSize =$this->db->Record[I8110]; $active =$this->db->Record[I8111]; $sql ="UPDATE ".$this->oEshop->dbTablePrefix."_files SET id_product='".$this->itemId."' WHERE id='".$cId."' AND lang='".$this->langData.I8112; $this->db->query($sql); if($active) {$this->TIIlTTI($this->itemId, true, $fileSize, "both"); }else {$this->TIIlTTI($this->itemId, true, $fileSize, "only_all"); }}}$this->cms->AddStatusMsg("status_add_to_list"); $this->appliedId =$cId; }function TIIlTTT($cId, $cModule) {$sql ="SELECT active, id_product, filesize FROM ".$this->oEshop->dbTablePrefix.I8113.$cId."' AND lang='".$this->langData."' AND id_product!=0"; $this->db->query($sql); $lIIIlIl =false; if($this->db->next_record()){ $lIIIlIL =$this->db->Record["id_product"]; $fileSize =$this->db->Record[I8110]; $active =$this->db->Record[I8111]; $lIIIlIl =true; }if(in_array($cId, $this->ILLlI1I)){ $key =array_search($cId, $this->ILLlI1I); unset($this->ILLlI1I[$key]); }if($lIIIlIl) {$sql ="UPDATE ".$this->oEshop->dbTablePrefix."_files SET id_product='0' WHERE id='".$cId."' AND lang='".$this->langData.I8112; $this->db->query($sql); if($active) {$this->TIIlTTI($lIIIlIL, false, $fileSize, "both"); }else {$this->TIIlTTI($lIIIlIL, false, $fileSize, "only_all"); }}$this->cms->AddStatusMsg("status_remove_from_list"); }function TIIlTTI($itemId, $lIIIlI1, $fileSize, $type) {$sql =I8114.$this->oEshop->dbTablePrefix."_items SET item_type='eshop_digitals', "; if($type != "only_public") {if($lIIIlI1) {$sql .= "num_files_all=num_files_all+1"; }else {$sql .= "num_files_all=num_files_all-1"; }if($type == I8115) {$sql .= ", "; }}if($type != "only_all") {if($lIIIlI1) {$sql .= "num_files=num_files+1"; }else {$sql .= "num_files=num_files-1"; }if($fileSize <0) {if($lIIIlI1) {$sql .= I8116; }else {$aInfo =TlTl1TT($this->db, $itemId, $this->langData, $this->oEshop->dbTablePrefix); $sql .= ", files_size=".$aInfo["size"]; }}else {if($lIIIlI1) {$sql .= ", files_size=IF(files_size < 0, -1, files_size+".$fileSize.")"; }else {$sql .= ", files_size=IF(files_size < 0, -1, files_size-".$fileSize.")"; }}}$sql .= " WHERE id='".$itemId."' AND lang='".$this->langData.I8112; $this->db->query($sql); }function TIIlTTl($cId, $cModule) {$this->fn->TITTT1l($cId, ($this->cms->VarsGet["free_download"]==I8117), $this->oEshop->dbTablePrefix.I8091); }function _ActionActivate($cId, $cModule) {$lIIIllI =($this->cms->Vars[I8090]==I8117); $lIIIlll =$lIIIllI; $sql ="SELECT active, id_product, filesize FROM ".$this->oEshop->dbTablePrefix.I8113.$cId."' AND lang='".$this->langData."' AND id_product!=0"; $this->db->query($sql); $lIIIlIl =false; if($this->db->next_record()){ $lIIIlll =$this->db->Record[I8111]; $productId =$this->db->Record["id_product"]; $fileSize =$this->db->Record[I8110]; }$this->TTT1IIT($lIIIllI, $cId, $this->oEshop->dbTablePrefix.I8091, I8111, I8118); if($lIIIllI != $lIIIlll && $productId >0) {$err =$this->GetLastError(); if(empty($err["errno"])) {$this->TIIlTTI($productId, $lIIIllI, $fileSize, "only_public"); }}}function TTTll11($cId, $cModule) {$lIIIllL =intval($this->cms->VarsPost["use_link"]); if(!$lIIIllL && file_exists($GLOBALS["PRIVATE_PATH"].$this->lIIII1L->GetOption(I8119).$_FILES['ffilename']['name'])>0 && $this->cms->Vars["force_owerwrite"] != "1") {$this->cms->AddStatusMsg(I8120, "red", I8084,I8084, Array("name"=>$_FILES['ffilename']['name'])); }else{ $isError =true; if(!$lIIIllL && filesize($_FILES[I8121]['tmp_name'])>0 ){$filename =I8084; $fsize =@filesize($_FILES[I8121]['tmp_name']); $isError =false; }elseif($lIIIllL) {if(!empty($this->cms->VarsPost["external_link"])) {$this->cms->VarsPost["external_link"] =stripslashes($this->cms->VarsPost[I8122]); $lIIIll1 =@parse_url($this->cms->VarsPost[I8122]); if(is_array($lIIIll1)) {if(($lIIIll1["scheme"] == "http" || $lIIIll1["scheme"] == "https") && $lIIIll1[I8123] != I8084 && $lIIIll1[I8123] != "path") {$filename =$this->cms->VarsPost[I8122]; $fsize =-1; $aInfo =Array(); if($this->module->GetOption("check_external_files") == true) {if($this->TIIlTT1($filename, $aInfo)) {if($aInfo["size"] === false) {$this->cms->AddStatusMsg("status_ext_file_size_undefined", I8124); }else {$fsize =$aInfo["size"]; }}else {$active =0; $this->cms->AddStatusMsg("status_active_reseted", I8124); }}$isError =false; }}}}if(!$isError) {$ftype =$this->cms->VarsPost['ftype']; $lIIIlLI =$this->cms->VarsPost['file_name']; $lIIIlLl =$this->cms->VarsPost[I8125]; $active =intval($this->cms->VarsPost['active']); $asql =Array( "name"=>$lIIIlLI, "description"=>$lIIIlLl, "ftype"=>$ftype, I8111=>$active, I8126=>$lIIIllL, "free_download"=>intval($this->cms->VarsPost['free_download']), "cdate"=>DateTools::toMysqlDate(time()), "mdate"=>DateTools::toMysqlDate(time()), I8127=>$this->langData, I8110=>$fsize, "filename"=>$filename, "original_fname"=>$filename );$lIIIlLL =$asql; $sql =$this->db->GenInsertSQL($this->oEshop->dbTablePrefix.I8091, $asql); $this->db->query($sql); $lid =$this->db->lastInsertId(); $isError =true; if($lIIIllL) {$isError =false; }else {$newfilename ='es_files_'.$lid."_".$_FILES[I8121][I8128].$this->lIIII1L->GetOption("eshop_files_extension"); $newfilename =$this->cms->TTITI11(stripslashes($newfilename)); if($this->cms->doUploadFile($_FILES[I8121], $GLOBALS["PRIVATE_PATH"].$this->lIIII1L->GetOption(I8119).$newfilename)) {$asql =Array( "filename"=>addslashes($newfilename), "original_fname"=>$_FILES[I8121][I8128] );$sql =$this->db->GenUpdateSQL($this->oEshop->dbTablePrefix.I8091, $asql, "WHERE id='$lid'"); $this->db->query($sql); $isError =false; }}if(!$isError) {$this->appliedId =$lid; $this->browser->SetApplied($this->db, $lIIIlLL, $this->langData); $this->browser->Position =0; if($this->cms->VarsPost[I8129]){ $this->ILLlI1I[] =$lid; if($this->itemId >0){ $asql["id_product"] =$this->itemId; $sql =I8114.$this->oEshop->dbTablePrefix."_files SET id_product='".$this->itemId."' WHERE id='".$lid."' AND lang='".$this->langData.I8112; $this->db->query($sql); if($active) {$this->TIIlTTI($this->itemId, true, $fsize, I8115); }else {$this->TIIlTTI($this->itemId, true, $fsize, I8130); }}}$this->cms->AddStatusMsg("status_add"); }else{ $sql ="DELETE FROM ".$this->oEshop->dbTablePrefix.I8113.$lid.I8112; $this->db->query($sql); $this->cms->AddStatusMsg("status_add_fail", I8124); }}else{ $this->cms->AddStatusMsg("status_add_fail", I8124); }}$this->TTT1I1T(); }function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT id, name, filename, description, ftype, IF(active > 0, 'checked', '') AS active, IF(free_download > 0, 'checked', '') AS free_download, is_external_file, if(is_external_file > 0, 'checked', '') AS use_link_checked FROM ".$this->oEshop->dbTablePrefix.I8113.$cId.I8112.$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData["file_name"] =$this->db->Record["name"]; $this->itemData["file_descr"] =$this->db->Record["description"]; $this->itemData[I8131] =$this->db->Record[I8131] >0 ?$this->db->Record[I8131] :1000; $this->itemData["editable"] ="edit"; if($this->db->Record[I8126]) {$this->itemData[I8122] =$this->db->Record["filename"]; }$this->db->query("SELECT id, name FROM cms_ftypes order by id"); if($this->db->num_rows()) while($this->db->next_record()) {$isSelected =I8084; if($this->itemData[I8132] == $this->db->Record[I8072]) $isSelected ="selected"; $data["options"] .= $this->cms->Gui->getAbs($this->moduleName.I8083, Array(I8072 => $this->db->Record[I8072], "ext" => $isSelected, "type" => $this->db->Record[I8133])); }$this->itemData[I8131] =$this->cms->Gui->get($this->moduleName."_subform:ftype", $data); $this->itemData["use_link_disabled"] ="disabled"; }}function TTTl1T1($cId, $cModule) {parent::TTTl1T1($cId, $cModule); }function _ActionDel($cId, $cModule) {$sql ="SELECT active, filename, filesize, id_product, is_external_file FROM ".$this->oEshop->dbTablePrefix.I8113.$cId.I8134.$this->langData.I8112; $this->db->query($sql); $lIIIlIl =false; if($this->db->next_record()) {$filename =$this->db->Record["filename"]; $lIIIlIL =$this->db->Record["id_product"]; $fileSize =$this->db->Record[I8110]; $active =$this->db->Record[I8111]; $lIIIlL1 =$this->db->Record[I8126]; $sql ="DELETE FROM ".$this->oEshop->dbTablePrefix.I8113.$cId.I8112; $this->db->query($sql); if(!$lIIIlL1 && @is_file($GLOBALS["PRIVATE_PATH"].$this->lIIII1L->GetOption(I8119).$filename)) {$this->cms->TTITlTT($filename, $GLOBALS[I8135].$this->lIIII1L->GetOption(I8119)); }$this->cms->AddStatusMsg("status_del"); }else {$this->cms->AddStatusMsg("status_del_fail", I8124); }if(in_array($cId, $this->ILLlI1I)) {$key =array_search($cId, $this->ILLlI1I); unset($this->ILLlI1I[$key]); $this->cms->AddStatusMsg("status_remove_from_list"); }if($lIIIlIL >0) {if($active) {$this->TIIlTTI($lIIIlIL, false, $fileSize, I8115); }else {$this->TIIlTTI($lIIIlIL, false, $fileSize, I8130); }}}function TTTl1lI($cId, $cModule) {$lIIIlLI =$this->cms->VarsPost['file_name']; $lIIIlLl =$this->cms->VarsPost[I8125]; $ftype =$this->cms->VarsPost[I8132]; $lIIIllI =intval($this->cms->VarsPost[I8136]); $lIIIlll =$lIIIllI; $lIIIlLL =Array(); $lIIIlL1 =false; $this->db->query("select name, id_product, filename, is_external_file, active, cdate, mdate, ftype, filesize from ".$this->oEshop->dbTablePrefix."_files where id='".$cId.I8112); if($this->db->next_record()) {$lIIIlLL =$this->db->Record; $lIIIlll =$this->db->Record[I8111]; $lIIIl1I =$this->db->Record["filename"]; $lIIIl1l =$this->db->Record[I8110]; $idProduct =$this->db->Record["id_product"]; $lIIIlL1 =$this->db->Record[I8126]; $asql =Array( I8133=>$lIIIlLI, I8137=>DateTools::toMysqlDate(time()), I8131=>$ftype, "free_download"=>intval($this->cms->VarsPost['free_download']), "description"=>$lIIIlLl); $lIIIlLL =array_merge($lIIIlLL, $asql); $ftype =$this->cms->VarsPost[I8132]; $isError =true; $needUpdate =false; if(!$lIIIlL1 && !empty($_FILES[I8121][I8128])){ $fsize =@filesize($_FILES[I8121]['tmp_name']); $newfilename =I8138.$cId."_".$_FILES[I8121][I8128].$this->lIIII1L->GetOption("eshop_files_extension"); $newfilename =$this->cms->TTITI11(stripslashes($newfilename)); $originalFileName =$_FILES[I8121][I8128]; if($this->cms->doUploadFile($_FILES[I8121], $GLOBALS[I8135].$this->lIIII1L->GetOption(I8119).$newfilename)) {$isError =false; }}elseif($lIIIlL1) {$this->cms->VarsPost[I8122] =stripslashes($this->cms->VarsPost[I8122]); if(!empty($this->cms->VarsPost[I8122])) {$lIIIll1 =@parse_url($this->cms->VarsPost[I8122]); if(is_array($lIIIll1)) {if($lIIIll1["scheme"] == "http" && $lIIIll1[I8123] != I8084 && $lIIIll1[I8123] != I8139) {$newfilename =$this->cms->VarsPost[I8122]; $originalFileName =$newfilename; $fsize =$lIIIl1l; $isError =false; }}}}if(!$isError) {if($lIIIl1I != $newfilename || ($lIIIlL1 && $lIIIl1l <0)) {if($lIIIlL1) {$aInfo =Array(); $fsize =-1; if($this->module->GetOption("check_external_files") == true) {if($this->TIIlTT1($newfilename, $aInfo)) {if($aInfo["size"] === false) {$this->cms->AddStatusMsg("status_ext_file_size_undefined", I8124); }else {$fsize =$aInfo["size"]; }}else {$lIIIllI =0; $this->cms->AddStatusMsg("status_active_reseted", I8124); }}}else {if(!empty($lIIIl1I) && @is_file($GLOBALS[I8135].$this->lIIII1L->GetOption(I8119).$lIIIl1I)) {$this->cms->TTITlTT($lIIIl1I, $GLOBALS[I8135].$this->lIIII1L->GetOption(I8119)); }}$needUpdate =true; }$asql["filename"] =addslashes($newfilename); $asql[I8110] =$fsize; $asql["original_fname"] =$originalFileName; $asql[I8111] =$lIIIllI; }$sql =$this->db->GenUpdateSQL($this->oEshop->dbTablePrefix.I8091, $asql, "WHERE id='".$cId.I8134.$this->langData.I8112); $this->db->query($sql); if($needUpdate && $idProduct >0) {if($lIIIlll == $lIIIllI) {if($lIIIllI) {$this->TIIlTTI($this->itemId, false, $lIIIl1l, "only_public"); $this->TIIlTTI($this->itemId, true, $fsize, I8140); }}else {if($lIIIllI) {$this->TIIlTTI($this->itemId, true, $fsize, I8140); }else {$this->TIIlTTI($this->itemId, false, $lIIIl1l, I8140); }}}$this->appliedId =$cId; $this->browser->SetApplied($this->db, $lIIIlLL, $this->langData); $this->TTT1I1T(); $this->cms->AddStatusMsg("status_apply"); }else {$this->cms->AddStatusMsg("status_apply_fail", I8124); }}function TIIlTT1($url, &$aInfo) {require_once $GLOBALS['CLASSES_PATH'] .'HttpDownloader.php'; $lIIIl1L =new HttpDownloader(); $res =$lIIIl1L->TITl11I($url, $aInfo); if(!$res) {$errCode =$lIIIl1L->error(); if($errCode == HDL_E_SOCKOPEN) {$this->cms->AddStatusMsg("status_ext_file_not_response", I8124); }else {$this->cms->AddStatusMsg("status_ext_file_not_found", I8124); }}return $res; }}?>
