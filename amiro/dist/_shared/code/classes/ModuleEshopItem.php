<?php foreach(array(8187=>"ZSIMn",8188=>'iHSuJQTZxQD`GOG',8189=>'iHSuJQTZxwJZDDQD`GOG',8190=>"TzX|dbdTqi",8191=>"WZIGZMPnTBGQsZtZ",8192=>'MtQI|JMnKD|ZJJHCQS',8193=>"IuJtM|DMtQD",8194=>"PrHuG|HGQrZtMHnD",8195=>"DGQWMZJ|Hff",8196=>"nH|MnSQx|SQtZMJD",8197=>"WZtD|IHSuJQ|nZIQ",8198=>"QxtpQtiHSuJQDjMDt",8199=>"|QxtpQtiHSuJQDjMDtwy",8200=>"DOHC|WZJWD|GrMWQD",8201=>'hToqR|gRmwqd',8202=>"|tZx|WJZDDQD",8203=>"fJt|tBGQ",8204=>'WZt|MS',8205=>"uDQ|DOMGGMnP|IHSuJQ",8206=>"frHnt",8207=>"|WZtD?W?JQft?LHMn?WID|ZSv|WZIGZMPn|tBGQD?t?hN?W`ZSv|WZIGZMPn|tBGQ=t`MS?COQrQ?t`IZtQrMZJ|tBGQ='IHSuJQ'?ZnS?W`MS=",8208=>"MDzSvwZt",8209=>"uDQroZDwZIGZMPn",8210=>"'",8211=>'SZtQtH',8212=>"WZtMS",8213=>"|WrQZtQgZtOwy",8214=>"PQtgZtO",8215=>"",8216=>"Hn|DGQWMZJ",8217=>'ZJJHC|frZWtMHn',8218=>'MDzSvwZt',8219=>'IZx|MtQID',8220=>'|HrSQr',8221=>"MS",8222=>'WuDtHI|nuI|tZYD',8223=>"SZtZDQt|SZtZ",8224=>"OZDgrHGQrtBFMQJSD",8225=>"rZnS|GrHG|MS",8226=>"GZrQnt",8227=>'MtQI|JMnKD|nuI',8228=>"tZx|tBGQ",8229=>"DOMGGMnP|tBGQ",8230=>"SMDWHunt|tBGQ",8231=>"WOZrPQ|tZx|tBGQ",8232=>'SQtZWO',8233=>"DOMGGMnP",8234=>"WMS",8235=>"GQrWQnt",8236=>"DOMGGMnP|SQfZuJt",8237=>"DQJQWtQS",8238=>"SMDWHunt|SQfZuJt",8239=>"WurrQnWB",8240=>"JQvQJ",8241=>'GZtO|GZrQnt|WZt|MS',8242=>"nZIQ",8243=>"ZwZtDNZIQD",8244=>"?FRhi?",8245=>"GrMWQ",8246=>"WurrQnWB|OMSSQn",8247=>"{[",8248=>"GrMWQ|vZrD",8249=>"GrMWQ|vZJuQ",8250=>"WOQWKYHx|SMDZYJQS",8251=>"SMDZYJQS",8252=>"{",8253=>"WurrQnWB|vZJuQD",8254=>"'!'",8255=>"GrMWQ|WZGtMHnD",8256=>"1",8257=>"GMWturQD|YHttHI",8258=>"DOHCgrMWQjHW",8259=>"|SMDWHuntD.?",8260=>"PJHYZJ|SMDWHunt",8261=>"QSMt",8262=>"?",8263=>"WHIYMnQS",8264=>"|DOMGGMnP|tBGQD",8265=>"MS|DOMGGMnP|tBGQ",8266=>"DQJQWt",8267=>"COQrQ",8268=>"DQJQWtQSwHnSMtMHn",8269=>"DOMGGMnP|IHSuJQ|ZSSHn",8270=>"|DuYfHrI%DOMGGMnP|IHSuJQ|ZSSHn",8271=>'fHrI|CMStO',8272=>"|PQtduYwZtDwy",8273=>'WZtMS',8274=>"GZtO",8275=>"ZWtMHn",8276=>'GrHG|nuI',8277=>"WZtMS|DuYJMnK",8278=>"|MtQI",8279=>"iHSuJQotIJ",8280=>"GrMWQ|WZGtMHn",8281=>'WZtmS',8282=>'|DIZJJ',8283=>"fMJtQr",8284=>"^",8285=>'ZqxtmnfH',8286=>'ZRQWHrS',8287=>'',8288=>"DGQW|DOHC|rHHt",8289=>'HGQn|YrZnWO',8290=>'MS',8291=>'DIZJJ|WHJD|JQvQJ|',8292=>"DIZJJ",8293=>"SZtZ",8294=>'JQvQJ',8295=>"|",8296=>'MtQID',8297=>"DIZJJ|fMJtQr|IHSQ",8298=>'1',8299=>"|WuDtHI|fMQJSD",8300=>"fJt|fHrWQ|vZJuQD",8301=>'_',8302=>"YHSB|MtQID",8303=>"DQZrWO|DuYWZtD",8304=>"JQttQr",8305=>"DtZtMW",8306=>"tQxt",8307=>"M`DKu",8308=>"rQDtFrHI",8309=>"WOQWKYHx",8310=>"frHI",8311=>"M`GrMWQ",8312=>"YHSB|WZtD",8313=>"LHMn",8314=>"WuDtHI",8315=>'MtQI|DQt',8316=>"MtQIs|QIGtB",8317=>"SQDWrMGtMHn",8318=>'DEJ',8319=>"?zNs?W`GuYJMW=1",8320=>'~',8321=>"MtQI|SQtZMJ",8322=>'nZIQ',8323=>'MS|HCnQr',8324=>'vZr?ZWtMvQ|IHSuJQ|MtQI|OQZSQr?=?"',8325=>'YHSB|YrHCDQ',8326=>'MtQIs|nZv|SZtZ',8327=>'YHSB|urPQnt|MtQID',8328=>'urPQnt|MtQI|',8329=>'JMDt|SZtZ',8330=>'YrHCDQ|MtQI|rHC',8331=>"'{",8332=>'fMQJSD',8333=>"SY",8334=>"ZSv|WZIGZMPn|tBGQ",8335=>'fMJtQr',8336=>'MtQI|QIGtB',8337=>'HYLQWt',8338=>"GZrQntwZtmS",8339=>"ZSSgZrZID",8340=>"WZtwurrQnWB",8341=>"GrMWQ|WurrQnWB",8342=>'JMDt|DQt',8343=>"WZts|",8344=>"|pQtgMWturQDwy",8345=>"WZts|QIGtB",8346=>"WZts",8347=>"WZt|ZSv|GJZWQ",8348=>'YHSB|urPQnt|WZtD',8349=>"!?W`DGQWMZJ|fJZP",8350=>"coqRq?",8351=>"DuYJMnK",8352=>"'?",8353=>"{?",8354=>'MtQI',8355=>'DuYMtQI',8356=>"SMDWHuntDyBwZtmS",8357=>"DuY|MtQI|WHJD",8358=>"ZduYwZtDNZIQD",8359=>'GZPQ|DHrt|SMI',8360=>"WZt|JQvQJ|ZYD",8361=>"Qxt|",8362=>'MtQI|WZtnZIQ',8363=>'Gf',8364=>"'{?ZD?fSZtQ",8365=>"W`GuYJMW=1?",8366=>"WZtnZIQ",8367=>"W`DuYJMnK",8368=>'DEJ|COQrQ',8369=>'HqnPMnQ',8370=>"|WZtD",8371=>"MnSQx",8372=>"wurgZPQTBGQ",8373=>"]HffDQt=",8374=>'DEJ|fMQJSD',8375=>'{',8376=>"MtQI|JMDt",8377=>"vZrMZYJQ|GrMWQ",8378=>"GZtO|DQttMnPD",8379=>"dqjqwT?nZIQ?FRhi?",8380=>'MS|WZtQPHrB',8381=>'QxGHrt|IHSuJQ',8382=>'Qxt|MIZPQD',8383=>"ZdEJ",8384=>"SQDtwZtguYJMW",8385=>"nuImtQID",8386=>"?COQrQ?MS|MtQI=",8387=>"GuYJMDO",8388=>"'?zNs?M`JZnP='",8389=>"+1",8390=>'v5|Hn|MtQI|SQJQtQ',8391=>"|MtQID?coqRq?MS='",8392=>'MS|DHurWQ',8393=>"M|GuY",8394=>"MtQI|tBGQ",8395=>"ZftQr|SQJ",8396=>"DEJ",8397=>"DtZtuD|SQJ|fZMJ",8398=>"'?zNs?JZnP='",8399=>"+",8400=>"WZt|GuYJMW",8401=>"ZJJ",8402=>"MS|WZtQPHrB",8403=>"WZt|nZIQ",8404=>"WZIGZMPnsZtZ",8405=>"nHnQ",8406=>"-1",8407=>"uGSZtQ",8408=>"DGQWMZJ",8409=>"PrG|DGQWMZJ|Hff",8410=>"OQZSQr",8411=>"|PrG|MSD",8412=>"QDOHG|DGQWMZJ|fHrI",8413=>"YJuQ",8414=>"DtZtuD|DGQWMZJ",8415=>"nuI|MtQID",8416=>"DD|DKu",8417=>"!",8418=>"DD|GrMWQ",8419=>"SY|WurrQnWB",8420=>"DD|nZIQ",8421=>"DD|rQDt",8422=>"Wnt",8423=>"W|GuY",8424=>"|MtQID?coqRq?DKu='",8425=>"rQS",8426=>"ZGGJB",8427=>"DQJQWt?GrMWQ?frHI?",8428=>"coqRq?MS|DHurWQ='",8429=>"M|JQttQr",8430=>"DD|MS",8431=>"'?zNs?MS,='",8432=>"DKu",8433=>"GHDMtMHn",8434=>"|MtQID",8435=>"-",8436=>"WZt|MS",8437=>"M`MtQI|tBGQ",8438=>"fJt|nZIQ",8439=>"fJt|DKu",8440=>"?JMKQ?",8441=>'fJt|MtQI|JMnKD',8442=>"fJt|MtQI|JMnKD",8443=>"JMDt|SZtZ",8444=>"}}M`Hn|DGQWMZJ?]?",8445=>"!}",8446=>"JMDt",8447=>'M_W',8448=>"M`MS",8449=>"}",8450=>'tBGQ',8451=>'HGtMIMAZtMHn',8452=>'M`MS',8453=>'ZWtMHn',8454=>'fJZPMWHn',8455=>'Hff',8456=>'Hn',8457=>'WZtQPHrB',8458=>'DMAQ',8459=>"Hn",8460=>"vZJuQ",8461=>'WZJJYZWK',8462=>"fHrI|SZtZ",8463=>"rQDt",8464=>"JQP|rQS",8465=>"GZPQ|MD|JZDt",8466=>'ZsZtZ',8467=>'IHSmS',8468=>"ZgrMWQwZGtMHnD",8469=>'WZtMS|DuYJMnK',8470=>"SZtZDQt|MS",8471=>'WuDtHI|fMQJSD',8472=>'IQtOHS',8473=>"rHC",8474=>"DGJMttQrgQrMHS",8475=>"|WZt",8476=>"GMWturQ",8477=>"GHGuG|GMWturQ",8478=>"ZnnHunWQ",8479=>"DuYWZtQPHrB|JMDt",8480=>"MtQIMS",8481=>'GZrQntwZtmS',8482=>"MS|SMDWHunt",8483=>'SZtZDQt|MS',8484=>"ZSS|GZrZID",8485=>"DQZrWO|MtQI",8486=>"MtQI",8487=>'ZmtQI',8488=>'DtrMGmtQINZIQ',8489=>"DOHC|rHHt|WZt",8490=>"ZJt",8491=>'ZRQDsZtZ',8492=>"WZJJQr",8493=>"iHSuJQqDOHGmtQI%%|GrMWQRHC",8494=>"WZJW|GrMWQ",8495=>"rHC|MnSQx",8496=>"tZx",8497=>"MS|tZx|WJZDD",8498=>"DWrMGt|GrMWQD",8499=>"GrMWQD",8500=>"MD|WOMJSD|rQZSB",8501=>'GZrQntmS',8502=>'WOMJSD',8503=>'@',8504=>"?DQJQWtQS",8505=>"@",8506=>"DKMG|MtQI",8507=>"tMtJQ",8508=>'Zt|DGQW|YJHWK',8509=>"wid|zWtiHSuJQ%%|zGGJBFMJtQrD",8510=>"GZrQntmS",8511=>"PQtduYwZtD",8512=>"WiZxjQvQJ",8513=>"MS|GZrQnt",8514=>"YHSB|MtQIs",8515=>"MtQIs",8516=>"RhhT|gzTo|ccc",8517=>'GMWturQ|OQMPOt',8518=>"ZYD",8519=>"uGSZtQ?",8520=>"Qxt|WuDtHI",8521=>"PQt|SQtZMJD",8522=>"fMQJS",8523=>"PQt|rQf|SQtZMJD",8524=>"GZrQntDms",8525=>'!',8526=>"{?zNs?}",8527=>"?jmimT?",8528=>'fJt|tBGQ',8529=>'SZtZ',8530=>"FRhi?.",8531=>'PQt|tMtJQD',8532=>"|MtQID.?",8533=>"?mNNqR?lhmN?",8534=>'ZJJ|GZrQntD',8535=>"\"@",8536=>"WHntQnt",8537=>"JMnKD|GHGuG",8538=>'GHDMtMHn',8539=>'GuYJMW',8540=>"SQJQtQ?frHI?",8541=>"|MtQID?coqRq?MS=",8542=>'DuYJMnK',8543=>'COQrQ?MS=',8544=>'WuDtHI|fMQJS|',8545=>'SQJQtQ',8546=>'DQJQWt?MS?frHI?',8547=>'|GrHGD',8548=>'WMS') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopItem extends CMS_ActModule {public $cid; public $catId; public $lIIIL1l; public $lIIIL1L; public $chargeTaxType; public $lIIIL11; public $I1IL1Ll; public $KeepItemCatId =false; public $lIII1II; public $lIII1Il; public $ILLllI1; public $IIl1IL1; public $I1Ill1L; public $id; public $catOffset; public $offset; public $lIII1IL; public $lIII1I1; public $lIII1lI; public $catSublink; protected $lIII1ll; public $lIII1lL =""; public $lIII1l1 =""; public $lIII1LI; public $IIllILI; public $lIII1Ll; public $lIII1LL; public $lIII1L1; public $lIII11I; public $lIII11l; public $oEshop; public $lIII11L; public $I1LLlII; public $I1LLlIl; public $ILLIIIL; public $lIII111; public $lIIlIII; public $lIIlIIl; public $I1LLlL1; public $lIIlIIL; public $lIIlII1; public $I1LLllI; public $_useShippingModule; public $lIIlIlI; public $lIIlIll =array(); public $lIIlIlL =array(); public $lIIlIl1; public $IIL1LIL; public $I1LLlLI; public $lIIlILI; public $lIIlILl; public $lIIlILL; public $lIIlIL1; public $lIIlI1I; public $lIIlI1l; public $lIIlI1L; public $lIIlI11; private $lIIllII =array(); private $aCaptions; private $aCustomFields; function ModuleEshopItem(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); if($this->cms->Core->Side == I8187) {require_once $GLOBALS['CLASSES_PATH'] .'EshopAdmin.php'; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init($this->moduleName); require_once $GLOBALS['CLASSES_PATH'] .I8188; require_once $GLOBALS['CLASSES_PATH'] .I8189; $this->I1LLlII =new ModuleTaxClasses($cms, $db, $cModule); $this->cms->Gui->AddGlobalVars(array(I8190 => $this->I1LLlII->lllI1Ll)); }else {CreateEshop($cms); $this->oEshop =&$cms->Eshop; $this->lIIlILl =""; }$this->I1IL1Ll =Array(); $this->lIII1L1 =false; $this->lIII11I =-1; $this->ILLIIIL =false; $this->lIII111 =false; $this->lIIlIII =false; $this->lIIlIIl =false; $this->lIIlIll =Array(); $this->lIIlIl1 =""; $this->lIIlIIL =array("isAdvCat" => false, "userHasCampaign" => false, I8191 => array(), "campaignData" => array(), "numItems" => 0); $this->IIL1LIL =""; $this->I1LLlLI =""; $this->lIIlILL =Array(); $this->lIIlI1I =$this->module->IssetAndTrueOption(I8192); $this->cms->Gui->AddGlobalVars(array("ITEM_LINKS_ALLOWED" => $this->lIIlI1I)); $this->lIIlI1l =false; $this->lIIlI11 =true; }function _Init($IIll1l1 =Array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =Array()) {$this->I1LLlL1 =$this->cms->Core->IsInstalled($this->oEshop->ownerName .'_home') ?$this->oEshop->ILlLL1l->GetOption("num_extra_special_flags") :0; $this->lIIlII1 =$this->oEshop->ILlLLLL->GetOption("num_special_flags");; $IIIIL11['default_prefix'] ='i'; $IIIIL11["use_options_form"] =true; $IIIIL11[I8193] =true; $IIIIL11["admin_init_order"] =Array("form", "filter"); $IIIIL11["use_positions"] =true; $IIIIL11[I8194] =Array("publish_on", "publish_off"); if($this->I1LLlL1 >0) {$IIIIL11[I8194][] ="special_advanced"; }else {$IIIIL11[I8194][] ="special_on"; $IIIIL11[I8194][] =I8195; }$IIIIL11[I8194] =array_merge($IIIIL11[I8194], Array("del", "gen_sublink", "gen_keywords", "index_details", I8196, "move_position")); $IIIIL11['picture_cat'] =$this->module->GetProperty('picture_cat'); $IIIIL11[I8197] =$this->oEshop->ownerName."_cat"; $IIIIL11["group_operations_popup"] =Array("change_parent_cat"); $IIIIL11[I8194][] ="change_parent_cat"; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); if($this->cms->Core->IsInstalled($this->oEshop->ownerName."_letters")){ $this->lIII111 =&$this->cms->Core->GetModule($this->oEshop->ownerName."_letters"); if(is_object($this->fn)){ $this->lIIlIII =&$this->fn; $this->ILLIIIL =true; }}}function _InitAdmin() {parent::_InitAdmin(); $this->oEshop->TT1l11l($this->options[I8193], $this->siteId); $this->oEshop->setCallbackObject($this); $this->oEshop->setCallbackMethod(I8198, I8199); $this->lIIIL1l =$this->oEshop->mEshop->GetOption(I8200); if (!$this->lIIIL1l && !$this->oEshop->mEshop->GetOption("show_base_price") && !sizeof($this->oEshop->mEshop->GetOption("extrafield_price_on"))) {$this->cms->Gui->AddGlobalVars(array ('HIDE_PRICES_IN_LIST' => true)); }$this->lIIIL1L =$this->oEshop->mEshop->GetOption("sku_is_unique"); if($this->oEshop->otherPricesEnabled) {$this->cms->Gui->AddGlobalVars(Array(I8201 => "1")); }if($this->oEshop->mEshop->GetOption("show_sku_column")) {$this->cms->Gui->addGlobalVars(Array("SKU_COL"=>"1")); }if($this->cms->Core->IsInstalled($this->oEshop->ownerName.I8202)){ $this->chargeTaxType =$this->cms->Core->GetModOption($this->oEshop->ownerName.I8202, "charge_tax_type"); }else{ $this->chargeTaxType =$this->oEshop->mEshop->GetOption('charge_tax_type'); }$this->lIIIL11 =""; if(isset($this->cms->Vars["flt_type"])) {$this->lIIIL11 =$this->cms->Vars[I8203]; }$this->cid =0; if(AMI::getSingleton('env/async50')->isActive()){ $this->cid =(int)(isset($this->cms->Vars['force_cat_id']) ?$this->cms->Vars['force_cat_id'] :AMI_Filter::getFieldValue('category', 0)); }elseif(!empty($this->cms->Vars[I8204])){ $this->cid =(int)$this->cms->Vars[I8204]; }$this->catId =0; $this->I1LLllI =Array(); $this->TT11TTT(); if($this->I1LLlL1) {$this->I1LLl1I =$this->cms->Gui->ParseLangFile($GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/lang/".$this->oEshop->ownerName."_home.lng"); }else {$this->I1LLl1I =Array(); }$_moduleName =$this->oEshop->ownerName ."_shipping_methods"; $this->_useShippingModule =$this->cms->Core->IsInstalled($_moduleName) && $this->cms->Core->GetModOption($_moduleName, I8205); if($this->realSide == I8206 && isset($this->cms->Vars["cid"]) && $this->cms->Vars["cid"] >0 && $this->TTT11ll()){ $curCatId =intval($this->cms->Vars["cid"]); $sql ="select t.* from ".$this->oEshop->dbTablePrefix.I8207.$curCatId; $this->db->query($sql); if($this->db->next_record()){ $this->lIIlIIL[I8208] =true; $this->lIIlIIL[I8191] =$this->db->Record; if(($lIIllIl =$this->cms->Core->GetUserId()) >0){ $sql ="select * from cms_adv_campaigns where id_type='".$this->db->Record["id"]."' and id_owner='".$lIIllIl."' limit 1"; $this->db->query($sql); if($this->db->next_record()){ $this->lIIlIIL[I8209] =true; $this->lIIlIIL["campaignData"] =$this->db->Record; }$sql ="select count(id) as count from ".$this->oEshop->dbTablePrefix."_items where id_category=".$curCatId." and id_owner='".$lIIllIl.I8210; $this->db->query($sql); if($this->db->next_record()) $this->lIIlIIL["numItems"] =$this->db->Record["count"]; }}}if($this->filter->issetField('datefrom')){ $this->filter->TITI1l1('datefrom'); }if($this->filter->issetField(I8211)){ $this->filter->TITI1l1(I8211); }$this->filter->IL11l1L =array('limit'); }function TTTlTI1() {if(!$this->lIII1L1) {$aEvent =array( 'modId' => $this->moduleName, 'oEngine' => $this );AMI_Event::fire('v5_on_before_eshop_front_init', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); parent::TTTlTI1(); $this->oEshop->init($this->moduleName); $this->oEshop->TT1l11l($this->options[I8193], $this->siteId); $this->lIII1L1 =true; $this->lIII1II =$this->oEshop->mEshop->GetOption("show_subcategory_items"); $this->lIII1Il =$this->oEshop->mEshop->GetOption("show_subcategories"); $this->ILLllI1 =$this->oEshop->mEshop->GetOption("show_currency_signs"); $this->lIII1LL =$this->oEshop->mEshop->GetOption("show_announce_in_subcats"); $this->IIl1IL1 =$this->I1Ill1L =Array(); $this->id =intval($this->cms->Vars["id"]); $this->catId =$this->oEshop->rootCatId; if(isset($this->cms->VarsPost[I8212])) {$this->catId =intval($this->cms->VarsPost[I8212]); }elseif(isset($this->cms->VarsGet[I8212])) {$this->catId =intval($this->cms->VarsGet[I8212]); }$this->TT11TTT(); $this->lIIlILI =$this->cms->Core->getModOption($this->oEshop->ownerName .'_cat', 'show_urgent_elements'); $aEvent =array( 'modId' => $this->moduleName, 'oEngine' => $this );AMI_Event::fire('v5_on_after_eshop_front_init', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); }}function TTT1TI1($IIl1LI1, &$aCustom) {$IIl1LlI =""; switch($IIl1LI1) {default: $IIl1LlI =$this->TTT1TI1($IIl1LI1, $aCustom); break; case "change_parent_cat": $aData =Array(); $this->oEshop->mEshop->PushPager($this->browser); $this->oEshop->ILlLLLL->InitPager($this->browser); $this->browser->SortCol ="name"; $this->oEshop->tree->setCallbackMethod("buildTreeOnChildsArray", "__buildTreeOnChildsArrayCB"); $this->oEshop->tree->sqlOrderEnable(); $this->oEshop->tree->createChildsArrayFlt("name"); $this->oEshop->tree->initResult(""); $aData["cat_list"] =$this->oEshop->tree->buildTreeOnChildsArray(); $this->oEshop->tree->sqlOrderDisable(); $IIl1LlI =$this->cms->Gui->get($this->moduleName."_list:grp_change_parent_cat_body", $aData); $this->oEshop->mEshop->PopPager($this->browser); break; }return $IIl1LlI; }function TT11TTT() {$this->oEshop->tree->setCallbackObject($this); if($this->side == I8187) {$this->oEshop->tree->setCallbackMethod("createChildsArrayFlt", "_treeArrayCB"); $this->oEshop->tree->setCallbackMethod("buildTreeOnChildsArray", "_buildTreeOnChildsArrayCB"); $this->oEshop->tree->setCallbackMethod("getAllParents", I8213); $this->oEshop->tree->setCallbackMethod("getPath", "_getPathCB"); $this->oEshop->tree->setCallbackMethod("getNode", "_getNodeRecordCB"); }else {$this->oEshop->tree->setCallbackMethod(I8214, "_getPathFrontCB"); $this->oEshop->tree->setCallbackMethod("getChildsFlt", "_getChildsIdCB"); if($this->lIII1LL){ $lIIllIL ="name, announce, sublink, count_public_childs, ext_picture, ext_popup_picture, ext_small_picture, adv_place as cat_adv_place, id as adv_counter_id, adv_campaign_type, urgent"; }else{ $lIIllIL ="name, announce, sublink, count_public_childs, ext_picture, ext_popup_picture, ext_small_picture, adv_place as cat_adv_place, id as adv_counter_id, adv_campaign_type, urgent"; }if($this->oEshop->ILlLLLL->IssetOption("num_special_flags")) {if($this->lIIlII1 >0) {$lIIllIL .= ", special_flag"; }}$this->oEshop->tree->TI11IIT("getSubCats", $lIIllIL); }}function TIIlTII(&$vData, $varName ="", $setPrefix =I8215) {$value =isset($this->itemData["on_special"]) ?$this->itemData["on_special"] :0; $vData["special_flag_list".$varName] =TIIlTII($this->cms->Gui, $this->moduleName."_subform", 1, $this->I1LLlL1, $this->I1LLl1I, $value, $varName, $setPrefix); $this->TIIlTIl($vData); }function TIIlTIl(&$vData) {$vData[I8216] =((isset($this->itemData[I8216]) && ($this->itemData[I8216] &1)) ?"checked" :I8215); unset($this->itemData[I8216]); }function TTTlI1l() {$res =false; if(parent::TTTlI1l()) {$res =($this->cid >0); }return $res; }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); $this->TIIllIl(); if($this->oEshop->isFractionAllowed){ $vData['ESHOP_ALLOW_FRACTION'] ='1'; if(!empty($this->itemData['allow_fraction'])){ $this->itemData[I8217] ="checked"; }}if(isset($this->cms->Vars['cid']) && $this->cms->Vars['cid'] >0){ $vData['set_cid'] =1; if( $this->lIIlIIL[I8218] && (!$this->lIIlIIL['userHasCampaign'] || $this->lIIlIIL['campaignData']['max_items'] >0 && $this->lIIlIIL['campaignData'][I8219] <= $this->lIIlIIL['numItems'] )&& !isset($this->itemData['id']) ){$vData['set_cid'] =0; if(!$this->lIIlIIL['doNotShowError']){ $this->cms->AddStatusMsg('adv_max_items_exceeded', 'red'); }}}if(isset($this->itemData["id_category"]) && $this->itemData["id_category"] >0) $lIIllI1 =intval($this->itemData["id_category"]); else $lIIllI1 =intval($this->catId); $vData["hasCustomFieldsTabs"] =false; $vData["hasPropertyFields"] =false; if($lIIllI1 >0){ $sql ="SELECT `dataset_id`, `dataset_data`, `allow_fraction`, `count_public_childs` FROM ".$this->oEshop->dbTablePrefix."_cats WHERE `id`=".$lIIllI1; $this->db->query($sql); if($this->db->next_record()){ $IL1ILLl =array(); if ($this->cms->Core->IsInstalled($this->oEshop->ownerName .'_order') && $this->cms->Core->GetModOption($this->oEshop->ownerName .I8220, 'allow_fractional_quantity') ){$vData['cat_allow_fraction'] =$this->db->Record[I8217]; }$IIlLIIL =Array("action"=>"set_dataset", I8221=>0, "item_data"=>&$this->db->Record, "custom"=>&$IL1ILLl); $this->TTT1lI1($IIlLIIL); $vData['hasCustomFieldsTabs'] =isset($IL1ILLl['custom_num_tabs']) && $IL1ILLl[I8222] >0; $vData['hasPropertyFields'] =isset($IL1ILLl['prop_num']) && $IL1ILLl['prop_num'] >0 && $IL1ILLl['prop_num_norest'] <= 0; $ILLlIII =unserialize($this->db->Record[I8223]); if(is_array($ILLlIII)) $vData["dataset_name"] =$ILLlIII["name"]; else $vData["dataset_name"] =$this->words["unknown"]; }else{ }}$this->lIIlIIl =$vData[I8224]; if($this->lIIlIIl){ $vData["prop_id"] =$this->action == "edit" ?intval($this->id) :0; if($vData["prop_id"] == 0){ $vData["prop_id"] =1000000+mt_rand(100000, 999999); SetLocalCookie(I8225, $vData["prop_id"], time()+86400, $this->cms->AdminPathWWW); }}$vData["cat_id"] =$this->catId; $vData["date"] =date($this->cms->DFMT["php"]); $vData[I8226] =I8215; $vData["cat_childs"] =I8215; $vData["price"] =0; $vData["num_decimal_digit"] =$this->oEshop->numberDecimals; $vData["item_type"] =$this->oEshop->defaultItemType; $lIIlllI =Array(); $lIIllll =Array(); $lIIlllL =Array(); $vData[I8227] =0; $vData['item_links_list'] =''; $vData['is_item_link'] =false; $vData =array_merge($vData, $this->itemData); $this->oEshop->TT111ll($this->action, $vData); $vData =array_merge($vData, $this->itemData); $lIIlll1 =$this->module->GetOption("specials_form_location"); if($lIIlll1 >0) {$vData["hasCustomFieldsTabs"] =($vData["hasCustomFieldsTabs"] || ($lIIlll1 == 3)); $this->TIIlTII($vData, "_".$lIIlll1); }else {$this->TIIlTIl($vData); }if($this->action == "edit") {$lIIlllI['percent'] =($this->itemData[I8228]=='percent') ?'selected': ''; $lIIllll['percent'] =($this->itemData[I8229]=='percent') ?'selected': ''; $lIIlllL['percent'] =($this->itemData[I8230]=='percent') ?'selected': ''; $vData["charge_tax_type_charge"] =($this->itemData[I8231]=='charge') ?'checked' :''; $vData["charge_tax_type_detach"] =($this->itemData[I8231]==I8232) ?'checked' :''; if($this->chargeTaxType == "charge" || $this->chargeTaxType == "detach") {$vData["CHOOSE_CHARGE_TAX_TYPE"] =$this->cms->Gui->get($this->moduleName."_subform:CHOOSE_CHARGE_TAX_TYPE", $vData); }unset($this->itemData[I8228]); unset($this->itemData[I8229]); unset($this->itemData[I8230]); $vData["tax"] =$this->itemData["tax"]; $vData["shipping"] =$this->itemData[I8233]; $vData["discount"] =$this->itemData["discount"]; if(isset($this->cms->Vars["cid"]) && $this->cms->Vars["cid"] >0 && $this->cms->Vars[I8234] != $this->itemData["id_category"]) {$this->catId =$this->cms->Vars[I8234]; for($i=0;$i<$this->oEshop->numPrices;$i++) {$lIIllLI[$this->oEshop->priceFields[$i]] =0; }}else {$this->catId =$this->itemData["id_category"]; $one =1; $lIIllLl =I8215; for($i=0;$i<$this->oEshop->numPrices;$i++) {$mask =$one << ($this->oEshop->priceFields[$i] -1); $lIIllLI[$this->oEshop->priceFields[$i]] =($mask &$this->itemData["price_mask"]); }}$vData["cat_id"] =$this->catId; }else {$lIIlllI[I8235] =(mb_strpos($this->oEshop->mEshop->GetOption("tax_default"), "%") !== false) ?"selected": I8215; $lIIllll['percent'] =(mb_strpos($this->oEshop->mEshop->GetOption(I8236), "%")!==false) ?"selected" :I8215; $lIIlllL[I8235] =(mb_strpos($this->oEshop->mEshop->GetOption("discount_default"), "%")!==false) ?I8237: I8215; if($this->cms->Core->IsInstalled($this->oEshop->ownerName.I8202)){ $lIIllLL =$this->cms->Core->GetModOption($this->oEshop->ownerName.I8202, I8231); }else{ $lIIllLL =$this->oEshop->mEshop->GetOption('charge_tax_type'); }$vData["charge_tax_type_charge"]=($lIIllLL=="charge") ?"checked" :I8215; $vData["charge_tax_type_detach"]=($lIIllLL=="detach") ?"checked" :I8215; if($this->chargeTaxType == "charge" || $this->chargeTaxType == "detach") {$vData["CHOOSE_CHARGE_TAX_TYPE"] =$this->cms->Gui->get($this->moduleName."_subform:CHOOSE_CHARGE_TAX_TYPE", $vData); }$vData["tax"] =doubleval($this->oEshop->mEshop->GetOption("tax_default")); $vData[I8233] =doubleval($this->oEshop->mEshop->GetOption(I8236)); $vData["discount"] =doubleval($this->oEshop->mEshop->GetOption(I8238)); }$lIIlllI["name"] =I8228; $lIIllll["name"] =I8229; $lIIlllL["name"] =I8230; $lIIlllI["currency"] =$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency).$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency); $lIIllll[I8239] =$lIIlllL[I8239] =$lIIlllI[I8239]; $vData[I8228] =$this->cms->Gui->get($this->moduleName."_subform:charge_type", $lIIlllI); $vData[I8229] =$this->cms->Gui->get($this->moduleName."_subform:charge_type", $lIIllll); $vData[I8230] =$this->cms->Gui->get($this->moduleName."_subform:charge_type", $lIIlllL); $this->I1LLlIl =true; $this->I1LLlIL =false; if($this->cms->Core->IsInstalled($this->oEshop->ownerName.I8202)){ $this->I1LLlII->TIl1I1I($this, $this->action, $vData, $this->itemData); }if(AMI_Registry::get('oldenv_inside_newenv', FALSE) === FALSE){ $this->I1IL1Ll[I8240] =0; $this->I1IL1Ll["is_childs"] =false; $this->I1IL1Ll['path_parent_cat_id'] =-1; if ($this->cid && $this->cid != $this->oEshop->rootCatId) {$sql ="SELECT `id_parent` FROM `" .$this->oEshop->dbTablePrefix .'_cats` WHERE `id` = ' .$this->cid; $this->I1IL1Ll[I8241] =$this->db->getValue($sql); }$this->oEshop->mEshop->PushPager($this->cms->Pager); $this->oEshop->mEshop->InitPager($this->cms->Pager, I8215, $this->oEshop->ILlLLLL->GetOption("front_page_sort_col"), $this->oEshop->ILlLLLL->GetOption("front_page_sort_dim")); if($this->realSide == I8206) {$this->oEshop->tree->AddFilter("audit_public_cat", "c.public=1"); }$this->oEshop->tree->sqlOrderEnable(); $this->oEshop->tree->createChildsArrayFlt(I8242); if ($vData[I8204] != $this->cid && $this->cid) {$this->cid =$vData[I8204]; }$this->oEshop->tree->initResult(Array(I8226=>&$vData[I8226], "childs"=>&$vData["cat_childs"], "selected_id"=>$vData["cat_id"], I8243=>&$this->I1LLllI)); $ILLILI1 =Array(); $ILLILI1 =$this->oEshop->tree->buildTreeOnChildsArray(); $this->oEshop->tree->sqlOrderDisable(); $this->oEshop->mEshop->PopPager($this->cms->Pager); }else{ if ($vData[I8204] != $this->cid && $this->cid) {$this->cid =$vData[I8204]; }}$vData["prices_on"] =I8215; if($this->oEshop->otherPricesEnabled) {$this->oEshop->getPriceFields("price_caption%d"); $sql ="SELECT i.id, i.price".$this->oEshop->getPriceFields("i.price_caption%d, i.price%d").I8244.$this->oEshop->dbTablePrefix."_cats i WHERE i.id='".$this->catId."' ".$this->_ApplyFilters(); $this->db->query($sql); $this->db->next_record(); $lIIllLl =I8215; $lIIllL1 =I8215; $lIIll1I =I8215; $lIIll1l =Array(); for($i=0; $i<$this->oEshop->numPrices; $i++) {$numPrice =$this->oEshop->priceFields[$i]; $Il111lI =Array(); $tmp =$this->oEshop->TT11TlT($this->db->Record["price".$numPrice]); $Il111lI["num_price"] =$numPrice; $I1LL1Ll =$tmp[I8245]; $ILl11ll =1; $currencyRate =1; if(isset($tmp["db_currency"]) && $tmp["db_currency"] != I8215 && $this->oEshop->issetCurrency($tmp["db_currency"])) {$tmp[I8239] =$tmp["db_currency"]; }else {$currencyRate =$this->oEshop->getCurrencyRate($tmp[I8239]); }if($this->oEshop->issetCurrency($tmp[I8239]) && $tmp[I8239] != I8215) {$Il111lI[I8239] =$tmp[I8239]; $Il111lI[I8246] =$this->cms->Gui->get($this->moduleName."_subform:currency_hidden", $Il111lI); $lIIll1l[$tmp[I8239]] =I8215; $Il111lI["currency_name"] =$this->cms->Gui->getAbs($this->moduleName."_subform:currency_name", Array(I8242=>$tmp[I8239])); if(!is_numeric($tmp[I8245]) && !empty($tmp[I8245])) {$I1LL1Ll ="(".$tmp[I8245].I8247.$currencyRate/$ILl11ll; }else {$I1LL1Ll =doubleval($tmp[I8245]) *$currencyRate/$ILl11ll; }}elseif($this->oEshop->baseCurrency != I8215) {$Il111lI["currency_name"] =$this->cms->Gui->getAbs($this->moduleName."_subform:currency_name", Array(I8242=>$this->oEshop->baseCurrency)); }$lIIll1L[] =$I1LL1Ll; $lIIll11[] =$tmp[I8245]; if(!is_numeric($tmp[I8245])) {$Il111lI["price_expr"] =$tmp[I8245]; }$price =isset($this->itemData[I8245.$numPrice]) ?$this->itemData[I8245.$numPrice] :I8215; if(!isset($lIIlLII["price_vars"])){ $lIIlLII[I8248] =''; }if($price != I8215) {if(!$lIIllLI[$numPrice]) {$price *= $currencyRate/$ILl11ll; }$lIIlLII[I8248] .= "var price".$numPrice."=".$price.";\n"; $price =$this->oEshop->formatNumber($price, false, true); $Il111lI[I8249] =$price; }else {$Il111lI[I8249] =I8215; $lIIlLII[I8248] .= "var price".$numPrice."=0;\n"; }$Il111lI["checkbox_value"] =I8215; $Il111lI["text_disabled"] =I8215; if(is_numeric($tmp[I8245]) || empty($tmp[I8245])) {$Il111lI[I8250] ="disabled"; }else {if(!(isset($lIIllLI[$numPrice]) && $lIIllLI[$numPrice] == 0)) {$Il111lI["checkbox_value"] ="checked"; $Il111lI["text_disabled"] =I8251; }$Il111lI[I8250] =I8215; }$Il111lI["price_caption"] =$this->db->Record["price_caption".$numPrice]; if($tmp[I8239] != I8215) {$aCaptions[] =jparse($this->db->Record["price_caption".$numPrice]." (".$tmp[I8239].I8252); }else {$aCaptions[] =jparse($this->db->Record["price_caption".$numPrice]); }$lIIllLl .= $this->cms->Gui->get($this->moduleName."_subform:other_price_item", $Il111lI); }$lIIlLIl =Array(); foreach($lIIll1l as $code => $val) {$lIIlLIl[] ="'cur_".jparse($code)."':".$this->oEshop->getCurrencyRate($code); }$lIIlLII[I8253] =implode(",", $lIIlLIl); unset($lIIlLIl); $lIIlLII["expressions"] =I8210.implode("','", $lIIll11).I8210; $lIIlLII["expressions_ex"] =I8210.implode(I8254, $lIIll1L).I8210; $lIIlLII["num_prices"] =$this->oEshop->numPrices; if(isset($this->itemData[I8245]) && $this->itemData[I8245] != I8215) {$lIIlLII["price_value0"] =$this->itemData[I8245]; }else {$lIIlLII["price_value0"] =0; }$vData["other_prices_script"] =$this->cms->Gui->get($this->moduleName."_subform:prices_script", $lIIlLII); $vData["other_prices"] =$this->cms->Gui->getAbs($this->moduleName."_subform:other_prices", Array("price_items" => $lIIllLl, "price_expressions" => $lIIllL1, I8255 => $lIIll1I)); $vData["prices_on"] =I8210.implode(I8254, $this->oEshop->priceFields).I8210; if($this->cid >0) {$vData["captions_array"] =$this->cms->Gui->getAbs($this->moduleName."_subform:captions_array", Array(I8255 => I8210.implode(I8254, $aCaptions).I8210)); }}if($this->cid >0) {$vData["excelsheet_on"] =I8256; }else {$vData["excelsheet_on"] ="0"; }if(isset($this->itemData[I8245]) && $this->itemData[I8245] != I8215) {$this->itemData[I8245] =$this->oEshop->formatNumber($this->itemData[I8245], false, true); }$vData["hasPicturesTabs"] =false; $vData["pictures_top"] =false; $vData[I8257] =false; if($this->module->IssetOption("pictures_form_location")){ switch($this->module->GetOption("pictures_form_location")){ case 1: $vData["pictures_top"] =true; break; case 2: $vData[I8257] =true; break; case 3: $vData["hasPicturesTabs"] =true; break; }}if($this->module->IssetOption("pictures_form_location")) $vData["showNWRS"] =$this->module->GetOption("nwrs_form_location"); $vData["hasPriceTabs"] =false; if($this->module->IssetOption("base_price_form_location")){ $vData[I8258] =$this->module->GetOption("base_price_form_location"); if($vData[I8258] == 3) $vData["hasPriceTabs"] =true; }if($this->module->IssetOption("prices_form_location")){ $vData["showOtherPricesLoc"] =$this->module->GetOption("prices_form_location"); if($vData["showOtherPricesLoc"] == 3) $vData["hasPriceTabs"] =true; }if($this->module->IssetOption("taxes_form_location")){ $vData["showTaxesLoc"] =$this->module->GetOption("taxes_form_location"); if($vData["showTaxesLoc"] == 3) $vData["hasPriceTabs"] =true; }if($this->cms->Core->IsInstalled($this->oEshop->ownerName .'_discounts')){ $global_discount =I8215; $category_dependent_discount =I8215; $sql ="SELECT * FROM `" .$this->oEshop->dbTablePrefix .I8259 ."WHERE " ."`condition` = 'global' AND `lang` = '" .$this->langData ."' AND " ."NOW() BETWEEN `date_start` AND `date_end` AND `public` = 1"; $this->db->query($sql); if ($this->db->next_record()) {$global_discount =sprintf( $this->words[I8260], $this->db->Record[I8242], $this->db->Record["amount"] .($this->db->Record["type"] == I8235 ?"%" :" " .$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency) .$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency) ));}if ($this->action == I8261) {$categoryId =$this->itemData["id_category"]; $sql ="SELECT d.* FROM `" .$this->oEshop->dbTablePrefix ."_discounts` d " ."LEFT JOIN `" .$this->oEshop->dbTablePrefix ."_cats` c ON c.id_discount = d.id " ."WHERE " ."c.id = '" .$categoryId ."' AND NOW() BETWEEN d.date_start AND d.date_end AND d.public = 1"; $this->db->query($sql); if ($this->db->next_record()) {foreach ($this->I1LLllI as $row) {if ($row[I8221] == $categoryId) {$lIIlLIL =trim(str_replace("&nbsp;", I8262,$row[I8242])); break; }}if (isset($lIIlLIL)) {$discount =$this->db->Record["amount"] >0 ?($this->db->Record["amount"] .($this->db->Record["type"] == I8235 ?"%" :I8262 .$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency) .$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency))) :$this->words[I8263]; $category_dependent_discount =sprintf( $this->words["category_dependent_discount"], $lIIlLIL, $this->db->Record[I8242], $discount );}}}if ($global_discount || $category_dependent_discount) {$vData["products_discounts"] =$this->cms->Gui->getAbs($this->moduleName."_subform:products_discounts", array (I8260 => $global_discount, "category_dependent_discount" => $category_dependent_discount ));}}if ($this->_useShippingModule) {$I1LLLlL =array ();$mModule =&$this->cms->Core->GetModule($this->oEshop->ownerName .I8264); $vData["shipping_types_link"] =$I1LLLlL["shipping_types_link"] =$mModule->GetAdminLink(); $type =null; $shippingTypeId =isset($this->itemData["id_shipping_type"]) ?$this->itemData["id_shipping_type"] :($this->action == I8261 && isset($this->cms->Vars[I8265]) ?$this->cms->Vars[I8265] :0); $sql ="SELECT `id`, `name`, `hidden` " ."FROM `" .$this->oEshop->dbTablePrefix ."_shipping_types` " ."WHERE `id` = '" .$shippingTypeId .I8210; if ($shippingTypeId >0 && $this->db->query($sql) && $this->db->next_record()) {$I1LLLlL[I8265] =$shippingTypeId =$this->db->Record[I8221]; }else {$I1LLLlL[I8265] =$this->itemData[I8265] =$shippingTypeId =0; }$I1LLLll =array (I8266 => "`id`, `name`", "from" => "`" .$this->oEshop->dbTablePrefix ."_shipping_types`", I8267 => "`lang` = '" .$this->langData ."' AND `hidden` = 0", "order" => "`name`" );if ($shippingTypeId >0) {$I1LLLll[I8268] ="`id` = " .$shippingTypeId; }$aCustom =array ("ctrl_field_name" => I8265, "ctrl_field_value" => $shippingTypeId, "ctrl_field_name_select" => "id_shipping_type_select", "tpl_list_postfix" => "list_ctrl_shipping_type_list" );$I1LLLlL["shipping_type_ctrl"] =$this->TIIIT1I("show_shipping_types_in_admin", $I1LLLll, $aCustom +$I1LLLlL); $vData[I8269] =$this->cms->Gui->get($this->moduleName.I8270, $I1LLLlL); }else {$vData[I8269] =I8215; }$vData[I8271] ='100%'; }function TTTlllT(&$vData) {parent::TTTlllT($vData); $this->oEshop->tree->setCallbackMethod("filterChildBranch", "filterChildBranchCB"); $this->oEshop->tree->setCallbackMethod("buildTreeOnChildsArray", I8272); $this->cms->SetsTemplate =$this->moduleName."_list"; $this->oEshop->TITTIIl($vData, $this->cms->SetsTemplate); $this->oEshop->ILLllI1 =$this->oEshop->mEshop->GetOption("show_currency_signs"); $this->TIIlTI1(); if(AMI_Registry::get('page/catId') <0){ $this->lIII1IL =FALSE; }if(isset($this->cms->Vars['catid']) && ($this->cms->Vars[I8273] >0) && ($this->catId >0) && ($this->cms->Vars[I8273] != $this->catId)){ $this->SetBodyType('body_empty'); }$this->lIII1Ll =0; $I1LLLLI =$this->oEshop->mEshop->GetOption("path_settings_front"); $I1LLLLl =$this->oEshop->mEshop->GetOption('path_settings_front_strip_text'); $this->oEshop->tree->initResult(''); $this->lIIlILl =$this->oEshop->tree->getPath($this->catId, I8274, I8242, abs((int)$I1LLLLI[0]), abs((int)$I1LLLLI[1]), abs((int)$I1LLLLI[3]), abs((int)$I1LLLLI[2]), $I1LLLLl); }function TIIlTI1($catId =0) {if($this->lIII11I != $catId) {$aEvent =array( 'modId' => $this->moduleName, 'catId' => &$catId, 'oEngine' => $this );AMI_Event::fire('v5_on_before_init_eshop_current_cat', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); $this->lIII11I =$catId; if($catId >0) {$this->catId =$catId; }else {if($this->id >0) {$sql ="SELECT id_category FROM ".$this->oEshop->dbTablePrefix."_items WHERE id='".$this->id.I8210; $this->db->query($sql); $this->db->next_record(); $this->catId =intval($this->db->Record["id_category"]); }elseif($this->catId <= 0) {$this->catId =$this->oEshop->rootCatId; }}$this->lIII11L =$this->catId; $this->lIII1IL =true; $this->catSublink =I8215; $this->lIII1lL =I8215; $this->lIII1l1 =I8215; $this->lIII1LI =Array(); $this->lIII1I1 =Array(); $this->lIII1lI =Array(); $this->TTT11ll(); $this->cms->Gui->AddGlobalVars(Array("CURRENT_CAT_ID" => $this->catId)); $this->cms->Core->Cache->TT1TI1l("CURRENT_CAT_ID", $this->catId); $sql ="SELECT *, adv_place as cat_adv_place, has_props cat_has_props". $this->oEshop->getPriceFields("price_caption%d, SUBSTRING(price%d, INSTR(price%d, '#')+1, 3) AS currency%d, SUBSTRING(price%d, INSTR(price%d, ':')+1, 3) AS db_currency%d"). I8244.$this->oEshop->dbTablePrefix."_cats WHERE lang='".$this->langData."' AND id='".$this->catId."' AND public=1"; $this->db->query($sql); if(!$this->db->next_record()) {$this->lIII1IL =false; }else {$IL1ILLl =array(); $IIlLIIL =Array(I8275=>"set_dataset", I8221=>0, "item_data"=>&$this->db->Record, "custom"=>&$IL1ILLl); $this->TTT1lI1($IIlLIIL); $this->lIIlIIl =isset($IL1ILLl['prop_num']) && $IL1ILLl[I8276] >0; if(!$this->isSmallMode) {$this->TTIITTT($this->db->Record); $this->catSublink =$this->db->Record['sublink']; $this->lIII1ll =$this->db->Record['cat_has_props']; $this->lIII1lL =$this->db->Record['announce']; $this->lIII1l1 =$this->db->Record['description']; $navData[I8212] =$this->db->Record[I8221]; $navData[I8277] =$this->db->Record["sublink"]; $this->lIII11l =$this->cms->ApplyNav($navData); $this->lIII1LI =$this->db->Record; $this->TTTlll1($this->oEshop->ownerName."_cat"); if($this->TTT11ll()) $this->TTT111l($this->lIII1LI, "cat_adv", $this->lIII1LI[I8221], "details"); $this->TTTlll1($this->oEshop->ownerName.I8278); if(isset($this->db->Record["sm_data"])) {$IIl1IL1 =unserialize($this->db->Record["sm_data"]); $GLOBALS[I8279]["headers"] =$this->cms->TITlTl1($GLOBALS[I8279]["headers"], $IIl1IL1); }for($i=0;$i<$this->oEshop->numPrices;$i++) {$numPrice =$this->oEshop->priceFields[$i]; $this->lIII1I1[I8280.$numPrice] =$this->db->Record[I8280.$numPrice]; $this->lIII1lI[I8239.$numPrice] =$this->db->Record[I8239.$numPrice]; $this->lIII1lI["db_currency".$numPrice] =$this->db->Record["db_currency".$numPrice]; }}}if($this->filter->issetField(I8212)) {$this->filter->TITI1l1(I8212); }if($this->catId != $this->oEshop->rootCatId) {$this->filter->AddField(I8212, "hidden", $this->catId); }$aEvent =array( 'modId' => $this->moduleName, I8281 => &$this->catId, 'oEngine' => $this );AMI_Event::fire('v5_on_after_init_eshop_current_cat', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); }}function TTTlIT1(&$aCustom, $cType ='small', $IIlLI11 ='', $IIlLlII =I8282) {$this->lIIlIl1 =(mb_strpos($this->module->GetProperty("active_spec_blocks"), "spec_".$this->oEshop->ownerName."_cat") === 0) ?"cat" :I8283; if($this->lIIlIl1 == "cat") {$this->TTT11ll(); $this->lIIlILI =$this->cms->Core->getModOption($this->oEshop->ownerName .'_cat', 'show_urgent_elements'); $this->TTTlll1($this->oEshop->ownerName."_cat"); $this->TTTlTI1(); $this->lIIlIll =$this->lIIlIlL =explode(I8284, $this->module->GetOption("small_cols")); array_unshift($this->lIIlIll, 0); }else {$this->TTTlTI1(); }parent::TTTlIT1($aCustom, $cType, $IIlLI11, $IIlLlII); }function _getChildsIdCB(&$res, &$record, &$Il11L1l) {$aEvent =array( 'modId' => $this->moduleName, 'aResData' => &$res, 'aRecord' => &$record, I8285 => &$Il11L1l, 'oEngine' => $this );AMI_Event::fire('v5_on_before_get_eshop_path_childs_id', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); $res[] =$record[I8221]; $aEvent =array( 'modId' => $this->moduleName, 'aResData' => &$res, I8286 => &$record, I8285 => &$Il11L1l, 'oEngine' => $this );AMI_Event::fire('v5_on_after_get_eshop_path_childs_id', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); return true; }function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {if($this->lIIlIl1 == "cat") {$this->oEshop->tree->setCallbackObject($this); $this->TTITTTI('push'); $this->oEshop->ILLlllI =I8287; $aBranchItems =Array(); $lIIlLI1 =I8287; $lIIlLlI =$this->oEshop->mEshop->GetOption("spec_catname_len"); $lIIlLll =$this->TTT11ll(); $this->oEshop->tree->initResult(I8215); $lIIlLlL =$this->oEshop->tree->TI11lIl($this->catId, true); if($lIIlLlL != I8215) {$lIIlLlL =$aBranchItems =explode(",", $lIIlLlL); }if($this->oEshop->mEshop->issetAndTrueOption("show_current_subcats")) {$this->oEshop->tree->TI11lIT(); if(is_array($lIIlLlL)) {$lIIlLlL[] =$this->catId; }else {$lIIlLlL =Array($this->catId); }foreach($lIIlLlL as $catId) {if($catId != $this->oEshop->rootCatId) {$II11L1l =Array(); $this->oEshop->tree->initResult($II11L1l); $II11L1l =$this->oEshop->tree->getChildsFlt($catId); if(is_array($II11L1l)) {$aBranchItems =array_merge($aBranchItems, $II11L1l); }}}$this->oEshop->tree->TI11lT1(); }$this->oEshop->ILlLLLL->SetOption('page_sort_col', $this->oEshop->ILlLLLL->GetOption('front_page_sort_col')); $this->oEshop->ILlLLLL->SetOption('page_sort_dim', $this->oEshop->ILlLLLL->GetOption('front_page_sort_dim')); $this->oEshop->ILlLLLL->InitPager($this->cms->Pager); $lIIlLl1 =$this->oEshop->mEshop->GetOption("deep_level"); $this->oEshop->tree->TI11lTl(); $this->oEshop->tree->setCallbackMethod("filterChildBranch", "filterSpecChildBranchCB"); $this->oEshop->tree->setCallbackMethod("buildTreeOnChildsArray", "_getSpecSubCatsCB"); $aCatsNames =$this->TIIlIT1(0, ($lIIlLl1 >0)? (1 +$lIIlLl1): 0, $aBranchItems); $this->oEshop->tree->TI11lTI(); $this->cms->Gui->addBlock("small_cats", $this->oEshop->mEshop->GetOption("tree_template")); $lIIlLLI =$lIIlLLl =I8287; $level =-1; $lIIlLLL =sizeof($aCatsNames); $lIIlLL1 =$this->cms->Gui->getAbs("small_cats:level_filler"); $aTmp =array("simple_prefix"=>"item_"); $aBranchItems[] =0; $aStack =Array(); $lIIlL1I =Array("link"=>$GLOBALS["ROOT_PATH_WWW"]); $lIIlL1l =Array(); $lIIlL1L =$this->oEshop->mEshop->GetOption(I8288); for($i =$lIIlL1L ?0 :1; $i <$lIIlLLL; $i++) {$lIIlL1l[$aCatsNames[$i]['id']] =$aCatsNames[$i]['id_parent']; $aCatsNames[$i]['open_parent_branch'] =intval(in_array($aCatsNames[$i]["id_parent"], $aBranchItems)); $aCatsNames[$i][I8289] =intval(in_array($aCatsNames[$i][I8221], $aBranchItems)); $aCatsNames[$i]['name'] =$this->cms->stripLine($aCatsNames[$i]['name'], $lIIlLlI); $aCatsNames[$i]['has_subcats'] =($i +1) <$lIIlLLL ?$aCatsNames[$i +1]['id_parent'] == $aCatsNames[$i][I8290] :false; $aCatsNames[$i]['super_parent_id'] =intval($aCatsNames[$i]['id_parent'] >0 ?(isset($lIIlL1l[$aCatsNames[$i]['id_parent']]) ?$lIIlL1l[$aCatsNames[$i]['id_parent']] :0) :0).I8215; $aCatsNames[$i] += $lIIlL1I; foreach($this->lIIlIlL as $lIIlL11 => $lIIl1II){ $aCatsNames[$i][I8291 .($lIIlL11 +1)] =$lIIl1II; }$aCatsNames[$i]['_cols'] =isset($this->lIIlIlL[$aCatsNames[$i]['level'] -1]) ?$this->lIIlIlL[$aCatsNames[$i]['level'] -1] :null; if($lIIlLll) $this->TTT111l($aCatsNames[$i], "cat_adv", $aCatsNames[$i][I8221], I8292, "small_cats"); $aCatsNames[$i]['filler'] =I8287; $vNavData =Array(); $vNavData[I8212] =$aCatsNames[$i][I8290]; $vNavData[I8277] =$aCatsNames[$i]['sublink']; $aCatsNames[$i] += $this->cms->ApplyNav($vNavData); $IIlLIIL =Array(I8275=>"_GetPicturesCB", I8293=> $_data =array(&$aCatsNames[$i], &$aTmp)); $this->TTT1lI1($IIlLIIL, array('ext_images')); if(!empty($lIIlLL1)) {for($j =$aCatsNames[$i]['level']; $j >0; $j--) {$aCatsNames[$i]['filler'] .= $lIIlLL1; }}for($j =$level; $j >$aCatsNames[$i]['level']; $j--) {$index =array_pop($aStack); $lIIlLLI .= $this->cms->Gui->getDefPostf("small_cats:level_end", "_".$j, $aCatsNames[$index]); }if($aCatsNames[$i]['level'] >$level){ array_push($aStack, $i); $lIIlLLI .= $this->cms->Gui->getDefPostf("small_cats:level_start", "_".$aCatsNames[$i][I8294], $aCatsNames[$i]); }$lIIl1Il ='normal'; if($this->lIII11L == $aCatsNames[$i][I8290]) {$lIIl1Il ='selected'; }$aCatsNames[$i]['item'] =$this->cms->Gui->getDefPostf("small_cats:item_".$lIIl1Il, I8295.$aCatsNames[$i][I8294], $aCatsNames[$i]); if(!isset($this->lIIlIll[$aCatsNames[$i][I8294]]) || $this->lIIlIll[$aCatsNames[$i][I8294]] == 0) {$this->lIIlIll[$aCatsNames[$i][I8294]] =1; }$lIIl1IL =false; if($aCatsNames[$i][I8294] >$level) {$lIIl1I1[$aCatsNames[$i][I8294]] =0; $lIIl1IL =true; }else {$lIIl1I1[$aCatsNames[$i][I8294]]++; }if(!$lIIl1IL) {if(($lIIl1I1[$aCatsNames[$i][I8294]] %$this->lIIlIll[$aCatsNames[$i][I8294]]) == 0) {$lIIlLLI .= $this->cms->Gui->getDefPostf("small_cats:Vsplitter", I8295.$aCatsNames[$i][I8294], $aCatsNames[$i]); }else {$lIIlLLI .= $this->cms->Gui->getDefPostf("small_cats:Hsplitter", I8295.$aCatsNames[$i][I8294], $aCatsNames[$i]); }}$lIIlLLI .= $this->cms->Gui->get("small_cats:item", $aCatsNames[$i]); $level =$aCatsNames[$i][I8294]; }$border =$lIIlL1L ?-1 :0; for ($j =$level; $j >$border; $j--) {$index =array_pop($aStack); $lIIlLLI .= $this->cms->Gui->getDefPostf("small_cats:level_end", I8295.$j, $aCatsNames[$index]); }$aData =array(I8296 => $lIIlLLI); foreach($this->lIIlIlL as $level => $value){ $aData[I8291 .($level +1)] =$value; }$aData['_cols'] =$this->lIIlIlL[$level]; $vRes["body"] =$this->cms->Gui->getAbs("small_cats", $aData); $this->TTITTTI('pop'); }else {$lIIl1lI =$this->module->GetOption(I8297); $this->TTTlllI("_small", true); $lIIl1ll =isset($this->cms->Vars["flt_force_values"]) ?$this->cms->Vars["flt_force_values"] :0; $this->cms->Vars["flt_force_values"] =I8298; $lIIl1lL =$this->catId; $lIIl1l1 =$this->module->GetOption("small_filter_start_cat"); if(!$lIIl1l1) {$lIIl1l1 =$this->catId; }$this->TIIlTI1($lIIl1l1); $IIlLIIL =Array(I8275=>"set_dataset", I8221=>0, "item_data"=>&$this->db->Record, "custom"=>&$IL1ILLl); $this->TTT1lI1($IIlLIIL); $this->lIIlILL =$this->module->GetOption("small_filter_hide_fields"); $IIlLIIL =Array( I8275 => "set_exclude_filter_fields", I8221 => 0, "custom" => Array( "exclude_filter_fields" => &$this->lIIlILL ));$this->TTT1lI1($IIlLIIL, Array("ext_".$this->oEshop->ownerName.I8299)); $lIIl1LI =(mb_strpos($lIIl1lI, I8283) !== false); $lIIl1Ll =(mb_strpos($lIIl1lI, "search") !== false); if($lIIl1LI) {$this->TTTlII1("body_items"); }else {$this->TTTlII1("body_empty"); }if($lIIl1Ll) {$this->TTTlIlI("body_items"); }$this->lIIlILL =Array(); $this->cms->Vars[I8300] =$lIIl1ll; $this->filter->TITIllT($this->module->GetProperty("active_spec_blocks")); $this->filter->TITIllI($GLOBALS["ROOT_PATH_WWW"].$this->module->GetFrontLink()); $aData =Array(I8283 => I8215, "search" => I8215); $aData[I8283] =$this->filter->GetFilterHtml(true); $hash =I8287; foreach($this->cms->VarsGet as $k => $v){ $hash .= $k .'=' .$v .I8301; }$specName =$this->module->GetProperty('active_spec_blocks'); $this->cms->Core->Cache->TT1TI1l('eshop_small_filter', $hash, $specName); $this->cms->Core->Cache->TT1TI1T($specName .'_hash', $hash); $this->cms->Core->Cache->TT1Tl1l($specName); if($lIIl1LI){ $aData[I8283] =$this->cms->Gui->get($this->filter->blockBox.":body_small_filter", $aData); }if($lIIl1Ll) {$this->TTTlIlI(I8302); $aData["search"] =$this->filter->TITI11l(); $aData["search"] =$this->cms->Gui->get($this->filter->blockBox.":body_small_search", $aData); }if($lIIl1LI && $lIIl1Ll) {$aData["splitter"] =$this->cms->Gui->get($this->filter->blockBox.":body_small_splitter", $aData); }foreach($this->lIIlIlL as $level => $value){ $aData[I8291 .($level +1)] =$value; }$vRes["body"] =$this->cms->Gui->get($this->filter->blockBox.":body_small", $aData); $this->filter->TITIllT(); $this->catId =$lIIl1lL; }}function TTTlII1($IIlLlL1 =I8215){ parent::TTTlII1($IIlLlL1); if($IIlLlL1 != "body_itemD" && $this->module->GetOption("allow_subcat_search")){ $this->filter->AddField(I8303, "subcats_search", empty($this->cms->VarsGet[I8303]) ?null :$this->cms->VarsGet[I8303]); $this->filter->MoveField(I8303, _MOVE_PREV); }$this->TTTlIlT(); if($this->ILLIIIL) $this->filter->AddField("letter", "hidden", isset($this->cms->VarsPost["letter"]) ?$this->cms->VarsPost[I8304] :(isset($this->cms->VarsGet[I8304]) ?$this->cms->VarsGet[I8304] :I8215)); }function TTTlIIl($IIlLlLI, $IIlLlLl, $defaultValue) {if(mb_substr($IIlLlLI, 0, 17) == "PropGroupSplitter"){ $this->filter->addField($IIlLlLI, "static", "PropGroupSplitter"); }else if(mb_substr($IIlLlLI, 0, 14) == "PropBlockStart"){ $this->filter->addField($IIlLlLI, I8305, "PropBlockStart", intval(mb_substr($IIlLlLI, 14))); }else if(mb_substr($IIlLlLI, 0, 12) == "PropBlockEnd"){ $this->filter->addField($IIlLlLI, I8305, "PropBlockEnd", intval(mb_substr($IIlLlLI, 12))); }if(!in_array($IIlLlLI, $this->lIIlILL)) {switch($IIlLlLI) {case "item_name": $this->filter->AddField($IIlLlLI, I8306, $IIlLlLl, $defaultValue, "like", "i.name"); break; case "item_sku": $this->filter->AddField($IIlLlLI, I8306, $IIlLlLl, $defaultValue, "like", I8307); break; case "item_with_photo": $this->filter->AddField($IIlLlLI, "checkbox", $IIlLlLl, $defaultValue, "=", "(LENGTH(i.ext_picture)>0 OR LENGTH(i.ext_popup_picture)>0 OR LENGTH(i.ext_small_picture)>0)"); if(empty($IIlLlLl)) {$this->filter->DisableFieldSql($IIlLlLI); }break; case I8308: $this->filter->AddField($IIlLlLI, "checkbox", intval($IIlLlLl), $defaultValue, "=", "(i.rest>0)"); if(empty($IIlLlLl)) {$this->filter->DisableFieldSql($IIlLlLI); }break; case "item_with_discount": $this->filter->AddField($IIlLlLI, I8309, $IIlLlLl, $defaultValue, "=", "(i.discount>0)"); if(empty($IIlLlLl)) {$this->filter->DisableFieldSql($IIlLlLI); }break; default: $pos =mb_strpos($IIlLlLI, I8245); if($pos !== false) {$pos += 5; $I1lILI1 =mb_strpos($IIlLlLI, I8295, $pos); $numPrice =intval(mb_substr($IIlLlLI, $pos, $I1lILI1 -$pos)); if($numPrice == 0) {$numPrice =I8215; }if($this->oEshop->issetPrice($numPrice) || $numPrice == I8215) {$IL111Ll =I8215; if($IIlLlLl != I8215) {$IIlLlLl =str_replace(",", ".", $IIlLlLl); $IIlLlLl =doubleval($IIlLlLl); if(isset($this->cms->VarsGet[$lIIl1LL])) {$IL111Ll =$IIlLlLl; $IIlLlLl =$this->oEshop->convertCurrency($IIlLlLl, $this->cms->VarsGet[$lIIl1LL], $this->oEshop->baseCurrency); $defaultValue =$this->oEshop->convertCurrency($defaultValue, $this->cms->VarsGet[$lIIl1LL], $this->oEshop->baseCurrency); }}if(mb_substr($IIlLlLI, -4) == I8310) {$this->filter->AddField($IIlLlLI, I8306, $IIlLlLl, $defaultValue, ">=", "i.price".$numPrice); }elseif(mb_substr($IIlLlLI, -2) == "to") {$this->filter->AddField($IIlLlLI, I8306, $IIlLlLl, $defaultValue, "<=", I8311.$numPrice); }if($IL111Ll != I8215) {$this->filter->TITI1Il($IIlLlLI, $IL111Ll); }if($IIlLlLl == I8215) {$this->filter->DisableFieldSQL($IIlLlLI); }}}parent::TTTlIIl($IIlLlLI, $IIlLlLl, $defaultValue); }}}function TTTllTI(&$aCustom) {if($this->IIlllI1) {$this->SetBodyType("body_search"); }else {if($this->lIII1IL) {if($this->id >0) {$this->SetBodyType("body_itemD"); }elseif($this->id != -1){ $this->SetBodyType(I8302); $this->SetBodyType('body_urgent_items'); }if($this->id != -1){ $this->SetBodyType('body_urgent_cats'); $this->SetBodyType(I8312); }}}parent::TTTllTI($aCustom); }function TTTll1T(&$vData, &$aCustom) {$this->TTT11ll(); $this->cms->Gui->AddGlobalVars(array("ID_CATEGORY" => $this->catId)); $lIIl1L1 =I8215; $lIIl11I =I8215; $lIIl11l =I8215; foreach($this->IIllIL1 as $IIlL1L1 => $tmp) {$aCustom['pager_navdata'] =$this->lIII11l['nav_data']; $IIlL1Ll =$this->TTITTT1($aCustom, $IIlL1L1, false); $Il11I1l =$vData; $aDefault =Array(); $IIlL1Ll['page_item_type'] =$IIlL1L1; $addSql =Array(I8266=>I8215, I8310=>I8215, I8313=>I8215, I8267=>I8215, "group"=>I8215, "order"=>I8215); $lIIILLl =$IIlL1Ll; $IIlLIIL =Array(I8275=>"add_extention_sql", I8221=>$this->catId, "item_data"=>I8215, I8293=>&$addSql, I8314=>&$lIIILLl); $this->TTT1lI1($IIlLIIL); $this->I1IL1Ll["extData"] =$lIIILLl; unset($lIIILLl); $this->oEshop->ILLlllI =$IIlL1L1; if ($this->cms->Core->IsInstalled('ext_rating')) {$lIIILl1 ="i.rate_opt,i.votes_rate,i.votes_count,i.votes_weight,"; }switch($IIlL1L1) {case "body_itemD": $aDefault[I8315] ='itemD_detail'; $aDefault['item'] ='item_detail'; $aDefault['item_set_empty'] =I8316; $aDefault['simple_set_fields'] =Array("fdate", I8242, "announce", "special_announce", I8317, "sku"); $aDefault['list_data']['simple_prefix'] ="itemD_"; $aDefault[I8318] ="SELECT i.id,i.name,i.announce,i.special_announce,i.description,i.rest,i.weight,i.size,i.price AS price0,i.tax,i.tax_type,i.tax_class_type, i.id_tax_class,i.show_all_props,i.adv_place,i.id_owner,".$lIIILl1. "date_format(i.date,'".$this->cms->DFMT["db"]."') as fdate". $this->oEshop->getPriceFields("i.price%d, SUBSTRING(c.price%d, INSTR(c.price%d, '#')+1, 3) AS currency%d, SUBSTRING(c.price%d, INSTR(c.price%d, ':')+1, 3) AS db_currency%d"). ", i.charge_tax_type,i.on_special,i.ext_picture,i.ext_popup_picture, i.sku, i.discount,i.discount_type, i.item_type, i.num_files, ". "i.files_size, i.sublink, i.sm_data, i.details_noindex, i.id_category, c.name AS category_name, c.sublink as cat_sublink, c.id_discount, c.dataset_id, c.adv_campaign_type, i.id_source, i.disable_comments ".$addSql[I8266]. I8244.$this->oEshop->dbTablePrefix."_items i INNER JOIN ".$this->oEshop->dbTablePrefix."_cats c ON i.id_category = c.id WHERE i.id = '".$this->id.I8210 .$this->_ApplyFilters().I8319.$this->oEshop->TITTIII("i"); $IIlL1Ll += $aDefault; $sql =$IIlL1Ll["sql"]; $this->db->query($sql); if($this->lIIlI1I && $this->db->numRows()){ $this->db->nextRecord(); if($this->db->Record['id_source']){ $this->TTTllT1(); $this->lIIlI1L =$this->db->Record['id_source']; $db2 =new DB_si; $db2->query('select i.sublink as sublink, c.sublink as cat_sublink from ' .$this->oEshop->dbTablePrefix .'_items i INNER JOIN ' .$this->oEshop->dbTablePrefix .'_cats c ON i.id_category = c.id WHERE i.id = ' .$this->lIIlI1L); if($db2->numRows()) {$db2->nextRecord(); AMI_Registry::set( 'page/links/canonical', $GLOBALS["ROOT_PATH_WWW"] .$this->cms->ActiveScript .I8320 .$db2->Record['cat_sublink'] .I8320 .$db2->Record['sublink'] );}}$this->db->seek(); }$Il11I1l[I8212] =$Il11I1l["cat_id"] =$this->catId; $Il11I1l["cat_sublink"] =$this->catSublink; parent::TTTll1T($Il11I1l, $IIlL1Ll); $lIIl1L1 =$Il11I1l[I8321]; $vData += $Il11I1l; $userId =$this->cms->Core->GetUserId(); if( AMI::editModeEnabled() && !$this->cms->Core->IsModerator($this->moduleName, $userId) && $userId != $vData['id_owner'] ){AMI_Registry::set('ami/editMode/discardEditingDetails', TRUE); }AMI_Registry::set('page/itemHeader', isset($vData['name']) ?$vData[I8322] :I8287); AMI_Registry::set('page/catHeader', isset($vData['category_name']) ?$vData['category_name'] :I8287); if(AMI::editModeEnabled()){ if(AMI::checkAccessRights('eshop_item', $vData[I8323], array('edit'))){ AMI_Registry::get('oGUI')->addHtmlScript(I8324 .AMI_Lib_String::jParse($vData[I8322]) .'";'); }}break; case I8302: case 'body_urgent_items': case I8325: if( isset($this->cms->I1IlIlI[$this->options['catid_varname']]) && $this->action == 'rsrtme' ){unset($this->cms->I1IlIlI[$this->options['catid_varname']]); }if($this->bodyType == 'body_itemD'){ if(isset($this->I1IL1Ll[I8326])){ $IIlL1Ll['pager_navdata'] =$this->I1IL1Ll["itemD_nav_data"]; }if($IIlL1L1 == I8325){ $IIlL1Ll['pager_navdata'] .= 'mode=browse&'; }}$this->TTTlll1($this->oEshop->ownerName.I8278); switch($IIlL1L1){ case I8327: $IIlL1Ll['row_set'] ='urgent_item_row'; $IIlL1Ll['list_data']['simple_prefix'] =I8328; $setPrefix ='urgent_item'; break; case 'body_items': $IIlL1Ll['row_set'] ='item_row'; $IIlL1Ll[I8329]['simple_prefix'] ='item_'; $setPrefix ='item'; break; case I8325: $IIlL1Ll['row_set'] =I8330; $IIlL1Ll[I8329]['simple_prefix'] ='browse_item_'; $setPrefix ='browse_item'; $this->browser->TI1TT11('_browse_' .$this->moduleName); break; }$lIIl11L =$this->module->IssetOption("show_all_subitems_level") ?$this->module->GetOption("show_all_subitems_level") :0; $lIIl111 ="i.id_category = '".$this->catId.I8210; if($lIIl11L >0 && $this->lIII1Ll >= $lIIl11L) {$sql ="SELECT `id`, `sublink`, `has_props` `cat_has_props`, `id_discount`, `dataset_id` FROM " .$this->oEshop->dbTablePrefix ."_cats WHERE `all_parents` LIKE '%,".$this->catId.",%' AND `public` = 1"; $rs =$this->db->select($sql); if($rs->numRows() >0){ $this->lIIllII =array( $this->catId => array( 'sublink' => $this->catSublink, 'cat_has_props' => $this->lIII1ll ));$IIlL1Ll[I8329]['noindex_list'] =true; while($rs->nextRecord()){ $this->lIIllII[$rs->Record[I8290]] =$rs->Record; }$lIIl111 ="i.id_category IN('".implode(I8254, array_keys($this->lIIllII)).I8331; }}$IIlL1Ll["list_data"]["item_catname"] =$this->cms->TTITI1l($setPrefix, "catname", Array("catname" => $this->lIII1LI[I8242])); $aDefault[I8318][I8332] ="i.id,i.name,i.announce,i.special_announce,i.description,i.rest,i.weight,i.size,i.price,i.price AS price0".$this->oEshop->getPriceFields("i.price%d"). ", i.tax,i.tax_type,i.charge_tax_type,i.tax_class_type, i.id_tax_class,i.on_special,i.ext_picture,i.ext_popup_picture, i.sku, ". "i.date,date_format(i.date,'".$this->cms->DFMT[I8333]."') as fdate, i.id_source, ". "i.discount,i.discount_type, i.sublink, (LENGTH(i.description) = 0) AS descr_empty, i.item_type, ". "i.num_files, i.files_size, i.adv_place, i.id_owner, ".$lIIILl1." '".$this->lIII1LI[I8334]."' as adv_campaign_type, i.disable_comments, i.id_category "; $aDefault[I8318]['from'] ="FROM ".$this->oEshop->dbTablePrefix."_items i "; $aDefault[I8318][I8335] ="WHERE ".$lIIl111.I8262.$this->TIIlIIl().$this->_ApplyFilters(I8287, $IIlL1L1 == I8327 ?$IIlL1L1 :I8287).$this->oEshop->TITTIII("i").$this->TTTlIl1(); $aDefault['list_set_empty'] =$IIlL1L1 == 'body_items' ?I8336 :I8287; if(isset($IIlL1Ll[I8318]) && is_array($IIlL1Ll[I8318])) {$IIlL1Ll[I8318] += $aDefault[I8318]; }$IIlL1Ll += $aDefault; $this->TTTllll($Il11I1l, $IIlL1Ll); $IIlL1Ll[I8318][I8332] .= $addSql[I8266]; $this->browser->InitSQL($IIlL1Ll[I8318][I8332],$IIlL1Ll[I8318]['from'],$IIlL1Ll[I8318][I8335], I8215, I8242); $IIlL1Ll[I8332]['item'] =Array('action'=>'callback', I8337=>&$this, 'method'=>'_getItemCB'); $this->I1IL1Ll["CurPageType"] =$IIlL1Ll['page_item_type']; $this->I1IL1Ll[I8338] =$this->catId; $this->I1IL1Ll["parentCatSublink"] =$this->catSublink; $this->I1IL1Ll[I8212] =$this->catId; $this->I1IL1Ll["catSublink"] =$this->catSublink; $this->I1IL1Ll['catHasProps'] =$this->lIII1ll; $this->I1IL1Ll["aPriceCaptions"] =$this->lIII1I1; $this->I1IL1Ll[I8339] ="&offset=".$this->offset."&catoffset=".$this->catOffset; $this->oEshop->ILlL1l1["item_list"] =$this->I1IL1Ll; $this->IIllILI =$this->oEshop->mEshop->GetOption("splitter_period"); $IIlL1Ll[I8329][I8340] =$this->lIII1lI; $IIlL1Ll["list_data"]["other_prices_captions"] =I8215; if($this->oEshop->numPrices >0) {$lIII1I1["num_prices"] =$this->oEshop->numPrices; for($i=0;$i<$this->oEshop->numPrices;$i++) {$numPrice =$this->oEshop->priceFields[$i]; $lIII1I1["num_prices"] =$numPrice; $lIII1I1[I8280] =$this->lIII1I1[I8280.$numPrice]; $lIII1I1[I8341] =$this->oEshop->getCurrencyName($this->lIII1lI[I8239.$numPrice]); $IIlL1Ll["list_data"]["other_prices_captions"] .= $this->cms->Gui->get($this->moduleName."_list:".$IIlL1Ll[I8329]['simple_prefix']."other_price_caption", $lIII1I1); }unset($lIII1I1); }if($this->lIIlIIl){ $this->oEshop->TITTT11(); }parent::TTTll1T($Il11I1l, $IIlL1Ll); $this->lIIllII =array(); if($this->lIIlIIl){ $this->oEshop->TITTITT(); }$lIIl11I =$Il11I1l["item_list"]; $vData += $Il11I1l; unset($this->oEshop->ILlL1l1["item_list"]); break; case I8312: case 'body_urgent_cats': $this->TTTlll1($this->oEshop->ownerName."_cat"); $IIlL1Ll['show_urgent_elements'] =$this->lIIlILI; $lIILIII =$IIlL1L1; $I1lIL1L =$IIlL1L1 == 'body_urgent_cats' ?'urgent_' :I8287; $IIlL1Ll['row_set'] =$I1lIL1L ."catD_row"; $IIlL1Ll[I8342] =$I1lIL1L ."catD_detail"; $IIlL1Ll[I8329]['splitter_prefix'] =$I1lIL1L ."catD_"; $IIlL1Ll[I8329]['nsplitter_prefix'] =$I1lIL1L .I8343; $IIlL1Ll[I8197] =$this->oEshop->ownerName .'_cat'; $IIlL1Ll += $aDefault; if($this->lIIlILl != I8215) {$vData["cat_path"] =$this->lIIlILl; }$Il11I1l =$vData; $this->IIllILI =$this->oEshop->ILlLLLL->GetOption("splitter_period"); $aTmp["simple_prefix"] =$I1lIL1L .I8343; $IIlL1Ll[I8329] += $this->lIII1LI; unset($IIlL1Ll[I8329]["count_public_childs"]); if($this->oEshop->itemCountersEnable) {$IIlL1Ll[I8329]["count_items"] =$this->cms->TTITI1l($I1lIL1L ."catD", "count_items", $this->lIII1LI["count_public_childs"]); }$IIlLIIL =Array(I8275=>I8344, I8293=> $_data =array(&$IIlL1Ll[I8329], &$aTmp)); $this->TTT1lI1($IIlLIIL, array('ext_images')); $IIlL1Ll['list_set_not_found'] =$IIlL1Ll['list_set_empty'] =($IIlL1L1 == 'body_urgent_cats' ?I8287 :$I1lIL1L .I8345); $IIlL1Ll[I8329]['announce'] =$this->cms->TTITI1l($I1lIL1L ."catD", "announce", $this->lIII1lL); $IIlL1Ll[I8329]['description'] =$this->cms->TTITI1l($I1lIL1L .I8346, I8317, $this->lIII1l1); $procData =array("cat_adv_place" => $IIlL1Ll[I8329]['cat_adv_place']); $this->_getCatAdvPlaceCB($procData, $procData, "details"); $IIlL1Ll[I8329]['cat_adv_place'] =empty($procData[I8347]) ?null :$procData[I8347]; if (!isset($I1LIlLI)) {$I1LIlLI =$this->browser->TI1TTlT(I8287, 'i'); }$this->oEshop->mEshop->PushPager($this->browser); if($this->oEshop->ILlLLLL->IssetOption('front_page_sort_col')) {$this->oEshop->ILlLLLL->SetOption('page_sort_col', $this->oEshop->ILlLLLL->GetOption('front_page_sort_col')); }if($this->oEshop->ILlLLLL->IssetOption('front_page_sort_dim')) {$this->oEshop->ILlLLLL->SetOption('page_sort_dim', $this->oEshop->ILlLLLL->GetOption('front_page_sort_dim')); }$this->oEshop->ILlLLLL->InitPager($this->browser); $this->browser->InitPager($this->catOffset, $this->oEshop->ILlLLLL->GetOption("page_size")); $IIL1I11 =false; if ($this->options['use_special_list_view'] && $IIlL1L1 == I8348) {$aShowAt =$this->module->GetAOption('show_urgent_elements'); $IIL1I11 =$this->browser->getActivePage() ?!in_array('at_next_pages', $aShowAt) :!in_array('at_first_page', $aShowAt); }$this->TTITTTI('push'); $lIILIIl =I8215; if($this->lIIlII1 >0) {$lIILIIl .= I8349; }$this->browser->InitSQL("c.*, c.id, c.name, c.announce, c.description, c.sublink, c.count_public_childs, c.dataset_id, c.dataset_data, c.special_flag, c.adv_place as cat_adv_place, c.adv_campaign_type, c.id_discount".$lIILIIl. $this->oEshop->getPriceFields("c.price_caption%d, SUBSTRING(c.price%d, INSTR(c.price%d, '#')+1, 3) AS currency%d, SUBSTRING(c.price%d, INSTR(c.price%d, ':')+1, 3) AS db_currency%d"), "FROM ".$this->oEshop->dbTablePrefix."_cats AS c", I8350 .($IIL1I11 ?0 :"1 ".$this->_ApplyFilters('c', $IIlL1L1 == I8348 ?$IIlL1L1 :I8287)." and c.id_parent='".$this->catId.I8210), I8215, I8242 );if ($this->options['use_special_list_view'] && $IIlL1L1 == I8348) {$this->browser->lll1IIl =0; $this->browser->Position =0; $this->browser->PageSize =0; $IIlL1Ll['reset_pager_for_urgent_cats'] =true; }$this->browser->ProcessSQL($this->db); $this->TTITTTI('pop'); $numRows =$this->db->num_rows(); if($numRows>0) {$lIILIIL[$I1lIL1L ."catD_list_pager"] =I8287; if($this->lIII1LL) {$lIIlLI1 =", announce"; }$lIILII1 =$this->oEshop->mEshop->GetOption("max_level_subcategories"); if($lIILII1 <0) {$lIILIlI =-1; $lIILII1--; }else {$lIILIlI =1; }$lIILIll =($this->lIII1Il >-1 && ($lIILII1 >=$this->lIII1Ll*$lIILIlI || $lIILII1 == 0)); if($this->lIII1II >-1 || $lIILIll) {$catIds =Array(); $lIILIlL =Array(); $ILl1LIL =array ();while($this->db->next_record()) {$catIds[] =$this->db->Record[I8221]; $lIILIlL[$this->db->Record[I8221]] =$this->db->Record[I8351]; $ILl1LIL[] =$this->db->Record["id_discount"]; for($i=0;$i<$this->oEshop->numPrices;$i++) {$lIII1lI[I8239.$this->oEshop->priceFields[$i]] =$this->db->Record[I8239.$this->oEshop->priceFields[$i]]; }}$this->db->seek(); }if($this->lIII1II >-1) {$db2 =new DB_si; $aItems =Array(); if(sizeof($catIds) >0) {if($this->lIII1II >0) {$lIILIl1 ="SELECT i.id,i.name,i.announce,i.special_announce,i.description,i.rest,i.weight,i.size,i.price AS price0, i.adv_place, i.id_owner". $this->oEshop->getPriceFields("price%d").", i.tax, i.tax_type, i.charge_tax_type,i.tax_class_type, i.id_tax_class, i.on_special, i.sku, ". "date_format(i.date,'".$this->cms->DFMT[I8333]."') as fdate, i.id_source, ". "i.ext_small_picture, i.ext_picture, i.ext_popup_picture, i.item_type, i.num_files, i.files_size, i.discount, ". "i.discount_type, i.sublink, (LENGTH(i.description) = 0) AS descr_empty, i.id_category, ID_DISCOUNT id_discount, i.urgent". $addSql[I8266].I8244.$this->oEshop->dbTablePrefix."_items i WHERE i.id_category='"; $lIILILI =I8352.$this->_ApplyFilters(I8287, $IIlL1L1, false). $this->oEshop->TITTIII("i").$this->TTTlIl1()." ORDER BY i.urgent DESC, ".$I1LIlLI." LIMIT ".$this->lIII1II; foreach($catIds as $index => $val) {$db2->query(str_replace("ID_DISCOUNT", $ILl1LIL[$index], $lIILIl1.$val.$lIILILI)); $this->TIIlITl($db2, $aItems, $lIILIlL); }}else {$I1LIlLI ="i.id_category asc, ".$I1LIlLI; $sql ="SELECT i.id, i.name, i.announce, i.special_announce, i.description,i.rest,i.weight,i.size, i.price AS price0, i.adv_place, i.id_owner". $this->oEshop->getPriceFields("price%d").", i.tax,i.tax_type, i.charge_tax_type,i.tax_class_type, i.id_tax_class, i.on_special, i.ext_small_picture, i.ext_picture, ". "date_format(i.date,'".$this->cms->DFMT[I8333]."') as fdate, i.id_source, ". "i.ext_popup_picture, i.sku, i.item_type, i.num_files, i.files_size, i.discount, i.discount_type, i.sublink, ". "(LENGTH(i.description) = 0) AS descr_empty, i.id_category, i.urgent".$addSql[I8266]. I8244.$this->oEshop->dbTablePrefix."_items i WHERE i.id_category IN(".implode(",", $catIds).I8353.$this->_ApplyFilters(I8287, $IIlL1L1, false).$this->oEshop->TITTIII("i").$this->TTTlIl1()." ORDER BY ".$I1LIlLI; $db2->query($sql); $this->TIIlITl($db2, $aItems, $lIILIlL); }}$IIlL1Ll["list_data"]["aItems"] =$aItems; }$IIlL1Ll[I8332][I8354] =Array('action'=>'callback', I8337=>&$this, 'method'=>'_getCategoryRowCB'); if($this->lIII1II >-1) {$IIlL1Ll[I8332][I8355] =Array('action'=>'callback', I8337=>&$this, 'method'=>'_getCategoryItemsRowCB'); if($this->lIII1II == 0) {$this->I1IL1Ll[I8356] =array(); foreach($catIds as $key => $value) {$this->I1IL1Ll[I8356][$value] =$ILl1LIL[$key]; }}$this->I1IL1Ll["CurPageType"] =$lIILIII; $this->I1IL1Ll[I8338] =$this->catId; $this->I1IL1Ll["parentCatSublink"] =$this->catSublink; $this->I1IL1Ll["splitterPeriod"] =$this->oEshop->mEshop->GetOption("sub_splitter_period"); $this->I1IL1Ll[I8357] =intval($this->oEshop->mEshop->GetOption("sub_items_cols")); if($this->I1IL1Ll[I8357] <1) {$this->I1IL1Ll[I8357] =1; }$this->I1IL1Ll[I8339] ="&offset=".$this->offset."&catoffset=".$this->catOffset; }$this->I1IL1Ll["aSubCatsNames"] =Array(); if($lIILIll) {$num =sizeof($catIds); if($num >0) {for($i=0;$i<$num;$i++) {$this->I1IL1Ll[I8358][$catIds[$i]] =$this->TIIlIT1($catIds[$i], $this->lIII1Il); }$IIlL1Ll[I8332]['subcats'] =Array('action'=>'callback', I8337=>&$this, 'method'=>'_getSubCategoryRowCB'); }}}else {}$this->oEshop->mEshop->PushPager($this->browser); if($this->oEshop->ILlLLLL->IssetOption('front_page_sort_col')) {$this->oEshop->ILlLLLL->SetOption('page_sort_col', $this->oEshop->ILlLLLL->GetOption('front_page_sort_col')); }if($this->oEshop->ILlLLLL->IssetOption('front_page_sort_dim')) {$this->oEshop->ILlLLLL->SetOption(I8359, $this->oEshop->ILlLLLL->GetOption('front_page_sort_dim')); }$this->oEshop->ILlLLLL->InitPager($this->browser); $this->browser->InitPager($this->catOffset, $this->oEshop->ILlLLLL->GetOption("page_size")); $Il11I1l["cat_level_abs"] =$this->lIII1Ll; $IIlL1Ll["list_data"][I8360] =$this->lIII1Ll; if(isset($this->ext["ext_".$this->oEshop->ownerName.I8299]) && $this->cms->Core->IsInstalled("ext_".$this->oEshop->ownerName.I8299)){ $IIlLIIL =Array(I8275=>"get_cat_custom_fields", I8221=>$this->catId, "item_data"=>&$vData, I8293=>&$Il11I1l, I8314=>&$IIlL1Ll); $this->ext[I8361.$this->oEshop->ownerName.I8299]->TTT1lI1($IIlLIIL); }parent::TTTll1T($Il11I1l, $IIlL1Ll); unset($IIlL1Ll['reset_pager_for_urgent_cats']); $vData += $Il11I1l; if(!AMI_Registry::exists('page/catHeader')){ AMI_Registry::set('page/catHeader', isset($vData['item_catname']) ?$vData[I8362] :I8287); }if(!empty($Il11I1l[$I1lIL1L .'catD_detail'])){ $lIIl11l .= $Il11I1l[$I1lIL1L .'catD_detail']; }$this->oEshop->mEshop->PopPager($this->browser); break; case "body_search": if (!$this->module->issetAndTrueOption('protect_seacrh') || isset($this->cms->Vars[I8363])) {$IIlL1Ll += $aDefault; $catID =intval($this->catId); $lIILILl =($this->cms->VarsGet[I8303] == I8256 && $catID >0 ?" AND (c.id=".$catID." OR c.all_parents like '%,".$catID.",%') AND i.id_source=0 " :I8215); $this->TTTllll($Il11I1l, $IIlL1Ll); $lIILILL ="i.id,i.name, i.sku, i.on_special, i.announce,i.special_announce,i.rest,i.weight,i.size, i.sublink, (LENGTH(i.description) = 0) AS descr_empty, i.item_type, i.ext_picture, ". "i.num_files, i.files_size ". $this->oEshop->getPriceFields("c.price_caption%d, SUBSTRING(c.price%d, INSTR(c.price%d, '#')+1, 3) AS currency%d, i.price%d, SUBSTRING(c.price%d, INSTR(c.price%d, ':')+1, 3) AS db_currency%d"). ", i.price as price0, i.tax,i.tax_type, i.charge_tax_type, i.tax_class_type, i.id_tax_class, i.discount, i.discount_type, c.name as catname, c.id AS cat_id, c.sublink AS cat_sublink, i.adv_place, c.adv_place as cat_adv_place, c.id_discount, c.dataset_id, c.dataset_data, " ."c.has_props cat_has_props, i.id_owner, ". "date_format(i.date,'".$this->cms->DFMT[I8333].I8364; $cSQLFields =$lIILILL .$addSql['select']; $cSQLFrom ="FROM ".$this->oEshop->dbTablePrefix."_items i INNER JOIN ".$this->oEshop->dbTablePrefix."_cats c ON c.id=i.id_category"; $cSQLFilter =I8350 .I8365 .$this->_ApplyFilters(I8287, I8287, false).$lIILILl.$this->oEshop->TITTIII("i").$this->TTTlIl1().$this->TIIlIIl(); $cGroupBy =I8287; $cOrderField =I8322; $cOrderAddOn =I8287; $cOrderReplace =array("price0" => I8311, "descr_empty" => "(LENGTH(i.description) = 0)", I8366 => "c.name", "cat_id" => "c.id", "cat_sublink" => I8367, I8347 => "c.adv_place"); $aEvent =array( 'mod_id' => $this->moduleName, 'sql_fields' => &$cSQLFields, 'sql_from' => &$cSQLFrom, I8368 => &$cSQLFilter, 'sql_group_by' => &$cGroupBy, 'sql_order_by' => &$cOrderField, 'sql_order_addon' => &$cOrderAddOn, 'sql_order_replace' => &$cOrderReplace, I8369 => $this );AMI_Event::fire('deprecated_v5_on_body_search', $aEvent, AMI_Event::MOD_ANY); AMI_Event::fire('v5_on_eshop_search_query', $aEvent, AMI_Event::MOD_ANY); $this->browser->InitSQL($cSQLFields, $cSQLFrom, $cSQLFilter, $cGroupBy, $cOrderField, $cOrderAddOn, $cOrderReplace); $this->browser->AddSQLJoinedTables($this->cms->Core, 'i', Array('c'=>$this->oEshop->dbTablePrefix.I8370)); $IIlL1Ll['simple_set_fields'] =Array("fdate", I8242, "announce", "special_announce", I8371, I8366); $IIlL1Ll[I8332][I8354] =Array('action'=>'callback', I8337=>&$this, 'method'=>'_getItemSearchCB'); $this->I1IL1Ll[I8372] =$IIlL1Ll['page_item_type']; $this->I1IL1Ll[I8338] =$this->catId; $this->I1IL1Ll["parentCatSublink"] =$this->catSublink; $this->I1IL1Ll['catHasProp'] =$this->catHasProp; $this->I1IL1Ll["aPriceCaptions"] =$this->lIII1I1; $this->I1IL1Ll[I8339] =I8373.$this->offset."&catoffset=".$this->catOffset; $IIlLIIl ='ext_' .$this->oEshop->ownerName .'_custom_fields'; if(isset($this->ext[$IIlLIIl]) && $this->cms->Core->IsInstalled($IIlLIIl) && $this->catId){ $lIILIL1 =$this->ext[$IIlLIIl]; $aProductIds =array(); $aDatasets =array(); $sql =$this->browser->TI1TIlT($this->db, 'SQL_CALC_FOUND_ROWS c.dataset_id, c.dataset_data, i.id'); $rs =$this->db->select($sql); if($rs->numRows()){ $sql ="SELECT FOUND_ROWS()"; $this->browser->setMaxCount($this->db->getValue($sql)); while($aRow =$rs->nextRecord(MYSQL_NUM)){ $aProductIds[] =$aRow[2]; if(empty($aDatasets[$aRow[0]])){ unset($aRow[2]); $aDatasets[$aRow[0]] =$aRow; $IIlLIIL =Array(I8275=>"add_extention_sql", I8221=>$this->catId, "item_data"=>I8215, I8293=>&$addSql, I8314=>&$lIIILLl); $this->TTT1lI1($IIlLIIL); }}$lIILIL1->TITT11T($aDatasets); $lIIILLl =$IIlL1Ll; $IIlLIIL =array(I8275 => "add_extention_sql", I8221 => $this->catId, "item_data" => I8215, I8293 => &$addSql, I8314 => &$lIIILLl); $this->TTT1lI1($IIlLIIL); $this->browser->SQLData[I8374] =$lIILILL .$addSql['select']; $this->browser->SQLData['sql_filter'] ='WHERE i.id IN(' .implode(',', $aProductIds) .I8375; $this->browser->SetForceRules(I8287, ' '); unset($aDatasets, $lIILILL, $aProductIds, $lIIILLl, $IIlLIIL); }$lIILI1I =array(); $sql ="SELECT * FROM ".$this->oEshop->dbTablePrefix."_cats WHERE id = '".$this->catId."' OR `all_parents` LIKE '%," .$this->catId .",%' ORDER BY (`id` = " .$this->catId .") DESC"; $rs =$this->db->select($sql); if($record =$rs->nextRecord()){ $lIILI1I =$record; while($record =$rs->nextRecord()){ $IIlLIIL =array(I8275 => "get_cat_custom_fields", I8221 => $this->catId, "item_data" => &$lIILI1I, I8293 => &$Il11I1l, I8314 => &$IIlL1Ll); $lIILIL1->TTT1lI1($IIlLIIL); }}}parent::TTTll1T($Il11I1l, $IIlL1Ll); $lIILI1l =$Il11I1l["search_item_list"]; $vData += $Il11I1l; }else {$this->cms->AddMessages($this->cms->Gui->ParseLangFile('templates/lang/_filter_msgs.lng')); $this->cms->AddStatusMsg('enable_javascript', 'red'); }break; default: parent::TTTll1T($Il11I1l, $IIlL1Ll); }}if($this->ILLIIIL && $this->lIII111->IssetAndTrueOption("show_letters")) {$vData["letters"] =$this->lIIlIII->TIIlllT($this->filter->GetFieldValue(I8304)); }$vData[I8321] =$lIIl1L1; $vData[I8376] =$lIIl11I; $vData["catD_detail"] =$lIIl11l; $vData["search_item_list"] =empty($lIILI1l) ?I8287 :$lIILI1l; $this->browser->TI1TT11(I8287); }function TTT1I1l() {return $this->IIllILI; }function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT i.*, DATE_FORMAT(i.date,'".$this->cms->DFMT[I8333]."') AS fdate, IF(i.public > 0, 'checked', '') AS public FROM ".$this->oEshop->dbTablePrefix."_items i WHERE i.id='".$cId.I8210; $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData["announce"] =$this->cms->htmlchars($this->itemData["announce"]); $this->itemData["special_announce"] =$this->cms->htmlchars($this->itemData["special_announce"]); $this->itemData[I8317] =$this->cms->htmlchars($this->itemData[I8317]); if($this->db->Record[I8245] == I8215) $this->itemData[I8377] ="checked"; $this->oEshop->TTT1lI1(I8261, $cId, $this->itemData, $this->oEshop->NONE); $this->lIIlI1l =false; if($this->db->Record['id_source'] >0){ $this->itemData['is_item_link'] =true; $this->lIIlI1l =true; $this->lIIlI1L =$this->db->Record['id_source']; $I1LLLLI =$this->oEshop->mEshop->GetOption(I8378); $I1LLLLl =$this->oEshop->mEshop->GetOption('path_settings_strip_text'); $this->oEshop->tree->initResult(I8287); $this->itemData["item_link_path"] =$this->oEshop->tree->getPath($this->itemData['id_category'], I8242, I8242, abs((int)$I1LLLLI[0]), abs((int)$I1LLLLI[1]), abs((int)$I1LLLLI[3]), abs((int)$I1LLLLI[2]), $I1LLLLl); $this->itemData['source_name'] =I8287; $sql =I8379.$this->oEshop->dbTablePrefix."_items WHERE id=".$this->db->Record['id_source']; $this->db->query($sql); if($this->db->next_record()){ $this->itemData['source_name'] =$this->db->Record[I8322]; }}else{ $this->itemData['item_links_list'] =I8287; $this->itemData[I8227] =0; $sql ="SELECT id_category FROM ".$this->oEshop->dbTablePrefix."_items WHERE id_source=".$cId; $this->db->query($sql); while($this->db->next_record()){ $this->itemData[I8227]++; $this->itemData['item_links_list'] .= (empty($this->itemData['item_links_list']) ?I8287 :',').$this->db->Record[I8380]; }}}}function TTTl11I($cId, $cModule) {$lIILI1L =I8215; $lIILI11 =I8215; if((isset($this->cms->VarsGet['export_driver']) && $this->cms->VarsGet['export_driver'] == 'CSVEshopDriver') && isset($this->cms->VarsGet[I8381]) && in_array('eshop_item', $this->cms->VarsGet[I8381])){ $lIILI1L =", pc.id AS cat_id_parent, pc.id_external AS cat_id_parent_external "; $lIILI11 =" LEFT JOIN ".$this->oEshop->dbTablePrefix."_cats pc ON pc.id=c.id_parent "; }$this->itemData =Array(); $lIILlII =I8215; for($i=0; $i<$this->oEshop->numPrices; $i++) {$lIILlII .= ",c.price".$this->oEshop->priceFields[$i]." as cat_price".$this->oEshop->priceFields[$i]; }$sql ="SELECT i.*, c.id as cat_id, c.id_external AS cat_id_external, c.dataset_id AS cat_dataset_id, c.sublink as cat_sublink, c.name AS cat_name, c.announce AS cat_announce, c.description AS cat_description, c.id_discount, c.public AS cat_public ".$lIILI1L.$lIILlII.I8244.$this->oEshop->dbTablePrefix."_items i INNER JOIN ".$this->oEshop->dbTablePrefix."_cats c ON c.id=i.id_category ".$lIILI11." WHERE i.id='".$cId.I8210; $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; }if(isset($this->ext['ext_images']) && $this->ext[I8382]->IsInstalled()){ $this->ext[I8382]->_GetPicturesCB($this->itemData,$this->itemData); }}function TTT1IlI($aSql =Array(), $cId =0) {if($cId >0){ $sql ='select id_source, name from '.$this->oEshop->dbTablePrefix.'_items where id='.intval($cId); $this->db->query($sql); if($this->db->next_record()){ if($this->db->Record['id_source'] >0){ $this->lIIlI1L =$this->db->Record['id_source']; $this->cms->VarsPost[I8322] =$this->db->Record[I8322]; $aSql =array(); $this->TTT1Ill($aSql, $cId, $this->cms->VarsPost); $this->lIIlI1l =true; return $aSql; }}}$this->lIIlI1l =false; if(!isset($this->cms->VarsPost[I8231])) {$this->cms->VarsPost[I8231] =$this->chargeTaxType; }$res =$this->oEshop->PrepareItemData($this->action, $this->cms->VarsPost, $aSql, $this->lIIIL1L, $cId, $this->ILLIIIL, $this->KeepItemCatId); $aSql =$res[I8383]; if(is_array($aSql) && sizeof($aSql) >0){ $I1L1lII =$this->I1LLlII->TIl1I1l($this->action, $this->cms->VarsPost, $aSql, $cId); $aSql =$I1L1lII[I8383]; }$this->catId =$res["catId"]; $this->I1IL1Ll =array_merge($this->I1IL1Ll, $res["aTmp"]); $aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TTT11IT($IILILIL) {$navData =parent::TTT11IT($IILILIL); $this->oEshop->tree->initResult(false); $res =$this->oEshop->tree->getNode($this->catId, I8351); if($res !== false) {$navData[I8212] =$this->catId; $navData[I8277] =$res[I8351]; }return $navData; }function TIIlTlT($id, $catId, $public, $parentPublic) {$this->oEshop->addItem($id, $catId, $public, $parentPublic); if($this->ILLIIIL) $this->TIIlIII($id, false); }function TTT1Tll($IIl11II, &$IIl1L1l, $cModule) {$res =parent::TTT1Tll($IIl11II, $IIl1L1l, $cModule); if($res) {$this->TIIlTlT($this->appliedId, $IIl1L1l["id_category"], $IIl1L1l["public"], $this->I1IL1Ll[I8384]); }return $res; }function TTTll11($cId, $cModule) {if($this->lIIlIIL[I8208] && (!$this->lIIlIIL[I8209] || $this->lIIlIIL["campaignData"]["max_items"] >0 && $this->lIIlIIL["campaignData"]["max_items"] <= $this->lIIlIIL[I8385])){ $this->cms->AddStatusMsg("status_add_fail", "red"); $this->action ="none"; return false; }if($this->lIIlIIL[I8208]){ $this->lIIlIIL[I8385]++; $this->lIIlIIL["doNotShowError"] =true; }parent::TTTll11($cId, $cModule); if(empty($this->errno)) {extract($this->I1IL1Ll); $this->TIIlTlT($this->appliedId, $this->catId, $public, $parentPublic); if(AMI_Registry::get('oldenv_inside_newenv', FALSE) === TRUE){ $oRequest =AMI::getSingleton('env/request'); $oRequest->set('applied_id', $this->appliedId); }if($this->cid >0) {$this->cid =$this->catId; }if(isset($this->cms->VarsCookie[I8225]) && $this->cms->VarsCookie[I8225] >0){ $sql ="update ".$this->oEshop->dbTablePrefix."_props set id_item=".intval($this->appliedId).I8386.intval($this->cms->VarsCookie[I8225]); $this->db->query($sql); SetLocalCookie(I8225, I8287, time(), $this->cms->AdminPathWWW); $IIlLIIL =Array(I8275 => "recalc_prop_data", I8221 => $this->appliedId); $this->TTT1lI1($IIlLIIL); }$this->TIIlIll($this->appliedId, $this->cms->Vars["cat"], $this->cms->Vars["item_links"]); }}function _ActionPublish($cId, $cModule) {if($this->ILLIIIL){ $recWasPub =false; $sql ="select i.public as i_pub, c.public as c_pub from ".$this->oEshop->dbTablePrefix."_items i LEFT JOIN ".$this->oEshop->dbTablePrefix."_cats c ON i.id_category=c.id WHERE i.id=".intval($cId); $this->db->query($sql); if($this->db->next_record()) $recWasPub =($this->db->Record["i_pub"] ?1 :0) &($this->db->Record["c_pub"] ?1 :0); }$public="0"; if(isset($this->cms->Vars[I8387]) && $this->cms->Vars[I8387] == "on") {$public=I8256; }$I1LLL1l =true; if($this->oEshop->itemCountersEnable) {$sql ="SELECT i.public, c.public AS cat_public, c.id AS cat_id FROM ".$this->oEshop->dbTablePrefix."_items i INNER JOIN ".$this->oEshop->dbTablePrefix."_cats AS c ON i.id_category=c.id WHERE i.id='".$cId.I8388.$this->langData.I8210; $this->db->query($sql); if($this->db->next_record()) {$oldPublic =$this->db->Record["public"]; $lIILlIl =$this->db->Record["cat_public"]; $parentCatId =$this->db->Record["cat_id"]; if($oldPublic == $public) {$I1LLL1l =false; }}}if($I1LLL1l) {parent::_ActionPublish($cId, $cModule); }if($this->oEshop->itemCountersEnable && $I1LLL1l) {if($lIILlIl) {$aSql =$this->oEshop->TT11I1I(($public) ?"+1" :I8389, "public"); $this->oEshop->TT11I1l(); $this->oEshop->tree->TI11l11($parentCatId, $aSql, true); $this->oEshop->TT11I11(); }}if($this->ILLIIIL && $I1LLL1l) $this->TIIlIII($cId, $recWasPub); $this->TIIlIl1($cId, 'public'); }function _ActionDel($cId, $cModule) {$aEvent =array( 'modId' => $this->moduleName, I8290 => &$cId );AMI_Event::fire('deprecated_v5_on_item_delete', $aEvent, AMI_Event::MOD_ANY); AMI_Event::fire(I8390, $aEvent, AMI_Event::MOD_ANY); if(!$cId){ $this->SetLastError(3, 'Deleting failed'); $this->cms->AddStatusMsg('status_del_fail', 'red'); return; }$lIILlIL =false; $sql ="SELECT id_source FROM ".$this->oEshop->dbTablePrefix.I8391.$cId.I8210; $this->db->query($sql); if($this->db->next_record()) {if($this->db->Record['id_source'] >0){ $this->lIIlI1L =$this->db->Record['id_source']; $lIILlIL =true; $sql ="update ".$this->oEshop->dbTablePrefix."_items set links_count=links_count-1 where id=".$this->db->Record[I8392]; }}if(!$lIILlIL && $this->ILLIIIL){ $recWasPub =false; $recWasLetter =I8215; $lIILlI1 ="en"; $sql ="select i.public as i_pub, i.letter as i_letter, i.lang as i_lang, c.public as c_pub from ".$this->oEshop->dbTablePrefix."_items i LEFT JOIN ".$this->oEshop->dbTablePrefix."_cats c ON i.id_category=c.id WHERE i.id=".intval($cId); $this->db->query($sql); if($this->db->next_record()){ $recWasPub =($this->db->Record[I8393] ?1 :0) &($this->db->Record["c_pub"] ?1 :0); $recWasLetter =$this->db->Record["i_letter"]; $lIILlI1 =$this->db->Record["i_lang"]; }}if($this->oEshop->itemCountersEnable) {$sql ="SELECT i.public, i.item_type, c.public AS cat_public, c.id AS cat_id FROM ".$this->oEshop->dbTablePrefix."_items i INNER JOIN ".$this->oEshop->dbTablePrefix."_cats AS c ON i.id_category=c.id WHERE  i.id='".$cId.I8388.$this->langData.I8210; $this->db->query($sql); if($this->db->next_record()) {$oldPublic =$this->db->Record["public"]; $lIILlIl =$this->db->Record["cat_public"]; $parentCatId =$this->db->Record["cat_id"]; $itemType =$this->db->Record[I8394]; }}parent::_ActionDel($cId, $cModule); if($this->oEshop->itemCountersEnable) {$aSql =$this->oEshop->TT11I1I(I8389, ($oldPublic && $lIILlIl) ?"both" :"all"); $this->oEshop->TT11I1l(); $this->oEshop->tree->TI11l11($parentCatId, $aSql, true); $this->oEshop->TT11I11(); }if(!$lIILlIL){ if($this->ILLIIIL) $this->TIIlIII($cId, $recWasPub, $recWasLetter, $lIILlI1, true); $sql ="delete from ".$this->oEshop->dbTablePrefix."_props where id_item=".intval($cId); $this->db->query($sql); $tmp =Array(I8394=>$itemType); $this->oEshop->TTT1lI1(I8395, $cId, $tmp, $this->oEshop->NONE); $this->TIIlI1I($cId); }}function TIIITlT($cId) {$tmp =$this->options["default_prefix"]; $this->options["default_prefix"] =I8215; $sql ="DELETE FROM ".$this->oEshop->dbTablePrefix."_items WHERE 1".$this->options[I8396][I8267].$this->_ApplyFilters(); $this->options["default_prefix"] =$tmp; if($this->db->query($sql) && (!$this->options["support_rights"] || $this->db->affected_rows() >0)) {$this->SetLastError(); $this->cms->AddStatusMsg("status_del"); }else {$this->SetLastError(3, "Deleting failed"); $this->cms->AddStatusMsg(I8397, "red"); }}function TIIlTlI($aGroupIds) {$catId =intval($this->cms->Vars["grp_id_cat"]); $IIL1IlL =0; if($catId >0) {$sql ="SELECT name, public FROM ".$this->oEshop->dbTablePrefix."_cats WHERE id='".$catId.I8398.$this->langData.I8210; $this->db->query($sql); if($this->db->nextRecord()) {$catName =$this->db->Record[I8242]; $lIILllI =$this->db->Record["public"]; $this->I1IL1Ll[I8384] =$lIILllI; if($this->cms->Vars["grp_type"] == "move") {$IILl1Il ="move"; $sql ="SELECT i.id, i.id_category, i.public, c.public as cat_public FROM ".$this->oEshop->dbTablePrefix."_items AS i INNER JOIN ".$this->oEshop->dbTablePrefix."_cats AS c ON i.id_category=c.id WHERE i.id IN('".implode("', '", $aGroupIds)."') AND i.id_category!='".$catId.I8388.$this->langData."' ORDER BY i.id_category"; $db =$this->db->TTI1I1T(); $db2 =$this->db->TTI1I1T(); $db->query($sql); $oldCatId =-1; $aIds =Array(); $IIL1Ill =0; $lIILlll =0; $IIL1IlL =$db->numRows(); $lIILllL =true; while(($lIILll1 =$db->nextRecord()) || $lIILllL) {if(!$lIILll1) {$lIILllL =false; }if($db->Record["id_category"] != $oldCatId) {if($oldCatId != -1) {$sql ="UPDATE ".$this->oEshop->dbTablePrefix."_items SET id_category='".$catId."' WHERE id IN('".implode(I8254, $aIds).I8331; if($this->db->query($sql)) {if($this->oEshop->itemCountersEnable) {$numItems =sizeof($aIds); $aSql =$this->oEshop->TT11I1I(I8399, ($lIILlLI ?"both" :"all"), Array("count_public_childs"=>$IIL1Ill, "count_childs"=>$numItems)); $this->oEshop->tree->TI11l11($oldCatId, $aSql, true); }}for($ii =0; $ii <sizeof($aIds); $ii++){ if($aIds[$ii] >0){ $this->TIIlI1l($db2, $aIds[$ii], $catId); }}}else {$lIILlLI =$db->Record[I8400]; }$aIds =Array($db->Record[I8221]); $oldCatId =$db->Record["id_category"]; $IIL1Ill =0; }else {$aIds[] =$db->Record[I8221]; $lIILlLI =$db->Record[I8400]; }if($db->Record["public"] >0) {$IIL1Ill++; $lIILlll++; }}if($IIL1IlL >0) {if($this->oEshop->itemCountersEnable) {$aSql =$this->oEshop->TT11I1I("+", ($lIILllI ?"both" :I8401), Array("count_public_childs"=>$lIILlll, "count_childs"=>$IIL1IlL)); $this->oEshop->tree->TI11l11($catId, $aSql, true); }}}elseif($this->cms->Vars["grp_type"] == "copy") {$IIl1Ll1[I8402] =$catId; $IIL1IlL =$this->TTT1TlI($aGroupIds, $cModule, false, $IIl1Ll1); $IILl1Il ="copy"; }}}if($IIL1IlL >0) {$this->cms->AddStatusMsg("status_grp_cat_".$IILl1Il, "blue", I8215, I8215, Array("num" => $IIL1IlL.I8215, I8403 => $catName)); }else {$this->cms->AddStatusMsg("status_grp_cat_".$IILl1Il."_fail", "red"); }}function TTT1ll1(&$asql, $cId, $IIIL11l, $IILIllI =false){ if(!$this->lIIlI1l){ parent::TTT1ll1($asql, $cId, $IIIL11l, $IILIllI); }}function TTTl1lI($cId, $cModule) {$lIILlLl =0; if($this->lIIlIIL[I8208]){ $sql ="select id_category from cms_es_items where id='".$cId.I8210; $this->db->query($sql); $this->db->next_record(); $lIILlLl =$this->db->Record[I8402]; }if($this->lIIlIIL[I8208] && (!$this->lIIlIIL[I8209] || $this->lIIlIIL[I8404]["max_items"] >0 && $this->lIIlIIL[I8404]["max_items"] <= $this->lIIlIIL[I8385])){ if($lIILlLl != intval($this->cms->Vars[I8234])){ $this->cms->AddStatusMsg("status_apply_fail", "red"); $this->action =I8405; return false; }}if($this->lIIlIIL[I8208]){ if($lIILlLl != intval($this->cms->Vars[I8234])) $this->lIIlIIL[I8385]++; $this->lIIlIIL["doNotShowError"] =true; }parent::TTTl1lI($cId, $cModule); if(!$this->lIIlI1l && empty($this->errno)) {$this->oEshop->TT11I1l(); extract($this->I1IL1Ll); if($categoryChanged) {if($this->oEshop->itemCountersEnable) {$aSql =$this->oEshop->TT11I1I(I8389, ($oldPublic && $oldParentPublic) ?"both" :I8401); $this->oEshop->tree->TI11l11($oldCatId, $aSql, true); $aSql =$this->oEshop->TT11I1I("+1", ($public && $parentPublic) ?"both" :I8401); $this->oEshop->tree->TI11l11($this->catId, $aSql, true); }}else {if($this->oEshop->itemCountersEnable && $oldPublic != $public) {if($oldParentPublic) {$aSql =$this->oEshop->TT11I1I(($public) ?I8406 :I8389, "public"); $this->oEshop->tree->TI11l11($oldCatId, $aSql, true); }}}$this->oEshop->TT11I11(); if($this->cid >0) {$this->cid =$this->catId; }if($this->ILLIIIL) $this->TIIlIII($cId, $recWasPub, $recWasLetter); if($isNeedRecalcPropData){ $lIILlLL =array(); $IIlLIIL =Array(I8275 => "recalc_prop_data", I8221 => $this->appliedId); $this->TTT1lI1($IIlLIIL); }$this->TIIlIll($cId, $this->cms->Vars["cat"], $this->cms->Vars["item_links"]); }}function TTTlITT($IIIL11l, $cId, $cModule =I8287) {switch($IIIL11l) {case I8407: $this->TIIlITI(); break; case "ss_apply": $this->TIIlITT(); break; case "special": $this->TIIlTll($cId); break; case "grp_special_advanced": if(isset($this->cms->Vars["special"]) && mb_strpos($this->cms->Vars[I8408] ,"advanced_") !== false) {$this->TIIlT1T($this->aGroupIds); }else {$this->TIIlTl1(); }$this->redirect =false; break; case "grp_change_parent_cat": $this->TIIlTlI($this->aGroupIds); break; case "special_confirm": $this->TIIlT1I($cId); break; case "grp_special_on": $this->TIIlT1l($this->aGroupIds); break; case I8409: $this->TIIlT11($this->aGroupIds); break; case "del_confirm": $this->TIIITlT($cId); break; case "show_details": $this->TIIlII1($cId); break; case "show_ref_details": $this->TIIlIlT($cId); break; case "links_popup": $this->TIIlIlI($cId); break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }if(AMI_Registry::get('oldenv_inside_newenv', FALSE) === TRUE){ $this->redirect =false; }}function TIIlTll($cId) {$form =Array(); $form[I8221] =$cId; $sql ="SELECT i.on_special FROM ".$this->oEshop->dbTablePrefix."_items i WHERE i.id='".$cId.I8210; $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; }$this->TIIlTII($form); $form["content"] =$this->cms->Gui->getAbs($this->moduleName."_subform:special_popup_form", $form); $form[I8410] =$this->words["eshop_special_form"]; $form["form_align"] ="align=center"; $IILIIIL ="special_popup"; parent::TTT1I1I($form, $IILIIIL); }function TIIlTl1() {$form =Array(); $form[I8411] =$this->aGroupIds; $this->TIIlTII($form, I8215, "grp_"); unset($form['_grp_ids']); $form["content"] =$this->cms->Gui->getAbs($this->moduleName."_subform:grp_special_popup_form", $form); $form[I8410] =$this->words[I8412]; $form["form_align"] ="align=center"; $IILIIIL ="special_popup"; parent::TTT1I1I($form, $IILIIIL); }function TIIlT1T(&$aGroupIds) {$lIILlL1 =explode(I8295, $this->cms->Vars[I8408]); $lIILl1I =intval($lIILlL1[1]); $lIILl1l =intval($lIILlL1[2]); if(($lIILl1I >0 || $lIILl1l >0) && sizeof($aGroupIds) >0) {$sql ="UPDATE ".$this->oEshop->dbTablePrefix."_items SET on_special= ((on_special | ".$lIILl1I.") & ~".$lIILl1l.") WHERE id IN('".implode(I8254, $aGroupIds)."') AND lang='".$this->langData.I8210; $this->db->query($sql); $this->IIllIll =$this->db->affected_rows(); $this->cms->AddStatusMsg("status_grp_special_advanced", I8413, I8215, I8215, Array("num_items" => $this->IIllIll.I8215)); $this->appliedId =I8215; for($i =0; $i <sizeof($aGroupIds); $i++){ if($aGroupIds[$i] >0){ $this->TIIlIl1($aGroupIds[$i], 'on_special'); }}}}function TIIlT1I($cId) {if($this->I1LLlL1 == 0) {$public =false; if(isset($this->cms->Vars[I8408]) && $this->cms->Vars[I8408] == "on") {$public =true; }$this->TTT1IIT($public, $cId, I8215.$this->oEshop->dbTablePrefix."_items", I8216, I8414); }else {$this->TTT1III(intval($this->cms->Vars[I8408]), $cId, I8215.$this->oEshop->dbTablePrefix."_items", I8216, I8414); }$this->TIIlIl1($cId, 'on_special'); }function TIIlT1l(&$aGroupIds) {$this->cms->Vars[I8408] ="on"; $numItems =sizeof($aGroupIds); for($i=0; $i<$numItems; $i++) {$this->TIIlT1I($aGroupIds[$i]); }$this->cms->AddStatusMsg("status_grp_special_on", I8413, I8215, I8215, Array(I8415 => $numItems.I8215)); $aGroupIds =Array(); $this->appliedId =I8215; }function TIIlT11(&$aGroupIds) {$this->cms->Vars[I8408] ="off"; $numItems =sizeof($aGroupIds); for($i=0; $i<$numItems; $i++) {$this->TIIlT1I($aGroupIds[$i]); }$this->cms->AddStatusMsg("status_grp_special_off", I8413, I8215, I8215, Array(I8415 => $numItems.I8215)); $aGroupIds =Array(); $this->appliedId =I8215; }function TIIlITT() {$updated =0; $added =0; $lIILl1L =0; $lIILl11 =0; $lIILLII =$this->cid; $parentPublic =false; $lIILLIl =0; if($this->cid == "0") {$lIILLII =$this->oEshop->rootCatId; }$ILLILlL =I8215; $aCatData =Array(); if($this->oEshop->currencyEnable) {$ILLILlL =$this->oEshop->getPriceFields("SUBSTRING(price%d, INSTR(price%d, '#')+1, 3) AS currency%d, SUBSTRING(price%d, INSTR(price%d, ':')+1, 3) AS db_currency%d"); }if($this->oEshop->itemCountersEnable || $this->oEshop->currencyEnable) {$sql ="SELECT id_site, public".$ILLILlL.I8244.$this->oEshop->dbTablePrefix."_cats WHERE id='".$lIILLII.I8398.$this->langData.I8210; $this->db->query($sql); if($this->db->nextRecord()) {$parentPublic =$this->db->Record["public"]; $aCatData =$this->db->Record; $siteId =$this->db->Record["id_site"]; }}if(empty($this->lIIIL11)) {$lIILLIL =$this->oEshop->defaultItemType; }else {$lIILLIL =$this->lIIIL11; }$lIILLI1 =Array(); $lIILLlI =$this->TIIlIIT(); $lIILLll =0; $lIILLlL =0; for($i=1; $i<=count($this->cms->VarsPost["ss_id"]); $i++){ $sku =$this->cms->VarsPost[I8416][$i]; $aSql =Array(I8242=>$this->cms->VarsPost["ss_name"][$i]); if($this->ILLIIIL && !isset($aSql[I8304]) && isset($aSql[I8242]) && mb_strlen($aSql[I8242]) >0){ $ILLIlll =preg_replace('/[^a-zA-Z--0-9]/u', I8287, unhtmlentities($aSql[I8242])); $aSql[I8304] =mb_substr($ILLIlll,0,1); }if($this->ILLIIIL){ $lIILLl1 =0; $recWasPub =false; $lIILLLI =false; $recWasLetter =I8215; $lIILlI1 ="en"; }if(trim($this->cms->VarsPost["ss_price"][$i]) != I8215){ $aSql[I8245] =doubleval(str_replace(I8417, ".", $this->cms->VarsPost["ss_price"][$i])); }else{ $aSql[I8245] ="=|NULL"; }$priceMask =intval($this->cms->VarsPost["ss_price_mask"][$i]); $lIILLLl =array(); if($this->oEshop->otherPricesEnabled) {$aTmp =Array(); for($j=0; $j<$this->oEshop->numPrices; $j++){ $numPrice =$this->oEshop->priceFields[$j]; if(trim($this->cms->VarsPost[I8418.$numPrice][$i]) == I8215) {$aSql[I8245.$numPrice] ="=|NULL"; $lIILLLl[I8245.$numPrice] ="=|NULL"; }else {if(isset($aCatData["db_currency"]) && $aCatData["db_currency"] != I8215 && $this->oEshop->issetCurrency($aCatData[I8419])) {$tmp[I8239] =$tmp[I8419]; $currencyRate =1; }else {$currencyRate =$this->oEshop->getCurrencyRate($tmp[I8239]); }$aSql[I8245.$numPrice] =doubleval(str_replace(I8417, ".", $this->cms->VarsPost[I8418.$numPrice][$i])); $aSql[I8245.$numPrice] /= $this->oEshop->getCurrencyRate($aCatData[I8239.$numPrice]); $lIILLLl[I8245.$numPrice] =$aSql[I8245.$numPrice]; }}$aSql["price_mask"] =$priceMask; }$aSql["lang"] =$this->langData; if($this->cms->VarsPost["ss_id"][$i] >I8215) {if($this->cms->VarsPost[I8420][$i] >I8215) {$lIILLl1 =intval($this->cms->VarsPost["ss_id"][$i]); $sql ="SELECT id_source FROM ".$this->oEshop->dbTablePrefix.I8391.$lIILLl1.I8210; $this->db->query($sql); if($this->db->next_record()){ if($this->db->Record["id_source"]){ $lIILLlL++; continue; }}if(isset($this->cms->VarsPost["ss_rest"]) && isset($this->cms->VarsPost[I8421][$i])){ $sql ="SELECT rest FROM ".$this->oEshop->dbTablePrefix.I8391.$lIILLl1.I8210; $this->db->query($sql); $this->db->next_record(); $lIILLLL =$this->db->Record["rest"]; if((int)$this->cms->VarsPost[I8421][$i] != (int)$lIILLLL){ $sql ="SELECT COUNT(*) AS cnt FROM ".$this->oEshop->dbTablePrefix."_props WHERE id_category='".$this->cid.I8210; $this->db->query($sql); if($this->db->next_record()){ if(intval($this->db->Record[I8422]) == 0){ $aSql['rest'] =intval($this->cms->VarsPost[I8421][$i]); }else{ $lIILLll++; }}}}if($this->ILLIIIL){ $sql ="select i.public as i_pub, i.letter as i_letter, c.public as c_pub from ".$this->oEshop->dbTablePrefix."_items i LEFT JOIN ".$this->oEshop->dbTablePrefix."_cats c ON i.id_category=c.id WHERE i.id=".$lIILLl1; $this->db->query($sql); if($this->db->next_record()){ $recWasPub =($this->db->Record[I8393] ?1 :0) &($this->db->Record[I8423] ?1 :0); $recWasLetter =$this->db->Record["i_letter"]; }}$sql ="select price from ".$this->oEshop->dbTablePrefix."_items WHERE id=".intval($lIILLl1); $this->db->query($sql); $lIILLL1 =0; if($this->db->next_record()){ $lIILLL1 =$this->db->Record[I8245]; }if($this->lIIIL1L && $sku != I8215) {$sql ="SELECT id, name FROM ".$this->oEshop->dbTablePrefix.I8424.$sku.I8398.$this->langData.I8352. "AND id!='".$this->cms->VarsPost["ss_id"][$i]."' LIMIT 1"; $this->db->query($sql); if($this->db->next_record()){ $this->cms->AddStatusMsg("status_item_apply_warn_sku", I8425, I8215, "[".$this->db->Record[I8242]."]", Array("sku"=>$sku)); $sku =I8215; }}$aSql["sku"] =$sku; $this->TTT1ll1($aSql, 0, I8426); $this->oEshop->TTT1lI1("before_ssapply_apply", 0, $aSql, $this->oEshop->NONE); $sql =$this->db->GenUpdateSQL(I8215.$this->oEshop->dbTablePrefix."_items", $aSql, "WHERE id='".$this->cms->VarsPost["ss_id"][$i].I8210); $this->db->query($sql); $updated++; $lIILL1I =false; $lIILL1l =0; $sql =I8427.$this->oEshop->dbTablePrefix."_items WHERE id=".$lIILLl1; $this->db->query($sql); if($this->db->next_record()){ if($lIILLL1 != $this->db->Record[I8245]){ $IIlLIIL =Array(I8275=>"recalc_prop_data", I8221=>$lIILLl1); $this->TTT1lI1($IIlLIIL); $lIILL1I =true; $lIILL1l =$this->db->Record[I8245]; }}if($lIILL1I){ $lIILLLl['price'] =$lIILL1l; $sql =$this->db->GenUpdateSQL(I8215.$this->oEshop->dbTablePrefix."_items", $lIILLLl, I8428.intval($lIILLl1).I8210); $this->db->query($sql); }}else {if($this->cms->VarsPost[I8420][$i] == I8215) {if($this->ILLIIIL){ $lIILLLI =true; $lIILLl1 =intval($this->cms->VarsPost["ss_id"][$i]); $sql ="select i.public as i_pub, i.letter as i_letter, i.lang as i_lang, c.public as c_pub from ".$this->oEshop->dbTablePrefix."_items i LEFT JOIN ".$this->oEshop->dbTablePrefix."_cats c ON i.id_category=c.id WHERE i.id=".$lIILLl1; $this->db->query($sql); if($this->db->next_record()){ $recWasPub =($this->db->Record[I8393] ?1 :0) &($this->db->Record[I8423] ?1 :0); $recWasLetter =$this->db->Record[I8429]; $lIILlI1 =$this->db->Record["i_lang"]; }}$lIILL1L =$lIILLIL; if($this->oEshop->numItemTypes >1 && empty($this->lIIIL11)) {$sql ="SELECT item_type FROM ".$this->oEshop->dbTablePrefix.I8391.$this->cms->VarsPost["ss_id"][$i].I8398.$this->langData.I8210; $this->db->query($sql); if($this->db->next_record()) {$lIILL1L =$this->db->Record[I8394]; }}$sql ="DELETE from ".$this->oEshop->dbTablePrefix.I8391.$this->cms->VarsPost[I8430][$i]."' OR id_source='".$this->cms->VarsPost[I8430][$i].I8210; $this->db->query($sql); if($this->cms->VarsPost["ss_public"][$i]==I8256) {$lIILl1L++; }else {$lIILl11++; }$lIILLI1[$lIILL1L][] =$this->cms->VarsPost[I8430][$i]; }}}elseif($this->cms->VarsPost[I8420][$i] >I8215){ if($lIILLIl == 0) {$lIILLIl =$this->TTTl1TI(); }else {$lIILLIl++; }if(isset($this->cms->VarsPost[I8421])){ $aSql['rest'] =intval($this->cms->VarsPost[I8421][$i]); }if($this->lIIIL1L && $sku != I8215) {$sql ="SELECT id, name FROM ".$this->oEshop->dbTablePrefix.I8424.$sku.I8398.$this->langData.I8431.$this->cms->VarsPost[I8430][$i]."' LIMIT 1"; $this->db->query($sql); if($this->db->next_record()){ $this->cms->AddStatusMsg("status_item_add_warn_sku", I8425, I8215, "[".$this->db->Record[I8242]."]", Array(I8432=>$sku)); $sku =I8215; }}if(isset($this->cms->VarsPost["ss_cat"]) && isset($this->cms->VarsPost["ss_cat"][$i])){ $lIILLII =(int)$this->cms->VarsPost["ss_cat"][$i]; }$aSql[I8432] =$sku; $aSql[I8394] =$lIILLIL; $aSql[I8402] =$lIILLII; $aSql["id_site"] =$siteId; $aSql[I8433] =$lIILLIl; $this->TTT1ll1($aSql, 0, "add"); $aSql += $lIILLlI; $this->oEshop->TTT1lI1("before_ssapply_add", 0, $aSql, $this->oEshop->NONE); $aSql["date"] ="=|NOW()"; $sql =$this->db->GenInsertSQL(I8215.$this->oEshop->dbTablePrefix.I8434, $aSql); $this->db->query($sql); $lIILL11 =$this->db->lastInsertId(); if($this->ILLIIIL) $lIILLl1 =intval($lIILL11); $added++; }if($this->ILLIIIL && $lIILLl1 >0) $this->TIIlIII($lIILLl1, $recWasPub, $recWasLetter, $lIILlI1, $lIILLLI); }$aSql =Array(); if($this->oEshop->itemCountersEnable) {$this->oEshop->TT11I1l(); if($lIILl1L >0 && $lIILl11 >0) {if($parentPublic) {$aSql =$this->oEshop->TT11I1I(I8399, "both", Array("count_public_childs"=>$lIILl1L, "count_childs"=>$lIILl1L +$lIILl11)); }else {$aSql =$this->oEshop->TT11I1I(I8399.($lIILl1L +$lIILl11), I8401); }}elseif($lIILl1L >0) {$aSql =$this->oEshop->TT11I1I(I8399.$lIILl1L, ($parentPublic) ?"both" :I8401); }elseif($lIILl11 >0) {$aSql =$this->oEshop->TT11I1I(I8399.$lIILl11, I8401); }$this->oEshop->tree->TI11l11($lIILLII, $aSql, true); if($added >0) {$aSql =$this->oEshop->TT11I1I(I8435.$added, ($parentPublic) ?"both" :I8401); $this->oEshop->tree->TI11l11($lIILLII, $aSql, true); }$this->oEshop->TT11I11(); }if(sizeof($lIILLI1) >0) {$lIIL1II =Array(); foreach($lIILLI1 as $itemType=>$lIIL1Il) {$tmp =Array(I8394=>$itemType); $this->oEshop->TTT1lI1(I8395, $lIIL1Il, $tmp, $this->oEshop->NONE); }unset($lIILLI1); }$this->cms->Gui->addHtmlScript('var amiRestoreHash="' .html_entity_decode($this->cms->VarsPost["hash"]) .'";'); $this->cms->Gui->addHtmlScript('var amiInstantExcelMode=true;'); $deleted =$lIILl1L +$lIILl11; if($lIILLll){ $this->cms->AddStatusMsg("status_rest_not_updated", I8425, I8215, I8215, Array("count"=>"$lIILLll")); }if($lIILLlL){ $this->cms->AddStatusMsg("status_links_not_updated", I8425, I8215, I8215, Array("count"=>"$lIILLlL")); }$this->cms->AddStatusMsg("status_price_update", I8413, I8215, I8215, Array("updated"=>"$updated", "added"=>"$added", "deleted"=>"$deleted")); }function TIIlITI() {$sql ="SELECT i.id, c.id AS cat_id FROM ".$this->oEshop->dbTablePrefix."_items i INNER JOIN ".$this->oEshop->dbTablePrefix."_items_cats ic ON i.id=ic.id_product INNER JOIN ".$this->oEshop->dbTablePrefix."_cats c ON ic.id_category=c.id"; $this->db->query($sql); $db =new DB_si; while($this->db->next_record()) {$db->query("UPDATE ".$this->oEshop->dbTablePrefix."_items SET id_category='".$this->db->Record[I8436]."' WHERE id='".$this->db->Record[I8221].I8210); set_time_limit(10); }}function TTTlIII() {parent::TTTlIII(); $aCats =Array(); $aCats =$this->filter->TITI1TT($aCats, Array($this->cms->Words[I8401]=>0), 55); $num =sizeof($this->I1LLllI); for($i=0;$i<$num;$i++) {$aCats =$this->filter->TITI1TT($aCats, Array($this->I1LLllI[$i][I8242]=>$this->I1LLllI[$i][I8221]), 500); }$this->filter->AddField(I8436, I8266, $this->cid, I8215, "=", I8402, $aCats); $this->filter->MoveField(I8436, _MOVE_START); if(!AMI::getSingleton('env/async50')->isActive()){ $this->filter->TITIll1(I8436); }if($this->cid==0) {$this->filter->DisableFieldSQL(I8436); }if($this->oEshop->numItemTypes >1) {$aItemTypes =Array(); $aItemTypes =$this->cms->Filter->TITI1TT($aItemTypes, Array($this->cms->Words[I8401]=>0), 55); $this->oEshop->extGetModulesList($aItemTypes); $this->cms->Filter->AddField(I8203, I8266, I8215, $this->lIIIL11, "=", I8437, $aItemTypes); $this->cms->Filter->MoveField(I8203, _MOVE_START); if(empty($this->lIIIL11)) {$this->cms->Filter->DisableFieldSQL(I8203); }}elseif($this->oEshop->numItemTypes >0) {$this->cms->Filter->AddField(I8203, "hidden", $this->oEshop->defaultItemType, I8215, "=", I8437); $this->cms->Filter->MoveField(I8203, _MOVE_START); }$this->filter->AddField("flt_name", I8306, isset($this->cms->Vars["flt_name"]) ?stripslashes(unhtmlentities($this->cms->Vars[I8438])) :I8287, I8215, " like ", "i.name"); $this->filter->MoveField(I8438,_MOVE_PREV); $this->filter->AddField("flt_sku", I8306, isset($this->cms->Vars["flt_sku"]) ?stripslashes(unhtmlentities($this->cms->Vars[I8439])) :I8287, I8215, " like ", I8307); $this->filter->MoveField(I8439,_MOVE_PREV); $this->filter->AddField("flt_id_external", I8306, isset($this->cms->Vars["flt_id_external"]) ?stripslashes(unhtmlentities($this->cms->Vars["flt_id_external"])) :I8287, I8215, I8440, "i.id_external"); $this->filter->MoveField("flt_id_external",_MOVE_PREV); if($this->lIIlI1I){ $this->filter->AddField('flt_item_links', 'checkbox', empty($this->cms->Vars[I8441]) ?null :$this->cms->Vars[I8441], '0', ' > ', $this->options['default_prefix'] .I8392); $this->filter->MoveField("flt_item_links",_MOVE_PREV); if(empty($this->cms->Vars[I8442])){ $this->cms->Filter->DisableFieldSQL(I8442); }}}function TTTlI11(&$vData, &$aCustom) {$IIlL1Ll =Array(); $IIlL1Ll["list_data"]["script_base_prices"] =I8215; $IIlL1Ll["list_data"]["script_prices"] =I8215; $IIlL1Ll[I8443]["row_number"] =0; $IIlL1Ll[I8443]["_force_show_main"] =0; $IIlL1Ll[I8443]["excel_list_rows"] =$this->oEshop->mEshop->GetOption("excel_list_rows"); $this->oEshop->TT111l1($vData, $IIlL1Ll[I8443]); if($this->cid >0) {$I1LLLLI =$this->oEshop->mEshop->GetOption(I8378); $I1LLLLl =$this->oEshop->mEshop->GetOption('path_settings_strip_text'); $I1LLLLL =$this->cms->Gui->getAbs($this->moduleName."_list:path_root_item", I8215); $this->oEshop->tree->initResult($I1LLLLL); $IIlL1Ll[I8443][I8274] =$this->oEshop->tree->getPath($this->cid, I8242, I8242, abs((int)$I1LLLLI[0]), abs((int)$I1LLLLI[1]), abs((int)$I1LLLLI[3]), abs((int)$I1LLLLI[2]), $I1LLLLl); $IIlL1Ll[I8443]["cat_childs_select"] =$this->cms->Gui->get($this->moduleName."_list:path_childs_select", $vData); }else {$this->cms->Gui->AddGlobalVars(Array('PARENT_COL' => I8298)); }$lIIL1IL =I8444 .(pow(2, $this->I1LLlL1 +1) -1) .") > 0)"; $ILLILlL ="i.id, i.id_category AS cat_id, i.id_source, i.links_count, i.public, i.name, i.sku, ". "date, date_format(date,'".$this->cms->DFMT[I8333]."') as fdate, ". "i.announce, i.price, i.sku, " .$lIIL1IL ." AS is_special, i.max_quantity, i.allow_fraction, ". "i.price_mask, c.name AS category, c.id_discount, ". I8437.$this->oEshop->getPriceFields("i.price%d").$this->oEshop->getPriceFields("ifnull(i.price%d,0)", I8435, I8445, ") AS psum"); if($this->lIIIL1l) {$ILLILlL .= ",i.tax,i.tax_type,i.charge_tax_type, i.tax_class_type, i.id_tax_class, i.discount,i.discount_type"; }if($this->oEshop->currencyEnable) {$ILLILlL .= $this->oEshop->getPriceFields("SUBSTRING(c.price%d, INSTR(c.price%d, '#')+1, 3) AS currency%d, SUBSTRING(c.price%d, INSTR(c.price%d, ':')+1, 3) AS db_currency%d"); }$ILLILlL .= $this->oEshop->TT1111I("i", I8446); $this->browser->InitSQL( $ILLILlL, Array('tables'=>Array('i'=>$this->oEshop->dbTablePrefix.I8434,'c'=>$this->oEshop->dbTablePrefix.I8370), 'joins'=>Array(I8447=>'i.id_category=c.id'), 'post_join'=>'AND i.lang=c.lang' )," WHERE c.lang='".$this->langData.I8352.$this->filter->GetFilterSql().$this->_ApplyFilters(), I8215, I8242, I8448, Array('category'=>'c.name', 'psum'=>$this->oEshop->getPriceFields("ifnull(i.price%d,0)", I8435, I8449,I8252), 'is_special' => "=|" .$lIIL1IL), _DB_STRAIGHT_JOIN );$this->browser->AddSQLJoinedTables($this->cms->Core, 'i', Array('c'=>$this->oEshop->dbTablePrefix.I8370)); $this->browser->TI1TIIT(Array(I8450=>'clause', 'optimization'=>Array(I8380=>'c|i')), Array(I8450=>'order', I8451=>Array('c'=>'c|i', 'i'=>I8447))); $IIlL1Ll['applied_id'] =I8452; if($this->I1LLlL1) {$lIIL1I1 ="_advanced"; }else {$lIIL1I1 =I8215; }$vData['cat_allow_fraction'] =isset($vData[I8217]) && $vData[I8217] === I8298 ?' checked' :I8287; $IIlL1Ll[I8332] =Array( 'price'=>Array(I8453=>'callback', I8337=>&$this, 'method'=>'_priceRow'), 'public'=>Array(I8453=>I8454, 'value'=>1, I8290=>'pub_id', 'on'=>$this->moduleName.'_list:public_on',I8455=>$this->moduleName.'_list:public_off'), 'is_special'=>Array(I8453=>I8454, 'value'=>1, I8290=>'spec_id', I8456=>$this->moduleName.'_list:special'.$lIIL1I1.'_on',I8455=>$this->moduleName.'_list:special'.$lIIL1I1.'_off'), I8457=>Array(I8453=>'stripline', 'size'=>50), 'announce'=>Array(I8453=>'stripline', I8458=>80), "action_edit"=>Array(I8275=>"flagicon", "value"=>I8215, I8221=>"edit_id", I8459=>$this->moduleName."_list:edit","off"=>I8215), "action_del"=>Array(I8275=>"flagicon", I8460=>I8215, I8221=>"del_id", I8459=>$this->moduleName."_list:del","off"=>I8215) );if($this->oEshop->otherPricesEnabled) {$IIlL1Ll[I8332]['other_prices_col'] =Array(I8453=>I8461, I8337=>&$this, 'method'=>'_otherPriceRow'); }$aCustom += $IIlL1Ll; $aCustom[I8443] += $IIlL1Ll[I8443]; $aCustom["fields"] += $IIlL1Ll["fields"]; $aCustom[I8462]["buttons"] =Array("add", I8426, "cancel", "save"); $vData[I8463] =isset($vData[I8463]) ?intval($vData[I8463]) :0; if(!$this->lIIlIIl){ $vData[I8377] =$this->cms->Gui->get($this->moduleName."_subform:variable_price", $this->itemData); }parent::TTTlI11($vData, $aCustom); }function TTT11Tl(&$IILILII) {$IILILII[] ="published"; $IILILII[] ="notpublished"; $IILILII[] =I8408; $IILILII[] ="not_special"; $IILILII[] =I8464; $IILILII[] ="leg_yellow"; $IILILII[] ="leg_blue"; $IILILII[] ="leg_edit"; $IILILII[] ="leg_del"; parent::TTT11Tl($IILILII); }function TTTllTT(&$vData) {$vData[I8465] =($this->browser->getPagesCount() == ($this->browser->getActivePage() +1)); }function _GroupOperationCB(&$vItem, &$vData) {if($vItem[I8392] >0){ $this->lIIlI1L =$this->db->Record[I8392]; $vItem["_group_operations_col"] =$this->cms->Gui->getAbs($this->moduleName."_list:group_operations_no_col"); }else{ parent::_GroupOperationCB($vItem, $vData); }}function _getCategoryRowCB(&$aItem, &$aData) {$aEvent =array( 'modId' => $this->moduleName, 'aItem' => &$aItem, I8466 => &$aData, I8369 => $this );AMI_Event::fire('v5_on_before_get_eshop_category', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); $this->TTIITTT($aItem); if(isset($this->ext[I8361.$this->oEshop->ownerName.I8299]) && $this->cms->Core->IsInstalled(I8361.$this->oEshop->ownerName.I8299)){ $IL1ILLl =array(); $IIlLIIL =Array(I8275=>"set_dataset", I8221=>$aItem["dataset_id"], "item_data"=>&$aItem, I8314=>&$IL1ILLl); $this->ext[I8361.$this->oEshop->ownerName.I8299]->TTT1lI1($IIlLIIL); $IIlLIIL =Array(I8275=>"get_subcat_custom_fields", I8221=>$aItem[I8221], "item_data"=>&$aItem, I8293=>&$aItem, I8314=>&$aData); $this->ext[I8361.$this->oEshop->ownerName.I8299]->TTT1lI1($IIlLIIL); }$aItem[I8360] =$this->lIII1Ll; if($this->oEshop->itemCountersEnable) {$aItem["count_items"] =$this->cms->TTITI1l(I8346, "count_items", $aItem["count_public_childs"]); }$aEvent =array( I8467 => $this->moduleName, 'aItem' => &$aItem, I8466 => &$aData, I8369 => $this );AMI_Event::fire('v5_on_after_get_eshop_category', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); }function _getCategoryItemsRowCB(&$aItem, &$aData) {$aEvent =array( I8467 => $this->moduleName, 'aItem' => &$aItem, I8466 => &$aData, I8369 => $this );AMI_Event::fire('v5_on_before_get_eshop_category_items', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); $lIIL1lI =Array(); $aData[I8340] =Array(); $aItem[I8360] =$this->lIII1Ll +1; if($this->oEshop->otherPricesEnabled) {$this->I1IL1Ll[I8468] =Array(); $aItem["other_prices_captions"] =I8215; $lIII1I1["num_prices"] =$this->oEshop->numPrices; for($i=0;$i<$this->oEshop->numPrices;$i++) {$numPrice =$this->oEshop->priceFields[$i]; $aData[I8340][I8239.$numPrice] =$aItem[I8239.$numPrice]; $aData[I8340][I8419.$numPrice] =$aItem[I8419.$numPrice]; $this->I1IL1Ll[I8468][I8280.$numPrice] =$aItem[I8280.$numPrice]; $lIII1I1["num_prices"] =$numPrice; $lIII1I1[I8280] =$aItem[I8280.$numPrice]; $lIII1I1[I8341] =$this->oEshop->getCurrencyName($aItem[I8239.$numPrice]); $aItem["other_prices_captions"] .= $this->cms->Gui->get($this->moduleName."_list:cat_item_other_price_caption", $lIII1I1); }}$aProducts =$aData["aItems"][$aItem[I8290]]; $this->TTTlll1($this->oEshop->ownerName.I8278); if(is_array($aProducts)) {$lIIL1ll =Array(); $numRows =sizeof($aProducts); $k =0; $IIllILI =$this->oEshop->mEshop->GetOption("sub_splitter_period"); $IIllLII =$this->TTT11ll(); $this->oEshop->ILlL1l1[I8376] =$this->I1IL1Ll; $aItem['item_list'] =I8287; foreach(array_keys($aProducts) as $index) {$aProduct =$aProducts[$index]; $lIIL1lL =array( I8273 => $aProduct[I8273], 'catid_sublink' => $aProduct[I8469] );$k++; $aProducts[I8360] =$this->lIII1Ll +1; $IIL1lI1 =$aData["simple_prefix"]; $aData["simple_prefix"] ="item_"; $IIlLIIL =Array(I8275=>I8344, I8293=> $_data =array(&$aProduct, &$aData)); $this->TTT1lI1($IIlLIIL, array(I8382)); $aData["simple_prefix"] =$IIL1lI1; $IL1ILLl =array(); $ILLlIII =array(I8470 => $aItem[I8470], I8223 => $aItem[I8223]); $aExtData =Array(I8275=>"get_dataset_field_types_count", I8221=>0, I8293=>&$ILLlIII, I8314=>&$IL1ILLl); $this->TTT1lI1($aExtData); if($IL1ILLl["props"] >0) $this->oEshop->TITTT11(); $this->_getSubItemCB($aProduct, $aData); if($IL1ILLl["props"] >0) $this->oEshop->TITTITT(); if(isset($this->I1IL1Ll["extData"][I8332][I8471]) && is_array($this->I1IL1Ll["extData"][I8332][I8471]) && $this->I1IL1Ll["extData"][I8332][I8471][I8453] == I8461){ $null =array(); $this->I1IL1Ll["extData"][I8332][I8471][I8337]->{$this->I1IL1Ll["extData"][I8332][I8471][I8472]}($aProduct, $null); }if(isset($aProduct["adv_place"])){ if($IIllLII) $this->TTT111l(array_merge($aProduct, array(I8334 => $aItem[I8334])), "adv", $aProduct[I8221]); else unset($aProduct["adv_place"]); }$aProduct =array_merge($aProduct, $lIIL1lL); unset($lIIL1lL); $aProduct =$this->cms->ApplyNav($aProduct); $aItem[I8376] .= $this->cms->TTITI1l("cat_item", I8473, $aProduct); if ($k >0 && $k != $numRows){ if((($k %$this->I1IL1Ll[I8357]) == 0)) {$aItem[I8376] .= $this->cms->TTITI1l("cat_item", "Vsplitter", $aItem); }elseif($k >= 1) {$aItem[I8376] .= $this->cms->TTITI1l("cat_item", "Hsplitter", $aItem); }if($this->I1IL1Ll[I8474] && $k%$this->I1IL1Ll[I8474] == 0 ){$aItem[I8376] .= $this->cms->TTITI1l("cat_item", "nSplitter", I8215); }}}unset($this->oEshop->ILlL1l1[I8376]); $aItem["cat_items"] =$this->cms->TTITI1l("cat_item", I8446, $aItem); }$this->TTTlll1($this->oEshop->ownerName.I8475); $aEvent =array( I8467 => $this->moduleName, 'aItem' => &$aItem, I8466 => &$aData, I8369 => $this );AMI_Event::fire('v5_on_after_get_eshop_category_items', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); }function _getSubCategoryRowCB(&$aItem, &$aData) {$aEvent =array( I8467 => $this->moduleName, 'aItem' => &$aItem, I8466 => &$aData, I8369 => $this );AMI_Event::fire('v5_on_before_get_eshop_subcategory', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); $aCatsNames =&$this->I1IL1Ll[I8358][$aItem[I8221]]; $lIIL1l1 =I8215; $numCats =sizeof($aCatsNames); $aItem["cat_subcategory_list"] =I8215; if($numCats) {$IIllLII =$this->TTT11ll(); $lIIL1LI =$this->oEshop->ILlLLLL->GetOption("sub_splitter_period"); $aTmp["simple_prefix"] ="cat_"; for($i=0;$i<$numCats;$i++) {$aCatData =Array(); $aCatData[I8221] =$aCatsNames[$i]; $aCatData[I8242] =$aCatsNames[$i][I8242]; $aCatData["picture"] =isset($aCatsNames[$i][I8476]) ?$aCatsNames[$i][I8476] :null; $aCatData["small_picture"] =isset($aCatsNames[$i]["small_picture"]) ?$aCatsNames[$i]["small_picture"] :null; $aCatData["popup_picture"] =isset($aCatsNames[$i][I8477]) ?$aCatsNames[$i][I8477] :null; $aCatData["cat_level"] =$aCatsNames[$i][I8240]; $aCatData[I8360] =$this->lIII1Ll +$aCatsNames[$i][I8240] +1; $vNavData[I8212] =$aCatsNames[$i][I8221]; $vNavData[I8277] =$aCatsNames[$i]['sublink']; $vNavData =$this->cms->ApplyNav($vNavData); $IIlLIIL =Array(I8275=>I8344, I8293=> $_data =array(&$aCatData, &$aTmp)); $this->TTT1lI1($IIlLIIL, array(I8382)); if(isset($aCatsNames[$i][I8347])){ if($IIllLII) $this->TTT111l($aCatData, "cat_adv", $aCatsNames[$i][I8221]); else unset($aCatsNames[$i][I8347]); }if($this->oEshop->itemCountersEnable) {$aCatData["count_subcat_items"] =$aCatsNames[$i]["count_public_childs"]; $aCatData["count_subcat_items"] =$this->cms->TTITI1l(I8346, "count_subcat_items", $aCatData); }if($this->lIII1LL) {$aCatData["announce"] =$aCatsNames[$i]["announce"]; $aCatData[I8478] =$this->cms->TTITI1l(I8346, "subcategory_announce", $aCatData); }$aCatData += $vNavData; $lIIL1l1 .= $this->cms->TTITI1l(I8346, "subcategory", $aCatData); if($lIIL1LI) {if(($i+1)%$lIIL1LI == 0 && ($i+1) != $numCats) {$lIIL1l1 .= $this->cms->TTITI1l(I8346, "sub_nSplitter", I8215); }}}$aItem["cat_subcategory_list"] =$this->cms->TTITI1l(I8346, I8479, Array(I8479=>$lIIL1l1)); }$aEvent =array( I8467 => $this->moduleName, 'aItem' => &$aItem, I8466 => &$aData, I8369 => $this );AMI_Event::fire('v5_on_after_get_eshop_subcategory', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); }function _getItemCB(&$aItem, &$aData) {$this->__getItemCB($aItem, $aData); }function _getSubItemCB(&$aItem, &$aData) {$this->__getItemCB($aItem, $aData); }function __getItemCB(&$aItem, &$aData) {$aEvent =array( I8467 => $this->moduleName, 'aItem' => &$aItem, I8466 => &$aData, I8369 => $this );AMI_Event::fire('v5_on_before_get_eshop_item', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); $vNavData[I8480] =$aItem[I8221]; $aItem['cat_has_props'] =0; if(isset($aItem[I8380]) && isset($this->lIIllII[$aItem[I8380]])){ $vNavData[I8273] =$aItem[I8380]; $vNavData[I8469] =$this->lIIllII[$aItem[I8380]]['sublink']; $aItem['cat_has_props'] =$this->lIIllII[$aItem[I8380]]['cat_has_props']; }else{ $vNavData[I8273] =$this->I1IL1Ll[I8481]; $vNavData[I8469] =$this->I1IL1Ll['parentCatSublink']; $aItem['cat_has_props'] =$this->I1IL1Ll['catHasProps']; }$vNavData =$this->cms->ApplyNav($vNavData); $aItem =array_merge($aItem, $vNavData); if(is_array($this->I1IL1Ll[I8468])){ $aItem += $this->I1IL1Ll[I8468]; }$aItem[I8360] =$this->lIII1Ll; $aItem += $aData[I8340]; if ($this->lIII1IL) {if (!isset($aItem["id_discount"])) {if(isset($this->lIIllII[$aItem[I8380]])) {$aItem[I8482] =$this->lIIllII[$aItem[I8380]]['id_discount']; }else if(isset($this->I1IL1Ll[I8356]) && isset($this->I1IL1Ll[I8356][$aItem[I8380]])) {$aItem[I8482] =$this->I1IL1Ll[I8356][$aItem[I8380]]['id_discount']; }else {$aItem[I8482] =$this->lIII1LI[I8482]; }}if(isset($this->lIIllII[$aItem[I8380]])) {$aItem['dataset_id'] =$this->lIIllII[$aItem[I8380]]['dataset_id']; }else {$aItem[I8483] =$this->lIII1LI[I8483]; }}$this->oEshop->getItemCB($aItem, $aData); $aEvent =array( I8467 => $this->moduleName, 'aItem' => &$aItem, I8466 => &$aData, I8369 => $this );AMI_Event::fire('v5_on_after_get_eshop_item', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); }function _getItemSearchCB(&$aItem, &$aData) {$aEvent =array( I8467 => $this->moduleName, 'aItem' => &$aItem, I8466 => &$aData, I8369 => $this );AMI_Event::fire('v5_on_before_get_eshop_search_item', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); extract($this->I1IL1Ll); $ILLll11 =$vNavData =Array(); $IL1ILLl =array(); $ILLlIII =array(I8470 => $aItem[I8470], I8223 => $aItem[I8223]); $aExtData =Array(I8275=>"get_dataset_field_types_count", I8221=>0, I8293=>&$ILLlIII, I8314=>&$IL1ILLl); $this->TTT1lI1($aExtData); if($IL1ILLl["props"] >0) $this->oEshop->TITTT11(); $vNavData[I8480] =$aItem[I8221]; $vNavData[I8212] =$aItem[I8436]; $vNavData[I8277] =$aItem["cat_sublink"]; $vNavData =$this->cms->ApplyNav($vNavData); $aItem[I8371] =$this->cms->TTITI1l("search_item", I8371, ($aItem["row_index"] +1 +$this->browser->Position)); $aItem =array_merge($aItem, $vNavData); $aItem[I8484] =$addParams; $aItem["base_price"] =$this->oEshop->TITTITI($aItem, $aItem, "search_item", "search_item"); $aItem["other_prices"] =$this->oEshop->TITTITl($aItem, $aItem, I8485, I8485, "other_price"); $vNavData[I8221] =$aItem[I8221]; $vNavData["id_sublink"] =$aItem[I8351]; $vNavData =$this->cms->ApplyNav($vNavData); $aItem =array_merge($aItem, $vNavData); if($this->oEshop->mEshop->GetOption("show_detail_link") || !$aItem["descr_empty"]) {$aItem[I8242] =$this->cms->TTITI1l(I8486, "name_link", $aItem); }$vNavData =Array(); $vNavData[I8212] =$aItem[I8436]; $vNavData[I8277] =$aItem["cat_sublink"]; $vNavData =$this->cms->ApplyNav($vNavData); $aCat =array_merge($aItem, $vNavData); $aItem[I8366] =$this->cms->TTITI1l(I8486, "catname_link", $aCat); $this->oEshop->TT1111T($this->I1IL1Ll[I8372], $aItem, $aItem); if($IL1ILLl["props"] >0) $this->oEshop->TITTITT(); $aEvent =array( I8467 => $this->moduleName, I8487 => &$aItem, I8466 => &$aData, I8369 => $this );AMI_Event::fire('v5_on_after_get_eshop_search_item', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); }function _getPathFrontCB(&$res, $itemId, $itemName, $stripItemName, &$Il11L1l) {$aEvent =array( I8467 => $this->moduleName, 'itemId' => $itemId, 'itemName' => &$itemName, 'aResData' => &$res, I8488 => &$stripItemName, I8285 => &$Il11L1l, I8369 => $this );AMI_Event::fire('v5_on_before_get_eshop_path_front', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); $tmp =I8215; $level =intval($this->lIII1Ll); if($Il11L1l["skip_item"]) {$tmp =$this->cms->Gui->getAbs($this->moduleName."_list:cat_skip_item", Array(I8242=>$stripItemName, I8240=>$level)); }else {if($Il11L1l["is_current"] && $this->id <= 0) {if($itemId != $this->oEshop->rootCatId || $this->oEshop->ILlLLLL->GetOption(I8489)) {$tmp =$this->cms->Gui->getAbs($this->moduleName."_list:cat_name", Array(I8221=>$itemId, I8242=>$stripItemName, "alt" =>$itemName, I8240=>$level)); }}else {$vNavData[I8212] =$itemId; $vNavData[I8277] =$Il11L1l["record"][I8351]; $vNavData =$this->cms->ApplyNav($vNavData); $tmp =$this->cms->Gui->getAbs($this->moduleName."_list:cat_nav_name", Array(I8221=>$itemId, I8242=>$stripItemName, I8490=>$itemName, I8240=>$level) +$vNavData); }}if($itemId != $this->oEshop->rootCatId && !empty($tmp) ){$res .= ($this->cms->TTITI1l("cat", "Hsplitter", array(I8240=>$level))).$tmp; }else {$res .= $tmp; }$this->lIII1Ll++; $aEvent =array( I8467 => $this->moduleName, 'itemId' => $itemId, 'itemName' => &$itemName, I8491 => &$res, I8488 => &$stripItemName, I8285 => &$Il11L1l, I8369 => $this );AMI_Event::fire('v5_on_after_get_eshop_path_front', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); return true; }function _priceRow(&$aItem, &$aData) {$aItem["calc_price"] =I8215; if($aItem[I8245] != I8215) {$price =$aItem[I8245]; $aItem[I8245] =$this->oEshop->formatNumber($price, false); $price =$this->oEshop->formatNumber($price, false, true); if($this->lIIIL1l) {$aPrice =$this->oEshop->calcPrice( $price, 0, $aItem["tax"], $aItem[I8228], $aItem[I8231], $aItem["discount"], $aItem[I8230], $this->oEshop->baseCurrency, I8215, true, array (I8492 => I8493, I8482 => $aItem[I8482] ),array( "tax_class_type" => $aItem["tax_class_type"], "id_tax_class" => $aItem["id_tax_class"] ));if($aPrice[I8249] != $price) {$aItem[I8494] =$this->oEshop->formatNumber($aPrice[I8249], false); $aItem[I8494] =$this->cms->Gui->get($this->moduleName."_list:calc_price", $aItem); }}}else {$price ="undefined"; if($aItem[I8394] != "eshop_account") $aItem[I8245] =$this->words["empty_price"]; else $aItem[I8245] =$this->words["variable_price_list"]; }$lIIlLII =Array(); $lIIlLII[I8221] =I8210.$aItem[I8221].I8210; $lIIlLII[I8245] =$price; $lIIlLII["price_mask"] =$aItem["price_mask"]; $lIIlLII["public"] =$aItem["public"]; $lIIlLII[I8242] =I8210.jparse($aItem[I8242]).I8210; $lIIlLII[I8432] =I8210.jparse($aItem[I8432]).I8210; $lIIlLII[I8371] =$aItem[I8495]; $aData["script_base_prices"] .= $this->cms->Gui->get($this->moduleName."_list:script_base_prices_row", $lIIlLII); $aData["row_number"] =$aItem[I8495] +1; $this->oEshop->TT1111T($aItem, $aData); }function _otherPriceRow(&$aItem, &$aData) {$lIIL1Ll =I8215; $lIIL1LL =Array(); $mask =1; $numPrices =$this->oEshop->numPrices; for($j=0;$j<$numPrices;$j++) {$Il111lI =Array(); $aPrice =Array(); $numPrice =$this->oEshop->priceFields[$j]; $price =$aItem[I8245.$numPrice]; if($price != I8215) {$lIIL1L1 =$price; $ILLl11L =$aItem[I8239.$numPrice]; if(isset($aItem[I8419.$numPrice]) && $aItem[I8419.$numPrice] != I8215 && $this->oEshop->issetCurrency($aItem[I8419.$numPrice])){ $ILLl11L =$aItem[I8419.$numPrice]; }else{ $price =$this->oEshop->TT11Tll($price, $aItem[I8239.$numPrice]); }if(!($aItem["price_mask"] &$mask)) {$lIIL1L1 =$price; }$lIIL1LL[] =$this->oEshop->formatNumber($lIIL1L1, false, true); $Il111lI[I8245] =$this->oEshop->formatMoney($price, $ILLl11L, true, false); $price =$this->oEshop->formatNumber($price, false, true); if($this->lIIIL1l) {$aPrice =$this->oEshop->calcPrice( $aItem[I8245.$numPrice], $numPrice, $aItem[I8496], $aItem[I8228], $aItem[I8231], $aItem["discount"], $aItem[I8230], $aItem[I8239.$numPrice], $aItem[I8419.$numPrice], true, array (I8482 => $aItem[I8482] ),array( "tax_class_type" => $aItem["tax_class_type"], "id_tax_class" => $aItem[I8497] ));if($aPrice[I8249] != $price) {$Il111lI[I8494] =$this->oEshop->formatMoney($aPrice[I8249], $aItem[I8239.$numPrice], true, false); $Il111lI[I8494] =$this->cms->Gui->get($this->moduleName."_list:calc_other_price", $Il111lI); }}}else {$Il111lI[I8245] =$this->words["empty_price"]; $lIIL1LL[] ="undefined"; }$lIIL1Ll .= $this->cms->Gui->get($this->moduleName."_list:other_price", $Il111lI); $mask =$mask << 1; }$aData[I8498] .= $this->cms->Gui->getAbs($this->moduleName."_list:script_prices_row", Array(I8371=>$aItem[I8495], "values"=>(implode(I8417, $lIIL1LL)))); $aPriceData["style"] =$aItem["style"]; $aPriceData[I8499] =$lIIL1Ll; $aItem["other_prices_col"] =$this->cms->Gui->get($this->moduleName."_list:other_prices_col", $aPriceData); }function _treeArrayCB(&$II11L1l, &$record, &$Il11L1l) {$II11L1l[] =Array(I8221=>$record[I8221], I8242=>$record[I8242]); }function _buildTreeOnChildsArrayCB(&$res, &$child, &$Il11L1l) {if($this->I1IL1Ll["is_childs"]) {if($this->I1IL1Ll[I8240] >$Il11L1l[I8240]) {$this->I1IL1Ll["is_childs"] =false; $this->I1IL1Ll[I8500] =true; }else {$res["childs"] .= "<option value=\"".$child[I8221]."\">".str_repeat("&middot;&nbsp;", $Il11L1l[I8240] -$this->I1IL1Ll[I8240]).$this->cms->stripLine($child[I8242], 30, true); }}elseif(($this->I1IL1Ll[I8241] == $Il11L1l[I8501]) || $res["selected_id"] == $child[I8221]) {$this->I1IL1Ll['is_childs'] =($res['selected_id'] == $child[I8290]); if ($this->I1IL1Ll['is_childs']) {$this->I1IL1Ll[I8240] =$Il11L1l[I8240]; }$res[I8502] .= '<option value="'.$child[I8290] .'"' .($this->I1IL1Ll['is_childs'] ?' selected' :I8287) .I8503 .$this->cms->stripLine($child[I8322], 30, true); }$indent =str_repeat("&middot;&nbsp;", $Il11L1l[I8240]); $res[I8226] .= "<option value=\"".$child[I8221]."\"".(($res["selected_id"] == $child[I8221])?I8504:I8215).">".$indent.$this->cms->stripLine($child[I8242], 50, true); $res[I8243][] =Array(I8221=>$child[I8221], I8242=>($indent.$this->cms->stripLine($child[I8242],60))); return true; }function __buildTreeOnChildsArrayCB(&$res, &$child, &$Il11L1l) {$indent =str_repeat("&middot;&nbsp;", $Il11L1l[I8240]); $res .= "<option value=\"".$child[I8221]."\"".I8505.$indent.$this->cms->stripLine($child[I8242], 50, true); return true; }function __buildTreeOnChildsArrayOptCB(&$res, &$child, &$Il11L1l) {$indent =str_repeat("&middot;&nbsp;", $Il11L1l[I8240]); $res["catList"][] =array( I8242 => $child[I8221], "caption" => $indent.$this->cms->stripLine($child[I8242], 50, true), I8237 => (($res["selectedCatId"] == $child[I8221]) ?I8237 :I8215) );return true; }function _getPathCB(&$res, $itemId, $itemName, $stripItemName, &$Il11L1l) {if($Il11L1l[I8506]) {$res .= $this->cms->Gui->getAbs($this->moduleName."_list:path_skip_item".($this->lIIlI1l ?'_itemLink' :I8287), Array("title"=>$stripItemName)); }else {if($Il11L1l["is_current"]) {$res .= $this->cms->Gui->getAbs($this->moduleName."_list:path_item_current".($this->lIIlI1l ?'_itemLink' :I8287), Array(I8221=>$itemId, "title"=>$stripItemName, I8490 =>$itemName)); }else {$res .= $this->cms->Gui->getAbs($this->moduleName."_list:path_item_link".($this->lIIlI1l ?'_itemLink' :I8287), Array(I8221=>$itemId, I8507=>$stripItemName, I8490=>$itemName)); }}return true; }function _extGetModulesListCB(&$result, $modName, &$ILLIllL, &$Il11L1l) {$result =$this->filter->TITI1TT($result, Array($this->words[$modName."_title"]=>$modName)); }function TIIlITl(&$db2, &$aItems, &$lIILIlL) {$aProduct =array(); $catId =-1; while($db2->next_record()) {if($catId != $db2->Record[I8402]) {$aItems[$catId.I8215] =$aProduct; $aProduct =Array(); $catId =$db2->Record[I8402]; }$aProduct[] =Array(I8212 => $catId, I8277 => $lIILIlL[$catId]) +$db2->Record; $oldCatId =$db2->Record[I8402]; }$aItems[$oldCatId.I8215] =$aProduct; }function TIIlIT1($parentId, $cMaxLevel =0, $cBranchItems =Array()) {$aEvent =array( I8467 => $this->moduleName, I8501 => &$parentId, 'maxLevel' => &$cMaxLevel, 'aBranchItems' => &$cBranchItems, I8369 => $this );AMI_Event::fire('v5_on_before_get_eshop_subcats', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); $I1LIlLl =$this->isSmallMode && in_array(I8508, $this->lIIlILI); $this->TTITTTI('push'); $this->oEshop->tree->addFilter(I8509, "1 ".$this->_ApplyFilters('c', I8287, !$I1LIlLl)); $this->TTITTTI('pop'); $result =Array(I8510=>$parentId, "cMaxLevel"=>$cMaxLevel, "cBranchItems"=>$cBranchItems, "res"=>Array()); $this->oEshop->tree->sqlOrderEnable(); $this->oEshop->tree->initResult($result); if ($I1LIlLl) {$this->oEshop->tree->TlTTTTI('urgent DESC'); }$res =$this->oEshop->tree->TI11lI1($parentId, I8511); $res =$this->oEshop->tree->buildTreeOnChildsArray($parentId); $this->oEshop->tree->sqlOrderDisable(); $this->oEshop->tree->TI11I1I(I8509); $aEvent =array( I8467 => $this->moduleName, I8501 => &$parentId, 'maxLevel' => &$cMaxLevel, 'aBranchItems' => &$cBranchItems, I8491 => &$res, I8369 => $this );AMI_Event::fire('v5_on_after_get_eshop_subcats', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); return $res["res"]; }function filterChildBranchCB(&$res, &$record, &$Il11L1l) {$condition =($res[I8512] == 0); $condition =$condition || ($res[I8512] >0 && $res[I8512] >($Il11L1l[I8240] +1)); $aEvent =array( I8467 => $this->moduleName, 'result' => &$condition, I8466 => &$res, I8286 => &$record, I8285 => &$Il11L1l, I8369 => $this );AMI_Event::fire('v5_on_filter_eshop_child_branch', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); return $condition; }function filterSpecChildBranchCB(&$res, &$record, &$Il11L1l) {$condition =$this->filterChildBranchCB($res, $record, $Il11L1l); $condition =$condition || in_array($record[I8221], $res["cBranchItems"]); $aEvent =array( I8467 => $this->moduleName, 'result' => &$condition, I8466 => &$res, I8286 => &$record, I8285 => &$Il11L1l, I8369 => $this );AMI_Event::fire('v5_on_filter_eshop_spec_child_branch', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); return $condition; }function _getSpecSubCatsCB(&$res, &$record, &$Il11L1l) {$condition =$res[I8512] == 0 || ($res[I8512] >0 && $res[I8512] >($Il11L1l[I8240] +1)); if($condition || in_array($record[I8221], $res["cBranchItems"])) {$res["res"][] =$record +Array(I8240=>$Il11L1l[I8240]); }$aEvent =array( I8467 => $this->moduleName, 'result' => &$condition, I8466 => &$res, I8286 => &$record, I8285 => &$Il11L1l, I8369 => $this );AMI_Event::fire('v5_on_get_eshop_spec_path_sub_cats', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); return ($condition || in_array($record[I8513], $res["cBranchItems"])); }function _getSubCatsCB(&$res, &$record, &$Il11L1l) {$lIIL11I =false; if(($res[I8512] == 0 || ($res[I8512] >0 && $res[I8512] >($Il11L1l[I8240] +1)))) {$res["res"][] =$record +Array(I8240=>$Il11L1l[I8240]); $lIIL11I =($record[I8221] != $res[I8510]); }else {$lIIL11I =false; }$aEvent =array( I8467 => $this->moduleName, 'result' => &$lIIL11I, I8466 => &$res, I8286 => &$record, I8285 => &$Il11L1l, I8369 => $this );AMI_Event::fire('v5_on_get_eshop_path_sub_cats', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); return $lIIL11I; }function _getNodeRecordCB(&$res, &$record, &$Il11L1l) {$res =$record; }function TTT1lTl($IIl1II1, &$record, &$vData, &$aData) {parent::TTT1lTl($IIl1II1, $record, $vData, $aData); switch($IIl1II1) {case I8514: if($this->lIIlIIl){ $this->oEshop->TITTT11(); }if(isset($vData['nav_data'])){ $this->I1IL1Ll[I8326] =$vData['nav_data']; }$vData[I8480] =$vData[I8221]; $aData[I8360] =$vData[I8360] =$this->lIII1Ll; $vData[I8484] =I8373.$this->offset."&catoffset=".$this->catOffset; $vData += $this->lIII1I1; $vData["base_price"] =$this->oEshop->TITTITI($vData, $vData, I8515, I8515); $vData["other_prices"] =$this->oEshop->TITTITl($vData, $vData, I8515, I8515, "other_price"); $vData["item_header"] =$this->cms->TTITI1l(I8515, I8410, $record[I8242]); $lIIL11l =$record["ext_popup_picture"]; if(!empty($lIIL11l)) {$IL1LIl1[I8476] =$GLOBALS[I8516].$lIIL11l; $IL1LIl1[I8507] =$record[I8242]; $size =imageGetSize($GLOBALS['ROOT_PATH'] .$lIIL11l); $IL1LIl1['width'] =$IL1LIl1['picture_width'] =$size[0]; $IL1LIl1['height'] =$IL1LIl1[I8517] =$size[1]; $vData["big_picture"] =$this->cms->TTITI1l(I8515, "big_picture", $IL1LIl1); }$this->oEshop->TT1111T(I8514, $record, $vData); if($this->lIIlIIl) $this->oEshop->TITTITT(); break; }}function TIIlIIT() {$aSql =Array(); $tax =$this->oEshop->mEshop->GetOption("tax_default"); $aSql[I8496] =doubleval($tax); $aSql[I8228] =(mb_strpos($tax, "%") !== false) ?I8235 :I8518; if($this->cms->Core->IsInstalled($this->oEshop->ownerName.I8202)){ $aSql[I8231] =$this->cms->Core->GetModOption($this->oEshop->ownerName.I8202, I8231); }else{ $aSql[I8231] =$this->oEshop->mEshop->GetOption('charge_tax_type'); }$lIIL11L =$this->oEshop->mEshop->GetOption(I8236); $aSql[I8233] =doubleval($lIIL11L); $aSql[I8229] =(mb_strpos($lIIL11L, "%") !== false) ?I8235 :I8518; $lIIL111 =$this->oEshop->mEshop->GetOption(I8238); $aSql["discount"] =doubleval($lIIL111); $aSql[I8230] =(mb_strpos($lIIL111, "%") !== false) ?I8235 :I8518; return $aSql; }function TTT1Tl1($cType, $cModule, $condition =I8287){ if($this->ILLIIIL){ $sql =I8519.$this->oEshop->dbTablePrefix."_items set letter = substring(name, 1, 1)"; $this->db->query($sql); $this->lIIlIII->TTT1Tl1($cType, $cModule, $condition); }parent::TTT1Tl1($cType, $cModule, $condition); }function TIIlIII($cId, $lII1III, $lII1IIl =I8215, $cLang ="en", $lII1IIL =false){ $lII1II1 =$lII1IIl; $lII1IlI =false; if(!$lII1IIL){ $sql ="select i.public as i_pub, i.lang as i_lang, i.letter as i_letter, c.public as c_pub from ".$this->oEshop->dbTablePrefix."_items i LEFT JOIN ".$this->oEshop->dbTablePrefix."_cats c ON i.id_category=c.id WHERE i.id=".intval($cId); $this->db->query($sql); if($this->db->next_record()){ $lII1IlI =($this->db->Record[I8393] ?1 :0) &($this->db->Record[I8423] ?1 :0); $cLang =$this->db->Record["i_lang"]; $lII1IIl =$this->db->Record[I8429]; }}if(mb_strlen($lII1II1) != 1) $lII1II1 =$lII1IIl; if(!$lII1III && $lII1IlI) $this->lIIlIII->TIIllI1($lII1IIl, 1, $cLang); else if($lII1III && !$lII1IlI) $this->lIIlIII->TIIllI1($lII1II1, -1, $cLang); else if($lII1II1 != $lII1IIl && $lII1III && $lII1IlI){ $this->lIIlIII->TIIllI1($lII1II1, -1, $cLang); $this->lIIlIII->TIIllI1($lII1IIl, 1, $cLang); }}function TIIlIIl(){ $lII1Ill =$this->filter->GetFieldValue(I8304); $retVal =I8215; if($this->ILLIIIL && mb_strlen($lII1Ill) == 1){ if($this->cms->Core->GetModOption($this->oEshop->ownerName."_letters", "case_sensitive")) $retVal =" AND i.letter like binary '".addslashes($lII1Ill).I8210; else $retVal =" AND (i.letter like binary '".addslashes(mb_strtolower($lII1Ill))."' OR i.letter like binary '".addslashes(mb_strtoupper($lII1Ill)).I8331; }return $retVal; }function TIIlII1($cId){ $data =array("details" => I8215); if(!empty($this->cms->VarsGet["field"])){ if(mb_strpos($this->cms->VarsGet["field"], I8520) !== false || mb_strpos($this->cms->VarsGet["field"], "prop") !== false){ $data["details"] =$this->cms->VarsGet["field"]; $IIlLIIL =Array(I8275=>I8521, I8221=>0, I8293=>&$data); $this->TTT1lI1($IIlLIIL); }}$data["metas"] =$this->cms->Gui->getMetas(); global $conn; print $this->cms->Gui->get($this->module->GetName()."_list:details", $data); $this->cms->Core->Cache->pageIsComplitedForSave =true; $conn->Out(); die(); }function TIIlIlT($cId){ $data =array("details" => I8215); if(!empty($this->cms->VarsGet["field"])){ if(mb_strpos($this->cms->VarsGet[I8522], I8520) !== false && $this->cms->VarsGet["ref_id"] >0){ $data["details"] =$this->cms->VarsGet[I8522]; $data["ref_id"] =$this->cms->VarsGet["ref_id"]; $IIlLIIL =Array(I8275=>I8523, I8221=>0, I8293=>&$data); $this->TTT1lI1($IIlLIIL); }}$data["metas"] =$this->cms->Gui->getMetas(); global $conn; print $this->cms->Gui->get($this->module->GetName()."_list:details", $data); $conn->Out(); die(); }function TTT1II1(&$db, &$aParams) {$aVars =parent::TTT1II1($db, $aParams); foreach($this->aCustomFields as $field){ if(isset($this->cms->VarsPost[$field])){ $aVars[$field] =$this->cms->VarsPost[$field]; }}if(!$this->oEshop->itemCountersEnable){ $sql ="SELECT all_parents FROM ".$this->oEshop->dbTablePrefix."_cats WHERE id='".$this->catId.I8398.$this->langData.I8210; $this->db->query($sql); if($this->db->next_record()) {$this->I1IL1Ll[I8524] =$this->db->Record["all_parents"]; $len =mb_strlen($this->I1IL1Ll[I8524]); $this->I1IL1Ll[I8524] =trim(mb_substr($this->I1IL1Ll[I8524], 1, $len -2) .',' .$this->catId, ','); }}$aVars += $this->oEshop->TT111lI($db, I8215, $aVars["splitter"], trim($this->I1IL1Ll[I8524],I8525)); return $aVars; }function TIIIT1I($optionName, $I1LLLll, $aCustom, $callback =I8215) {$count =$this->module->GetOption($optionName); if ($count <0) {if (isset($I1LLLll[I8267]) && !is_array($I1LLLll[I8267])) {$I1LLLll[I8267] =(array)$I1LLLll[I8267]; }if (isset($I1LLLll[I8268])) {$I1LLLll[I8267][] =$I1LLLll[I8268]; }}elseif ($count >0) {$I1LLLll["limit"] =$count; }$sql ="SELECT " .$I1LLLll[I8266] .(isset($I1LLLll[I8268]) ?", " .$I1LLLll[I8268] ." AS `selected` " :I8215) .I8244 .$I1LLLll[I8310] .I8262 .(isset($I1LLLll[I8267]) ?I8350 .(is_array($I1LLLll[I8267]) ?I8449 .implode(I8526, $I1LLLll[I8267]) .I8252 :$I1LLLll[I8267]) :I8215 ).(isset($I1LLLll["order"]) ?" ORDER BY " .$I1LLLll["order"] :I8215) .(isset($I1LLLll["limit"]) ?I8527 .$I1LLLll["limit"] :I8215) .(isset($I1LLLll["tail"]) ?I8262 .$I1LLLll["tail"] :I8215); $this->db->query($sql); $aList =array ();while ($this->db->next_record()) {if (method_exists($this, $callback)) {$this->$callback($this->db->Record); }$aList[] =$this->db->Record; }if ($count <0 && count($aList) >0) {$aCustom += $aList[0]; }return $this->TTT1lIT($aList, $count, $aCustom); }function TTT1T1T(&$aIds, $cModule){ if($this->filter->issetField('flt_type')) {$this->filter->UpdateFieldDBName(I8528, 'p.item_type'); parent::TTT1T1T($aIds, $cModule); $this->filter->UpdateFieldDBName(I8528, 'i.item_type'); }}function TTT1IlT(&$aVars){ $this->aCustomFields =array(); $IIlLIIL =array(I8453 => 'get_titles', I8290 => 0, 'item_data' => I8287, I8529 => I8287, 'custom' => &$this->aCustomFields); $this->TTT1lI1($IIlLIIL); $aEvent =array( I8467 => $this->moduleName, I8466 => &$aVars, I8369 => $this );AMI_Event::fire('v5_on_generate_eshop_item_keywords', $aEvent, AMI_Event::MOD_ANY); unset($aEvent); parent::TTT1IlT($aVars); }function TTT1TTT(&$aGroupIds, $cModule){ $extModId ='ext_' .$this->oEshop->ownerName .'_custom_fields'; if(isset($this->ext[$extModId]) && $this->cms->Core->IsInstalled($extModId)){ $this->TIIllIl(); $catId =(int)$this->catId; if($catId){ $sql ="SELECT `dataset_id`, `dataset_data` " ."FROM `" .$this->oEshop->dbTablePrefix ."_cats` " ."WHERE `id` = " .$catId; }else{ $sql ="SELECT c.`dataset_id`, c.`dataset_data` " .I8530 .$this->oEshop->dbTablePrefix .'_datasets` d ' ."INNER JOIN `" .$this->oEshop->dbTablePrefix ."_cats` c ON c.`dataset_id` = d.`id` " ."WHERE d.`lang` = '" .$this->langData ."' AND d.`is_sys` = 1 " ."LIMIT 1"; }$aRecord =$this->db->getRecord($sql); if($aRecord){ $IL1ILLl =array(); $IIlLIIL =array(I8453 => 'set_dataset', I8290 => 0, 'item_data' => &$aRecord, 'custom' => &$IL1ILLl); $this->TTT1lI1($IIlLIIL); $this->aCustomFields =array(); $IIlLIIL =array(I8453 => I8531, I8290 => 0, 'item_data' => I8287, I8529 => I8287, 'custom' => &$this->aCustomFields); $this->TTT1lI1($IIlLIIL); }}$aIds =$aGroupIds; parent::TTT1TTT($aGroupIds, $cModule); if($this->lIIlI1I && sizeof($aIds)){ $aIds =iterator_to_array( AMI::getSingleton('db') ->fetchCol( DB_Query::getSnippet( "SELECT `id` " .I8530 .$this->oEshop->dbTablePrefix .I8532 ."WHERE `id` IN (%s) AND `links_count`" )->implode($aIds, TRUE) ));foreach($aIds as $id){ $this->TIIlIl1($id, 'sm_data'); }}}function TTT1TTI(&$IIl1ll1, $prefix){ $IIl1ll1['select'] .= ", CONCAT(c.all_parents, ',', " .$prefix ."id_category) all_parents"; if(sizeof($this->aCustomFields)){ $IIl1ll1['select'] .= ', ' .implode(', ', $this->aCustomFields); }$IIl1ll1['join'] .= I8533 .$this->oEshop->dbTablePrefix ."_cats c ON c.id = " .$prefix ."id_category "; }function TTT1TTl(&$record){ $this->I1IL1Ll['parentsID'] =str_replace(',,', I8525, $record[I8534]); foreach($this->aCustomFields as $field){ if(array_key_exists($field, $record)){ $this->cms->VarsPost[$field] =$record[$field]; }}}function _popupBuildTreeOnChildsArrayCB(&$res, &$child, &$Il11L1l) {if($res["selected_id"] == $child[I8221]) {return false; }$indent =str_repeat("&middot;&nbsp;", $Il11L1l[I8240]); $res["cat_select"] .= "<option value=\"".$child[I8221].I8535.$indent.$this->cms->stripLine($child[I8242], 50, true); return true; }function TIIlIlI($cId) {$form =Array(); $form[I8221] =$cId; $I1L1l1l =Array(); $I1L1l1L =I8215; $this->oEshop->tree->setCallbackMethod("buildTreeOnChildsArray", "_popupBuildTreeOnChildsArrayCB"); $this->oEshop->tree->createChildsArrayFlt(I8242); $this->oEshop->tree->initResult(Array("cat_select"=>I8215, "selected_id"=>$cId)); $ILLILI1 =$this->oEshop->tree->buildTreeOnChildsArray(); $form[I8536] =$this->cms->Gui->getAbs($this->moduleName."_subform:links_popup_form", $form +$ILLILI1); $form[I8410] =$this->cms->Words["eshop_create_links"]; $form["form_align"] ="align=center"; $IILIIIL =I8537; parent::TTT1I1I($form, $IILIIIL); }function TIIlIll($id, $lII1IlL, $lII1Il1){ if(!$this->lIIlI1I){ return; }$lII1ILI =array(); $lII1ILl =array(); $aCatIds =array(); if(is_array($lII1Il1)){ $aCatIds =$lII1Il1; }else{ $lII1ILL =mb_split(I8525, $lII1Il1); for($i =0; $i <sizeof($lII1ILL); $i++){ $val =intval($lII1ILL[$i]); if($val >0 && $val != $lII1IlL){ $aCatIds[] =$val; }}}$lII1IL1 =array(); $sql ="SELECT id, id_category FROM ".$this->oEshop->dbTablePrefix."_items WHERE id_source=".$id; $this->db->query($sql); while($this->db->next_record()){ if($this->db->Record[I8380] != $lII1IlL){ $lII1IL1[$this->db->Record[I8380]] =$this->db->Record[I8290]; }}$IL1LIIL =0; if(sizeof($aCatIds) >0 || sizeof($lII1IL1) >0){ if(sizeof($aCatIds) >0){ $aData =array(); $sql ="SELECT * FROM ".$this->oEshop->dbTablePrefix."_items WHERE id=".$id; $this->db->query($sql); if($this->db->next_record(MYSQL_ASSOC)){ $aData =$this->db->Record; unset($aData[I8290]); unset($aData[I8380]); unset($aData[I8538]); unset($aData['id_external']); $aData['price_mask'] =0; $aData[I8392] =$id; $aData['links_count'] =0; }}foreach($lII1IL1 as $lII1I1I => $linkId){ if(!in_array($lII1I1I, $aCatIds)){ $lII1ILl[] =$linkId; $this->TIIlI1T($linkId); }else{ $this->TIIllTT($linkId, $aData); $IL1LIIL++; }}for($i =0; $i <sizeof($aCatIds); $i++){ if(!isset($lII1IL1[$aCatIds[$i]])){ $lII1I1l =$this->TIIlI11($aCatIds[$i], $aData); $lII1ILI[$lII1I1l] =$aCatIds[$i]; $IL1LIIL++; }}}if($this->lIIlI11){ if(sizeof($lII1ILI) >0){ $this->TIIllIT($id, $lII1ILI); }if(sizeof($lII1ILl) >0){ $this->TIIllII($lII1ILl); }}$sql ='update '.$this->oEshop->dbTablePrefix.'_items set id_source=0, links_count='.$IL1LIIL.' where id='.$id; $this->db->query($sql); }function TIIlIl1($itemId, $lII1I1L){ if(!$this->lIIlI1I){ return; }if(!is_array($lII1I1L)){ $aFields =array($lII1I1L); }else{ $aFields =$lII1I1L; }$sql ='select '.implode(I8525, $aFields).' from '.$this->oEshop->dbTablePrefix.'_items where id='.$itemId; $this->db->query($sql); if($this->db->next_record()){ $lII1I11 =array(); for($i =0; $i <sizeof($aFields); $i++){ $lII1I11[$aFields[$i]] =mysql_real_escape_string($this->db->Record[$aFields[$i]], $this->db->_dbLink); }if(sizeof($lII1I11) >0){ if(isset($lII1I11[I8539])){ $this->TIIllT1($itemId, 'modify', $lII1I11[I8539] == I8298); }$sql =$this->db->GenUpdateSQL($this->oEshop->dbTablePrefix.'_items', $lII1I11, 'where id_source='.$itemId); $this->db->query($sql); }}}function TIIlI1T($id){ $this->TIIllTl($this->db, $id, 'delete'); $sql =I8540.$this->oEshop->dbTablePrefix."_items WHERE id=".$id; $this->db->query($sql); }function TIIlI1I($id){ if(!$this->lIIlI1I){ return; }$lII1ILl =array(); $sql ="select id from ".$this->oEshop->dbTablePrefix."_items WHERE id_source=".$id; $this->db->query($sql); if($this->db->next_record()){ $lII1ILl[] =$this->db->Record[I8290]; }if(sizeof($lII1ILl) >0){ $this->TIIllII($lII1ILl); }$this->TIIllT1($id, 'delete'); $sql =I8540.$this->oEshop->dbTablePrefix."_items WHERE id_source=".$id; $this->db->query($sql); }function TIIlI1l(&$db, $id, $idCategory){ if(!$this->lIIlI1I){ return; }$sql ="select id from ".$this->oEshop->dbTablePrefix."_items WHERE id_source=".$id.' and id_category='.$idCategory; $db->query($sql); if($db->next_record()){ $itemId =$db->Record[I8290]; $this->TIIllTl($db, $itemId, 'delete'); $this->TIIllII(array($itemId)); $sql =I8540.$this->oEshop->dbTablePrefix.I8541.$itemId; $db->query($sql); }}function TIIlI11($catId, $aData){ $aData[I8380] =$catId; $aData[I8538] =$this->TTTl1TI(); $this->TIIllTI($aData); $sql =$this->db->GenInsertSQL($this->oEshop->dbTablePrefix.'_items', $aData); $this->db->query($sql); $itemId =$this->db->lastInsertId(); $this->TIIllTl($this->db, $itemId, 'add'); $aVars =array( 'original_sublink' => I8287, I8322 => $aData[I8322] );$aData['sublink'] =I8287; $this->TTT1Ill($aData, $itemId, $aVars, true, false); $lII1I11 =array(I8542 => $aData[I8542]); $sql =$this->db->GenUpdateSQL($this->oEshop->dbTablePrefix.'_items', $lII1I11, 'where id='.$itemId); $this->db->query($sql); return $itemId; }function TIIllTT($id, $aData){ $this->TIIllTl($this->db, $id, 'modify', $aData[I8539] == I8298); unset($aData[I8542]); $this->TIIllTI($aData); $sql =$this->db->GenUpdateSQL($this->oEshop->dbTablePrefix.'_items', $aData, I8543.$id); $this->db->query($sql); }function TIIllTI(&$aData){ foreach(array('announce', 'special_announce', 'description', 'sm_data') as $field){ $aData[$field] =addslashes($aData[$field]); }foreach($aData as $field => $value){ if((mb_substr($field, 0, 13) == I8544) && ($aData[$field] === null)){ $aData[$field] ='=|NULL'; }}}function TIIllTl(&$db, $itemId, $lII1lII ='modify', $lII1lIl =false){ if($this->oEshop->itemCountersEnable){ $catId =0; $sql ='select i.id, i.id_category, i.public, c.public as cat_public from '.$this->oEshop->dbTablePrefix.'_items i left join '.$this->oEshop->dbTablePrefix.'_cats c on c.id=i.id_category where i.id='.$itemId; $db->query($sql); if($db->next_record()){ $lII1lIL =$db->Record[I8539] == I8298; $lII1lI1 =$db->Record['cat_public'] == I8298; $catId =$db->Record[I8380]; }if($catId >0){ $type =I8287; $delta =I8287; if($lII1lI1 && ($lII1lIl != $lII1lIL || $lII1lIL && $lII1lII == 'add')){ if($lII1lIl || $lII1lII == 'add'){ $delta =I8406; }else{ $delta =I8389; }$type =I8539; }if($lII1lII == 'add' || $lII1lII == I8545){ if(empty($type)){ if($lII1lII == 'add'){ $delta =I8406; }else if($lII1lII == I8545){ $delta =I8389; }$type ='all'; }else{ $type ='both'; }}if(!empty($type)){ $aSql =$this->oEshop->TT11I1I($delta, $type); $this->oEshop->TT11I1l(); $this->oEshop->tree->TI11l11($catId, $aSql, true); $this->oEshop->TT11I11(); }}}}function TIIllT1($lII1llI, $lII1lII ='modify', $lII1lIl =false){ $db =$this->db->TTI1I1T(); $aItems =array(); $sql =I8546.$this->oEshop->dbTablePrefix.'_items where id_source='.$lII1llI; $db->query($sql); while($db->next_record()){ $aItems[] =$db->Record[I8290]; }for($i =0; $i <sizeof($aItems); $i++){ $this->TIIllTl($db, $aItems[$i], $lII1lII, $lII1lIl); }}function TIIllIT($id, $lII1ILI){ $db =$this->db->TTI1I1T(); $db2 =$this->db->TTI1I1T(); $sql ='select * from ' .$this->oEshop->dbTablePrefix .'_props where id_item=' .$id; $db->query($sql); while($db->next_record(MYSQL_ASSOC)){ $lII1lll =$db->Record; unset($lII1lll[I8290]); foreach($lII1ILI as $itemId => $lII1llL){ $lII1lll['id_item'] =$itemId; $lII1lll[I8380] =$lII1llL; $sql =$db2->GenInsertSQL($this->oEshop->dbTablePrefix.I8547, $lII1lll); $db2->query($sql); }}}function TIIllII($lII1ILl){ $db =$this->db->TTI1I1T(); $sql ='delete from ' .$this->oEshop->dbTablePrefix .'_props where id_item in (' .implode(I8525, $lII1ILl) .I8375; $db->query($sql); }function TTIITTT(&$record){ if (!empty($record['announce']) && $this->cms->Core->GetModOption($this->oEshop->ownerName .'_cat', 'fill_empty_description') && mb_strlen(trim(strip_tags($record['announce']))) && !mb_strlen(trim(strip_tags($record['description']))) ){$record['description'] =$record['announce']; }}protected function TIIllIl(){ $this->oEshop->tree->initResult(FALSE); $res =$this->oEshop->tree->getNode($this->cid); if($res === FALSE){ $this->cid =0; }$this->catId =$this->oEshop->rootCatId; if(isset($this->cms->Vars[I8548]) && $this->cms->Vars[I8548] >0){ $this->catId =$this->cms->Vars[I8548]; }elseif($this->cid >0){ $this->catId =$this->cid; }}public function getItemId(){ return isset($this->lIIlI1L)?$this->lIIlI1L:$this->id; }}