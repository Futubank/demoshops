<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       66482 xkqwwtnxttpqxyskprxtmpgkrwkgqtqnllglyypxxunnwlxzywwxriuyxupwnqyiqrnlpnir
 */ ?><?php foreach(array(8584=>'wjzddqd|gzTo',8585=>'H',8586=>"QSMt",8587=>"GrMnt|WHnfMrI",8588=>"GrMntQS|fHrID",8589=>"DtZt|MS",8590=>"fJt|HrSQr|MS",8591=>"uDQrnZIQ",8592=>'',8593=>'SrZft',8594=>'DOMGGQS',8595=>'WHnfMrIQS',8596=>"rQEuMrQIQntD|SrZft",8597=>"ZJJ",8598=>"SZtQfrHI",8599=>"?JMKQ?",8600=>"[",8601=>"|HrSQr`JnP",8602=>"|GrMnt|",8603=>"'{?zd?H|SZtQ?",8604=>"DtZt",8605=>"IQIYQr|uDQrnZIQ",8606=>"HrSQr|uDQrnZIQ",8607=>"DOMGGMnP",8608=>"|DQJQWtQS",8609=>'WHuntrB',8610=>"Mnn",8611=>'|WHuGHnD',8612=>"mNNqR?lhmN?.",8613=>"#Yr@",8614=>'GQrDHn|tBGQ|Hn',8615=>"GOG|StMIQ",8616=>'WOZnPQS|YB',8617=>"DtZtuD|JMDt",8618=>"Qxt|",8619=>"IZnufZWturQrD",8620=>"HCnQrD",8621=>"DQJQWt",8622=>"",8623=>"MS",8624=>"GrHG|LHMn2",8625=>"ZWtMHn",8626=>"MtQImSD",8627=>"HrSQr|MtQI|rQWHrS",8628=>"DMAQ",8629=>"WuDtHI",8630=>"WurrQnWB",8631=>"WHSQ",8632=>"GrMWQ|WurrQnWB",8633=>"GrHGQrtB|WZGtMHn",8634=>"tHtZJ|CQMPOt",8635=>"nQC|nZIQ",8636=>"GrMWQ",8637=>"SMDWHunt|tBGQ",8638=>"MS|SMDWHunt",8639=>"GrMWQ|vZJuQ",8640=>"nZIQ",8641=>"MtQI|MnfH",8642=>"YuB|WurrQnWB",8643=>"GurWOZDQ|DKu",8644=>"MtQI|GrMWQ",8645=>"tZx|MtQI|vZJuQ",8646=>"MtQI|SZtZ",8647=>"YZDQ|GrMWQ|WZGtMHn",8648=>"GurWOZDQ|GrMWQ",8649=>"rHC1",8650=>"HCnQr|nZIQ",8651=>"DOMGGMnP|tZx",8652=>"PrZnS|tHtZJ|CQMPOt",8653=>"ZIHunt",8654=>"tBGQ",8655=>"IHSuJQ|MIP|GZtO",8656=>"fQQ|GQrWQnt",8657=>"?",8658=>'SrMvQr',8659=>"GrMnt|Ytn",8660=>'ZsZtZ',8661=>"!?",8662=>"YuMJSMnP",8663=>"SY",8664=>'HqnPMnQ',8665=>"HrSQr|SZtQ",8666=>"WuDtMnfH",8667=>"WuDtHIQr|ZSSrQDD",8668=>"G`GrMWQ:S",8669=>"coqRq?MS|HrSQr?=?'",8670=>"Qxt|SZtZ",8671=>"tZx|MtQI",8672=>"Wur|GrMWQ",8673=>"MtQID",8674=>"EtB",8675=>"tHtZJ|GrMWQ",8676=>"HrSQr|ZWtMHn|ZGGJB",8677=>"'?",8678=>"DtZtuDQD|OMDtHrB",8679=>"DtZtuD",8680=>"YQfHrQ|HrSQr|ZGGJB",8681=>'DQnS|nHtMfMWZtMHn',8682=>'DtZtuDQD|ZWtMHnD',8683=>"QDOHG|SMPMtZJD",8684=>"fMJQ|MS",8685=>"nuIYQr|ZttQIGtD",8686=>"MnMtMZJ",8687=>"'",8688=>"WOQWKQS",8689=>"fHrI",8690=>"tZYJQD",8691=>"DEJ|fMJQSD",8692=>'LHMnD',8693=>"LHMnD|tBGQD",8694=>'IQIYQr|uDQrnZIQ',8695=>'H`fMrDtnZIQ',8696=>'ZIHunt',8697=>'WID|IQIYQrD',8698=>'QxWMDQ|tZx',8699=>'ZWtMHn',8700=>'nZIQ',8701=>'CHrSD',8702=>"vZJuQ",8703=>"ZWtMHn|QSMt",8704=>"Hff",8705=>"|JMDt%SQJ",8706=>"ZGGJB",8707=>"JQP|GrMnt",8708=>"fMrDtnZIQ",8709=>"IQIYQr|nZIQ",8710=>"HrSQr|IQIYQr|nZIQ",8711=>"rHC|MnSQx",8712=>"JMDt|tHtZJ",8713=>'vZJuQ',8714=>'WHrrQWtvZJuQ',8715=>'hGtMHnDiHSuJQNZIQ') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopOrder extends CMS_ActModule {public $oEshop; public $defaultCurrency; public $shippingScheme; public $lII1LLI; public $lII1LLl; public $lII1LLL; public $lII1LL1; public $lII1L1I; public $lII1L1l; public $oOrder; public $I1IL1Ll; function ModuleEshopOrder(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->defaultCurrency =""; $this->lII1LLI =Array(); $this->lII1LLl =0; $this->lII1L1I =false; $this->I1IL1Ll =Array(); $this->printOrder =false; if($this->cms->Core->Side == "admin") {require_once $GLOBALS[I8584] .'EshopAdmin.php'; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init($this->moduleName); }}function _Init($IIll1l1 =Array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =Array()) {$IIIIL11['default_prefix'] =I8585; $IIIIL11['multi_sites'] =true; $IIIIL11["group_operations"] =Array("del"); $IIIIL11["allowed_actions"] =Array(I8586, "apply", "save", "del", "print", I8587, "export"); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin() {parent::_InitAdmin(); $this->oEshop->TT1l11l($this->options["multi_sites"], $this->siteId); if($this->oEshop->currencyEnable) {$this->defaultCurrency =$this->module->GetOption("default_currency"); $this->defaultCurrency =$this->defaultCurrency[$this->langData]; }$this->shippingScheme =$this->oEshop->mEshop->GetOption('shipping_scheme'); $this->lII1LLL =$this->module->GetOption(I8588); $this->lII1LL1 =$this->module->GetOption("default_printed_form"); if(!in_array($this->lII1LL1, $this->lII1LLL)) {$this->lII1LL1 =$this->lII1LLL[0]; }require_once $GLOBALS[I8584] .'EshopOrder.php'; $this->oOrder =new EshopOrder(); $this->oOrder->aCurrency =&$this->oEshop->aCurrency; $this->cms->Eshop =&$this->oEshop; if(CheckProbability(0.1)) {$this->oOrder->TITTI1I($this->cms); }}function TTTlITT($IIIL11l, $cId, $cModule ='') {switch($IIIL11l) {case "print": $this->TTll11I($cId); $this->redirect =false; break; case I8587: $this->TIIlllI($cId, $cModule); $this->redirect =false; break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function TTTlIII() {parent::TTTlIII(); $lII1L1L =empty($this->cms->Vars[I8589]) ?'0' :$this->cms->Vars[I8589]; $this->filter->AddField("flt_order_id", "text", isset($this->cms->Vars["flt_order_id"]) ?stripslashes(unhtmlentities($this->cms->Vars[I8590])) :'', "", " like ", "o.id"); $this->filter->MoveField(I8590,_MOVE_END); $this->filter->AddField(I8591, "text", isset($this->cms->Vars[I8591]) ?stripslashes(unhtmlentities($this->cms->Vars[I8591])) :'', "", " like ", "CONCAT(m.firstname, ' ', m.lastname)"); $this->filter->MoveField(I8591,_MOVE_END); $this->filter->AddField("flt_username", "text", isset($this->cms->Vars["flt_username"]) ?stripslashes(unhtmlentities($this->cms->Vars["flt_username"])) :I8592, "", " like ", "m.username"); $this->filter->MoveField("flt_username",_MOVE_END); $aStats =array(); $lII1L11 =array(I8593, 'printed', 'pending', 'checkout', 'waiting', I8594, 'delivered', 'rejected', 'accepted', 'cancelled', I8595, 'confirmed_conditionally', 'confirmed_done'); foreach($lII1L11 as $statusId){ $aStats =$this->filter->TITI1TT($aStats, array($this->words[$statusId] => $statusId), 35); }if($this->module->GetOption("use_requirements_order")) {$aStats =$this->filter->TITI1TT($aStats, array($this->words["requirements_draft"] => I8596), 35); $aStats =$this->filter->TITI1TT($aStats, array($this->words["requirements_accepted"] => "requirements_accepted"), 35); $aStats =$this->filter->TITI1TT($aStats, array($this->words["requirements_cancelled"] => "requirements_cancelled"), 35); }$aStats =$this->filter->TITI1TT($aStats, array($this->words[I8597]=>0), 35); $this->filter->AddField(I8589, "select", $lII1L1L, "", "=", "o.status", $aStats); $this->filter->MoveField(I8589, _MOVE_END); $this->filter->UpdateFieldDBName(I8598, "o.order_date"); $this->filter->UpdateFieldDBName("dateto", "o.order_date"); if($lII1L1L=="0") {$this->filter->DisableFieldSQL(I8589); }$this->filter->AddField("flt_eshop_item_name", "text", isset($this->cms->Vars["flt_eshop_item_name"]) ?stripslashes(unhtmlentities($this->cms->Vars["flt_eshop_item_name"])) :I8592, "", I8599, "o.name"); $this->filter->MoveField("flt_eshop_item_name", _MOVE_END); if(sizeof($this->oEshop->aCloneOwners) >1) {$aOwners =Array(); $lII11II =Array(); foreach($this->oEshop->aCloneOwners as $ownerName => $tmp) {$ownerData =$this->cms->Core->OwnerGetData($ownerName); $lII11II[] ="*".$ownerName; $aOwners =$this->filter->TITI1TT($aOwners, array($ownerData["admin_menu_caption"] => I8600.$ownerName), 35); }}}function TIIlllI($cId, $cModule) {$this->printOrder =true; $this->cms->Gui->lang =$this->langData; $aWords =Array( $GLOBALS['LOCAL_FILES_REL_PATH']."_admin/templates/lang/".$this->oEshop->ownerName."_order.lng", "templates/lang/".$this->oEshop->ownerName.I8601 );foreach($aWords as $path){ $lII11Il =$this->cms->Gui->ParseLangFile($path); $this->words =array_merge($this->words, $lII11Il); }$this->cms->Gui->addBlock($this->moduleName."_subform", $GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/eshop_".$this->cms->Vars["type"].I8602.$this->langData.".tpl"); $this->TTTl1Tl($cId, $cModule); }function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT o.*, m.username AS member_username, o.username AS order_username, ". "DATE_FORMAT(order_date,'".$this->cms->DFMT["db_dtime"].I8603. "FROM cms_es_orders o ". "LEFT OUTER JOIN cms_members m ON m.id=o.id_member ". "WHERE o.id='".$cId."' and o.show_in_admin=1".$this->_ApplyFilters(); $this->db->query($sql); $memberDeleted =false; if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData[I8604] =$this->itemData["status"]; unset($this->itemData["status"]); if($this->db->Record["member_username"] != "") {$username =$this->db->Record[I8605]; }else {$username =$this->words["unknown"]; $memberDeleted =true; }if($memberDeleted || $username != $this->db->Record["order_username"]) {$this->itemData["order_username"] =$this->cms->Gui->getAbs($this->moduleName."_subform:order_username", Array(I8606=>$this->db->Record[I8606])); }$oExtData =unserialize($this->db->Record["ext_data"]); $this->oEshop->pushCurrencyData($oExtData["currency"], $oExtData["base_currency"]["code"]); $shipping =$this->oEshop->convertCurrency($this->db->Record[I8607], $this->oEshop->baseCurrency, $this->defaultCurrency); $this->oEshop->TT11T1T(); $this->itemData[I8591] =$username; $this->itemData["cust_email"] =$this->itemData["email"]; $this->itemData["comments"] =nl2br($this->db->Record["comments"]); $this->itemData[$this->itemData[I8604].I8608] ="selected"; $this->itemData["cust_info"] =I8592; $aCustInfo =unserialize($this->db->Record["custinfo"]); $shippingConflicts =""; if(is_array($aCustInfo)) {if(array_key_exists(I8609, $aCustInfo)){ $aCountries =$this->cms->Gui->ParseLangFile($GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/lang/country.lng"); }if($aSysInfo["person_type"] == "natural") {$this->itemData["print_customer_name"] =$this->db->Record["firstname"]." ".$this->db->Record["lastname"]; $this->itemData["print_customer_address"] =$this->TIIllll($aCustInfo); }else {$this->itemData["print_customer_name"] =$this->db->Record["company"]; $this->itemData["print_customer_address"] =$aCustInfo["address"]; }$this->itemData["customer_inn"] =$aCustInfo[I8610]; $this->itemData["customer_kpp"] =$aCustInfo["kpp"]; foreach($aCustInfo as $name => $val) {if ($name == 'id_coupon' && $this->cms->Core->IsInstalled($aCustInfo['coupon_owner'] .I8611)) {$this->oEshop->initByOwnerName($aCustInfo['coupon_owner']); $sql ="SELECT co.coupon, coc.name coupon_category " ."FROM `" .$this->oEshop->dbTablePrefix ."_coupons` co " .I8612 .$this->oEshop->dbTablePrefix ."_coupons_cats` coc ON co.id_cat = coc.id " ."WHERE co.id = " .intval($val); if ($record =$this->db->getRecord($sql)) {$this->itemData += $record; }}if(!empty($this->words[$name])) {if($name == I8609 && isset($aCountries[$val])){ $val =$aCountries[$val]; }$this->itemData["cust_info"] .= $this->words[$name].': '.nl2br($val).I8613; }if($this->printOrder){ $this->itemData["custom_".$name] =$val; }}if (isset($aCustInfo["shipping_conflicts"])) {$shippingConflicts =$aCustInfo["shipping_conflicts"]; }}$this->itemData["shipping_conflicts"] =$shippingConflicts; $lII11IL =false; if($this->module->GetOption(I8614)) {$lII11I1 =$this->module->GetOption('person_type_accessible_lang'); if(is_array($lII11I1)) {$lII11IL =in_array($this->langData, $lII11I1); }else {$lII11IL =($lII11I1==$this->langData); }}$aStatHistory =unserialize($this->db->Record["statuses_history"]); if(is_array($aStatHistory)) {$i =0; $aHistory["status_list"] =I8592; foreach($aStatHistory as $date => $aDetails) {$aDetails['date'] =date($this->cms->DFMT[I8615], $date); $aDetails['status'] =$this->words[$aDetails['status']]; $aDetails['comments'] =nl2br($aDetails['comments']); $aDetails[I8616] =$this->words[$aDetails['type']]; $style ="row2"; if($i%2) {$style="row1"; }$aDetails["style"] =$style; $aHistory[I8617] .= $this->cms->Gui->get($this->moduleName."_subform:status_row", $aDetails); }$this->itemData["history"] =$this->cms->Gui->get($this->moduleName."_subform:history", $aHistory); }$lII11lI =&$this->cms->Core->GetModule($this->oEshop->ownerName."_reference"); $lII11ll =&$this->cms->Core->GetModule(I8618.$this->oEshop->ownerName."_custom_fields"); $ILLILlL =""; $lII11lL =Array(); if($lII11lI->IsInstalled()) {$lII11l1 =$lII11lI->GetProperty("system_references"); $I11Llll =$lII11ll->GetOption("custom_name"); $lII11LI =array_search(I8619, $lII11l1); if($lII11LI !== false) {$ILLILlL .= ",p.".$I11Llll.$lII11LI; $lII11lL[I8619] =$I11Llll.$lII11LI; }$lII11Ll =array_search("gtd_numbers", $lII11l1); if($lII11Ll !== false) {$ILLILlL .= ",p.".$I11Llll.$lII11Ll; $lII11lL["gtd_numbers"] =$I11Llll.$lII11Ll; }}$db2 =new DB_si; $owners =$this->db->Record[I8620]; if(substr($owners, 0, 1) !== ";") $owners =";" .$owners; if(substr($owners, strlen($owners)-2, 1)) $owners .= ";"; $aOwners =explode(";", $owners); $numOwners =sizeof($aOwners); for($lII11LL =1; $lII11LL <$numOwners -1; $lII11LL++) {$lII11L1 =0; $grandDiscount =0; $lII111I =0; $lII111l =0; $lII111L =false; $this->oEshop->initByOwnerName($aOwners[$lII11LL]); $addSql =Array(I8621=>"", "from"=>"", "join"=>I8622, "where"=>I8622, "group"=>I8622, "order"=>I8622); $aCustom =Array("sql_type" => "system_referencies_fields", "prefix"=>"i"); $IIlLIIL =Array("action"=>"add_extention_sql", I8623=>0, "item_data"=>I8622, "data"=>&$addSql, "custom"=>&$aCustom); $this->TTT1lI1($IIlLIIL); $aCustom =Array("sql_type" => I8624, "order_item_field"=>"oi.id_product", "order_prefix"=>"oi"); $IIlLIIL =Array(I8625=>"add_extention_sql", I8623=>0, "item_data"=>I8622, "data"=>&$addSql, "custom"=>&$aCustom); $this->TTT1lI1($IIlLIIL); $sql ="SELECT i.id, i.name, i.price AS price0".$this->oEshop->getPriceFields("i.price%d, SUBSTRING(c.price%d, INSTR(c.price%d, ':')+1, 3) AS db_currency%d"). ", i.tax,i.tax_type,i.charge_tax_type,i.tax_class_type,i.id_tax_class,i.discount,i.discount_type, i.item_type, i.sku, oi.ext_data, ". "oi.owner_name, oi.price AS purchase_price, oi.price_number, oi.qty, c.id_discount ".$addSql[I8621]." ". "FROM cms_es_order_items oi LEFT JOIN ".$this->oEshop->dbTablePrefix."_items i ON (oi.id_product = i.id) ". "LEFT JOIN ".$this->oEshop->dbTablePrefix."_cats c ON (c.id = i.id_category)" .$addSql["join"]. " WHERE oi.id_order = '".$cId."' AND oi.owner_name='".$aOwners[$lII11LL]."'"; $db2->query($sql); if($db2->num_rows() >0) {$i =0; if(!$this->printOrder && $this->oEshop->numItemTypes >0) {$itemIds =Array(); while($db2->next_record()) {$this->oEshop->TT11lTT($db2->Record["item_type"]); $itemIds[] =$db2->Record[I8623]; }$db2->seek(); $aData =Array("oExtData"=>&$oExtData, I8626=>&$itemIds); $this->oEshop->TT11lT1("order_edit", $this->itemData, $aData); }$numOwners =sizeof($this->oEshop->aCloneOwners); if($numOwners >1) {$this->itemData["owner_name_header"] =$this->cms->Gui->get($this->moduleName."_subform:item_row_ownername_header", $productData); }$aNone =false; $aCustom["record_type"] =I8627; $ILLl11I =0; $enableWeightCol =false; $enableSizeCol =false; while($db2->next_record()) {$extData =Array(); $extData =unserialize($db2->Record["ext_data"]); if(!empty($extData["item_info"]["weight"])){ $enableWeightCol =true; }if(!empty($extData["item_info"][I8628])){ $enableSizeCol =true; }if($enableWeightCol && $enableSizeCol){ break; }}$this->cms->Gui->AddGlobalVars(Array("ENABLE_WEIGHT_COL" => $enableWeightCol, "ENABLE_SIZE_COL" => $enableSizeCol)); $db2->seek(); $ILLl11I =0; while($db2->next_record()) {$this->TTT1lI1($aExtData =Array(I8625=>"prepare_record", I8623=>0, "item_data"=>&$db2->Record, I8629=>&$aCustom)); $productData =Array(); $priceNumber =$db2->Record["price_number"]; $extData =Array(); $extData =unserialize($db2->Record["ext_data"]); $taxItem =$this->oEshop->convertCurrency($extData["item_info"]["tax_item"], $extData[I8630]["code"], $this->defaultCurrency); $taxItem =$this->oEshop->formatNumber($taxItem, true, true); $taxItem *= $db2->Record["qty"]; $lII111I += $taxItem; $itemPrice =$this->oEshop->convertCurrency($extData["item_info"]["cur_price"], $extData[I8630][I8631], $this->defaultCurrency); $itemPrice =$this->oEshop->formatNumber($itemPrice, true, true); $lII1111 =$itemPrice *$db2->Record["qty"]; $lII11L1 += $lII1111; if (isset($extData["absolute_discount"])) {$discount =$extData["absolute_discount"]; $discount =$this->oEshop->convertCurrency($discount, $extData[I8630][I8631], $this->defaultCurrency); $discount =$this->oEshop->formatNumber($discount, true, true); $grandDiscount += $discount; }$priceCaptions =$extData["price_captions"]; $ILLl11L =$extData[I8632]; $productData["index"] =$i +1; $productData["order_name_short"] =$this->cms->stripLine($extData["name"], 27); $productData["order_property_caption"] =$extData[I8633]; $productData["order_property_caption_short"] =$this->cms->stripLine($extData[I8633], 27); if($enableWeightCol){ $productData["weight"] =$extData["item_info"]["weight"]; $productData[I8634] =$extData["item_info"]["weight"] *$db2->Record["qty"]; $ILLl11I += $productData[I8634]; }if($enableSizeCol){ $productData[I8628] =$extData["item_info"][I8628]; }$id =$db2->Record[I8623]; $productData[I8635] =I8622; $productData["order_name"] =$extData["name"]; if($id >0) {$productData[I8623] =$id; $productData["name"] =$db2->Record["name"]; $currPrice =I8622; if($db2->Record[I8636.$priceNumber] != I8622) {$aPrice =$this->oEshop->calcPrice( $db2->Record[I8636.$priceNumber], $priceNumber, $db2->Record["tax"], $db2->Record["tax_type"], $db2->Record["charge_tax_type"], $db2->Record["discount"], $db2->Record[I8637], $this->defaultCurrency, $db2->Record["db_currency".$priceNumber], true, array ("qty" => $db2->Record["qty"], "id_discount" => $db2->Record[I8638] ),array( "tax_class_type" => $db2->Record["tax_class_type"], "id_tax_class" => $db2->Record["id_tax_class"] ));$currPrice =$aPrice[I8639]; }$productData["curr_price"] =$this->oEshop->formatMoney($currPrice, $this->defaultCurrency); }if($productData["name"] != $productData["order_name"]) {if($productData["name"] == I8622) {$productData[I8640] =$this->words["unknown"]; }$productData["name_short"] =$this->cms->stripLine($productData[I8640], 27); $productData[I8635] =$this->cms->Gui->get($this->moduleName."_subform:item_row_newname", $productData); }$productData["shipping_conflicts"] =$shippingConflicts; if (isset($extData[I8641]["shipping_method_name"])) {$productData["shipping_method_name"] =$extData[I8641]["shipping_method_name"]; }$price =$db2->Record["purchase_price"]; $priceTotal =$this->oEshop->convertCurrency($price, $oExtData[I8642][I8631], $this->defaultCurrency); $priceTotal =$this->oEshop->formatNumber($priceTotal, true, true) *$db2->Record["qty"]; $lII111l += $priceTotal; $this->oEshop->pushCurrencyData($oExtData[I8630], $oExtData["base_currency"][I8631]); $productData["sku"] =$db2->Record["sku"]; $productData[I8643] =$extData[I8641]["sku"]; if ($productData[I8643] === $productData["sku"]) $productData[I8643] =I8622; if($this->printOrder) {$itemPrice =$this->oEshop->convertCurrency($extData[I8641]["cur_price"], $extData[I8630][I8631], $this->defaultCurrency); $itemPrice =$this->oEshop->formatNumber($itemPrice, true, true); $lII1111 =$itemPrice *$db2->Record["qty"]; $productData[I8644] =$this->oEshop->formatMoney($itemPrice, $this->defaultCurrency); $productData["item_total_price"] =$this->oEshop->formatMoney($lII1111, $this->defaultCurrency); $productData["tax_item"] =$this->oEshop->formatMoney($taxItem, $this->defaultCurrency); $productData["tax_item_value"] =$extData[I8641]["tax_item_value"]; $productData[I8645] =$this->oEshop->TT11IlT($extData[I8641][I8645], $extData[I8641]["tax_type"], true, $oExtData["base_currency"][I8631], $this->defaultCurrency); $productData["total_tax"] =$this->oEshop->formatMoney($lII1111 +$taxItem, $this->defaultCurrency); $IIlLIIL =Array(I8625=>"add_system_referencies_fields", I8623=>0, I8646=>&$db2->Record, "data"=>&$productData); $this->TTT1lI1($IIlLIIL); foreach(array(I8619, "gtd_numbers") as $lIlIIII) {if(isset($productData[$lIlIIII]) && is_array($productData[$lIlIIII])) {$lIlIIIl =$this->cms->Gui->get($this->moduleName."_subform:".$lIlIIII."_splitter", $productData); $productData[$lIlIIII] =implode($lIlIIIl, $productData[$lIlIIII]); }}}if($this->oEshop->otherPricesEnabled) {if($priceNumber >0) {$caption =$priceCaptions[$id][$priceNumber]; }else {$caption =$this->cms->words[I8647]; }if($caption != I8622) {$productData["price_caption"] =$this->cms->Gui->getAbs($this->moduleName."_subform:price_caption", Array("price_caption" => $caption)); }else {$productData["price_caption"] =I8622; }}$price =$this->oEshop->convertCurrency($price, $oExtData[I8642][I8631], $this->defaultCurrency); $this->oEshop->TT11T1T(); $productData[I8648] =$this->oEshop->formatMoney($price, $this->defaultCurrency); $productData["qty"] =$db2->Record["qty"]; $productData["total"] =$this->oEshop->formatMoney($priceTotal, $this->defaultCurrency); $style ="row2"; if($i%2) {$style=I8649; }$productData["style"] =$style; $aData =Array(I8623=>$id, "extData"=>&$extData); $this->oEshop->TT11lIT("order_edit", $productData, $aData); if($numOwners >1) {$ownerData =$this->cms->Core->OwnerGetData($db2->Record["owner_name"]); $productData[I8650] =$ownerData["admin_menu_caption"]; $productData[I8650] =$this->cms->Gui->get($this->moduleName."_subform:item_row_ownername", $productData); }$this->itemData["product_list"] .= $this->cms->Gui->get($this->moduleName."_subform:item_row", $productData); $i++; }$lII111I += $this->oEshop->formatNumber($this->itemData[I8651], true, true) +$this->oEshop->formatNumber($this->itemData["excise_tax"], true, true); $amount =$lII11L1 +$lII111I +$shipping; $this->itemData["tax"] =$this->oEshop->formatMoney($lII111I, $this->defaultCurrency); $this->itemData[I8607] =$this->oEshop->formatMoney($shipping, $this->defaultCurrency); $this->itemData["total"] =$this->oEshop->formatMoney($lII11L1, $this->defaultCurrency); $this->itemData["grand_total_tax"] =$this->oEshop->formatMoney($lII11L1 +$lII111I, $this->defaultCurrency); $this->itemData[I8652] =$ILLl11I; if ($grandDiscount >0) {$this->itemData["grand_discount"] =$this->oEshop->formatMoney($grandDiscount, $this->defaultCurrency); $percent =($lII11L1 +$lII111I +$grandDiscount) >0 ?100 *(1 -($lII11L1 +$lII111I) /($lII11L1 +$lII111I +$grandDiscount)) :0; $this->itemData["grand_discount_percent"] =$this->oEshop->formatPercent($percent, false); $this->cms->Gui->addGlobalVars(array ("SHOW_DISCOUNTS" => "1")); }$this->itemData[I8653] =$this->oEshop->formatMoney($amount, $this->defaultCurrency); $this->itemData["order_price_total"] =$this->oEshop->formatMoney($lII111l, $this->defaultCurrency); if($this->printOrder) {if(($this->cms->Vars["type"] == "bill" && $this->module->GetOption("bill_form_with_shipping")) || $this->cms->Vars[I8654] != "bill") {if($shipping >0) {$this->itemData["shipping_row"] =$this->cms->Gui->get($this->moduleName."_subform:shipping_row", $this->itemData); }}$lII11L1 =$this->oEshop->formatNumber($lII11L1, true, true); $this->itemData["grand_total_price"] =$this->oEshop->formatMoney($lII11L1, $this->defaultCurrency); require_once $GLOBALS[I8584] .'ValueSpelledOut.php'; $lIlIIIL =new ValueSpelledOut(); if($lIlIIIL->TlTTTIl($this->defaultCurrency)) {$this->itemData["spelled_out"] =$lIlIIIL->TlTTTI1($amount, $this->defaultCurrency); }$this->itemData[I8655] =$II1l111; }}}$aSysInfo =unserialize($this->itemData["sysinfo"]); $this->itemData["sysinfo"] =I8592; if(is_array($aSysInfo)) {if(isset($aSysInfo["fee_percent"])) {$lIlIII1 =$amount *$aSysInfo[I8656]/100; $feeConst =$this->oEshop->convertCurrency($aSysInfo["fee_const"], $aSysInfo["fee_curr"], $this->defaultCurrency); $lIlIII1 += $feeConst; $this->itemData["payment_tax"] =$this->oEshop->formatNumber($lIlIII1, true, true); $this->itemData["payment_tax"] =$this->cms->Gui->get($this->moduleName."_subform:payment_tax", $this->itemData); }if (is_array($aCustInfo)) {if($aSysInfo["person_type"] == "natural") {$this->itemData["print_customer_name"] =$this->db->Record["firstname"].I8657.$this->db->Record["lastname"]; $this->itemData["print_customer_address"] =$this->TIIllll($aCustInfo); }else {$this->itemData["print_customer_name"] =$this->db->Record["company"]; $this->itemData["print_customer_address"] =$aCustInfo["address"]; }}foreach($aSysInfo as $name => $val) {if ($name != "payment_type" && isset($this->words[$name])) {if(!empty($this->words[$val])) {$this->itemData["sysinfo"] .= $this->words[$name].': '.$this->words[$val].I8613; }else if($name == I8658 && isset($GLOBALS['BILLING_DRIVERS_ALIASES'][$val]) && !empty($this->words[$GLOBALS['BILLING_DRIVERS_ALIASES'][$val]])) {$this->itemData["sysinfo"] .= $this->words[$name].': '.$this->words[$GLOBALS['BILLING_DRIVERS_ALIASES'][$val]].I8613; }else {$this->itemData["sysinfo"] .= $this->words[$name].': '.nl2br($val).I8613; }}}}if(is_array($this->lII1LLL) && sizeof($this->lII1LLL) >1) {$this->itemData["print_btn"] =$this->cms->Gui->get($this->moduleName."_subform:print_btn_popup",$this->itemData); }else {$this->itemData[I8659] =$this->cms->Gui->get($this->moduleName."_subform:print_btn",$this->itemData); }if($this->printOrder) {$html =$this->cms->Gui->get($this->moduleName."_subform", $this->itemData); echo $html; $GLOBALS["conn"]->out(); die(); }}}function TIIllll(&$aCustInfo) {$aEvent =array( 'modId' => $this->moduleName, I8660 => &$aCustInfo, 'oEngine' => $this );AMI_Event::fire('v5_on_eshop_order_create_custom_address', $aEvent, AMI_Event::MOD_ANY); $customerAddress =I8622; $delimiter =I8622; if($aCustInfo["city"] != I8622) {$customerAddress .= $aCustInfo["city"]; $delimiter =I8661; }if($aCustInfo["street"] != I8622) {$customerAddress .= $delimiter.$aCustInfo["street"]; $delimiter =I8661; }if($aCustInfo["house"] != I8622) {$customerAddress .= $delimiter.$aCustInfo["house"]; $delimiter =I8661; if($aCustInfo[I8662] != I8622) {$customerAddress .= "/".$aCustInfo[I8662]; }if($aCustInfo["app"] != I8622) {$customerAddress .= $delimiter.$aCustInfo["app"]; $delimiter =I8661; }}return $customerAddress; }function TTTl11I($cId, $cModule) {$this->itemData =Array(); $sql ="SELECT *,DATE_FORMAT(order_date,'".$this->cms->DFMT[I8663]."') AS fdate FROM ".$this->module->GetTableName()." WHERE id='".$cId."'"; $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; }$aEvent =array( 'modId' => $this->moduleName, I8660 => &$this->itemData, I8664 => $this );AMI_Event::fire('v5_on_before_eshop_order_export_item', $aEvent, AMI_Event::MOD_ANY); if(sizeof($this->itemData) >0) {$this->itemData["show_in_admin"] ="1"; $this->itemData["real_order_date"] =$this->itemData[I8665]; $this->itemData[I8665] =$this->itemData["fdate"]; $this->itemData["statuses_history"] =unserialize($this->itemData["statuses_history"]); $this->itemData["custinfo"] =unserialize($this->itemData[I8666]); $this->itemData["sysinfo"] =unserialize($this->itemData["sysinfo"]); $this->itemData["ext_data"] =unserialize($this->itemData["ext_data"]); $this->itemData[I8666][I8667] =$this->TIIllll($this->itemData[I8666]); $this->oEshop->pushCurrencyData($this->itemData["ext_data"][I8630], $this->itemData["ext_data"]["base_currency"][I8631]); $sql ="SELECT p.id, p.id_external as item_id_external, p.name, p.price AS price".$this->oEshop->getPriceFields(I8668). ", p.tax,p.tax_type,p.charge_tax_type,p.discount,p.discount_type, p.item_type, oi.ext_data, ". "oi.price AS purchase_price, oi.price_number, oi.qty ". "FROM cms_es_order_items oi LEFT JOIN ".$this->oEshop->dbTablePrefix."_items p ON (oi.id_product = p.id) ". I8669.$cId."'"; $this->db->query($sql,DBC_SYS_QUERY); $lII111I =0; $totalPrice =0; $shipping =0; $shippingChanged =false; if($this->db->num_rows() >0) {$this->itemData["items"] =Array(); $k =0; while($this->db->next_record()) {foreach($this->db->Record as $key=>$value) {if(!is_numeric($key)) {$this->itemData["items"][$k][$key] =$this->db->Record[$key]; }}$this->itemData["items"][$k][I8670] =unserialize($this->itemData["items"][$k][I8670]); $ILLl11L =$this->itemData["items"][$k][I8670][I8630][I8631]; $lIlIIlI =&$this->itemData["items"][$k][I8670][I8641]; $lIlIIlI["tax_item"] =$this->oEshop->convertCurrency($lIlIIlI[I8671], $ILLl11L, $this->defaultCurrency); $lII111I += ($lIlIIlI[I8671] *$this->itemData["items"][$k]["qty"]); $lIlIIlI["cur_price"] =$this->oEshop->convertCurrency($lIlIIlI["cur_price"], $ILLl11L, $this->defaultCurrency); $totalPrice += ($lIlIIlI[I8672] *$this->itemData["items"][$k]["qty"]); $lIlIIlI["cur_price_tax"] =$this->oEshop->convertCurrency($lIlIIlI["cur_price_tax"], $ILLl11L, $this->defaultCurrency); $shippingItem =$this->oEshop->convertCurrency($this->itemData[I8673][$k][I8670][I8641]["shipping_item"], $ILLl11L, $this->defaultCurrency); $lIlIIlI["shipping_item"] =$shippingItem; $lIlIIll =isset($this->itemData[I8673][$k][I8670][I8641]["shipping_method_name"]) && mb_strlen($this->itemData[I8673][$k][I8670][I8641]["shipping_method_name"]); $_shippingItem =($lIlIIll ?1 :$this->itemData[I8673][$k][I8674]) *$shippingItem; switch($this->shippingScheme) {case 'sum': $shipping += $_shippingItem; break; case 'max': $shipping =max($shipping, $_shippingItem); break; case 'min': if ($_shippingItem >0) {$shipping =$shippingChanged ?min($shipping, $_shippingItem) :$_shippingItem; $shippingChanged =true; }break; }$k++; }}$this->oEshop->TT11T1T(); }$this->itemData["total_tax"] =$lII111I; $this->itemData[I8675] =$totalPrice; $this->itemData["total_shipping"] =$shipping; $aEvent =array( 'modId' => $this->moduleName, I8660 => &$this->itemData, I8664 => $this );AMI_Event::fire('v5_on_after_eshop_order_export_item', $aEvent, AMI_Event::MOD_ANY); }function TTT1IlI($aSql, $cId =0) {$ILLILlL =I8622; $lIlIIlL =I8622; $lIlIIl1 =I8622; $eshopDigitalsOn =$this->oEshop->extItemTypeIsEnabled("eshop_digitals"); $addSql =$this->oEshop->TT11lII(I8676); $sql ="SELECT o.id, o.status, o.statuses_history, o.ext_data".$addSql[I8621]. " FROM cms_es_orders o ".$addSql["join"]." WHERE o.id='".$this->cms->Vars[I8623].I8677.$this->_ApplyFilters().$addSql["group"]; $this->db->query($sql); if($this->db->next_record()) {$id =$this->db->Record[I8623]; $this->I1IL1Ll["numItems"] =$this->db->Record["num_items"]; $status =$this->db->Record["status"]; $extData =unserialize($this->db->Record[I8670]); $lIlIILI =unserialize($this->db->Record[I8678]); $this->lII1L1l =addslashes($status); $this->lII1L1I =$this->cms->VarsPost["status"] != $this->lII1L1l; $aSql =Array("adm_comments"=>$this->cms->VarsPost["adm_comments"], "status"=>$this->cms->VarsPost[I8679]); if(!$this->lII1L1I) {end($lIlIILI); $lastIndex =key($lIlIILI); $lIlIILI[$lastIndex]["comments"] =removeSpecial($this->cms->VarsPost["adm_comments"], 'slashes'); $aSql[I8678] =addslashes(serialize($lIlIILI)); }$aTmp =Array("extData"=>&$extData); $this->oEshop->TTT1lI1(I8680, $id, $aSql, $aTmp); $aSql[I8670] =addslashes(serialize($extData)); if(!empty($this->cms->VarsPost["o_date"])) {$aSql[I8665] =$this->cms->VarsPost["o_date"]; }}return $aSql; }function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); if(empty($this->errno)) {if($this->lII1L1I) {$ILLIlLI =Array(); $aActions =$this->module->GetOption('statuses_actions'); $aStatActions =&$aActions[$this->cms->VarsPost[I8679]]; if(is_array($aStatActions)) {$pos =array_search('status_changed_user', $aStatActions); switch ($this->cms->VarsPost[I8681]) {case 'force': if($pos === false) {$aStatActions[] ='status_changed_user'; }break; case 'dont': if($pos !== false) {unset($aStatActions[$pos]); }$ILLIlLI['dontNotifyUser'] =TRUE; break; }}$this->module->SetOption(I8682, $aActions); $this->oOrder->updateStatus($this->cms, $cId, 'admin', $this->cms->VarsPost[I8679], $ILLIlLI, $this->lII1L1l); }$aTmp =Array("numItems"=>$this->I1IL1Ll["numItems"]); $aSql =Array(); $this->oEshop->TTT1lI1("after_order_apply", $cId, $aSql, $aTmp); if($this->oEshop->extItemTypeIsEnabled(I8683)) {$eshopDigitals =&$this->cms->Core->GetModule($this->oEshop->ownerName."_digitals"); $maxAttempts =$eshopDigitals->GetOption("max_download_attempts"); for($i=1;$i<=$this->I1IL1Ll["numItems"];$i++) {if(isset($this->cms->VarsPost[I8623.$i]) && $this->cms->VarsPost[I8623.$i] >0) {$ILLlI1L =$this->cms->VarsPost[I8623.$i]; if(is_array($this->cms->VarsPost["file_id".$ILLlI1L]) && sizeof($this->cms->VarsPost[I8684.$ILLlI1L]) >0) {$sql ="SELECT ext_data FROM cms_es_order_items WHERE id_order='".$this->cms->Vars[I8623]."' AND id_product='".$ILLlI1L."'"; $this->db->query($sql); if($this->db->next_record()) {$aExtData =unserialize($this->db->Record[I8670]); $ILLlI11 =Array(); $isChanged =false; foreach($this->cms->VarsPost[I8684.$ILLlI1L] as $key=>$fileId) {if(isset($this->cms->VarsPost["number_attempts".$fileId]) && $this->cms->VarsPost[I8685.$fileId] != $this->cms->VarsPost["number_attempts_old".$fileId]) {$aExtData[I8683]["download_attempts"][$fileId]["rest"] =intval($this->cms->VarsPost[I8685.$fileId]); if(!isset($aExtData[I8683]["download_attempts"][$fileId][I8686])) {$aExtData[I8683]["download_attempts"][$fileId][I8686] =$maxAttempts; }$isChanged =true; }}if($isChanged) {$aSql =Array(I8670=>addslashes(serialize($aExtData))); $sql =$this->db->GenUpdateSQL("cms_es_order_items", $aSql, "WHERE id_order='".$this->cms->Vars[I8623]."' AND id_product='".$ILLlI1L.I8687); $this->db->query($sql); }}}}}}}}function _ActionDel($cId, $cModule) {parent::_ActionDel($cId, $cModule); if(empty($this->errno)) {$sql ="DELETE FROM cms_es_order_items WHERE id_order = '".$cId.I8687; $this->db->query($sql); }}function TTll11I($cId) {if(is_array($this->lII1LLL) && sizeof($this->lII1LLL) >1) {$form =Array(); $form[I8623] =$cId; foreach($this->lII1LLL as $key=>$formType) {$lIlIILl["type_name"] =$this->words[$formType."_print_form_name"]; $lIlIILl["type_value"] =$formType; if($formType == $this->lII1LL1) {$lIlIILl[I8688] =I8688; }else {$lIlIILl[I8688] =I8622; }$form["print_type"] .= $this->cms->Gui->get($this->moduleName."_subform:print_type", $lIlIILl); }$aEvent =array( 'modId' => $this->moduleName, I8660 => &$form, I8664 => $this );AMI_Event::fire('v5_on_eshop_order_print', $aEvent, AMI_Event::MOD_ANY); $form[I8689] =$this->cms->Gui->get($this->moduleName."_subform:print_popup_form", $form); $html =$this->cms->Gui->get($this->moduleName."_subform:print_popup", $form); echo $html; $GLOBALS["conn"]->Out(); die(); }else {$this->cms->Vars[I8625] =I8587; $this->cms->Vars[I8654] =$this->lII1LL1; $this->TIIlllI($cId, I8622); }}function TTTlI11(&$vData, &$aCustom) {$IIlL1Ll =Array(); $aCustom += Array( "sql_fileds" => I8622, I8690 => Array(), "joins" => Array(), "joins_types" => Array(), );$this->browser->InitSQL("o.id, o.name, o.status, o.total, o.tax, o.excise_tax, o.shipping_tax, o.shipping, o.order_date, m.username AS member_username, ". "o.username AS order_username, o.ext_data, m.firstname, m.lastname, ". "o.firstname AS order_firstname, o.lastname AS order_lastname, ". "(o.tax+o.shipping+o.total) AS amount, ". "CONCAT(m.firstname, m.lastname) AS member_name, ". "DATE_FORMAT(order_date,'".$this->cms->DFMT["db_dtime"].I8603.$aCustom[I8691], Array('tables'=>$aCustom[I8690] +Array(I8585=>"cms_es_orders",'m'=>'cms_members'), I8692=>$aCustom["joins"] +Array('o|m'=>'m.id=o.id_member'), 'joins_types'=>$aCustom[I8693] +Array('o|m'=>'LEFT OUTER') )," WHERE show_in_admin=1".$this->filter->GetFilterSql().$this->_ApplyFilters(), I8622, I8640, "o.id", Array( I8694=>'m.username', 'order_username'=>'o.username', 'order_firstname'=>I8695, 'order_lastname'=>'o.lastname', 'status'=>'o.status', I8696=>'(o.tax+o.shipping+o.total)', 'member_name'=>'CONCAT(m.firstname, m.lastname)' ),_DB_STRAIGHT_JOIN );$this->browser->AddSQLJoinedTables($this->cms->Core, I8585, Array('m'=>I8697)); $IIlL1Ll['applied_id'] ='o.id'; $this->browser->ProcessSQL($this->db); $lIlIILL =Array(); $lIlIIL1 =Array(); if($this->db->num_rows() >0) {while($this->db->next_record()) {$lIlIILL[] =$this->db->Record[I8623]; $lIlIIL1[$this->db->Record[I8623]] =Array( 'tax' => $this->db->Record["tax"], I8698 => $this->db->Record["excise_tax"], 'shipping_tax' => $this->db->Record[I8651] );}$sql ="SELECT id_order, qty, ext_data FROM cms_es_order_items WHERE id_order IN(".implode(",", $lIlIILL).") ORDER BY `id_order` ASC"; unset($lIlIILL); $this->db->query($sql); $aOrderItems =Array(); $lastOrderId =0; $count =0; while($this->db->next_record()) {$orderId =(int)$this->db->Record['id_order']; if($orderId != $lastOrderId) {if($lastOrderId){ $this->TIIlll1($lIlIIL1, $aOrderItems, $lastOrderId); $aOrderItems =array(); }$lastOrderId =$orderId; }$aOrderItems[] =unserialize($this->db->Record[I8670]) +Array(I8674=>$this->db->Record[I8674]); }$this->TIIlll1($lIlIIL1, $aOrderItems, $orderId); }unset($lIlIIL1); if(is_array($this->lII1LLL) && sizeof($this->lII1LLL) >1) {$lIlII1I ="_popup"; }else {$lIlII1I =I8622; }$IIlL1Ll['fields'] =Array( 'other_fields'=>Array(I8699=>'callback', 'object'=>&$this, 'method'=>'_OrderRow'), I8700=>Array(I8699=>'stripline', 'size'=>27), 'status'=>Array(I8699=>'get_word', I8701=>&$this->words, "default_word"=>"unknown"), "action_print"=>Array(I8625=>"flagicon", I8702=>I8622, I8623=>"print_id", "on"=>$this->moduleName."_list:print".$lIlII1I,"off"=>I8622), I8703=>Array(I8625=>"flagicon", I8702=>I8622, I8623=>"edit_id", "on"=>$this->moduleName."_list:edit",I8704=>I8622), "action_del"=>Array(I8625=>"flagicon", I8702=>I8622, I8623=>"del_id", "on"=>$this->moduleName.I8705,I8704=>I8622) );$aCustom += $IIlL1Ll; $aCustom["fields"] += $IIlL1Ll["fields"]; $this->oEshop->pushCurrencyData(); $aCustom["form_data"]["buttons"] =Array(I8706, "cancel", "save"); parent::TTTlI11($vData, $aCustom); $this->oEshop->TT11T1T(); }function TTT11Tl(&$IILILII) {$IILILII[] ="leg_yellow"; $IILILII[] ="leg_blue"; $IILILII[] =I8707; $IILILII[] ="leg_edit"; $IILILII[] ="leg_del"; }function _OrderRow(&$aItem, &$aData) {$aItem["member_name"] =I8622; $aItem["order_member_name"] =I8622; $memberDeleted =false; if($aItem[I8605] != I8622) {if($aItem[I8708] != I8622) {$aItem["member_name"] .= $aItem[I8708].I8657; }$aItem["member_name"] .= $aItem["lastname"]; if($aItem["member_name"] == I8622) {$aItem[I8709] =$aItem[I8605]; }}else {$memberDeleted =true; $aItem[I8709] =$this->words['unknown']; }if($aItem["order_firstname"] !=I8622) {$orderMemberName =$aItem["order_firstname"].I8657; }$orderMemberName .= $aItem["order_lastname"]; if($orderMemberName == I8622) {$orderMemberName =$aItem[I8606]; }if($memberDeleted || $aItem[I8709] != $orderMemberName) {$aItem[I8710] =$this->cms->Gui->getAbs($this->moduleName."_list:order_member_name", Array(I8710=>$orderMemberName)); }$extData =unserialize($aItem[I8670]); $this->oEshop->setCurrencyData($extData[I8630], $extData["base_currency"][I8631]); $shipping =$this->oEshop->convertCurrency($aItem[I8607], $this->oEshop->baseCurrency, $this->defaultCurrency); $lIlII1l =$this->lII1LLI[$aItem[I8623]] +$shipping; $aItem[I8653] =$this->oEshop->formatMoney($lIlII1l, $this->defaultCurrency); $this->lII1LLl += $this->oEshop->formatNumber($lIlII1l, true, true); if($aData["_num_rows"] == ($aItem["row_index"] +1)) {if(($aItem[I8711] +1)%2) {$aData["style"] =$this->browser->style["even"]; }else {$aData["style"] =$this->browser->style["simple"]; }$aData[I8712] =$this->oEshop->formatMoney($this->lII1LLl, $this->defaultCurrency); $aData["row_total"] =$this->cms->Gui->get($this->moduleName."_list:row_total", $aData); }}protected function TIIlll1($lIlIIL1, $aOrderItems, $orderId){ $amount =0; $shipping =0; foreach($aOrderItems as $extData) {$itemPrice =$this->oEshop->convertCurrency($extData[I8641][I8672], $extData[I8630][I8631], $this->defaultCurrency); $itemPrice =$this->oEshop->formatNumber($itemPrice, true, true); $taxItem =$this->oEshop->convertCurrency($extData[I8641][I8671], $extData[I8630][I8631], $this->defaultCurrency); $taxItem =$this->oEshop->formatNumber($taxItem, true, true); $itemPrice *= $extData[I8674]; $taxItem *= $extData[I8674]; $amount += $itemPrice +$taxItem; }$this->lII1LLI[$orderId] =$amount; $this->lII1LLI[$orderId] += $this->oEshop->formatNumber($this->oEshop->convertCurrency($lIlIIL1[$orderId][I8651], $extData[I8630][I8631], $this->defaultCurrency), true, true); $this->lII1LLI[$orderId] += $this->oEshop->formatNumber($this->oEshop->convertCurrency($lIlIIL1[$orderId]["excise_tax"], $extData[I8630][I8631], $this->defaultCurrency), true, true); }public function ruleDefaultCurrencyCB($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ='getallvalues'){ static $aCodes =null; if(is_null($aCodes)){ $aCodes =array(); foreach($this->oEshop->aCurrency as $code => $aCurrency){ if(!mb_strlen($code)){ continue; }$aCodes[$code] =$aCurrency[I8700]; }}$passedValue =$cData[I8713]; $lIlII1L =isset($passedValue[$this->langData]) ?$passedValue[$this->langData] :I8592; switch($IIL1l1I){ case 'getallvalues': $res =array(); foreach($aCodes as $code => $caption){ if(!mb_strlen($code)){ continue; }$res[] =array( I8700 => $code, 'caption' => $caption, 'selected' => $lIlII1L != $code ?I8592 :'selected' );}break; case I8714: $res =$passedValue; if(!isset($aCodes[$passedValue]) && sizeof($aCodes)){ list($code, )=each($aCodes); $res =$code; }break; case 'getvalue': $res =$lIlII1L; break; case 'apply': $previousValue =$this->cms->Core->GetModOption($IIL1lL1[I8715], 'default_currency'); $previousValue[$this->langData] =$passedValue; $aData['real_value'] =$previousValue; break; }return true; }}