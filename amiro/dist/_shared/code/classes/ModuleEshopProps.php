<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       24683 xkqwrurztumizqinypwxxmxtpiulztmygznstrxxqmypuzxuztuwylrpxwqrkzgpmtzqpnir
 */ ?><?php foreach(array(8792=>"MtQImS",8793=>"WZtmS",8794=>"DZvQ",8795=>'qDOHGzSIMn`GOG',8796=>"^",8797=>"{?ZnS?MD|GrHG=1",8798=>"DWrMGtD",8799=>"DuYIMt|ZGGJB",8800=>"rQDt|tHtZJ",8801=>"",8802=>"RqVqRdq}whNV}GrHG|",8803=>"fnuI",8804=>"'",8805=>'!',8806=>"ftBGQ",8807=>"GrHG|",8808=>"fJZP",8809=>"ZSS|GrHGD",8810=>"rQDt",8811=>"GrMWQ",8812=>"DtHG",8813=>"%HGQr|oWQJJ",8814=>"SQfZuJt|GZrZID",8815=>"rQf|tZYJQ|nuI",8816=>"nuI",8817=>"W",8818=>"GMWturQ",8819=>"RhhT|gzTo|ccc",8820=>"GMWturQ|WZt",8821=>"GMW|ZSS|",8822=>"GMWturQD|LD|vZrD",8823=>"ZSS|vZJuQ",8824=>"ZSS|",8825=>"QSMt|GMWturQ",8826=>"rQf|DHrt",8827=>"|rQfQrQnWQ|",8828=>"%GrHG|zWQJJ|DQJQWt",8829=>"fJZP|nZIQD",8830=>"GrHGD|nuID",8831=>"OtBGQ",8832=>"%GrHG|zrHC",8833=>"%GrHG|tZYJQ",8834=>"HGQrD|JMDt",8835=>"nuI|GrHGD",8836=>"MDhGQrDdOHCn",8837=>"uGSZtQ?",8838=>"SQJQtQ?frHI?",8839=>"rQDt|GrHG|",8840=>"=_Nhc}{",8841=>"|",8842=>'MS|WZtQPHrB',8843=>"rQWZJW|GrHG|SZtZ",8844=>"fMQJSD|IZG|HGQr",8845=>"DMAQ|HGQr|",8846=>"IZDK",8847=>"1",8848=>"IHSMfMQS|SZtQ",8849=>"HGQr|",8850=>"|GrHGD",8851=>"MDgrHGDdOHCn") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopProps extends CMS_ActModule{ public $itemId; public $catId; public $oEshop; public $lIlIL11; public $lIlI1II; function ModuleEshopProps(&$cms, &$db, &$cModule){ parent::CMS_ActModule($cms, $db, $cModule); }function Init($IIll1l1 =Array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =array()){ if(isset($this->cms->Vars[I8792]) && $this->cms->Vars[I8792] != ""){ $this->itemId =$this->cms->Vars[I8792]; }else{ $this->itemId =0; }if(isset($this->cms->Vars["catId"]) && $this->cms->Vars["catId"] != ""){ $this->catId =$this->cms->Vars[I8793]; }else{ $this->catId =0; }$IIIIL11["allowed_actions"] =array("add", "edit", "apply", I8794, "del"); $IIIIL11["picture_cat"] ="eshop"; $aOptions += $IIIIL11; require_once $GLOBALS['CLASSES_PATH'] .I8795; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init($this->moduleName); $this->oEshop->TT1l11l($this->options["multi_sites"], $this->siteId); parent::Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin(){ parent::_InitAdmin(); $sql ="select dataset_data from ".$this->oEshop->dbTablePrefix."_cats where id=".$this->catId; $this->db->query($sql); if($this->db->next_record()){ $this->lIlIL11 =unserialize($this->db->Record["dataset_data"]); $lIlI1Il =array(); foreach(explode(I8796, $this->lIlIL11["fields_map"]) as $lIlI1IL){ if($lIlI1IL >0) $lIlI1Il[] =intval($lIlI1IL); }$IIlLLLL =array(); if(sizeof($lIlI1Il) >0){ $sql ="select * from ".$this->oEshop->dbTablePrefix."_custom_types where id in(".implode(",", $lIlI1Il).I8797; $this->db->query($sql); $custData =array(); while($this->db->next_record()){ $IIlLLLL[$this->db->Record["id"]] =$this->db->Record; }}$this->lIlI1II =array(); foreach($lIlI1Il as $key => $val){ if(isset($IIlLLLL[$val])) $this->lIlI1II["$val"] =$IIlLLLL[$val]; }}if($this->itemId >1100000){ $sql ="delete from ".$this->oEshop->dbTablePrefix."_props where id_item >= 1100000 and modified_date < DATE_ADD(NOW(), INTERVAL -1 DAY)"; $this->db->query($sql); }}function TTTlITT($IIIL11l, $cId, $cModule ='') {$id =intval($cId); switch ($IIIL11l) {default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function &TTTlI1T(&$aCustom) {$data =parent::TTTlI1T($aCustom); $data[I8798] =$this->cms->Gui->getScripts(); $data["metas"] =$this->cms->Gui->getMetas(); $data["status"] =$this->cms->GetStatusMessages(); global $conn; print $this->cms->Gui->get($this->module->GetName(), $data); $conn->Out(); die(); }function TTTlI1I(&$vData) {$vData["submit_add"] =""; $vData[I8799] ="disabled"; $vData["action"] ="add"; $vData["item_id"] =$this->itemId; parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {$vData[I8800] ="0"; if(sizeof($this->lIlI1II) >0){ $sql ="select show_all_props from ".$this->oEshop->dbTablePrefix."_items where id=".intval($this->itemId); $this->db->query($sql); $lIlI1I1 =0; if($this->db->next_record()){ $lIlI1I1 =$this->db->Record["show_all_props"]; }$lIlI1lI =0; $header =I8801; $IL1Il1l =array(); $lIlI1ll =array(); foreach($this->lIlI1II as $id => $data){ if($data["ftype"] == "flagmap" && $data["value_type"] == "scalar") $IL1Il1l[] =I8802.$data["fnum"].", 10, 2)) as prop_".$data["fnum"]; else $IL1Il1l[] ="prop_".$data[I8803]; if($data["value_type"] != "scalar" && $data["value_type"] != I8801 && $data["ref_table_num"] >= 0){ $sql ="select name, value_1 from ".$this->oEshop->dbTablePrefix."_reference_".sprintf("%04d", $data["ref_table_num"])." where lang='".$this->langData.I8804; $this->db->query($sql); while($this->db->next_record()){ if(!isset($lIlI1ll[$data[I8803]][$this->db->Record["value_1"]])){ $lIlI1ll[$data[I8803]][$this->db->Record["value_1"]] =$this->db->Record["name"]; }}}}$sql ="select ".implode(I8805, $IL1Il1l).", rest, price, size, weight, stop, mask from ".$this->oEshop->dbTablePrefix."_props where id_item=".$this->itemId." and lang='".$this->langData."' order by id"; $this->db->query($sql); while($this->db->next_record()){ $I1III1I =array(); foreach($this->lIlI1II as $id => $data){ if($data[I8806] == "flagmap" && $data["value_type"] == "scalar"){ $ILLIL1l =unserialize($data["default_params"]); $I1III1I[] =I8804.TlTllIT($this->db->Record[I8807.$data[I8803]], true, true).I8804; $lIlI1lL =array(); for($i =1; $i <= sizeof($ILLIL1l["flag"][$this->langData]); $i++){ if($ILLIL1l["flag"][$this->langData][$i]["u"] && $this->db->Record[I8807.$data[I8803]][$i-1] == "1") $lIlI1lL[] =$ILLIL1l[I8808][$this->langData][$i]["c"]; }$I1III1I[] =I8804.implode('<br>', $lIlI1lL).I8804; }else{ $I1III1I[] =I8804.$this->db->Record[I8807.$data[I8803]].I8804; if(isset($lIlI1ll[$data[I8803]])){ $I1III1I[] =I8804.$lIlI1ll[$data[I8803]][$this->db->Record[I8807.$data[I8803]]].I8804; }else{ $I1III1I[] =I8804.$this->db->Record[I8807.$data[I8803]].I8804; }}}if($this->db->Record["mask"] == "1"){ $vData[I8809] .= $this->cms->Gui->getAbs($this->module->GetName().":prop_add", array("prop_data" => implode(",", $I1III1I), "rest" => intval($this->db->Record[I8810]))); $vData[I8800] += intval($this->db->Record[I8810]); }else $vData["add_opers"] .= $this->cms->Gui->getAbs($this->module->GetName().":oper_add", array("oper_data" => implode(",", $I1III1I), I8811 => I8804.$this->db->Record[I8811].I8804, "weight" => I8804.$this->db->Record["weight"].I8804, "size" => I8804.$this->db->Record["size"].I8804, I8812 => I8804.intval($this->db->Record[I8812]).I8804)); }$lIlI1l1 =true; $counter =0; foreach($this->lIlI1II as $id => $data){ $header .= $this->cms->Gui->getAbs($this->module->GetName().":prop_Hcell", array("is_first" => $lIlI1l1, "name" => $this->lIlIL11["fields_captions"][$id])); $lIlI1LI .= $this->cms->Gui->getAbs($this->module->GetName().I8813, array("is_first" => $lIlI1l1, "name" => $this->lIlIL11["fields_captions"][$id])); $lIlI1l1 =false; if($data[I8806] == "flagmap"){ $ILLIL1l =unserialize($data[I8814]); }$lIlI1Ll ='text'; if($data["value_type"] == "scalar" || $data["value_type"] == I8801 || $data[I8815] <= 0){ if($data[I8806] == "flagmap"){ $lIlI1Ll ='hidden'; $flags =I8801; $lIlI1LL =I8801; for($i =1; $i <= sizeof($ILLIL1l[I8808][$this->langData]); $i++){ if($ILLIL1l[I8808][$this->langData][$i]["u"]){ $flags .= $this->cms->Gui->getAbs($this->module->GetName().":prop_Acell_checkbox_item", array(I8803 => $data[I8803], I8816 => $i, "name" => $ILLIL1l[I8808][$this->langData][$i]["c"])); $lIlI1LL .= $this->cms->Gui->getAbs($this->module->GetName().":oper_Acell_checkbox_item", array(I8803 => $data[I8803], I8816 => $i, "name" => $ILLIL1l[I8808][$this->langData][$i][I8817])); }}$lIlI1L1 .= $this->cms->Gui->getAbs($this->module->GetName().":prop_Acell_checkbox", array(I8803 => $data[I8803], "flags" => $flags)); $lIlI11I .= $this->cms->Gui->getAbs($this->module->GetName().":oper_Acell_checkbox", array(I8803 => $data[I8803], "flags" => $lIlI1LL)); }else if($data[I8806] == I8818){ if(!isset($vData["pictures_js_vars"])) {$vData["pictures_js_vars"] =I8801; $vData["pictures_js_script"] =I8801; }$vData["www_path"] =$GLOBALS[I8819]; foreach(array("prop", "oper") as $lIlI11l){ $aPicData =Array('url' => 'ce_img_proc.php?cat='.$this->options[I8820].'&fld=add_'.$lIlI11l.'_'.$data[I8803].'&lang='.$this->cms->lang, 'id'=>I8821.$lIlI11l."_".$data[I8803]); $addPic =$this->cms->Gui->get($this->moduleName.":images_add", $aPicData); $editPic =$this->cms->Gui->get($this->moduleName.":images_edit", $aPicData); $data['edit_picture'] =$addPic; $vData[I8822] .= $this->cms->Gui->getAbs($this->moduleName.":pictures_js_vars", Array("name"=>"add_".$lIlI11l."_".$data[I8803], I8823=>jparse($addPic), "edit_value"=>jparse($editPic))); $vData["pictures_js_script"] .= $this->cms->Gui->getAbs($this->moduleName.":pictures_js_script", Array("name"=>I8824.$lIlI11l."_".$data[I8803])); if($lIlI11l == "prop") $lIlI1L1 .= $this->cms->Gui->getAbs($this->module->GetName().":prop_Acell_picture", array(I8803 => $data[I8803], "edit_picture" => $data[I8825])); else $lIlI11I .= $this->cms->Gui->getAbs($this->module->GetName().":oper_Acell_picture", array(I8803 => $data[I8803], I8825 => $data[I8825])); }}else{ $lIlI1L1 .= $this->cms->Gui->getAbs($this->module->GetName().":prop_Acell_text", array(I8803 => $data[I8803])); $lIlI11I .= $this->cms->Gui->getAbs($this->module->GetName().":oper_Acell_text", array(I8803 => $data[I8803])); }}else{ $lIlI1Ll ="select"; $options =I8801; $lIlI11L =I8801; $default_params =unserialize($data[I8814]); $SortCol =(!empty($default_params[I8826]))? $default_params[I8826] :"id"; $SortDim =(!empty($default_params["ref_sort_method"]))? $default_params["ref_sort_method"] :I8801; $sql ="select name, value_1 from ".$this->oEshop->dbTablePrefix.I8827.sprintf("%04d", $data[I8815])." where lang='".$this->langData."' GROUP BY value_1 ORDER BY ".$SortCol." ".$SortDim; $this->db->query($sql); $lIlI11L .= $this->cms->Gui->getAbs($this->module->GetName().":oper_Acell_select_option", array("name" => $this->words["prop_any"], "value" => '')); while($this->db->next_record()){ $options .= $this->cms->Gui->getAbs($this->module->GetName().":prop_Acell_select_option", array("name" => $this->db->Record["name"], "value" => $this->db->Record["value_1"])); $lIlI11L .= $this->cms->Gui->getAbs($this->module->GetName().":oper_Acell_select_option", array("name" => $this->db->Record["name"], "value" => $this->db->Record["value_1"])); }$lIlI1L1 .= $this->cms->Gui->getAbs($this->module->GetName().I8828, array(I8803 => $data[I8803], "options" => $options)); $lIlI11I .= $this->cms->Gui->getAbs($this->module->GetName().":oper_Acell_select", array(I8803 => $data[I8803], "options" => $lIlI11L)); }if($data[I8806] == "flagmap"){ $vData[I8829] .= $this->cms->Gui->getAbs($this->module->GetName().":flag_names_new", array(I8803 => $data[I8803])); for($i =1; $i <= sizeof($ILLIL1l[I8808][$this->langData]); $i++){ if($ILLIL1l[I8808][$this->langData][$i]["u"]) $vData[I8829] .= $this->cms->Gui->getAbs($this->module->GetName().":flag_names", array(I8803 => $data[I8803], I8816 => $i, "name" => $ILLIL1l[I8808][$this->langData][$i][I8817])); }}$vData[I8830] .= $this->cms->Gui->getAbs($this->module->GetName().":props_nums", array(I8816 => $counter, I8803 => intval($data[I8803]), "htype" => $lIlI1Ll)); $vData["opers_nums"] .= $this->cms->Gui->getAbs($this->module->GetName().":opers_nums", array(I8816 => $counter, I8803 => intval($data[I8803]), I8831 => $lIlI1Ll)); $counter ++; }$header =$this->cms->Gui->getAbs($this->module->GetName().":prop_Hrow", array("data" => $header)); $lIlI1LI =$this->cms->Gui->getAbs($this->module->GetName().":oper_Hrow", array("data" => $lIlI1LI)); $lIlI1L1 =$this->cms->Gui->getAbs($this->module->GetName().I8832, array("data" => $lIlI1L1)); $lIlI11I =$this->cms->Gui->getAbs($this->module->GetName().":oper_Arow", array("data" => $lIlI11I)); $vData["props_list"] =$this->cms->Gui->getAbs($this->module->GetName().I8833, array("header" => $header, "add_row" => $lIlI1L1, "show_all_props" => $lIlI1I1 ?"checked" :I8801)); $vData[I8834] =$this->cms->Gui->getAbs($this->module->GetName().":oper_table", array("header" => $lIlI1LI, "add_row" => $lIlI11I)); $vData["num_opers"] =$vData[I8835] =count($this->lIlI1II); $vData["isPropsShown"] =isset($this->itemData["isPropsShown"]) ?$this->itemData["isPropsShown"] :1; $vData["isOpersShown"] =isset($this->itemData[I8836]) ?$this->itemData[I8836] :0; }}function TTTl1ll($cId, $cModule) {if(sizeof($this->lIlI1II) >0){ $lIlI111 =array( $this->itemId => $this->catId );$sql ='select id, id_category from ' .$this->oEshop->dbTablePrefix .'_items where id_source=' .$this->itemId; $this->db->query($sql); while($this->db->next_record()){ $lIlI111[$this->db->Record['id']] =$this->db->Record['id_category']; }$sql =I8837.$this->oEshop->dbTablePrefix."_items set show_all_props=".intval($this->cms->VarsPost["show_all_props"])." where id in (" .implode(I8805, array_keys($lIlI111)) .")"; $this->db->query($sql); $sql =I8838.$this->oEshop->dbTablePrefix."_props where id_item in (" .implode(I8805, array_keys($lIlI111)) .") and lang='".$this->langData."' and mask=1"; $this->db->query($sql); $counter =0; foreach(explode(I8796, $this->cms->VarsPost["fields_map"]) as $IL1l1L1){ if($IL1l1L1 >0){ $lIllIII =array(I8810 => $this->cms->VarsPost[I8839.$IL1l1L1], "mask" => "1", "lang" => $this->langData, "modified_date" => I8840); foreach($this->lIlI1II as $key => $arr){ if(($arr["value_type"] == "scalar" || $arr["value_type"] == I8801 || $arr[I8815] <= 0) && $arr[I8806] == "flagmap"){ if(empty($this->cms->VarsPost[I8807.$arr[I8803].I8841.$IL1l1L1])) $this->cms->VarsPost[I8807.$arr[I8803].I8841.$IL1l1L1] ="0"; $lIllIII[I8807.$arr[I8803]] ="=|CONV('".strrev(TlTllT1($this->cms->VarsPost[I8807.$arr[I8803].I8841.$IL1l1L1]))."', 2, 10)"; }else{ $lIllIII[I8807.$arr[I8803]] =$this->cms->VarsPost[I8807.$arr[I8803].I8841.$IL1l1L1]; }}foreach($lIlI111 as $itemId => $catId){ $lIllIII['id_item'] =$itemId; $lIllIII[I8842] =$catId; $sql =$this->db->GenInsertSql($this->oEshop->dbTablePrefix."_props", $lIllIII); $this->db->query($sql); }$counter++; }}$this->cms->AddStatusMsg("properties_saved", "blue", I8801, I8801, array(I8816 => $counter.I8801)); if($this->itemId <= 1100000){ foreach($lIlI111 as $itemId => $catId){ $this->TTT1lI1($aExtData =Array("action"=>I8843, "id"=>$itemId)); }}}$this->itemData["isPropsShown"] =$this->cms->VarsPost["isPropsShown"]; $this->itemData[I8836] =$this->cms->VarsPost[I8836]; }function TTTl1lI($cId, $cModule) {if(sizeof($this->lIlI1II) >0){ $lIlI111 =array( $this->itemId => $this->catId );$sql ='select id, id_category from ' .$this->oEshop->dbTablePrefix .'_items where id_source=' .$this->itemId; $this->db->query($sql); while($this->db->next_record()){ $lIlI111[$this->db->Record['id']] =$this->db->Record[I8842]; }$sql =I8838.$this->oEshop->dbTablePrefix."_props where id_item in (" .implode(I8805, array_keys($lIlI111)) .") and lang='".$this->langData."' and mask!=1"; $this->db->query($sql); $counter =0; foreach(explode(I8796, $this->cms->VarsPost[I8844]) as $IL1l1L1){ if($IL1l1L1 >0){ $lIllIII =array(I8811 => $this->cms->VarsPost["price_oper_".$IL1l1L1], "weight" => $this->cms->VarsPost["weight_oper_".$IL1l1L1], "size" => $this->cms->VarsPost[I8845.$IL1l1L1], I8812 => $this->cms->VarsPost["stop_oper_".$IL1l1L1] == "1" ?"1" :"0", I8846 => bindec((!empty($this->cms->VarsPost["price_oper_".$IL1l1L1]) ?"1" :"0"). (!empty($this->cms->VarsPost["weight_oper_".$IL1l1L1]) ?I8847 :"0"). (!empty($this->cms->VarsPost[I8845.$IL1l1L1]) ?I8847 :"0"). "0"), "lang" => $this->langData, I8848 => I8840); foreach($this->lIlI1II as $key => $arr){ if(($arr["value_type"] == "scalar" || $arr["value_type"] == I8801 || $arr[I8815] <= 0) && $arr[I8806] == "flagmap"){ if(empty($this->cms->VarsPost[I8849.$arr[I8803].I8841.$IL1l1L1])) $this->cms->VarsPost[I8849.$arr[I8803].I8841.$IL1l1L1] ="0"; $lIllIII[I8807.$arr[I8803]] ="=|CONV('".strrev(TlTllT1($this->cms->VarsPost[I8849.$arr[I8803].I8841.$IL1l1L1]))."', 2, 10)"; }else{ $lIllIII[I8807.$arr[I8803]] =$this->cms->VarsPost[I8849.$arr[I8803].I8841.$IL1l1L1]; }}foreach($lIlI111 as $itemId => $catId){ $lIllIII['id_item'] =$itemId; $lIllIII[I8842] =$catId; $sql =$this->db->GenInsertSql($this->oEshop->dbTablePrefix.I8850, $lIllIII); $this->db->query($sql); }$counter++; }}$this->cms->AddStatusMsg("operators_saved", "blue", I8801, I8801, array(I8816 => $counter.I8801)); if($this->itemId <= 1100000){ foreach($lIlI111 as $itemId => $catId){ $this->TTT1lI1($aExtData =Array("action"=>I8843, "id"=>$itemId)); }}}$this->itemData[I8851] =$this->cms->VarsPost[I8851]; $this->itemData[I8836] =$this->cms->VarsPost[I8836]; }}