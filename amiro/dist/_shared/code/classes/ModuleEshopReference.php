<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       27424 xkqwzqswlkinrmymkytrsnpknruuutxkuirgnqkgwlqgxsxylzlrkinkmimikinlzgpmpnir
 */ ?><?php foreach(array(8852=>'',8853=>"DZvQ",8854=>"PQn|KQBCHrSD",8855=>"SQDWrMGtMHn",8856=>'qDOHGzSIMn`GOG',8857=>"rQfQrQnWQ|nZIQ",8858=>"tZYJQ|nuI",8859=>"fJt|tZYJQ|nZIQ",8860=>"ftBGQ",8861=>"SQDWrMYQ",8862=>"",8863=>"tQxt",8864=>"DQJQWt",8865=>"rQJZtQS|MtQID",8866=>"nHnQ",8867=>"fJZPIZG",8868=>"nuI",8869=>"vZJuQ",8870=>"IZG",8871=>"^",8872=>"vZJuQ|1",8873=>"WOQWKQS",8874=>"fJHZt",8875=>"1",8876=>"!?0?ZD?vZJuQ!?'",8877=>"?",8878=>'ZWtMHn',8879=>'HYLQWt',8880=>'DMAQ',8881=>'MS',8882=>'JQP|rQS',8883=>"fHrI|SZtZ",8884=>"JMDt|SZtZ",8885=>"SZtQ",8886=>"coqRq?MS='",8887=>"!",8888=>"FRhi?",8889=>'QrrnH',8890=>"DKu|WHSQ",8891=>"=_whNV}'",8892=>'MS|QxtQrnZJ',8893=>'vZJuQ|1',8894=>'x',8895=>"MD|GrHG",8896=>"='",8897=>"'",8898=>"|MtQID?DQt?",8899=>"GrHG|",8900=>"|GrHGD?DQt?") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopReference extends CMS_ActModule {public $oEshop; public $lIllIIl; public $lIllIIL; public $lIllII1; public $ILLILl1; public $lIllIlI; public $lIllIll; public $ILLIL1l; public $lIllIlL; public $lIllIl1; public $tablePrefix; function ModuleEshopReference(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->lIllII1 =false; $this->ILLILl1 =4; $this->lIllIlI =""; $this->lIllIll =array(); $this->ILLIL1l =array(); $this->lIllIlL =array(); $this->lIllIl1 =array(); $this->tablePrefix ='cms_'; }function _Init($IIll1l1 =Array(), $IIll1LI =I8852, $IIll1Ll =I8852, $aOptions =Array()) {$this->lIllIIL =0; $IIIIL11["allowed_actions"] =Array("add", "edit", "apply", I8853, "del"); $IIIIL11["group_operations"] =Array("del", "gen_sublink", I8854, "index_details", "no_index_details"); $IIIIL11["use_options_form"] =true; $IIIIL11["announce_field_name"] =I8855; $IIIIL11["front_mod_name"] =$this->module->GetOwnerName()."_reference_types"; $IIIIL11["use_positions"] =true; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function TTTlTI1() {parent::TTTlTI1(); }function _InitAdmin() {parent::_InitAdmin(); require_once $GLOBALS['CLASSES_PATH'] .I8856; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init($this->moduleName); $this->oEshop->TT1l11l($this->options["multi_sites"], $this->siteId); $this->TIIll1I(true); $lIllILI =$this->cms->Gui->ParseLangFile($GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/lang/".$this->oEshop->ownerName."_reference.lng"); $sql ="select table_num, name, default_caption from ".$this->oEshop->dbTablePrefix."_ref_types order by table_num"; $this->db->query($sql); $this->lIllIl1 =array(); while($this->db->next_record()){ $ILLI1lI =unserialize($this->db->Record["name"]); if(!is_array($ILLI1lI)) $ILLI1lI =array(); if(isset($ILLI1lI[$this->langData])) $name =$ILLI1lI[$this->langData]; else $name =$this->words["unknown"]; if($this->lIllIIL == $this->db->Record["table_num"]) {$this->lIllIlL[I8857] =$name; $lIllILl =unserialize($this->db->Record["default_caption"]); if(is_array($lIllILl) && isset($lIllILl[$this->langData])) {$this->lIllIlL["reference_caption"] =$lIllILl[$this->langData]; }else {$this->lIllIlL["reference_caption"] =$this->words["unknown"]; }}$this->lIllIl1[$name] =$this->db->Record[I8858]; }ksort($this->lIllIl1); }function TIIll1I($force =false) {if(!$this->lIllII1 || $force){ $this->lIllII1 =true; $lIllILL =isset($this->cms->Vars["flt_table_name"]) ?intval($this->cms->Vars["flt_table_name"]) :0; if($lIllILL != $this->lIllIIL || empty($this->cms->Vars["flt_table_name"])) {if(isset($this->cms->Vars["flt_table_name"]) && $this->cms->Vars[I8859] >0){ $this->lIllIIL =$lIllILL; $lIllIL1 =sprintf("%0".$this->ILLILl1."d", $this->lIllIIL); $this->lIllIlI =""; $sql ="select ftype, flagmap_data from ".$this->oEshop->dbTablePrefix."_ref_types where table_num='".intval($this->lIllIIL)."'"; $this->db->query($sql); if($this->db->next_record()){ $this->lIllIlI =$this->db->Record["ftype"]; $this->ILLIL1l =unserialize($this->db->Record["flagmap_data"]); if(!is_array($this->ILLIL1l)){ $this->ILLIL1l =array(); }$this->cms->Gui->addGlobalVars(array("REFERENCE_TYPE" => $this->db->Record[I8860])); }}else {$lIllIL1 =sprintf("%0".$this->ILLILl1."d", "1"); }$this->lIllIIl =$this->oEshop->dbTablePrefix."_reference_".$lIllIL1; if(mb_strpos($this->lIllIIl, $this->tablePrefix) === 0) $this->lIllIIl =mb_substr($this->lIllIIl, mb_strlen($this->tablePrefix)); $this->module->SetTableName($this->lIllIIl); $this->lIllIll =array(); $this->db->setSafeSQLOptions(I8861); $sql ="DESCRIBE ".$this->tablePrefix.$this->lIllIIl; $this->db->query($sql); while($this->db->next_record()){ if(mb_strpos($this->db->Record["Field"], "value_") === 0){ $this->lIllIll[] =$this->db->Record["Field"]; }}}}}function ProcessAction($IIIL11l, $cId, $cModule =I8862) {$this->TIIll1I(true); parent::ProcessAction($IIIL11l, $cId, $cModule); }function TTTlIII() {parent::TTTlIII(); $this->filter->TITI1l1("datefrom"); $this->filter->TITI1l1("dateto"); $lIllI1I =$this->filter->TITI1TT($lIllI1I, Array($this->cms->Words["no"]=>0), 55); foreach($this->lIllIl1 as $lIllI1l => $lIllI1L) $lIllI1I =$this->filter->TITI1TT($lIllI1I, array($lIllI1l => $lIllI1L), 500); $this->filter->AddField("flt_name", I8863, stripslashes(unhtmlentities($this->cms->Vars["flt_name"])), I8862, " like ", "name"); $this->filter->MoveField("flt_name",_MOVE_PREV); $this->filter->AddField(I8859, I8864, $this->cms->Vars[I8859], I8862, "!=", "id", $lIllI1I); $this->filter->MoveField(I8859, _MOVE_START); $this->filter->DisableFieldSQL(I8859); }function TTTlI1I(&$vData) {$this->TIIll1I(); if($this->lIllIIL >0){ $this->cms->Gui->AddGlobalVars(Array("FULL_FORM"=>"1")); }parent::TTTlI1I($vData); $lIllI11 =array(); switch($this->lIllIlI){ case I8865: $lIllI11["value"] =I8862; $lIllI11["custom_related_items_add"] ="inline"; $lIllI11["custom_related_items_edit"] =I8866; $lIllI11["related_items_number"] ="0"; break; case "related_cats": $lIllI11["value"] =I8862; $lIllI11["custom_related_cats_add"] ="inline"; $lIllI11["custom_related_cats_edit"] =I8866; $lIllI11["related_cats_number"] ="0"; break; case I8867: if(isset($this->ILLIL1l[$this->langData]["map"])){ for($i =0; $i <mb_strlen($this->ILLIL1l[$this->langData]["map"]); $i++){ if($this->ILLIL1l[$this->langData]["map"][$i] == "1") $lIllI11[] =array(I8868 => $i+1, "name" => $this->ILLIL1l[$this->langData]["name"][$i+1], "checked" => I8862); }}break; case "date": $lIllI11[I8869] =date($this->cms->DFMT["php"], time()); break; case "int": case "float": default: $lIllI11[I8869] =I8862; break; }$vData["custom_control_data"] =$lIllI11; $vData["REFERENCE_DATA_TYPE"] =$this->lIllIlI; $vData['form_width'] ='100%'; }function TTTlI11(&$vData, &$aCustom) {if($this->lIllIlI == I8867 && (!isset($this->ILLIL1l[$this->langData]["map"]) || mb_strlen(str_replace("0", I8862, $this->ILLIL1l[$this->langData][I8870])) == 0)){ $this->cms->Gui->addGlobalVars(array("FULL_FORM" => 2)); }$lIllI11 =array(); if($this->itemData["id"] >0){ switch($this->lIllIlI){ case I8865: $lIllI11[I8869] =$this->itemData["value_1"]; $lIllI11["custom_related_items_add"] =I8866; $lIllI11["custom_related_items_edit"] ="inline"; $lIllI11["related_items_number"] ="0"; if(!empty($this->itemData["value_1"])){ foreach(explode(I8871, $this->itemData["value_1"]) as $key => $val){ if(intval($val) >0) $lIllI11["related_items_number"] ++; }}break; case "related_cats": $lIllI11[I8869] =$this->itemData["value_1"]; $lIllI11["custom_related_cats_add"] =I8866; $lIllI11["custom_related_cats_edit"] ="inline"; $lIllI11["related_cats_number"] ="0"; if(!empty($this->itemData[I8872])){ foreach(explode(I8871, $this->itemData[I8872]) as $key => $val){ if(intval($val) >0) $lIllI11["related_cats_number"] ++; }}break; case I8867: if(isset($this->ILLIL1l[$this->langData][I8870])){ for($i =0; $i <mb_strlen($this->ILLIL1l[$this->langData][I8870]); $i++){ if($this->ILLIL1l[$this->langData][I8870][$i] == "1") $lIllI11[] =array(I8868 => $i+1, "name" => $this->ILLIL1l[$this->langData]["name"][$i+1], I8873 => $this->itemData[I8867][$i] == "1" ?I8873 :I8862); }}break; case "date": $lIllI11[I8869] =date($this->cms->DFMT["php"], strtotime($this->itemData[I8872])); break; case "int": $lIllI11[I8869] =intval($this->itemData[I8872]); break; case I8874: $lIllI11[I8869] =floatval($this->itemData[I8872]); break; default: $lIllI11[I8869] =$this->itemData[I8872]; break; }}else $lIllI11 =$vData["custom_control_data"]; $vData["is_autofill"] ="0"; if($this->lIllIlI == I8865){ $vData["value_field"] =$this->cms->Gui->getAbs($this->moduleName."_subform:value_field_related_items", $lIllI11); }elseif($this->lIllIlI == "related_cats"){ $vData["value_field"] =$this->cms->Gui->getAbs($this->moduleName."_subform:value_field_related_cats", $lIllI11); }elseif($this->lIllIlI == I8867){ for($i =0; $i <sizeof($lIllI11); $i++) $vData["value_field"] .= $this->cms->Gui->getAbs($this->moduleName."_subform:value_field_flagmap", $lIllI11[$i]); }elseif($this->lIllIlI == "date"){ $vData["value_field"] =$this->cms->Gui->getAbs($this->moduleName."_subform:value_field_date", $lIllI11); $vData["is_autofill"] =I8875; }elseif($this->lIllIlI == I8863){ $vData["value_field"] =$this->cms->Gui->getAbs($this->moduleName."_subform:value_field_text", $lIllI11); $vData["is_autofill"] =I8875; }else{ $vData["value_field"] =$this->cms->Gui->getAbs($this->moduleName."_subform:value_field_base", $lIllI11); $vData["is_autofill"] =I8875; }$this->browser->InitSQL("id, name".(sizeof($this->lIllIll) >0 ?", ".implode(", ", $this->lIllIll) :I8862).I8876.$this->lIllIlI."' as ftype, sku_code, description, date_format(date,'".$this->cms->DFMT["db"]."') as fdate", "FROM ".$this->tablePrefix.$this->lIllIIl.I8877, "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), I8862, "name" );$aCustom['fields'] =Array( 'name'=>Array(I8878=>'stripline', 'size'=>25), 'value'=>Array(I8878=>'callback', I8879=>&$this, 'method'=>'_createValueCB'), 'description'=>Array(I8878=>'stripline', I8880=>200), 'actions'=>Array(I8878=>'actions', 'set'=>$this->moduleName.'_list:icons_edit_del', I8881=>Array('edit_id', 'del_id')), );$aCustom['applied_id'] =I8881; $aCustom['legend'] =Array(I8882, 'leg_yellow', 'leg_blue', 'leg_edit', 'leg_del'); $aCustom[I8883]["buttons"] =Array("add", "apply", "cancel", I8853); $aCustom[I8884]["linkAddon"] ="|refnum=".$this->lIllIIL; parent::TTTlI11($vData, $aCustom); if($this->lIllIIL == 0) $vData["list_table"] =I8862; }function _createValueCB(&$aItem, &$aData){ if($aItem[I8860] == "int") $aItem[I8869] =intval($aItem[I8872]); else if($aItem[I8860] == I8874) $aItem[I8869] =floatval($aItem[I8872]); else if($aItem[I8860] == I8885) $aItem[I8869] =date($this->cms->DFMT["php"], strtotime($aItem[I8872])); else if($aItem[I8860] == I8867 || $aItem[I8860] == I8865 || $aItem[I8860] == "related_cats" || $aItem[I8860] == I8863) $this->cms->Gui->addGlobalVars(array("DONOTUSEVALUE" => 1)); else $aItem[I8869] =$aItem[I8872]; }function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $lIlllII =array(); if($this->lIllIlI == I8867){ $lIlllIl =0; if(isset($this->ILLIL1l[$this->langData][I8870])){ $lIlllIl =ceil(mb_strlen($this->ILLIL1l[$this->langData][I8870])/63); }for($i =$lIlllIl; $i >0; $i--){ $lIlllII[] ="CONV(value_".$i.", 10, 2) as value_converted_".$i; }}$sql ="SELECT * ".(sizeof($lIlllII) >0 ?",".implode(",", $lIlllII) :I8862).I8877. "FROM ".$this->tablePrefix.$this->lIllIIl.I8877. I8886.$cId."'".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; for($i =0; $i <sizeof($this->lIllIll); $i++){ $this->itemData[$this->lIllIll[$i]] =$this->db->Record[$this->lIllIll[$i]]; }$this->itemData[I8855] =$this->cms->htmlchars($this->db->Record[I8855]); }if($this->lIllIlI == I8867 && $lIlllIl >0){ $this->itemData[I8867] =I8862; for($i =1; $i <= $lIlllIl; $i++){ $this->itemData[I8867] .= str_pad(strrev($this->db->Record["value_converted_".$i]), 63, "0"); }}}function TTTl1lI($cId, $cModule) {$oldValues =array(); $sql ="SELECT ".implode(I8887, $this->lIllIll).I8877. "FROM ".$this->tablePrefix.$this->lIllIIl.I8877. I8886.$cId."'"; $this->db->query($sql); if($this->db->next_record()){ for($i =0; $i <count($this->lIllIll); $i++) $oldValues[$this->lIllIll[$i]] =$this->db->Record[$this->lIllIll[$i]]; }parent::TTTl1lI($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno'])){ $lIlllIL =array(); $sql ="SELECT ".implode(I8887, $this->lIllIll).I8877. I8888.$this->tablePrefix.$this->lIllIIl.I8877. I8886.$cId."'"; $this->db->query($sql); if($this->db->next_record()){ for($i =0; $i <count($this->lIllIll); $i++) $lIlllIL[$this->lIllIll[$i]] =$this->db->Record[$this->lIllIll[$i]]; }$this->TIIll1l($this->db, $this->oEshop->dbTablePrefix, $this->lIllIIL, $this->lIllIll, $cId, $oldValues, $lIlllIL, "apply"); }}function _ActionDel($cId, $cModule) {$oldValues =array(); $sql ="SELECT ".implode(I8887, $this->lIllIll).I8877. I8888.$this->tablePrefix.$this->lIllIIl.I8877. I8886.$cId."'"; $this->db->query($sql); if($this->db->next_record()){ for($i =0; $i <count($this->lIllIll); $i++) $oldValues[$this->lIllIll[$i]] =$this->db->Record[$this->lIllIll[$i]]; }parent::_ActionDel($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL[I8889]) && $cId >0) $this->TIIll1l($this->db, $this->oEshop->dbTablePrefix, $this->lIllIIL, $this->lIllIll, $cId, $oldValues, array(), "delete"); }function TTT1IlI($aSql =Array(), $cId =0) {$name =$this->cms->VarsPost["name"]; $description =$this->cms->VarsPost[I8855]; if($name != I8852) {$aSql =Array( "name"=>$name, "sku_code"=>$this->cms->VarsPost[I8890], I8855=>$description, );if(!isset($this->cms->VarsPost[I8869])) {$this->cms->VarsPost[I8869] =$name; }if(in_array(I8872, $this->lIllIll)){ switch($this->lIllIlI){ case I8867: $lIlllIl =0; if(isset($this->ILLIL1l[$this->langData][I8870])){ for($i =0; $i <mb_strlen($this->ILLIL1l[$this->langData][I8870]); $i++){ $lIlllIl =ceil(($i+1)/63); $aSql["value_".$lIlllIl] .= $this->cms->VarsPost["value_".($i+1)] == I8875 ?I8875 :"0"; }}for($i =$lIlllIl; $i >0; $i--){ $aSql["value_".$i] =I8891.strrev($aSql["value_".$i])."', 2, 10)"; }break; case "int": $aSql[I8872] =intval($this->cms->VarsPost[I8869]); break; case I8874: $aSql[I8872] =floatval($this->cms->VarsPost[I8869]); break; case I8885: $aSql[I8872] =DateTools::toMysqlDate(DateTools::getCorrectUDate($this->cms->VarsPost[I8869], $this->cms->DFMT["conf"])); break; default: $aSql[I8872] =$this->cms->VarsPost[I8869]; break; }}if(isset($this->cms->VarsPost[I8892])){ $aSql[I8892] =$this->cms->VarsPost[I8892]; }elseif(isset($aSql['value_1'])){ $sql ='SELECT `id` FROM ' .$this->tablePrefix .$this->lIllIIl .' ' ."WHERE `value_1` = '" .mysql_real_escape_string($aSql[I8893]) ."' AND `id` != " .$cId .$this->_ApplyFilters(); if($this->db->getValue($sql)){ $this->cms->AddStatusMsg('status_duplicate_reference_value', 'red'); return array(); }$aSql[I8892] =$aSql[I8893]; }if($cId == 0) $aSql[I8885] =DateTools::toMysqlDate(time()); }if(isset($aSql[I8892])){ $aSql[I8892] =str_replace(';', I8894, $aSql[I8892]); }$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TIIll1l(&$db, $dbTablePrefix, $lIlllI1, $lIllllI, $lIlllll, $lIllllL, $lIllll1, $IIIL11l ="apply"){ $I11LLIL =array(); $lIlllLI =array(); $needUpdate =(is_array($lIllllL) && is_array($lIllll1) && count(array_diff($lIllllL, $lIllll1)) >0); if($needUpdate){ $sql ="select fnum, is_prop from ".$dbTablePrefix."_custom_types where ref_table_num=".intval($lIlllI1)." AND value_type='ref_value'"; $db->query($sql); while($db->next_record()){ if($db->Record[I8895] == I8875) $lIlllLI[] =$db->Record["fnum"]; else $I11LLIL[] =$db->Record["fnum"]; }for($i =0; $i <count($I11LLIL); $i++){ if(count($lIllllI) == 1){ $sql ="update ".$dbTablePrefix."_items set custom_field_".$I11LLIL[$i].I8896.$lIllll1[I8872]."' where custom_field_".$I11LLIL[$i].I8896.$lIllllL[I8872]."'"; $db->query($sql); }else {$setPart =I8862; $lIlllLl =I8862; for($j =0; $j <count($lIllllI); $j++){ $setPart .= (empty($setPart) ?I8862 :I8887)."custom_field_".$I11LLIL[$i]."_".mb_substr($lIllllI[$j], 6).I8896.$lIllll1[$lIllllI[$j]].I8897; $lIlllLl .= (empty($lIlllLl) ?I8862 :" AND ")."custom_field_".$I11LLIL[$i]."_".mb_substr($lIllllI[$j], 6).I8896.$lIllllL[$lIllllI[$j]].I8897; }$sql ="update ".$dbTablePrefix.I8898.$setPart." where ".$lIlllLl; $db->query($sql); }}for($i =0; $i <count($lIlllLI); $i++){ if(count($lIllllI) == 1){ $sql ="update ".$dbTablePrefix."_props set prop_".$lIlllLI[$i].I8896.$lIllll1[I8872]."' where prop_".$lIlllLI[$i].I8896.$lIllllL[I8872].I8897; $db->query($sql); }else {$setPart =I8862; $lIlllLl =I8862; for($j =0; $j <count($lIllllI); $j++){ $setPart .= (empty($setPart) ?I8862 :I8887).I8899.$lIlllLI[$i]."_".mb_substr($lIllllI[$j], 6).I8896.$lIllll1[$lIllllI[$j]].I8897; $lIlllLl .= (empty($lIlllLl) ?I8862 :" AND ").I8899.$lIlllLI[$i]."_".mb_substr($lIllllI[$j], 6).I8896.$lIllllL[$lIllllI[$j]].I8897; }$sql ="update ".$dbTablePrefix.I8900.$setPart." where ".$lIlllLl; $db->query($sql); }}}}function TTT1II1(&$db, &$aParams) {$this->ILLILIL =parent::TTT1II1($db, $aParams) +$this->lIllIlL; return $this->ILLILIL; }}