<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       20850 xkqwkiylixtggytpgktwzxmgltrxkixiqmlmqzqnlixgiizsktxgkkirukgitnzrgquypnir
 */ ?><?php foreach(array(9188=>'qDOHGzSIMn`GOG',9189=>"WOQWK|GuYJMW",9190=>"QSMt",9191=>"GHGuG",9192=>"SZtQfrHI",9193=>"tQxt",9194=>"?jmkq?",9195=>'MS',9196=>"",9197=>"uDQ|DOMGGMnP|IHSuJQ",9198=>"CZrn|DOMGGMnP|IHSuJQ|MD|SMDZYJQS",9199=>"ZGGJB",9200=>"MD|SQfZuJt",9201=>"DOMGGMnP|IQtOHSD",9202=>"coqRq?1?",9203=>"?pRhUg?yb?t`MS",9204=>"t",9205=>"t2I_t",9206=>"t`MS",9207=>".",9208=>"vZJuQ",9209=>"Hff",9210=>"DMAQ",9211=>"ZWtMHn",9212=>"|JMDt%QSMt",9213=>"Hn",9214=>"IQtOHS",9215=>"JQP|YJuQ",9216=>"ZSS",9217=>'',9218=>"rQS",9219=>".?",9220=>"dqjqwT?[?",9221=>"?WOQWKQS",9222=>"nZIQ",9223=>"'",9224=>"?",9225=>"coqRq?MS?=?'",9226=>"MntvZJ",9227=>"MS",9228=>'WZtQPHrMQD',9229=>"FRhi?.",9230=>"'?",9231=>"?.DQJQWtQS.?",9232=>"DQJQWtQS") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopShippingTypes extends CMS_ActModule {public $oEshop; public $_filter; public $lIlLLLI; public $lIlLLLl; public $popup; function ModuleEshopShippingTypes(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); if($this->cms->Core->Side == "admin") {require_once $GLOBALS['CLASSES_PATH'] .I9188; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init($this->moduleName); }else {CreateEshop($cms); $this->oEshop =&$cms->Eshop; }}function _Init($IIll1l1 =array (),$IIll1LI ='', $IIll1Ll ='', $aOptions =array ()){$IIIIL11 =array ("stop_use_sublinks" => false, "lang_data" => true, I9189 => false, "default_prefix" => "t", "allowed_actions" => array ("add", I9190, "apply", "save", "del") );$aOptions += $IIIIL11; $this->lIlLLLl =false; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin(){ $this->popup =isset($this->cms->Vars["popup"]) ?intval($this->cms->Vars[I9191]) :0; $this->_filter =array( 'flt_shipping_method' => isset($this->cms->Vars['flt_shipping_method']) ?$this->cms->Vars['flt_shipping_method'] :null );parent::_InitAdmin(); }function TTTlIII() {parent::TTTlIII(); if ($this->filter->issetField("datefrom")) {$this->filter->TITI1l1(I9192); }if ($this->filter->issetField("dateto")) {$this->filter->TITI1l1("dateto"); }$this->filter->AddField(I9191, "hidden", $this->popup); $this->filter->AddField("flt_name", I9193, isset($this->cms->Vars["flt_name"]) ?stripslashes(unhtmlentities($this->cms->Vars["flt_name"])) :'', "", I9194, "t.name"); $this->filter->MoveField("flt_name", _MOVE_START); $sql ="SELECT `id`, `name` " ."FROM `" .$this->oEshop->dbTablePrefix ."_shipping_methods` " ."WHERE lang = '" .$this->langData ."' AND `hidden` = 0 AND `id_parent` = 0 " ."ORDER BY `name` ASC"; $this->db->query($sql); $aShippingMethods =array ();while ($this->db->next_record()) {$aShippingMethods[$this->db->Record['name']] =$this->db->Record[I9195]; }$IILLLL1 ="flt_shipping_method"; $aSelect =array ();$aSelect =$this->filter->TITI1TT($aSelect, Array($this->cms->Words["all"] => "")); $aSelect =$this->filter->TITI1TT($aSelect, $aShippingMethods, 50); $this->filter->AddField( $IILLLL1, "select", $this->_filter[$IILLLL1], I9196, "=", "t2m.id_method", $aSelect );$this->filter->MoveField($IILLLL1, _MOVE_PREV); if ($this->_filter[$IILLLL1] == I9196) {$this->filter->DisableFieldSQL($IILLLL1); }}function TTTlI1I(&$vData) {if (!$this->cms->Core->GetModOption($this->oEshop->ownerName ."_shipping_methods", I9197)) {$this->cms->AddStatusMsg(I9198, "red"); }parent::TTTlI1I($vData); if (sizeof($this->itemData) == 0) {if ($this->action == I9199) {$vData["name"] =I9196; $vData["shipping_methods"] =$this->TIIl1lI(0); }else {$vData["is_default"] =isset($this->cms->Vars["is_default"]) && $this->cms->Vars[I9200] ?" checked" :I9196; $vData["name"] =isset($this->cms->Vars["name"]) ?$this->cms->Vars["name"] :I9196; $lIlLLLL =isset($this->cms->Vars[I9201]) ?$this->cms->Vars[I9201] :array ();$vData[I9201] =$this->TIIl1lI(0, $lIlLLLL); }}else {$vData[I9200] =$this->itemData[I9200]; $vData["name"] =$this->itemData["name"]; $vData[I9201] =$this->TIIl1lI($this->id); }}function TTTlI11(&$vData, &$aCustom) {$this->lIlLLLI =array ();$sql ="SELECT t.id, COUNT(c.id_shipping_type) categories_count, COUNT(t.id) methods_count " ."FROM `" .$this->oEshop->dbTablePrefix ."_shipping_types` t " ."LEFT OUTER JOIN `" .$this->oEshop->dbTablePrefix ."_cats` c ON c.id_shipping_type = t.id " ."LEFT OUTER JOIN `" .$this->oEshop->dbTablePrefix ."_shipping_types_methods` t2m ON t2m.id_type = t.id " .I9202 .$this->_ApplyFilters() .$this->TTTlIl1() ."GROUP BY t.id"; $this->db->query($sql); while ($this->db->next_record()) {$this->lIlLLLI[$this->db->Record["id"]] =array ('categories' => $this->db->Record['categories_count']); }$sql ="SELECT t.id, COUNT(t2m.id_type) methods_count " ."FROM `" .$this->oEshop->dbTablePrefix ."_shipping_types` t " ."LEFT OUTER JOIN `" .$this->oEshop->dbTablePrefix ."_shipping_types_methods` t2m ON t2m.id_type = t.id " .I9202 .$this->_ApplyFilters() .I9203; $rs =&$this->db->select($sql); while ($record =$rs->nextRecord()) {if (isset($this->lIlLLLI[$record[I9195]])) {$this->lIlLLLI[$record[I9195]]['methods'] =$record['methods_count']; }}$this->browser->InitSQL( "t.id, t.is_default, t.name, COUNT(DISTINCT(t2m.id_method)) methods_count", array ("tables" => array (I9204 => "`" .$this->module->GetTableName() ."` ", "t2m" => "`" .$this->oEshop->dbTablePrefix ."_shipping_types_methods` " ),"joins" => array ("t2m|t" => "t2m.id_type = t.id"), "joins_types" => array (I9205 => "LEFT OUTER"), "post_join" => "LEFT OUTER JOIN `" .$this->oEshop->dbTablePrefix ."_shipping_methods` m ON m.id = t2m.id_method" ),I9202 .$this->_ApplyFilters() .$this->TTTlIl1(), I9206, I9196, "t.id DESC", array ("methods_count" => "COUNT(t2m.id_method)" ));$this->browser->AddSQLJoinedTables($this->cms->Core, I9204, array ("t2m" => I9207 .$this->oEshop->dbTablePrefix ."_shipping_types_methods` " ));$aCustom["fields"] += array (I9200 => array ("action" => "flagicon", I9208 => 1, "id" => "def_id", "on" => $this->moduleName ."_list:is_default_on", I9209 => $this->moduleName ."_list:is_default_off" ),"name" => array ("action" => "stripline", I9210 => 50), "methods_count" => array ("action" => "stripline", I9210 => 10), "action_edit" => array (I9211 => "flagicon", I9208 => I9196, "id" => "edit_id", "on" => $this->moduleName .I9212, I9209 => I9196 ),"action_del" => array (I9211 => "flagicon", I9208 => I9196, "id" => "del_id", I9213 => $this->moduleName ."_list:del", I9209 => I9196 ),"row" => array (I9211 => "callback", "object" => &$this, I9214 => "_rowCB") );$aCustom["legend"] =array ("leg_red", "leg_yellow", I9215, "leg_edit", "leg_del"); $aCustom["form_data"]["buttons"] =array (I9216, I9199, "cancel", "save"); $aCustom["applied_id"] =I9206; $vData[I9191] =$this->popup; parent::TTTlI11($vData, $aCustom); }function _ApplyFilters($prefix ='', $bodyType =I9217, $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); $res .= " AND t.hidden = 0"; return $res; }function TTT1IlI($aSql =array (),$cId =0) {$name =isset($this->cms->VarsPost["name"]) ?trim($this->cms->VarsPost["name"]) :I9196; if (empty($name)) {$this->cms->AddStatusMsg("warn_missing_name", I9218); return array ();}if (!isset($this->cms->VarsPost[I9201]) || !is_array($this->cms->VarsPost[I9201]) || count($this->cms->VarsPost[I9201]) <1 ){$this->cms->AddStatusMsg("warn_missing_shipping_methods", I9218); return array ();}$is_default =isset($this->cms->VarsPost[I9200]) ?1 :0; $aSql =array ("name" => $name, I9200 => $is_default );if ($is_default) {$sql ="UPDATE `" .$this->module->GetTableName() ."` " ."SET `is_default` = 0 " ."WHERE `lang` = '" .$this->langData ."'"; $this->db->query($sql); }$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function ProcessAction($IIIL11l, $cId, $cModule =I9196) {$id =intval($cId); $this->action =$IIIL11l; switch ($IIIL11l) {case "default": $this->TIIl1I1($id, $cModule); break; default: parent::ProcessAction($IIIL11l, $id, $cModule); }}function TIIl1I1($cId, $cModule) {if (!empty($cId)) {$sql ="UPDATE `" .$this->module->GetTableName() .I9219 ."SET `is_default` = (id = '" .$cId ."') " ."WHERE `lang` = '" .$this->langData ."'"; $this->db->query($sql); }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql =I9220 ."FROM `" .$this->module->GetTableName() ."` t " ."WHERE id = '" .$cId ."'" .$this->_ApplyFilters(); $this->db->query($sql); if ($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData[I9200] =$this->itemData[I9200] ?I9221 :I9196; }}function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); if (empty($this->cms->VarsPost["name"]) || !isset($this->cms->VarsPost[I9201]) || !is_array($this->cms->VarsPost[I9201]) || count($this->cms->VarsPost[I9201]) <1 ){return; }$this->TIIl1lT($this->db->lastInsertId()); $this->lIlLLLl =true; if ($this->id) {$this->appliedId =$this->id; }}function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); if (empty($this->cms->VarsPost["name"])) {return; }$this->TIIl1lT($this->id); if ($this->id) {$this->appliedId =$this->id; }if ($this->popup && $this->errno == 0) {$this->cms->Gui->AddGlobalVars(array ("_APPLIED_ID" => $cId, "_SHIPPING_TYPE_NAME" => $this->cms->VarsPost[I9222] ));}}function _ActionDel($cId, $cModule) {$sql ="SELECT `id` " ."FROM `" .$this->oEshop->dbTablePrefix ."_shipping_types` " ."WHERE `hidden` = 1 AND lang = '" .$this->langData .I9223; $this->db->query($sql); $lIlLLL1 =$this->db->next_record() ?$this->db->Record["id"] :0; $sql ="UPDATE `" .$this->oEshop->dbTablePrefix ."_cats` " ."SET `id_shipping_type` = " .$lIlLLL1 .I9224 ."WHERE `id_shipping_type` = '" .$cId .I9223; $this->db->query($sql); $sql ="UPDATE `" .$this->oEshop->dbTablePrefix ."_items` " ."SET `id_shipping_type` = 0 " ."WHERE `id_shipping_type` = '" .$cId .I9223; $this->db->query($sql); $sql ="DELETE FROM `" .$this->oEshop->dbTablePrefix ."_shipping_types_methods` " ."WHERE id_type = '" .$cId .I9223; $this->db->query($sql); $sql ="DELETE FROM `" .$this->module->GetTableName() .I9219 .I9225 .$cId .I9223; $this->db->query($sql); $this->SetLastError(); $this->cms->AddStatusMsg("status_del"); }function TIIl1lT($cId) {$sql ="DELETE FROM `" .$this->oEshop->dbTablePrefix ."_shipping_types_methods` " ."WHERE id_type = '" .$cId .I9223; $this->db->query($sql); $lIlLL1I =isset($this->cms->VarsPost[I9201]) && is_array($this->cms->VarsPost[I9201]) ?array_map(I9226, $this->cms->VarsPost[I9201]) :array ();foreach ($lIlLL1I as $shippingMethodId) {$sql ="INSERT INTO `" .$this->oEshop->dbTablePrefix ."_shipping_types_methods` " ."SET id_type = '" .$cId ."', id_method = " .$shippingMethodId; $this->db->query($sql); }}function TIII1ll($fieldName, $setName, &$aData, $selected =null, $lIIIIlL =false) {$options =I9217; foreach ($aData as $id => $name) {$aRowData =array (I9227 => $id, I9222 => isset($this->words[$name]) ?$this->words[$name] :(isset($this->cms->Words[$name]) ?$this->cms->Words[$name] :$name), "selected" => $id === $selected ?" selected" :I9196 );$row =$this->cms->Gui->getAbs($this->moduleName ."_subform:" .$setName, $aRowData); if ($lIIIIlL) {$row =trim($row); }$options .= $row; }return $options; }function _rowCB(&$aItem, &$aData) {$aItem["categories_count"] =isset($this->lIlLLLI[$aItem[I9227]]) ?($this->lIlLLLI[$aItem[I9227]][I9228] >0 ?$this->cms->stripLine($this->lIlLLLI[$aItem[I9227]][I9228], 10) :I9196 ):I9196; $aItem["methods_count"] =isset($this->lIlLLLI[$aItem[I9227]]) ?($this->lIlLLLI[$aItem[I9227]]['methods'] >0 ?$this->cms->stripLine($this->lIlLLLI[$aItem[I9227]]['methods'], 10) :I9196 ):I9196; }function TIIl1lI($id, $lIlLL1l =array ()){if ($id) {$sql ="SELECT m.id, m.name, t2m.id_type `selected` " .I9229 .$this->oEshop->dbTablePrefix ."_shipping_methods` m " ."LEFT JOIN `" .$this->oEshop->dbTablePrefix ."_shipping_types_methods` t2m ON m.id = t2m.id_method AND t2m.id_type = " .$id .I9224 ."WHERE m.id_parent = 0 AND m.hidden = 0 AND m.lang = '" .$this->langData .I9230 ."ORDER BY m.name ASC"; }else {$sql ="SELECT `id`, `name`, " .(count($lIlLL1l) ?"`id` IN (" .implode($lIlLL1l) .")" :0) .I9231. I9229 .$this->oEshop->dbTablePrefix ."_shipping_methods` " ."WHERE `id_parent` = 0 AND `hidden` = 0 AND `lang` = '" .$this->langData .I9230 ."ORDER BY `name` ASC"; }$this->db->query($sql); $result =I9196; while ($this->db->next_record()) {$result .= $this->cms->Gui->getAbs( $this->moduleName ."_subform:option_row", array (I9227 => $this->db->Record[I9227], I9222 => $this->db->Record[I9222], I9232 => $this->db->Record[I9232] ?I9221 :I9196 ));}return $result; }}?>