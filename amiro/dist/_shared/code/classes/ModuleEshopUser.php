<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       25125 xkqwnlmrlgzltllylztqyunsizxntprzlniyzktxtnmytuikwuywznklylqniqlylgzgpnir
 */ ?><?php foreach(array(9316=>'qDOHGzSIMn`GOG',9317=>"JZnP|SZtZ",9318=>"rQDQt",9319=>"QSMt",9320=>"qdohg|zwwhUNT",9321=>'wid|iQIYQr`GOG',9322=>'SZtQfrHI',9323=>"PrG|ZWtMvQ|Hn",9324=>'uDQrnZIQ',9325=>'tQxt',9326=>"|uDQr",9327=>"ZSS",9328=>"Wurr|GHDtfMx",9329=>"WID|IQIYQrD",9330=>"Qu`MS|IQIYQr=I`MS",9331=>"ZWtMvQ",9332=>"Qu",9333=>"vZJuQ",9334=>"Hff",9335=>"DMAQ",9336=>"ZWtMHn",9337=>"IQtOHS",9338=>"WYgQrDHnZJsMDWHunt",9339=>"JQPQnS",9340=>"JQP|YJuQ",9341=>"YuttHnD",9342=>"GZBIQnt|fHrI",9343=>"MtQI",9344=>"|uDQr|MtQID",9345=>"DtBJQ|DQJQWtQS",9346=>"|WZrt",9347=>"tHtZJ",9348=>"DtZtuD|uDQr|ZSS",9349=>'FhRi|ihsq',9350=>'1',9351=>"'",9352=>'rQPMDtrZtMHn|SZtQ',9353=>"fMQJSD",9354=>"YZJZnWQ|OMDtHrB",9355=>"WHunt",9356=>"rQS",9357=>"DtZtuD|QrrHr",9358=>"GZDDCHrS2",9359=>"DtZtuD|uDQr|ZGGJB",9360=>"ZWtMvZtQ",9361=>"DtZtuD|ZWtMvZtQ",9362=>"|zWtMHnRQDQt",9363=>"coqRq?Qu`MS='",9364=>"MS",9365=>"YZJZnWQ",9366=>'MS',9367=>'',9368=>'?') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopUser extends CMS_ActModule {public $user; public $oEshop; private $lIlLIL1; protected $lIlL1I1 =array(); function ModuleEshopUser(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); if($this->cms->Core->Side != 'admin'){ CreateEshop($cms); $this->oEshop =&$cms->Eshop; }else{ require_once $GLOBALS['CLASSES_PATH'] .I9316; $this->oEshop =new EshopAdmin($this->cms, $this->words); $this->oEshop->init($this->moduleName); }}function _Init($IIll1l1 =Array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =Array()) {$IIIIL11['default_prefix'] ='m'; $IIIIL11[I9317] =false; $IIIIL11['check_public'] =false; $IIIIL11['group_operations'] =Array("active_on", "active_off", I9318, "del"); $IIIIL11["allowed_actions"] =Array("activate", "add", I9319, "apply", "save", "del", I9318); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->oEshop->init($this->moduleName); $this->oEshop->TT1l11l($this->options["multi_sites"], $this->siteId); $this->cms->Gui->AddGlobalVars( Array( I9320 => intval($this->cms->Core->IsInstalled($this->oEshop->ownerName."_account")), "ESHOP_USER_ITEMS" => intval($this->cms->Core->IsInstalled($this->oEshop->ownerName."_user_items")), ));}function _InitAdmin() {parent::_InitAdmin(); require_once $GLOBALS['CLASSES_PATH'] .I9321; require_once $GLOBALS['CLASSES_PATH'] .'EshopUser.php'; $none =""; require_once $GLOBALS['CLASSES_PATH'] .I9316; $this->user =new EshopUser($none); $this->user->SetDbTablePrefix($this->oEshop->dbTablePrefix); $this->lIlLIL1 =$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency) .$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency); if($this->filter->issetField(I9322)){ $this->filter->TITI1l1(I9322); }if($this->filter->issetField('dateto')){ $this->filter->TITI1l1('dateto'); }$this->filter->IL11l1L =array('limit'); $sql ="SELECT m.id, m.username " ."FROM `cms_host_users` u " ."LEFT JOIN `cms_members` m ON m.id = u.id_member " ."WHERE u.sys_user = 1"; $this->lIlL1I1 =$this->db->getRecord($sql); }function TTTlTI1() {parent::TTTlTI1(); $this->user =$this->cms->Member; CreateEshop($this->cms); $this->oEshop =&$this->cms->Eshop; }function TTTlITT($IIIL11l, $cId, $cModule ="") {$id =intval($cId); switch ($IIIL11l) {case "activate": $this->_ActionActivate($cId, $cModule); break; case I9318: $this->_ActionReset($cId, $cModule); break; case I9323: $this->TIITTl1($this->aGroupIds, $cModule); break; case "grp_active_off": $this->TIITT1T($this->aGroupIds, $cModule); break; case "grp_reset": $this->TIITT1I($this->aGroupIds, $cModule); break; case "import": $this->redirect =false; $this->TTIITT1($cId, $cModule); break; case 'export': $this->redirect =false; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function TTTlIII(){ parent::TTTlIII(); foreach(array(I9324, 'firstname', 'lastname', 'email') as $field){ $lIlL1lI ='flt_' .$field; $this->filter->AddField($lIlL1lI, I9325, isset($this->cms->Vars[$lIlL1lI]) ?stripslashes(unhtmlentities($this->cms->Vars[$lIlL1lI])) :'', '', ' like ', 'm.' .$field); }}function TTTlI1I(&$vData) {$I1lLII1 =$this->user->getScripts($this->cms, $this->oEshop->ownerName.I9326); $vData["header_memeber_script"] =$I1lLII1["header"]; $vData["check_member_script"] =$I1lLII1["check_form"]; if($this->action != I9327) {$vData["on_change_member_script"] =$I1lLII1["on_change"]; }$vData["member_form"] =$this->user->getForm($this->cms, $this->db, $this->itemData); $vData["curr_postfix"] =$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency); if(!empty($vData[I9328])) {$vData["curr_prefix"] =$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency); }parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {$this->browser->InitSQL("m.id, m.username, m.firstname, m.lastname, m.email, (m.active & eu.active) as active, m.balance, m.eshop_discount, m.eshop_discount_exp_date, m.eshop_discount_type ", Array("tables"=>Array("m"=>I9329, "eu"=>$this->oEshop->dbTablePrefix."_users"), "joins"=>Array("m|eu"=>I9330) ),"WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), "", "name", "", Array(I9331=>"(m.active & eu.active)", "balance"=>"m.balance"), _DB_STRAIGHT_JOIN );$this->browser->AddSQLJoinedTables($this->cms->Core, "m", Array(I9332=>$this->oEshop->dbTablePrefix."_users")); $aCustom["fields"] += Array( I9331=>Array("action"=>"flagicon", I9333=>1, "id"=>"act_id", "on"=>$this->moduleName."_list:active_on",I9334=>$this->moduleName."_list:active_off"), "username"=>Array("action"=>"stripline", I9335=>50), "lastname"=>Array("action"=>"stripline", I9335=>50), "firstname"=>Array(I9336=>"stripline", I9335=>50), "balance"=>Array(I9336 => "callback", "object"=>&$this, I9337=>"_getBalanceCB"), "eshop_discount"=>Array(I9336 => "callback", "object"=>&$this, I9337=>I9338), "eshop_discount_exp_date"=>Array(I9336=>"stripline", I9335=>50), );$aCustom["applied_id"] ="m.id"; $aCustom[I9339] =Array("onactive", "notactive", "leg_red", "leg_yellow", I9340, "leg_edit", "leg_reset", "leg_del"); $aCustom["form_data"][I9341] =Array(I9327, "apply", "cancel", "save"); $vData['discount_type_base_currency'] =$this->lIlLIL1; $ILII11I =new DateTime($vData['eshop_discount_exp_date']); $vData['eshop_discount_exp_date'] =$ILII11I->format('d.m.Y'); parent::TTTlI11($vData, $aCustom); }function TTTllTI(&$aCustom) {$this->SetBodyType("body_payment_form"); }function &TTTllTl(&$aCustom) {global $ROOT_PATH_WWW; if(!$this->user->isLoggedIn()) {$mMembers =&$this->cms->Core->GetModule("members"); $this->user->requireLogin($ROOT_PATH_WWW.$mMembers->GetFrontLink(), $ROOT_PATH_WWW.$this->module->GetFrontLink()); }return parent::TTTllTl($aCustom); }function TTTll1T(&$vData, &$aCustom) {if(in_array($this->moduleName, $this->cms->Core->GetProperty('disabled_se_indexing_mods'))){ $this->TTTllT1(); }$this->id =$this->user->getUserInfo("id"); $aDefault =Array( "page_item_type"=>"body_payment_form", "item_set"=>I9342, "item"=>I9342, );$IIlL1Ll =$aCustom +$aDefault; $aCustom["page_body_type"] =$IIlL1Ll["page_item_type"]; $sql ="SELECT m.balance FROM ".$this->oEshop->dbTablePrefix."_users eu LEFT JOIN cms_members m ON eu.id_member=m.id ". "WHERE m.id='".$this->id."' AND m.active=1 AND eu.active=1"; $this->db->query($sql); $this->db->next_record(); $IIlL1Ll["balance"] =$this->oEshop->formatMoney(doubleval($this->db->Record["balance"]), $this->oEshop->baseCurrency); $vData[$IIlL1Ll[I9343]] =$this->cms->Gui->get($this->moduleName."_list:".$IIlL1Ll["item_set"], $IIlL1Ll); }function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {$I1lLILI =$this->cms->Gui->getAbs($this->moduleName."_list:special_selected_style", ""); $IllI1II =$this->user->isLoggedIn(); $I1LILlL =Array($this->oEshop->ownerName.I9326, $this->oEshop->ownerName.I9344, $this->oEshop->ownerName."_order_history"); $aModules =array_merge(Array($this->oEshop->ownerName."_item", $this->oEshop->ownerName."_order"), $I1LILlL); foreach($aModules as $modName) {if($this->cms->Core->IsPresentInPMandPublic($modName) && (!in_array($modName, $I1LILlL) || ($IllI1II && in_array($modName, $I1LILlL)))) {$aData =Array(); $aData["front_link"] =$this->cms->Core->GetModFrontLink($modName); if($this->cms->ActivePage == $modName) {$aData[I9345] =$I1lLILI; }else {$aData[I9345] =""; }$vRes[$modName]["vars"] =$aData; $vRes[$modName]["default"] =$this->cms->Gui->get($this->moduleName."_list:special_menu_".$modName, $aData); }}$modName =$this->oEshop->ownerName.I9346; if($this->cms->Core->IsPresentInPMandPublic($modName)){ CreateCart($this->cms, $GLOBALS ["oSession"]); if(isset($this->cms->Member->Cart) && is_object($this->cms->Member->Cart)){ $oCart =$this->cms->Member->Cart; $oCart->cms =$this->cms; $aData =Array(); if($this->cms->ActivePage == $modName) {$aData[I9345] =$I1lLILI; }else {$aData[I9345] =""; }$aData["front_link"] =$this->cms->Core->GetModFrontLink($modName); $aData["item_count"] =$oCart->itemcount(); $aData[I9347] =sprintf("%.2f",$oCart->total); $vRes[$modName]["vars"] =$aData; $vRes[$modName]["default"] =$this->cms->Gui->get($this->moduleName."_list:special_menu_".$modName, $aData); }}}function TTTll11($cId, $cModule) {$IlIl1LI =$this->cms->VarsPost; $id_user =$this->user->createUser($this->cms, $this->db, $IlIl1LI, false, false); if($id_user >0) {$this->appliedId =$id_user; $this->browser->SetApplied($this->db, $asql, $this->langData); $this->SetLastError(); $this->cms->AddStatusMsg(I9348); }else {$this->itemData =removeSpecial($IlIl1LI, "slashes"); $this->SetLastError(1, "Adding failed"); $this->cms->AddStatusMsg("status_error", "red"); }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $this->cms->Gui->AddGlobalVars( array( I9349 => 'EDIT', 'EDIT_USERNAME' => '0', 'EMPTY_PASSWORD' => I9350 ));$sql ="SELECT m.*, eu.discount, eu.discount_type, eu.discount_exp_date FROM cms_members m ". "INNER JOIN ".$this->oEshop->dbTablePrefix."_users eu ON eu.id_member=m.id ". "WHERE m.id='".$cId.I9351.$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData["website"] =$this->itemData["companyweb"]; $this->itemData["balance"] =$this->oEshop->formatNumber($this->itemData["balance"], false, true); $this->itemData[I9352] =date($this->cms->DFMT['php_dtime'], strtotime($this->itemData['date'])); $ILLL1L1 =Array( "items" => "", I9353 => Array("balance" => Array(I9336 => "callback", "object"=>&$this, I9337=>"_getBalanceCB")), );$this->itemData[I9354] =$this->TTT1lT1($this->itemData[I9354], $ILLL1L1); }$sql ="select count(*) as count from ".$this->oEshop->dbTablePrefix."_user_items where lang='".$this->langData."' and owner_id='".$cId.I9351; $this->db->query($sql); $this->db->next_record(); $this->itemData["user_items_number"] =intval($this->db->Record[I9355]); $this->cms->Gui->AddGlobalVars(Array("EMPTY_PASSWORD" => "1")); }function _ActionDel($cId, $cModule) {if($this->cms->Core->TTlllTI() && $cId == $this->lIlL1I1['id']){ $this->cms->AddStatusMsg("status_admin_del_fail",I9356); }else{ $this->user->TTTT1IT($this->cms, $this->db, $cId); $this->cms->AddStatusMsg("status_del"); $this->SetLastError(); }}function TTTl1lI($cId, $cModule) {$IlIl1LI =$this->cms->VarsPost; unset($IlIl1LI[I9324]); $IlIl1LI["currency"] =$this->oEshop->baseCurrency; if($this->cms->Core->TTlllTI() && $cId == $this->lIlL1I1['id']){ $this->SetLastError(2, "Apply failed"); $this->cms->AddStatusMsg(I9357, I9356); }else{ if ($IlIl1LI[$this->user->getLoginField()] == "") {unset($IlIl1LI[$this->user->getLoginField()]); $this->user->SetObligatory($this->user->getLoginField()); }$id_user =$this->user->TTTT1T1($this->cms, $this->db, $cId, $IlIl1LI, true); if($id_user >0) {$is_hash =!empty($this->cms->VarsPost["password_hash"]); if($is_hash || (!empty($this->cms->VarsPost["password"]) && $this->cms->VarsPost["password"]==$this->cms->VarsPost[I9358])) {$aData =$this->user->getData($this->db, 'id', $id_user); $this->user->TTI1I1l(I9324, $aData[I9324]); $this->user->TTI1I1l("id", $cId); $this->user->setPass($this->db, $is_hash ?$this->cms->VarsPost["password_hash"] :$this->cms->VarsPost["password"], $is_hash); }$this->appliedId =$id_user; $this->browser->SetApplied($this->db, $asql, $this->langData); $this->SetLastError(); $this->cms->ClearMessages(); $this->cms->AddStatusMsg(I9359); }else {$this->itemData =removeSpecial($IlIl1LI, "slashes"); $this->SetLastError(2, "Apply failed"); $this->cms->AddStatusMsg(I9357, I9356); }}}function _ActionActivate($cId, $cModule) {$active ="0"; if (isset($this->cms->VarsGet["activate"]) && $this->cms->VarsGet[I9360] == "on") {$active ="1"; }if( ($this->cms->Core->TTlllTI() && $cId == $this->lIlL1I1['id']) || !$this->user->TTTT1II($this->cms, $this->db, $cId, $active) ){$this->cms->AddStatusMsg("status_activate_fail", I9356); }else {$this->cms->AddStatusMsg(I9361); }$this->appliedId =$cId; $this->browser->SetApplied($this->db, $asql, $this->langData); }function TIITTl1(&$aGroupIds, $cModule) {$this->cms->VarsGet[I9360] ="on"; $this->TTTl1II($aGroupIds, $cModule, "_ActionActivate", "status_grp_activate"); }function TIITT1T(&$aGroupIds, $cModule) {$this->cms->VarsGet[I9360] =I9334; $this->TTTl1II($aGroupIds, $cModule, "_ActionActivate", "status_grp_unactivate"); }function _ActionReset($cId, $cModule) {if($this->cms->Core->TTlllTI() && $cId == $this->lIlL1I1['id']){ $this->cms->AddStatusMsg('status_reset_fail', 'red'); }else{ $this->user->TTI1lIl($this->cms, $this->db, $cId, true); $this->cms->AddStatusMsg("status_reset"); $this->appliedId =$cId; $this->browser->SetApplied($this->db, $asql, $this->langData); }}function TIITT1I(&$aGroupIds, $cModule) {$this->TTTl1II($aGroupIds, $cModule, I9362, "status_grp_reset"); }function TTTl11I($cId, $cModule) {$sql ="SELECT m.*, eu.id_external FROM cms_members m ". "INNER JOIN ".$this->oEshop->dbTablePrefix."_users eu ON eu.id_member=m.id ". I9363.$cId.I9351.$this->_ApplyFilters();; $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData[I9354] =unserialize($this->itemData[I9354]); }}function TTIITT1($cId, $cModule) {$IlIl1LI =$this->cms->VarsPost; $genData ="password"; if(empty($IlIl1LI[$this->user->getLoginField()])) {$genData .= "|username"; }$id_user =$this->user->createUser($this->cms, $this->db, $IlIl1LI, false, false, $genData); if($id_user >0) {if(!empty($this->cms->VarsPost["password_hash"])) {$this->user->TTI1I1l("username", $IlIl1LI[$this->user->getLoginField()]); $this->user->TTI1I1l(I9364, $id_user); $this->user->setPass($this->db, $this->cms->VarsPost["password_hash"], true); }$this->SetLastError(); }else {$this->SetLastError(1, "Adding failed"); }}function _getBalanceCB(&$vItem, &$vData) {$lIlL1ll =(empty($vItem["currency"]))? $this->oEshop->baseCurrency: $vItem["currency"]; $vItem[I9365] =$this->oEshop->formatMoney(doubleval($vItem[I9365]), $lIlL1ll); $links['act_id'] =$links['edit_id'] =$links['del_id'] =$links['reset_id'] =$vItem[I9366]; $del =$vItem[I9366] == $this->lIlL1I1[I9366] ?'' :'_del'; if($this->cms->Core->TTlllTI() && $vItem[I9366] == $this->lIlL1I1[I9366]){ $vItem['actions'] =$this->cms->Gui->get($this->oEshop->ownerName .'_user_list:icon_none', $links) .$this->cms->Gui->get($this->oEshop->ownerName .'_user_list:icon_none', $links) .$this->cms->Gui->get($this->oEshop->ownerName .'_user_list:icon_none', $links); }else{ $vItem['actions'] =$this->cms->Gui->get($this->oEshop->ownerName .'_user_list:icons_edit_reset' .$del, $links) .($del != '' ?I9367 :$this->cms->Gui->get($this->oEshop->ownerName .'_user_list:icon_none', $links)); }}public function cbPersonalDiscount(&$vItem, &$vData){ $vItem['eshop_discount'] =empty($vItem['eshop_discount']) ?I9367 :($vItem['eshop_discount'] .I9368 .($vItem['eshop_discount_type'] != 'abs' ?'%' :$this->lIlLIL1)); }}