<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       21162 xkqwmglsyrqipwkxmlqywxsknqtrzgmlmstluttriltzlxuxwrzgwnpppxyxrsxryyyupnir
 */ ?><?php foreach(array(9369=>'',9370=>'WOQWK|GuYJMW',9371=>"MWHnD|GZtO",9372=>"&",9373=>'QxtQnDMHnD',9374=>'`',9375=>"MS",9376=>"GZrQnt",9377=>"",9378=>"SZtQfrHI",9379=>"MD|QSMt",9380=>"SQfZuJt|WHIIMDDMHn",9381=>"IMn|fMxQS",9382=>"IMn|GQrWQnt",9383=>"|IZx|",9384=>"WHIIMDDMHn|tBGQ",9385=>"WHIIMDDMHn",9386=>"IQIYQrD",9387=>"nZIQ",9388=>":",9389=>"nHnQ",9390=>"MD|fMnZJ",9391=>"GrMWQ|SQDW",9392=>"|uDQr|MtQID",9393=>"LHMnD",9394=>"coqRq?H`HCnQr|MS='",9395=>"f",9396=>"fJZPMWHn",9397=>"Hff",9398=>"ftBGQ",9399=>"|wyFHrIZtFMJQTBGQ",9400=>"IQtOHS",9401=>"HYLQWt",9402=>"DQt",9403=>'JQPQnS',9404=>"HrMPMnZJ|fnZIQ",9405=>"ftGPQtfMJQ`GOG IHSuJQ=QDOHG]MS=",9406=>"GrQfMx",9407=>'tIG|nZIQ',9408=>'fMJQ',9409=>"JZnP",9410=>'nZIQ',9411=>"GQrWQnt",9412=>'WOZrPQ|tZx|tBGQ',9413=>"1",9414=>"SQDWrMGtMHn",9415=>"tZx",9416=>"MtQI|tBGQ",9417=>"|MtQID",9418=>"|fMJQD",9419=>"HCnQr|MS",9420=>"fMrDtnZIQ",9421=>"fMJQnZIQ",9422=>"WZtQPHrMQD",9423=>"wjzddqd|gzTo",9424=>"WHIGZnB|nZIQ",9425=>"|fMJQD?coqRq?MS='",9426=>"rQS",9427=>"'?ZnS?H`MS='",9428=>"'",9429=>"gRmVzTq|gzTo") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleEshopUserItems extends CMS_ActModule {public $user; public $oEshop; public $lIlL1lL; public $lIlL1l1; public $IlIllII; public $fileType; public $lIlL1LI; public $lIlL1Ll; function ModuleEshopUserItems(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); if($this->cms->Core->Side!="admin") {CreateEshop($cms); $this->oEshop =&$cms->Eshop; }}function _Init($IIll1l1 =Array(), $IIll1LI ='', $IIll1Ll =I9369, $aOptions =Array()) {require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_gui.php"); $aOptions['default_prefix'] ='i'; $aOptions[I9370] =false; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->lIlL1l1 =&$this->cms->Core->GetModule("files"); $this->lIlL1Ll =&$this->cms->Core->GetModule($this->oEshop->ownerName."_digitals"); $this->IlIllII =Array(); $this->fileType =Array(); $this->lIlL1LI =Array(); $aIconData =Array(); $aIconData['path'] =$GLOBALS["ROOT_PATH_WWW"].$this->lIlL1l1->GetOption(I9371); $sql ="SELECT id, name, icon, extensions FROM cms_ftypes"; $this->db->query($sql); while ($this->db->next_record()) {$aIconData['alt'] ="__file__ [".$this->db->Record['name'].I9372; $aIconData['icon'] =$this->db->Record['icon']; $aExts =explode(';', mb_strtolower($this->db->Record['extensions'])); foreach($aExts as $key => $value) {if(!empty($value) || mb_strlen($this->db->Record[I9373])==0) {$this->lIlL1LI[$this->db->Record['id']] =$this->db->Record['name']; $this->IlIllII[$this->db->Record['id']] =$this->cms->Gui->get($this->module->GetName()."_list:icon", $aIconData); $this->fileType[I9374.$value] =$this->db->Record['id']; }}}}function TTTllTI(&$aCustom) {$this->SetBodyType("body_items"); }function TTTlTI1() {parent::TTTlTI1(); $this->user =$this->cms->Member; CreateEshop($this->cms); $this->oEshop =&$this->cms->Eshop; $this->lIlL1lL =$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency); if($this->lIlL1lL) $this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency); $this->TT11TTT(); }function TT11TTT() {$this->oEshop->tree->setCallbackObject($this); $this->oEshop->tree->setCallbackMethod("createChildsArrayFlt", "_treeArrayCB"); $this->oEshop->tree->setCallbackMethod("buildTreeOnChildsArray", "_buildTreeOnChildsArrayCB"); $this->oEshop->tree->addFilter("public", "c.public=1"); }function _treeArrayCB(&$II11L1l, &$record, &$Il11L1l) {$II11L1l[] =Array("id"=>$record[I9375], "name"=>$record["name"]); }function _buildTreeOnChildsArrayCB(&$res, &$child, &$Il11L1l) {$indent =str_repeat("&middot;&nbsp;", $Il11L1l["level"]); $res[I9376] .= "<option value=\"".$child[I9375]."\"".(($res["selected_id"] == $child[I9375])?" selected":I9377).">".$indent.$this->cms->stripLine($child["name"], 50, true); return true; }function ProcessAction($IIIL11l, $cId, $cModule =I9377) {$id =intval($cId); switch ($IIIL11l) {case "del": $this->TIIl1l1($cId, $cModule); break; default: parent::ProcessAction($IIIL11l, $cId, $cModule); break; }}function TTTlIII() {parent::TTTlIII(); if($this->filter->issetField("datefrom")) $this->filter->TITI1l1(I9378); if($this->filter->issetField("dateto")) $this->filter->TITI1l1("dateto"); }function TTTlllT(&$vData) {$vData["action"] ="add"; $vData[I9379] ="no"; $lIlL1LL =$this->cms->Gui->ParseLangFile("templates/lang/_eshop_user_items_msgs.lng"); $vData["commission_allow_modify"] =$this->module->GetOption("allow_edit_commission"); $III1II1 =trim($this->module->GetOption(I9380)); $lIlL1L1 =$this->module->GetOption("bound_percent_commission"); $vData["min_percent"] =floatval($lIlL1L1[0]); $vData["max_percent"] =floatval($lIlL1L1[1]); $lIlL1L1 =$this->module->GetOption("bound_fixed_commission"); $vData[I9381] =floatval($lIlL1L1[0]); $vData["max_fixed"] =floatval($lIlL1L1[1]); $vData["msg_commission_exceed_p"] =str_replace(array("_min_", "_max_"), array($vData[I9382], $vData["max_percent"]), $lIlL1LL["msg_commission_exceed_p"]); $vData["msg_commission_exceed_f"] =str_replace(array("_min_", I9383), array($vData[I9381], $vData["max_fixed"]), $lIlL1LL["msg_commission_exceed_f"]); if($III1II1[mb_strlen($III1II1)-1] == "%"){ $vData["commission"] =FormatNumber(mb_substr($III1II1, 0, mb_strlen($III1II1)-1), $this->oEshop->numberDecimals, $this->oEshop->numberDecimals, true, true); $vData[I9384] ="percent"; $vData["c_postfix"] ="%"; }else{ $vData[I9384] ="fixed"; $vData[I9385] =FormatNumber($III1II1, $this->oEshop->numberDecimals, $this->oEshop->numberDecimals, true, true); $vData["c_prefix"] =$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency); $vData["c_postfix"] =$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency); $vData["ct_absolute"] ="selected"; }parent::TTTlllT($vData); }function &TTTllTl(&$aCustom) {global $ROOT_PATH_WWW; $mMembers =&$this->cms->Core->GetModule(I9386); $this->user->requireLogin($ROOT_PATH_WWW.$mMembers->GetFrontLink(), $ROOT_PATH_WWW.$this->module->GetFrontLink(), "eshop_user_items"); return parent::TTTllTl($aCustom); }function TTTll1T(&$vData, &$aCustom) {$aCustom["page_item_type"] ="body_items"; $vData["base_currency_postfix"] =$this->lIlL1lL; $lIlL11I =0; $this->oEshop->tree->createChildsArrayFlt(I9387); $this->oEshop->tree->initResult(Array(I9376=>&$vData["categories"], "selected_id"=>$lIlL11I)); $ILLILI1 =Array(); $ILLILI1 =$this->oEshop->tree->buildTreeOnChildsArray(); $tax =$this->oEshop->mEshop->GetOption("tax_default"); $taxType =I9377; if(mb_strpos($tax, "%") !== false){ $taxType =I9388; $tax =floatval(str_replace(I9388, I9377, $tax)); }else $tax =floatval($tax); $lIlL11l =Array(); if($this->cms->Core->IsInstalled($this->oEshop->ownerName."_tax_classes")){ $chargeTaxType =$this->cms->Core->GetModOption($this->oEshop->ownerName."_tax_classes", "charge_tax_type"); }else{ $chargeTaxType =$this->oEshop->mEshop->GetOption('charge_tax_type'); }if($chargeTaxType != I9389 && $tax >0){ $lIlL11l["is_tax"] ="yes"; $lIlL11l["tax"] =$tax.$taxType; }if($chargeTaxType == "charge" && $tax >0) $lIlL11l[I9390] ="yes"; if($chargeTaxType == "detach" && $tax >0) $lIlL11l["is_tax_commission"] ="yes"; $vData[I9391] =$this->cms->Gui->get($this->module->GetName()."_list:price_desc", $lIlL11l); $this->browser->InitSQL("o.id, f.id as fileid, f.original_fname, i.public as public, i.name, i.price, f.ftype, f.filesize", Array("tables"=>Array("o" => $this->oEshop->dbTablePrefix.I9392, "i"=>$this->oEshop->dbTablePrefix."_items", "f"=>$this->oEshop->dbTablePrefix."_files"), I9393 =>Array("o|i"=>"o.item_id=i.id", "i|f"=>"f.id_product=i.id") ),I9394.$this->user->getUserInfo(I9375)."' ".$this->_ApplyFilters().$this->TTTlIl1(), I9377, I9387, I9377, I9377, _DB_STRAIGHT_JOIN );$this->browser->AddSQLJoinedTables($this->cms->Core, "o", Array("i"=>$this->oEshop->dbTablePrefix."_items", I9395=>$this->oEshop->dbTablePrefix."_files")); $aCustom["fields"] =Array( "public" => Array("action"=>I9396, "value"=>1, I9375=>"pub_id", "on"=>"eshop_user_items_list:public_on",I9397=>"eshop_user_items_list:public_off"), I9387=>Array("action"=>"stripline", "size"=>50), I9398=>Array("action"=>"callback", "object"=>&$this, "method"=>I9399), "price"=>Array("action"=>"callback", "object"=>&$this, I9400=>"_CBFormatPrice"), "filesize"=>Array("action"=>"callback", I9401=>&$this, I9400=>"_CBFormatFileSize"), "actions"=>Array("action"=>"actions", I9402=>"eshop_user_items_list:icons_actions", I9375=>Array("del_id")), );$aCustom["applied_id"] ="o.id"; $aCustom[I9403] =Array('leg_published', 'leg_notpublished', "leg_delete"); parent::TTTll1T($vData, $aCustom); }function _CBFormatFileType(&$aItem, &$aData){ if(array_key_exists($aItem[I9398], $this->IlIllII)) $aItem[I9398] =$this->IlIllII[$aItem[I9398]]; else $aItem[I9398] =$this->IlIllII[1000]; $aItem[I9398] =str_replace("__file__", $aItem[I9404], $aItem[I9398]); $aItem["viewicon"] =I9405.$aItem["fileid"]; }function _CBFormatPrice(&$aItem, &$aData){ $aItem["price"] =FormatNumber($aItem["price"], $this->oEshop->numberDecimals, $this->oEshop->numberDecimals, true, true); $aItem[I9406] =$this->oEshop->getCurrencyPrefix($this->oEshop->baseCurrency); $aItem["postfix"] =$this->oEshop->getCurrencyPostfix($this->oEshop->baseCurrency); }function _CBFormatFileSize(&$aItem, &$aData){ $aItem["filesize"] =getBytesAsText($aItem["filesize"], $this->words, 1); }function TTT1ITI($cId, $cModule) {$I1ILlLl =$this->cms->VarsPost; if(is_file($_FILES['file'][I9407]) && filesize($_FILES['file'][I9407]) >0){ $fname =stripslashes($_FILES['file']['name']); $fsize =@filesize($_FILES['file'][I9407]); $ftype =intval($this->fileType[I9374.mb_strtolower(get_file_ext(stripslashes($_FILES[I9408]['name'])))]); if($ftype == 0) $ftype =1000; $asql =Array( I9387 => $I1ILlLl[I9387], "description" => I9377, I9398 => $ftype, "cdate" => DateTools::toMysqlDate(time()), "mdate" => DateTools::toMysqlDate(time()), I9409 => $this->langData, "filesize"=>$fsize );$lIIIlLL =$asql; $sql =$this->db->GenInsertSQL($this->oEshop->dbTablePrefix."_files", $asql); $this->db->query($sql); $IL1l1L1 =$this->db->lastInsertId(); $newfilename ='es_files_'.$IL1l1L1."_".$_FILES[I9408][I9410].$this->lIlL1Ll->GetOption("eshop_files_extension"); $newfilename =$this->cms->TTITI11(stripslashes($newfilename)); if($this->cms->doUploadFile($_FILES[I9408], $GLOBALS["PRIVATE_PATH"].$this->lIlL1Ll->GetOption("eshop_files_path").$newfilename)) {$tax =$this->oEshop->mEshop->GetOption("tax_default"); $taxType =I9377; if(mb_strpos($tax, I9388) !== false){ $taxType =I9411; $tax =floatval(str_replace(I9388, I9377, $tax)); }else{ $taxType ="abs"; $tax =floatval($tax); }if($this->cms->Core->IsInstalled($this->oEshop->ownerName."_tax_classes")){ $chargeTaxType =$this->cms->Core->GetModOption($this->oEshop->ownerName."_tax_classes", "charge_tax_type"); }else{ $chargeTaxType =$this->oEshop->mEshop->GetOption(I9412); }$asql =Array("cat" => $I1ILlLl["categories"], "public" => $this->module->GetOption("publish") ?I9413 :"0", I9387 => $I1ILlLl[I9387], "announce" => $I1ILlLl["announce"], "description" => $I1ILlLl[I9414], "price" => floatval(str_replace(",", ".", $I1ILlLl["price"])), I9415 => $tax, "tax_type" => $taxType, "charge_tax_type" => $chargeTaxType, I9409 => $this->langData); $lIlL11L =$this->oEshop->PrepareItemData("add", $asql, Array(), false); $asql =array_merge($asql, $lIlL11L["aSql"]); $asql =array_merge($asql, Array(I9416 => "eshop_digitals", "num_files" => I9413, "files_size" => $fsize)); unset($asql["cat"]); $sql =$this->db->GenInsertSQL($this->oEshop->dbTablePrefix.I9417, $asql); $this->db->query($sql); $lIlL111 =$this->db->lastInsertId(); $this->oEshop->addItem($lIlL111, $I1ILlLl["categories"], $this->module->GetOption("publish"), false); $asql =Array( "id_product" => $lIlL111, "filename" => addslashes($newfilename), I9404 => $_FILES[I9408][I9410] );$sql =$this->db->GenUpdateSQL($this->oEshop->dbTablePrefix.I9418, $asql, "WHERE id='$IL1l1L1'"); $this->db->query($sql); $asql =Array( I9409 => $this->langData, I9385 => floatval(str_replace(",", ".", $I1ILlLl[I9385])), I9384 => $I1ILlLl[I9384] == "precent" ?I9411 :"abs", I9419 => $this->user->getUserInfo(I9375), "item_id" => $lIlL111 );$sql =$this->db->GenInsertSQL($this->oEshop->dbTablePrefix.I9392, $asql); $this->db->query($sql); $lIl1III =Array(I9387 => stripslashes($I1ILlLl[I9387]), "category" => I9377, "login" => $this->user->getUserInfo("username"), I9420 => $this->user->getUserInfo(I9420), "lastname" => $this->user->getUserInfo("lastname"), "email" => $this->user->getUserInfo("email"), I9421 => $_FILES[I9408][I9410], "filesize" => getBytesAsText($fsize, $this->words, 1), "filetype" => $this->lIlL1LI[$ftype], I9375 => $lIlL111); $sql ="select name from ".$this->oEshop->dbTablePrefix."_cats where id='".intval($I1ILlLl[I9422])."'"; $this->db->query($sql); if($this->db->next_record()) $lIl1III["category"] =$this->db->Record[I9387]; $lIl1IIl =$this->cms->Gui->get($this->module->GetName()."_mail_add:subject", $lIl1III); $mailBody =$this->cms->Gui->get($this->module->GetName()."_mail_add", $lIl1III); require_once($GLOBALS[I9423]."Mailer.php"); $oMail =new Mailer(); $oMail->RecipientAddress =$this->module->GetOption("notification_email"); $oMail->RecipientName =$this->module->GetOption("notification_name"); $oMail->SenderAddress =$this->cms->Core->GetOption("company_robot_email"); $oMail->SenderName =$this->cms->Core->GetOption(I9424); $oMail->Subject =$lIl1IIl; $oMail->Body =$mailBody; $oMail->BodyFormat ="html"; $oMail->Encoding ="UTF-8"; $oMail->Prepare(); $res =$oMail->Send(); $this->cms->AddStatusMsg("status_add"); }else{ $sql ="DELETE FROM ".$this->oEshop->dbTablePrefix.I9425.$IL1l1L1."'"; $this->db->query($sql); $this->cms->AddStatusMsg("status_add_fail", "red"); }}else{ $this->cms->AddStatusMsg("status_add_fail", I9426); }}function TIIl1l1($cId, $cModule) {$sql ="select f.filename, o.item_id, f.id as file_id from ".$this->oEshop->dbTablePrefix."_user_items o INNER JOIN ".$this->oEshop->dbTablePrefix."_items i ON o.item_id=i.id INNER JOIN ".$this->oEshop->dbTablePrefix."_files f ON f.id_product=i.id where o.owner_id='".$this->user->getUserInfo(I9375).I9427.$cId."'"; $this->db->query($sql); if($this->db->next_record()) {$filename =$this->db->Record[I9421]; $itemId =$this->db->Record["item_id"]; $fileId =$this->db->Record["file_id"]; $sql ="DELETE FROM ".$this->oEshop->dbTablePrefix.I9425.$fileId.I9428; $this->db->query($sql); $sql ="DELETE FROM ".$this->oEshop->dbTablePrefix."_items WHERE id='".$itemId.I9428; $this->db->query($sql); $sql ="DELETE FROM ".$this->oEshop->dbTablePrefix."_user_items WHERE id='".$cId.I9428; $this->db->query($sql); if(@is_file($GLOBALS[I9429].$this->lIlL1Ll->GetOption("eshop_files_path").$filename)) $this->cms->TTITlTT($filename, $GLOBALS[I9429].$this->lIlL1Ll->GetOption("eshop_files_path")); $this->cms->AddStatusMsg("status_del"); }else {$this->cms->AddStatusMsg("status_del_fail", I9426); }}}?>