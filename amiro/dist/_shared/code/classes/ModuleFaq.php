<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       45587 xkqwkmlmiiuwqyqnsynlrrngmizyzmqrmsnuplmrwpknwuqizyxrwxglynliwzwpsnxqpnir
 */ ?><?php foreach(array(6788=>"fZE|WZt",6789=>"GuYJMDO|Hn",6790=>"MnSQx|SQtZMJD",6791=>"fE",6792=>"GMWturQ|WZt",6793=>"",6794=>"fJt|EuQDtMHn",6795=>'',6796=>'100:',6797=>"'{?zd?fSZtQ?",6798=>'tZYJQD',6799=>'jqFT?hUTqR',6800=>"ZnDCQrQS",6801=>"ZWtMHn",6802=>"Hn",6803=>"DtrMGJMnQ",6804=>"DMAQ",6805=>"MS",6806=>"fJZPMWHn",6807=>"fMQJSD",6808=>"|pQtzSIMnmtQIwy",6809=>"ZSS",6810=>"nHtGuYJMDOQS",6811=>"JQP|SQJ",6812=>"WZt|JMDt|JZBHut",6813=>'YHSB|urPQnt|MtQID',6814=>"YHSB|MtQIs",6815=>'YHSB|WZtD',6816=>"YHSB|fHrI",6817=>"u|nZIQ",6818=>"QIZMJ",6819=>"IQIYQrD",6820=>"GZPQ|MtQI|tBGQ",6821=>"SZtQ",6822=>"EuQDtMHn|rHC",6823=>"MtQI|JMDt",6824=>"YHSB|WZtD",6825=>"WZt|rHC|JMnKD",6826=>"MtQI|SQtZMJD",6827=>"coqRq?fE`MS='",6828=>"ZutOHr",6829=>"LHMn",6830=>'fE',6831=>"IQtOHS",6832=>"fSZtQ",6833=>"ZnDCQr",6834=>"QrrnH",6835=>"WHIGZnB|nZIQ",6836=>"EuQDtMHn",6837=>'WZtnZIQ',6838=>"DuYJMnK",6839=>"MtQI",6840=>"JMnK",6841=>"JMnKD",6842=>"ZnWOHr",6843=>"!?fE`Qxt|",6844=>"fE`MS|WZt?mN}'",6845=>"DMIGJQ|GrQfMx",6846=>"ZWtMvQ|MtQI|tBGQ",6847=>"SZtZ",6848=>"DuYMtQI|MnSQx",6849=>"DuYMtQI",6850=>"DIZJJ",6851=>"nH|WZtD",6852=>"?jmimT?",6853=>"DIZJJ|",6854=>"?",6855=>'W`urPQnt?sqdw!?',6856=>"?zNs?MS?mN}'",6857=>"ZwZtD",6858=>"uDQ|MS|GZPQ",6859=>"coqRq?1?",6860=>"WZtD|nuI",6861=>'?fE`urPQnt?sqdw!?',6862=>'wjzddqd|gzTo',6863=>"HYLQWt",6864=>"|pQtdIZJJsQtZMJDwy",6865=>"WZt|MS|GZPQ",6866=>"IHrQ",6867=>"MS|WZt",6868=>"WZt|SQtZMJ",6869=>"WZt|nZIQ",6870=>"coqRq?MS=",6871=>"WID|fZE",6872=>"rQS",6873=>"nH|nuIYQrMnP",6874=>"'",6875=>"RhhT|gzTo|ccc",6876=>"fZE|fuJJ|JMnK",6877=>"fZE|IZMJ%DuYLQWt",6878=>"PQtZJJvZJuQD",6879=>"DOHC|WHuntQrD",6880=>"WHuntQr") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleFaq extends CMS_ActModule {public $IlIllI1; public $I1LIIl1; public $I1LIILI; public $I1LIILl; public $I1LIILL; public $I1LIL1l; public $I1LIL1L; public $sublink; public $published; public $I1LIL11; public $I1LI1II; public $I1LII1I; function ModuleFaq(&$cms, &$db, &$cModule) {require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_convert.php"); parent::CMS_ActModule($cms, $db, $cModule); $this->I1LII1I =$this->cms->Core->IsInstalled(I6788) && $this->module->IssetAndTrueOption("use_categories"); if ($this->I1LII1I) {$this->IlIllI1 =new CategoriesFunctionsFaq($this->cms, $this, I6788); }else {$this->IlIllI1 =new CMS_CategoriesFunctionsStub($this->cms, $this, I6788); }$this->I1LIL1l =Array(); $this->I1LIL1L =false; $this->I1LIL11 =false; }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {$IIIIL11["group_operations"] =Array(I6789, "publish_off", "del", "gen_sublink", "gen_keywords", I6790, "no_index_details", "reset_ratings", "move_position"); $IIIIL11["default_prefix"] =I6791; $IIIIL11["use_id_page"] =true; $IIIIL11["use_options_form"] =true; $IIIIL11["name_field_name"] ="question"; $IIIIL11["strip_tags_before_autolink"] =true; $IIIIL11["description_field_name"] ="answer"; $IIIIL11["announce_field_name"] ="question"; $IIIIL11[I6792] ="faq"; $IIIIL11["use_positions"] =true; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->IlIllI1->_Init(); $this->IlIllI1->TTIT1IT("_ApplyCatFilters"); }function _InitAdmin() {parent::_InitAdmin(); }function TTTlTI1() {parent::TTTlTI1(); $this->I1LIIl1 =$this->module->GetOption("show_subitems"); $this->I1LIILl =$this->module->GetOption("subitems_splitter_period"); $this->I1LIILL =$this->module->GetOption("subitems_cols"); $this->cms->SetsTemplate =$this->moduleName."_list"; $this->aRequiredFields =array_flip($this->module->GetAOption("required_fields")); $this->I1LIL11 =$this->module->GetOption("question_number_type"); }function TTTlITT($IIIL11l, $cId, $cModule =I6793) {parent::TTTlITT($IIIL11l, $cId, $cModule); }function GetHtml(&$aCustom) {return parent::GetHtml($aCustom); }function TTTlIII() {parent::TTTlIII(); if($this->IlIllI1->TTTlIII("flt_subject_id")) {$this->filter->MoveField("flt_subject_id", _MOVE_START); }$this->filter->AddField("flt_question", "text", stripslashes(unhtmlentities($this->cms->Vars[I6794])), I6793, " like ", "fq.question"); }function _ApplyCatFilters($prefix ='', $bodyType ='', $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); return $res; }function _ApplyFilters($prefix =I6795, $bodyType =I6795, $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1).$this->I1LIIL1; return $res; }function TTTlI1I(&$vData) {if($this->module->GetOption("send_answer_to_author")){ $vData["send"] ="checked"; }parent::TTTlI1I($vData); $vData['form_width'] =I6796; }function TTTlI1l() {$res =false; if(parent::TTTlI1l()) {$res =$this->IlIllI1->TTTlI1l(); }return $res; }function TTTlI11(&$vData, &$aCustom) {$aCatSql =Array(); $aCatSql["join_to_alias"] =I6791; $this->IlIllI1->TTIT1lT("item_list", $aCatSql); $this->browser->InitSQL( "fq.id, fq.public, fq.author, fq.email, fq.question, (length(fq.answer)>0) AS answered, DATE_FORMAT(fq.date,'".$this->cms->DFMT["db"]. I6797. $aCatSql["select"], array ('tables' => array('fq' => 'cms_faq') +$aCatSql[I6798], 'joins' => $aCatSql['joins'], 'joins_types' => array ('fq|c' => I6799) ),"WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), I6793, "name", "fq.id desc", $aCatSql["order_replace"] += Array(I6800=> "(length(fq.answer)>0)") );if(!empty($aCatSql[I6798])) {$this->browser->AddSQLJoinedTables($this->cms->Core, 'fq', $aCatSql[I6798]); }$aCustom["fields"] += Array( "public"=>Array(I6801=>"flagicon", "value"=>1, "id"=>"pub_id", I6802=>$this->moduleName."_list:public_on","off"=>$this->moduleName."_list:public_off"), "cname"=>Array(I6801=>I6803, "size"=>35), "author"=>Array(I6801=>I6803, "size"=>35), "email"=>Array(I6801=>I6803, I6804=>145), "question"=>Array(I6801=>I6803, I6804=>145), "action_edit"=>Array(I6801=>"flagicon", "value"=>I6793, I6805=>"edit_id", I6802=>$this->moduleName."_list:edit","off"=>I6793), "action_del"=>Array(I6801=>I6806, "value"=>I6793, I6805=>"del_id", I6802=>$this->moduleName."_list:del","off"=>I6793), );$aCustom[I6807]["bold"] =Array(I6801=>"callback", "object"=>&$this, "method"=>I6808); $aCustom["applied_id"] ="fq.id"; $aCustom["form_data"]["buttons"] =Array(I6809, "apply", "cancel", "save"); $this->IlIllI1->TTTlI11($vData, $aCustom); parent::TTTlI11($vData, $aCustom); }function TTT11Tl(&$IILILII) {$IILILII[] ="published"; $IILILII[] =I6810; $IILILII[] ="leg_bold"; $IILILII[] ="leg_yellow"; $IILILII[] ="leg_blue"; $IILILII[] ="leg_edit"; $IILILII[] =I6811; parent::TTT11Tl($IILILII); }function TTTllTI(&$aCustom) {$flag =true; $I1LII1L =false; $cat =$this->IlIllI1->TTTllTI($aCustom); if($cat != -1) {if($this->id >0) {$this->SetBodyType("body_itemD"); $flag =false; $I1LII1L =true; }else {if($cat === 0) {$this->SetBodyType('body_urgent_cats'); $this->SetBodyType("body_cats"); $this->bodyType ='body_cats'; if($this->cms->Core->GetModOption(I6788, I6812) == "link_to_same_page" && $this->I1LIIl1 >= 0){ $this->SetBodyType("body_cats_links"); }$this->SetBodyType("body_form"); $flag =false; }else {if($this->id != -1) {$this->SetBodyType("body_items"); $this->SetBodyType(I6813); if($this->module->GetOption("question_list_layout") == "link_to_same_page"){ $this->SetBodyType("body_questions"); }$this->SetBodyType("body_form"); }else {$this->SetBodyType(I6814); $flag =false; $I1LII1L =true; }}}if($cat !== false) {if($flag && $this->module->GetOption("multicat")) {$this->SetBodyType('body_urgent_cats'); $this->SetBodyType("body_cats"); if ($this->bodyType == 'body_urgent_cats') {$this->bodyType =I6815; }}if($I1LII1L && $this->module->GetOption("multicat_in_body_details")) {$this->SetBodyType('body_urgent_cats'); $this->SetBodyType("body_cats"); if ($this->bodyType == 'body_urgent_cats') {$this->bodyType =I6815; }}}}parent::TTTllTI($aCustom); }function TTTlllT(&$vData) {parent::TTTlllT($vData); }function TTTll1T(&$vData, &$aCustom) {foreach($this->IIllIL1 as $IIlL1L1 => $tmp) {$aDefault =Array(); $this->I1LIL1L =false; $this->lIlLL11 =false; $IIlL1Ll =$this->TTITTT1($aCustom, $IIlL1L1, false); switch($IIlL1L1) {case I6816; $IIlL1Ll["page_item_type"] =I6816; $vData["id_cat"] =$vData["cat_id"]; $this->IlIllI1->TTIT1I1($vData, $this->moduleName."_list"); $I1LI1Il =is_object($this->cms->Member) && $this->cms->Member->isLoggedIn(); if($I1LI1Il){ $vData[I6817] =$this->cms->Member->getUserInfo("firstname"); $vData[I6817] .= " " .$this->cms->Member->getUserInfo("lastname"); $vData["u_email"] =$this->cms->Member->getUserInfo(I6818); }if(!$this->module->GetOption("faq_add_by_registered_only") || $I1LI1Il){ $vData["form"] =$this->cms->Gui->get($this->moduleName."_list:form", $vData); }elseif ($this->cms->Core->IsInstalled("members")) {$mMembers =$this->cms->Core->GetModule(I6819); $vData["register_link"] =$mMembers->GetFrontLink(); $vData["form"] =$this->cms->Gui->get($this->moduleName."_list:register", $vData); }break; case "body_questions"; $IIlL1Ll[I6820] ="body_items"; $IIlL1Ll["active_item_type"] ="body_questions"; $IIlL1Ll["simple_set_fields"] =Array(I6821, "author", I6818, "question", "answer"); $IIlL1Ll["row_set"] =I6822; $IIlL1Ll["list_set"] ="question_list"; require_once $GLOBALS['CLASSES_PATH'] .'CMS_IteratorArray.php'; $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray($this->I1LIL1l[I6823]); $this->browser->InitSQL(I6805, "FROM cms_faq AS fq", "WHERE 1 " );break; case "body_cats": case 'body_urgent_cats': $IIlL1Ll[I6820] =$IIlL1L1; $IIlL1Ll['show_urgent_elements'] =$this->cms->Core->getModOption('faq_cat', 'show_urgent_elements'); $this->I1LI1II ="answers"; $this->IlIllI1->TTTll1T($vData, $IIlL1Ll); break; case "body_cats_links": $IIlL1Ll[I6820] =I6824; $this->I1LI1II ="links"; $this->IlIllI1->TTTll1T($vData, $IIlL1Ll); $IIlL1Ll["list_set"] ="cat_list_links"; $IIlL1Ll["row_set"] =I6825; break; case I6814: $aDefault[I6820] =I6814; $IIlL1Ll += $aDefault; $IIlL1Ll["simple_set_fields"] =Array(I6821, "author", I6818, "question", "answer"); $this->IlIllI1->TTTll1T($vData, $IIlL1Ll); $aCatSql =Array(); $this->IlIllI1->TTIT1lT(I6826, $aCatSql); $sql ="SELECT fq.*, ". "DATE_FORMAT(fq.date, '".$this->cms->DFMT["db"].I6797. "FROM cms_faq AS fq ". I6827.$this->id."'".$aCatSql["where"].$this->_ApplyFilters(); $this->db->query($sql); $vData[I6805] =$this->id; break; case "body_items": case I6813: $aDefault[I6820] =$IIlL1L1; $aDefault["simple_set_fields"] =Array(I6821, I6828, I6818, "question", "answer"); $IIlL1Ll += $aDefault; $this->TTTllll($vData, $IIlL1Ll); $aCatSql =Array(); $this->IlIllI1->TTIT1lT(I6823, $aCatSql); $this->browser->InitSQL("fq.id, fq.author, fq.email, fq.sublink, ". "fq.question, fq.answer, (length(fq.answer)>0) AS answered, ". "DATE_FORMAT(fq.date, '".$this->cms->DFMT["db"]."') AS fdate".$aCatSql["select"], "FROM cms_faq AS fq ".$aCatSql[I6829], "WHERE 1 ".$aCatSql["where"].$this->_ApplyFilters(I6795, $IIlL1L1 == I6813 ?$IIlL1L1 :I6795).$this->TTTlIl1(), I6793, $this->browser->TI1TTlT(), "fq.id desc", Array(I6800=> "(length(fq.answer)>0)") );$this->browser->AddSQLJoinedTables($this->cms->Core, I6830, $aCatSql["tables"]); $IIlL1Ll[I6807]["detials"] =Array(I6801=>"callback", "object"=>&$this, I6831=>"_GetFrontItemCB"); $this->lIlLL11 =true; if(!$this->IlIllI1->TTTll1T($vData, $IIlL1Ll)) {$IIlL1Ll[I6820] ="body_empty"; }$this->I1LIL1L =true; $this->I1LIL1l[I6823] =Array(); break; }$this->IlIllI1->TTIT1I1($vData); $this->lIlLL11 =false; parent::TTTll1T($vData, $IIlL1Ll); if($IIlL1L1 == "body_questions") {$this->db =new DB_si; }}}function TTT1lTl($IIl1II1, &$record, &$vData, &$aData) {parent::TTT1lTl($IIl1II1, $record, $vData, $aData); switch($IIl1II1) {case I6814: $vData["item_link"] =$this->cms->Gui->get($this->moduleName."_list:itemD_item_link", $vData); $this->IlIllI1->TTT1lTl($IIl1II1, $record, $vData, $aData); $vData["top_link"] =$this->cms->TTITI1l("itemD", "top_link", $vData); $vData[I6821] =$this->cms->TTITI1l("itemD", I6821, $record[I6832]); if(!empty($record[I6828])) {$vData[I6828] =$this->cms->TTITI1l("itemD", I6828, $record); }break; }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT fq.*, DATE_FORMAT(fq.date,'".$this->cms->DFMT["db"]."') AS fdate, ". "IF(fq.public > 0, 'checked', '') AS public ". "FROM cms_faq AS fq ". I6827.$cId."'".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData["question"] =$this->cms->htmlchars($this->itemData["question"]); $this->itemData[I6833] =$this->cms->htmlchars($this->itemData[I6833]); }}function _ActionDel($cId, $cModule) {$sql ="SELECT public, id_cat FROM cms_faq WHERE id='".$cId."'"; $this->db->query($sql); if($this->db->next_record()){ $this->IlIllI1->TTIT1ll($cId, $cModule, $this->db->Record["public"], $this->db->Record["id_cat"]); parent::_ActionDel($cId, $cModule); $err =$this->GetLastError(); if(empty($err[I6834])) {$this->IlIllI1->_ActionDel($cId, $cModule); }}}function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); if(empty($this->errno) && $this->appliedId >0) {$this->IlIllI1->TTTll11($cId, $cModule); if(intval($this->cms->VarsPost["send"]) && !empty($this->cms->VarsPost[I6833])){ $this->TIITlTl($this->module->GetOption("faq_email"), $this->module->GetOption("company_name"), $this->cms->VarsPost[I6818], $this->cms->VarsPost[I6828], $GLOBALS['LOCAL_FILES_REL_PATH']."_admin/templates/letters/faq_mail_" .$this->langData .".tpl", "html"); }}}function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); if(empty($this->errno)) {$this->IlIllI1->TTTl1lI($cId, $cModule); if(intval($this->cms->VarsPost["send"]) && !empty($this->cms->VarsPost[I6833])){ $this->TIITlTl($this->module->GetOption("faq_email"), $this->module->GetOption(I6835), $this->cms->VarsPost[I6818], $this->cms->VarsPost[I6828], $GLOBALS['LOCAL_FILES_REL_PATH']."_admin/templates/letters/faq_mail_" .$this->langData .".tpl", "html"); }}}function _ActionPublish($cId, $cModule) {$this->IlIllI1->TTIT1ll($cId, $cModule); parent::_ActionPublish($cId, $cModule); $this->IlIllI1->_ActionPublish($cId, $cModule); }function TTT1Tl1($cType, $cModule, $condition =I6795) {$res =$this->IlIllI1->TTT1Tl1($cType, $cModule); if(!$res) {parent::TTT1Tl1($cType, $cModule, $condition); }}function TTT1IlI($aSql =Array(), $cId =0) {$author =$this->cms->VarsPost[I6828]; $email =$this->cms->VarsPost[I6818]; $question =$this->cms->VarsPost[I6836]; $answer =$this->cms->VarsPost[I6833]; $udate =DateTools::getCorrectUDate($this->cms->VarsPost[I6821], $this->cms->DFMT["conf"]); $date =date($this->cms->DFMT["php"], $udate); if(!empty($question) && !empty($author)) {$aSql =Array( I6821=>DateTools::toMysqlDate($udate), I6828=>$author, I6818=>$email, I6836=>$question, I6833=>$answer, "public"=>intval($this->cms->VarsPost["public"]) );if ($this->I1LII1I) {if (($catname =trim($this->cms->VarsPost[I6837])) != I6795) {$aSql['subject'] =$catname; }else {$sql ="SELECT `name` FROM `cms_faq_cat` WHERE id = " .intval($this->cms->VarsPost['cat_id']); $aSql['subject'] =$this->db->getValue($sql); }}}$this->IlIllI1->TTT1IlI($aSql, $cId); $aSql =parent::TTT1IlI($aSql, $cId); $this->sublink =$aSql[I6838]; $this->published =$aSql["public"]; return $aSql; }function TTT11Il(&$vData, &$IIlL1Ll) {if($this->I1LIL1L) {if($this->db->num_rows() >0) {while($this->db->next_record()) {$this->I1LIL1l[I6823][] =$this->db->Record; }$this->db->seek(); }}parent::TTT11Il($vData, $IIlL1Ll); }function _GetFrontItemCB(&$aItem, &$aData) {$aItem["q_row_index"] =$this->TIITlTI($aItem["abs_row_index"], $this->I1LIL11); $aItem["item_anchor"] =$this->cms->TTITI1l(I6839, "anchor", $aItem); if($this->module->GetOption("question_list_layout") == "link_to_separate_page"){ $aItem["question_data"] =$this->cms->TTITI1l(I6836, I6840, $aItem); }else {$aItem["question_data"] =$this->cms->TTITI1l(I6836, "body", $aItem); }}function _GetFrontSubitemCB(&$aItem, &$aData) {$aItem["q_row_index"] =$this->TIITlTI($aItem["subitem_index"], $this->I1LIL11); if($this->I1LI1II == I6841){ $aItem["item_anchor"] =I6793; $aItem["question_data"] =$this->cms->TTITI1l(I6836, "subitem_link", $aItem); }else {$aItem["item_anchor"] =$this->cms->TTITI1l(I6839, I6842, $aItem); $aItem["question_data"] =$this->cms->TTITI1l(I6836, "body", $aItem); }}function _GetAdminItemCB(&$aItem, &$aData) {if(!$aItem[I6800]) {$aItem["style"] .= "_b"; }}function TIITIl1(&$IIL1lLI) {$this->lIlLL11 =false; $II11L1L =" fq.urgent DESC, fq.".$this->module->GetOption("front_subitem_sort_col")." ".$this->module->GetOption("front_subitem_sort_dim"); $fields ="SELECT fq.id, fq.id_cat, fq.author, fq.email, fq.sublink, fq.question, fq.answer, ". "DATE_FORMAT(fq.date, '".$this->cms->DFMT["db"]."') AS fdate, fq.urgent"; foreach($this->options["item_pictures"] as $fieldName) {if(!empty($fieldName) && $fieldName != 'null' && $fieldName != -222222){ $fields .= I6843.$fieldName; }}$fields .= " FROM cms_faq AS fq WHERE "; $this->_forceHideFutureItems =true; if($this->I1LIIl1 >0) {$sql =$fields."fq.id_cat='__id_cat__'".$this->_ApplyFilters()." ORDER BY ".$II11L1L." LIMIT ".$this->I1LIIl1; }else {$sql =$fields.I6844.implode("','", $IIL1lLI)."')".$this->_ApplyFilters(I6795, $IIl1II1, false)." ORDER BY fq.id_cat ASC, ".$II11L1L; }unset($this->_forceHideFutureItems); $this->I1LIILI =$this->IlIllI1->TTIITTI($sql, $IIL1lLI, "__id_cat__"); $this->lIlLL11 =true; }function _DrawSubItemsCB(&$aItem, &$aData) {$I1LIlIl =$this->I1LIILI[$aItem[I6805]]; $aItem[I6823] =I6793; if(is_array($I1LIlIl)) {$k =0; $numRows =sizeof($I1LIlIl); $vData[I6845] ="subitem_"; $I1LIlIL =$this->options["name_field_name"]; $this->options["name_field_name"] =I6836; $setPostfix =($this->I1LI1II == I6841) ?"_links" :I6793; foreach($I1LIlIl as $index=>$aSubItem) {$k++; $aTmp[I6846] ="body_items"; $aTmp["cat_id"] =$aItem[I6805]; $aTmp["cat_sublink"] =$aItem[I6838]; $this->_GetNavDataCB($aSubItem, $aTmp); $aSubItem += $this->IIllllL; $IIlLIIL =Array(I6801=>"_GetPicturesCB", I6847=> $_data =array(&$aSubItem, &$vData)); $this->TTT1lI1($IIlLIIL, array('ext_images')); $aSubItem[I6836] =$this->cms->TTITI1l("subitem", I6836.$setPostfix, $aSubItem); $IIlLIIL =Array(I6801=>"add_subitem_data", I6805=>I6793, "item_data"=>&$aSubItem); $this->TTT1lI1($IIlLIIL); $aSubItem[I6848] =$k -1; $this->_GetFrontSubitemCB($aSubItem, $aData); $aItem[I6823] .= $this->cms->TTITI1l("subitem", "row".$setPostfix, $aSubItem); if($k >0 && $k != $numRows) {if((($k %$this->I1LIILL) == 0)) {$aItem[I6823] .= $this->cms->TTITI1l("subitem", "Vsplitter".$setPostfix, $aItem); }elseif($k >1) {$aItem[I6823] .= $this->cms->TTITI1l(I6849, "Hsplitter".$setPostfix, $aItem); }if($this->I1LIILl && $k%$this->I1LIILl == 0 ){$aItem[I6823] .= $this->cms->TTITI1l(I6849, "nSplitter".$setPostfix, I6793); }}}$this->options["name_field_name"] =$I1LIlIL; $aItem[I6823] =$this->cms->TTITI1l(I6849, "list".$setPostfix, $aItem); }}function TTTlIT1(&$aCustom, $cType =I6850, $IIlLI11 =I6793, $IIlLlII ="_small") {$this->IlIllI1->TTTlITl($aCustom, $cType, $IIlLI11, $IIlLlII, true); $html =parent::TTTlIT1($aCustom, $cType, $IIlLI11, $IIlLlII); $this->IlIllI1->TTTlITl($aCustom, $cType, $IIlLI11, $IIlLlII, false); return $html; }function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {$I1LIlI1 =$this->module->GetOption("small_number_items"); $I1LIllI =$this->module->GetOption("small_category_ids"); $I1LIlll =$this->module->GetOption("small_number_categories"); $mode =I6851; if( $this->cms->Core->IsInstalled($this->IlIllI1->catModuleName) && $this->module->issetAndTrueOption('use_categories') ){$mode ="cats_ids"; $I1LIllL =is_array($I1LIllI); if(!$I1LIllL || ($I1LIllL && sizeof($I1LIllI) == 0)) {if(empty($I1LIllI)) {$mode =empty($I1LIlll) ?I6851 :"cats_num"; }else {$I1LIllI =Array($I1LIllI); }}}$I1LIll1 =" "; if(!empty($I1LIlI1)) {$I1LIll1 =I6852.$I1LIlI1; }$aDefault =Array(); $aDefault["simple_set_fields"] =Array("announce"); $aCustom += $aDefault; $aDefault["list_data"]["splitter_prefix"] =I6853; $aCustom["list_data"] += $aDefault["list_data"]; $I1LIlLI =" fq.".$this->module->GetOption("small_items_sort_col").I6854.$this->module->GetOption("small_items_sort_dim"); if ($this->I1LII1I && ($mode == 'cats_num' || $mode == 'cats_ids')) {$I1LIlLl =in_array('at_spec_block', $this->IlIllI1->IILI1LI->GetAOption('show_urgent_elements')); $this->TTITTTI('push'); $sql ="SELECT c.id AS cat_id, c.sublink AS cat_sublink, c.name AS cat_name, c.announce AS cat_announce, c.id_page AS cat_id_page, c.urgent FROM cms_faq_cat AS c WHERE 1".$this->_ApplyCatFilters('c', I6795, !$I1LIlLl); $I1LIlLL =" ORDER BY " .($I1LIlLl ?I6855 :I6795) ."c.".$this->module->GetOption("small_categories_sort_col").I6854.$this->module->GetOption("small_categories_sort_dim"); if($mode == "cats_num") {$sql .= $I1LIlLL.I6852.$I1LIlll; }else {$sql .= I6856.implode("','", $I1LIllI)."')".$I1LIlLL; }$this->TTITTTI('pop'); $this->db->query($sql); $aCatIds =Array(); while($this->db->next_record()) {$aCatIds[] =$this->db->Record["cat_id"]; $this->I1LIL1l[I6857][$this->db->Record["cat_id"]] =$this->db->Record; }}$I1LIlL1 =in_array('at_spec_block', $this->module->GetAOption('show_urgent_elements')); if($mode == I6851) {$this->IlIllI1->TTIT1lT('small_list', $aCatSql); }$IILL1ll =$this->options[I6858]; $this->options[I6858] =false; $this->_forceHideFutureItems =true; switch($mode) {case I6851: $this->options['use_id_page'] =$IILL1ll; $this->browser->InitSQL("fq.id, fq.question, fq.answer, fq.sublink, fq.urgent" .$aCustom["sql_addon"]["select"] .", date_format(fq.date,'".$this->cms->DFMT["db"]."') as fdate ".$aCatSql["select"], "FROM cms_faq AS fq ".$aCatSql[I6829], I6859.$this->_ApplyFilters(I6795, I6795, !$I1LIlL1).$aCatSql["where"], I6793, $I1LIlLI );$this->browser->SetForceRules('ORDER BY ' .$I1LIlLI, $I1LIll1); $this->browser->AddSQLJoinedTables($this->cms->Core, I6830, $aCatSql["tables"]); if ($I1LIlL1) {$this->browser->TI1TII1(array ('fq.urgent DESC')); }break; case I6860: case "cats_ids": $aItems =Array(); if(sizeof($aCatIds) >0) {$ILLILlL ="SELECT fq.id, fq.id_cat, fq.id_page, fq.question, fq.answer, fq.sublink" .$aCustom["sql_addon"]["select"] .", date_format(fq.date,'".$this->cms->DFMT["db"]."') as fdate "; foreach($this->options["item_pictures"] as $fieldName) {if(!empty($fieldName) && $fieldName != 'null' && $fieldName != -222222){ $sql .= I6843.$fieldName; }}if ($I1LIlL1) {$I1LIlLI =I6861 .$I1LIlLI; }foreach($aCatIds as $catId) {$sql =$ILLILlL." FROM cms_faq AS fq WHERE fq.id_cat='".$catId."' ".$this->_ApplyFilters(I6795, I6795, !$I1LIlL1)." ORDER BY ".$I1LIlLI.$I1LIll1; $this->db->query($sql); while($this->db->next_record()) {$aItems[] =$this->db->Record +$this->I1LIL1l[I6857][$this->db->Record["id_cat"]]; }}}require_once $GLOBALS[I6862] .'CMS_IteratorArray.php'; $I1LIl1I =$this->db; $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray($aItems); $this->browser->InitSQL(I6805, "FROM cms_faq ", I6859 );$this->browser->SetForceRules(I6793, I6854); $aCustom[I6807] += Array("cat_detials" => Array(I6801=>"callback", I6863=>&$this, I6831=>"_GetSmallCatDetailsCB")); $this->I1LIL1l["prevCatId"] =-1; break; }unset($this->_forceHideFutureItems); $this->options[I6858] =$IILL1ll; $aCustom[I6807] += Array("detials" => Array(I6801=>"callback", I6863=>&$this, I6831=>I6864)); parent::TTTll1I($vRes, $aCustom, $cType, $IIlLlII); if(isset($I1LIl1I)) {$this->db =$I1LIl1I; }}function _GetSmallDetailsCB(&$aItem, &$aData) {$aItem[I6821] =$aItem[I6832]; $aItem[I6821] =$this->cms->TTITI1l(I6850, I6821, $aItem); $aItem["front_link"] =$aData["front_link"]; if($this->module->GetOption("small_number_categories")){ $I1LI1IL =$this->module->GetFrontLink($this->I1LIL1l[I6857][$aItem["id_cat"]][I6865]); $aItem["front_link"] =$I1LI1IL; }$aItem["header"] =$this->cms->TTITI1l(I6850, "header", $aItem); $aItem["more"] =$this->cms->TTITI1l(I6850, I6866, $aItem); }function _GetSmallCatDetailsCB(&$aItem, &$aData) {if($this->I1LIL1l["prevCatId"] != $aItem["id_cat"]) {$this->I1LIL1l["prevCatId"] =$aItem["id_cat"]; $tmp =Array(I6846=>I6824); $tmp2 =Array(I6805=>$aItem[I6867], I6838=>$aItem["cat_sublink"]); $this->_GetNavDataCB($tmp2, $tmp); $I1LI1IL =$this->module->GetFrontLink($this->I1LIL1l[I6857][$aItem[I6867]][I6865]); $aItem["front_link"] =$I1LI1IL; $aItem["cat_nav_data"] =$tmp2["nav_data"]; $aItem[I6868] =$this->cms->TTITI1l(I6850, I6868, $aItem); }else {$aItem[I6868] =I6793; }}function TTT11IT($IILILIL) {$navData =parent::TTT11IT($IILILIL); $navData += $this->IlIllI1->TTT11IT($IILILIL); return $navData; }function TTT1ITI($cId, $cModule) {$langFile =$this->cms->Gui->ParseLangFile("templates/lang/_faq_msgs.lng"); $this->cms->InitMessages($langFile); $I1LI1I1 =false; foreach ($this->aRequiredFields as $fieldName => $value) {if ($this->cms->VarsPost[$fieldName] == I6793) {$I1LI1I1 =true; break; }}if (!$I1LI1I1) {$catId =isset($this->cms->VarsPost["cat_id"]) ?intval($this->cms->VarsPost["cat_id"]) :1; if($this->cms->Core->IsInstalled(I6788)){ $sql ="SELECT name FROM cms_faq_cat WHERE id=" .$catId; $this->db->query($sql); if($this->db->next_record()) {$this->I1LIL1l[I6869] =$this->db->Record["name"]; }$asql =Array("num_items"=> "=|(num_items+1)"); $sql =$this->db->GenUpdateSQL("cms_faq_cat", $asql,I6870.$catId); $this->db->query($sql); }$asql =Array( I6867=> $catId, I6828=> $this->cms->VarsPost[I6828], I6818=> $this->cms->VarsPost[I6818], I6836=> $this->cms->VarsPost[I6836], I6821=> "=|now()", "lang"=> $this->langData, "public"=> "0" );$sql =$this->db->GenInsertSQL(I6871, $asql); $this->db->query($sql); $this->appliedId =$this->db->lastInsertId(); $this->TIITlTl($this->cms->VarsPost[I6818], $this->cms->VarsPost[I6828], $this->module->GetOption("faq_email"), $this->module->GetOption(I6835), "templates/letters/faq_mail.tpl"); $this->cms->AddStatusMsg("status_add"); }else {$this->cms->AddStatusMsg("status_error", I6872); }}function TIITlTI($I1LI1lI, $type){ $res =I6793; switch($type){ case "arabic": $res =($I1LI1lI +1); break; case "roman": $res =TlTllII($I1LI1lI+1); break; case "bullet": $res ="&#149;"; break; case I6873: break; default: $res =($I1LI1lI +1); }return $res; }function TIITlTl($from, $I1LI1ll, $to, $I1LI1lL, $Il1LlL1 ="templates/letters/faq_mail.tpl", $bodyType ="plain"){ $I1LI1l1 =$this->cms->VarsPost; $I1LI1l1 =removeSpecial($I1LI1l1); $sql ="SELECT name FROM cms_faq_cat WHERE id='".$I1LI1l1["cat_id"].I6874; $this->db->query($sql); if($this->db->next_record()) {$I1LI1l1[I6869] =$this->db->Record["name"]; }$I1LI1l1 += array(I6835 => $this->cms->Core->GetOption(I6835), "company_url" => $this->cms->Core->GetOption("company_url")); if($this->published){ $navData =$this->IlIllI1->TTT11IT(I6793); $I1LI1IL =$this->module->GetFrontLink($this->IIlll1I); $I1LI1l1["faq_full_link"] =$GLOBALS[I6875]; $I1LI1l1["faq_full_link"] .= $I1LI1IL; $I1LI1l1["faq_full_link"] .= "/" .$navData["catid_sublink"]; $I1LI1l1[I6876] .= "/" .$this->sublink; }require_once($GLOBALS["CLASSES_PATH"]."Mailer.php"); $oMail =new Mailer(); $this->cms->Gui->addBlock("faq_mail", $Il1LlL1); $oMail->SenderAddress =$from; $oMail->SenderName =$I1LI1ll; $oMail->RecipientAddress =$to; $oMail->RecipientName =$I1LI1lL; $oMail->Subject =$this->cms->Gui->get(I6877, $I1LI1l1); $oMail->BodyFormat =$bodyType; if ($oMail->BodyFormat == "html") {$oMail->Body =$this->cms->Gui->get("faq_mail:answer", $I1LI1l1); }else {$oMail->Body =$this->cms->Gui->get("faq_mail", $I1LI1l1); }$oMail->Prepare(); if(!$oMail->Send()){ trigger_error("FAQ: sending email failed...", E_USER_WARNING); }}function correctStopArgNames($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I =I6878){ return $this->IlIllI1->correctStopArgNames($cData, $IIL1lL1, $res, $aData, $IIL1l1I); }function TTT1II1(&$db, &$aParams) {$aVars =parent::TTT1II1($db, $aParams) +$this->IlIllI1->TTT1II1($db, $aParams); return $aVars; }function TTT1TTI(&$IIl1ll1, $prefix) {if ($this->I1LII1I) {$IIl1ll1['select'] .= ", id_cat"; }}function TTT1TTl(&$record) {if ($this->I1LII1I) {$this->IlIllI1->catId =$record['id_cat']; }}}class CategoriesFunctionsFaq extends CMS_CategoriesFunctions {public $I1LI1LI =I6793; public $I1LI1Ll =false; function CategoriesFunctionsFaq(&$cms, &$oModule, $IILL11I) {parent::CMS_CategoriesFunctions($cms, $oModule, $IILL11I); $this->I1LI1LI =$this->cms->Core->GetModOption(I6788, "category_number_type"); $this->I1LI1Ll =$this->cms->Core->GetModOption(I6788, I6879); }function _GetCategoryCB(&$aItem, &$aData) {$aItem["cat_row_index"] =$this->module->TIITlTI($aItem["abs_row_index"], $this->I1LI1LI); if($this->I1LI1Ll){ $aItem["cat_counter"] =$this->cms->TTITI1l("cat", I6880, $aItem); }$aItem["name_links"] =$this->cms->TTITI1l("cat", "lname_links", $aItem); parent::_GetCategoryCB($aItem, $aData); }}