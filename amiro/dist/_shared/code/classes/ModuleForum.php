<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       105611 xkqwluywmsswwzspmiltsgrlnwzlngsrnrxrxuwkunkqxrlzskzlzzpswqlzmuiytzkppnir
 */ ?><?php foreach(array(9546=>'OHDtiHSQ',9547=>'uDQ|WZtQPHrMQD',9548=>'ZSIMn',9549=>'IDP|SZtQ',9550=>'JHWK|Hff',9551=>'nH|MnSQx|SQtZMJD',9552=>'uDQ|HGtMHnD|fHrI',9553=>'tHGMW',9554=>'fJt|DQWtMHn|MS',9555=>'IQDDZPQD|GQr|GZPQ',9556=>'JQP|YHJS',9557=>'fJt|tHGMWD|HnJB',9558=>'SQfZuJt|GrQfMx',9559=>'fJt|MS',9560=>"tQxt",9561=>"?jmkq?':",9562=>'',9563=>'fJt|JHWKQS',9564=>'OMSSQn',9565=>'fJt|ZutOHr',9566=>'tQxt',9567=>'fJt|MG',9568=>'0',9569=>'fJt|unZnDCQrQS',9570=>'DZvQ',9571=>'JHWKQS',9572=>'MS|WZt',9573=>'WZGtMHn',9574=>'fHruI|tHGMW|ZGGJB',9575=>'f',9576=>'tZYJQD',9577=>'f_W',9578=>"f`MS?SQDW",9579=>'vZJuQ',9580=>'Hff',9581=>'DMAQ',9582=>'DtrMGJMnQ',9583=>'rQGJB|MS',9584=>'fJZPMWHn',9585=>'ZWtMHn|SQJ',9586=>'|JMDt%SQJ',9587=>'WZJJYZWK',9588=>'f`MS',9589=>'WZnWQJ',9590=>'ZWtMHn',9591=>'RqihTq|zssR',9592=>'fSZtQ',9593=>'fZJDQ',9594=>'JQP|YJuQ',9595=>'SMDGJZB|ZnDCQrD',9596=>'funW|WHnvQrt`GOG',9597=>'MS|tOrQZS',9598=>'MS',9599=>'|Y',9600=>']nYDG^',9601=>'IQDDZPQ',9602=>'fHruI|CZtWOMnP',9603=>'MS|IQDDZPQ',9604=>'DJZDOQD',9605=>'ZutOHr',9606=>'MG',9607=>'MS|IQIYQr',9608=>'IDP|ZnDCQrD',9609=>'DuYJMnK',9610=>'Hn',9611=>"FRhi?.WID|fHruI.?",9612=>'IDP|ZutOHr',9613=>"coqRq?.MS.?=?",9614=>'LHMnD',9615=>'GOG|StMIQ',9616=>".MS|tOrQZS.?=?",9617=>'DKMG|IHSuJQ|fMJtQr',9618=>'GuYJMDO',9619=>"?coqRq?.MS.?mN?}",9620=>'YJuQ',9621=>'!',9622=>"{",9623=>"'",9624=>'IDP|tHGMW',9625=>'IDP|MS',9626=>"?coqRq?.MS|WZt.?=?",9627=>'WHuntQrD',9628=>'IQIYQrD',9629=>'DtHG|CZtWOMnP|urJ',9630=>'RhhT|gzTo|ccc',9631=>'DWrMGt|nZv|JMnK',9632=>'wid|iZMJeuQuQ`GOG',9633=>'fJt|MS|tOrQZS',9634=>'MS?=?',9635=>'PQn|DuYJMnK',9636=>'YHSB|IQDDZPQs',9637=>'YHSB|WZtD',9638=>'YHSB|MtQIs',9639=>'SMDGJZB|fHrI',9640=>'DMIGJQ|DQt|fMQJSD',9641=>'YHSB|urPQnt|MtQID',9642=>'HYLQWt',9643=>'fGrHW`GOG tMS=',9644=>'SZtQ',9645=>"SY|StMIQ",9646=>'I_f',9647=>'coqRq?',9648=>'I',9649=>'JMDt|SZtZ',9650=>'JMDt',9651=>'fMQJSD',9652=>'WZt|DuYJMnK',9653=>'fHrWQ|JMIMt',9654=>'DWrMGt|fuJJ|JMnK',9655=>'iHSuJQotIJ',9656=>'OQZSQrD',9657=>'YHSB|IQDDZPQ|fHrI',9658=>'tHGMW|IHSQ',9659=>'CZntDurJ',9660=>']',9661=>'YHSB|IQIYQr|GHDtD',9662=>'rHC|DQt',9663=>'JMDt|DQt|QIGtB',9664=>"f`[",9665=>'LHMnD|tBGQD',9666=>'WZt|nZIQ',9667=>'nZIQ|DurnZIQ',9668=>'MtQIg|',9669=>'truQ',9670=>'_]WZtMS=\S-_',9671=>'GZPQr',9672=>'~\ `[$~',9673=>'JZDt|tHGMW|IQDDZPQ',9674=>'DGJMttQr',9675=>"\\\\",9676=>'nZv|SZtZ',9677=>'GrMvZtQ|IQDDZPQD',9678=>'ZmtQI',9679=>'tHtZJ|uDQrD|EtB',9680=>"|DIZJJ",9681=>'DQJQWt',9682=>'YHSB|DIZJJ',9683=>'?jmimT?',9684=>'IQtOHS',9685=>'DIZJJ|tHGMW|JQnPtO',9686=>'rQS',9687=>'DtZtuD|QrrHr',9688=>'GuYJMW',9689=>'ZGGJB',9690=>'WuDtHI',9691=>'DtZtuD|IDP',9692=>']MS=',9693=>'fHruI|ZSIMn|QIZMJ',9694=>'WZtMS|DuYJMnK',9695=>'tMtJQ|DuYLQWt',9696=>'~;\C-\%\~\~~',9697=>'iZMJQr`GOG',9698=>'wid|iQIYQr`GOG',9699=>'DtZtuD',9700=>'wjzddqd|gzTo',9701=>'YHSB',9702=>"coqRq?MS?mN?}",9703=>'iHSuJQFHruI%%grHWQDDTHGMWDduYDWrMYQrD',9704=>'rDD|tGJ|MtQI|JMnK',9705=>'fHruI|WZt',9706=>'nuI|GuYJMW|tHGMWD',9707=>'WZt',9708=>'tHGMW|JQn|Mn|WZtD',9709=>'WZt|MS',9710=>'JZDt|IQDDZPQ',9711=>'|nuI|MtQID') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} if (!defined('HOSTMODE_SHARED')) {define('HOSTMODE_SHARED', 0x2); }if (!function_exists(I9546)) {function hostMode() {static $mode =false; if ($mode === false) {$mode =$GLOBALS['_h']['mode'] == 'single' ?0 :HOSTMODE_SHARED; }return $mode; }}class ModuleForum extends CMS_Forum{ public $IlIllI1; public $I1LIIl1; public $threadId; public $I1LII1I; public $lIl1lIl; public $lIl1lIL; public $lIl1lI1; public $lIl1llI; public $lIl1lll; public $lIl1llL; public $lIl1ll1; public $lIl1lLI; private $lIl1lLl; private $lIl1lLL =false; function ModuleForum(&$cms, &$db, &$cModule, $lIl1lL1 =false) {if (empty($lIl1lL1)) {parent::CMS_Forum($cms, $db, $cModule); $this->I1LII1I =$this->cms->Core->IsInstalled('forum_cat') && $this->module->IssetAndTrueOption(I9547); if ($this->I1LII1I) {$this->IlIllI1 =new CategoriesFunctionsForum($cms, $this, 'forum_cat'); }else {$this->IlIllI1 =new CMS_CategoriesFunctionsStub($cms, $this, 'forum_cat'); }}}function _Init($IIll1l1 =array (),$IIll1LI ='', $IIll1Ll ='', $aOptions =array ()){if ($this->side == I9548) {$this->lIl1lIL =isset($this->cms->Vars['flt_id_thread']) ?intval($this->cms->Vars['flt_id_thread']) :0; $this->lIl1lLL =!$this->lIl1lIL && empty($this->cms->Vars['sort']); if($this->lIl1lLL){ $this->module->SetOption('page_sort_col', I9549); $this->module->SetOption('page_sort_dim', 'desc'); }}$IIIIL11 =array ('group_operations' => array ('lock_on', I9550, 'del', 'gen_sublink', 'gen_keywords', 'index_details', I9551, 'reset_ratings'), 'default_prefix' => 'f', 'use_id_page' => false, I9552 => true, 'use_modified_date' => false, 'name_field_name' => 'topic', 'announce_field_name' => I9553 );$aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->IlIllI1->_Init(); $this->IlIllI1->TTIT1IT('_ApplyCatFilters'); $this->threadId =0; }function _InitAdmin(){ parent::_InitAdmin(); $vMod =&$this->cms->Core->GetModule('members'); $this->cms->Gui->AddGlobalVars(array ('members_link' => $vMod->GetAdminLink())); $this->lIl1lIl =isset($this->cms->Vars['flt_section_id']) ?intval($this->cms->Vars[I9554]) :0; if ($this->lIl1lIL) {$this->options['group_operations'] =array ('publish_on', 'publish_off', 'del'); }}function TTTlTI1() {parent::TTTlTI1(); $this->I1LIIl1 =false; $this->lIl1lI1 =$this->module->GetOption(I9555); $this->lIl1llI =$this->module->GetOption('messages_pages'); $this->lIl1lll =$this->module->GetOption('topic_tool_tip_length'); $this->II11ll1 =empty($this->IlIlLIL['id']) ?0 :$this->IlIlLIL['id']; $this->lIl1llL =0; $this->lIl1ll1 =null; }function TTT11Tl(&$IILILII) {if ($this->side == I9548 && !$this->lIl1lIL && ($index =array_search(I9556, $IILILII))) {$IILILII[$index] ='leg_bold_in_topic_list'; }}function TTTlIII() {parent::TTTlIII(); if($this->lIl1lLL){ $this->filter->UpdateField('sort', I9549); $this->filter->UpdateField('sdim', 'desc'); }$aModules =array(); $this->filter->AddField(I9557, 'hidden', empty($this->cms->Vars[I9557]) ?0 :1, '1', ' = ', '(' .$this->options[I9558] .'id = ' .$this->options[I9558].'id_thread)'); if (empty($this->cms->Vars[I9557]) || $this->cms->Vars[I9557] == 0) {$this->filter->DisableFieldSQL(I9557); }$this->filter->AddField('flt_id', 'text', isset($this->cms->Vars[I9559]) ?stripslashes(unhtmlentities($this->cms->Vars[I9559])) :'', '', ' = ', $this->options[I9558].'id'); if (empty($this->cms->Vars[I9559])) {$this->filter->DisableFieldSQL(I9559); }else {$sql ="SELECT `id_thread` FROM `cms_forum` WHERE `id` = " .intval($this->cms->Vars[I9559]); $threadId =$this->db->getValue($sql); if ($threadId) {$this->filter->DisableFieldSQL(I9557); $this->lIl1lIL =$threadId; }}$search =isset($this->cms->Vars['flt_search']) ?trim(stripslashes(unhtmlentities($this->cms->Vars['flt_search']))) :''; $this->filter->AddField("flt_search", I9560, $search, "", " LIKE ", $this->options[I9558].I9553); $this->filter->TITI1II("flt_search", " OR " .$this->options[I9558].I9553 .I9561.addslashes($search)."%' ". " OR " .$this->options[I9558].'message' .I9561.addslashes($search)."%' " );if ($search === I9562) {$this->filter->DisableFieldSQL('flt_search'); }else {$this->filter->DisableFieldSQL(I9557); }if ($this->IlIllI1->TTTlIII(I9554)) {$this->filter->MoveField(I9554, _MOVE_START); }$this->filter->AddField('flt_locked', 'checkbox', isset($this->cms->Vars['flt_locked']) ?$this->cms->Vars[I9563] :null, '0', ' = ', $this->options[I9558].'locked'); if (empty($this->cms->Vars[I9563])) {$this->filter->DisableFieldSQL(I9563); }$this->filter->AddField('flt_id_thread', I9564, $this->lIl1lIL, 0, ' = ', $this->options[I9558].'id_thread'); if ($this->lIl1lIL) {$this->filter->TITI1l1(I9563); }else {$this->filter->DisableFieldSQL('flt_id_thread'); }$this->filter->AddField('flt_go_last_page', I9564, I9562); $this->filter->AddField(I9565, 'text', isset($this->cms->Vars[I9565]) ?stripslashes(unhtmlentities($this->cms->Vars[I9565])) :I9562, I9562, ' LIKE ', "`author`"); if (empty($this->cms->Vars[I9565])) {$this->filter->DisableFieldSQL(I9565); }$this->filter->AddField('flt_ip', I9566, isset($this->cms->Vars['flt_ip']) ?stripslashes(unhtmlentities($this->cms->Vars['flt_ip'])) :I9562, I9562, ' = ', 'INET_NTOA(`ip`)'); if (empty($this->cms->Vars[I9567])) {$this->filter->DisableFieldSQL(I9567); }if (!$this->lIl1lIL) {$this->filter->AddField('flt_unanswered', 'checkbox', isset($this->cms->Vars['flt_unanswered']) ?$this->cms->Vars['flt_unanswered'] :null, I9568, ' = ', '(' .$this->options[I9558] .'msg_answers'. ' = 0)'); if (empty($this->cms->Vars[I9569])) {$this->filter->DisableFieldSQL(I9569); }}}function _ApplyCatFilters($prefix =I9562, $bodyType =I9562, $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); if ($bodyType == 'cats_selectbox' && $this->side == I9548) {$res .= ' AND is_separator = 0'; }return $res; }function TTTlI1l() {return parent::TTTlI1l() && $this->IlIllI1->TTTlI1l(); }function TTTlI11(&$vData, &$aCustom){ if ($this->lIl1lIL && !in_array($this->cms->Vars['action'], array ('reply', I9570, 'edit'))) {$this->cms->Vars['action'] ='reply'; $sql ="SELECT `msg_id` FROM `cms_forum` WHERE `id` = " .$this->lIl1lIL; $cId =$this->db->getValue($sql); $this->TTTl1Tl($cId ?$cId :$this->lIl1lIL, I9562); if (is_array($this->itemData)) {if ($this->itemData[I9571]) {$aTemplates =array ('forum_subform' => 'templates/empty_pager_form.tpl', 'forum_form' => 'templates/empty_form.tpl' );foreach($aTemplates as $name => $files) {if (!is_array($files)) {$files =array($files); }foreach($files as $fname) {$this->cms->Gui->mergeBlock($name, $fname); }}}else {$vData =array_merge($vData, $this->itemData); }}}$path =array ();$categoryId =$this->I1LII1I ?$this->lIl1lIl ?$this->lIl1lIl :(sizeof($this->itemData) ?$this->itemData[I9572] :0) :0; if ($categoryId >0) {foreach ($this->IlIllI1->IILL1IL as $row) {if ($row['id'] == $categoryId) {$caption =$row['name']; break; }}if (isset($caption)) {$path[] =$this->cms->Gui->getAbs($this->moduleName .'_list:path_category', array ('id' => $categoryId, I9573 => $caption ));}}if (sizeof($path)) {array_unshift($path, $this->cms->Gui->getAbs($this->moduleName .'_list:path_category', array ('id' => 0, I9573 => $this->words['all'] )));}if ($this->lIl1lIL) {$this->filter->TITI1l1('flt_urgent'); $sql ="SELECT `topic` FROM `cms_forum` WHERE `id` = " .$this->lIl1lIL; $caption =$this->db->getValue($sql); if (!is_null($caption)) {$path[] =$this->cms->Gui->getAbs($this->moduleName .'_list:path_topic', array (I9573 => $caption)); }}else {$this->words['forum_add'] =$this->words['forum_topic_add']; $this->words['forum_apply'] =$this->words[I9574]; }$aCustom['list_data']['path'] =implode($this->cms->Gui->getAbs($this->moduleName .'_list:path_splitter', I9562), $path); $aSQL =array ('join_to_alias' => I9575); $this->IlIllI1->TTIT1lT('item_list', $aSQL); $II11L1I =$this->lIl1lIL ?$this->cms->DFMT['db_dtime'] :str_replace(':%s', I9562, $this->cms->DFMT['db_dtime']); $this->browser->InitSQL( "f.*, f.id lock_id, DATE_FORMAT(f.date, '" .$II11L1I ."') AS fdate, " ."DATE_FORMAT(f.`msg_date`, '" .$II11L1I ."') `fmsg_date` " .$aSQL["select"], array (I9576 => array(I9575 => 'cms_forum') +$aSQL[I9576], 'joins' => $aSQL['joins'], 'joins_types' => array (I9577 => 'LEFT OUTER') ),"WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), "", "name", I9578, $aSQL[I9576] += array (I9553 => '=|id_thread') );if (!empty($aSQL[I9576])) {$this->browser->AddSQLJoinedTables($this->cms->Core, I9575, $aSQL[I9576]); }$aFields =array ('public' => array ('action' => 'flagicon', I9579 => 1, 'id' => 'pub_id', 'on' => $this->moduleName .'_list:public_on', I9580 => $this->moduleName .'_list:public_off'), 'cname' => array ('action' => 'stripline', I9581 => 35), I9553 => array ('action' => 'stripline', I9581 => 145), 'author' => array ('action' => I9582, I9581 => 35), 'action_reply' => array ('action' => 'flagicon', I9579 => I9562, 'id' => I9583, 'on' => $this->moduleName .'_list:reply', I9580 => I9562), 'action_edit' => array ('action' => I9584, I9579 => I9562, 'id' => 'edit_id', 'on' => $this->moduleName .'_list:edit', I9580 => I9562), I9585 => array ('action' => I9584, I9579 => I9562, 'id' => 'del_id', 'on' => $this->moduleName .I9586, I9580 => I9562) );$aCustom['fields'] += $aFields; $aCustom['fields']['bold'] =array ('action' => I9587, 'object' => &$this, 'method' => '_GetAdminItemCB'); $aCustom['applied_id'] =I9588; $aCustom['form_data']['buttons'] =array ('add', 'apply', I9589, I9570, 'preview'); $this->IlIllI1->TTTlI11($vData, $aCustom); if (sizeof($this->itemData)) {if ($this->itemData['id'] != $this->itemData['id_thread']) {$this->cms->Gui->addGlobalVars(array ('USE_SPECIAL_LIST_VIEW' => false)); }if ($this->cms->Vars[I9590] == 'reply') {$vData['fdate'] =date($this->cms->DFMT['php_dtime']); }}else {$vData['ip'] =getenv(I9591); $this->itemData['id_member'] =$vData['id_member'] =$this->IlIlLIL['id']; $vData['author'] =$this->TTI1TII(); $vData[I9592] =date($this->cms->DFMT['php_dtime']); }$vData['noindex_external_links'] =$this->module->GetOption('noindex_external_links') ?'true' :I9593; $aCustom['legend'] =array ('published', 'notpublished', I9556, 'leg_yellow', I9594, 'leg_reply', 'leg_edit', 'leg_del'); $aCustom['list_data'][I9595] =!$this->lIl1lIL; $this->cms->Gui->addGlobalVars(array ('DISPLAY_CATEGORIES' => !$this->lIl1lIl && !$this->lIl1lIL, 'NOT_THREAD' => !$this->lIl1lIL, 'DISPLAY_MESSAGES' => $this->lIl1lIl || $this->lIl1lIL ));$vData[I9547] =$this->I1LII1I; require_once $GLOBALS['FUNC_INCLUDES_PATH'] .I9596; parent::TTTlI11($vData, $aCustom); }function _GetAdminItemCB(&$aItem, &$aData) {foreach (array ('author', 'msg_author') as $k) {if (isset($aItem[$k])) {$this->TTI1TIl($aItem[$k]); }}$this->TTIl11l($aItem); $aItem['is_topic'] =intval($aItem['id'] == $aItem[I9597]); if ($this->lIl1lIL) {if ($aItem['is_topic']) {$aItem['style'] .= '_b'; }if (!$aItem[I9571]) {$aItem['msg_id'] =$aItem[I9598]; $aItem['action_reply'] =$this->cms->Gui->get($this->moduleName .'_list:reply', $aItem); }}elseif (!$aItem['msg_answers']) {$aItem['style'] .= I9599; }if ($aItem[I9571]) {$aItem['action_reply'] =$this->cms->Gui->get($this->moduleName .'_list:icon_none', $aItem); }$aItem[I9571] =$aItem[I9598] == $aItem[I9597] ?$this->cms->Gui->get($this->moduleName .'_list:locked_' .($aItem[I9571] ?'on' :I9580), $aItem) :I9600; $aItem['answers'] =$this->lIl1lIL ?I9562 :$this->cms->Gui->get($this->moduleName .'_list:answers', $aItem); if ($aItem['is_topic']) {$aItem[I9585] =$this->cms->Gui->get($this->moduleName .'_list:action_del', $aItem); }$aItem[I9601] =$this->cms->stripLine(TlTllI1($aItem[I9601]), 1024); }function TTTlITT($IIIL11l, $cId, $cModule =I9562) {switch ($this->side) {case I9548: if ($cId >0) {$this->TTIl111($cId); switch ($IIIL11l) {case 'reply': $this->TIIl111($IIIL11l, $cId); break; case 'lock': $this->TII1TTT($cId); break; }}switch ($IIIL11l) {case 'grp_lock_on': case 'grp_lock_off': $this->TII1TTl($this->aGroupIds, $cModule, $IIIL11l); break; }default: switch ($IIIL11l) {case I9602: $this->TII1TlT(); break; case 'view_posts': if ($cId >0) {$this->TII1Tl1($cId); }case 'locate': if ($this->realSide == 'standard' && !empty($this->cms->VarsGet['id_message'])) {$messageId =intval($this->cms->VarsGet[I9603]); if ($this->id || $messageId >0) {$this->_locateMessageId =$messageId; }}break; }}if ($cId >0) {switch ($IIIL11l) {case 'update_member': $this->TTI1TTT($cId); break; case 'delete_member': $this->TTI1TTI($cId); break; }}parent::TTTlITT($IIIL11l, $cId, $cModule); }function TTT1IlI($aSql =array (),$cId =0) {require_once $GLOBALS['FUNC_INCLUDES_PATH'] .I9596; if ($cId) {$this->TII1T1T($cId); }$topic =$this->cms->VarsPost[I9553]; $message =$this->cms->VarsPost[I9601]; $this->threadId =intval($this->cms->VarsPost[I9597]); $this->_public =intval($this->cms->VarsPost['public']); if (!empty($topic) && !empty($message)) {$message =removeSpecial($message, I9604); $this->TTI1TIT($message, $this->module->GetOption('front_images'), (bool)sizeof($this->IlIlLIL)); $aSql =array (I9597 => $this->threadId, I9553 => $topic, I9601 => addslashes(TlTllIl($this->cms->htmlchars($this->cms->TTITIIT($message)), true, $this->module->GetOption('noindex_external_links'), $this->IlIlLlI)), 'public' => $this->_public );if (!empty($this->cms->VarsPost['author'])) {$aSql[I9605] =$this->cms->VarsPost[I9605]; }$aSql[empty($this->cms->VarsPost[I9598]) ?'date' :'modified_date'] ='=|now()'; if ($this->action == 'add') {$aSql[I9606] ="=|INET_ATON('" .getenv(I9591) ."')"; if (!empty($this->cms->VarsPost['id_member'])) {$aSql['id_member'] =intval($this->cms->VarsPost[I9607]); }if (!$this->threadId) {$aSql += array ('msg_topic' => $aSql[I9553], 'msg_id_member' => $aSql[I9607], 'msg_author' => $aSql[I9605], I9549 => '=|NOW()', I9608 => 0 );}}if (empty($this->cms->Vars['skip_cats'])) {$this->IlIllI1->TTT1IlI($aSql, $cId); }if (isset($this->cms->VarsPost[I9572])) {$aSql[I9572] =$this->cms->VarsPost[I9572]; }if (isset($this->cms->VarsPost[I9571])) {$aSql[I9571] =intval($this->cms->VarsPost[I9571]); }}$aSql =parent::TTT1IlI($aSql, $cId); if($cId){ if($cId != $this->threadId){ $sql ="SELECT `sublink` FROM `cms_forum` WHERE `id` = " .$this->threadId; $sublink =$this->db->getValue($sql); if($sublink){ $aSql['sublink'] =$sublink; }}else{ $oQuery =DB_Query::getUpdateQuery( 'cms_forum', array(I9609 => $aSql[I9609]), 'WHERE `id_thread` = ' .$this->threadId );$this->db->query($oQuery->get()); }}return $aSql; }function TIIl111(&$IIIL11l, &$cId) {$IIIL11l ='edit'; }function TII1TTT($cId) {$this->redirect =false; $sql =$this->db->genUpdateSQL('cms_forum', array (I9571 => intval($this->cms->Vars['lock'] == I9610)), "WHERE `id_thread` = " .$cId); $this->db->execute($sql); $this->appliedId =$cId; $this->cms->AddStatusMsg('status_activate'); }function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); if (empty($this->errno) && $this->appliedId >0) {$this->IlIllI1->TTTll11($cId, $cModule); if ($this->threadId) {if ($this->_public) {$sql ="SELECT `id_cat`, " .$this->appliedId ."`msg_id`, `topic` `msg_topic`, `id_member` `msg_id_member`, `author` `msg_author`, `date` `msg_date`, `sublink` " .I9611 ."WHERE `id` = " .$this->appliedId; if ($aSQL =$lIl1l1I =$this->db->getRecord($sql)) {$this->IlIllI1->catId =$aSQL[I9572]; unset($aSQL[I9572], $aSQL[I9609]); $aSQL[I9608] ='=|msg_answers + 1'; $aSQL['msg_topic'] =addslashes($aSQL['msg_topic']); $aSQL[I9612] =addslashes($aSQL[I9612]); $sql =$this->db->genUpdateSQL('cms_forum', $aSQL, "WHERE `id` = " .$this->threadId); $this->db->execute($sql); $this->TIIT1TI($lIl1l1I); }}}else {$aSQL =array (I9597 => $this->appliedId, 'msg_id' => $this->appliedId, );$sql =$this->db->genUpdateSQL('cms_forum', $aSQL, I9613 .$this->appliedId); $this->db->execute($sql); }if ($this->_public) {if ($this->I1LII1I && !empty($this->IlIllI1->catId)) {$this->IlIllI1->TII1T1I($this->threadId ?$this->threadId :$this->appliedId); }$this->TTI1Tl1($this->IlIlLIL[I9598], 1, TRUE); }if ($this->realSide == 'front') {$this->TIIT1TT(); }}}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $IIl1ll1 =array ('select' => I9562, 'joins' => array (),I9576 => array ());$this->IlIllI1->TTIT1lT('item_list', $IIl1ll1); if (sizeof($IIl1ll1[I9614])) {reset($IIl1ll1[I9614]); list (,$IIl1ll1[I9614]) =each ($IIl1ll1[I9614]); reset($IIl1ll1[I9576]); list ($lIl1l1l, $IIl1ll1[I9576]) =each ($IIl1ll1[I9576]); $lIl1l1L =" LEFT OUTER JOIN " .$IIl1ll1[I9576] .' ' .$lIl1l1l ." ON " .$IIl1ll1[I9614]; }else {$lIl1l1L =""; }$sql ="SELECT f.*, DATE_FORMAT(f.date, '" .$this->cms->DFMT["db_dtime"] ."') AS fdate, " ."IF(f.public > 0, 'checked', '') `public`, IF(f.locked > 0, ' checked', '') `locked`, INET_NTOA(`ip`) `ip`". $IIl1ll1['select'] ." FROM `cms_forum` AS f" .$lIl1l1L ." WHERE f.id='".$cId."'".$this->_ApplyFilters(); $this->db->query($sql); if ($this->itemData =$this->db->nextRecord()) {if ($this->cms->Vars[I9590] == 'reply') {$this->itemData[I9598] =0; $this->itemData['date'] =date($this->cms->DFMT[I9615]); $this->itemData[I9601] ='[Q="' .$this->itemData[I9605] .'"]' .TlITI1l($this->itemData[I9601], true) .'[/Q]'; $this->itemData[I9605] =$this->TTI1TII(); $this->itemData[I9607] =$this->IlIlLIL[I9598]; }else {$this->itemData[I9601] =TlITI1l($this->itemData[I9601], true); }}}function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); if (empty($this->errno)) {$threadId =$this->threadId ?$this->threadId :$this->appliedId; $lIl1l11 =$this->IlIllI1->TTTl1lI($cId, $cModule); if ($lIl1l11) {$aSQL =array (I9572 => $lIl1l11); if (isset($this->cms->VarsPost[I9571])) {$aSQL[I9571] =intval($this->cms->VarsPost[I9571]); }$sql =$this->db->genUpdateSQL('cms_forum', $aSQL, "WHERE `id_thread` = " .$threadId); $this->db->execute($sql); $this->TII1TT1(0, $this->IlIllI1->catId); $this->TII1TT1($cId); }else {if (isset($this->cms->VarsPost[I9571])) {$aSQL[I9571] =intval($this->cms->VarsPost[I9571]); }if (isset($this->cms->VarsPost[I9571])) {$sql =$this->db->genUpdateSQL('cms_forum', array (I9571 => intval($this->cms->VarsPost[I9571])), "WHERE `id_thread` = " .$threadId); $this->db->execute($sql); }if (!$this->_public && $this->threadId == $cId) {$this->TII1TTI(); }$this->TII1TT1($this->threadId ?$this->threadId :$cId, 0, true); if ($this->_public && $this->threadId == $cId) {$this->TTI1T1T('id_thread = ' .$this->threadId, 1, TRUE); }}}}function _ActionDel($cId, $cModule) {$cId =intval($cId); $sql ="SELECT `id_cat`, `id_thread` FROM `cms_forum` WHERE `id` = " .$cId; list ($categoryId, $threadId) =$this->db->getRecord($sql, 0, MYSQL_NUM); if ($this->lIl1lIL == $cId || $threadId == $cId) {if ($threadId == $cId) {$this->lIl1lIL =$cId; }$this->TTI1T1T(I9616 .$cId .$this->_ApplyFilters('t', I9617), -1, TRUE); $this->TII1TII($cId); }else {$this->TTI1Tl1($this->IlIlLll[I9607], -1, TRUE); }parent::_ActionDel($cId, $cModule); if ($this->lIl1lIL == $cId) {$sql ="DELETE FROM `cms_forum` WHERE `id_thread` = " .$cId; $this->db->execute($sql); }if ($this->lIl1lIL) {$this->TII1TT1($this->lIl1lIL, $categoryId, $threadId == $cId); }else {$this->TII1TT1($cId); }if ($this->lIl1lIL == $cId) {$this->redirect =$this->forceRedirect =false; $this->TII1TIl(); }}function _ActionPublish($cId, $cModule) {if($this->action != 'publish'){ $public =(int)!empty($this->cms->VarsPost['public']); }else{ $public =(int)($this->cms->Vars[I9618] == I9610); $this->TII1T1T($cId, true); }parent::_ActionPublish($cId, $cModule); if (mb_strpos($this->action, 'grp_') === false && $this->IlIlLIl == $public) {return; }if ($cId == $this->threadId && !$public) {$this->TII1TTI(); }$this->TII1TT1($this->threadId ?$this->threadId :$this->appliedId); }function TII1TTI() {$this->TTI1T1T('id_thread = ' .$this->threadId, -1, TRUE); $sql ="UPDATE `cms_forum` SET `public` = 0 WHERE id_thread = " .$this->threadId; $this->db->execute($sql); }function TTTl1l1(&$aGroupIds, $cModule, $public =null){ if(is_null($public)){ $public =1; }$sql ="UPDATE `cms_forum` SET `public` = " .$public .I9619 .implode(',', $aGroupIds) .")"; $this->db->execute($sql); $IIl1lIl =$this->db->affectedRows(); if($IIl1lIl){ $this->IIllIll =$IIl1lIl; $this->cms->AddStatusMsg($public ?'status_grp_publish' :'status_grp_unpublish', I9620, I9562, I9562, array ('num_items' => $IIl1lIl .I9562)); if(!$public && $this->lIl1lIL && in_array($this->lIl1lIL, $aGroupIds)){ $this->threadId =$this->lIl1lIL; $this->TII1TTI(); }$this->aGroupIds =array(); $this->appliedId =I9562; $this->TII1TT1($this->lIl1lIL, 0, true); $aGroupIds =array(); }}function TTTl11T(&$aGroupIds, $cModule) {$this->TTTl1l1($aGroupIds, $cModule, 0); }function TII1TTl(&$aGroupIds, $cModule, $IIIL11l) {$locked =intval($IIIL11l == 'grp_lock_on'); $sql ="UPDATE `cms_forum` SET `locked` = " .$locked ." WHERE `id_thread` IN (" .implode(I9621, $aGroupIds) .")"; $this->db->execute($sql); if ($IIl1lIl =$this->db->affectedRows()) {$this->IIllIll =$IIl1lIl; $this->cms->AddStatusMsg($locked ?'status_grp_locked' :'status_grp_unlocked', I9620, I9562, I9562, array ('num_items' => $IIl1lIl .I9562)); $this->aGroupIds =array ();$this->appliedId =I9562; }}function TTTl1I1(&$aGroupIds, $cModule) {$ids =implode(I9621, $aGroupIds); if (!$this->lIl1lIL && $this->I1LII1I) {$I1IILLL =array ();$sql ="SELECT DISTINCT(`id_cat`) FROM `cms_forum` WHERE `id` IN (" .$ids .")"; $rs =&$this->db->select($sql); while (list ($categoryId) =$rs->nextRecord(MYSQL_NUM)) {$I1IILLL[] =$categoryId; }}$sql ="DELETE FROM `cms_forum` ". "WHERE `" .($this->lIl1lIL ?I9598 :I9597) ."` IN (" .$ids .I9622; $this->db->execute($sql); if (!$this->lIl1lIL) {$this->TII1TII($ids); }$IIl1lIl =$this->db->affectedRows(); if ($IIl1lIl) {if ($this->lIl1lIL) {$this->TII1TT1($this->lIl1lIL, true); if (in_array($this->lIl1lIL, $aGroupIds)) {$this->TII1TIl(); }}elseif ($this->I1LII1I) {foreach ($I1IILLL as $categoryId) {$this->TII1TT1(0, $categoryId, true); }}$this->IIllIll =$IIl1lIl; $this->cms->AddStatusMsg('status_grp_del', I9620, I9562, I9562, array ('num_items' => $IIl1lIl .I9562)); $this->aGroupIds =array ();$this->appliedId =I9562; }}function TII1TT1($threadId =0, $categoryId =0, $lIl1LII =false) {$this->TTI1TI1(); if ($threadId) {$this->side ='front'; $sql ="SELECT MAX(`date`) `msg_date`, COUNT(`id`) `msg_answers` " ."FROM `cms_forum` f " ."WHERE `id_thread` = " .$threadId .$this->_ApplyFilters(I9562, I9548, false); $this->side =I9548; if ($record =$this->db->getRecord($sql)) {if (!$record[I9549]) {if(!$categoryId){ $sql ="SELECT `id_cat` FROM `cms_forum` WHERE `id` = " .$threadId; $categoryId =$this->db->getvalue($sql); }$this->TII1TT1(0, $categoryId, $lIl1LII); }else {if ($record[I9608] >0) {$record[I9608]--; }$this->side ='front'; $sql ="SELECT `id_cat`, `id_thread` FROM `cms_forum` f " ." WHERE `id_thread` = " .$threadId ." AND `date` = '" .$record[I9549] ."'" .$this->_ApplyFilters(I9562, I9548, false) ." LIMIT 1"; $this->side =I9548; if ($lIl1LIl =$this->db->getRecord($sql)) {$this->TII1TIT($record +$lIl1LIl, !$lIl1LII); if ($categoryId) {$this->TII1TT1(0, $categoryId, true); }}}}elseif($categoryId){ $this->TII1TT1(0, $categoryId, true); }}elseif ($categoryId) {$this->side ='front'; $sql ="SELECT MAX(`date`) " ."FROM `cms_forum` f " ."WHERE `id_cat` = " .$categoryId .$this->_ApplyFilters(I9562, I9548, false); $this->side =I9548; if ($lIl1LIL =$this->db->getValue($sql)) {$this->side ='front'; $sql ="SELECT `id_thread` FROM `cms_forum` f WHERE `date` = '" .$lIl1LIL .I9623 .$this->_ApplyFilters(I9562, I9548, false); $this->side =I9548; if ($threadId =$this->db->getValue($sql)) {$this->TII1TT1($threadId, 0, $lIl1LII); }}else {$aSQL =array ('num_public_items' => 0, 'num_public_topics' => 0, 'msg_id' => 0, 'msg_id_thread' => 0, I9624 => I9562, 'msg_id_member' => 0, I9612 => I9562, I9549 => I9562, 'msg_sublink' => I9562, I9608 => 0 );$sql =$this->db->genUpdateSQL('cms_forum_cat', $aSQL, I9613 .$categoryId); $this->db->execute($sql); }}}function TII1TIT($record, $lIl1LI1 =false) {$threadId =$record[I9597]; unset($record[I9597]); $sql ="SELECT `id` `msg_id`, `topic` `msg_topic`, `id_member` `msg_id_member`, `author` `msg_author` " ."FROM `cms_forum` f " ."WHERE `date` = '" .$record[I9549] ."' AND `id_thread` = " .$threadId; if ($aSQL =$this->db->getRecord($sql)) {if ($lIl1LI1) {$sql ="SELECT `msg_id`, `msg_topic` FROM `cms_forum` WHERE id = " .$threadId; $lIl1LlI =$this->db->getRecord($sql); if ($lIl1LlI['msg_id'] == $aSQL[I9625] && $lIl1LlI[I9624] == $aSQL[I9624]) {return; }}$this->TTI1TI1(); $categoryId =$record[I9572]; unset($record[I9572]); $aSQL += $record; $aSQL[I9624] =addslashes($aSQL[I9624]); $aSQL[I9612] =addslashes($aSQL[I9612]); $sql =$this->db->genUpdateSQL('cms_forum', $aSQL, I9613 .$threadId); $this->db->execute($sql); if ($categoryId && $this->I1LII1I) {$this->side ='front'; $sql ="SELECT COUNT(1) `num_items`, SUM(IF(`public` != 0, 1, 0)) `num_public_items`, SUM(IF(`id_thread` = `id` AND `public` != 0, 1, 0)) `num_public_topics`, MAX(`id`) `msg_id`" ." FROM `cms_forum` f " .I9626 .$categoryId .$this->_ApplyFilters(I9562, I9548, false) ." GROUP BY `id_cat`"; $this->side =I9548; if ($record =$this->db->getRecord($sql)) {$sql ="SELECT `topic` `msg_topic`, `sublink` `msg_sublink` FROM `cms_forum` WHERE `id` = " .$threadId; if ($lIl1Lll =$this->db->getRecord($sql)) {$lIl1Lll[I9624] =addslashes($lIl1Lll[I9624]); $aSQL =array_merge($aSQL, $lIl1Lll); }$aSQL += $record; $aSQL['msg_id_thread'] =$threadId; $sql =$this->db->genUpdateSQL('cms_forum_cat', $aSQL, I9613 .$categoryId); $this->db->execute($sql); }}}}function TTT1Tl1($cType, $cModule, $II11l1L =TRUE) {switch ($cType) {case I9627: $this->TTI1TI1(); $I1IILLL =array ();if ($this->I1LII1I) {$sql ="SELECT `id` FROM `cms_forum_cat` c WHERE 1" .$this->IlIllI1->_ApplyFilters(I9562, 'cats_selectbox'); $rs =&$this->db->select($sql); while (list ($categoryId) =$rs->nextRecord(MYSQL_NUM)) {$I1IILLL[$categoryId] =$categoryId; }}$this->side ='front'; $sql ="SELECT `id_cat`, `id_thread`, MAX(`date`) `msg_date`, COUNT(`id`) `msg_answers` " ."FROM `cms_forum` f " ."WHERE 1 " .$this->_ApplyFilters(I9562, I9548, false) ." GROUP BY `id_thread` ORDER BY `id_cat` ASC"; $this->side =I9548; $rs =&$this->db->select($sql); $records =array ();while ($record =$rs->nextRecord()) {$records[] =$record; }if (($qty =sizeof($records)) >0) {$lIl1LlL =$qty -1; require_once $GLOBALS['FUNC_INCLUDES_PATH'] .'func_array.php'; sortMultiArray($records, I9549); $lIl1Ll1 =$this->I1LII1I; foreach ($records as $index => $record) {unset($I1IILLL[$record[I9572]]); if ($record[I9608] >0) {$record[I9608]--; }$this->I1LII1I =$index <$lIl1LlL ?$record[I9572] != $records[$index +1][I9572] :true; $this->TII1TIT($record); }$this->I1LII1I =$lIl1Ll1; }foreach ($I1IILLL as $categoryId) {$this->TII1TT1(0, $categoryId); }parent::TTT1Tl1($cType, $cModule, false); $this->cms->AddStatusMsg('status_repair_counters', I9620); break; default: if (!$this->IlIllI1->TTT1Tl1($cType, $cModule)) {parent::TTT1Tl1($cType, $cModule); }}}function TII1TII($ids) {$sql ="DELETE FROM `cms_forum_subscribers` WHERE `id_thread` IN (" .$ids .I9622; $this->db->execute($sql); }function TIIT1TI($aSQL) {$IlIIIlI =$aSQL['msg_id_member']; $topic =$aSQL[I9624]; $sql ="SELECT m.id, m.email, m.username " ."FROM `cms_forum_subscribers` s " ."INNER JOIN `cms_members` m ON m.id = s.id_member " ."WHERE s.id_thread = " .$this->threadId; $rs =&$this->db->select($sql); $aRecipients =array ();while (list ($memberId, $email, $username) =$rs->nextRecord(MYSQL_NUM)) {if ($memberId != $IlIIIlI) {$aRecipients[$username .' <' .$email .'>'] =array ('recipient_username' => $username); }}if ($I1LLIlL =(sizeof($aRecipients) >0)) {$vMod =&$this->cms->Core->GetModule(I9628); $this->cms->Gui->addBlock('_forum_email', '_local/_admin/templates/letters/forum_mail.tpl'); require_once $GLOBALS['CLASSES_PATH'] .'Mailer.php'; $oMail =new Mailer(); $mailData =array (I9553 => removeSpecial($topic), I9605 => removeSpecial($aSQL[I9612]), I9629 => $vMod->GetFrontLink() .'?action=forum_watching&subaction=stop_watching&id_thread=', I9597 => $this->threadId, I9598 => $this->appliedId, 'site_path' => preg_replace(array ('/^\w+\:\/\//', '/\/.*$/'), I9562, $GLOBALS[I9630]), 'topic_scrap' => $this->cms->stripLine(removeSpecial($topic), 50) );$oMail->SenderAddress =$this->TTI1TTl(); $oMail->BodyFormat ='plain'; $oMail->Prepare(); if ($this->side == I9548) {$mailData['www_root'] =$GLOBALS[I9630]; $aNavData =array (I9598 => $aSQL[I9625], 'id_sublink' => $aSQL[I9609] )+$this->IlIllI1->TTT11IT(I9562); $this->cms->TTTTlll(); $this->cms->frn->ActiveModule =&$this->module; $aNavData =$this->cms->frn->ApplyNav($aNavData); $mailData[I9631] =$this->module->GetFrontLink() .preg_replace('/\&*$/', I9562, $aNavData['nav_data']); }$IlI1LLl =array ('lang' => $this->langData, 'subject' => addslashes($this->cms->Gui->get('_forum_email:subject_post_in_topic', $mailData)), 'headers' => addslashes(serialize($oMail->_Headers)), 'body' => addslashes($this->cms->Gui->get('_forum_email:body_post_in_topic', $mailData)) );require_once $GLOBALS['CLASSES_PATH'] .I9632; CMS_MailQueue::addLetter($this->db, $IlI1LLl, $aRecipients); }if ($I1LLIlL) {require_once $GLOBALS['CLASSES_PATH'] .'CMS_BackgroundProcess.php'; $process =new CMS_BackgroundProcess(); $process->registerHandler('CMS_MailQueue::processQueue', I9562); $process->process(); }}function TII1TIl() {$this->lIl1lIL =0; if ($this->filter->issetField('flt_id_thread')) {$this->filter->DisableFieldSQL(I9633); }unset($this->cms->Vars[I9633]); $this->cms->Vars[I9557] =1; $this->filter->AddField(I9557, I9564, '1', '1', ' = ', '(' .$this->options[I9558] .I9634 .$this->options[I9558] .'id_thread)'); $this->options['group_operations'] =array ('lock_on', I9550, 'del', I9635, 'gen_keywords', 'reset_ratings'); }function correctStopArgNames($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ='getallvalues') {return $this->IlIllI1->correctStopArgNames($cData, $IIL1lL1, $res, $aData, $IIL1l1I); }function TTT1II1(&$db, &$aParams) {$aVars =parent::TTT1II1($db, $aParams) +$this->IlIllI1->TTT1II1($db, $aParams); return $aVars; }function TTTllTI(&$aCustom) {$this->lIl1lLl =$this->_locateMessageId || empty($this->cms->VarsGet[I9603]) ?0 :(int)$this->cms->VarsGet[I9603]; if ($this->lIl1llL) {$this->SetBodyType('body_member_posts'); }else {$flag =true; $I1LII1L =false; $cat =$this->IlIllI1->TTTllTI($aCustom); if($cat != -1) {if ($this->id >0) {$this->SetBodyType($this->lIl1lLl ?I9636 :'body_itemD'); $this->SetBodyType('body_message_form'); $flag =false; $I1LII1L =true; }else {if($cat === 0) {$this->SetBodyType('body_urgent_cats'); $this->SetBodyType('body_cats'); $this->bodyType =I9637; $flag =false; }else {if($this->id != -1) {$this->SetBodyType('body_urgent_items'); $this->SetBodyType('body_items'); $this->SetBodyType('body_form'); $this->bodyType ='body_items'; }else {$this->SetBodyType($this->lIl1lLl ?I9636 :I9638); $this->SetBodyType('body_message_form'); $flag =false; $I1LII1L =true; }}}if ($cat !== false) {if ($flag && $this->module->GetOption('multicat')) {$this->SetBodyType('body_urgent_cats'); $this->SetBodyType(I9637); if ($this->bodyType == 'body_urgent_cats') {$this->bodyType =I9637; }}if ($I1LII1L && $this->module->GetOption('multicat_in_body_details')) {$this->SetBodyType('body_urgent_cats'); $this->SetBodyType(I9637); if ($this->bodyType == 'body_urgent_cats') {$this->bodyType =I9637; }}}}}parent::TTTllTI($aCustom); }function TTTll1T(&$vData, &$aCustom) {$this->TII1TI1($vData); $vData['display_form'] =!empty($this->cms->VarsGet['display_form']); if($vData[I9639]){ $this->TTTllT1(); }$useSpecialListView =$this->options['use_special_list_view']; $I1LllL1 =AMI::getSingleton('env/session')->isLoggedIn(); if ($I1LllL1) {$vData[I9605] =$this->TTI1TII(); $vData[I9607] =$this->II11ll1; }else {$vData[I9605] =I9562; $vData[I9607] =0; }foreach($this->IIllIL1 as $IIlL1L1 => $tmp) {$aDefault =array ();$IIlL1Ll =$this->TTITTT1($aCustom, $IIlL1L1, false); switch ($IIlL1L1) {case I9637: case 'body_urgent_cats': $IIlL1Ll['page_item_type'] =$IIlL1L1; $IIlL1Ll['show_urgent_elements'] =$this->cms->Core->getModOption('forum_cat', 'show_urgent_elements'); $IIlL1Ll['_sql']['select'] =", `is_separator`, `num_public_items`, `num_public_topics`, `msg_id`, `msg_sublink`, `msg_topic`, `msg_id_member`, `msg_author`, " ."DATE_FORMAT(`msg_date`, '" .str_replace(':%s', I9562, $this->cms->DFMT["db_dtime"]) ."') `fmsg_date`, `msg_answers`"; $IIlL1Ll[I9640] =array ('num_public_items', 'cat_num_public_topics'); if ($IIlL1L1 == I9637) {$IIlL1Ll['replace_empty_set_by_row_set'] =true; }$this->IlIllI1->TTTll1T($vData, $IIlL1Ll); break; case 'body_items': case I9641: $aDefault['page_item_type'] =$IIlL1L1; $IIlL1Ll += $aDefault; $this->TTTllll($vData, $IIlL1Ll); $aSQL =array ();$this->IlIllI1->TTIT1lT('item_list', $aSQL); $this->browser->InitSQL( "f.*" .$aSQL['select'] .", DATE_FORMAT(`msg_date`, '" .str_replace(':%s', I9562, $this->cms->DFMT["db_dtime"]) ."') `fmsg_date`, `msg_date` `c_date`", "FROM cms_forum f ", "WHERE f.id = f.id_thread " .$aSQL['where'] .$this->_ApplyFilters(I9575, $IIlL1L1 == I9641 ?$IIlL1L1 :I9562) .$this->TTTlIl1(), I9562, $this->browser->TI1TTlT(), 'f.date desc' );if ($this->IlIllI1->TTTll1T($vData, $IIlL1Ll)) {$IIlL1Ll[I9640] =array (I9553, 'date', I9605); $IIlL1Ll['fields'][I9598] =array (I9590 => I9587, I9642 => &$this, 'method' => '_GetFrontTopicRowCB'); if ($IIlL1L1 == 'body_items') {$IIlL1Ll['replace_empty_set_by_row_set'] =true; $vData['noindex_external_links'] =$this->module->GetOption('noindex_external_links') ?'true' :I9593; }}else {$IIlL1Ll['page_item_type'] ='body_empty'; }break; case I9638: case I9636: if($this->lIl1lLl){ $this->TTTllT1(); }else{ $this->cms->Gui->addScript(I9643 .$this->id); }if($this->id <1){ $this->TTT11lI(); }$aDefault['page_item_type'] =I9638; $IIlL1Ll += $aDefault; $IIlL1Ll[I9640] =array (I9592, I9605, I9553, 'realcat_link'); if ($this->IlIllI1->TTTll1T($vData, $IIlL1Ll)) {$IIlL1Ll['page_item_type'] ='body_items'; $IIlL11I =I9644; $IIlL11l =$this->module->GetOption('messages_dim'); $this->TTTlIIT($this->offset, $IIlL11I, $IIlL11l, $this->lIl1lI1, false, 'page', 0); $this->browser->lllL11L =$this->lIl1llI; if (sizeof($this->IlIlLL1) >0) {$select =", DATE_FORMAT(m.date, '" .$this->cms->DFMT['db'] ."') `registration_date`, m.photo `avatar`, m.forum_sign, m.posts_count, m.companyweb member_site "; $this->IlIlL1L =$this->cms->Member->TTI1l1l($this->cms); if(is_object($this->IlIlL1L)){ $this->IlIlL1L->TITIIIl($select, 'm.', 'body_items'); }}else {$select =""; }$this->browser->InitSQL( "f.*, DATE_FORMAT(f.date, '" .$this->cms->DFMT[I9645] ."') AS fdate, UNIX_TIMESTAMP(f.date) `unixtime`, f.modified_date m_date, f.date c_date, m.custom_data, m.active is_member_active, m.source_app_user_id, m.source_app_id, m.rating_value as user_rating_value, m.rating_count as user_rating_count " .$select, array (I9576 => array(I9575 => 'cms_forum', 'm' => 'cms_members'), I9614 => array(I9646 => 'm.id = f.id_member'), 'joins_types' => array('f|m' => 'LEFT OUTER') ),I9647 .($this->lIl1lLl ?'f.`id` = ' .$this->lIl1lLl .' AND ' :I9562) .'f.id_thread = ' .$this->id .$this->_ApplyFilters(I9575) .$this->TTTlIl1(), I9562, $this->lIl1lLl ?I9562 :$this->browser->TI1TTlT(), $this->lIl1lLl ?I9562 :'f.id desc' );$this->browser->AddSQLJoinedTables($this->cms->Core, I9575, array (I9648 => 'cms_members')); $sql ="SELECT `topic`, `sublink` FROM `cms_forum` WHERE id = " .$this->id; if ($row =$this->db->getRecord($sql, 0, MYSQL_NUM)) {list ($vData[I9553], $sublink) =$row; }else {$sublink =null; }$pfx =$this->lIl1lLl ?'messageD_' :'itemD_'; $IIlL1Ll[I9649]['simple_prefix'] =$pfx; $IIlL1Ll[I9649]['splitter_prefix'] =$pfx; $IIlL1Ll[I9649]['stub_prefix'] =$pfx; $IIlL1Ll['list_set'] =$pfx .I9650; $IIlL1Ll['list_set_empty'] =$pfx .'list_empty'; $IIlL1Ll['row_set'] =$pfx .'row'; $IIlL1Ll[I9651][I9598] =array (I9590 => I9587, I9642 => &$this, 'method' => '_GetFrontTopicMessageRowCB'); if ($I1LllL1) {$IIlL1Ll[I9649][I9607] =$this->II11ll1; $IIlL1Ll[I9649][I9597] =$this->id; }$IIlL1Ll['pager_navdata'] ='/' .(isset($vData[I9652]) ?$vData[I9652] .'/' :I9562) .$sublink .'?'; $IIlL1Ll['hide_cat_id'] =true; $aCustom['force_page_size'] =$this->lIl1lI1; if($this->_locateMessageId){ $tmp =$this->browser->SQLData[I9653]; $this->browser->SQLData[I9653] =' '; $this->browser->ProcessSQL($this->db); $this->browser->SQLData[I9653] =$tmp; $this->browser->IsVarApplied =true; $this->offset =intval(floor($this->browser->ArrangePosSQL($this->db, $this->_locateMessageId, I9588) /$this->lIl1lI1)) *$this->lIl1lI1; $this->TTTlIIT($this->offset, $IIlL11I, $IIlL11l, $this->lIl1lI1, false, 'page', 0); }elseif($this->lIl1lLl){ $this->browser->SetForceRules(' ', ' ', true); $this->cms->Gui->addGlobalVars(array( I9654 => $GLOBALS['vGlobVars'][I9654] .= '&action=locate#m' .$this->lIl1lLl ));}$this->IlIlLLI =$this->offset; $this->options['use_special_list_view'] =false; $vData[I9598] =$vData[I9597] =$this->id; $vData[I9598] =$this->lIl1lLl ?$this->lIl1lLl :$this->id; $vData['noindex_external_links'] =$this->module->GetOption('noindex_external_links') ?'true' :I9593; $IIlL1Ll[I9649]['forum_subscription_management_url'] =$this->IlIlLLl .'?action=forum_watching'; $vData['script_quote_message'] =$this->cms->Gui->get($this->moduleName .'_list:script_quote_message', $vData); if (!empty($this->cms->Vars['go_last_page'])) {$this->browser->lll1IlL =true; }$sql ="SELECT `sm_data`, `details_noindex` FROM `cms_forum` WHERE id = " .$this->id; $lIl1LLI =$this->db->getRecord($sql); if ($lIl1LLI['sm_data']) {$IIl1IL1 =unserialize($lIl1LLI['sm_data']); $GLOBALS[I9655][I9656] =$this->cms->TITlTl1($GLOBALS[I9655][I9656], $IIl1IL1); }if($lIl1LLI['details_noindex']){ $this->TTTllT1(); }}else {$IIlL1Ll['page_item_type'] ='body_empty'; }break; case 'body_form': case I9657: $IIlL1Ll['page_item_type'] ='body_form'; $vData[I9572] =isset($vData['cat_id']) ?$vData['cat_id'] :null; $vData[I9658] =$IIlL1L1 == 'body_form'; $vData['entity'] =$vData[I9658] ?I9553 :I9601; if ($I1LllL1 || !$this->module->GetOption('add_' .$vData['entity'] .'s_by_registered_only')) {if (!$vData[I9658]) {$vData['re_topic'] =$this->words['re'] .': ' .$vData[I9553]; }$this->TTI1TT1($vData); if(AMI::getOption(I9628,'user_source_app')){ $vData['user_source_app_buttons'] =AMI::getSingleton('user_source_app')->getButtons(); }$vData['form'] =$this->cms->Gui->get($this->moduleName .'_list:form', $vData); }else {if (!$this->IlIlLLL) {$vData['register_link'] =$this->IlIlLLl; $vData[I9659] =rawurlencode($GLOBALS[I9630] .$GLOBALS['vGlobVars'][I9654] .(mb_strpos($GLOBALS['vGlobVars'][I9654], '?') === false ?'?' :I9660) .'display_form=1#forumForm'); $vData['form'] =$this->cms->Gui->get($this->moduleName .'_list:register_to_add_' .$vData['entity'], $vData); }}break; case I9661: $IIlL1Ll['page_item_type'] ='body_filtered'; $IIlL1Ll['list_set'] ='itemP_list'; $IIlL1Ll[I9662] ='itemP_row'; if ($this->lIl1llL <0) {$this->browser->InitSQL("0" ,"FROM `cms_forum`", "WHERE 0"); $IIlL1Ll[I9663] ='itemP_no_user'; break; }$this->TTTlIIT($this->offset, I9644, 'DESC', $this->lIl1lI1, false, 'page', 0); $this->browser->lllL11L =$this->lIl1llI; $aSQL =array ();if ($this->I1LII1I) {$select ='c.name cat_name, c.sublink cat_sublink, c.id cat_id, '; $where ='AND c.id = f.id_cat '; $joins =array (I9577 => 'f.id_cat = c.id'); $tables =array ('c' => 'cms_forum_cat'); }else {$select =$where =I9562; $joins =array ();$tables =array ();}$this->options['use_special_list_view'] =false; $this->browser->InitSQL( $select .I9664 .", DATE_FORMAT(`date`, '" .str_replace(':%s', I9562, $this->cms->DFMT[I9645]) ."') `fdate`", array (I9576 => array(I9575 => 'cms_forum') +$tables, I9614 => $joins, I9665 => array (I9577 => 'LEFT OUTER') ),"WHERE f.id_member = " .$this->id ." " .$where .$this->_ApplyFilters() .$this->TTTlIl1(), I9562, $this->browser->TI1TTlT(), 'f.date desc', $tables );$this->browser->AddSQLJoinedTables($this->cms->Core, I9575, $tables); $IIlL1Ll[I9640] =array (I9592, I9666, I9553, I9601); switch($this->IlIlLI1){ case 'nickname': $author =$this->lIl1ll1['nickname']; break; case 'username': $author =$this->lIl1ll1['username']; break; case I9667: $author =trim($this->lIl1ll1['firstname'] .' ' .$this->lIl1ll1['lastname']); }$IIlL1Ll[I9649][I9605] =$author; $IIlL1Ll[I9649][I9607] =$this->id; $this->TTIl11l($IIlL1Ll[I9649]); $IIlL1Ll[I9649]['offset_link'] =$this->cms->ActiveScript .'?action=view_posts&id=' .$this->id .'&offset=[START]'; $IIlL1Ll[I9649]['simple_prefix'] ='itemP_'; $IIlL1Ll[I9649]['splitter_prefix'] =I9668; $IIlL1Ll[I9649]['stub_prefix'] =I9668; $IIlL1Ll[I9663] ='itemP_list_empty'; $vData['noindex_external_links'] =$this->module->GetOption('noindex_external_links') ?I9669 :I9593; break; }parent::TTTll1T($vData, $IIlL1Ll); }$this->options['use_special_list_view'] =$useSpecialListView; }function _GetFrontTopicRowCB(&$aItem, &$aData) {foreach (array (I9605, I9612) as $k) {if (isset($aItem[$k])) {$this->TTI1TIl($aItem[$k]); }}$this->TTIl11l($aItem); if ($this->IlIlLLL) {$aItem[I9607] =$aItem['msg_id_member'] =0; }$offsetLink =str_replace('?', $aItem['nav_data'], preg_replace(I9670, I9562, $aData['offset_link'])); $aItem['tooltip'] =$this->cms->stripLine($aItem[I9601], $this->lIl1lll); $lIl1LLl =array ($this->browser->Position, $this->browser->PageSize, $this->browser->lllL11L, $this->browser->MaxCount, $this->browser->Icons); $this->module->PushPager($this->browser); $this->module->InitPager($this->browser, 0); $this->browser->PageSize =$this->lIl1lI1; $this->browser->lllL11L =$this->lIl1llI; $this->browser->MaxCount =$aItem[I9608] +1; $this->browser->Icons =$this->IlIlLlL; $this->browser->forceViewEndLink =true; $pager =$this->browser->GetPager(); if ($pagesCount =sizeof($pager)) {$aItem['pager'] =$this->cms->Gui->getAbs($this->moduleName .'_list:topic_messages_pager', array (I9671 => $this->browser->GetPagerHtml($pager, $offsetLink))); $this->browser->Icons['next'] =$this->browser->Icons['last'] ='[LINK]'; $pager =$pager[$pagesCount -1]; $aItem['last_page_link'] =preg_replace(I9672, I9562, $offsetLink) .'?offset=' .$pager['start']; }else {$aItem[I9671] =I9562; $aItem['last_page_link'] =$this->cms->Gui->get($this->moduleName .'_list:topic_item_link', $aItem); }$this->browser->forceViewEndLink =false; list ($this->browser->Position, $this->browser->PageSize, $this->browser->lllL11L, $this->browser->MaxCount, $this->browser->Icons) =$lIl1LLl; $this->module->PopPager($this->browser); $aItem[I9673] =$this->cms->Gui->get($this->moduleName .'_list:' .I9673 .($aItem[I9625] ?I9562 :'_empty'), $aItem); $aItem['locked_status'] =$this->cms->Gui->get($this->moduleName .'_list:' .($aItem[I9571] ?'topic_status_locked' :'topic_status_opened'), $aItem); }function _GetFrontTopicMessageRowCB(&$aItem, &$aData) {foreach (array (I9605, I9612) as $k) {if (isset($aItem[$k])) {$this->TTI1TIl($aItem[$k]); }}if($this->II11ll1 && $this->II11ll1 == $aItem[I9607] && ($aItem['abs_row_index'] +1) == $this->browser->MaxCount && empty($aItem[I9571])) {$aItem['front_edit'] =$this->cms->Gui->getAbs($this->moduleName .'_list:front_edit', array (I9598 => $aItem[I9598], I9674 => $aItem[I9571] ?I9562 :' | ', 'expire' => $aItem['unixtime'] +$this->IlIlLl1, I9607 => $aItem[I9607] ));}if ($this->IlIlLLL) {$aItem[I9607] =0; }elseif ($aItem[I9607]) {$this->TTI1Tll($aItem, $aData); }$aItem['author_js'] =str_replace(I9675, "\\\\\\\\", TlITI1l($aItem[I9605])); $aData['unlocked'] =$aItem['unlocked'] =!$aItem[I9571]; $aItem['counter'] =++$this->IlIlLLI; $aItem[I9676] .= '#m' .$this->IlIlLLI; if($aItem['source_app_id'] && AMI::getOption(I9628,'user_source_app')){ $I1Ll1LI =AMI::getSingleton('user_source_app'); $aItem['user_source_app_icon'] =$I1Ll1LI->getDriverIcon($I1Ll1LI->getDriverNameById($aItem['source_app_id']), array('user_id' => $aItem['source_app_user_id'])); }$I1LllL1 =AMI::getSingleton('env/session')->isLoggedIn(); if($I1LllL1 && !empty($aItem[I9607]) && $this->cms->Core->isInstalled(I9677) && $this->cms->Core->IsPresentInPMandPublic(I9677)){ $oPrivateMessagesView =AMI::getSingleton('private_messages/service/view'); $aItem['send_private_message_link'] =$oPrivateMessagesView->getUserSendMessageLink($aItem[I9607], $this->cms->lang); }if (!empty($aItem['custom_data'])) {$aItem += unserialize($aItem['custom_data']); }$aEvent =array(I9678 => $aItem); AMI_Event::fire('ON_AMI_FORUM_ITEM_ROW', $aEvent, 'forum'); $aItem =$aEvent[I9678]; }function TII1TI1(&$aData) {if(!$this->lIl1lLl){ $useSpecialListView =$this->options['use_special_list_view']; $this->options['use_special_list_view'] =false; $sql ="SELECT COUNT(1) FROM `cms_forum` f WHERE `id_thread` = `id`" .$this->_ApplyFilters(); $aData['total_topics_qty'] =$this->db->getValue($sql); $sql ="SELECT COUNT(1) FROM `cms_forum` f WHERE 1" .$this->_ApplyFilters(); $aData['total_messages_qty'] =$this->db->getValue($sql); $this->side =I9548; $sql ="SELECT COUNT(1) FROM `cms_members` f WHERE `active` = 1" .$this->_ApplyFilters(); $aData[I9679] =$this->db->getValue($sql); switch($this->IlIlLI1){ case 'nickname': $IlIl11L ='nickname'; break; case 'username': $IlIl11L ='username'; break; case I9667: $IlIl11L ="CONCAT(firstname, ' ', lastname)"; }$sql ="SELECT *, id `id_member`, " .$IlIl11L ." `author` FROM `cms_members` f WHERE `active` = 1" .$this->_ApplyFilters() ." ORDER BY `date` DESC LIMIT 1"; $aUser =$this->db->getRecord($sql); $this->TTI1TIl($aUser[I9605]); $this->side ='front'; $aData['last_registered_user'] =$this->cms->Gui->get($this->moduleName .'_list:last_registered_user', $aUser); $this->options['use_special_list_view'] =$useSpecialListView; }}function TTTlIT1(&$aCustom, $cType ="small", $IIlLI11 ="", $IIlLlII =I9680) {$this->IlIllI1->TTTlITl($aCustom, $cType, $IIlLI11, $IIlLlII, true); $html =parent::TTTlIT1($aCustom, $cType, $IIlLI11, $IIlLlII); $this->IlIllI1->TTTlITl($aCustom, $cType, $IIlLI11, $IIlLlII, false); return $html; }function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {$this->cms->SetsTemplate =$this->moduleName .'_list'; $aDefault =array (I9640 => array (I9592, 'ftime', I9612, I9608) );$aCustom += $aDefault; $aSQL =array ();$this->IlIllI1->TTIT1lT('small_list', $aSQL); $this->lIl1lLI =$this->module->GetOption('small_display_message'); if ($this->lIl1lLI) {$aSQL[I9681] .= ', f1.message, f.msg_id'; $aSQL[I9576]['f1'] ='cms_forum'; $aSQL['join'] .= ' INNER JOIN cms_forum f1 ON f.msg_id = f1.id'; }$this->browser->InitSQL( "f.id, f.topic, f.msg_answers, f.msg_author, f.msg_id_member, f.sublink, date_format(f.msg_date,'".$this->cms->DFMT['db']."') as fdate, date_format(f.msg_date,'".$this->cms->DFMT['db_time']."') as ftime, f.id as adv_counter_id " .$aSQL[I9681], "FROM " .$this->module->GetTableName() ." f" .$aSQL['join'], "WHERE f.id = f.id_thread " .$this->_ApplyFilters(I9562, I9682, false) .$aSQL['where'], I9562, 'f.msg_date' );$this->browser->SetForceRules('ORDER BY f.msg_date ' .$this->module->GetOption('page_sort_dim_small'), I9683 .$this->module->GetOption('page_size_small')); $this->browser->AddSQLJoinedTables($this->cms->Core, I9575, $aSQL[I9576]); $aCustom[I9651][I9553] =array (I9590 => I9587, I9642 => &$this, 'method' => '_GetSmallDetailsCB'); if ($this->TTT11ll()) {$aCustom[I9651]['adv_counter_id'] =array (I9590 => I9587, I9642 => &$this, I9684 => '_GetSmallAdvCounter'); }parent::TTTll1I($vRes, $aCustom, $cType, $IIlLlII); }function _GetSmallDetailsCB(&$aItem, &$aData) {foreach (array (I9605, I9612) as $k) {if (isset($aItem[$k])) {$this->TTI1TIl($aItem[$k]); }}$this->TTIl11l($aItem); if ($this->IlIlLLL) {$aItem[I9607] =$aItem['msg_id_member'] =0; }$aItem['front_link'] =$aData['front_link']; $aItem[I9553] =$this->cms->stripLine(strip_tags($aItem[I9553]), $this->module->GetOption(I9685)); $aItem[I9553] =$this->cms->TTITI1l('small', I9553, $aItem); $aItem['display_message'] =$this->lIl1lLI; if ($this->lIl1lLI) {$aItem[I9601] =$this->cms->stripLine(strip_tags($aItem[I9601]), $this->module->GetOption('small_message_length')); $aItem[I9601] =$this->cms->TTITI1l('small', I9601, $aItem); }else {$aItem[I9601] =I9562; }}function TTT11IT($IILILIL) {$navData =parent::TTT11IT($IILILIL); $navData += $this->IlIllI1->TTT11IT($IILILIL); return $navData; }function TII1TlT() {if (($threadId =intval($this->cms->Vars[I9597])) >0) {$sql ="SELECT 1 FROM `cms_forum` f WHERE `id` = " .$threadId .$this->_ApplyFilters(); if ($this->db->getValue($sql)) {$this->cms->Vars['subaction'] == 'watch' ?$this->TII1TlI($threadId) :$this->TII1Tll($threadId); }}$this->TTI1TlT(); }function TTT1ITI($cId, $cModule) {$langFile =$this->cms->Gui->ParseLangFile('templates/lang/_forum_msgs.lng'); $this->cms->AddMessages($langFile); $this->threadId =empty($this->cms->VarsPost[I9597]) ?0 :intval($this->cms->VarsPost[I9597]); $entity =$this->threadId ?I9601 :I9553; if (!($this->II11ll1 || !$this->module->GetOption('add_' .$entity .'s_by_registered_only'))) {unset($this->cms->VarsGet['status_msg']); if($entity == 'messages'){ $entity .= 's'; }$this->cms->AddStatusMsg('status_not_allowed_to_add_' .$entity, I9686); return; }if (empty($this->cms->VarsPost[I9553]) || empty($this->cms->VarsPost[I9601]) || ($this->I1LII1I ?empty($this->cms->VarsPost['cat_id']) :false) || ($this->II11ll1 ?false :empty($this->cms->VarsPost[I9605])) ){unset($this->cms->VarsGet['status_msg']); $this->cms->AddStatusMsg('status_error', I9686); return; }require_once $GLOBALS['FUNC_INCLUDES_PATH'] .I9596; $message =TlTllIl( $this->cms->htmlchars(removeSpecial(trim($this->cms->VarsPost[I9601]), I9604)), true, $this->module->GetOption('noindex_external_links'), $this->IlIlLlI );if(!$this->TTI1TlI($message, true)){ $this->cms->Gui->AddGlobalVars( array( 'posted_topic' => $entity == I9553 ?removeSpecial(trim($this->cms->VarsPost[I9553]), I9604) :I9562, 'posted_bb_code' => AMI_Lib_String::jParse(removeSpecial(trim($this->cms->VarsPost[I9601]), I9604)) ));return; }$sql ="SELECT `locked` FROM `cms_forum` WHERE `id` = " .$this->threadId; if ($this->db->getValue($sql)) {unset($this->cms->VarsGet['status_msg']); $this->cms->AddStatusMsg(I9687, I9686); return; }if ($this->I1LII1I) {$categoryId =intval($this->cms->VarsPost['cat_id']); $sql ="SELECT 1 FROM cms_forum_cat c WHERE id = " .$categoryId .$this->_ApplyCatFilters('c', I9638, false); if (!$this->db->getValue($sql)) {unset($this->cms->VarsGet['status_msg']); $this->cms->AddStatusMsg(I9687, I9686); return; }}else {$categoryId =0; }$this->_public =$this->cms->VarsPost[I9688] =1; if ($this->II11ll1) {$this->cms->VarsPost[I9605] =$this->TTI1TII(); }$this->cms->VarsPost[I9607] =$this->II11ll1; $this->cms->VarsPost[I9572] =$categoryId; $this->cms->VarsPost[I9571] =0; $this->cms->Vars['skip_cats'] =true; $action =$this->action; $this->action ='add'; $ILLLILI =$this->cms->Gui->debug; $this->cms->Gui->debug =array ();$this->cms->PushFrontSettings($this->db, $this->langData); require_once $GLOBALS['CLASSES_PATH'] .'Admin.php'; $adm =new Admin($this->cms->Core); $adm->constructorPostActions(); $adm->InitFromObject($this->cms, $this->module); $cms =clone($this->cms); $this->cms =&$adm; $this->cms->Messages =$cms->Messages; $publish =$this->module->GetOption($this->II11ll1 ?'publish_from_athorized' :'publish_from_not_athorized'); $lIl1LLL =$publish ?I9562 :'_not_published'; $this->cms->Messages['status_add'] =$cms->Messages[$this->threadId ?'status_message_is_added' .$lIl1LLL :'status_topic_is_added' .$lIl1LLL]; $this->cms->SuppressStatusErrors =true; $this->realSide ='front'; $this->_InitAdmin(); if (empty($this->cms->VarsPost['id_update'])) {$this->cms->VarsPost[I9688] =$publish; $this->TTTll11(0, $cModule); if(!$publish){ $this->appliedId =0; }}else {$IlIIII1 =false; if ($this->II11ll1) {$IlIIIll =intval($this->cms->VarsPost['id_update']); $sql ="SELECT `id_member`, `id_thread` " ."FROM `cms_forum` f " ."WHERE id = " .$IlIIIll .$this->_ApplyFilters(); if (($row =$this->db->getRecord($sql)) && $this->II11ll1 == $row[I9607]) {$sql ="SELECT MAX(`id`) " ."FROM `cms_forum` f " ."WHERE `id_thread` = " .$row[I9597] .$this->_ApplyFilters(); if($this->db->getValue($sql) == $IlIIIll){ $this->action =I9689; $this->cms->VarsPost[I9598] =$IlIIIll; $this->cms->Messages['status_apply'] =$cms->Messages['status_message_is_updated']; $this->TTTl1lI($IlIIIll, $cModule); if(isset($this->ext['ext_reindex'])){ $IIlLIIL =array (I9590 => 'post_process_front', I9598 => $IlIIIll, I9690 => array ('ext_action' => $this->action)); $this->ext['ext_reindex']->TTT1lI1($IIlLIIL); }}else{ $IlIIII1 =true; }$this->appliedId =$IlIIIll; }else {$IlIIII1 =true; }}else {$IlIIII1 =true; }}if(!empty($IlIIII1)){ $adm->AddStatusMsg('status_updated_fail', I9686); }$I1LlLII =$adm->SysStatusMsgs; $I1LlLIl =$adm->StatusMsgs; $this->cms =&$cms; $this->cms->PopFrontSettings($this->db, $this->langData); if (!empty($this->cms->VarsPost['topic_watch']) && $this->II11ll1) {$this->TII1TlI($this->appliedId); }$this->forceRedirect =true; $this->cms->VarsGet =array (I9691 => serialize(array ('sys' => $I1LlLII, 'plain' => $I1LlLIl))); $this->cms->ActiveScript =preg_replace('/\?.*$/u', I9562, $GLOBALS['vGlobVars'][I9654]); if ($this->appliedId) {if($this->threadId){ if($publish){ $this->cms->ActiveScript .= '?action=locate&id_message=' .$this->appliedId; }elseif($this->module->GetOption('messages_dim') == 'asc'){ $this->cms->ActiveScript .= '?go_last_page=1'; }}elseif(empty($this->cms->VarsPost['id_update'])){ $sql ="SELECT `sublink` FROM `cms_forum` WHERE `id` = " .$this->appliedId; $sublink =$this->db->getValue($sql); if (mb_strlen($sublink)) {$sublink ='/' .$sublink .'?'; if (mb_strpos($this->cms->ActiveScript, '?') === false) {$this->cms->ActiveScript .= $sublink; }else {$this->cms->ActiveScript =str_replace('?', $sublink, $this->cms->ActiveScript); }}}$this->IIlll1L =I9692 .$this->appliedId .($this->threadId && $publish ?'#mdF' .$this->appliedId :I9562); }$this->cms->Gui->debug =$ILLLILI; }function TII1TlI($threadId) {if(AMI::getOption(I9628,'user_source_app')){ $aUserInfo =$this->cms->Member->getUserInfo(); if(!AMI::getSingleton('user_source_app')->checkValidMail($aUserInfo['email'])){ return false; }}$aSQL =array (I9607 => $this->II11ll1, I9597 => $threadId); $sql =$this->db->genInsertSQL('cms_forum_subscribers', $aSQL); $this->db->execute($sql, DBC_NO_HALT); $this->cms->addStatusMsg('status_subscribed'); }function TII1Tll($threadId) {$sql ="DELETE FROM `cms_forum_subscribers` WHERE `id_member` = " .$this->II11ll1 ." AND `id_thread` = " .$threadId; $this->db->execute($sql); $this->cms->addStatusMsg('status_unsubscribed'); }function TIIT1TT() {$ILLLlIl =$this->module->GetOption(I9693); $senderEmail =$this->TTI1TTl(); if (empty($ILLLlIl) || empty($senderEmail) || !$this->module->GetOption($this->threadId ?'notify_admin_about_new_message' :'notify_admin_about_new_topic')) {return false; }if ($this->threadId) {$sql ="SELECT `topic` FROM `cms_forum` WHERE `id` = " .$this->threadId; $topic =$this->db->getValue($sql); }else {$topic =$this->cms->VarsPost[I9553]; if($this->I1LII1I && $this->module->GetFrontLink() == $this->cms->Gui->globalVars[I9631]){ $navData =$this->IlIllI1->TTT11IT(I9562); $this->cms->Gui->globalVars[I9631] .= '/' .$navData[I9694]; }$sql ="SELECT `sublink` FROM `cms_forum` WHERE `id` = " .$this->appliedId; $this->cms->Gui->globalVars[I9631] .= '/' .$this->db->getValue($sql); }$topic =removeSpecial($this->cms->VarsPost[I9553]); $mailData =array (I9605 => removeSpecial($this->cms->VarsPost[I9605]), 'members_link' => $this->IlIlLLl, I9607 => $this->IlIlLLL ?0 :(empty($this->cms->VarsPost[I9607]) ?0 :intval($this->cms->VarsPost[I9607])), 'title' => $topic, I9695 => mb_substr($topic, 0, 45), 'body' => removeSpecial($this->cms->VarsPost[I9601]), 'link' => $GLOBALS[I9630] .$this->module->GetFrontLink(), I9597 => $this->threadId, I9553 => removeSpecial($topic), 'target' => I9553, 'site_path' => preg_replace(array (I9696, '/\/.*$/'), I9562, $GLOBALS[I9630]) );if ($this->threadId) {$mailData[I9598] =$this->appliedId; }$this->cms->Gui->addBlock('_forum_email', '_local/_admin/templates/letters/forum_mail.tpl'); require_once $GLOBALS['CLASSES_PATH'] .I9697; $oMail =new Mailer(); $oMail->SenderAddress =$senderEmail; $oMail->Subject =$this->cms->Gui->get('_forum_email:subject_' .($this->threadId ?I9601 :I9553), $mailData); $oMail->Body =trim($this->cms->Gui->get('_forum_email', $mailData)); $oMail->CopyAddress =I9562; $oMail->BodyFormat ='plain'; $oMail->Prepare(); $oMail->RecipientAddress =$ILLLlIl; $oMail->Send(); return true; }function TII1Tl1($cId) {$this->TTTllT1(); require_once $GLOBALS['CLASSES_PATH'] .I9698; $member =CMS_Member::getInfo($this->db, intval($cId), I9598); if (sizeof($member) >0) {$this->lIl1llL =$cId; $this->lIl1ll1 =$member; }else {$this->lIl1llL =-1; }}function ProcessTopicsSubscribers(&$process) {$limit =100; $db =&$process->db; $sql ="LOCK TABLES `cms_forum_queue` WRITE"; $db->execute($sql); $sql ="SELECT * FROM `cms_forum_queue` WHERE `status` = 'queued' LIMIT " .$limit; $rs =&$db->select($sql); $lIl1LL1 =false; if (($rowsCount =$rs->numRows()) >0) {$this->TTI1TI1(); $rs->setAttr('auto_free', false); $ids =array ();while ($row =$rs->nextRecord()) {$ids[] =$row[I9598]; }$lIl1L1I =implode(I9621, $ids); $sql =$db->genUpdateSQL('cms_forum_queue', array (I9699 => 'sending'), "WHERE id IN (" .$lIl1L1I .I9622); $db->execute($sql); $sql ="UNLOCK TABLES"; $db->execute($sql); $rs->seek(); $rs->setAttr('auto_free', true); $IlI11II =0; $ids =array ();require_once $GLOBALS[I9700] .I9697; while ($row =$rs->nextRecord()) {$this->TTI1TI1(); foreach (explode(';', $row['recipients']) as $recipient) {$oMail =new Mailer(); list ($oMail->RecipientName, $oMail->RecipientAddress) =explode(' <', $recipient); $oMail->RecipientAddress =mb_substr($oMail->RecipientAddress, 0, -1); $oMail->Body =str_replace('++recipient_username++', $oMail->RecipientName, $row[I9701]); $oMail->Prepare(); $oMail->_Headers =unserialize($row[I9656]); $oMail->Subject =$row['subject']; $this->_MailPrepared =true; $oMail->Send(); $IlI11II++; }$ids[] =$row[I9598]; if ($IlI11II >= $limit) {break; }}$sql ="DELETE FROM `cms_forum_queue` WHERE id IN (" .implode(I9621, $ids) .I9622; $db->execute($sql); if ($rowsCount != sizeof($ids)) {$sql =$db->genUpdateSQL('cms_forum_queue', array (I9699 => 'qouted'), I9702 .$lIl1L1I .I9622); $db->execute($sql); }}else {$sql ="UNLOCK TABLES"; $db->execute($sql); $lIl1LL1 =true; }if ($lIl1LL1) {$process->unregisterHandler(I9703); }}function TTT1TTI(&$IIl1ll1, $prefix) {if ($this->I1LII1I) {$IIl1ll1[I9681] .= ", id_cat"; }}function TTT1TTl(&$record) {if ($this->I1LII1I) {$this->IlIllI1->catId =$record[I9572]; }}public function cbRSSItem(&$aItem){ if(preg_match('/#m(\d+)$/', $aItem['rss_tpl_item_link'])){ $aItem[I9704] =preg_replace(array(I9672, '/#.*$/'), I9562, $aItem[I9704]) .'?action=locate&amp;id_message=' .$aItem[I9598] .'#m' .$aItem[I9598]; }}private function TII1T1T($id, $lIl1L1l =false){ $sql ="SELECT `public`, `id_thread` FROM `cms_forum` WHERE `id` = " .(int)$id; list ($public, $threadId) =$this->db->getRecord($sql, 0, MYSQL_NUM); $this->IlIlLIl =$public; if($lIl1L1l){ $this->threadId =$threadId; }}}class CategoriesFunctionsForum extends CMS_CategoriesFunctions {public $I1LI1Ll =false; public $lIl1L1L; function CategoriesFunctionsForum(&$cms, &$oModule, $IILL11I) {$this->lIl1L1L =&$oModule; parent::CMS_CategoriesFunctions($cms, $oModule, $IILL11I); $this->I1LI1Ll =$this->cms->Core->GetModOption(I9705, 'show_counters'); }function TII1T1I($threadId) {$sql ="SELECT `msg_id`, " .$threadId ." `msg_id_thread`, `topic` `msg_topic`, `msg_id_member`, `msg_author`, `msg_date`, `sublink` `msg_sublink`, `msg_answers` " ."FROM `cms_forum` WHERE `id` = " .$threadId; if ($aSQL =$this->module->db->getRecord($sql)) {if ($threadId == $aSQL[I9625]) {$aSQL[I9706] ='=|num_public_topics + 1'; }$aSQL[I9624] =addslashes($aSQL[I9624]); $aSQL[I9612] =addslashes($aSQL[I9612]); $sql =$this->module->db->genUpdateSQL('cms_forum_cat', $aSQL, I9613 .$this->catId); $this->module->db->execute($sql); }}function _GetCategoryCB(&$aItem, &$aData) {if (isset($aItem[I9612])) {$this->lIl1L1L->TTI1TIl($aItem[I9612]); }if ($this->module->IlIlLLL) {$aItem['msg_id_member'] =0; }if ($this->I1LI1Ll) {$aItem['cat_counter'] =$this->cms->TTITI1l(I9707, 'counter', $aItem); }if (!$aItem['is_separator']) {$aItem['name_links'] =$this->cms->TTITI1l(I9707, 'lname_links', $aItem); $this->module->TTIl11l($aItem); if ($aItem[I9624]) {$aRecord =$aItem; $aRecord[I9624] =$this->cms->stripLine($aRecord[I9624], $this->IILI1LI->GetOption(I9708), true); $aRecord[I9598] =$aItem[I9625]; $aRecord[I9609] =$aRecord['msg_sublink']; unset($aRecord[I9676]); $aTmp =array ('active_item_type' => 'body_items', I9598 => $aItem[I9625], I9609 => $aItem['msg_sublink'], I9709 => $aItem[I9598], I9652 => $aItem[I9609] );$this->module->_GetNavDataCB($aRecord, $aTmp); $lIl1LLl =array ($this->module->browser->Position, $this->module->browser->PageSize, $this->module->browser->lllL11L, $this->module->browser->MaxCount, $this->module->browser->Icons); $this->module->module->PushPager($this->module->browser); $this->module->module->InitPager($this->module->browser, 0); $this->module->browser->PageSize =$this->module->lIl1lI1; $this->module->browser->lllL11L =$this->module->lIl1llI; $this->module->browser->MaxCount =$aItem[I9608] +1; $this->module->browser->Icons =$this->module->IlIlLlL; $this->module->browser->forceViewEndLink =true; $pager =$this->module->browser->GetPager(); if ($pagesCount =sizeof($pager)) {$pager =$pager[$pagesCount -1]; $aRecord['pager_link'] ='offset=' .$pager['start']; }else {$aRecord['pager_link'] =I9562; }$this->module->browser->forceViewEndLink =false; list ($this->module->browser->Position, $this->module->browser->PageSize, $this->module->browser->lllL11L, $this->module->browser->MaxCount, $this->module->browser->Icons) =$lIl1LLl; $this->module->module->PopPager($this->module->browser); $aItem[I9710] =$this->cms->Gui->get($this->moduleName .'_list:' .I9710, $aRecord); }else {$aItem[I9710] =$this->cms->Gui->get($this->moduleName .'_list:' .'last_message_empty', $aItem); }}$tmp =$aItem['_num_items']; $aItem[I9711] =1 -$aItem['is_separator']; parent::_GetCategoryCB($aItem, $aData); $aItem[I9711] =$tmp; }function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); return $this->catId == $this->IILLLLl ?null :$this->IILLLLl; }}