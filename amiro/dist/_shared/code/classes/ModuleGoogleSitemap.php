<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       39399 xkqwmgrykyknqkmswinrqqwlkzlgwwkyzpixuxwimypkikxknpqsqgzykigyzrkxsgugpnir
 */ ?><?php foreach(array(9730=>"ZrtMWJQD",9731=>"vHtQD",9732=>"LHYD",9733=>'ihsUjq|gmwTURqd|gzTo',9734=>'mm1J111',9735=>"\n",9736=>'ZJJHC|IuJtM|JZnP',9737=>"MnDtZJJQS|JZnPD",9738=>"SQfZuJt|SZtZ|JZnP",9739=>'fuJJtQxt',9740=>"uDQ|HGtMHnD|fHrI",9741=>"DQnS|DMtQIZG",9742=>"DQZrWO|nHt|MnDtZJJQS",9743=>"1",9744=>"DMtQIZG|MnSQx|fMJQ",9745=>"SMDZYJQS",9746=>"JZDt|PQn|DMtQIZG",9747=>"DMtQIZG|JMnK",9748=>"YMP|vZJuQ",9749=>'nuI|fZMJQS',9750=>"JZDt|DQnS|DMtQIZG",9751=>"DMtQIZG|IHSuJQD",9752=>'wjzddqd|gzTo',9753=>"PQn|DMtQIZG",9754=>"dqjqwT?JMnK!?IHSuJQ|nZIQ!?UNmX|TmiqdTzig}SZtQ|IHSMfMQS{?zd?JZDt|IHSMfMQS|tD?FRhi?WID|DMtQ|DQZrWO?coqRq?ZWtMvQ?=?'1'?ZnS?GuYJMW]WZt|GuYJMW?ZnS?nHMnSQx=0?",9755=>"?hRsqR?yb?IHSuJQ|nZIQ",9756=>"IHSuJQ|nZIQ",9757=>'|',9758=>"`xIJ",9759=>"`PA",9760=>"MnSQx|DI",9761=>"%",9762=>"#~JHW@\n",9763=>'PHHPJQ|DMtQIZG',9764=>"PHHPJQ|DMtQIZG",9765=>"",9766=>'OttG|WHSQ',9767=>"DMtQIZG|DQnt",9768=>'MnDtZJJQS|JZnPD',9769=>"DMtQIZG|WHIGrQDD",9770=>"?zNs?IHSuJQ|nZIQ?jmkq?'",9771=>"?jmimT?",9772=>":01`1f",9773=>'hRsqR?yb?IHSuJQ|nZIQ!?SZtQ|IHSMfMQS?sqdw',9774=>"dqjqwT?JMnK!?IHSuJQ|nZIQ!?nHMnSQx!?uDQ|OrQfJZnP!?SZtQ|IHSMfMQS!?JZnP!?UNmX|TmiqdTzig}SZtQ|IHSMfMQS{?zd?JZDt|IHSMfMQS|tD?FRhi?WID|DMtQ|DQZrWO?coqRq?ZWtMvQ?=?'1'?ZnS?GuYJMW]WZt|GuYJMW?",9775=>"JMnK",9776=>'',9777=>"JZDt|IHSMfMQS|tD",9778=>'?',9779=>'RhhT|gzTo|ccc',9780=>'~',9781=>'????????OrQfJZnP="',9782=>"????#WOZnPQfrQE@",9783=>'urJD',9784=>"grZPIZ%?GuYJMW",9785=>"\"",9786=>"CY9",9787=>"nQCD",9788=>"YJHP",9789=>"DMtQIZG|WOZnPQfrQE",9790=>'DMtQIZG|IHSuJQD',9791=>"nQvQr",9792=>"IHntOJB",9793=>"?szb",9794=>'SZtQ',9795=>'DMtQIZG|fMJQ',9796=>"ZWt|DQnS|DMtQIZG",9797=>'uDQr',9798=>"ZWt|HutGut|DMtQIZG",9799=>"PQtZJJvZJuQD",9800=>"wHrQ",9801=>"ZGGJB",9802=>"dqjqwT?MS?FRhi?WID|GZPQD?coqRq?IHSuJQ|nZIQ?=?'GZPQ|404'?hR?IHSuJQ|nZIQ?=?'GrMnt|vQrDMHn'",9803=>"'?") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleGoogleSitemap extends CMS_ActModule {public $IlIlL1I; public $lIl11IL; public $lIl11I1; public $lIl11lI; public $lIl11ll; public $lIl11lL; public $lIl11l1; public $lIl11LI; public $lIl11Ll; public $lIl11LL; public $lIl11L1; public $lIl111I; public $lIl111l; private $IlILILI =false; private static $lIl111L =array("news", "blog", I9730, "photoalbum", "faq", "classifieds", "feedback", I9731, "files", "discussion", "forum", "guestbook", I9732, "eshop", "portfolio", "kb", "pages"); function ModuleGoogleSitemap(&$cms, &$db, &$cModule) {$this->IlIlL1I =false; $this->lIl11IL =0; $this->lIl11I1 =0; $this->lIl11lI =$GLOBALS[I9733]; $this->lIl11ll =$GLOBALS[I9734]; $this->lIl11lL =20000; $this->lIl11l1 ='<?xml version="1.0" encoding="UTF-8"?>'."\n". '<urlset'."\n". '  xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"'."\n". '  xmlns:xhtml="http://www.w3.org/1999/xhtml"'."\n". '  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'.I9735. '  xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9'.I9735. '                      http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd">'.I9735; $this->lIl11LI ='<?xml version="1.0" encoding="UTF-8"?>'.I9735. '<sitemapindex'.I9735. '  xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"'.I9735. '  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'.I9735. '  xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9'.I9735. '                      http://www.sitemaps.org/schemas/sitemap/0.9/siteindex.xsd">'.I9735; $this->lIl11Ll ="http://www.google.com/webmasters/tools/ping?sitemap="; if($cms->Core->GetOption(I9736)){ $this->lIl11L1 =" AND lang IN ('".implode("','", $cms->Core->GetAOption(I9737))."') "; }else{ $this->lIl11L1 =" AND lang = '".$cms->Core->GetOption(I9738)."' "; }$this->lIl11LL =0; $this->lIl111I =0; $this->lIl111l =time(); parent::CMS_ActModule($cms, $db, $cModule); if( $this->cms->Core->IsInstalled('reindex') && $this->cms->Core->GetModOption('reindex', 'mode') == I9739 ){$this->IlILILI =true; }$this->TII1ITI(); }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {$IIIIL11["group_operations"] =Array(); $IIIIL11["use_id_page"] =false; $IIIIL11[I9740] =true; $IIIIL11["multi_sites"] =false; $IIIIL11["use_positions"] =false; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin() {parent::_InitAdmin(); }function TTTlITT($IIIL11l, $cId, $cModule ="") {switch ($IIIL11l) {case "gen_sitemap": $this->TII1T11($cId, $cModule); break; case I9741: $this->TII1ITT($cId, $cModule); break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function GetHtml(&$aCustom) {return parent::GetHtml($aCustom); }function &TTTlI1T(&$aCustom) {return parent::TTTlI1T($aCustom); }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {$this->options['admin_views'] =array('form'); $vData += $this->itemData; $vData[I9742] =""; if (!$this->cms->Core->IsInstalled('srv_tags_reindex')) {$vData[I9742] =I9743; parent::TTTlI11($vData, $aCustom); return; }$vData["last_gen_sitemap"] =""; $vData["sitemap_link"] =""; $vData[I9744] =""; $vData["last_send_sitemap"] =""; $vData["send_sitemap_status"] =I9745; $vData["sitemaps_is_turned_off"] =""; $aTmp =array(); if ($this->cms->Core->ReadOption($aTmp, "google_sitemap", "gen_sitemap")) {$vData[I9746] =date($this->cms->DFMT["php_dtime"], $aTmp['value']); $IlILI11 =unserialize($aTmp["big_value"]); if (isset($IlILI11["index_sm"])) {$vData[I9747] =$this->lIl11ll.$IlILI11["index_sm"][0]; $vData[I9744] =$IlILI11["index_sm"][0]; $lIl1111 =array(); if ($this->cms->Core->ReadOption($lIl1111, "google_sitemap", I9741)) {$IlILL11 =$lIl1111["value"]; $IlIL1lI =unserialize($lIl1111[I9748]); if (!isset($IlIL1lI['num_failed'])) {$IlIL1lI['num_failed'] =0; }$vData["last_send_sitemap"] =date($this->cms->DFMT["php_dtime"], $IlILL11); $vData["send_sitemap_status"] =""; if (($IlILL11 +60*60) >time()) {$vData["send_sitemap_status"] =I9745; }elseif (($IlIL1lI['num_failed'] >= 3) && ($IlILL11 +24*60*60 >time())) {$vData["send_sitemap_status"] =I9745; }if ($IlIL1lI[I9749]) {$vData["last_send_status"] ="failed"; }else {$vData["last_send_status"] ="ok"; }}else {$vData[I9750] =""; $vData["send_sitemap_status"] =""; }}}if ($this->module->GetOption("sitemaps_disabled")) {$vData["send_sitemap_status"] =I9745; $vData["gen_sitemap_status"] =I9745; $vData["sitemaps_is_turned_off"] =I9743; }parent::TTTlI11($vData, $aCustom); }function TII1T11($cId, $cModule) {$this->II1lLL1 =TlT1I11(); $this->lIl11IL =0; $this->fn->TII1lT1(true); if (!$this->IlIlL1I) {while(@ob_end_clean()); $vData['metas'] =$this->cms->Gui->getMetas(); $vData['progress_id'] =$this->II1lLL1; $html =$this->cms->Gui->get($this->moduleName."_subform:progress_popup_header", $vData); print $html; flush(); }$supportedModules =$this->TII1I1l(I9751); if (sizeof($supportedModules) >0) {$this->lIl11IL =sizeof($supportedModules) +3; $this->lIl11I1 =0; }$this->TII1ITl(); $this->TII1Ill(100); if ($this->IlIlL1I) {print "OK"; ob_flush(); }else {$html =$this->cms->Gui->get($this->moduleName."_subform:progress_popup_footer", $vData); print $html; flush(); }$GLOBALS["conn"]->TT1I1lT(); exit; }function TII1ITT($cId, $cModule) {$lILIIII =$this->TII1IT1(); $this->cms->AddStatusMsg($lILIIII, "blue"); }function TII1ITI() {require_once $GLOBALS[I9752] .'CMS_BackgroundProcess.php'; $process =new CMS_BackgroundProcess(); $process->registerHandler('CMS_GoogleSitemap::processGoogleSitemap', ''); }function TII1ITl() {$IlILlll =$this->TII1lTl(); $this->TII1Ill(); $this->cms->Core->ReadOption($lILIIIl, "google_sitemap", I9753); $lILIIIL =$this->module->GetOption("sitemap_compress"); $supportedModules =$this->TII1I1l(I9751); $IlILI1L =$lILIIIl["value"]; if (!$IlILI1L) {$IlILI1L =0; }$IlILI11 =unserialize($lILIIIl[I9748]); $IlILll1 =""; $IlILlLI =array(); $IlILlLl =0; $IlILlLL =0; $IlILlL1 =0; $IlILl1I =array(); $IlILl1l =0; $sql =I9754.$this->lIl11L1.$this->TTI1ITT().I9755; $this->TTI1T1I($sql); $rs =&$this->db->select($sql); $this->TII1Ill(); $curModule =""; while ($IlILLII =$rs->nextRecord()) {set_time_limit(29); $this->TII1Il1(); $IlILLIl =$IlILLII[I9756]; if (array_key_exists($IlILLIl, $supportedModules)) {$curModule =$IlILLIl; }else {$IlILLIl =mb_substr($IlILLIl, 0, mb_strpos($IlILLIl, I9757)); if (array_key_exists($IlILLIl, $supportedModules)) {$curModule =$IlILLIl; }else {$curModule =""; }}if (!$curModule || (isset($supportedModules[$curModule]) && intval($supportedModules[$curModule]) == 0)) {continue; }if (($IlILlLL >= $this->lIl11lL) && ($curModule == $IlILll1)) {$IlILlLL =0; $IlILLIL += 1; $IlILLI1 ="sitemap_".$IlILll1."_".sprintf("%03d", $IlILLIL).I9758; if ($lILIIIL) $IlILLI1 .= ".gz"; $IlILlLI[$curModule][] =$IlILLI1; }if ($curModule != $IlILll1) {$this->TII1Ill(); $IlILlLL =0; $IlILLIL =1; $IlILlL1 =0; $IlILll1 =$curModule; $IlILLI1 ="sitemap_".$IlILll1."_".sprintf("%03d", $IlILLIL).I9758; if ($lILIIIL) $IlILLI1 .= I9759; $IlILlLI[$curModule][] =$IlILLI1; }if ($IlILLII["last_modified_ts"] >= $IlILlL1) {$IlILl1I[$IlILll1] =$IlILLII["last_modified_ts"]; $IlILlL1 =$IlILLII["last_modified_ts"]; }$IlILlLL += 1; }if (isset($IlILI11["index_sm"]) && mb_substr($IlILI11[I9760][0], 0, 8) == "sitemap_") {@unlink($this->lIl11lI.$IlILI11[I9760][0]); }$IlILLlI ="sitemap_index.xml"; $IlILLll =$this->TII1II1($IlILLlI, $lILIIIL); $this->TII1IlT($IlILLll, $this->lIl11LI, $lILIIIL); foreach ($IlILlLI as $module => $IlILLlL) {set_time_limit(29); $this->TII1Il1(); foreach ($IlILLlL as $IlILLl1) {$IlILLLI =$IlILl1I[$module]; if (!$IlILLLI) $IlILLLI =time(); $IlILLLl =date("Y-m-d\TH:i:s",$IlILLLI).mb_substr(date("O",$IlILLLI),0,3).I9761.mb_substr(date("O",$IlILLLI),3,2); $IlILLLL ='  <sitemap>'.I9735; $IlILLLL .= "    <loc>".$GLOBALS['ROOT_PATH_WWW'].$IlILLl1.I9762; $IlILLLL .= "    <lastmod>".$IlILLLl."</lastmod>\n"; $IlILLLL .= '  </sitemap>'.I9735; $this->TII1IlT($IlILLll, $IlILLLL, $lILIIIL); $IlILl1l += 1; }}$this->TII1IlT($IlILLll, '</sitemapindex>', $lILIIIL); $this->TII1IlI($IlILLll, $lILIIIL); if ($lILIIIL) $IlILLlI .= I9759; @chmod($this->lIl11lI.$IlILLlI, 0644); $IlILlLI[I9760][0] =$IlILLlI; $this->cms->Core->WriteOption(I9763, 'gen_sitemap', time(), serialize($IlILlLI)); $IlILLL1 =$this->TII1lTl(); $this->TII1lTI("act_gen_sitemap", sprintf("%.5f", $IlILLL1 -$IlILlll), "", $IlILLlI, @filesize($this->lIl11lI.$IlILLlI), $IlILl1l); }function TII1IT1() {$IlILlll =$this->TII1lTl(); $this->cms->Core->ReadOption($lILIIIl, I9764, I9753); $IlIL1ll =""; $IlIL1II =""; $IlIL1Il =0; $IlILI1L =$lILIIIl["value"]; if (!$IlILI1L) {$IlIL1ll ="sitemap_sent_err_file_not_created"; }$IlIL1IL =I9765; $IlILI11 =unserialize($lILIIIl[I9748]); if(isset($IlILI11[I9760]) && file_exists($this->lIl11lI.$IlILI11[I9760][0])) {$IlIL1IL =$this->lIl11ll.$IlILI11[I9760][0]; @clearstatcache; $IlIL1II =@filesize($this->lIl11lI.$IlILI11[I9760][0]); foreach($IlILI11 as $IlIL1I1 => $mod){ if($IlIL1I1 != 'index_sm'){ $IlIL1Il += sizeof($mod); }}}else {$IlIL1ll ="sitemap_sent_err_file_not_found"; }if (!$IlIL1ll) {$lIl1111 =array(); $this->cms->Core->ReadOption($lIl1111, I9764, I9741); $IlIL1lI =unserialize($lIl1111[I9748]); if (!isset($IlIL1lI[I9749])) {$IlIL1lI[I9749] =0; }$IlIL1ll ="sitemap_sent"; $IlIL1lL =$this->lIl11Ll.urlencode($IlIL1IL); if (function_exists('curl_init')) {$ch =curl_init(); curl_setopt($ch, CURLOPT_URL, $IlIL1lL); curl_setopt($ch, CURLOPT_HEADER, 0); curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); $IlIL1l1 =curl_exec($ch); $IlIL1LI =curl_getinfo($ch); curl_close($ch); if ($IlIL1LI[I9766] != 200) {$IlIL1lI[I9749] += 1; $IlIL1ll ="sitemap_sent_err_http_code"; }}elseif (ini_get('allow_url_fopen') || get_cfg_var('allow_url_fopen')) {$handle =fopen($IlIL1lL, "r"); fclose($handle); }if ($IlIL1ll == I9767) {$IlIL1lI[I9749] =0; }$this->cms->Core->WriteOption(I9763, 'send_sitemap', time(), serialize($IlIL1lI)); }$status =I9765; $IlILLL1 =$this->TII1lTl(); if ($IlIL1ll != I9767) $status =$IlIL1ll; $this->TII1lTI("act_send_sitemap", sprintf("%.5f", $IlILLL1 -$IlILlll), $status, I9765, $IlIL1II, $IlIL1Il); return $IlIL1ll; }function TII1IIT($lILIII1 =I9765) {$IlILlll =$this->TII1lTl(); $compress =false; $lILIIlI =explode("_", $lILIII1); $lILIIll =intval($lILIIlI[sizeof($lILIIlI) -1]); unset($lILIIlI[sizeof($lILIIlI) -1]); unset($lILIIlI[0]); $module =implode(I9757, $lILIIlI); if (mb_substr($lILIII1, -3) == I9759) $compress =true; $lILIIlL =0; $lILIIl1 =$this->cms->Core->GetOption(I9736); $IILlllL =$this->cms->Core->GetOption(I9768); $lILIIIL =$this->module->GetOption(I9769); $supportedModules =$this->TII1I1l(I9751); $IlILlII =$this->TII1I1l("sitemap_changefreq"); $filter =I9765; $lILIILI =I9765; if ($module) {if(!array_key_exists($module, $supportedModules) && $module != 'urls'){ return; }elseif($module != 'urls'){ $filter =I9770.$module."%' "; if ($lILIIll) {$lILIILI =I9771.$this->lIl11lL*($lILIIll-1).", ".$this->lIl11lL; }}}if($module == 'pages' || $module == 'urls'){ $filter =$filter.$this->TTI1ITT(); }if($module != 'urls'){ $lILIILl =$this->TII1I11(intval($IlILlII[$module])); $lILIILL =sprintf(I9772, $supportedModules[$module]/10); $IlILLI1 ="sitemap_".$module."_".sprintf("%03d", $lILIIll).I9758; if ($compress) $IlILLI1 .= I9759; $lILIIL1 =I9773; $this->TII1IIl($this->lIl11l1, $compress); }else{ $supportedModules['urls'] =10; $lILIIL1 ='ORDER BY date_modified DESC'; }$this->db->execute("SET NAMES utf8"); $sql =I9774.$this->lIl11L1." $filter ".$lILIIL1." ".$lILIILI; $this->TTI1T1I($sql); $rs =&$this->db->select($sql); $lILII1I =array(); $lILII1l =array(); $lILII1L =$this->cms->Core->GetModOption('forum', 'messages_per_page'); if(empty($lILII1L)){ $lILII1L =10; }$lILII11 =I9765; $lILIlII =0; while ($IlILLII =$rs->nextRecord()) {set_time_limit(29); $lILIlIl =$IlILLII[I9775]; if($IlILLII["noindex"] == 1 && $IlILLII[I9756] != 'forum'){ continue; }else if ($IlILLII[I9756] == 'forum') {$lILIlIl =preg_replace('/\?id_message=\d+$/i', I9776, $lILIlIl); if(isset($lILII1I[$lILIlIl])){ $lILII1I[$lILIlIl] ++; $lILIlIL =floor(($lILII1I[$lILIlIl] -1) /$lILII1L); if($lILIlIL >0){ $lILIlIl .= '?action=rsrtme&offset=' .($lILIlIL *$lILII1L); }}else{ $lILII1I[$lILIlIl] =1; }if($IlILLII["noindex"] == 1){ continue; }if(isset($lILII1l[$lILIlIl])){ continue; }else{ $lILII1l[$lILIlIl] =true; }}$lILIILL ="0.5"; if (($IlILLII["last_modified_ts"] +10*24*60*60) >= time()) {$lILIILL =sprintf(I9772, $supportedModules[$module]/10); }elseif ((($IlILLII[I9777] +15*24*60*60) >= time()) && ($supportedModules[$module] >= 6)) {$lILIILL =sprintf(I9772, ($supportedModules[$module] -1)/10); }elseif ((($IlILLII[I9777] +20*24*60*60) >= time()) && ($supportedModules[$module] >= 7)) {$lILIILL =sprintf(I9772, ($supportedModules[$module] -2)/10); }elseif ((($IlILLII[I9777] +25*24*60*60) >= time()) && ($supportedModules[$module] >= 8)) {$lILIILL =sprintf(I9772, ($supportedModules[$module] -3)/10); }elseif ((($IlILLII[I9777] +30*24*60*60) >= time()) && ($supportedModules[$module] >= 9)) {$lILIILL =sprintf(I9772, ($supportedModules[$module] -4)/10); }elseif ((($IlILLII[I9777] +35*24*60*60) >= time()) && ($supportedModules[$module] >= 10)) {$lILIILL =sprintf(I9772, ($supportedModules[$module] -5)/10); }$lILIlI1 =$GLOBALS['ROOT_PATH_WWW'].htmlentities(ltrim($lILIlIl, '/'), ENT_QUOTES, 'UTF-8'); if($module == 'urls'){ echo $IlILLII[I9756].I9778.$lILIlI1.I9778.$IlILLII[I9777].I9735; }else{ $lILII11 .= "  <url>".I9735. "    <loc>".$lILIlI1."</loc>".I9735; if($lILIIl1 && $IlILLII['use_hreflang']){ foreach($IILlllL as $lILIllI){ $lILIlll =$GLOBALS[I9779].htmlentities(preg_replace('/^'.$IlILLII['lang'].'\//', $lILIllI .'/', ltrim($lILIlIl, I9780)), ENT_QUOTES, 'UTF-8'); if($lILIllI != $IlILLII['lang']){ $lILII11 .= "    <xhtml:link".I9735. '        rel="alternate"'.I9735. I9781 .$lILIllI .'"'.I9735. '        href="' .$lILIlll .'"'.I9735. '    />'.I9735; }}}$lILII11 .= I9782.$lILIILl."</changefreq>".I9735. "    <priority>".$lILIILL."</priority>".I9735. "  </url>".I9735; $lILIlII += 1; if ($lILIlII >= 50) {$this->TII1IIl($lILII11, $compress); $lILII11 =I9765; $lILIlII =0; }$lILIIlL += 1; }}global $conn; if($module == I9783){ if(!is_null($conn)){ $conn->AddHeader('Content-type: text/plain; charset=utf-8'); $conn->DisableSign =true; $conn->Out(); }return; }$lILII11 .= "</urlset>"; $this->TII1IIl($lILII11, $compress); $IlILLL1 =$this->TII1lTl(); $this->TII1lTI("act_output_sitemap", sprintf("%.5f", $IlILLL1 -$IlILlll), I9765, $IlILLI1, $this->lIl11LL, $lILIIlL); if(!is_null($conn)){ $conn->AddHeader('Content-type: application/xml; charset=utf-8'); $conn->DisableSign =true; $conn->Out(); }}function TII1III($filename, $compress) {ob_start(); header($GLOBALS["SERVER_PROTOCOL"]." 200 OK"); header("Expires: 0"); header("Cache-Control: must-revalidate, post-check=0,pre-check=0"); header(I9784); header("Accept-Ranges: none"); if ($compress) {header("Content-type: application/gzip"); }else {header('Content-type: application/xml; charset=utf-8',true); }header("Content-disposition: attachment; filename=\"".$filename.I9785); ob_end_flush(); }function TII1IIl($content, $compress =false) {if ($compress) {$lILIllL =@gzcompress($content, 9); $lILIllL =mb_substr($lILIllL, 0, mb_strlen($lILIllL) -4); $this->lIl11LL += mb_strlen("\x1f\x8b\x08\x00\x00\x00\x00\x00"); $this->lIl11LL += mb_strlen($lILIllL.pack('V', crc32($content)).pack('V', mb_strlen($content))); echo "\x1f\x8b\x08\x00\x00\x00\x00\x00"; echo $lILIllL.pack('V', crc32($content)).pack('V', mb_strlen($content)); }else {$this->lIl11LL += mb_strlen($content); echo $content; }}function TII1II1($filename, $compress) {if (!$filename) {return false; }if ($compress) {$IlILLll =@gzopen($this->lIl11lI.$filename.I9759, I9786); }else {$IlILLll =@fopen($this->lIl11lI.$filename, "wb"); }return $IlILLll; }function TII1IlT($IlILLll, $string, $compress) {if (!$IlILLll) {return false; }if ($compress) {$result =@gzwrite($IlILLll, $string); }else {$result =@fwrite($IlILLll, $string); }return $result; }function TII1IlI($IlILLll, $compress) {if (!$IlILLll) {return false; }if ($compress) {return @gzclose($IlILLll); }else {return @fclose($IlILLll); }}function TII1Ill($II1LI11 =-1) {if ($II1LI11 == -1) {$this->lIl11I1 ++; $II1LI11 =0; if ($this->lIl11I1 >$this->lIl11IL) {$II1LI11 =100; }else {$II1LI11 =intval(100*$this->lIl11I1/$this->lIl11IL); }}else {$this->lIl11I1 =intval($II1LI11*$this->lIl11IL/100); }if ($this->IlIlL1I) {print I9778; ob_flush(); }else {TlT1lTT($this->II1lLL1, $II1LI11, I9776); $html =$this->cms->Gui->getAbs($this->moduleName."_subform:progress_popup_iterator", Array("percent" => $II1LI11)); print $html; flush(); }}function TII1Il1() {if ((++$this->lIl111I) %50 == 0 && $this->lIl111l +5 <time()) {$this->lIl111l =time(); print I9778; $this->IlIlL1I ?ob_flush() :flush(); }}function TII1I1T(&$Core) {$lILIll1 =array(); $vMod =&$Core->GetModule(I9764); foreach(self::$lIl111L as $IlILll1){ switch($IlILll1) {case "news": $lILIll1[I9787] =10; break; case "eshop": $lILIll1["eshop"] =7; break; case "pages": $lILIll1["pages"] =8; break; case I9788: case "forum": case "guestbook": case "discussion": $lILIll1[$IlILll1] =9; break; default: $lILIll1[$IlILll1] =5; break; }}return $lILIll1; }function TII1I1I(&$Core) {$lILIlLI =array(); $vMod =&$Core->GetModule(I9764); foreach(self::$lIl111L as $IlILll1){ $lILIlLI[$IlILll1] =7; }return $lILIlLI; }function TII1I1l($option) {$res =array(); if ($option == I9751) {$res =$this->module->GetOption(I9751); if (!is_array($res) || !sizeof($res)) {$res =$this->TII1I1T($this->cms->Core); }}elseif ($option == "sitemap_changefreq") {$res =$this->module->GetOption(I9789); if (!is_array($res) || !sizeof($res)) {$res =$this->TII1I1I($this->cms->Core); }}$IlILl11 =$this->TTI1ITI(); foreach($IlILl11 as $modId => $hyper){ $res[$modId] =isset($res[$hyper]) ?$res[$hyper] :(($option == I9790) ?5 :7); }return $res; }function TII1I11($value) {switch ($value) {case 1: return "daily"; break; case 7: return "weekly"; break; case 30: return "monthly"; break; case 365: return "yearly"; break; case 0: return I9791; break; default: return "weekly"; break; }}function TII1lTT() {$IlILL1l =$this->module->GetOption("sitemap_ping_google"); switch ($IlILL1l) {case "daily": return 1; break; case "weekly": return 7; break; case I9792: return 30; break; default: return 7; break; }}function TII1lTI($action, $time ="0.0", $status =I9765, $sitemap_file =I9765, $sitemap_size =I9765, $num_urls =0) {global $oSession; if (CheckProbability(0.05)) {$I1LllLl =$this->module->GetOption('autodeletion_period'); if (stripos($I1LllLl, 'week') !== false) {$numDays =0; preg_match('/^(\d*)\s*.*$/i', $I1LllLl, $matches); $numDays =7*intval($matches[1]); if ($numDays <= 6) {$numDays =7; }$I1LllLl =$numDays.I9793; }$sql ="DELETE FROM cms_google_sitemap " ."WHERE `date` < DATE_SUB(NOW(), INTERVAL " .$I1LllLl .")"; $this->db->execute($sql); }if (!$status) {$status ="sm_status_ok"; }$aSQL =array( I9794 => "=|NOW()", 'action' => $action, 'time' => $time, 'status' => $status, I9795 => $sitemap_file, 'sitemap_size' => $sitemap_size, 'num_urls' => $num_urls );if ($this->IlIlL1I) {$aSQL["daemon_mode"] ='1'; if ($action == I9796) {$aSQL["action"] ="act_auto_send_sitemap"; }}else {if (is_object($oSession)) {$login =$oSession->GetVar('user'); }else if (function_exists('admSession')) {$session =admSession(); $login =$session->GetVar(I9797); }if (is_array($login)) {$login =$login["username"]; }$aSQL["ip"] =getenv("REMOTE_ADDR"); $aSQL["login"] =$login; }if ($action == I9798) {$aSQL['useragent'] =getenv('HTTP_USER_AGENT'); }$sql =$this->db->genInsertSQL('cms_google_sitemap', $aSQL); $this->db->execute($sql); }function TII1lTl() {list($usec, $sec) =explode(" ", microtime()); return ((float)$usec +(float)$sec); }function disableSitemaps($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I =I9799) {if ($cData["value"]) {@clearstatcache; if (@is_file($GLOBALS[I9733]."sitemap_index.xml")) {@unlink($GLOBALS[I9733]."sitemap_index.xml"); }$GLOBALS["Core"]->DeleteOption(I9764, I9753); $GLOBALS[I9800]->DeleteOption(I9764, I9741); $db =new DB_si; $sql ="DELETE FROM cms_google_sitemap"; $db->execute($sql); }switch($IIL1l1I) {case I9799: break; case "getvalue": $res =$cData["value"]; break; case "correctvalue": break; case I9801: break; }return true; }private function TTI1T1I(&$sql){ if($this->IlILILI){ $sql =str_replace('cms_site_search', 'cms_site_search_index', $sql); }}private function TTI1ITT(){ $IlIL1Ll =I9776; $IlIL1LL =array(); $sql =I9802; $rs =&$this->db->select($sql); while($IlILLII =$rs->nextRecord()){ $IlIL1LL[] =$IlILLII["id"]; }foreach($IlIL1LL as $ID){ $IlIL1Ll .= " AND id_page != '".mysql_real_escape_string($ID, $this->db->_dbLink).I9803; }return $IlIL1Ll; }private function TTI1ITI(){ $aModules =array(); $oDeclarator =AMI_ModDeclarator::getInstance(); $aInstalled =$oDeclarator->getRegistered('ami_multifeeds'); if(sizeof($aInstalled)){ foreach($aInstalled as $modId){ if((strpos(substr($modId, -4), '_cat') !== false) && !$this->cms->Core->issetModOption($modId, 'use_categories')){ }else{ $aHyperData =$oDeclarator->getHyperData($modId); if(!empty($aHyperData[1])){ $aModules[$modId] =$aHyperData[1]; }}}}return $aModules; }}