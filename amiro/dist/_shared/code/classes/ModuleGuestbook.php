<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       31620 xkqwxynsgzxpmqpnxkliswnzgqwggiziimlkgqlwtwynwkxmnitntkwksnmpkiuktwnypnir
 */ ?><?php foreach(array(9804=>'nZIQ|fMQJS|nZIQ',9805=>'GuYJMDO|Hn',9806=>'',9807=>'HrSQr|DEJ',9808=>"[",9809=>'fJZPMWHn',9810=>'|JMDt%GuYJMW|Hn',9811=>'DtrMGJMnQ',9812=>'MS',9813=>'ZWtMHn|EuHtQ',9814=>'|JMDt%EuHtQ',9815=>'rQGJB|MS',9816=>'ZWtMHn',9817=>'Hff',9818=>'|JMDt%SQJ',9819=>'HYLQWt',9820=>'fHrI|SZtZ',9821=>'DZvQ',9822=>'EuHtQ',9823=>'RqihTq|zssR',9824=>'GOG|StMIQ',9825=>'JQPQnS',9826=>'JQP|YHJS',9827=>'SMDZYJQS',9828=>'IQDDZPQ',9829=>'rQGJB',9830=>'nHnQ',9831=>'zss',9832=>'funW|WHnvQrt`GOG',9833=>'frHnt|MIZPQD',9834=>'ZutOHr',9835=>'GuYJMW',9836=>'MS|IQIYQr',9837=>'*~e&',9838=>'~;\D[',9839=>'DuYLQWt',9840=>'IDP|MS|IQIYQr',9841=>"coqRq?.MS.?=?",9842=>'YHSB|fHrI',9843=>"P`[!?",9844=>"coqRq?1",9845=>'wjzddqd|gzTo',9846=>'fSZtQ',9847=>'ZDW',9848=>'IQIYQrD',9849=>'fZJDQ',9850=>'uDQr|DHurWQ|ZGG',9851=>'CZntDurJ',9852=>'DWrMGt|fuJJ|JMnK',9853=>'fHrI',9854=>'trQQ|HffDQt',9855=>'uDQr|MS',9856=>'|JMDt%MtQI|ZutOHr',9857=>'DtZtuD|QrrHr',9858=>'DJZDOQD',9859=>"'{",9860=>'JZnP|SZtZ',9861=>'ZJJ',9862=>'~\]\|MS\=\S-~',9863=>']PH|JZDt|GZPQ=1',9864=>"dqjqwT?",9865=>'JMnK',9866=>'~;\C-\%\~\~~',9867=>'iZMJQr`GOG') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleGuestbook extends CMS_Discussion {public $lILIlL1; public $I1LlLlL; function ModuleGuestbook(&$cms, &$db, &$cModule) {parent::CMS_Forum($cms, $db, $cModule); }function _Init($IIll1l1 =array (),$IIll1LI ='', $IIll1Ll ='', $aOptions =array ()){$IIIIL11 =array (I9804 => 'subject', 'announce_field_name' => 'message', 'group_operations' => array (I9805, 'publish_off', 'del'), 'default_prefix' => 'g' );$aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->lILIlL1 =0; $this->I1LlLlL =0; $this->II11I11 =0; }function _InitAdmin() {parent::_InitAdmin(); }function TTTlIII($II11l1L =true) {parent::TTTlIII(); $this->II11llL =true; parent::TTTlIII(false); }function TTTlI11(&$vData, &$aCustom) {$this->browser->InitSQL( "g.*, DATE_FORMAT(g.date, '" .$this->cms->DFMT['db_dtime'] ."') AS fdate", "FROM `cms_guestbook` g", "WHERE 1 " .$this->_ApplyFilters() .$this->TTTlIl1(), I9806, 'name', 'g.id desc' );if ($this->II11IL1) {if ($this->id) {$id =$this->id; }else {$sql ="SELECT id FROM `cms_guestbook` g WHERE 1 " .$this->_ApplyFilters().$this->TTTlIl1() ." LIMIT 1"; $id =intval($this->db->getValue($sql)); }if ($this->TTIlIIT($this->II11I11)) {$this->II11lI1 =$this->browser->SQLData[I9807]; $res =$this->TTIlIII($this->II11I11, I9806); }else {$res =array ('rows' => array ());}$db =clone($this->db); require_once $GLOBALS['CLASSES_PATH'] .'CMS_IteratorArray.php'; $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray($res['rows']); $this->db->IlI1Lll =$this->II11llI; $this->db->IIIll1L =false; $this->browser->lll1IIL =false; $this->browser->InitSQL(I9808, "FROM xxx", "WHERE 1"); }$aFields =array ('public' => array ('action' => I9809, 'value' => 1, 'id' => 'pub_id', 'on' => $this->moduleName .I9810, 'off' => $this->moduleName .'_list:public_off'), 'author' => array ('action' => I9811, 'size' => 35), 'action_post_message' => array ('action' => I9809, 'value' => I9806, I9812 => 'reply_id', 'on' => $this->moduleName .'_list:post_message', 'off' => I9806), I9813 => array ('action' => I9809, 'value' => I9806, I9812 => 'quote_id', 'on' => $this->moduleName .I9814, 'off' => I9806), 'action_reply' => array ('action' => I9809, 'value' => I9806, I9812 => I9815, 'on' => $this->moduleName .'_list:reply', 'off' => I9806), 'action_edit' => array (I9816 => I9809, 'value' => I9806, I9812 => 'edit_id', 'on' => $this->moduleName .'_list:edit', I9817 => I9806), 'action_del' => array (I9816 => I9809, 'value' => I9806, I9812 => 'del_id', 'on' => $this->moduleName .I9818, I9817 => I9806) );$aCustom['fields'] += $aFields; $aCustom['fields']['bold'] =array (I9816 => 'callback', I9819 => &$this, 'method' => '_GetAdminItemCB'); $aCustom['applied_id'] ='g.id'; $aCustom[I9820]['buttons'] =array ('add', 'apply', 'cancel', I9821, 'preview'); if (sizeof($this->itemData)) {if($this->II11lLI){ $vData[I9812] =$this->itemData[I9812]; }$vData['id_parent'] =$this->cms->Vars[I9816] != 'reply' ?$this->itemData['id_parent'] :$this->lILIlL1; if ($this->cms->Vars[I9816] == I9822 || $this->cms->Vars[I9816] == 'reply') {$vData['fdate'] =date($this->cms->DFMT['php_dtime']); }}else {$vData['ip'] =getenv(I9823); $this->itemData['id_member'] =$vData['id_member'] =$this->IlIlLIL[I9812]; $vData['author'] =$this->TTI1TII(); $vData['fdate'] =date($this->cms->DFMT[I9824]); }$vData['noindex_external_links'] =$this->module->GetOption('noindex_external_links') ?'true' :'false'; $aCustom[I9825] =array ('published', 'notpublished', 'leg_yellow', 'leg_blue', I9826, 'leg_reply', 'leg_edit', 'leg_del'); if($this->II11lL1){ $vData['cancel'] =I9827; }parent::TTTlI11($vData, $aCustom); if (isset($db)) {$this->db =$db; }}function _GetAdminItemCB(&$aItem, &$aData) {foreach (array ('author', 'msg_author') as $k) {if (isset($aItem[$k])) {$this->TTI1TIl($aItem[$k]); }}$this->TTIl11l($aItem); if ($aItem['count_children']) {$aItem['action_del'] =$this->cms->Gui->get($this->moduleName .'_list:action_del_with_children', $aItem); }elseif (!$aItem['id_parent']) {$aItem['style'] .= '_b'; }$aItem['message'] =$this->cms->stripLine(TlTllI1($aItem[I9828]), 1024); if (!empty($aItem['tree_level'])) {$aItem[I9828] =str_repeat('&nbsp; ', $aItem['tree_level']) .$aItem[I9828]; }}function TTTlITT($IIIL11l, $cId, $cModule =I9806){ $I1LlL1I =$IIIL11l; switch ($this->side) {case 'admin': if ($cId >0) {$this->TTIl111($cId); switch ($IIIL11l) {case I9822: case I9829: $this->TTIlIlI($IIIL11l, $cId); break; }}break; }if ($cId >0) {switch ($IIIL11l) {case 'update_member': $this->TTI1TTT($cId); break; case 'delete_member': $this->TTI1TTI($cId); break; }}parent::TTTlITT($IIIL11l, $cId, $cModule); if( $this->II11l1l || !$this->II11lLl || $this->side !== 'admin' || ($I1LlL1I === I9829 && $this->cms->Vars[I9816] === I9829) ){return; }$parentId =(int)$this->cms->Vars['flt_id_parent']; $I1LlL1l =FALSE; switch($IIIL11l){ case I9830: case 'add': case 'apply': if($IIIL11l === 'apply' && $this->cms->Vars[I9816] !== 'apply'){ break; }$cId =$parentId; $IIIL11l =I9829; $mode =I9831; $this->II11lL1 =TRUE; $this->II11lLL =$this->cms->Vars[I9816] !== I9821; $this->II11l1I =$this->cms->Vars[I9816] === I9821; $I1LlL1l =TRUE; break; case 'edit': $IIIL11l =I9829; $mode ='EDIT'; $this->II11lLL =FALSE; $this->II11l1I =TRUE; $I1LlL1l =TRUE; break; }if($I1LlL1l){ $this->II11l1l =TRUE; $this->TTIlIlI($IIIL11l, $cId); $this->TTTl1Tl($cId, $cModule); $this->cms->Gui->addGlobalVars(array('FORM_MODE' => $mode)); }}function TTT1IlI($aSql =array (),$cId =0) {require_once $GLOBALS['FUNC_INCLUDES_PATH'] .I9832; if ($cId) {$sql ="SELECT `public` FROM `cms_guestbook` WHERE `id` = " .$cId; $this->IlIlLIl =$this->db->getValue($sql); }$message =trim($this->cms->VarsPost[I9828]); $subject =trim($this->cms->VarsPost['subject']); $this->_public =(int)!empty($this->cms->VarsPost['public']); if (!empty($subject) && !empty($message)) {$message =removeSpecial($message, 'slashes'); $this->TTI1TIT($message, $this->module->GetOption(I9833), (bool)sizeof($this->IlIlLIL)); $aSql =array ('subject' => $this->cms->htmlchars($subject), I9828 => addslashes(TlTllIl($this->cms->htmlchars($message), true, $this->module->GetOption('noindex_external_links'), $this->IlIlLlI)), 'id_parent' => intval($this->cms->VarsPost['id_parent']) );if (!empty($this->cms->VarsPost[I9834])) {$aSql[I9834] =$this->cms->VarsPost[I9834]; }$aSql[empty($this->cms->VarsPost[I9812]) ?'date' :'modified_date'] ='=|NOW()'; if ($this->action == 'add') {$aSql[I9835] =$this->_public; $aSql['ip'] ="=|INET_ATON('" .getenv(I9823) ."')"; if (!empty($this->cms->VarsPost['id_member'])) {$aSql[I9836] =intval($this->cms->VarsPost[I9836]); }}}$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); if (empty($this->errno) && $this->appliedId >0) {$this->TTIlT1I('+1', $this->_public ?'both' :'all'); if (isset($this->cms->VarsPost['is_reply'])) {$this->I1LlLlL =$this->appliedId; }}}function TTTl1lI($cId, $cModule) {$aItem =$this->TTIlT1T($cId); parent::TTTl1lI($cId, $cModule); if (empty($this->errno) && $this->appliedId >0) {$this->TTIlITI($aItem, intval(isset($this->cms->VarsPost[I9835]))); }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $cId =intval($cId); $sql ="SELECT g.*, DATE_FORMAT(g.date, '" .$this->cms->DFMT["db_dtime"] ."') AS fdate, " ."IF(g.public > 0, ' checked', '') `public`, INET_NTOA(g.`ip`) `ip`, m.email " ."FROM `cms_guestbook` g " ."LEFT OUTER JOIN `cms_members` m ON m.id = g.id_member " ."WHERE g.id = " .$cId .$this->_ApplyFilters(); $this->db->query($sql); if ($this->itemData =$this->db->nextRecord()) {$I1LlL11 =$this->cms->Vars[I9816] == I9822 || $this->cms->Vars[I9816] == I9829; if($I1LlL11 || $this->II11l1l){ $this->itemData['date'] =date($this->cms->DFMT[I9824]); $this->itemData[I9828] =$I1LlL11 || $this->II11lLL ?'[Q="' .$this->itemData[I9834] .'"]' .TlITI1l($this->itemData[I9828], true) .I9837 :TlITI1l($this->itemData[I9828], true); $aItem =$this->itemData; $this->TTIl11l($aItem); $this->itemData['_parent_id'] =$cId; $this->itemData['is_async'] =$aItem['is_async'] =$this->II11lLI; $this->itemData['answer_for'] =$this->cms->Gui->get($this->moduleName .'_subform:answer_for', $aItem); $this->itemData['id_parent'] =$this->itemData[I9812]; $this->itemData['can_send'] =!empty($this->itemData['email']); $this->lILIlL1 =$this->itemData[I9812]; if($I1LlL11 || !$this->II11l1I){ $this->itemData[I9812] =0; }$this->itemData[I9836] =$this->IlIlLIL[I9812]; $this->itemData[I9834] =$this->TTI1TII(); }else {$this->itemData[I9828] =TlITI1l($this->itemData[I9828], true); }$re =$this->words['re']; if (!preg_match(I9838 .preg_quote($re) .'\s*:/i', $this->itemData['subject'])) {$this->itemData['subject'] =$re .': ' .trim($this->itemData[I9839]); }}}function _ActionDel($cId, $cModule) {$aItem =$this->TTIlT1T($cId); if (sizeof($aItem) >0) {$IIl1lIL =$this->TTIlITl($aItem); if (!sizeof($this->aGroupIds)) {$this->cms->AddStatusMsg('status_del'); }return $IIl1lIL; }}function _ActionPublish($cId, $cModule) {$aItem =$this->TTIlT1T($cId); if ($aItem) {$public =intval($this->cms->Vars['publish'] == 'on'); $this->appliedId =$cId; $this->TTIlITI($aItem, $public); }parent::_ActionPublish($cId, $cModule); }function TIITl11($record, $I1Ll1I1 =false) {$sql ="SELECT `id` `msg_id`, `id_member` `msg_id_member`, `author` `msg_author` " ."FROM `cms_guestbook` " ."WHERE `date` = '" .$record['msg_date'] ."'"; if ($aSQL =$this->db->getRecord($sql)) {$aSQL += $record; }else {$aSQL =array ('msg_id' => 0, I9840 => 0, 'msg_author' => I9806, 'msg_date' => '0000-00-00 00:00:00' );}if ($I1Ll1I1) {$this->TTIlTlT(0); }$sql =$this->db->genUpdateSQL('cms_guestbook', $aSQL, I9841 .$this->II11I11); $this->db->execute($sql); }function TTT1Tl1($cType, $cModule, $II11l1L =true) {switch ($cType) {case 'counters': $this->TTIlTlT(0); $this->cms->AddStatusMsg('status_repair_counters', 'blue'); break; default: parent::TTT1Tl1($cType, $cModule, true); }}function TTTllTI(&$aCustom) {$this->SetBodyType('body_items'); $this->SetBodyType(I9842); parent::TTTllTI($aCustom); }function TTTll1T(&$vData, &$aCustom) {$this->II11lll =$this->cms->DFMT['db']; $I1LllL1 =AMI::getSingleton('env/session')->isLoggedIn(); if ($I1LllL1) {$vData[I9834] =$this->TTI1TII(); $vData[I9836] =$this->II11ll1 =$this->IlIlLIL[I9812]; }else {$vData[I9834] =I9806; $vData[I9836] =0; }foreach ($this->IIllIL1 as $IIlL1L1 => $tmp) {$aDefault =array ();$IIlL1Ll =$this->TTITTT1($aCustom, $IIlL1L1, false); switch ($IIlL1L1) {case 'body_items': $aDefault['page_item_type'] =$IIlL1L1; $IIlL1Ll += $aDefault; $this->TTTllll($vData, $IIlL1Ll); $this->browser->InitSQL( I9843 ."DATE_FORMAT(`date`, '" .$this->II11lll ."') `fdate`, " ."UNIX_TIMESTAMP(g.date) `unixtime`", "FROM `cms_guestbook` g ", I9844 .$this->_ApplyFilters() .$this->TTTlIl1(), I9806, $this->browser->TI1TTlT() );if ($this->II11IL1) {$this->II11I1I =" WHERE 1 " .$this->_ApplyFilters(); if ($this->id) {$id =$this->id; }else {$sql ="SELECT `id` FROM `cms_guestbook` g" .$this->II11I1I ." ORDER BY `id` ASC LIMIT 1"; $id =intval($this->db->getValue($sql)); }$this->TTIlTlI($id); if ($this->TTIlIIT($this->II11I11)) {$this->II11lI1 =$this->browser->SQLData[I9807]; $res =$this->TTIlIII($this->II11I11, I9806); }else {$res =array ('rows' => array ());}$db =clone($this->db); require_once $GLOBALS[I9845] .'CMS_IteratorArray.php'; $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray($res['rows']); $this->db->IlI1Lll =$this->II11llI; $this->db->IIIll1L =false; $this->browser->lll1IIL =false; $this->browser->InitSQL(I9808, "FROM xxx", I9844); }$IIlL1Ll['simple_set_fields'] =array (I9846, I9839, I9828); if (!empty($this->cms->Vars['go_last_page']) && $this->module->GetOption('front_page_sort_col') == 'date' && $this->module->GetOption('front_page_sort_dim') == I9847) {$this->browser->lll1IlL =true; }$IIlL1Ll['fields'][I9812] =array (I9816 => 'callback', I9819 => &$this, 'method' => '_GetFrontItemCB'); $vMod =&$this->cms->Core->GetModule(I9848); $this->IlIlLLl =$vMod->IsPresentInPMandPublic() ?$vMod->GetFrontLink() :I9806; $this->IlIlLLL =mb_strlen($this->IlIlLLl) ?false :true; break; case I9842: $vData['id_parent'] =0; $vData['noindex_external_links'] =$this->module->GetOption('noindex_external_links') ?'true' :I9849; $IIlL1Ll['page_item_type'] =I9842; if ($I1LllL1 || !$this->module->GetOption('add_messages_by_registered_only')) {$vData['script_quote_message'] =$this->cms->Gui->get($this->moduleName .'_list:script_quote_message', $vData); $this->TTI1TT1($vData); if(AMI::getOption(I9848,I9850)){ $vData['user_source_app_buttons'] =AMI::getSingleton(I9850)->getButtons(); }$vData['form'] =$this->cms->Gui->get($this->moduleName .'_list:form', $vData); }else {$vMod =&$this->cms->Core->GetModule(I9848); $I1LLII1 =$vMod->IsPresentInPMandPublic() ?$vMod->GetFrontLink() :I9806; $I1LLIlI =mb_strlen($this->IlIlLLl) ?false :true; if (!$I1LLIlI) {$vData['register_link'] =$I1LLII1; $vData[I9851] =rawurlencode($GLOBALS['ROOT_PATH_WWW'] .$GLOBALS['vGlobVars']['script_full_link'] .(mb_strpos($GLOBALS['vGlobVars'][I9852], '?') === false ?'?' :'&') .'display_form=1#forumForm'); $vData[I9853] =$this->cms->Gui->get($this->moduleName .'_list:register_to_add_message', $vData); }}break; }parent::TTTll1T($vData, $IIlL1Ll); if (isset($db)) {$this->db =$db; }}}function _GetFrontItemCB(&$aItem, &$aData) {parent::_GetFrontItemCB($aItem, $aData); $this->TTIl11l($aItem, $this->IlIlLLL); if (!empty($aItem['tree_level'])) {$aItem['tree_offset'] =$this->cms->Gui->getAbs($this->moduleName .'_list:tree_offset', array (I9854 => $aItem['tree_level'] *10)); }if($aItem['source_app_id'] && AMI::getOption(I9848,I9850)){ $I1Ll1LI =AMI::getSingleton(I9850); $aItem['user_source_app_icon'] =$I1Ll1LI->getDriverIcon($I1Ll1LI->getDriverNameById($aItem['source_app_id']), array(I9855 => $aItem['source_app_user_id'])); }$I1LllL1 =AMI::getSingleton('env/session')->isLoggedIn(); if($I1LllL1 && !empty($aItem[I9836]) && $this->cms->Core->isInstalled('private_messages') && $this->cms->Core->IsPresentInPMandPublic('private_messages')){ $oPrivateMessagesView =AMI::getSingleton('private_messages/service/view'); $aItem['send_private_message_link'] =$oPrivateMessagesView->getUserSendMessageLink($aItem[I9836], $this->cms->lang); }$aItem['forum_script_link'] =AMI_PageManager::hasModPublicPage('forum', $this->cms->lang) ?AMI_PageManager::getModLink('forum', $this->cms->lang) :null; $aItem[I9834] =$this->cms->Gui->getAbs($this->moduleName .I9856, $aItem); }function TTT1ITI($cId, $cModule) {$I1LllL1 =AMI::getSingleton('env/session')->isLoggedIn(); if (!$I1LllL1 && $this->module->GetOption('add_messages_by_registered_only')) {$this->cms->AddStatusMsg('status_not_allowed_to_add_messages', 'red'); return false; }if (isset($this->cms->VarsPost[I9834]) && ($author =trim($this->cms->VarsPost[I9834])) != I9806) {$author =trim($this->cms->VarsPost[I9834]); $memberId =0; }else {$author =$I1LllL1 ?$this->TTI1TII() :$this->cms->VarsPost[I9834]; $memberId =$I1LllL1 ?$this->IlIlLIL[I9812] :0; }$subject =trim($this->cms->VarsPost[I9839]); $message =trim($this->cms->VarsPost[I9828]); if (empty($subject) || empty($author) || empty($message)) {$this->cms->AddStatusMsg(I9857, 'red'); return false; }$sourceAppId =$I1LllL1 ?$this->IlIlLIL['source_app_id'] :0; $parentId =empty($this->cms->VarsPost['realAnswer']) ?0 :intval($this->cms->VarsPost['id_parent']); if ($parentId) {$sql ="SELECT `id` FROM `cms_guestbook` g " .I9841 .$parentId .$this->_ApplyFilters(); $parentId =intval($this->db->getValue($sql)); }$public =intval((bool)$this->module->GetOption('force_publish')); require_once $GLOBALS['FUNC_INCLUDES_PATH'] .I9832; $message =TlTllIl($this->cms->htmlchars(removeSpecial($message, 'slashes')), true, $this->module->GetOption('noindex_external_links'), $this->IlIlLlI); if(!$this->TTI1TlI($message)){ $this->cms->Gui->AddGlobalVars( array( I9839 => AMI_Lib_String::htmlChars(removeSpecial($subject, I9858)), 'posted_bb_code' => AMI_Lib_String::jParse(removeSpecial(trim($this->cms->VarsPost[I9828]), I9858)) ));return false; }$message =addslashes($message); if (empty($this->cms->VarsPost['id_update'])) {$aSQL =array ('ip' => "=|INET_ATON('" .getenv(I9823) .I9859, I9835 => $public, 'id_parent' => $parentId, I9836 => $memberId, 'source_app_id' => $sourceAppId, I9834 => $author, 'date' => '=|NOW()', I9839 => $this->cms->htmlchars($subject), I9828 => $message );if ($this->options[I9860]) {$aSQL['lang'] =$this->langData; }$sql =$this->db->genInsertSQL('cms_guestbook', $aSQL); $this->db->execute($sql); $this->appliedId =$this->db->lastInsertId(); if ($this->appliedId) {$this->TTIlT1I('+1', $public ?'both' :I9861); $this->TIIT1TT($aSQL); $this->cms->AddStatusMsg('status_add'); }else {$this->cms->AddStatusMsg(I9857); }}else {$this->TTIlIlT($message); $public =1; }$this->forceRedirect =true; $this->cms->VarsGet =array ('status_msg' => serialize(array ('sys' => $this->cms->SysStatusMsgs, 'plain' => $this->cms->StatusMsgs))); $this->cms->ActiveScript =preg_replace(I9862, I9806, $GLOBALS['vGlobVars'][I9852]); if ($this->appliedId) {$this->IIlll1L ='&_id=' .$this->appliedId; if ($public) {$this->IIlll1L .= (mb_strpos($GLOBALS['vGlobVars'][I9852], 'go_last_page=1') === false ?I9863 :I9806); }}}function TIIT1TT($aSQL) {$senderEmail =$this->TTI1TTl(); $I1LLIIL =$this->module->GetOption('forum_webmaster_email'); if (empty($I1LLIIL) || empty($senderEmail) || !$this->module->GetOption('notify_admin_about_new_message')) {return false; }if (isset($aSQL['header'])) {$topic =$this->cms->VarsPost['header']; }else {$sql =I9864 .$this->options[I9804] ." FROM " .$this->module->GetTableName() ." WHERE `id` = " .$this->appliedId; $topic =$this->db->getValue($sql); }$mailData =array (I9834 => removeSpecial($aSQL[I9834]), 'members_link' => $this->cms->Core->GetModFrontLink(I9848), I9836 => $this->IlIlLLL ?0 :$aSQL[I9836], 'body' => removeSpecial($this->cms->VarsPost[I9828]), I9865 => $GLOBALS['ROOT_PATH_WWW'] .$this->module->GetFrontLink(), 'topic' => removeSpecial($topic), 'target' => I9839, 'site_path' => preg_replace(array (I9866, '/\/.*$/'), I9806, $GLOBALS['ROOT_PATH_WWW']) );$this->cms->Gui->addBlock('_forum_email', '_local/_admin/templates/letters/forum_mail.tpl'); require_once $GLOBALS[I9845] .I9867; $oMail =new Mailer(); $oMail->SenderAddress =$senderEmail; $oMail->Subject =$this->cms->Gui->get('_forum_email:subject_guestbook_message', $mailData); $oMail->Body =trim($this->cms->Gui->get('_forum_email', $mailData)); $oMail->CopyAddress =I9806; $oMail->BodyFormat ='plain'; $oMail->Prepare(); $oMail->RecipientAddress =$I1LLIIL; $oMail->Send(); return true; }}