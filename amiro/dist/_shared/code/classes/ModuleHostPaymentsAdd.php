<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       16999 xkqwlusupmxynpsxzukkrsilptyrmqtptimkmnixmltuqlrlistrsqxwtyrlukzrzzwypnir
 */ ?><?php foreach(array(9965=>'zSIiHSuJQ`GOG',9966=>'iHSuJQoHDtgZBIQntDgrHGD`GOG',9967=>'wjzddqd|gzTo',9968=>'iHSuJQoHDtgZBIQntDsHWD`GOG',9969=>'iHSuJQoHDtdMtQiZGD`GOG',9970=>"PrHuG|HGQrZtMHnD",9971=>"|DIZJJ",9972=>"WJMQnt|",9973=>'iHSuJQoHDtUDQrD`GOG',9974=>'iHSuJQoHDtgZBIQntD`GOG',9975=>"YZJZnWQ",9976=>"ZIHunt|IHntO",9977=>"GZBIQnt|ZIHunt|IMn",9978=>"IMn|ZIHunt",9979=>"ZIHunt|nuI",9980=>"ZIHunt|tZx",9981=>"ZIHunt",9982=>'YZnK|Lur',9983=>'rYK|QurHDQt',9984=>'GZB|IQtOHS',9985=>"JMWQnWQ|tBGQ",9986=>"fHrI|OQZSQr",9987=>"GZWKZPQ",9988=>"YuB|tBGQ",9989=>"GrMWMnP|",9990=>"GZWKZPQ|MnfH",9991=>"fHrI",9992=>"SQDWrMGtMHn",9993=>"GZB|IQtOHS",9994=>"MS|WHntrZWtHr='",9995=>"'!?",9996=>"GZBIQnt|tBGQ='",9997=>"MnvHMWQ|nuI",9998=>"BZnSQx",9999=>"GrMnt|urJ",10000=>'WJMQnt|fMrDtnZIQ',10001=>"GZBIQnt|fHrI",10002=>"WHntrZWtHr|nZIQ",10003=>"MnvHMWQ",10004=>"frMQnSJB",10005=>"DtZtuD",10006=>"",10007=>"rQS",10008=>"WHntrZWtHr|") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} require_once $GLOBALS['CLASSES_PATH'] .I9965; require_once $GLOBALS['CLASSES_PATH'] .I9966; require_once $GLOBALS[I9967] .I9968; require_once $GLOBALS[I9967] .I9969; class ModuleHostPaymentsAdd extends AdmModule {function ModuleHostPaymentsAdd(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_format.php"); $IIIIL11[I9970] =Array(); $IIIIL11["lang_data"] =false; $aOptions += $IIIIL11; $this->docsLang =HOST_DOCS_LANG; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin() {parent::_InitAdmin(); }function TTTlTI1() {parent::TTTlTI1(); }function TTTlITT($IIIL11l, $cId, $cModule ="") {parent::TTTlITT($IIIL11l, $cId, $cModule); }function GetHtml(&$aCustom) {return parent::GetHtml($aCustom); }function TTTlIT1(&$aCustom, $cType ="small", $IIlLI11 ="", $IIlLlII =I9971) {return parent::TTTlIT1($aCustom, $cType, $IIlLI11, $IIlLlII); }function TTlTll1() {parent::TTlTll1(); }function TTTlIII() {}function _ApplyFilters($prefix ='', $bodyType ='', $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); return $res; }function &TTTlI1T(&$aCustom) {return parent::TTTlI1T($aCustom); }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); $vData['action'] ='apply'; }function TTTlI11(&$vData, &$aCustom) {ModuleHostPaymentsProps::TII111I($lILlILL, 0, $this->TTTTIlI()); $lILlIL1 =array(); if (is_array($lILlILL)){ foreach($lILlILL as $key => $value){ $lILlIL1[I9972.$key] =$value; }}ModuleHostPaymentsProps::TII111I($lILlI1I["props"]); if (is_array($lILlI1I) && is_array($lILlI1I["props"])){ foreach($lILlI1I["props"] as $key => $value){ $lILlIL1["contractor_".$key] =$value; }}$IILll11 =$lILlIL1["contractor_docnum_prefix"]; $vData =array_merge($vData, $lILlIL1); $IIIlLl1 =AdmModule::TTTTI1l($this->cms->Core); $this->lL1IlIL =$IIIlLl1['main_currency']; require_once $GLOBALS[I9967] .I9973; $oSess =admSession(); $vData["domain"] =$oSess->TlIT11I(); $hr =ModuleHostUsers::TIlTTlI($vData["domain"]); $UserId =$hr['id']; require_once $GLOBALS[I9967] .I9974; $account =ModuleHostPayments::TII1llI($UserId); $vData[I9975] =FormatMoney($this->cms, $account["amount"],$this->lL1IlIL,2,2,false, false); $vData["amount_min"] =FormatMoney($this->cms, $account["amount_min"],$this->lL1IlIL,2,2,false, false); $vData["amount_month"] =FormatMoney($this->cms, $account[I9976],$this->lL1IlIL); $vData["date_amount_zero"] =date($this->cms->DFMT["php"], $account["date_amount_zero"]); $amount_min =($account["payment_amount_min"] >0)?$account[I9977]:$account[I9976]; $vData["min_amount"] =($account["amount"] <0)?abs($account["amount"]) +$amount_min :$amount_min; $vData["min_amount_str"] =FormatMoney($this->cms, $vData[I9978],$this->lL1IlIL,2,2,false, false); $vData["amount_num"] =$this->cms->Vars["amount"]; foreach($IIIlLl1["currency_rates"] as $key=>$value){ $vData["amount_".$key] =round($vData[I9979] /$IIIlLl1["currency_rates"][$this->lL1IlIL] *$value, 2); }$lILlIL1["contractor_tax_percent"] =(mb_strpos($lILlIL1["contractor_tax_value"], "%")>0)?true:false; $lILlIL1["contractor_tax_value"] =doubleval($lILlIL1["contractor_tax_value"]); if ($lILlIL1["contractor_tax_percent"]){ switch($lILlIL1["contractor_tax_scheme"]){ case "inc": $vData[I9980] =round($this->cms->Vars["amount"] /(100+$lILlIL1["contractor_tax_value"]) *$lILlIL1["contractor_tax_value"], 2); break; case "sum": $vData[I9980] =round($this->cms->Vars[I9981] /100 *$lILlIL1["contractor_tax_value"], 2); break; default: $vData[I9980] =0; break; }}else{ $vData[I9980] =$lILlIL1["contractor_tax_value"]; }$vData["pay_method"] =$this->cms->Vars["pay_method"]; $lILlI1l =array( I9982 => 1, 'bank_fiz' => 1, 'rbk_bankCard' => 3, 'webmoney' => 4, 'yandex' => 5, I9983 => 6, 'rbk_inner' => 8, 'rbk_prepaidcard' => 9, 'qiwi' => 10, 'paypal' => 11 );if(isset($lILlI1l[$vData[I9984]])){ $vData['payment_type'] =$lILlI1l[$vData[I9984]]; }$vData["pay_method_name"] =$this->words[$vData["pay_method"]]; if($account[I9985]!="paid"){ $vData[I9986] =$this->words["buy_system"]; $vData["hide_balance"] =1; if (!empty($this->cms->VarsPost["id_sitemap"])){ ModuleHostSiteMaps::TIlTTTI($this->cms->VarsPost["id_sitemap"], $lILlI1L); $vData[I9987] =$lILlI1L["name"]; $vData["id_sitemap"] =$this->cms->VarsPost["id_sitemap"]; $vData["buy_type"] =$this->cms->VarsPost[I9988]; $vData["rent_period"] =$this->cms->VarsPost["rent_period"]; $vData["buy_type_name"] =$this->words[$vData[I9988]]; $vData["bonus"] =FormatMoney($this->cms, $lILlI1L[I9989.$this->cms->VarsPost[I9988]."_bonus"],$this->lL1IlIL,2,2,false, false); $vData[I9979] =$lILlI1L["pricing_amount_".$this->cms->VarsPost[I9988]]; if ($vData[I9988]=="rent"){ $vData[I9979] =$vData[I9979] *$vData["rent_period"]; }$vData[I9981] =FormatMoney($this->cms, $vData[I9979],$this->lL1IlIL,2,2,false, false); $vData[I9990] =$this->cms->Gui->get($this->moduleName."_subform:package_info", $vData); }}else{ $vData[I9986] =$this->words["add_balance"]; }if (empty($vData["contractor_type"])){ $vData["form"] =$this->cms->Gui->get($this->moduleName."_subform:contractor_not_defined", $vData); }else if (empty($vData["client_type"]) || empty($vData["client_name"])){ $lILlI11 =$this->cms->Core->GetModule('srv_host_payments_props'); $vData["props_href"] =$lILlI11->GetAdminLink(); $vData[I9991] =$this->cms->Gui->get($this->moduleName."_subform:payer_not_defined", $vData); }else if ($account[I9985]!="paid" && (empty($this->cms->VarsPost["id_sitemap"])&&(empty($this->cms->VarsPost["pay_method"])))){ $lILllII =Array(); ModuleHostSiteMaps::TIlTTTT($lILllII); foreach($lILllII as $key=>$value){ $value["pricing_amount_rent_str"] =FormatMoney($this->cms, $value["pricing_amount_rent"], $this->lL1IlIL,2,2,false, false); $value["pricing_amount_buy_str"] =FormatMoney($this->cms, $value["pricing_amount_buy"], $this->lL1IlIL,2,2,false, false); $vData["packages_list"] .= $this->cms->Gui->get($this->moduleName."_subform:package_row", $value); }$vData[I9991] =$this->cms->Gui->get($this->moduleName."_subform:select_package", $vData); }else if (($account[I9985]=="paid") && (!empty($vData[I9979]) && (intval($vData[I9979]) >0) && ($vData[I9979] <$vData[I9978]))){ $this->cms->AddStatusMsg('amount_less_than_minimal','red'); $vData[I9991] =$this->cms->Gui->get($this->moduleName."_subform:amount_form", $vData); }else{ if (!empty($vData[I9979]) && (intval($vData[I9979]) >0)){ $vData[I9981] =FormatMoney($this->cms, $vData[I9979],$this->lL1IlIL,2,2,false, false); if (!empty($vData["pay_method"])){ $vData["invoice_date"] =date($this->cms->DFMT["php"]); $db =&DB_si::admInstance(); $db->query("SELECT doc_num FROM cms_host_payments_docs WHERE doc_type=1 AND doc_num LIKE '".$IILll11."%' ORDER BY date DESC LIMIT 1"); $db->next_record(); $vData["invoice_num"] =$IILll11.(intval(str_replace($IILll11, "", $db->Record["doc_num"])) +1); if (isset($this->cms->VarsPost[I9988]) && $this->cms->VarsPost[I9988]=="buy"){ $vData[I9992] =$this->words["invoice_buy"]; }else{ $vData[I9992] =$this->words["invoice_rent"]; }$vData["service_description"] =$this->cms->Gui->get($this->moduleName."_subform:invoice_".$vData[I9993]."_descr_".$this->docsLang, $vData); $sql ="INSERT INTO cms_host_payments_docs SET ". "id_user='".$UserId."', ". I9994.$lILlIL1["contractor_id"]."', ". "id_client='".$lILlIL1["client_id"].I9995. "doc_type='1', ". "date=NOW(), ". "amount='".$vData[I9979].I9995. "amount_tax='".$vData[I9980].I9995. I9996.$vData["payment_type"].I9995. "note='".$vData["service_description"].I9995. "doc_num='".$vData[I9997].I9995. "ext_info='".addslashes(serialize($lILlIL1)).I9995. "tmp='1'"; $db->query($sql); $lILllIl =$db->lastInsertId(); $vData["invoice_id"] =$lILllIl; if ($vData[I9993] == "webmoney" || $vData[I9993] == I9998){ $vData["payment_info"] =$this->cms->Gui->get($this->moduleName."_subform:pay_form_".$vData[I9993]."_info", $vData); }$lILllIL =$this->cms->Core->GetModule('srv_host_payments_docs'); $vData[I9999] =$lILllIL->GetAdminLink(); $vData["id"] =$lILllIl; $vData["invoice"] =ModuleHostPaymentsDocs::TII1l11($this->cms, $lILllIl, true); $aName =explode(' ', $vData['client_name']); $vData[I10000] =$aName[1]; $vData['client_lastname'] =$aName[0]; $vData['Yahoo_USD_RUB_rate'] =(float)@file_get_contents($GLOBALS['SYS_PATH'] .'currencyRate.USD.RUB.txt'); $vData[I10001] =$this->cms->Gui->get($this->moduleName."_subform:pay_form_".$vData[I9993], $vData); require_once($GLOBALS["CLASSES_PATH"]."Mailer.php"); $oMail =new Mailer(); $oMail->SenderAddress =$vData["contractor_email"]; $oMail->SenderName =$vData[I10002]; $oMail->RecipientAddress =$vData["client_email"]; $oMail->RecipientName =$vData["client_name"]; $oMail->Subject =$this->cms->Gui->get($this->moduleName."_subform:invoice_mail_subj_".$this->docsLang, $vData); $I1IIILL["content"] =$this->cms->Gui->get($this->moduleName."_subform:invoice_mail_body_".$this->docsLang, $vData); $oMail->Body =$this->cms->Gui->get($this->moduleName."_subform:html_body_block_".$this->docsLang, $I1IIILL); $oMail->BodyFormat ="html"; if (!empty($vData["invoice"])){ $oMail->TIT11lI(); $I1IIILL["content"] =$vData[I10003]; $lILllI1 =$this->cms->Gui->get($this->moduleName."_subform:html_body_block_".$this->docsLang, $I1IIILL); $Il1LL1l ="bill.html"; $II11IIl[1]["ftype"]="text/html"; $II11IIl[1][I10004] =$Il1LL1l; $II11IIl[1]["original"] =$Il1LL1l; $II11IIl[1]["filename"] =$Il1LL1l; $II11IIl[1]["fbody"] =$lILllI1; $II11IIl[1]["fsize"] =mb_strlen($lILllI1); $II11IIl[1][I10005] ="ok"; $II11IIl[1]["fid"] ="FILEID".rand(10,99)."@".uniqid(I10006); $oMail->AddAttachments($II11IIl); }if(!empty($vData["client_email"])){ if($oMail->Send()){ $this->cms->AddStatusMsg("status_sent",I10006,I10006,I10006,Array("email"=>$oMail->RecipientAddress)); }else{ $this->cms->AddStatusMsg("status_failed",I10007,I10006,I10006,Array("email"=>$oMail->RecipientAddress)); }}$oMail->RecipientAddress =$vData["contractor_email"]; $oMail->Send(); }else{ $lILlllI =Array(); ModuleHostPaymentsProps::TII111I($lILlllI["props"]); foreach($lILlllI["props"] as $key => $value){ $vData[I10008.$key] =$value; }$vData[I9988] =$this->cms->VarsPost[I9988]; $vData["rent_period"] =$this->cms->VarsPost["rent_period"]; $vData[I9991] =$this->cms->Gui->get($this->moduleName."_subform:amount_static", $vData); $vData[I9991] .= $this->cms->Gui->get($this->moduleName."_subform:pay_form_method", $vData); }}else{ $vData[I9979] =$vData[I9978]; $vData[I9991] =$this->cms->Gui->get($this->moduleName."_subform:amount_form", $vData); }}$vData["subform"] =$this->cms->Gui->get($this->moduleName."_subform", $vData); }function TTTl1lI($cId, $cModule) {}}