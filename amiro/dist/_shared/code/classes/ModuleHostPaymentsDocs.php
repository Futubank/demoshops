<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       35449 xkqwxigrkyrgxsqwlktnzgznzkykmqggltpnzgipqynqpykilgrrytnqsxxtrpqmkkmtpnir
 */ ?><?php foreach(array(10009=>'zSIiHSuJQ`GOG',10010=>'iHSuJQoHDtgZBIQntDgrHGD`GOG',10011=>'wjzddqd|gzTo',10012=>'iHSuJQoHDtUDQrD`GOG',10013=>"PrHuG|HGQrZtMHnD",10014=>"QxGHrt",10015=>"",10016=>"PrG|QxGHrt",10017=>"OMSSQn",10018=>"fJt|SHIZMn",10019=>"fJt|DQZrWO",10020=>'QnWHSQoTij',10021=>"VDGJMttQr",10022=>"0",10023=>"fJt|DtZtuD",10024=>'fJt|DtZtuD',10025=>"1",10026=>"fJt|SHW|tBGQ",10027=>"fJt|VDGJMttQr3",10028=>"tBGQ|WZrS",10029=>"5",10030=>"tBGQ|QurHDQt",10031=>"8",10032=>"tBGQ|YZnK",10033=>"fJt|GZBDrW",10034=>'fJt|GZBDrW',10035=>"fJt|MS|rQDQJJQr",10036=>'',10037=>"JQPQnS",10038=>"JQP|QIZMJ",10039=>'WID|OHDt|uDQrD',10040=>"fJZPMWHn",10041=>"|JMDt%QSMt",10042=>"MS",10043=>"ZWtMHn|GrMnt",10044=>"|JMDt%MWHn|GrMnt",10045=>"SQJ|MS",10046=>"ZWtMHn",10047=>"fMQJSD",10048=>'IQtOHS',10049=>"ZWtMHn|QSMt",10050=>"ZWtMHnD",10051=>'WJMQnt|nZIQ',10052=>"|JMDt%OMDtHrB|urJ",10053=>"WJMQnt|nZIQ",10054=>"ZIHunt",10055=>"SHW|tBGQ",10056=>'GZBIQnt|tBGQ',10057=>"SZtQ",10058=>"'?zNs?SZtQ='",10059=>"UnZYJQ?tH?SQJQtQ",10060=>"SY",10061=>"WHntrZWtHr|nZIQ",10062=>"SHWuIQnt",10063=>"YMJJ|",10064=>"tIG",10065=>"!",10066=>"GZBIQnt|SHWD",10067=>"ZIHunt='",10068=>"nHtQ='",10069=>"'",10070=>"SHW|nuI",10071=>"WJMQnt|",10072=>"QIZMJ",10073=>"MnvHMWQ|SZtQ",10074=>"yMJJ`OtIJ",10075=>"HrMPMnZJ",10076=>"HK",10077=>"rQS",10078=>"SHW|SZtQ",10079=>"ZIHunt|tZx",10080=>"SHW|rHCD",10081=>"tHtZJ|tZx",10082=>'WHntrZWtHr|nZIQ',10083=>'WJMQnt|GZDDGHrt',10084=>'?',10085=>"GQrDHn",10086=>"ZWt|rHCD",10087=>"tMtJQ",10088=>"?") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} require_once $GLOBALS['CLASSES_PATH'] .I10009; require_once $GLOBALS['CLASSES_PATH'] .I10010; require_once $GLOBALS[I10011] .I10012; class ModuleHostPaymentsDocs extends AdmModule {public $lILIl1L; function ModuleHostPaymentsDocs(&$cms, &$db, &$cModule) {parent::AdmModule($cms,$db,$cModule); }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_format.php"); if($this->TTTTIIl()) {$IIIIL11[I10013] =Array("print", "del", "email", "book", I10014); }else{ $IIIIL11[I10013] =Array("print"); }$IIIIL11["lang_data"] =false; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin() {parent::_InitAdmin(); $IIIlLl1 =AdmModule::TTTTI1l($this->cms->Core); $this->lL1IlIL =$IIIlLl1['main_currency']; $lILIl11 =$this->cms->Core->GetModule('srv_host_payments_history'); $this->lILIl1L =$lILIl11->GetAdminLink(); }function TTTlTI1() {parent::TTTlTI1(); }function TTTlITT($IIIL11l, $cId, $cModule =I10015) {switch($IIIL11l) {case "email": $this->TII1l1T($cId); $this->redirect =false; break; case "grp_email": $this->TII1l1T($this->aGroupIds); $this->redirect =false; break; case "print": $this->TTll11I($cId); $this->redirect =false; break; case "grp_print": $this->TTll11I($this->aGroupIds); $this->redirect =false; break; case I10016: $this->TTTl11I($this->aGroupIds); $this->redirect =false; break; case "grp_book": $this->TII1ll1($this->aGroupIds); $this->redirect =false; break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function GetHtml(&$aCustom) {return parent::GetHtml($aCustom); }function TTTlIT1(&$aCustom, $cType ="small", $IIlLI11 =I10015, $IIlLlII ="_small") {return parent::TTTlIT1($aCustom, $cType, $IIlLI11, $IIlLlII); }function TTlTll1() {parent::TTlTll1(); }function TTTlIII() {parent::TTTlIII(); $this->filter->AddField("flt_mode", I10017, $this->cms->Vars["flt_mode"]); $this->filter->AddField("flt_Hsplitter1", "Hsplitter"); if($this->TTTTIIl() || $this->TTTTII1()) {$domain =stripslashes(unhtmlentities($this->cms->Vars["flt_domain"])); $this->cms->Filter->AddField(I10018, "text", $domain, I10015, " LIKE", "domain_orig"); }$doc_num =stripslashes(unhtmlentities($this->cms->Vars["flt_doc_num"])); $search =stripslashes(unhtmlentities($this->cms->Vars[I10019])); $this->cms->Filter->AddField("flt_doc_num", "text", $doc_num, I10015, " LIKE", "doc_num"); $this->cms->Filter->setExtraFieldParams(array (I10020 => false)); $this->cms->Filter->AddField(I10019, "text", $search, I10015, " LIKE", "pd.ext_info"); $this->cms->Filter->setExtraFieldParams(array ());$this->filter->AddField("flt_Vsplitter1", I10021); $this->filter->MoveField('flt_Vsplitter1',_MOVE_START); if($this->TTTTIIl() || $this->TTTTII1()) {$aStatus =Array(); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words["bill_0"]." / ".$this->words["invoice_0"]=>I10022), 45, false); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words["bill_1"]." / ".$this->words["invoice_1"]=>"1"), 45, false); $src =$this->cms->Vars[I10023]; if(!isset($src) || $src=='') {$src =Array(0, 1); }$this->filter->AddField(I10023, "select", $src, I10015, "LIKE", "pd.tmp", $aStatus, 1, 2); $this->filter->MoveField(I10024,_MOVE_START); $this->filter->AddField("flt_Hsplitter2", "Hsplitter"); $this->filter->MoveField('flt_Hsplitter2',_MOVE_START); $lILllll =Array(); $lILllll =$this->filter->TITI1TT($lILllll, Array($this->words["type_1"]=>I10025), 45, false); $lILllll =$this->filter->TITI1TT($lILllll, Array($this->words["type_2"]=>"2"), 45, false); $src =$this->cms->Vars["flt_doc_type"]; if(!isset($src) || $src=='') {$src =Array(1, 2); }$this->filter->AddField(I10026, "select", $src, I10015, "LIKE", "pd.doc_type", $lILllll, 1, 2); $this->filter->MoveField('flt_doc_type',_MOVE_START); $this->filter->AddField(I10027, I10021); $this->filter->MoveField('flt_Vsplitter3',_MOVE_START); $lILlllL =Array(); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words["type_unknown"]=>I10022), 45, false); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words["type_cash"]=>"2"), 45, false); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words[I10028]=>"3"), 45, false); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words["type_webmoney"]=>"4"), 45, false); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words["type_yandex"]=>I10029), 45, false); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words["type_qiwi"]=>"10"), 45, false); $lILlllL =$this->filter->TITI1TT($lILlllL, array($this->words['type_paypal'] => '11'), 45, FALSE); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words[I10030]=>"6"), 45, false); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words["type_terminals"]=>"7"), 45, false); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words["type_inner"]=>I10031), 45, false); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words["type_prepaidcard"]=>"9"), 45, false); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words["type_bonus"]=>"99"), 45, false); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words[I10032]=>I10025), 45, false); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words["type_hosting"]=>"101"), 45, false); $lILlllL =$this->filter->TITI1TT($lILlllL, Array($this->words["type_traffic"]=>"102"), 45, false); $src =$this->cms->Vars[I10033]; if(!isset($src) || $src=='') {$src =array(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 99, 101, 102); }$this->filter->AddField(I10033, "select", $src, I10015, "LIKE", "pd.payment_type", $lILlllL, 1, 5); $this->filter->MoveField(I10034,_MOVE_START); }if ($this->TTTTIIl()){ $lILILII =ModuleHostUsers::TIlTT1I(); $lILILIl =Array(); foreach($lILILII as $key=>$value){ $lILILIl =$this->filter->TITI1TT($lILILIl, Array($value["name"]=>$key), 45, false); }$lILILIl =$this->filter->TITI1TT($lILILIl, Array($this->words["all"]=>I10022), 45, false); $this->filter->AddField("flt_id_reseller", "select", $this->cms->Vars[I10035], I10015, "=", "hu.id_reseller", $lILILIl); if($this->cms->Vars[I10035] == I10022 || empty($this->cms->Vars[I10035])) {$this->filter->DisableFieldSql(I10035); }}$this->filter->AddField("flt_Vsplitter2", I10021); $this->filter->MoveField('flt_Vsplitter2',_MOVE_START); }function _ApplyFilters($prefix =I10036, $bodyType =I10036, $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); return $res; }function TTTlI1T(&$aCustom) {return parent::TTTlI1T($aCustom); }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); }function &TTTlTIT() {return DB_si::admInstance(); }function TTTlI11(&$vData, &$aCustom) {$sql =" hu.domain_orig, pd.id, pd.doc_type, pd.date as date_orig, DATE_FORMAT(pd.date,'".$this->cms->DFMT["db"]."') AS date, ". "SUM(pd.amount) as amount, SUM(pd.amount_tax) as amount_tax, pd.payment_type, pd.doc_num, pd.note, pd.ext_info, pd.tmp "; $from ="FROM cms_host_payments_docs pd LEFT JOIN cms_host_users hu ON hu.id=pd.id_user"; if ($this->TTTTII1()){ $lILILIL ="AND hu.id_reseller='".$this->TTTTIlI()."' "; }if($this->TTTTIIl() || $this->TTTTII1()) {$this->browser->InitSQL($sql, $from, "WHERE 1 ".$lILILIL .$this->_ApplyFilters().$this->TTTlIl1(), "date DESC, pd.doc_num, doc_type",I10015,I10015 ,array() );$aCustom[I10037] =Array("leg_blue", "leg_edit","leg_print", "leg_del", I10038); $aCustom["form_data"]["buttons"] =Array("apply", "cancel"); }else{ $this->browser->InitSQL($sql, $from, "WHERE ((pd.doc_type='2' AND pd.tmp='0') OR pd.doc_type!='2') AND pd.id_user='".$this->TTTTIlI()."' ".$this->_ApplyFilters().$this->TTTlIl1(), "pd.date DESC, pd.doc_num, pd.doc_type",I10015,I10015 ,array() );$aCustom[I10037] =Array("leg_print"); }$this->browser->AddSQLJoinedTables($this->cms->Core,'pd', array(I10039=>'hu')); $aCustom["fields"] += Array( "action_edit"=>Array("action"=>I10040, "value"=>I10015, "id"=>"edit_id", "on"=>$this->moduleName.I10041,"off"=>I10015), "action_email"=>Array("action"=>I10040, "value"=>I10015, I10042=>"email_id", "on"=>$this->moduleName."_list:icon_email","off"=>I10015), I10043=>Array("action"=>I10040, "value"=>I10015, I10042=>"print_id", "on"=>$this->moduleName.I10044,"off"=>I10015), "action_del"=>Array("action"=>I10040, "value"=>I10015, I10042=>I10045, "on"=>$this->moduleName."_list:del","off"=>I10015), "action_empty"=>Array(I10046=>I10040, "value"=>I10015, I10042=>I10015, "on"=>$this->moduleName."_list:icon_del","off"=>I10015) );$aCustom[I10047] += Array( 'name'=>array('action'=>'callback','object'=>&$this,I10048=>'CBRow') );$aCustom["applied_id"] ="pd.id"; parent::TTTlI11($vData, $aCustom); }function CBRow(&$aItem,&$aData) {if($this->TTTTIIl()) {$aItem["actions"] =$aItem[I10049].$aItem[I10043].$aItem["action_email"]; if ($aItem["tmp"]==I10025){ $aItem["actions"] .= $aItem["action_del"]; }else{ $aItem[I10050] .= $aItem["action_empty"]; }}else{ $aItem[I10050] =$aItem[I10043]; }$Il11L1l =unserialize($aItem["ext_info"]); $link =array('history_href'=>"$this->lILIl1L?flt_search_domain=".$aItem['domain_orig'], I10051 => $Il11L1l["client_name"], 'domain' => $aItem['domain_orig']); $aItem['history_url'] =$this->cms->Gui->get($this->moduleName.I10052,$link); $aItem["document"] =$this->words["type_".$aItem["doc_type"]]; $aItem["client_name"] =$Il11L1l[I10053]; $aItem["client_inn"] =$Il11L1l["client_inn"]; $aItem["contractor_name"] =$Il11L1l["contractor_name"]; $aItem[I10054] =FormatMoney($this->cms, $aItem[I10054],$this->lL1IlIL,2,2,true,false); if ($aItem["doc_type"]==I10025){ $aItem["status"] =$this->words["bill_".$aItem["tmp"]]; }else if($aItem[I10055]=="2"){ $aItem["status"] =$this->words["invoice_".$aItem["tmp"]]; }$vMod =&$this->cms->Core->GetModule("srv_host_payments_history"); $src =$vMod->GetProperty('payment_types'); if ($aItem['payment_type'] <100){ $aItem['payment_type'] =$this->words['type_'.$src[$aItem[I10056]]]; }else{ $aItem[I10056] =$this->words['type_hosting']; }}function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); }function TTTl1T1($cId, $cModule) {parent::TTTl1T1($cId, $cModule); }function _ActionDel($cId, $cModule) {if(!$this->TTTTIIl()) return; $sql ="SELECT tmp, doc_num, doc_type, date FROM cms_host_payments_docs WHERE id='".$cId."'"; $this->db->query($sql); if ($this->db->next_record()){ $lILlll1 =$this->db->Record["doc_num"]; $lILllLI =$this->db->Record[I10055]; $lILllLl =$this->db->Record[I10057]; if ($this->db->Record["tmp"]=='1'){ $sql ="SELECT id FROM cms_host_payments_docs WHERE doc_num='".$lILlll1."' AND doc_type='".$lILllLI.I10058.$lILllLl."'"; $this->db->query($sql); while($this->db->next_record()){ $lILllLL .= (empty($lILllLL)?I10015:", ").$this->db->Record[I10042]; }if ($lILllLI==1){ $sql ="UPDATE cms_host_payments_history SET id_bill='0' WHERE id_bill in (".$lILllLL.")"; }else{ $sql ="UPDATE cms_host_payments_history SET id_invoice='0' WHERE id_invoice in (".$lILllLL.")"; }$this->db->query($sql); $sql ="DELETE FROM cms_host_payments_docs WHERE id in (".$lILllLL.")"; $this->db->query($sql); $this->SetLastError(); $this->cms->AddStatusMsg("status_del"); }else{ $this->SetLastError(1, I10059); $this->cms->AddStatusMsg("status_unable_to_delete", "red", I10015, I10015, Array("num"=>$lILlll1)); }}}function TTTl1Tl($cId, $cModule) {if(!$this->TTTTIIl()) return; $sql ="SELECT doc_num, ext_info, date as date_orig, DATE_FORMAT(date,'".$this->cms->DFMT[I10060]."') as date, doc_type, tmp, ext_info, payment_type FROM cms_host_payments_docs WHERE id='".$cId."'"; $this->db->query($sql); if($this->db->next_record()){ $aExtInfo =unserialize($this->db->Record["ext_info"]); $this->itemData[I10042] =$cId; $this->itemData[I10053] =$aExtInfo[I10053]; $this->itemData["contractor_name"] =$aExtInfo[I10061]; $this->itemData["doc_num"] =$this->db->Record["doc_num"]; $this->itemData["doc_num"] =$this->db->Record["doc_num"]; $this->itemData[I10062] =$this->words["type_".$this->db->Record[I10055]]; $this->itemData[I10057] =$this->db->Record[I10057]; $this->itemData[I10055] =$this->db->Record[I10055]; $this->itemData["tmp"] =$this->db->Record["tmp"]; if ($this->itemData[I10055]==I10025){ $this->itemData["status"] =$this->words[I10063.$this->itemData["tmp"]]; }else if($this->itemData[I10055]=="2"){ $this->itemData["status"] =$this->words["invoice_".$this->itemData[I10064]]; }$vMod =&$this->cms->Core->GetModule("srv_host_payments_history"); $src =$vMod->GetProperty('payment_types'); if ($this->db->Record[I10056] <100){ $this->itemData[I10056] =$this->words['type_'.$src[$this->db->Record[I10056]]]; }else{ $this->itemData[I10056] =$this->words['type_hosting']; }$sql ="SELECT id, amount, amount_tax, note FROM cms_host_payments_docs WHERE doc_num='".$this->db->Record["doc_num"]."' AND doc_type='".$this->db->Record[I10055].I10058.$this->db->Record["date_orig"]."'"; $this->db->query($sql); while($this->db->next_record()){ if ($lILllL1!=I10015){ $lILllL1 .=I10065; }$lILllL1 .= $this->db->Record[I10042]; $this->itemData["doc_list"] .= $this->cms->Gui->get("srv_host_payments_docs_subform:doc_item", $this->db->Record); }}if ($this->itemData[I10055] == 1){ $sql ="SELECT payment_num, DATE_FORMAT(date,'".$this->cms->DFMT[I10060]."') AS date FROM cms_host_payments_history WHERE id_bill in (".$lILllL1.") GROUP BY id_payment"; }else{ $sql ="SELECT payment_num, DATE_FORMAT(date,'".$this->cms->DFMT[I10060]."') AS date FROM cms_host_payments_history WHERE id_invoice in (".$lILllL1.") GROUP BY id_payment"; }$this->db->query($sql); while($this->db->next_record()){ $this->itemData["payment_docs"] .= ($this->itemData[I10066]!=I10015)?", ":I10015.$this->db->Record["payment_num"]; }}function TTTl1lI($cId, $cModule) {if(!$this->TTTTIIl()) return; for ($i=0;$i<sizeof($this->cms->VarsPost["doc_id"]); $i++){ $sql ="UPDATE cms_host_payments_docs SET ". I10067.$this->cms->VarsPost[I10054][$i]."', ". "amount_tax='".$this->cms->VarsPost["amount_tax"][$i]."', ". I10068.$this->cms->VarsPost["note"][$i]."' ". "WHERE id='".$this->cms->VarsPost["doc_id"][$i].I10069; $this->db->query($sql); }$this->cms->AddStatusMsg('document_updated','blue'); $this->appliedId =$cId; $this->browser->SetApplied($this->db, $asql, $this->langData); }function TTT1IlI($aSql =Array(), $cId =0) {$aSql =parent::TTT1IlI($aSql, $cId, true); return $aSql; }function TTll11I($cId) {if($this->TTTTIIl()) {$html =$this->TII1l11($this->cms, $cId, false); }else{ $html =$this->TII1l11($this->cms, $cId); }echo $html; $GLOBALS["conn"]->Out(); die(); }function TTTl11I($cId) {if($this->TTTTIIl()) {$html =$this->TII1l11($this->cms, $cId, false, 'templates/_payments_docs_export.tpl'); }else{ $html =$this->TII1l11($this->cms, $cId, true, 'templates/_payments_docs_export.tpl'); }Header("Content-disposition: filename=export.txt"); Header("Content-type: application/octet-stream"); echo $html; die(); }function TII1ll1(&$cId) {if (!is_array($cId)){ $cId =Array($cId); }$lILll1I =$cId; $lILll1l =0; foreach($lILll1I as $lILll1L=>$lILll11){ $sql ="SELECT doc_num, date FROM cms_host_payments_docs WHERE doc_type='2' AND tmp='1' AND id='".$lILll11.I10069; $this->db->query($sql); if ($this->db->next_record()){ $sql ="UPDATE cms_host_payments_docs SET tmp='0' WHERE doc_type='2' AND doc_num='".$this->db->Record[I10070].I10058.$this->db->Record[I10057].I10069; $this->db->query($sql); $lILll1l++; }else{ unset($cId[$lILll1L]); }}if($lILll1l >0){ $this->cms->AddStatusMsg("status_book"); }$this->TII1l1T($cId); }function TII1l1T($cId) {if (!is_array($cId)){ $cId =Array($cId); }foreach($cId as $key=>$value){ $sql ="SELECT *, DATE_FORMAT(date,'".$this->cms->DFMT[I10060]."') AS date FROM cms_host_payments_docs WHERE id='".$value.I10069; $this->db->query($sql); if ($this->db->next_record()){ $lILlLII =$this->db->Record; $lILllLI =$lILlLII [I10055]; $aCustomerInfo =Array(); $lILlLIl =Array(); ModuleHostPaymentsProps::TII111I($aCustomerInfo, $lILlLII["id_client"]); foreach($aCustomerInfo as $lILlLIL => $lILlLI1){ $lILlLII[I10071.$lILlLIL] =$lILlLI1; }ModuleHostPaymentsProps::TII111I($lILlLIl, $lILlLII["id_contractor"]); foreach($lILlLIl as $lILlLlI => $lILlLll){ $lILlLII["contractor_".$lILlLlI] =$lILlLll; }$lILlLlL =$this->TII1l11($this->cms, $value); if ($lILlLlL == false){ continue; }require_once($GLOBALS["CLASSES_PATH"]."Mailer.php"); $oMail =new Mailer(); $oMail->RecipientAddress =$aCustomerInfo[I10072]; $oMail->RecipientName =$aCustomerInfo["name"]; $oMail->SenderAddress =$lILlLIl[I10072]; $oMail->SenderName =$lILlLIl["name"]; $lILlLII["invoice_num"] =$lILlLII["act_num"] =$lILlLII[I10070]; $lILlLII[I10073] =$lILlLII["act_date"] =$lILlLII[I10057]; if ($lILllLI==1){ $oMail->Subject =$this->cms->Gui->get("payments_docs:invoice_mail_subj_".$this->cms->lang, $lILlLII); $ILLLIl1["content"] =$this->cms->Gui->get("payments_docs:invoice_mail_body_".$this->cms->lang, $lILlLII); $Il1LL1l =I10074; }else if($lILllLI == 2){ $oMail->Subject =$this->cms->Gui->get("payments_docs:act_mail_subj_".$this->cms->lang, $lILlLII); $ILLLIl1["content"] =$this->cms->Gui->get("payments_docs:act_mail_body_".$this->cms->lang, $lILlLII); $Il1LL1l ="Invoice.html"; }$oMail->Body =$this->cms->Gui->get("payments_docs:html_body_block_".$this->cms->lang, $ILLLIl1); $oMail->BodyFormat ="plain"; $II11IIl[1]["ftype"]="HTML"; $II11IIl[1]["friendly"] =$Il1LL1l; $II11IIl[1][I10075] =$Il1LL1l; $II11IIl[1]["filename"] =$Il1LL1l; $II11IIl[1]["fbody"] =$lILlLlL; $II11IIl[1]["fsize"] =mb_strlen($lILlLlL); $II11IIl[1]["status"] =I10076; $II11IIl[1]["fid"] ="FILEID".rand(10,99)."@".uniqid(I10015); $oMail->AddAttachments($II11IIl); $lILlLl1 =0; $lILlLLI =0; if(!$oMail->Send()){ $this->cms->AddStatusMsg("status_email_failed",I10077,I10015,I10015,Array(I10072=>$oMail->RecipientAddress, "doc"=> $lILlLII[I10070])); $lILlLl1++; }else{ $lILlLLI++; }}}if ($lILlLl1 >0){ if ($lILlLLI >0){ $this->cms->AddStatusMsg("status_email_sent"); }}else{ if ($lILlLLI >0){ $this->cms->AddStatusMsg("status_email_all_sent"); }else{ $this->cms->AddStatusMsg("status_no_email_sent", I10077); }}}function TII1l1I($lILlLLl) {$db =&DB_si::admInstance(); $sql ="SELECT * FROM cms_host_payments_docs hd WHERE doc_num = '". $lILlLLl.I10069; $db->query($sql); if ($db->next_record()){ $lILlLII =$db->Record; return $lILlLII; }else{ return false; }}function TII1l1l($ILL11lL) {$db =&DB_si::admInstance(); $sql ="SELECT * FROM cms_host_payments_docs hd WHERE id = '". $ILL11lL.I10069; $db->query($sql); if ($db->next_record()){ $lILlLII =$db->Record; return $lILlLII; }else{ return false; }}function TII1l11(&$cms, $aIds, $lILlLLL =true, $template ="templates/_payments_docs.tpl") {$lILlLL1 =($template === 'templates/_payments_docs_export.tpl') ?true :false; require_once $GLOBALS[I10011] .'ValueSpelledOut.php'; $lILlL1I =new ValueSpelledOut(); $db =&DB_si::admInstance(); if (!is_array($aIds)){ $aIds =Array($aIds); }$sql ="SELECT hd.id FROM cms_host_payments_docs hd, cms_host_payments_props hp WHERE hd.id_client = hp.id AND hd.id IN (". implode(I10065, $aIds) .") ORDER BY hp.name, hp.code"; $db->query($sql); $aIds =array(); while ($db->next_record()){ $aIds[] =$db->Record[I10042]; }foreach($aIds as $key=>$cId){ $lILllL1 =I10015; $sql ="SELECT doc_type, doc_num, date FROM cms_host_payments_docs WHERE id='".$cId.I10069; $db->query($sql); if ($db->next_record()){ $cms->Gui->addBlock('payments_docs', $template); $aWords =$cms->Gui->parseLangFile('templates/lang/_payments_docs.lng'); $form =Array(); $sql ="SELECT *, DATE_FORMAT(date,'".$cms->DFMT[I10060]."') AS date FROM cms_host_payments_docs WHERE doc_type='".$db->Record[I10055]."' AND doc_num='".$db->Record[I10070].I10058.$db->Record[I10057]."' ORDER BY note"; $db->query($sql); $lILlL1l =0; while ($db->next_record()){ if ($lILllL1!=I10015){ $lILllL1 .=I10065; }$lILllL1 .= $db->Record[I10042]; if (!isset($form[I10055])){ $form[I10055] =$db->Record[I10055]; $form =array_merge($form, unserialize($db->Record["ext_info"])); $form[I10070] =$db->Record[I10070]; $form[I10078] =$db->Record[I10057]; }$lILlL1l++; $row =Array(); $row["payment_type"] =$db->Record["payment_type"]; $row["service_num"] =$lILlL1l; $row["price"] =FormatNumber($db->Record[I10054] -$db->Record[I10079],2,2,true,false); $row["tax"] =$form["contractor_tax_value"]; $row["tax_value"] =FormatNumber($db->Record[I10079],2,2,true,false); $row["price_with_tax"] =FormatNumber($db->Record[I10054],2,2,true,false); $row["service_description"] =$db->Record["note"]; $form["total_price_with_tax"] += $db->Record[I10054]; $form["total_tax"] += $db->Record[I10079]; if ($form[I10055]==1){ if ($row["payment_type"]!=1){ $form[I10080] .= $cms->Gui->get("payments_docs:doc_bill_fake_row_".$cms->lang, $row); }else if ($form["client_type"]=="person"){ }else{ $form[I10080] .= $cms->Gui->get("payments_docs:doc_bill_company_row_".$cms->lang, $row); }}else if ($form[I10055]==2){ if ($form["contractor_tax_value"] >0){ $form[I10080] .= $cms->Gui->get("payments_docs:doc_sf_row_".$cms->lang, $row); }$form["act_rows"] .= $cms->Gui->get("payments_docs:doc_act_row_".$cms->lang, $row); }}$sql ="SELECT payment_num, DATE_FORMAT(date,'".$cms->DFMT[I10060]."') AS date FROM cms_host_payments_history WHERE id_invoice in (".$lILllL1.") GROUP BY id_payment"; $db->query($sql); while($db->next_record()){ $form[I10066] .= ($form[I10066]!=I10015)?", ":I10015.$db->Record["payment_num"]; }$form["total_price_with_tax_words"] =$lILlL1I->TlTTTll($form["total_price_with_tax"], $cms->lang); $form["total_price_with_tax_str"] =FormatMoney($cms, $form["total_price_with_tax"],$this->lL1IlIL, 2, 2, true, false); $form["total_tax_value"] =$form["total_tax"]; $form[I10081] =FormatNumber($form[I10081], 2, 2, true, false); $form["total_price_with_tax"] =FormatNumber($form["total_price_with_tax"], 2, 2, true, false); $form =array_merge($form, $row); $form["set_sign"] =($lILlLLL)?I10025:I10015; $form["builder_domain"] =AdmModule::TTTTI1I(); if ($lILlLL1) {$form[I10082] =preg_replace('/[\r\n]+/', ' ', $form[I10082]); $form[I10051] =preg_replace('/[\r\n]+/', ' ', $form[I10051]); $form[I10083] =preg_replace('/[\r\n]+/', ' ', $form[I10083]); $form['service_description'] =preg_replace('/[\r\n]+/', I10084, $form['service_description']); }if (isset($html["document_list"]) && mb_strlen($html["document_list"])>0){ $html["document_list"] .= $cms->Gui->getAbs("payments_docs:page_splitter"); }if ($form[I10055]==1){ if ($form["payment_type"]!=1){ $html["document_list"] .= $cms->Gui->get("payments_docs:doc_bill_fake_body_".$cms->lang, $form); }else if ($form["client_type"]==I10085){ $html["document_list"] .= $cms->Gui->get("payments_docs:doc_bill_person_".$cms->lang, $form); }else{ $html["document_list"] .= $cms->Gui->get("payments_docs:doc_bill_company_body_".$cms->lang, $form); }}else if ($form[I10055]==2){ if ($form["contractor_tax_value"] >0){ $html["document_list"] .= $cms->Gui->get("payments_docs:doc_sf_body_".$cms->lang, $form); $html["document_list"] .= $cms->Gui->getAbs("payments_docs:page_splitter"); }$form[I10080] =$form[I10086]; $html["document_list"] .= $cms->Gui->get("payments_docs:doc_act_body_".$cms->lang, $form); }}else{ return false; }}if (sizeof($aIds)>1){ $html["title"] =$aWords["print_documents"]; }else{ $html[I10087] =$aWords["type_".$form[I10055]]." ".$form[I10070]." ".$aWords["from"].I10088.$form[I10078]; }$html['meta'] =$cms->Gui->getMeta('content-type'); $html =$cms->Gui->get("payments_docs:body", $html); return $html; }}?>