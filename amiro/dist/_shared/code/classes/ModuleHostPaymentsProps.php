<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       25697 xkqwyxxnzxniwkxugnizpzgpwplnnszxinitnwguwtqmrlpstpwrwqnuimqytqsplurspnir
 */ ?><?php foreach(array(10200=>'zSIiHSuJQ`GOG',10201=>'iHSuJQoHDtUDQrD`GOG',10202=>"",10203=>"ZSS",10204=>"'?",10205=>"|DIZJJ",10206=>"fJt|IHSQ",10207=>"u`SHIZMn|HrMP",10208=>"?jmkq",10209=>"fJt|DQZrWO",10210=>'SZtQ|nHC',10211=>'WID|OHDt|uDQrD',10212=>"fJZPMWHn",10213=>"Hn",10214=>"ZWtMHn",10215=>"Hff",10216=>"|JMDt%SQJ",10217=>"fMQJSD",10218=>'IQtOHS',10219=>"HnZWtMvQ",10220=>"fHrI|SZtZ",10221=>"DuYfHrI",10222=>"1",10223=>'MS',10224=>'"',10225=>"'",10226=>'YJuQ',10227=>"ZWtMvQ",10228=>'',10229=>"GOG",10230=>"GrHGD|",10231=>"MS|uDQr",10232=>"nuI",10233=>"WOZnPQD",10234=>"iZMJQr`GOG",10235=>"^",10236=>'GrHGD|nHt|WOZnPQS',10237=>"DtZtuD|ZWtMvZtQ",10238=>"'?jmimT?1",10239=>"nZIQ",10240=>"ZSSrQDD|GHDt",10241=>"GOHnQ",10242=>"Qxt|MnfH",10243=>"|",10244=>"MS",10245=>"'?hRsqR?yb?nZIQ",10246=>"tBGQ",10247=>"GHDt|ZSSrQDD",10248=>"QIZMJ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} require_once $GLOBALS['CLASSES_PATH'] .I10200; require_once $GLOBALS['CLASSES_PATH'] .I10201; class ModuleHostPaymentsProps extends AdmModule {function ModuleHostPaymentsProps(&$cms, &$db, &$cModule) {parent::AdmModule($cms,$db,$cModule); }function _Init($IIll1l1 =Array(), $IIll1LI =I10202, $IIll1Ll =I10202, $aOptions =Array()) {$IIIIL11["group_operations"] =Array(); $IIIIL11["lang_data"] =false; $aOptions += $IIIIL11; $this->docsLang =HOST_DOCS_LANG; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function ProcessAction($IIIL11l, $cId, $cModule ='') {$id =intval($cId); if (!empty($IIIL11l) && $IIIL11l!="none" && $IIIL11l!=I10203 && $IIIL11l!="rsrtme"){ if($this->TTTTII1()) {$lILLllL =" AND u.id_reseller='".$this->TTTTIlI()."' "; }else if(!$this->TTTTIIl()) {$lILLllL =" AND u.id='".$this->TTTTIlI().I10204; }$db =&$this->TTTlTIT(); $sql ="SELECT p.id FROM cms_host_payments_props p, cms_host_users u WHERE p.id_user=u.id AND p.id='".$cId."'".$lILLllL; $db->query($sql); if (!$db->next_record()){ trigger_error("SECURITY: attempt to perform action [$IIIL11l] on properties [$cId], domain=".$this->TTTTIlT(),E_USER_WARNING); return; }}switch ($IIIL11l) {case "activate": $this->_ActionActivate($cId, $cModule); break; default: parent::ProcessAction($IIIL11l, $cId, $cModule); break; }}function _InitAdmin() {parent::_InitAdmin(); }function TTTlTI1() {parent::TTTlTI1(); }function TTTlITT($IIIL11l, $cId, $cModule =I10202) {parent::TTTlITT($IIIL11l, $cId, $cModule); }function GetHtml(&$aCustom) {return parent::GetHtml($aCustom); }function TTTlIT1(&$aCustom, $cType ="small", $IIlLI11 =I10202, $IIlLlII =I10205) {return parent::TTTlIT1($aCustom, $cType, $IIlLI11, $IIlLlII); }function TTlTll1() {parent::TTlTll1(); }function TTTlIII() {$this->filter->TITI1l1("dateto"); $this->filter->TITI1l1("datefrom"); parent::TTTlIII(); $this->filter->AddField("flt_mode", "hidden", $this->cms->Vars[I10206]); if($this->TTTTII1() || $this->TTTTIIl()) {$domain =stripslashes(unhtmlentities($this->cms->Vars["flt_domain"])); $this->cms->Filter->AddField("flt_domain", "text", $domain, I10202, " LIKE", I10207); $this->cms->Filter->MoveField("flt_domain", _MOVE_PREV); }$search =stripslashes(unhtmlentities($this->cms->Vars["flt_search"])); $this->cms->Filter->AddField("flt_search", "text", $search, I10202, I10208, "p.name"); $this->cms->Filter->TITI1II("flt_search"," OR p.name LIKE '%".addslashes($search)."%' OR p.code LIKE '%".addslashes($search)."%' OR p.email LIKE '%".addslashes($search)."%' OR p.ext_info LIKE '%".addslashes($search)."%'"); $this->cms->Filter->MoveField("flt_search", _MOVE_PREV); if(empty($search) || $search==''){ $this->cms->Filter->DisableFieldSQL(I10209); }}function _ApplyFilters($prefix ='', $bodyType ='', $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); return $res; }function &TTTlI1T(&$aCustom) {return parent::TTTlI1T($aCustom); }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); $vData['action'] ='add'; $vData[I10210] =date($this->cms->DFMT["php"]); }function &TTTlTIT() {return DB_si::admInstance(); }function TTTlI11(&$vData, &$aCustom) {if($this->TTTTII1()) {$lILLllL =" AND u.id_reseller='".$this->TTTTIlI().I10204; }else if(!$this->TTTTIIl()) {$lILLllL =" AND u.id='".$this->TTTTIlI().I10204; }$sql =" u.domain_orig, p.id, p.active, p.active AS is_active, p.type, p.name, p.code, p.address, p.address_post, p.address_consignee, p.phone, p.fax, p.email, p.ext_info, p.bank_info "; $from ="from cms_host_payments_props p, cms_host_users u "; $this->browser->InitSQL($sql, $from, "WHERE p.id_user=u.id ".$lILLllL.$this->_ApplyFilters().$this->TTTlIl1(), I10202,"name","name ASC" ,array() );$this->browser->AddSQLJoinedTables($this->cms->Core,'p',array( I10211=>'u')); $aCustom["fields"] += Array( "active"=>Array("action"=>I10212, "value"=>"1", "id"=>"act_id", I10213=>$this->moduleName."_list:active_on","off"=>$this->moduleName."_list:active_off"), "action_edit"=>Array(I10214=>I10212, "value"=>I10202, "id"=>"edit_id", I10213=>$this->moduleName."_list:edit",I10215=>I10202), "action_del"=>Array(I10214=>I10212, "value"=>I10202, "id"=>"del_id", I10213=>$this->moduleName.I10216,I10215=>I10202), "action_empty"=>Array(I10214=>I10212, "value"=>I10202, "id"=>I10202, I10213=>$this->moduleName."_list:icon_del",I10215=>I10202) );$aCustom[I10217] += Array( 'name'=>array('action'=>'callback','object'=>&$this,I10218=>'CBRow') );$aCustom["applied_id"] ="p.id"; $aCustom["legend"] =Array(I10219, "notactive", "leg_blue", "leg_edit", "leg_del"); $aCustom[I10220]["buttons"] =Array(I10203, "apply", "cancel"); parent::TTTlI11($vData, $aCustom); $vData["host_user"] =$this->TTTTIIl() ?1 :0; $vData[I10221] =$this->cms->Gui->get($this->moduleName."_subform:prop_form_".$this->docsLang, $vData); }function CBRow(&$aItem,&$aData) {global $ADMIN_PATH_WWW; $links["edit_id"] =$aItem['id']; if ($aItem["is_active"]==I10222){ $aItem["actions"] =$aItem["action_edit"].$aItem["action_empty"]; }else{ $links["del_id"] =$aItem[I10223]; $aItem["actions"] =$aItem["action_edit"].$aItem["action_del"]; }}function TTTll11($cId, $cModule) {foreach($this->cms->VarsPost as $key=>$value){ if(mb_substr($key, 0, 6)=="props_"){ $lILLll1[mb_substr($key, 6)] =str_replace(I10224, "'", trim(stripslashes(unhtmlentities($value)))); }else if (mb_substr($key, 0, 4)=="ext_"){ $I1LILLL[mb_substr($key, 4)] =str_replace(I10224, "'", trim(stripslashes(unhtmlentities($value)))); }else if (mb_substr($key, 0, 5)=="bank_"){ $lILLlLI[mb_substr($key, 5)] =str_replace(I10224, I10225, trim(stripslashes(unhtmlentities($value)))); }}if($this->TII11lI($lILLll1, $I1LILLL, $lILLlLI, 0, true, $this->TTTTIlI())){ $this->cms->AddStatusMsg('props_added','blue'); $this->cms->AddStatusMsg("status_activate"); $this->cms->AddStatusMsg('go_to_add_payment', I10226); }else{ $this->cms->AddStatusMsg('props_not_added','red'); }}function TTTl1T1($cId, $cModule) {parent::TTTl1T1($cId, $cModule); }function _ActionDel($cId, $cModule) {$db =&$this->TTTlTIT(); $sql ="SELECT p.active, p.name FROM cms_host_payments_props p, cms_host_users u WHERE p.id_user=u.id AND p.id='".$cId.I10225; $db->query($sql); if ($db->next_record()){ $lILl1IL =$db->Record["name"]; if ($db->Record[I10227]==1){ $this->cms->AddStatusMsg('props_active_not_deleted','red'); }else{ $lILLlLl =$this->TII11lT($cId); if ($lILLlLl){ $this->cms->AddStatusMsg('props_not_deleted','red', I10228, I10228, Array("name"=>$lILl1IL)); }else{ $sql ="DELETE FROM cms_host_payments_props WHERE id='".$cId.I10225; $db->query($sql); $this->cms->AddStatusMsg('props_deleted',I10226, I10228, I10228, Array("name"=>$lILl1IL)); }}}}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $IIII11I =Array(); $this->TII111I($IIII11I, $cId); $this->itemData =array_merge($this->itemData, $IIII11I); $this->itemData[I10210] =date($this->cms->DFMT[I10229]); $this->itemData["read_only"] =($this->TII11lT($cId))? 1 :0; if($this->TTTTIIl()) {$this->itemData["host"] =($this->TII111T($cId)==$this->TTTTIlI()) ?1 :0; }$vData['action'] ='apply'; }function TTTl1lI($cId, $cModule) {$lILLlLI =array(); foreach($this->cms->VarsPost as $key=>$value){ if(mb_substr($key, 0, 6)==I10230){ $lILLll1[mb_substr($key, 6)] =str_replace(I10224, I10225, trim(stripslashes(unhtmlentities($value)))); }else if (mb_substr($key, 0, 4)=="ext_"){ $I1LILLL[mb_substr($key, 4)] =str_replace(I10224, I10225, trim(stripslashes(unhtmlentities($value)))); }else if (mb_substr($key, 0, 5)=="bank_"){ $lILLlLI[mb_substr($key, 5)] =str_replace(I10224, I10225, trim(stripslashes(unhtmlentities($value)))); }}$IIII11I =$lILLll1; $IIII11I["id"] =$cId; $IIII11I =array_merge($IIII11I, $I1LILLL); $IIII11I =array_merge($IIII11I, $lILLlLI); $db =&$this->TTTlTIT(); $sql ="SELECT p.id_user, u.domain_orig FROM cms_host_payments_props p, cms_host_users u WHERE p.id_user=u.id AND p.id='".$cId.I10225; $db->query($sql); $db->next_record(); $lILILlL =$db->Record[I10231]; $lILILLL =$db->Record["domain_orig"]; $this->TII111I($lILLlLL, $cId); if($this->TII11lI($lILLll1, $I1LILLL, $lILLlLI, $cId)){ $this->cms->AddStatusMsg('props_changed',I10226); $dateFrom =$this->cms->VarsPost["update_docs_date"]; $lILll1l =$this->TII11ll($cId, $dateFrom); if ($lILll1l >0){ $this->cms->AddStatusMsg('props_updated_in_docs',I10226, I10228, I10228, Array(I10232 => "$lILll1l")); }$this->cms->AddStatusMsg('go_to_add_payment', I10226); foreach($lILLlLL as $key=>$value){ if ($IIII11I[$key] != $lILLlLL[$key]){ $lILLlL1["name"] =$key; $lILLlL1["new_value"] =$IIII11I[$key]; $lILLlL1["old_value"] =$lILLlLL[$key]; $lILILL1[I10233] .= $this->cms->Gui->get("srv_host_notifications:props_mail_change_row_".$this->langData, $lILLlL1); }$IIII11I[$key] =str_replace(I10224, I10225, trim(stripslashes(unhtmlentities($value)))); }$lILILL1["date"] =$dateFrom; if($lILILL1[I10233]!=I10202){ $IIIlLl1 =AdmModule::TTTTI1l($this->cms->Core); $ILLLlIl =$IIIlLl1['bill_admin_email']; require_once($GLOBALS["CLASSES_PATH"].I10234); $oMail =new Mailer(); $oMail->SenderAddress =$this->cms->Core->GetOption('company_email'); $oMail->SenderName =$this->cms->Core->GetOption("company_name"); $oMail->Subject =$this->cms->Gui->getAbs("srv_host_notifications:props_mail_subj_".$this->langData, Array("domain"=>$lILILLL)); $oMail->Body =$this->cms->Gui->get("srv_host_notifications:props_mail_body_".$this->langData, $lILILL1); $oMail->BodyFormat ="html"; $oMail->Prepare(); $oMail->RecipientAddress =$IIII11I["email"]; if ($IIII11I["email"] != $lILLlLL["email"]){ $oMail->RecipientAddress .= I10235.$lILLlLL["email"]; }$oMail->Send(); ModuleHostUsers::TIlTT1T($this->cms,$ILLLlIl, $lILILlL, Array('subject'=>$oMail->Subject,'body'=>$oMail->Body,'lang'=>$this->docsLang)); }}else{ $this->cms->AddStatusMsg(I10236,'red'); }$this->appliedId =$cId; $this->browser->SetApplied($db, $asql, $this->langData); }function _ActionActivate($cId, $cModule) {if(isset($this->cms->VarsGet["activate"]) && $this->cms->VarsGet["activate"] == I10213) $active =I10222; else $active ="0"; if ($this->TII111l($cId, $active)){ $this->cms->AddStatusMsg(I10237); }else{ $this->cms->AddStatusMsg("status_activate_fail", "red"); }$this->appliedId =$cId; $this->browser->SetApplied($db, $asql, $this->langData); }function TTT1IlI($aSql =Array(), $cId =0) {$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TII11lT($cId){ $db =&$this->TTTlTIT(); $sql ="SELECT id FROM cms_host_payments_history WHERE id_contractor='".$cId."' OR id_client='".$cId.I10238; $db->query($sql); $lILLlLl =$lILLlLl |$db->next_record(); $sql ="SELECT id FROM cms_host_payments_docs WHERE id_contractor='".$cId."' OR id_client='".$cId.I10238; $db->query($sql); $lILLlLl =$lILLlLl |$db->next_record(); return $lILLlLl; }function TII11lI(&$lILLll1, &$I1LILLL, &$lILLlLI, $cId =0, $lILLl1I=false, $lILILlL =0){ $db =&DB_si::admInstance(); $aSql =Array( "type" => addslashes($lILLll1["type"]), I10239 => addslashes($lILLll1[I10239]), "code" => addslashes($lILLll1["inn"]), "address" => addslashes($lILLll1["address"]), I10240 => addslashes($lILLll1["post_address"]), "address_consignee" => addslashes($lILLll1["fiz_address"]), "phone" => addslashes($lILLll1[I10241]), "fax" => addslashes($lILLll1["fax"]), "email" => addslashes($lILLll1["email"]), I10242 => addslashes(serialize($I1LILLL)), "bank_info" => addslashes(serialize($lILLlLI)) );if ($cId == 0){ if ($lILILlL==0){ $db->query("SELECT id FROM cms_host_users WHERE domain_orig='".BUILDER_DOMAIN.I10225); $db->next_record(); $lILILlL =$db->Record["id"]; }if ($lILLl1I){ $aSql[I10231] =$lILILlL; $sql =$db->GenInsertSQL("cms_host_payments_props", $aSql); }else{ $sql =$db->GenUpdateSQL("cms_host_payments_props", $aSql, "WHERE active=1 AND id_user='".$lILILlL.I10225); }}else{ $sql =$db->GenUpdateSQL("cms_host_payments_props", $aSql, "WHERE id='$cId'"); }$result =$db->query($sql); if ($lILLl1I){ $cId =$db->lastInsertId(); ModuleHostPaymentsProps::TII111l($cId, 1); }return $result; }function TII11ll($cId, $dateFrom){ $db =&$this->TTTlTIT(); $aTypes =Array("client", "contractor"); $this->TII111I($IIII11I, $cId); $lILll1l =0; foreach($aTypes as $lILLl1l=>$lILLl1L){ unset($aInfo); foreach($IIII11I as $key => $value){ $aInfo[$lILLl1L.I10243.$key] =$value; }$sql ="SELECT id, ext_info FROM cms_host_payments_docs WHERE id_".$lILLl1L."='".$cId."' AND date>='".DateTools::toMysqlDate(DateTools::getCorrectUDate($dateFrom, $this->cms->DFMT["conf"])).I10225; $db->query($sql); $lILLl11 =Array(); while ($db->next_record()){ $aExtInfo =unserialize($db->Record[I10242]); $aExtInfo =array_merge($aExtInfo, $aInfo); $lILLl11[] =Array(I10244=>$db->Record[I10244], I10242=>$aExtInfo); }foreach($lILLl11 as $key=>$value){ $sql ="UPDATE cms_host_payments_docs SET ext_info='".addslashes(serialize($value[I10242]))."' WHERE id='".$value[I10244].I10225; $db->query($sql); $lILll1l++; }}return $lILll1l; }function TII11l1(&$vData){ $db =&DB_si::admInstance(); $db->query("SELECT id FROM cms_host_users WHERE domain_orig='".BUILDER_DOMAIN.I10225); $db->next_record(); $lILILlL =$db->Record[I10244]; $sql ="SELECT * FROM cms_host_payments_props WHERE  id_user='".$lILILlL.I10245; $db->query($sql); while($db->next_record()){ $vData[] =$db->Record; }}function TII111T($cId){ $db =&DB_si::admInstance(); $sql ="SELECT id_user FROM cms_host_payments_props WHERE id='".$cId.I10225; $db->query($sql); if ($db->next_record()){ return $db->Record[I10231]; }else{ return 0; }}function TII111I(&$vData, $cId =0, $lILILlL =0){ $db =&DB_si::admInstance(); if ($cId >0){ $sql ="SELECT * FROM cms_host_payments_props WHERE id='".$cId.I10225; }else{ if ($lILILlL==0){ $db->query("SELECT id FROM cms_host_users WHERE domain_orig='".BUILDER_DOMAIN.I10225); $db->next_record(); $lILILlL =$db->Record[I10244]; }$sql ="SELECT * FROM cms_host_payments_props WHERE active=1 AND id_user='".$lILILlL.I10225; }$db->query($sql); if ($db->next_record()){ $vData[I10244] =$db->Record[I10244]; $vData[I10246] =$db->Record[I10246]; $vData[I10239] =$db->Record[I10239]; $vData["inn"] =$db->Record["code"]; $vData["address"] =$db->Record["address"]; $vData[I10247] =$db->Record[I10240]; $vData["fiz_address"] =$db->Record["address_consignee"]; $vData[I10241] =$db->Record[I10241]; $vData["fax"] =$db->Record["fax"]; $vData[I10248] =$db->Record[I10248]; $ext_info =unserialize($db->Record[I10242]); if(is_array($ext_info)){ $vData =array_merge($vData, $ext_info); }$bank_info =unserialize($db->Record["bank_info"]); if(is_array($bank_info)){ $vData =array_merge($vData, $bank_info); }}return true; }function TII111l($cId, $active){ $sql ="SELECT active, id_user FROM cms_host_payments_props WHERE id='$cId'"; $db =&$this->TTTlTIT(); $db->query($sql); if($db->next_record()){ $lILILlL= $db->Record[I10231]; $sql ="UPDATE cms_host_payments_props SET active='0' where id_user='".$lILILlL.I10225; $db->query($sql); $sql ="UPDATE cms_host_payments_props SET active='$active' WHERE id='$cId'"; $db->query($sql); return true; }else {return false; }}}