<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       69874 xkqwllkguyqlksmxrxtkpmnkgnnmrinrrgzmrsgnqzgqiiiqgxqrtrmlmqngrnuumuqqpnir
 */ ?><?php foreach(array(10324=>'wjzddqd|gzTo',10325=>'zSIiHSuJQ`GOG',10326=>'iHSuJQoHDtgZBIQntDgrHGD`GOG',10327=>"ZSIMn",10328=>'IZx|DMtQD|2JQvQJ',10329=>'IZx|DMtQD',10330=>"?zNs?MS|rQDQJJQr='",10331=>'IZx|DMtQD|3JQvQJ',10332=>'rQS',10333=>"ZGGJB",10334=>"JZnP|SZtZ",10335=>'MS',10336=>'fJt|QIZMJ',10337=>"fJt|QIZMJ",10338=>"=",10339=>"tOMrS|JQvQJ",10340=>"0",10341=>'($',10342=>"'",10343=>"fJt|SHIZMn|tBGQ",10344=>"DtZtuD|ZWtMvQ",10345=>"DtZt|MS",10346=>"ZWtMvQ",10347=>"",10348=>"tBGQ|GZMS",10349=>"tBGQ|trMZJ",10350=>"trMZJ",10351=>"tBGQ|MS",10352=>"u`JMWQnWQ|tBGQ",10353=>"@=",10354=>"u`ftG|DtZtuD",10355=>"{",10356=>"fJt|SZQIHn|MPnHrQ",10357=>"fJt|MD|SQIH|DMtQ",10358=>"ZJJ",10359=>"fJt|MS|rQDQJJQr",10360=>"fJt|MS|nHSQ",10361=>"SZtQfrHI",10362=>"31`12`1979",10363=>"u`DtZtuD!?u`ZSIMn|DtZtuD!?u`JMWQnWQ|tBGQ!?",10364=>"u`QxG|SZQIHn|MPnHrQ!u`JMWQnWQ|QxG|SZtQ!?",10365=>"szTq|FhRizT}u`JMWQnWQ|QxG|SZtQ!?'",10366=>"SY",10367=>"'{?zd?JMWQnWQ|QxGMrQ!?",10368=>"u`MS",10369=>'JO',10370=>'WZJJYZWK',10371=>"JQPQnS",10372=>"JQP|SQJ",10373=>'OHDt',10374=>'eUqRb|dTRmNp',10375=>"|nuI|rHCD",10376=>'DMtQD',10377=>'rHC|JMIMtD',10378=>"SHIZMn",10379=>"ZJMZD|urJ",10380=>"SQJ|MS",10381=>'JMWQnWQ|tBGQ',10382=>'BQD',10383=>'GrHGD|urJ',10384=>" ZWtMHn=JHWZtQ]MS=",10385=>"GZBIQntD|SHWD|urJ",10386=>"DuDGQnS",10387=>"MS|rQDQJJQr",10388=>'ZWtMHnD',10389=>'ZSIMn|DtZtuD',10390=>"JZDt|JHPMn",10391=>"MS|nHSQ",10392=>"WHGB",10393=>'GZDDCHrS',10394=>'OttGD%~~',10395=>'uDQrnZIQ',10396=>"MS",10397=>"u`ZSIMn|DtZtuD!?u`JMWQnWQ|tBGQ!?u`ftG|DtZtuD!u`YZWKuG|Hn|SQJQtQ!u`SMDK|EuHtZ!?",10398=>"'{?ZD?JZDt|JHPMn?",10399=>"ZWtMHn",10400=>"JMWQnWQ|tBGQ",10401=>"QxG|SZQIHn|MPnHrQ",10402=>"DtZtuD",10403=>"DtZtuD|MtQI",10404=>"ZSIMn|DtZtuD|MtQI",10405=>'',10406=>"uDQrnZIQ",10407=>"trZf|EuHtZ",10408=>"JMWQnWQ|QxG",10409=>"JMWQnWQ|QxGMrQ",10410=>"IZx|IYHxQD",10411=>'YZWKuG|Hn|SQJQtQ',10412=>'ru',10413=>'DtBJQ',10414=>'DtZtuD|',10415=>"QIZMJ",10416=>"rQDQJJQr|nZIQ",10417=>"rQDQJQrD|MtQID",10418=>"tBGQ",10419=>'WHntQnt',10420=>"\\",10421=>'DrW|SHIZMn',10422=>"Qrr|tQxt",10423=>'SnDAHnQ%QxMDtD',10424=>"WHIGZnB|nZIQ",10425=>"DrW|SHIZMn",10426=>"IZMJ%OQZSQr",10427=>'YHSB',10428=>'DuYLQWt',10429=>'SHIZMn',10430=>"rQS",10431=>'SQJ|SnD|SMDZYJQS',10432=>'SH|YZWKuG',10433=>"JZnP",10434=>"?",10435=>"IQIYQr",10436=>"DtZtuD|SQJ",10437=>"CA|SQDMPnD",10438=>"rQZDHn",10439=>"IZMJ%IZMJ|YHSB",10440=>"&```",10441=>"coqRq?MS=':S'",10442=>"'?coqRq?MS?=?'",10443=>'QIZMJ',10444=>'ZWtMHn',10445=>'ftG|QnZYJQS',10446=>'SMDZYJQ',10447=>'EuHtZ',10448=>'IZMJSHI|ZWtMvQ',10449=>'SQfZuJt',10450=>"`tGJ",10451=>"WHIGZnB|QIZMJ",10452=>'ZSS|tQxt',10453=>"szTq|FhRizT}u`JMWQnWQ|QxG|SZtQ!'",10454=>'MS|IQIYQr',10455=>'JZDtzSIMndtZtuD',10456=>'ZWtMvQ',10457=>'IZx|IYHxQD',10458=>'SZtQ',10459=>"QxGMrQ",10460=>'trZf|EuHtZ',10461=>'MD|SQIH',10462=>'trMZJ',10463=>'AQrH|SZtQ|fHr|trMZJ',10464=>'DtZtuD',10465=>'QxGSZtQ',10466=>'JMWQnWQ|QxG|SZtQ',10467=>'ZSS|fHHtQr',10468=>"JZDtnZIQ",10469=>'ftG|DtZtuD',10470=>'WHIIQnt',10471=>'RqihTq|zssR',10472=>"u`QIZMJ|EuHtZ!u`QIZMJ|DGZWQ|uDQS!u`IZx|IYHxQD!u`JMWQnWQ|QxG|SZtQ!u`JMWQnWQ|tBGQ!u`WHIIQntD!",10473=>"ZWtHr|MG",10474=>'WHntQnt+tBGQ',10475=>"nZIQ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} require_once $GLOBALS['CLASSES_PATH'] .'SiteManager.php'; require_once $GLOBALS[I10324] .I10325; require_once $GLOBALS[I10324] .I10326; require_once($GLOBALS["CLASSES_PATH"]."Mailer.php"); require_once($GLOBALS["CLASSES_PATH"]."MboxClient.php"); function unhtmlspecialchars ($string) {$trans_tbl =get_html_translation_table (HTML_ENTITIES); $trans_tbl =array_flip ($trans_tbl); return strtr ($string, $trans_tbl); }class ModuleHostUsers extends AdmModule {public $userData; public $lILL1I1; public $lILL1lI; function ModuleHostUsers(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); }function TIlTTT1() {global $Core; if($Core->Side == I10327){ $lILL1ll =AdmModule::TTTTI1l($this->cms->Core); $limits =array( 'max_sites' => $lILL1ll["max_sites"], 'max_sites_3level' => $lILL1ll["max_sites_3level"], I10328 => $lILL1ll["max_sites_2level"], 'remind_sites_left' => $lILL1ll["remind_sites_left"] );}else{ $mod =&$Core->GetModule("wz_host_users"); $limits =array( I10329 => $mod->GetOption(I10329), 'max_sites_3level' => $mod->GetOption('max_sites_3level'), I10328 => $mod->GetOption(I10328), 'remind_sites_left' => $mod->GetOption('remind_sites_left') );}return $limits; }function TIlTTIT($lILL1lL =0) {global $db, $Core; if($Core->Side == I10327){ $IIl1lLI =&$this->TTTlTIT(); }else{ $IIl1lLI =$db; }if ($lILL1lL!=0){ $lILILIL =I10330.$lILL1lL."'"; }else{ $lILILIL =""; }$sql ="SELECT COUNT(*) AS cnt FROM cms_host_users WHERE 1 ".$lILILIL; $IIl1lLI->query($sql); $IIl1lLI->next_record(); $count =$IIl1lLI->Record['cnt']; $sql ="SELECT COUNT(*) AS cnt FROM cms_host_users WHERE domain RLIKE '^[^\.]+\.[^\.]+\$'".$lILILIL; $IIl1lLI->query($sql); $IIl1lLI->next_record(); $lILL1l1 =$IIl1lLI->Record['cnt']; return array( 'num_sites' => $count, 'num_sites_2level' => $lILL1l1, 'num_sites_3level' => $count-$lILL1l1 );}function TIlTTII($msg =false) {$limits =ModuleHostUsers::TIlTTT1(); $stats =ModuleHostUsers::TIlTTIT(); $max =intval($limits[I10329]); $lILL1LI =intval($limits[I10328]); $III1LI1 =intval($limits[I10331]); $err =false; if(($max && $stats['num_sites']>=$max) || ($lILL1LI>0 && $stats['num_sites_2level']>=$lILL1LI) || ($III1LI1 && $stats['num_sites_3level']>=$III1LI1) ){if($msg) $this->cms->AddStatusMsg('sites_limit_reached',I10332); return false; }return true; }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {$this->userData =array(); $this->resellersList =$this->TIlTT1I(); $this->lILL1I1 =SiteManager::TI1llT1(); $this->docsLang =HOST_DOCS_LANG; $IIIIL11["allowed_actions"] =Array("edit", I10333, "del", "special","copy"); $IIIIL11["group_operations"] =Array(); $IIIIL11[I10334] =false; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin() {if (!$this->TTTTIIl() && !$this->TTTTII1()){ trigger_error("SECURITY: attempt to open wizard by non-admin, domain=".$this->TTTTIlT(),E_USER_WARNING); die(); }require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_gui.php"); parent::_InitAdmin(); $db =&DB_si::admInstance(); $db->query("SELECT id,name FROM cms_clan_nodes"); $this->lILL1lI =array(); while($db->next_record()) {$this->lILL1lI[$db->Record[I10335]] =$db->Record['name']; }}function TTlTll1() {parent::TTlTll1(); }function TTTlIII() {parent::TTTlIII(); $this->filter->AddField("flt_mode", "hidden", $this->cms->Vars["flt_mode"]); $this->filter->AddField(I10336, 'text', $this->cms->Vars[I10336], '', 'like', 'm.email'); if (empty($this->cms->Vars[I10337])) {$this->filter->DisableFieldSql(I10337); }$search =stripslashes(unhtmlentities(trim($this->cms->Vars["flt_search"]))); $this->filter->AddField("flt_search", "text", $search, "", I10338, "u.username"); $this->filter->TITI1II("flt_search", " OR u.domain_orig LIKE '%".addslashes($search)."%' ". " OR u.username LIKE '%".addslashes($search)."%' ". " OR u.alias_domain LIKE '%".addslashes($search)."%' "); $this->filter->MoveField("flt_search", _MOVE_START); $lILL1Ll =Array(); $lILL1Ll =$this->filter->TITI1TT($lILL1Ll, Array($this->words[I10339]=>"2"), 45, false); $lILL1Ll =$this->filter->TITI1TT($lILL1Ll, Array($this->words["second_level"]=>"1"), 45, false); $lILL1Ll =$this->filter->TITI1TT($lILL1Ll, Array($this->words["all"]=>I10340), 45, false); if(empty($this->cms->Vars["flt_domain_type"])) {$this->cms->Vars["flt_domain_type"] =I10340; }$condition ='^[^.]+(\\\.[^.]+){'.$this->cms->Vars["flt_domain_type"].I10341; $this->filter->AddField("flt_domain_type", "select", $this->cms->Vars["flt_domain_type"], "", I10338, I10342.$this->cms->Vars["flt_domain_type"].I10342, $lILL1Ll); $this->filter->TITI1II("flt_domain_type"," AND (u.domain RLIKE '".$condition."')"); if($this->cms->Vars[I10343] == I10340) {$this->filter->DisableFieldSql(I10343); }$aStatus =Array(); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words["status_!error"]=>"!error"), 45, false); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words["status_suspend"]=>"suspend"), 45, false); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words[I10344]=>"active"), 45, false); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words["all"]=>I10340), 45, false); $this->filter->AddField("stat_id", "select", $this->cms->Vars[I10345], "", I10338, "u.status", $aStatus); if($this->cms->Vars[I10345] == I10340 || empty($this->cms->Vars[I10345])) {$this->filter->DisableFieldSql(I10345); }$aStatus =Array(); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words["status_suspend"]=>"suspend"), 45, false); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words[I10344]=>I10346), 45, false); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words["all"]=>I10340), 45, false); $this->filter->AddField("admin_stat_id", "select", $this->cms->Vars["admin_stat_id"], I10347, I10338, "u.admin_status", $aStatus); if($this->cms->Vars["admin_stat_id"] == I10340 || empty($this->cms->Vars["admin_stat_id"])) {$this->filter->DisableFieldSql("admin_stat_id"); }$aStatus =Array(); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words[I10348]=>"paid"), 45, false); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words[I10349]=>I10350), 45, false); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words["type_free"]=>"free"), 45, false); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words["all"]=>I10340), 45, false); $this->filter->AddField(I10351, "select", $this->cms->Vars[I10351], I10347, I10338, I10352, $aStatus); if($this->cms->Vars[I10351] == I10340 || empty($this->cms->Vars[I10351])) {$this->filter->DisableFieldSql(I10351); }$this->filter->AddField("flt_daemon_ignore", "checkbox", $this->cms->Vars["flt_daemon_ignore"], I10340, I10353, "u.exp_daemon_ignore"); $this->filter->AddField("flt_ftp_status", "checkbox", $this->cms->Vars["flt_ftp_status"], I10340, I10353, I10354); $this->filter->AddField("flt_is_demo_site", "checkbox", $this->cms->Vars["flt_is_demo_site"], I10340, I10353, "(u.flags & ".SF_DEMO.I10355); $this->filter->AddField("flt_has_alias", "checkbox", $this->cms->Vars["flt_has_alias"], I10340, I10353, "length(u.alias_domain)"); if ($this->cms->Vars[I10356] == I10340 || empty($this->cms->Vars[I10356])) {$this->filter->DisableFieldSql(I10356); }if ($this->cms->Vars["flt_ftp_status"] == I10340 || empty($this->cms->Vars["flt_ftp_status"])) {$this->filter->DisableFieldSql("flt_ftp_status"); }if ($this->cms->Vars["flt_is_demo_site"] == I10340 || empty($this->cms->Vars[I10357])) {$this->filter->DisableFieldSql(I10357); }if ($this->cms->Vars["flt_has_alias"] == I10340 || empty($this->cms->Vars["flt_has_alias"])) {$this->filter->DisableFieldSql("flt_has_alias"); }if ($this->TTTTIIl()){ $lILILIl =Array(); foreach($this->resellersList as $key=>$value){ $lILILIl =$this->filter->TITI1TT($lILILIl, Array($value["name"]=>$key), 45, false); }$lILILIl =$this->filter->TITI1TT($lILILIl, Array($this->words[I10358]=>I10340), 45, false); $this->filter->AddField("flt_id_reseller", "select", $this->cms->Vars["flt_id_reseller"], I10347, I10338, "u.id_reseller", $lILILIl); if($this->cms->Vars[I10359] == I10340 || empty($this->cms->Vars[I10359])) {$this->filter->DisableFieldSql(I10359); }}if(sizeof($this->lILL1lI)>0) {$lILL1LL =Array(); foreach($this->lILL1lI as $id=>$name){ $lILL1LL =$this->filter->TITI1TT($lILL1LL, Array($name=>$id), 45, false); }$lILL1LL =$this->filter->TITI1TT($lILL1LL, Array($this->words['main']=>I10340), 45, false); $lILL1LL =$this->filter->TITI1TT($lILL1LL, Array($this->words[I10358]=>"-1"), 45, false); $this->filter->AddField("flt_id_node", "select", $this->cms->Vars[I10360], I10347, I10338, "u.id_node", $lILL1LL); if($this->cms->Vars[I10360] == "-1" || !isset($this->cms->Vars[I10360])) {$this->filter->DisableFieldSql(I10360); }}$this->filter->UpdateFieldDBName("dateto", "date_registered"); $this->filter->UpdateFieldDBName(I10361, "date_registered"); if($this->cms->Vars["dateto"] == "31.12.2034") {$this->filter->DisableFieldSql("dateto"); }if($this->cms->Vars[I10361] == I10362) {$this->filter->DisableFieldSql(I10361); }}function &TTTlTIT() {return DB_si::admInstance(); }function TTTlI11(&$vData, &$aCustom) {$sql =" u.id, u.id_reseller, id_node, u.id_member, u.username, m.email, u.domain, u.alias_domain, u.date_registered,u.dbase, ". "DATE_FORMAT(u.date_registered,'".$this->cms->DFMT["db"]."') AS date_reg_fmt, ". I10363. I10364. I10365.$this->cms->DFMT[I10366].I10367. "u.db_size+u.disk_space AS used_space, u.db_size, u.disk_space, u.disk_quota, u.ext_info, ". "MAX(lh.date) as last_login_date, pp.name as client_name, pp.id as id_props ,". "count(lh.id) as logins_count, DATE_FORMAT(max(lh.date), '".$this->cms->DFMT[I10366]."') as last_login, p.id as payment_id "; $from ="FROM cms_host_users u LEFT JOIN cms_host_login_history lh ". "ON u.id_member = lh.id_member AND (lh.id_member > 0 OR lh.id_member IS NULL) AND lh.status='success' ". "LEFT JOIN cms_members m ON u.id_member=m.id ". "LEFT JOIN cms_host_payments p ON u.id = p.id_user ". "LEFT JOIN cms_host_payments_props pp ON u.id = pp.id_user AND pp.active=1 "; if ($this->TTTTII1()){ $lILILIL ="AND u.id_reseller='".$this->TTTTIlI()."' "; }$this->browser->InitSQL($sql,$from, "WHERE 1 ".(empty($this->cms->Vars["flt_search"]) && empty($this->cms->Vars[I10337]) ?' AND 0 ' :$lILILIL.$this->_ApplyFilters().$this->TTTlIl1()), I10368,"date_registered","username ASC"); $this->browser->AddSQLJoinedTables($this->cms->Core,'u',array( 'cms_host_login_history'=>I10369, 'cms_members'=>'m', 'cms_host_payments'=>'p', 'cms_host_payments_props'=>'pp')); $aCustom["fields"] += Array( 'username'=>array('action'=>I10370,'object'=>&$this,'method'=>'CBRow') );$aCustom["applied_id"] =I10368; $aCustom[I10371] =Array("leg_red", "leg_yellow", "leg_blue", "leg_edit", I10372); $lILL1L1 =parse_url($GLOBALS['ADMIN_PATH_WWW']); $port =$lILL1L1['port']; $lILL1L1 =$lILL1L1['scheme'].'://'.$lILL1L1[I10373]; if(!empty($port)) $lILL1L1 .= ":$port"; $aCustom['list_data']['backurl'] =htmlspecialchars($lILL1L1.$_SERVER['PHP_SELF'].'?'.$_SERVER[I10374]); parent::TTTlI11($vData, $aCustom); }function CBRow(&$aItem,&$aData) {$domain =TlT1III($aItem['domain']); if(empty($aItem["email"])) $aItem["email"] =$this->words['unknown']; if($aData[I10375] == ($aItem["row_index"] +1)) {if($this->TTTTII1()){ $lILL1lL =$this->TTTTIlI(); }else if($this->cms->Vars[I10359]!=0){ $lILL1lL =$this->cms->Vars[I10359]; }else{ $lILL1lL =0; }$limits =ModuleHostUsers::TIlTTT1(); $stats =ModuleHostUsers::TIlTTIT($lILL1lL); $max =$limits[I10329]==0 ?$this->words['unlimited'] :$limits[I10329]; $lILL1LI =$limits[I10328]==0 ?$this->words['unlimited'] :$limits[I10328]; $III1LI1 =$limits[I10331]==0 ?$this->words['unlimited'] :$limits[I10331]; if ($lILL1lL!=0){ $lILILI1 =array( I10376=> "$stats[num_sites]", 'level2'=> "$stats[num_sites_2level]", 'level3'=> "$stats[num_sites_3level]" );}else{ $lILILI1 =array( I10376=> "$stats[num_sites]/$max", 'level2'=> "$stats[num_sites_2level]/$lILL1LI", 'level3'=> "$stats[num_sites_3level]/$III1LI1" );}$aItem[I10377] =$this->cms->Gui->get('wz_host_users_list:row_limits',$lILILI1); }if(empty($aItem["domain"])) {$aItem["domain"] =$this->words["is_absent"]; $links[I10378] =$this->words["is_absent"]; }else {$links[I10378] =TlITI1l($domain); $aItem["domain_url"] =$this->cms->Gui->getAbs("wz_host_users_list:domain_url",Array(I10378 => $domain)); }if(!empty($aItem["alias_domain"])) {$aItem[I10379] =$this->cms->Gui->getAbs("wz_host_users_list:alias_url",Array("alias" => TlITI1l($aItem["alias_domain"]))); }$links["edit_id"] =$links[I10380] =$links["copy_id"] =$aItem[I10335]; $links["username"] =TlITI1l($aItem["username"]); $lILLl1L =$aItem[I10381]; $aItem[I10381] =$this->words['type_'.$aItem[I10381]]; $lILlI11 =$this->cms->Core->GetModule('srv_host_payments_props'); $aItem["props_href"] =$lILlI11->GetAdminLink(); $lILl1ll =$this->cms->Core->GetModule('srv_host_payments'); $aItem["payments_href"] =$lILl1ll->GetAdminLink(); $lILL11I =$this->cms->Core->GetModule('srv_host_payments_history'); $aItem["payments_history_href"] =$lILL11I->GetAdminLink(); $lILl1lL =$this->cms->Core->GetModule('srv_host_payments_docs'); $aItem["payments_docs_href"] =$lILl1lL->GetAdminLink(); $yesno =$aItem['exp_daemon_ignore'] ?'no' :I10382; $aItem['exp_daemon_ignore_on'] =$this->words[$yesno]; if(!empty($aItem["client_name"])){ $aItem['props_href'] .= "?flt_domain=".$domain; $aItem[I10383] =$this->cms->Gui->get('wz_host_users_list:props_url', $aItem); }if ($this->cms->Core->IsSysUser() && !empty($aItem["payment_id"]) && ($lILLl1L=="paid")){ $aItem["payments_href"] .= I10384.$aItem["payment_id"]; $aItem["payments_url"] =$this->cms->Gui->get("wz_host_users_list:payments_url", $aItem); $aItem["payments_history_href"] .= "?flt_search_domain=".$domain; $aItem["payments_history_url"] =$this->cms->Gui->get("wz_host_users_list:payments_history_url", $aItem); $aItem["payments_docs_href"] .= "?flt_domain=".$domain; $aItem[I10385] =$this->cms->Gui->get("wz_host_users_list:payments_docs_url", $aItem); }$edit =$del =$copy =true; $aItem['LOGIN_OK'] =1; if(($aItem["status"]!=I10346 && $aItem["status"]!=I10386) || !$this->cms->Core->IsSysUser()) {$edit =$del =$copy =false; }elseif($aItem["id"]==$this->TTTTIlI()) {$del =$copy =false; $aItem['LOGIN_OK'] =0; }if($domain==BUILDER_DOMAIN) {$del =$copy =false; $aItem['LOGIN_OK'] =0; }if($this->lILL1I1 &CLOPT_NO_COPY) $copy =false; if($this->lILL1I1 &CLOPT_NO_UPDATE) $edit =false; if($this->lILL1I1 &CLOPT_NO_DELETE) $del =false; if($this->TTTTII1()){ $edit =false; $del =false; }if($aItem["id"]==$aItem[I10387]){ $aItem["is_reseller"]="1"; }else{ $aItem["reseller_name"] =$this->resellersList[$aItem[I10387]]["name"]; }$aItem[I10388] =$edit ?$this->cms->Gui->get("wz_host_users_list:icon_hostuser_edit", $links) :$this->cms->Gui->getAbs("wz_host_users_list:icon_none",array()); $aItem[I10388] .= $copy ?$this->cms->Gui->get("wz_host_users_list:icon_hostuser_copy", $links) :$this->cms->Gui->getAbs("wz_host_users_list:icon_none",array()); $aItem[I10388] .= $del ?$this->cms->Gui->get("wz_host_users_list:icon_hostuser_del", $links) :$this->cms->Gui->getAbs("wz_host_users_list:icon_none",array()); $aItem['status'] =$this->words['status_'.$aItem['status']]; $aItem[I10389] =$this->words['status_'.$aItem[I10389]]; $aItem["last_login"] =empty($aItem["last_login"])? "-": $aItem[I10390]; $aItem["disk_space"] =getBytesAsText($aItem["disk_space"], $this->words, 2, 2); $aItem["node_name"] =isset($this->lILL1lI[$aItem["id_node"]]) ?$this->lILL1lI[$aItem[I10391]] :''; }function TTTllTI(&$aCustom) {if($this->id >0) {$this->SetBodyType("body_itemD"); }else {$this->SetBodyType("body_items"); }}function TTTlITT($IIIL11l, $cId, $cModule ='') {if ($this->TTTTII1() && ($IIIL11l!=I10392 && $IIIL11l!="none" && $IIIL11l!="special" && $IIIL11l!="rsrtme")){ trigger_error("SECURITY: attempt to do action [".$IIIL11l."] by reseller, domain=".$this->TTTTIlT(),E_USER_WARNING); return; }switch($IIIL11l) {case "special": $this->TIlTTIl($cId,$cModule); break; case I10392: $this->_ActionCopy($cId,$cModule); break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function TIlTTIl($cId, $cModule) {global $conn; $hash ='a208'; $time =time(); $db =&$this->TTTlTIT(); $db->query("SELECT domain_orig,admin_url FROM cms_host_users WHERE id=$cId"); $db->next_record(); $domain =$db->Record['domain_orig']; if($domain==BUILDER_DOMAIN) {trigger_error("Auto-login attempt into builder domain",E_USER_WARNING); return; }$member =CMS_Member::getInfo($domain); $hsid =md5($member[I10393].$hash.$time); $lILL1L1 =$db->Record['admin_url']; if(empty($lILL1L1)) $lILL1L1 ='index.php'; if(ADMIN_REQUIRE_SSL == 'ssl_only') {$lILL1L1 =str_replace('http://', I10394, $lILL1L1); }$vars =array('admin_url'=>$lILL1L1, 'hsid'=>$hsid, 'tstamp'=>$time, 'loginname'=>$member[I10395], 'domain'=>$domain, 'backurl'=>htmlspecialchars($this->cms->Vars['script_link'])); echo $this->cms->Gui->get("wz_host_users_list:login_form", $vars); $conn->Out(); die(); }function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); }function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $db =&$this->TTTlTIT(); if(!$this->TTTTII1() && !$this->TTTTIIl()) return; $lid =$this->cms->Vars[I10396]; if ($this->TTTTII1()){ $lILILIL ="AND u.id_reseller='".$this->TTTTIlI()."' "; }$sql ="SELECT u.id, u.id_reseller, m.username, u.flags,u.domain, DATE_FORMAT(u.date_registered,'".$this->cms->DFMT[I10366]."') AS rdate, u.status, ". I10365.$this->cms->DFMT[I10366].I10367. I10397. "u.traf_quota,u.dbase, ". "u.db_size, u.disk_space, u.comments, u.ext_info, u.exp_daemon_ignore, ". "u.admin_status, u.status_history, m.lang, ". "count(lh.id) as logins_count, DATE_FORMAT(max(lh.date), '".$this->cms->DFMT["db_dtime"].I10398. "FROM cms_host_users u LEFT JOIN cms_host_login_history lh ". "ON u.id_member = lh.id_member AND (lh.id_member > 0 OR lh.id_member IS NULL) AND lh.status='success' ". "LEFT JOIN cms_members m on u.id_member=m.id ". "WHERE u.id=$lid ".$lILILIL." GROUP BY u.id"; $this->itemData[I10399] =I10333; $this->itemData[I10396] =$lid; $db->query($sql); if($db->next_record()) {if($this->TTTTII1()) return; $tmp =array(); $tmp["type_".$db->Record[I10400]] =" selected"; $gui =&$this->cms->Gui; $this->itemData["type_item"] =$gui->get("wz_host_users_subform:type_selectbox", $tmp); $tmp =array(); $exp =(int)$db->Record[I10401]; $tmp["expire_$exp"] =" selected"; $this->itemData["expire_item"] =$gui->get("wz_host_users_subform:expire_selectbox", $tmp); if($db->Record["status"] == I10346 || $db->Record[I10402] == I10386) {$this->itemData["stat_".$db->Record[I10402]] =" selected"; $this->itemData["status_item"] =$gui->get("wz_host_users_subform:status_selectbox", $this->itemData); }else {$this->itemData[I10403] =$this->words["status_".$db->Record[I10402]]; }$tmp =array(); $tmp["stat_".$db->Record["admin_status"]] =" selected"; $this->itemData[I10404] =$gui->get("wz_host_users_subform:admin_status_selectbox", $tmp); $domain =$this->itemData[I10378] =TlT1III($db->Record[I10378]); $this->itemData["demo_checked"] =$db->Record["flags"] &SF_DEMO ?'checked' :I10405; $this->itemData["date_registered"] =$db->Record["rdate"]; $this->itemData["logins_count"] =$db->Record["logins_count"]; $this->itemData[I10390] =$db->Record[I10390]; $this->itemData[I10406] =$db->Record[I10406]; $this->itemData[I10387] =$db->Record[I10387]; $this->itemData["disk_space"] =getBytesAsText($db->Record["disk_space"], $this->words, 2, 1); $this->itemData["disk_quota"] =intval($db->Record["disk_quota"]); $this->itemData[I10407] =intval(floatval($db->Record[I10407])/(1024*1024)); $this->itemData["db_size"] =getBytesAsText($db->Record["db_size"], $this->words, 2, 1); $this->itemData[I10408] =$db->Record[I10409]; $this->itemData["comments"] =$db->Record["comments"]; $lILL11l =&MboxClient::TT1I1Il($domain); if(is_object($lILL11l)) {$lILL11l->useDomain($domain); $lILL11L =$lILL11l->domainInfo(); $lILL11l->TI1Tlll(); if(($lILL11L)===false) {trigger_error("Cannot get mail domain info, domain=$domain: ".$lILL11l->errorsAsString(),E_USER_ERROR); }$this->itemData["maildom_active_checked"] =$lILL11L[I10346]==1 ?'checked' :I10405; $this->itemData["email_quota"] =intval($lILL11L["disk_quota"]/1024); $this->itemData["max_mboxes"] =intval($lILL11L[I10410]); $this->itemData["add_footer"] =$lILL11L["add_footer"]==1 ?'checked' :I10405; $this->itemData["email_send_rate_limit"] =intval($lILL11L["email_send_rate_limit"]); }$this->itemData['ftp_enabled'] =$db->Record['ftp_status']==0 ?I10405 :'checked'; $this->itemData['backup_enabled'] =$db->Record[I10411]==0 ?I10405 :'checked'; $this->itemData["add_text_lang"] =$db->Record["lang"]=='ru' ?I10412 :'en'; $aHistory =unserialize($db->Record['status_history']); if(is_array($aHistory)) {$rows =I10405; $i =0; foreach($aHistory as $date=>$item) {$item['date'] =date($this->cms->DFMT['php_dtime'],$date); $item[I10413] =sprintf("row%d",((++$i)%2)+1); $item['status'] =$this->words['status_'.$item['status']]; $item[I10389] =$this->words[I10414.$item[I10389]]; $rows =$gui->get("wz_host_users_subform:status_history_row",$item).$rows; }$tmp =array('status_list'=>$rows); $table =$gui->get("wz_host_users_subform:history",$tmp); }$this->itemData['status_history'] =$table; $lILL111 =CMS_Member::getInfo($domain); $this->itemData[I10415] =$lILL111[I10415]; $sql ="SELECT id FROM cms_host_users WHERE id_reseller!=id AND id_reseller='".$this->itemData[I10396]."' LIMIT 1"; $db->query($sql); if($db->next_record() || $this->TTTTII1()) {$this->itemData["id_reseller_lock"]="1"; $this->itemData[I10416] =$this->resellersList[$this->itemData[I10387]]["name"]; }else{ $lIL1III =false; foreach($this->resellersList as $key=>$value){ if ($this->itemData[I10387]==$key){ $value["selected"] ="selected"; $lIL1III =true; }$this->itemData["reselers_items"] .= $gui->get("wz_host_users_subform:reseller_item", $value); }$value =Array(I10387=>0, "name"=>$this->words["no_reseller"]); if ($this->itemData[I10387]==0 || !$lIL1III){ $value["selected"] ="selected"; }$this->itemData[I10417] =$this->itemData[I10417].$gui->get("wz_host_users_subform:reseller_item", $value); if ($this->itemData[I10387]!=$this->itemData[I10396]){ $this->itemData[I10417] =$gui->getAbs("wz_host_users_subform:reseller_item", Array(I10387=>$this->itemData[I10396], "name"=>$this->words["make_a_reseller"])).$this->itemData[I10417]; }}}}function TTTTI1T($domain,$flags=0) {return WZDaemon::admInstance(false,$domain,60,$flags); }function _ActionCopy($cId, $cModule) {if(!$this->cms->Core->IsSysUser()) return; $sql ="SELECT u.domain_orig, m.email, m.lang, id_reseller FROM cms_host_users u, cms_members m ". "WHERE u.id_member=m.id AND u.id='".$cId.I10342; $db=&$this->TTTlTIT(); $db->query($sql); if ($db->next_record()){ $form[I10378] =$db->Record["domain_orig"]; $form[I10415] =$email =$db->Record[I10415]; $lang_data =$db->Record["lang"]; $lILL1lL =$db->Record[I10387]; }else{ trigger_error("Attempt to copy non-existent site id='".$cId.I10342, E_USER_ERROR); }$lILL1ll =AdmModule::TTTTI1l($this->cms->Core); if(isset($this->cms->Vars[I10418]) && $this->cms->Vars[I10418] == "popup") {if(!$this->TIlTTII()) {$set ='limits_reached'; $vData =array(); }else {$set ='copy_popup'; $form[I10396] =$this->cms->Vars[I10396]; $domains =array_keys($lILL1ll[I10378]); $lIL1IIl =I10405; foreach ($domains as $dom) {$lIL1IIl .= "$dom:"; }$lIl1I11 =$this->cms->Gui->get("wz_host_users_subform:copy_popup_items", $form); $vData =array(I10419=>$lIl1I11,'domains'=>$lIL1IIl); }$this->TTT1I1I($vData,$set); }if(!$this->TIlTTII(true)) return; $tok =explode('|',$this->cms->Vars['type']); $domain =array_shift($tok); $addzone =array_shift($tok); $lIL1IIL =array_shift($tok); $lIL1II1 =array_shift($tok); $passwd =str_replace("\\\\",I10420,unhtmlspecialchars(implode('|',$tok))); if (empty($passwd)){ $passwd =GeneratePassword(8); }$tok =explode('.',$domain); if(sizeof($tok)==2) {$limits =ModuleHostUsers::TIlTTT1(); $stats =ModuleHostUsers::TIlTTIT(); $lILL1LI =intval($limits[I10328]); if($lILL1LI<0) {$this->cms->AddStatusMsg('level2_forbidden',I10332); return; }}$db =&$this->TTTlTIT(); $sql ="SELECT domain_orig FROM cms_host_users WHERE id='$cId'"; $db->query($sql); $db->next_record(); $srcDomain =$db->Record['domain_orig']; $daemon =$this->TTTTI1T($srcDomain,SYSD_F_CONFIRM); $dp =array( I10421=>$srcDomain, 'dst_domain'=>$domain, I10393=>$passwd, 'add_zone'=>$addzone );if(!$daemon->TlTTT1l($dp)) {$this->cms->AddStatusMsg("site_copy_fail", "red", I10347, I10347, Array(I10422 => $daemon->GetLastError())); }else {$this->cms->AddStatusMsg("site_copy_ok"); $resp =$daemon->GetLastResponse(); $resp =explode(' ',$resp); switch($resp[3]) {case 'dnszone:created': $this->cms->AddStatusMsg("dns_zone_created"); break; case I10423: $this->cms->AddStatusMsg("dns_zone_exists"); break; case 'dnszone:error': $this->cms->AddStatusMsg("dns_zone_create_err",I10332); break; }$username =$resp[2]; $this->cms->Gui->addBlock("mail",$GLOBALS['LOCAL_FILES_REL_PATH']."_admin/templates/letters/_wz_copy_user" .$lang_data .".tpl"); $III1LII =&$this->cms->Core->GetModule("wz_designs"); $III1LlI =array( "company_name" => $this->cms->Core->GetOption(I10424), "company_url" => $this->cms->Core->GetOption("company_url"), "company_email" => $this->cms->Core->GetOption("company_email"), I10425 => $srcDomain, I10378 => $domain, "password" => $passwd, I10406 => $username, "recipient_name" => $recipientName, "webname" => $lIL1IlI );$III1LlL =$this->cms->Gui->get("mail:copy_subject", $III1LlI); $mbody =$this->cms->Gui->get(I10426, $III1LlI); $mbody .= $this->cms->Gui->get("mail:mail_body", $III1LlI); $mbody .= $this->cms->Gui->get("mail:footer", $III1LlI); $oMail =new Mailer(); $oMail->RecipientAddress =$email; $oMail->RecipientName =$recipientName; $oMail->SenderAddress =$this->cms->Core->GetOption("company_robot_email"); $oMail->SenderName =$this->cms->Core->GetOption(I10424); $oMail->Subject =$III1LlL; $oMail->Body =$mbody; $oMail->BodyFormat ="html"; $oMail->Prepare(); $mailSent =1; if ($lIL1IIL){ if(!$oMail->Send()) {trigger_error("Sending email failed to [$email]...", E_USER_WARNING); $this->cms->AddStatusMsg('notify_email_sent_error',I10332); }else{ $this->cms->AddStatusMsg('notify_email_sent_ok','blue'); }}if($this->TTTTII1()){ $oSess =admSession(); $lIL1Ill =$oSess->GetUserInfo(I10415); $this->TIlTT1T($this->cms,$lIL1Ill, $cId, Array('recipient_addr'=>$email,'subject'=>$oMail->Subject, I10427=>$oMail->Body,'lang'=>$this->docsLang)); }else if($lILL1lL != $this->TTTTIlI()){ $sql ="SELECT m.email FROM cms_host_users u, cms_members m WHERE u.id='".$lILL1lL."' AND u.id_member=m.id "; $db->query($sql); if ($db->next_record()){ $lIL1Ill =$db->Record[I10415]; $this->TIlTT1T($this->cms,$lIL1Ill, $cId, Array('recipient_addr'=>$email,I10428=>$oMail->Subject, I10427=>$oMail->Body,'lang'=>$this->docsLang)); }}$this->TIlTT1T($this->cms,$lILL1ll["host_admin_email"], $cId, Array('recipient_addr'=>$email,I10428=>$oMail->Subject, I10427=>$oMail->Body,'lang'=>$this->docsLang)); if ($lIL1II1){ $this->db->query("UPDATE cms_host_users SET backup_on_delete=1 WHERE id=$cId"); $dp =array(I10429=>$srcDomain,'delete_subscriber'=>1,'del_zone'=>1); if($daemon->TITTlIT($dp)) {$this->cms->AddStatusMsg("status_del"); }else{ $this->cms->AddStatusMsg("status_del_fail", I10430); }}}}function _ActionDel($cId, $cModule) {if(!$this->TTTTIIl()) return; $sql ="SELECT u.*, m.email FROM cms_host_users u, cms_members m WHERE u.id_member=m.id AND u.id='$cId'"; $this->db->query($sql); if(isset($this->cms->Vars[I10418]) && $this->cms->Vars[I10418] == "popup") {$form[I10396] =$this->cms->Vars[I10396]; if($this->db->next_record()) {if(empty($this->db->Record[I10406])) {$form[I10406] =$this->cms->words['unknown']; }else {$form[I10406] =$this->db->Record[I10406]; }$form[I10415] =$this->db->Record[I10415]; $form['del_dns_disabled'] =I10405; if(empty($this->db->Record[I10378])) {$form[I10378] =$this->cms->words["is_absent"]; $form[I10431] ='disabled'; }else {$domain =$form[I10378] =TlT1III($this->db->Record[I10378]); $tmp =explode('.',$domain); if(sizeof($tmp)==2) {$daemon =$this->TTTTI1T(false); if($daemon->TlTTII1($domain)!==1) $form[I10431] ='disabled'; }else {$form[I10431] ='disabled'; }}$form[I10432] =$this->db->Record[I10411]==0 ?I10405 :"checked"; $form['do_notify'] =$this->module->GetOption('notify_status_change') ?"checked" :I10405; }$lIl1I11 =$this->cms->Gui->get("wz_host_users_subform:del_popup_items", $form); $vData =array(I10419=>$lIl1I11); $this->TTT1I1I($vData,'del_popup'); }do {if(!$this->db->next_record()) {$this->cms->AddStatusMsg("status_del_fail", I10430); break; }$type =$this->cms->Vars[I10418]; $lIL1IIL =strstr($type, "notify") ?1 :0; $lIL1IlI =TlT1III($this->db->Record[I10378]); $status =$this->db->Record[I10402]; $id_member =$this->db->Record['id_member']; $member =CMS_Member::getInfo($lIL1IlI); $email =$member[I10415]; $lang_data =$member[I10433]; if($member["firstname"] != I10347 || $member["lastname"] != I10347) {$recipientName =", ".$member["firstname"].I10434.$member["lastname"]; }else {$recipientName =I10347; }if($status == "deleting") {$this->cms->AddStatusMsg("status_del_exists", I10430); break; }$lIL1IlL =strstr($type, "|backup") ?1 :0; $this->db->query("UPDATE cms_host_users SET backup_on_delete=$lIL1IlL WHERE id=$cId"); $daemon =$this->TTTTI1T($lIL1IlI); $lIL1Il1 =strstr($type, I10435) ?0 :1; $lIL1ILI =strstr($type,'|delzone') ?1 :0; $dp =array(I10429=>$lIL1IlI,'delete_subscriber'=>$lIL1Il1,'del_zone'=>$lIL1ILI); if(!$daemon->TITTlIT($dp)) {$this->cms->AddStatusMsg("status_del_fail", I10430); break; }$this->cms->AddStatusMsg(I10436); $this->cms->Gui->addBlock("mail",$GLOBALS['LOCAL_FILES_REL_PATH']."_admin/templates/letters/_wz_del_user_" .$lang_data .".tpl"); $III1LII =&$this->cms->Core->GetModule(I10437); $III1LlI =array( I10424 => $this->cms->Core->GetOption(I10424), "company_url" => $this->cms->Core->GetOption("company_url"), "company_email" => $this->cms->Core->GetOption("company_email"), I10438 => $this->cms->Vars[I10438], "recipient_name" => $recipientName, "webname" => $lIL1IlI );$III1LlL =$this->cms->Gui->getAbs("mail:delete_subject", Array("webname"=>$lIL1IlI)); $mbody =$this->cms->Gui->get(I10426, $III1LlI); $mbody .= $this->cms->Gui->get(I10439, $III1LlI); $mbody .= $this->cms->Gui->get("mail:footer", $III1LlI); $oMail =new Mailer(); $oMail->RecipientAddress =$email; $oMail->RecipientName =$recipientName; $oMail->SenderAddress =$this->cms->Core->GetOption("company_robot_email"); $oMail->SenderName =$this->cms->Core->GetOption(I10424); $oMail->Subject =$III1LlL; $oMail->Body =$mbody; $oMail->BodyFormat ="html"; $oMail->Prepare(); $mailSent =1; if ($lIL1IIL){ if(!$oMail->Send()) {$mailSent =0; trigger_error("Sending email failed to [$email]...", E_USER_WARNING); $this->cms->AddStatusMsg('notify_email_sent_error',I10332); }else{ $this->cms->AddStatusMsg('notify_email_sent_ok','blue'); }}$lIL1ILl =$III1LII->GetOption("wizard_user_email"); if(!empty($lIL1ILl)) {$oMail->RecipientAddress =$lIL1ILl; if(!$oMail->Send()){ trigger_error("Sending email failed to [".$oMail->RecipientAddress."]...", E_USER_WARNING); }}$III1LlL =$this->cms->Gui->getAbs("mail:admin_delete_subject", Array("webname"=>$lIL1IlI)); $mbody =$this->cms->Gui->get("mail:admin_mail_body", $III1LlI); $oMail->Subject =$III1LlL; $oMail->Body =$mbody; $oMail->RecipientAddress =$III1LII->GetOption("wizard_email"); $oMail->Prepare(); if(!$oMail->Send()) {trigger_error("Sending email failed to [".$oMail->RecipientAddress.I10440, E_USER_WARNING); }if($III1LII->GetOption("wizard_email_cc") != $III1LII->GetOption("wizard_email")) {$oMail->RecipientAddress =$III1LII->GetOption("wizard_email_cc"); if(isset($oMail->RecipientAddress) && $oMail->RecipientAddress!=I10405 && !$oMail->Send()) {trigger_error("Sending email failed to [".$oMail->RecipientAddress.I10440, E_USER_WARNING); }}}while(false); unset($this->cms->Vars[I10396]); }function TTTl1lI($cId, $cModule) {if(!$this->TTTTIIl()) return; if(!$this->TIlTTII(true)) return; $sql ="SELECT id FROM cms_host_users WHERE id_reseller!=id AND id_reseller='".$this->userData[I10335]."' LIMIT 1"; $this->db->query($sql); if($this->db->next_record()) {$this->userData['id_reseller'] =$this->userData[I10335]; }parent::TTTl1lI($cId, $cModule); $cId =intval($cId); $err =$this->GetLastError(); $domain =$this->userData['domainName']; $member =CMS_Member::getInfo($domain); $id_member =$member[I10335]; $lIL1ILL =$this->cms->VarsPost['member_email']; $sql ="UPDATE cms_members SET email='$lIL1ILL' ". I10441; $lIL1IL1 =&DB_si::admInstance($domain); $lIL1IL1->query(sprintf($sql,$id_member)); $hr =ModuleHostUsers::TIlTTlI($domain); $this->db->query(sprintf($sql,$hr['id_member'])); if(defined('SELECT_MAX_MBOXES') && SELECT_MAX_MBOXES === true){ $sql ="UPDATE cms_host_users SET max_mboxes = '".intval($this->cms->VarsPost['max_mboxes']).I10442.intval($cId).I10342; $this->db->query($sql); }$notify =$this->cms->Vars['notify_user']; $lIL1I1I =$this->userData['lastStatus']; $lIL1I1l =$this->userData['lastAdminStatus']; $lILl11I =$this->userData['userLang']; $email =$this->userData[I10443]; $recipientName =$this->userData['recipientName']; $daemon =$this->TTTTI1T($domain); $lIL1I1L =$this->cms->Vars['status']; $lIL1I11 =$this->cms->Vars[I10389]; if(!$err['errno'] && $lIL1I1l!=$lIL1I11) {$lIL1lII =true; }else {$lIL1lII =false; $lIL1I11 =$lIL1I1l; }if($lIL1I1I!=$lIL1I1L) {switch($lIL1I1L) {case 'suspend': $dp =array(I10444=>'suspend',I10429=>$domain); break; case 'active': $dp =array(I10444=>'activate',I10429=>$domain); break; default: break; }if(!$daemon->TlTTITT($dp)) {$this->cms->AddStatusMsg("status_change_failed", I10430); $lIL1I1L =$lIL1I1I; }else $lIL1lII =true; }$lIL1lIl =$this->cms->VarsPost[I10445]==1 && $lIL1I1L=='active' && $lIL1I11=='active'; if($lIL1lIl!=$this->userData['lastFtpStatus']) {$action =$lIL1lIl ?'enable' :I10446; $dp =array(I10444=>$action,I10429=>$domain); if(!$daemon->TlTTITl($dp)) {$lIL1lIl =$this->userData['lastFtpStatus']; $this->cms->AddStatusMsg("ftp_setup_failed", I10430); }else $lIL1lII =true; }$lIL1lIL =intval($this->cms->VarsPost['disk_quota']); if($this->userData['disk_quota']!=$lIL1lIL) {$dp =array(I10429=>$domain,I10447=>$lIL1lIL); if(!$daemon->TlTTIIT($dp)) {$this->cms->AddStatusMsg('disk_quota_setup_failed',I10332); }}$lIL1lI1 =intval($this->cms->VarsPost['email_quota'])*1024; $lIL1llI =intval($this->cms->VarsPost['max_mboxes']); $lIL1lll =intval($this->cms->VarsPost['add_footer']) ?1 :0; $lIL1llL =intval($this->cms->VarsPost[I10448]) ?1 :0; $lILL11l =&MboxClient::TT1I1Il($domain); if(is_object($lILL11l)) {$lILL11l->useDomain($domain); if($lILL11l->updateDomain(array('active'=>$lIL1llL,'disk_quota'=>$lIL1lI1,'max_mboxes'=>$lIL1llI,'add_footer'=>$lIL1lll))===false) {trigger_error("Cannot update mail domain $domain: ".$lILL11l->errorsAsString(),E_USER_WARNING); $this->cms->AddStatusMsg('email_domain_update_failed',I10332); }$lILL11l->TI1Tlll(); }if($lIL1I1I!=$lIL1I1L || $lIL1I1l!=$lIL1I11) {$oSess =admSession(); $rec =array( 'changed_by' => $oSess->GetUserInfo(I10395), 'comment'=>$this->cms->VarsPost["text"] );if($lIL1I1I!=$lIL1I1L) $rec['status'] =$lIL1I1L; if($lIL1I1l!=$lIL1I11) $rec[I10389] =$lIL1I11; ModuleHostUsers::TIlTTl1($cId,$rec); }if($lIL1lII && ($notify==I10382 || ($notify==I10449 && $this->module->GetOption('notify_status_change'))) ){$gui =&$this->cms->Gui; $gui->addBlock("mail",$GLOBALS['LOCAL_FILES_REL_PATH']."_admin/templates/letters/_wz_status_changed_" .$lILl11I .I10450); $yesno =array(false=>'no',true=>I10382); $III1LlI =array( I10424 => $this->cms->Core->GetOption(I10424), "company_url" => $this->cms->Core->GetOption("company_url"), "company_email" => $this->cms->Core->GetOption(I10451), "recipient_name" => $recipientName, "webname" => $domain, 'site_status' => $this->words[I10414.$lIL1I1L], I10389 => $this->words[I10414.$lIL1I11], 'ftp_status' => $this->words[$yesno[$lIL1lIl]], I10452 => stripslashes($this->cms->Vars['text']) );$III1LlL =$gui->getAbs("mail:status_subject", Array("webname"=>$domain)); $mbody =$gui->get(I10426, $III1LlI); $mbody .= $gui->get(I10439, $III1LlI); $mbody .= $gui->get("mail:footer", $III1LlI); $oMail =new Mailer(); $oMail->RecipientAddress =$email; $oMail->RecipientName =$recipientName; $oMail->SenderAddress =$this->cms->Core->GetOption("company_robot_email"); $oMail->SenderName =$this->cms->Core->GetOption(I10424); $oMail->Subject =$III1LlL; $oMail->Body =$mbody; $oMail->BodyFormat ="html"; $oMail->Prepare(); $mailSent =1; if(!$oMail->Send()){ $mailSent =0; trigger_error("Sending email failed to [$email]...", E_USER_WARNING); $this->cms->AddStatusMsg('notify_email_sent_error',I10332); }$this->cms->AddStatusMsg('notify_email_sent_ok','blue'); }}function TTT1IlI($aSql =Array(), $cId =0) {$db =&$this->TTTlTIT(); $sql ="SELECT u.username, u.id_reseller, u.flags,u.dbase,u.status,u.admin_status,u.domain,u.status_history,u.ftp_status,". I10453.$this->cms->DFMT['db']."') AS expdate,". "u.disk_quota,u.email_quota,u.max_mboxes,u.id_member ". "FROM cms_host_users u WHERE u.id=$cId"; $db->query($sql); $db->next_record(); $this->userData['id_member'] =intval($db->Record[I10454]); $this->userData['id_reseller'] =intval($db->Record['id_reseller']); $this->userData['lastStatus'] =$db->Record['status']; $this->userData[I10455] =$db->Record[I10389]; $domain =$this->userData['domainName'] =TlT1III($db->Record[I10429]); $this->userData['lastFtpStatus'] =intval($db->Record['ftp_status']) && $db->Record['status']==I10456 && $db->Record[I10389]==I10456; $this->userData['disk_quota'] =$db->Record['disk_quota']; $this->userData['email_quota'] =$db->Record['email_quota']; $this->userData[I10457] =$db->Record[I10457]; $this->userData[I10395] =$db->Record[I10395]; $this->userData['dbase'] =$db->Record['dbase']; $this->userData['status_history'] =$db->Record['status_history']; $date =$this->cms->VarsPost[I10458]; if(isset($date) && trim($date)!=I10405) {$tmp =preg_split('/[^0-9]/',$date); $str =implode(I10405,$tmp); if($str+0 != 0) $udate =DateTools::getCorrectUDate($date, $this->cms->DFMT["conf"],-1); else $udate =0; }else $udate =0; $aSql =array( 'id_reseller'=>$this->cms->VarsPost[I10387], 'exp_daemon_ignore'=>$this->cms->VarsPost[I10459], I10389=>$this->cms->VarsPost["admin_status"], 'comments'=>unhtmlentities(stripslashes($this->cms->VarsPost["comments"])), 'traf_quota'=>$this->cms->VarsPost[I10460]*1024*1024, 'flags' => $db->Record['flags'], 'email_send_rate_limit' => intval($this->cms->VarsPost['email_send_rate_limit']) );if(isset($this->cms->VarsPost[I10461])) $aSql['flags'] |= SF_DEMO; else $aSql['flags'] &= ~SF_DEMO; $lIL1ll1 =!($this->cms->VarsPost["site_type"]==I10462 && $udate==0); if(!$lIL1ll1) $this->cms->AddStatusMsg(I10463,I10332); else $aSql[I10381] =$this->cms->VarsPost["site_type"]; $lIL1I1L =$this->cms->VarsPost[I10464]; if($this->userData['lastStatus']!=$lIL1I1L) {if($lIL1I1L=='suspend' || $lIL1I1L =I10456) {}else $aSql[I10464] =$lIL1I1L; }if($udate==-1) {$this->cms->AddStatusMsg('invalid_date',I10332); }elseif($lIL1ll1) {$dd =$db->Record['expdate']; $lIL1lLI =DateTools::getCorrectUDate($db->Record[I10465],$this->cms->DFMT['conf']); if($udate!=$lIL1lLI) {$aSql[I10466] =DateTools::toMysqlDate($udate); $aSql['last_remind_sent'] =DateTools::toMysqlDate(0); }}$aSql[I10411] =$this->cms->VarsPost['backup_enabled']==1 ?1 :0; $aSql['email_add_footer'] =$this->cms->VarsPost[I10467]==1 ?1 :0; $member =CMS_Member::getInfo($domain); $this->userData['userLang'] =$member['lang']==I10412 ?I10412 :'en'; $this->userData[I10443] =$member[I10443]; if($member["firstname"] != I10347 || $member[I10468] != I10347) {$recipientName =", ".$member["firstname"].I10434.$member[I10468]; }else {$recipientName =I10347; }$this->userData['recipientName'] =$recipientName; $aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TIlTTI1($id_member) {$sql ="DELETE FROM cms_sessions WHERE id_member=".intval($id_member); $db =&$this->TTTlTIT(); $db->query($sql); }function TIlTTlT($id_member) {$sql ="DELETE FROM cms_sessions WHERE id_member=(SELECT id_member from cms_host_users WHERE id=".intval($id_member).I10355; $db =&DB_si::admInstance(); $db->query($sql); }function TIlTTlI($val,$key='domain_orig') {$sql ="SELECT * FROM cms_host_users WHERE $key='$val'"; $db =&DB_si::admInstance(); $db->query($sql); $db->next_record(); return $db->Record; }function TIlTTll($userId,$status,&$daemon,$lIL1lLl=I10405,$comment=I10405) {$db =&DB_si::admInstance(); $db->query("SELECT domain_orig,status,admin_status,ftp_status FROM cms_host_users WHERE id=$userId"); if(!$db->next_record()) return false; $lIL1I1L =($status==I10456); $action =$lIL1I1L ?'enable' :I10446; $ftp_status =$lIL1I1L ?'1' :'0'; if($ftp_status != $db->Record[I10469]){ $dp =array(I10444=>$action,I10429=>$db->Record['domain_orig']); if($daemon->TlTTITl($dp)){ $db->query("UPDATE cms_host_users SET ftp_status=".$ftp_status." WHERE id='".$userId.I10342); }else{ return false; }}$db->query("UPDATE cms_host_users SET admin_status='$status' WHERE id=$userId"); ModuleHostUsers::TIlTTl1( $userId,array(I10389=>$status,'changed_by'=>$lIL1lLl,I10470=>$comment)); return true; }function TIlTTl1($userId,$rec) {$db =&DB_si::admInstance(); $db->query("SELECT status,admin_status, status_history FROM cms_host_users WHERE id=$userId"); if(!$db->next_record()) return false; $aHistory =unserialize($db->Record['status_history']); if(!is_array($aHistory)) $aHistory =array(); $aHistory[time()] =array( I10464=>isset($rec[I10464]) ?$rec[I10464] :$db->Record[I10464], I10389=>isset($rec[I10389]) ?$rec[I10389] :$db->Record[I10389], 'changed_by' => $rec['changed_by'], 'ip' => $_SERVER[I10471], I10470=>$rec[I10470] );$lIL1lLL =serialize($aHistory); $db->query("UPDATE cms_host_users SET status_history='".addslashes($lIL1lLL)."' WHERE id=$userId"); return true; }function TIlTT1T(&$cms,$email,$userId,$data) {$gui =&$cms->Gui; $lang =$data['lang']==I10412 ?I10412 :'en'; $gui->addBlock("adm_data",$GLOBALS['LOCAL_FILES_REL_PATH']."_admin/templates/letters/_admin_notification.tpl"); $sql ="SELECT u.domain_orig AS domain,u.username,u.home_dir,u.dbase,u.status,u.admin_status,". "u.date_registered,u.ftp_status,u.exp_daemon_ignore,u.traf_quota,u.disk_space,u.disk_quota,u.db_size,". I10472. "p.amount,p.amount_min,p.amount_month,p.date_amount_zero,p.date_last_remind_sent,p.note,p.hidden_note,". "p.traf_amount,p.traf_price,p.billing_off,p.billing_date,p.last_payment_amount,p.last_payment_date ". "FROM cms_host_users u LEFT JOIN cms_host_payments p ON u.id=p.id_user ". "WHERE u.id=$userId"; $db =&DB_si::admInstance(); $db->query($sql); $db->next_record(); $lIL1lL1 =$db->Record; $lIL1lL1['specbody'] =$data[I10427]; $lIL1lL1['recipient_addr'] =$data['recipient_addr']; $oSess =admSession(); $userData =$oSess->getUserInfo(); $lIL1lL1[I10473] =$oSess->ip; $lIL1lL1["actor_domain"] =$oSess->TlIT11I(); $lIL1lL1["actor_email"] =$userData[I10415]; $lIL1lL1["actor_username"] =$userData[I10406]; $lIL1lL1['meta'] =$gui->getMeta(I10474); $mbody =$gui->get("adm_data:body_".$lang, $lIL1lL1); $oMail =new Mailer(); $oMail->RecipientAddress =$email; $oMail->SenderAddress =$cms->Core->GetOption("company_robot_email"); $oMail->SenderName =$cms->Core->GetOption(I10424); $oMail->Subject =$data[I10428]; $oMail->Body =$mbody; $oMail->BodyFormat ="html"; $oMail->Prepare(); return $oMail->Send(); }function TIlTT1I(){ $db =&DB_si::admInstance(); $sql ="SELECT hu.id_member,hu.id_reseller,hu.domain_orig, hp.id as id_props, hp.* , hu.id FROM cms_host_users hu LEFT JOIN cms_host_payments_props hp ON hu.id=hp.id_user AND hp.active=1 WHERE hu.id_reseller=hu.id ORDER BY hp.name DESC"; $db->query($sql); $lILILIl =Array(); while($db->next_record()){ $lILILIl[$db->Record[I10396]] =$db->Record; if (empty($db->Record[I10475])){ $lILILIl[$db->Record[I10396]] [I10475] =$db->Record["domain_orig"]; }}return $lILILIl; }}