<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       9869 xkqwlyxitqrurwkgykrzzwrxltwyuppggpsnqxkiqnumuxwwgkxyrmqgxiutlyuirmmrpnir
 */ ?><?php foreach(array(10544=>"SQfZuJt|GrQfMx",10545=>"fJt|nZIQ",10546=>"'",10547=>"dqwURmTb%?ZttQIGt?tH?HGQn?IHSuJQ?YB?nHn+ZSIMn!?SHIZMn=",10548=>'MnWJuSQS',10549=>'vZJuQ',10550=>'t',10551=>"G_t",10552=>'G_t',10553=>"G`MS",10554=>"ZWtMHn",10555=>"HYLQWt",10556=>"vZJuQ",10557=>"|JMDt%QSMt",10558=>"MS",10559=>"|JMDt%MWHn|nHnQ",10560=>"ZGGJMQS|MS",10561=>"JQP|SQJ",10562=>"WZnWQJ",10563=>'MS|rQD',10564=>"nZIQ",10565=>"DuYtBGQ",10566=>"DQtuG|fQQ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleHstPkg extends ModuleHst {public $aResources; function ModuleHstPkg(&$cms, &$db, &$cModule) {$this->aResources =Array(); parent::ModuleHst($cms, $db, $cModule); }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {$IIIIL11 =array(); $IIIIL11[I10544] ="p"; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->aResources =$this->TIlTII1(); }function _InitAdmin() {if($this->TTTTlTI() || $this->TTTTII1()) {trigger_error("Access violation.", E_USER_ERROR); }parent::_InitAdmin(); }function TTTlIII() {parent::TTTlIII(); $this->filter->AddField("flt_name", "text", stripslashes(unhtmlentities($this->cms->Vars[I10545])), "", " like ", "name"); }function TIlTII1(){ $aRes =Array(); $sql ="SELECT hr.id as res_id, hr.name as res_name, hr.unit as res_unit, hr.subtype FROM cms_hst_res hr WHERE lang='".$this->langData.I10546; $res =$this->db->select($sql); while ($res->next_record()) {$aRes[$res->Record["res_id"]] =$res->Record; }return $aRes; }function &TTTlI1I(&$aData) {if ($this->TTTTlTI()){ trigger_error(I10547.$this->TTTTIlT(),E_USER_WARNING); die(); }if (count($this->aResources)){ $lIL1LL1 =Array("1", "2"); foreach ($this->aResources as $id => $aRes) {if (isset($this->itemData['resources'][$id])) {$aRes[I10548] ="checked"; $aRes['value'] =$this->itemData['resources'][$id]['value']; }else{ $aRes[I10549] =1; }$aRes['row_style_index'] =$lIL1LL1[0]; $lIL1LL1 =array_reverse($lIL1LL1); $aData["resource_rows"] .= $this->cms->Gui->get($this->moduleName."_subform:resource_row", $aRes); }}else {$aData["resource_rows"] .$this->cms->Gui->get($this->moduleName."_subform:empty_resources_list", $this->db->Record); }parent::TTTlI1I($aData); }function TTTlI11(&$vData, &$aCustom) {$this->browser->InitSQL("p.id, p.name, p.setup_fee, p.is_deleteable, count(distinct r.id_res) as resources, count(distinct t.id) as tariff_pkgs ", Array( 'tables'=>Array('p' => 'cms_hst_pkg', I10550=>'cms_hst_tariff_pkg', 'r'=>'cms_hst_pkg_res'), 'joins'=>Array(I10551=>"t.id_pkg=p.id", "t|r"=>"r.id_pkg=p.id"), 'joins_types'=>Array(I10552=>'LEFT', 't|r'=>'LEFT') ),"WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), I10553, "name", "p.id desc" );$aCustom["fields"] += Array( "name"=>Array(I10554=>"stripline", "size"=>120), "formats"=>Array(I10554=>"callback", I10555=>&$this, "method"=>'_ApplyFieldsCB'), "action_edit"=>Array(I10554=>"flagicon", I10556=>"", "id"=>"edit_id", "on"=>$this->moduleName.I10557,"off"=>""), "is_deleteable"=>Array(I10554=>"flagicon", I10556=>1, I10558=>"del_id", "on"=>$this->moduleName."_list:del","off"=>$this->moduleName.I10559), );$this->browser->AddSQLJoinedTables($this->cms->Core, 'p', array(I10550=>'cms_hst_tariff_pkg', 'r'=>'cms_hst_pkg_res')); $aCustom[I10560] =I10553; $aCustom["legend"] =Array("leg_yellow", "leg_blue", "leg_edit", I10561); $aCustom["form_data"]["buttons"] =Array("add", "apply", I10562, "save"); parent::TTTlI11($vData, $aCustom); }function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); $this->TIlTIlT($this->db->lastInsertId()); }function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT * ". "FROM " .$this->module->GetTableName() ." p ". "LEFT JOIN cms_hst_pkg_res pr ON pr.id_pkg=p.id ". "WHERE p.id='".$cId.I10546.$this->_ApplyFilters(); $this->db->query($sql); $lIL1L1I =true; while ($this->db->next_record()) {if ($lIL1L1I) {$this->itemData =$this->db->Record; $this->itemData['resources'] =array(); $lIL1L1I=false; }if ($this->db->Record['id_res'] >0) {$this->itemData['resources'][$this->db->Record[I10563]] =$this->db->Record; }}}function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); if (!empty($this->cms->VarsPost['name'])) {$this->TIlTIlT($cId); }}function _ActionDel($cId, $cModule) {$sql ="SELECT count(*) as cnt FROM cms_hst_tariff_pkg WHERE id_pkg = '$cId'"; if ($this->db->getValue($sql) >0) {$this->SetLastError(3, "Deleting failed"); $this->cms->AddStatusMsg("status_del_fail_tariff_exists", "red"); }else {parent::_ActionDel($cId, $cModule); $this->TIlTIlI($cId); }}function TTT1IlI($aSql =Array(), $cId =0) {$name =trim($this->cms->VarsPost[I10564]); $setup_fee =intval($this->cms->VarsPost["setup_fee"]); if($name != "") {$aSql =Array( I10564=>$name, "setup_fee"=>$setup_fee, );}$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TIlTIlT($cId){ $this->TIlTIlI($cId); $lIL1L1l =Array(); foreach ($this->cms->VarsPost as $name => $val) {if (mb_substr($name, 0, 5) == "resid") {if (intval($this->cms->VarsPost["res_included_$val"])) {if ($this->aResources[$val][I10565] == "on-off") {$cnt =1; }else {$cnt =intval($this->cms->VarsPost["value_$val"]); }$lIL1L1l[] =Array ("id_pkg" => $cId, "id_res" => intval($val), I10556 => $cnt, );}}}if (count($lIL1L1l)) {foreach ($lIL1L1l as $lIL1L1L) {$sql =$this->db->GenInsertSQL('cms_hst_pkg_res', $lIL1L1L); $this->db->query($sql); }}}function TIlTIlI($cId){ $sql="DELETE FROM cms_hst_pkg_res WHERE id_pkg='$cId'"; $this->db->query($sql); }function _ApplyFieldsCB(&$vItem, &$vData) {$vItem[I10566] =FormatNumber($vItem[I10566], 0, 0); $vItem["resources"] =FormatNumber($vItem["resources"], 0, 0); $vItem["tariff_pkgs"] =FormatNumber($vItem["tariff_pkgs"], 0, 0); }}?>