<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       50452 xkqwzqtgmwulppsnktqrptpkzwsuyqlxsqyzriyxmwnsrwnruknprytmngwuqklnznxupnir
 */ ?><?php foreach(array(10672=>'iHSuJQoDtRQDmnDt`GOG',10673=>'IZx|DMtQD',10674=>"IZx|DMtQD|2JQvQJ",10675=>'IZx|DMtQD|3JQvQJ',10676=>"ZSIMn",10677=>'Wnt',10678=>'IZx|DMtQD|2JQvQJ',10679=>'rQS',10680=>'v`MS',10681=>'WOQWKQS',10682=>'DQJQWt',10683=>'Hn|fHrI',10684=>'nZIQ',10685=>'W',10686=>'DtHrQ|tH|SY',10687=>'JZDt|JHPMn|SZtQ',10688=>'ZWtMHn|GZrZID',10689=>'WHGB|GZrZID|rHC',10690=>"fJt|DQZrWO",10691=>"DtZtuD|DuDGQnS",10692=>"0",10693=>"=",10694=>"nHt|MnDtZJJQS",10695=>"ZSIMn|DtZt|MS",10696=>"DQJQWt",10697=>"+1",10698=>'DWOQIQ',10699=>'gog|dqjF',10700=>'tZYJQD',10701=>"MS|ZSIMn",10702=>'uDQrnZIQ',10703=>'SHIZMn',10704=>'SY',10705=>'ZrOMvQ|WrQZtQS',10706=>"ZWWQDD|vMHJZtMHn",10707=>"rQS",10708=>"SHIZMn",10709=>'JMIMtD|rQZWOQS',10710=>"|DuYfHrI%WHGB|fHrI",10711=>'sy',10712=>'`',10713=>'HD|uDQr',10714=>'MS|rQD|MnDt',10715=>'SQDt|uDQrnZIQ',10716=>'MS',10717=>'JMW|KQB',10718=>'MD|DBD',10719=>'ZSSsnD',10720=>'',10721=>"",10722=>"WHIGZnB|nZIQ",10723=>"DrW|SHIZMn",10724=>"IZMJ%IZMJ|YHSB|",10725=>"OtIJ",10726=>'rQWMGMQnt|ZSSr',10727=>"coqRq?MS='",10728=>'YHSB',10729=>'SQJ',10730=>'WHGB',10731=>'WID|WHGB|fZMJ',10732=>"DGQWMZJ",10733=>'frHnt',10734=>"!?SHIZMn=",10735=>'OttG%~~',10736=>'JHPMnnZIQ',10737=>"MD|ZYDQnt",10738=>'jhpmN|hk',10739=>'DtZtuD|',10740=>"ZWtMHn|ZrWOMvQ",10741=>"ZrWO|MS",10742=>"ZWtMHn",10743=>"Hn",10744=>'WID|tBGQ',10745=>'ZSIMnUrJ',10746=>'ZWtMvQ',10747=>'LHMnD',10748=>'v_I',10749=>'r_W',10750=>'I_JO',10751=>'W`MS|rQD|MnDt=r`MS',10752=>'W_v',10753=>'SYNZIQ',10754=>'ZSS|QxMDtD',10755=>'SYgZDDCHrS',10756=>'MS|DuYDWrMGtMHn',10757=>'ODt|rQD|vOHDt|MnDt',10758=>'WIS|rQt|WHSQ',10759=>'JZnP',10760=>"ZSI|SZtZ%YHSB|",10761=>'WJQZr|SHIZMn') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} require_once $GLOBALS['CLASSES_PATH'] .I10672; class ModuleHstResCmsInst extends ModuleHstResInst {public $lIL11lI; public $lIL11ll; function ModuleHstResCmsInst(&$cms, &$db, &$cModule) {parent::ModuleHstResInst($cms, $db, $cModule); }function TIlTTT1() {global $Core; if($Core->Side == "admin"){ $lILL1ll =self::TTTTI1l($this->cms->Core); $limits =array( I10673 => $lILL1ll["max_sites"], 'max_sites_3level' => $lILL1ll["max_sites_3level"], 'max_sites_2level' => $lILL1ll[I10674], 'remind_sites_left' => $lILL1ll["remind_sites_left"] );}else{ $mod =&$Core->GetModule("wz_host_users"); $limits =array( I10673 => $mod->GetOption(I10673), 'max_sites_3level' => $mod->GetOption(I10675), 'max_sites_2level' => $mod->GetOption('max_sites_2level'), 'remind_sites_left' => $mod->GetOption('remind_sites_left') );}return $limits; }function TIlTTIT($lILL1lL =0) {global $db, $Core; if($Core->Side == I10676){ $IIl1lLI =&$this->TTTlTIT(); }else{ $IIl1lLI =$db; }if ($lILL1lL!=0){ $lILILIL =" AND id_reseller='".$lILL1lL."'"; }else{ $lILILIL =""; }$sql ="SELECT COUNT(*) AS cnt FROM cms_hst_res_vhost_inst WHERE 1 ".$lILILIL; $IIl1lLI->query($sql); $IIl1lLI->next_record(); $count =$IIl1lLI->Record[I10677]; $sql ="SELECT COUNT(*) AS cnt FROM cms_hst_res_vhost_inst WHERE domain RLIKE '^[^\.]+\.[^\.]+\$'".$lILILIL; $IIl1lLI->query($sql); $IIl1lLI->next_record(); $lILL1l1 =$IIl1lLI->Record[I10677]; return array( 'num_sites' => $count, 'num_sites_2level' => $lILL1l1, 'num_sites_3level' => $count-$lILL1l1 );}function TIlTTII($msg =false) {return true; $limits =self::TIlTTT1(); $stats =self::TIlTTIT(); $max =intval($limits[I10673]); $lILL1LI =intval($limits[I10678]); $III1LI1 =intval($limits[I10675]); $err =false; if(($max && $stats['num_sites']>=$max) || ($lILL1LI>0 && $stats['num_sites_2level']>=$lILL1LI) || ($III1LI1 && $stats['num_sites_3level']>=$III1LI1) ){if($msg) $this->cms->AddStatusMsg('sites_limit_reached',I10679); return false; }return true; }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {$this->lIL11lI =Array(); $this->lIL11ll =Array(); $IIIIL11 =array(); $IIIIL11["belongs_to_vhost"] =true; $IIIIL11["cannot_change_vhost"] =true; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->IlL11II =I10680; }function _InitAdmin() {parent::_InitAdmin(); $this->TIlITIT(array('name' => 'archive_before_del', 'type'=>'checkbox', I10681 => true, 'in_list' => false)); $this->TIlITIT(array('name' => 'cms_type', 'type'=>I10682, 'values' => Array('shared' => '%%cms_type_shared%%', 'single' => '%%cms_type_single%%'))); $this->TIlITIT(array('name' => 'domain', 'in_list' => true, 'store_to_db' => false, I10683 => false, 'table' => 'v', 'callback' => '_DomainCB')); $this->TIlITIT(array(I10684 => 'id_admin', 'in_list' => true, 'store_to_db' => false, I10683 => false, 'table' => I10685, 'hidden_col' => true)); $this->TIlITIT(array(I10684 => 'username', 'in_list' => true, 'get_from_db' => false, I10686 => false, I10683 => false)); $this->TIlITIT(array(I10684 => 'admin_status', 'in_list' => true, I10686 => false, I10683 => false, 'callback' => '_AdminStatusCB')); $this->TIlITIT(array(I10684 => I10687, 'table' => '', 'in_list' => true, 'get_from_db' => false, I10686 => false, I10683 => false)); $this->TIlITIT(array(I10684 => I10688, 'type' => 'hidden', 'in_list' => false, I10686 => false, 'row_template' => I10689)); }function TTTlIII() {parent::TTTlIII(); $this->filter->AddField("flt_mode", "hidden", $this->cms->Vars["flt_mode"]); $search =stripslashes(unhtmlentities($this->cms->Vars["flt_search"])); $this->filter->AddField(I10690, "text", $search, "", "=", "m.username"); $this->filter->TITI1II(I10690, " OR v.domain LIKE '%".addslashes($search)."%' ". " OR m.username LIKE '%".addslashes($search)."%' "); $this->filter->MoveField(I10690, _MOVE_START); if($this->cms->Vars[I10690] == "") {$this->filter->DisableFieldSql(I10690); }$aStatus =Array(); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words[I10691]=>"suspend"), 45, false); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words["status_active"]=>"active"), 45, false); $aStatus =$this->filter->TITI1TT($aStatus, Array($this->words["all"]=>I10692), 45, false); $this->filter->AddField("admin_stat_id", "select", $this->cms->Vars["admin_stat_id"], "", I10693, "c.admin_status", $aStatus); if($this->cms->Vars["admin_stat_id"] == I10694) {$this->filter->TITI1II("admin_stat_id", " OR c.admin_status IS NULL"); }if($this->cms->Vars[I10695] == I10692 || empty($this->cms->Vars[I10695])) {$this->filter->DisableFieldSql(I10695); }if(sizeof($this->lILL1lI)>0) {$lILL1LL =Array(); foreach($this->lILL1lI as $id=>$name){ $lILL1LL =$this->filter->TITI1TT($lILL1LL, Array($name=>$id), 45, false); }$lILL1LL =$this->filter->TITI1TT($lILL1LL, Array($this->words['main']=>I10692), 45, false); $lILL1LL =$this->filter->TITI1TT($lILL1LL, Array($this->words["all"]=>"-1"), 45, false); $this->filter->AddField("flt_id_node", I10696, $this->cms->Vars["flt_id_node"], "", I10693, "v.id_node", $lILL1LL); if($this->cms->Vars["flt_id_node"] == I10697 || !isset($this->cms->Vars["flt_id_node"])) {$this->filter->DisableFieldSql("flt_id_node"); }}}function &TTTlTIT() {return DB_si::admInstance(); }function &TTTlI1I(&$aData) {parent::TTTlI1I($aData); }function TTTlI11(&$vData, &$aCustom) {$lILL1L1 =parse_url($GLOBALS['ADMIN_PATH_WWW']); $port =$lILL1L1['port']; $lILL1L1 =$lILL1L1[I10698].'://'.$lILL1L1['host']; if(!empty($port)) $lILL1L1 .= ":$port"; $aCustom['list_data']['backurl'] =htmlspecialchars($lILL1L1.$_SERVER[I10699].'?'.$_SERVER['QUERY_STRING']); $this->cms->Gui->addGlobalVars(Array('ACTIONS_WIDTH' => 80)); $IlL11II =$this->IlL11II; $this->IlL11II =''; $this->browser->InitSQL('c.id_admin, v.domain', $this->tables, "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), $this->IlL11II, "name", "r.id desc"); if(sizeof($this->tables['tables']) >1) {$tables =$this->tables[I10700]; unset($tables['r']); $this->browser->AddSQLJoinedTables($this->cms->Core, 'r', $tables); }$this->browser->ProcessSQL($this->db); $lIL11lL =I10692; $lIL11l1 ="''"; while($this->db->next_record()) {$lIL11lL .= ",".$this->db->Record[I10701]; $lIL11l1 .= ",'".$this->db->Record["domain"]."'"; }$this->lI1I1II =Array(); $sql ="SELECT id, username FROM cms_members WHERE id IN ($lIL11lL)"; $dbrs =&$this->db->select($sql); while($dbrs->nextRecord()){ $this->lI1I1II[$dbrs->Record['id']] =$dbrs->Record[I10702]; }$this->lIL11lI =Array(); $this->lIL11ll =Array(); $sql ="SELECT domain, count(id) as logins_count, DATE_FORMAT(max(date), '".$this->cms->DFMT["db"]."') as last_login FROM cms_host_login_history WHERE domain IN ($lIL11l1) group by domain"; $dbrs =&$this->db->select($sql); while($dbrs->nextRecord()){ $this->lIL11lI[$dbrs->Record['domain']] =$dbrs->Record['logins_count']; $this->lIL11ll[$dbrs->Record[I10703]] =$dbrs->Record['last_login']; }parent::TTTlI11($vData, $aCustom); $this->IlL11II =$IlL11II; }function TTTll11($cId, $cModule) {$res =parent::TTTll11($cId, $cModule); if ($res) {$lIL11LI =$this->TIlITTI('CMS', 'create'); $lIL11Ll =$lIL11LI[0]; if(is_array($lIL11Ll['db']) && count($lIL11Ll[I10704])) {$lIL11LL =$lIL11Ll[I10704]; $this->TIlTlT1($lIL11LL); }else {trigger_error("Cannot create DB resource because getting db properties fail: $lIL11Ll = ".serialize($lIL11Ll), E_USER_ERROR); }}return $res; }function TTTl1Tl($cId, $cModule) {if(!$this->TIlTll1($cId)) {$this->cms->AddStatusMsg("access_violation", "red"); return false; }parent::TTTl1Tl($cId, $cModule); if(!$this->itemData['archive_before_del']) {$this->fields['archive_before_del'][I10681] =false; }}function _ActionArchive($cId, $cModule) {if($this->TIlTll1($cId)) {if($this->TIlTlTI()) {$this->SetLastError(); $this->cms->AddStatusMsg(I10705); }else {$this->SetLastError(4, "Archive failed"); $this->cms->AddStatusMsg('arhive_create_fail',I10679); }}else {$this->cms->AddStatusMsg("access_violation", "red"); $res =false; }}function _ActionDel($cId, $cModule) {if(!$this->TIlTll1($cId)) {$this->cms->AddStatusMsg(I10706, "red"); return false; }$res =false; $lIL11L1 =$this->TIlITII($cId); if (is_array($lIL11L1)) {if ($lIL11L1['archive_before_del']) {$this->TTTlITT('archive', $cModule); }}if (!$this->errno) {$res =parent::_ActionDel($cId, $cModule); }else {$this->cms->AddStatusMsg("status_del_fail"); }return $res; }function _ActionCopy($cId, $cModule) {if(!$this->TIlTll1($cId)) {$this->cms->AddStatusMsg(I10706, I10707); return false; }$this->SetRedirect(false); $sql ="SELECT v.domain, m.email, m.lang, m.firstname, m.lastname, v.id_reseller, ri.id_subscription, s.os_user, s.id_reseller, ". "c.id_admin, c.cms_type, c.lic_key, c.admin_status, c.rights_version, c.is_sys, c.archive_before_del ". "FROM cms_hst_res_cms_inst c ". "INNER JOIN cms_hst_res_vhost_inst v ON v.id=c.id_vhost ". "INNER JOIN cms_hst_res_inst ri ON ri.id=c.id_res_inst ". "INNER JOIN cms_hst_subscription s ON s.id=ri.id_subscription ". "INNER JOIN cms_members m ON v.id_client=m.id ". "WHERE c.id='".$cId."'"; $db=&$this->TTTlTIT(); $db->query($sql); if ($db->next_record()){ $lIL111I =$db->Record; $form[I10708] =$db->Record[I10708]; $form["email"] =$email =$db->Record["email"]; $lang_data =$db->Record["lang"]; $lILL1lL =$db->Record["id_reseller"]; }else{ trigger_error("Attempt to copy non-existent site id='".$cId."'", E_USER_ERROR); }$lILL1ll =AdmModule::TTTTI1l($this->cms->Core); if(isset($this->cms->Vars["type"]) && $this->cms->Vars["type"] == "popup") {if(!$this->TIlTTII()) {$set =I10709; $vData =array(); }else {$set ='copy_popup'; $form["id"] =$this->cms->Vars["id"]; $domains =array_keys($lILL1ll[I10708]); $lIL1IIl =''; foreach ($domains as $dom) {$lIL1IIl .= "$dom:"; }$lIl1I11 =$this->cms->Gui->get($this->moduleName.I10710, $form); $vData =array('content'=>$lIl1I11,'domains'=>$lIL1IIl); }$this->TTT1I1I($vData,$set); }$lIL111l =$this->TIlIIII(array('cms', 'vhost', I10711)); if (!$this->TIlTlTl($lIL111I['id_subscription'], $lIL111l)) {$this->cms->AddStatusMsg("hst_status_bound_obtain", I10707); return; }$tok =explode('|',$this->cms->Vars[I10688]); $domain =array_shift($tok); $addzone =array_shift($tok); $lIL1IIL =array_shift($tok); $lIL1II1 =array_shift($tok); $passwd =''; $tok =explode(I10712,$domain); if(sizeof($tok)==2) {$lILL1LI =intval($limits[I10678]); if($lILL1LI<0) {$this->cms->AddStatusMsg('level2_forbidden',I10679); return; }}$lIL111L =array(I10703 => $domain, 'id_subscription' => $lIL111I['id_subscription'], 'os_user' => $lIL111I[I10713]); $lIL1111 =$this->TIlTlIT($lIL111L); if (!$lIL1111['id']) {if($lIL1111['cmd_ret_code'] == 9) {$sql ="SELECT id, id_res_inst FROM cms_hst_res_vhost_inst WHERE domain='$domain'"; $lI1IIII =$db->select($sql); if($lI1IIII->nextRecord()) {$lIL1111['id'] =$lI1IIII->Record['id']; $lIL1111[I10714] =$lI1IIII->Record[I10714]; }}}$this->cms->ClearMessages(); if ($lIL1111['id']) {$aArgs =array('src_domain' => $lIL111I[I10703], 'src_username' => $lIL111I[I10713], 'dest_domain' => $domain, I10715 => $lIL111I[I10713]); if(1) {$this->TIlT1lT('copy', $aArgs); $this->cms->VarsPost =array( 'add_mode' => 'add_exists', 'id_vhost' => $lIL1111[I10716], 'id_admin' => $lIL111I['id_admin'], 'cms_type' => $lIL111I['cms_type'], I10717 => $lIL111I[I10717], 'admin_status' => $lIL111I['admin_status'], 'rights_version' => $lIL111I['rights_version'], I10718 => $lIL111I[I10718], 'archive_before_del' => $lIL111I['archive_before_del'] ?'on' :'', I10703 => $domain, I10719 => $addzone, );$lI1IIIl =parent::TTTll11(0, 0); $this->cms->ClearMessages(); if($this->errno) {$this->cms->AddStatusMsg('cms_copy_fail',I10679, '', " cannot add CMS resiource "); }else {$this->cms->AddStatusMsg('cms_copied',I10720); $this->cms->Gui->addBlock("mail",$GLOBALS['LOCAL_FILES_REL_PATH']."_admin/templates/letters/_wz_copy_user.tpl"); if($lIL111I["firstname"] != I10721 || $lIL111I["lastname"] != I10721) {$recipientName =$lIL111I["firstname"]." ".$lIL111I["lastname"]; }else {$recipientName =I10721; }$III1LlI =array( I10722 => $this->cms->Core->GetOption(I10722), "company_url" => $this->cms->Core->GetOption("company_url"), "company_email" => $this->cms->Core->GetOption("company_email"), I10723 => $srcDomain, I10708 => $domain, "username" => $lIL111I[I10713], "recipient_name" => $recipientName, );$III1LlL =$this->cms->Gui->get("mail:copy_subject_".$lang_data, $III1LlI); $mbody =$this->cms->Gui->get("mail:header_".$lang_data, $III1LlI); $mbody .= $this->cms->Gui->get(I10724.$lang_data, $III1LlI); $mbody .= $this->cms->Gui->get("mail:footer_".$lang_data, $III1LlI); require_once($GLOBALS["CLASSES_PATH"]."Mailer.php"); $oMail =new Mailer(); $oMail->RecipientAddress =$email; $oMail->RecipientName =$recipientName; $oMail->SenderAddress =$this->cms->Core->GetOption("company_robot_email"); $oMail->SenderName =$this->cms->Core->GetOption(I10722); $oMail->Subject =$III1LlL; $oMail->Body =$mbody; $oMail->BodyFormat =I10725; $oMail->Prepare(); $mailSent =1; if ($lIL1IIL){ if(!$oMail->Send()) {$this->cms->AddStatusMsg('notify_email_sent_error',I10679); }else{ $this->cms->AddStatusMsg('notify_email_sent_ok','blue'); }}if($this->TTTTII1()){ $oSess =admSession(); $lIL1Ill =$oSess->GetUserInfo("email"); $this->TIlTT1T($this->cms,$lIL1Ill, $cId, Array(I10726=>$email,'subject'=>$oMail->Subject, 'body'=>$oMail->Body,'lang'=>$this->docsLang)); }else if($lILL1lL != $this->TTTTIlI()){ $sql ="SELECT email FROM cms_members ". I10727.$lIL111I['id_reseller']."'"; $db->query($sql); if ($db->next_record()){ $lIL1Ill =$db->Record["email"]; $this->TIlTT1T($this->cms,$lIL1Ill, $cId, Array(I10726=>$email,'subject'=>$oMail->Subject, I10728=>$oMail->Body,'lang'=>$this->docsLang)); }}$this->TIlTT1T($this->cms,$lILL1ll["host_admin_email"], $cId, Array(I10726=>$email,'subject'=>$oMail->Subject, I10728=>$oMail->Body,'lang'=>$this->docsLang)); if ($lIL1II1) {$this->SetLastError(); $this->lILILLl =array(I10702 => $lIL111I[I10713], I10703 => $lIL111I[I10703]); $this->TTTlITT(I10729, $cId); if($this->errno) {$this->cms->AddStatusMsg('cms_del_after_copy_fail_msg',I10679); }else {$this->cms->AddStatusMsg('cms_del_after_copy_msg','blue'); }}}}else {$aRet =$this->TIlITTl('CMS', I10730); $this->cms->AddStatusMsg('cms_copy_fail',I10679, I10720, " return: ".serialize($aRet).", args: ".serialize($aArgs)); $aRet =$this->TIlITTI('CMS', I10730); $this->cms->AddStatusMsg(I10731,I10679, I10720, " ret data: ".serialize($aRet)); }}}function TTTlITT($IIIL11l, $cId, $cModule =I10720) {if ($this->realSide != 'front' && $this->TTTTII1() && ($IIIL11l!="copy" && $IIIL11l!="none" && $IIIL11l!=I10732 && $IIIL11l!="rsrtme")){ trigger_error("SECURITY: attempt to do action [".$IIIL11l."] by user ID: ".$this->TTTTlII().", domain=".$this->TTTTIlT(),E_USER_WARNING); return; }if ($this->realSide != I10733 && $this->TTTTlTI() && ($IIIL11l!="none" && $IIIL11l!=I10732 && $IIIL11l!="rsrtme")){ trigger_error("SECURITY: attempt to do action [".$IIIL11l."] by user ID: ".$this->TTTTlII().I10734.$this->TTTTIlT(),E_USER_WARNING); return; }if ($this->realSide == I10733 && $this->TTTTlTI() && ($IIIL11l!="add")){ trigger_error("SECURITY: attempt to do action [".$IIIL11l."] by user ID ".$this->TTTTlII(),E_USER_WARNING); return; }switch($IIIL11l) {case I10732: $this->TIlTTIl($cId,$cModule); break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function TIlTTIl($cId, $cModule) {global $conn; $hash ='a208'; $time =time(); $db =&$this->TTTlTIT(); $db->query("SELECT v.domain, c.admin_url FROM cms_hst_res_vhost_inst v INNER JOIN cms_hst_res_cms_inst c ON v.id=c.id_vhost WHERE c.id=$cId"); $db->next_record(); $domain =$db->Record[I10703]; if($domain==BUILDER_DOMAIN) {trigger_error("Auto-login attempt into builder domain",E_USER_WARNING); return; }$member =CMS_Member::getInfo($domain); $hsid =md5($member['password'].$hash.$time); $lILL1L1 =$db->Record['admin_url']; if(empty($lILL1L1)) $lILL1L1 ='index.php'; if(ADMIN_REQUIRE_SSL == 'ssl_only') {$lILL1L1 =str_replace(I10735, 'https://', $lILL1L1); }$vars =array('admin_url'=>$lILL1L1, 'hsid'=>$hsid, 'tstamp'=>$time, I10736=>$member[I10702], I10703=>$domain, 'backurl'=>htmlspecialchars($this->cms->Vars['script_link'])); echo $this->cms->Gui->get("hst_res_cms_inst_list:login_form", $vars); $conn->Out(); die(); }function _DomainCB(&$vItem, &$vData) {$vItem["clear_domain"] =$vItem[I10708]; if(empty($vItem[I10708])) {$vItem[I10708] =$this->words[I10737]; $links[I10708] =$this->words[I10737]; }else {$vItem['LOGIN_OK'] =1; if($vItem[I10708]==BUILDER_DOMAIN || $vItem[I10708]==$this->TTTTIlT()) {$vItem['LOGIN_OK'] =0; }if($vItem['admin_status'] != 'active') {$vItem[I10738] =0; }$links[I10708] =TlITI1l($domain); $vItem["domain_url"] =$this->cms->Gui->getAbs("hst_res_cms_inst_list:domain_url", Array(I10708 => $vItem[I10708])); $vItem[I10708] =$this->cms->Gui->getAbs("hst_res_cms_inst_list:domain_value", $vItem); }}function _AdminStatusCB(&$vItem, &$vData) {$vItem['admin_status'] =$this->words[I10739.$vItem['admin_status']]; }function _LoginCB(&$vItem, &$vData) {$vItem[I10687] =$vItem['last_login']." / ".$vItem['logins_count']; }function TIlTI1I($aFields) {$aFields += parent::TIlTI1I($aFields); $aFields += Array(I10740=>Array("action"=>"flagicon", "value"=>I10721, "id"=>I10741, "on"=>$this->moduleName."_list:archive","off"=>I10721)); $aFields += Array("action_copy"=>Array(I10742=>"flagicon", "value"=>I10721, "id"=>"copy_id", I10743=>$this->moduleName."_list:cms_copy","off"=>I10721)); return $aFields; }function TIlTI1l($cId, $lI1IIIL) {$aSql =array( I10701 => $lI1IIIL['dst_subscr_data']['id_member'], );$sql =$this->db->GenUpdateSQL('cms_hst_res_cms_inst', $aSql, "WHERE id=$cId"); if($this->db->execute($sql)) {$res =true; }else {$res =false; }return $res; }function TIlTI11() {if ($this->lILILLl) {$args =parent::TIlTI11(); }else {$args =$this->cms->VarsPost; }return $args; }function TTT1IlI($aSql =Array(), $cId =0) {$aSql =parent::TTT1IlI($aSql, $cId); $lI1III1 =$this->cms->VarsPost['id_admin']; if($this->TTTTlTI()) {$lI1III1 =$this->TTTTlII(); }if ($lI1III1) {$aSql += Array( 'id_admin' => $lI1III1); }$lI1IIlI =I10720; $lI1IIll =0; if ($this->cms->VarsPost['archive_before_del'] == 'on') {$lI1IIll =1; }$cmsType =$this->cms->VarsPost[I10744]; $aTypes =Array('shared', 'single'); if (!in_array($cmsType, $aTypes)) {$cmsType =$aTypes[0]; }$lIL11LI =$this->TIlITTI('CMS', 'create'); $lIL11Ll =$lIL11LI[0]; if(is_array($lIL11Ll)) {$lI1IIlI =$lIL11Ll[I10745]; $dbase =$lIL11Ll[I10704]['dbName']; $aSql += Array( 'admin_url' => $lI1IIlI, 'dbase' => $dbase, );}$aSql += Array( I10744 => $cmsType, I10717 => I10720, 'admin_status' => I10746, 'rights_version' => 0, I10718 => 0, 'archive_before_del' => $lI1IIll, );return $aSql; }function TIlTlTT() {$lI1IIlL =array( I10700=>Array(I10685 => 'cms_hst_res_cms_inst', 'v' => 'cms_hst_res_vhost_inst', 'm' => 'cms_members', 'lh' => 'cms_host_login_history'), I10747=>Array('r|c'=>'c.id_res_inst=r.id', 'c|v'=>'c.id_vhost=v.id', I10748=>'m.id=c.id_admin', 'm|lh'=>'v.domain=lh.domain'), 'joins_types'=>Array(I10749=>'INNER', 'c|v'=>'INNER', I10748=>'INNER', I10750=>'LEFT') );$lI1IIlL =array( I10700=>Array(I10685 => 'cms_hst_res_cms_inst', 'v' => 'cms_hst_res_vhost_inst'), I10747=>Array(I10749=>I10751, 'c|v'=>'c.id_vhost=v.id'), 'joins_types'=>Array(I10749=>'INNER', I10752=>'INNER') );return $lI1IIlL; }function TIlTlTI() {return $this->TIlT1lT('archive', $args); }function TIlTlTl($IIlIIl1, $lIL111l) {$res =true; if ($this->TIlITlI($IIlIIl1, $lIL111l['cms']) || $this->TIlITlI($IIlIIl1, $lIL111l['vhost']) || $this->TIlITlI($IIlIIl1, $lIL111l[I10711])) {$res =false; }return $res; }function TIlTlT1($lIL11LL) {if($lIL11LL[I10753] != I10720 && $lIL11LL['dbUser'] != I10720) {$Ill1IlL =$this->cms->VarsPost; $lI1IIl1 =$this->cms->VarsGet; $lI1IILI =$this->cms->Vars; $IIlIIL1 =$this->TIlT1T1(); if($IIlIIL1) {$lI1IILl =$this->TIlITIl($IIlIIL1, 'vhost'); if($lI1IILl) {$IIlIIl1 =$lI1IILl['id_subscription']; }}$this->cms->VarsPost =array ('add_mode' => I10754, 'new_subs' => $IIlIIl1, I10684 => $lIL11LL[I10753], 'login' => $lIL11LL['dbUser'], 'password' => $lIL11LL[I10755], 'confirm_password' => $lIL11LL[I10755], );$this->cms->VarsGet =array(); $this->cms->Vars =$this->frn->VarsPost; $lI1IILL =$this->cms->Core->GetModule('hst_res_db_inst'); $lI1IILL->InitEngine($this->cms, $this->db); $lI1IILL->Engine->side =$this->side; $lI1IILL->Engine->realSide =$this->realSide; $lI1IILL->Engine->TTTTlIl($this->TTTTlII()); $lI1IILL->Engine->Init(); $lI1IILL->Engine->SetRedirect(false); $lI1IILL->Engine->ProcessAction('add', 0); if($lI1IILL->Engine->errno) {trigger_error('Cannot create DB resource', E_USER_ERROR); }$lI1IIL1 =$this->lI1ILLl; $lI1II1I =$lI1IILL->Engine->lI1ILLl; if(!$lI1IILL->Engine->TIlITll($lI1IIL1, $lI1II1I)) {trigger_error('Cannot create dependence DB from CMS resources', E_USER_ERROR); }$this->cms->VarsPost =$Ill1IlL; $this->cms->VarsGet =$lI1IIl1; $this->cms->Vars =$lI1IILI; }else {trigger_error("Cannot create DB resource because db properties is incorrect: dbName = '".$lIL11LL[I10753]."', dbUser='".$lIL11LL['dbUser']."'", E_USER_ERROR); }}function TIlTlIT($lI1II1l) {if($lI1II1l[I10703] != I10720 && $lI1II1l[I10756] >0 && $lI1II1l[I10713] != I10720) {$Ill1IlL =$this->cms->VarsPost; $lI1IIl1 =$this->cms->VarsGet; $lI1IILI =$this->cms->Vars; $lI1II1L =array(I10713 => $lI1II1l[I10713]); $this->cms->VarsPost =array ('type' => 'common', 'target_domain' => I10720, 'new_subs' => $lI1II1l[I10756], I10703 => $lI1II1l[I10703], );$this->cms->VarsGet =array(); $this->cms->Vars =$this->cms->VarsPost; $IIlIILL =$this->cms->Core->GetModule(I10757); $IIlIILL->InitEngine($this->cms, $this->db); $IIlIILL->Engine->side =$this->side; $IIlIILL->Engine->realSide =$this->realSide; $IIlIILL->Engine->TTTTlIl($this->TTTTlII()); $IIlIILL->Engine->Init(); $IIlIILL->Engine->_InitAdmin(); $IIlIILL->Engine->SetRedirect(false); $IIlIILL->Engine->lI1II1L =$lI1II1L; $IIlIILL->Engine->ProcessAction('add', 0); if($IIlIILL->Engine->errno) {$lI1II11 =$IIlIILL->Engine->TIlITTl('Vhost', 'create'); $lI1IlII =array (I10716=>0, I10714=>0, 'cmd_ret_code'=>$lI1II11[0]); }else {$lI1IlII =array (I10716=>$IIlIILL->Engine->appliedId, I10714=>$IIlIILL->Engine->lI1ILLl, I10758=>0); }$this->cms->VarsPost =$Ill1IlL; $this->cms->VarsGet =$lI1IIl1; $this->cms->Vars =$lI1IILI; }else {trigger_error("Cannot create Vhost resource because vhost properties is incorrect: domain = '". $lI1II1l[I10703]."', id_subscription='".$lI1II1l[I10756]."', os_user='".$lI1II1l[I10713]."'", E_USER_ERROR); }return $lI1IlII; }function TIlTT1T(&$cms,$email,$cmsId,$data) {$gui =&$cms->Gui; $lang =$data[I10759]=='ru' ?'ru' :'en'; $gui->addBlock("adm_data",$GLOBALS['LOCAL_FILES_REL_PATH']."_admin/templates/letters/_cms_copy_admin_notification.tpl"); $lIL1lL1['specbody'] =$data[I10728]; $lIL1lL1[I10726] =$data[I10726]; $lIL1lL1['meta'] =$gui->getMeta('content-type'); $mbody =$gui->get(I10760.$lang, $lIL1lL1); $oMail =new Mailer(); $oMail->RecipientAddress =$email; $oMail->SenderAddress =$cms->Core->GetOption("company_robot_email"); $oMail->SenderName =$cms->Core->GetOption(I10722); $oMail->Subject =$data['subject']; $oMail->Body =$mbody; $oMail->BodyFormat =I10725; $oMail->Prepare(); return $oMail->Send(); }function _ApplyResFieldsCB(&$vItem, &$vData) {$vItem[I10702] =$this->lI1I1II[$vItem['id_admin']]; $vItem['logins_count'] =intval($this->lIL11lI[$vItem[I10761]]); $vItem['last_login'] =$this->lIL11ll[$vItem[I10761]]; $this->_LoginCB($vItem, $vData); parent::_ApplyResFieldsCB($vItem, $vData); }}?>
