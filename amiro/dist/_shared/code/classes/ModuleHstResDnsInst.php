<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       32822 xkqwixpnllnxrykypqpmgygsmykwtmlnugkqimwpykmyssswpqyipqpkznrsrrgykmygpnir
 */ ?><?php foreach(array(10773=>"YQJHnPD|tH|vOHDt",10774=>"tQxt",10775=>"fJt|SHIZMn",10776=>'ZWtMHn',10777=>"",10778=>'nQC|rQWHrS|MS',10779=>'ZsnDRQWHrSD',10780=>'tBGQ',10781=>"'{^\n",10782=>'LHMnD',10783=>'LHMnD|tBGQD',10784=>'tZYJQD',10785=>"v`MS?SQDW",10786=>"MS|rQDQJJQr",10787=>'rQWHrSD|WHunt',10788=>'uDQrnZIQ',10789=>"fMQJSD",10790=>"rQWHrSD|WHunt",10791=>"MS",10792=>"ZWtMHn|SQJ",10793=>"Hn",10794=>"WZJJYZWK",10795=>"`MS",10796=>"JQP|SQJ",10797=>"WZnWQJ",10798=>'MS',10799=>"#G@zWtMHn?ZSS#Yr@",10800=>'ZsQDtrHBRQWHrSD',10801=>'',10802=>'MS|DuYDWrMGtMHn',10803=>"rQS",10804=>'ZwrQZtQRQWHrSD',10805=>'vOHDt',10806=>"DtZtuD|ZSS|fZMJ",10807=>"DtZtuD|ZGGJB|fZMJ",10808=>"+1",10809=>"zGGJB?fZMJQS",10810=>"sQJQtMnP?fZMJQS",10811=>'rQWHrSD|HrSQr',10812=>"Sr|ttJ|",10813=>'GrMHrMtB',10814=>'nZIQ',10815=>"iX",10816=>'ZNHwOZnPQRQWHrSD',10817=>'S',10818=>'v`MS|rQD|MnDt=r`MS',10819=>'Dr_v',10820=>"?hR",10821=>'MS|rQD|MnDt') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleHstResDnsInst extends ModuleHstResInst {public $lI1IlIl; function ModuleHstResDnsInst(&$cms, &$db, &$cModule) {parent::ModuleHstResInst($cms, $db, $cModule); }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {$this->lI1IlIl =Array(); $IIIIL11 =array(); $IIIIL11[I10773] =false; $IIIIL11["cannot_change_vhost"] =true; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin() {parent::_InitAdmin(); }function TTTlIII() {parent::TTTlIII(); if($this->filter->issetField("flt_subscription")) {$this->filter->TITI1l1("flt_subscription"); }$this->filter->AddField("flt_subscription", I10774, stripslashes(unhtmlentities($this->cms->Vars["flt_subscription"])), "", " like ", "v.id_subscription"); $this->filter->AddField(I10775, I10774, stripslashes(unhtmlentities($this->cms->Vars[I10775])), "", " like ", "v.domain"); }function &TTTlI1I(&$aData) {$vars =array( 'IS_ADMIN' => intval($this->TTTTIIl() || $this->TTTTII1()), );$this->cms->Gui->addGlobalVars($vars); if($this->cms->Vars[I10776] == "edit" || $this->cms->Vars[I10776] == "print" || $this->cms->Vars[I10776] == "save") {$aData["add_exists_records_rows"] =I10777; if(is_array($this->itemData['aDnsRecords']) && count($this->itemData['aDnsRecords'])) {$aData['add_exists_records_rows'] =''; $aData[I10778] =count($this->itemData['aDnsRecords'])+1; for ($i =0; $i <count($this->itemData['aDnsRecords']); $i++) {$aData['add_exists_records_rows'] .= "insertDnsRecordRow('". $this->itemData[I10779][$i]['name']."', '". $this->itemData[I10779][$i]['ttl']."', '". $this->itemData[I10779][$i][I10780]."', '". $this->itemData[I10779][$i]['priority']."', '". $this->itemData[I10779][$i]['value'].I10781; }}$aData['records_capt'] =$this->cms->Gui->get($this->moduleName."_subform:records_caption", $this->itemData); }ModuleHst::TTTlI1I($aData); }function TTTlI11(&$vData, &$aCustom) {$lI1IlIL =array( 'tables'=>array('s' => 'cms_hst_subscription', 'r' => 'cms_hst_res_inst', 'v' => 'cms_hst_res_vhost_inst'), I10782=>Array('s|r'=>'s.id=r.id_subscription', 'r|v'=>'v.id_res_inst=r.id'), I10783=>Array('s|r'=>'INNER', 'r|v'=>'INNER') );$tables =$lI1IlIL[I10784]; if(sizeof($lI1IlIL[I10784]) >1) {unset($tables['r']); }$this->browser->InitSQL("v.id, r.id_member, r.id_reseller", $lI1IlIL, "WHERE v.has_dns>0 ".$this->_ApplyFilters().$this->TTTlIl1(), I10777, "domain", I10785 );if(sizeof($tables) >1) {$this->browser->AddSQLJoinedTables($this->cms->Core, 'r', $tables); }$this->browser->ProcessSQL($this->db); $lI1IlI1 =Array(); $lI1IllI =Array(); while($this->db->next_record()) {$lI1IlI1[] =$this->db->Record["id"]; $lI1IllI[] =$this->db->Record["id_member"]; if($this->db->Record["id_reseller"] >0 ){$lI1IllI[] =$this->db->Record[I10786]; }}$lI1IlIl =Array(); if (count($lI1IlI1)) {$sql ="SELECT id_vhost, count(id) as records_count FROM cms_hst_res_dns_inst WHERE id_vhost IN (".implode(",",$lI1IlI1).") group by id_vhost"; $dbrs =&$this->db->select($sql); while ($dbrs->nextRecord()){ $lI1IlIl[$dbrs->Record['id_vhost']] =$dbrs->Record[I10787]; }}$lI1IllI =array_unique($lI1IllI); $this->lI1I1II =Array(); if (count($lI1IllI) >0 && $lI1IllI[0] != 0) {$sql ="SELECT id, username FROM cms_members WHERE id IN (".implode(",", $lI1IllI).")"; $dbrs =&$this->db->select($sql); while($dbrs->nextRecord()){ $this->lI1I1II[$dbrs->Record['id']] =$dbrs->Record[I10788]; }}$this->lI1IlIl =$lI1IlIl; $this->browser->InitSQL("v.id, v.id_subscription, v.domain", $lI1IlIL, "WHERE v.has_dns>0 ".$this->_ApplyFilters().$this->TTTlIl1(), I10777, "domain", I10785 );if(sizeof($tables) >1) {$this->browser->AddSQLJoinedTables($this->cms->Core, 'r', $tables); }$aCustom[I10789] += Array( "domain"=>Array("action"=>"stripline", "size"=>120), I10790=>Array("action"=>"callback", "object"=>&$this, "method"=>'_FormatRecordsCount'), "action_edit"=>Array("action"=>"flagicon", "value"=>I10777, I10791=>"edit_id", "on"=>$this->moduleName."_list:edit","off"=>I10777), I10792=>Array("action"=>"flagicon", "value"=>I10777, I10791=>"del_id", I10793=>$this->moduleName."_list:del","off"=>I10777), "res_fields" => Array("action"=>I10794, "object"=>&$this, "method"=>"_ApplyResFieldsCB"), );$aCustom["applied_id"] =$this->lI1IL1L.I10795; $aCustom["legend"] =Array("leg_yellow", "leg_blue", "leg_edit", I10796); $aCustom["form_data"]["buttons"] =Array("add", "apply", I10797, "save"); ModuleHst::TTTlI11($vData, $aCustom); }function _ApplyFilters($prefix ='', $bodyType ='', $IIlLLl1 =true) {$res =ModuleHst::_ApplyFilters($prefix, $bodyType, $IIlLLl1); return $res; }function TTT1IlI($aSql =Array(), $cId =0) {$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TTTl1Tl($cId, $cModule) {if($this->TIlTll1($cId)) {ModuleHst::TTTl1Tl($cId, $cModule); if(intval($cId)) {$lI1Illl =$this->TIlITIl($cId, 'vhost'); if(is_array($lI1Illl)) {$this->itemData =$lI1Illl; $this->IIlIIL1 =$this->itemData[I10798]; $this->IIlIIl1 =$this->itemData['id_subscription']; $this->lI1ILLl =0; $this->itemData[I10779] =$this->TIlTlIl($this->IIlIIL1); if(is_array($this->itemData[I10779]) && count($this->itemData[I10779])) {$this->lI1ILLl =$this->itemData[I10779][0]['id_res_inst']; }}}}else {$this->cms->AddStatusMsg("access_violation", "red"); }}function TTTll11($cId, $cModule) {echo I10799; return false; }function TTTl1lI($cId, $cModule) {$res =true; $access =true; if($this->TTTTlTI()) {$access =$this->TIlTll1($cId); }if($access) {$aArgs =$this->TIlTI11(); if(count($aArgs['aDestroyRecords'])) {$lI1IllL =Array('domain' => $aArgs['domain'], 'records' => $aArgs[I10800]); if($this->TIlT11T($lI1IllL)) {if(!$this->TIlTlI1($aArgs[I10800])) {$this->cms->AddStatusMsg("status_del_obsolete_records_fail", "red"); $res =false; }}else {$this->cms->AddStatusMsg("hst_status_del_obsolete_records_fail", "red", I10801, I10801, array('text'=>$this->TIlT1II())); $res =false; }}if($res) {if(count($aArgs['aNoChangeRecords']) || count($aArgs['aCreateRecords'])) {if(count($aArgs['aCreateRecords'])) {$aSql =$this->TIlT1Tl(); $lI1Ill1 =true; if($this->IIlIIl1 != $aSql[I10802] || !$this->lI1ILLl) {if ($this->TIlITlI($aSql[I10802], $aSql['id_res'])) {$lI1Ill1 =false; $this->cms->AddStatusMsg("hst_status_bound_obtain", "red"); $this->cms->AddStatusMsg("status_add_fail", I10803); $res =false; }}if($lI1Ill1) {$lI1IlLI =Array('domain' => $aArgs['domain'], 'records' => $aArgs['aCreateRecords']); $lI1IlLl =$this->TIlT1l1($lI1IlLI); $lI1IlLL =false; if(!$lI1IlLl) {$lI1IlL1 =$this->TIlTlll($aArgs[I10804]); if (count($lI1IlL1)) {$lI1IlLL =true; }}if($lI1IlLl || $lI1IlLL) {$lI1Il1I =true; if(!$this->lI1ILLl) {$sql =$this->db->GenInsertSQL('cms_hst_res_inst', $aSql); if($this->db->execute($sql)) {$this->lI1ILLl =$this->db->lastInsertId(); if(!$this->TIlITlT($aSql[I10802], $aSql['id_res'], "+1")) {$this->cms->AddStatusMsg("hst_status_used_value_update_fail", I10803); $lI1Il1I =false; }$lI1IILl =$this->TIlITIl($this->IIlIIL1, I10805); $lI1Il1l =$lI1IILl['id_res_inst']; if(!$this->TIlITll($lI1Il1l, $this->lI1ILLl)) {$this->cms->AddStatusMsg("hst_status_add_dependence_fail", I10803); $lI1Il1I =false; }}else {$lI1Il1I =false; }if ($lI1Il1I) {$this->cms->AddStatusMsg("status_add", "blue"); }else {$this->cms->AddStatusMsg(I10806, I10803); $res =false; }}if($res && $this->lI1ILLl) {if ($lI1IlLL) {$lI1Il1L =$lI1IlL1; }else {$lI1Il1L =$aArgs[I10804]; }if(!$this->TIlTllT($lI1Il1L)) {$this->cms->AddStatusMsg("status_apply_fail", I10803); $res =false; }}}if(!$lI1IlLl) {$this->cms->AddStatusMsg("hst_status_apply_fail", I10803, I10801, I10801, array('text'=>$this->TIlT1II())); if ($lI1IlLL) {$this->cms->AddStatusMsg("status_apply_partially"); }else {$this->cms->AddStatusMsg(I10807, I10803); }$res =false; }}}}else {if($this->lI1ILLl) {$this->cms->AddStatusMsg("hst_status_deleting_empty_resource", "blue"); $sql ="DELETE FROM cms_hst_res_inst WHERE id='".$this->lI1ILLl."'"; if($this->db->execute($sql)) {if(!$this->TIlITlT($this->IIlIIl1, $this->I1ILIII, I10808)) {$this->cms->AddStatusMsg("hst_status_used_value_update_fail", I10803); $res =false; }}else {$this->cms->AddStatusMsg("status_del_fail", I10803); $res =false; }}}}}else {$this->cms->AddStatusMsg("access_violation", I10803); $res =false; }if($res) {$this->cms->AddStatusMsg("status_apply"); $this->SetLastError(); }else {$this->SetLastError(1, I10809); }$this->appliedId =$cId; $this->TTT1I1T(); }function _ActionDel($cId, $cModule) {$res =true; if($this->TIlTll1($cId)) {$this->cms->VarsPost['records_order'] =I10801; $aArgs =$this->TIlTI11(); if($this->TIlITl1()) {if(count($aArgs[I10800])) {$lI1IllL =Array('domain' => $aArgs['domain'], 'records' => $aArgs[I10800]); if($this->TIlT11T($lI1IllL)) {if(!$this->TIlTlI1($aArgs[I10800])) {$res =false; }}else {$this->cms->AddStatusMsg("hst_status_del_fail", I10803, I10801, I10801, array('text'=>$this->TIlT1II())); $res =false; }}if($this->lI1ILLl && $res) {$sql ="DELETE FROM cms_hst_res_inst WHERE id='".$this->lI1ILLl."'"; if($this->db->execute($sql)) {if($this->TIlITlT($this->IIlIIl1, $this->I1ILIII, I10808)) {if(!$this->TIlIT1l($this->lI1ILLl)) {$this->cms->AddStatusMsg("hst_status_del_dependence_fail", I10803); $res =false; }}else {$this->cms->AddStatusMsg("hst_status_used_value_update_fail", I10803); $res =false; }}else {$res =false; }}}else {$this->cms->AddStatusMsg("hst_status_del_depended_resources_fail", I10803); $res =false; }}else {$this->cms->AddStatusMsg("access_violation", I10803); $res =false; }if($res) {$this->SetLastError(); $this->cms->AddStatusMsg("status_del"); }else {$this->cms->AddStatusMsg("status_del_fail"); $this->SetLastError(3, I10810); }}function _ActionMove($cId, $cModule) {$res =true; $access =true; if($this->TIlTll1($cId)) {$this->IIlIIl1 =$this->cms->VarsPost['current_subs']; parent::_ActionMove($cId, $cModule); }else {$this->cms->AddStatusMsg("access_violation", I10803); $res =false; }if($res) {$this->SetLastError(); $this->cms->AddStatusMsg("status_move"); }else {$this->cms->AddStatusMsg("status_move_fail"); }}function TIlTlII() {$aSql =Array(); if(isset($this->cms->VarsPost[I10811]) && $this->cms->VarsPost[I10811] != I10801) {$lI1Il11 =explode(';', $this->cms->VarsPost[I10811]); foreach ($lI1Il11 as $recordId) {$lI1ILII =Array( 'name' => $this->cms->VarsPost["dr_name_".$recordId], 'ttl' => $this->cms->VarsPost[I10812.$recordId], I10780 => $this->cms->VarsPost["dr_type_".$recordId], 'value' => $this->cms->VarsPost["dr_value_".$recordId], );if($lI1ILII[I10780] == "MX") {$lI1ILII[I10813] =$this->cms->VarsPost["dr_priority_".$recordId]; }$aSql[] =$lI1ILII; }}return $aSql; }function TIlTI11() {$args =array(); $args['domain'] =$this->lILILLl['domain']; $lI1ILIl =$this->TIlTlII(); $lI1ILIL =Array(); if (count($this->lILILLl[I10779])) {foreach ($this->lILILLl[I10779] as $lI1ILI1) {$lI1ILlI =false; if (count($lI1ILIl)) {foreach ($lI1ILIl as $lIILll1) {if ($lI1ILI1['name'] == $lIILll1[I10814] && $lI1ILI1['ttl'] == $lIILll1['ttl'] && $lI1ILI1[I10780] == $lIILll1[I10780] && $lI1ILI1['value'] == $lIILll1['value']) {if($lIILll1[I10780] != I10815 || $lI1ILI1[I10813] == $lIILll1[I10813]) {$lI1ILlI =true; break; }}}}if(!$lI1ILlI) {$lI1ILIL[] =$lI1ILI1; }}}$args[I10800] =$lI1ILIL; $lI1ILll =Array(); $lI1ILlL =Array(); if (count($lI1ILIl)) {foreach ($lI1ILIl as $lIILll1) {$lI1ILlI =false; if (count($this->lILILLl[I10779])) {foreach ($this->lILILLl[I10779] as $lI1ILI1) {if ($lI1ILI1[I10814] == $lIILll1[I10814] && $lI1ILI1['ttl'] == $lIILll1['ttl'] && $lI1ILI1[I10780] == $lIILll1[I10780] && $lI1ILI1['value'] == $lIILll1['value']) {if($lIILll1[I10780] != I10815 || $lI1ILI1[I10813] == $lIILll1[I10813]) {$lI1ILlI =true; break; }}}}if(!$lI1ILlI) {$lI1ILll[] =$lIILll1; }else {$lI1ILlL[] =$lIILll1; }}}$args[I10804] =$lI1ILll; $args[I10816] =$lI1ILlL; return $args; }function TIlTlTT() {$lI1IIlL =array( I10784=>Array('sr' => 'cms_hst_subscription_res', 'v' => 'cms_hst_res_vhost_inst', I10817 => 'cms_hst_res_dns_inst'), I10782=>Array('r|sr'=>'sr.id_subscription=s.id', 'sr|v'=>I10818, 'v|d'=>'d.id_vhost=v.id'), I10783=>Array('r|sr'=>'INNER', I10819=>'INNER', 'v|d'=>'LEFT') );return $lI1IIlL; }function TIlTlIl($lI1ILl1) {$aRecords =Array(); $sql ="SELECT * FROM cms_hst_res_dns_inst WHERE id_vhost='$lI1ILl1'"; $this->db->query($sql); if ($this->db->num_rows()) {while ($this->db->next_record()) {$aRecords[] =$this->db->Record; }}return $aRecords; }function TIlTlI1($lI1ILLI) {$res =true; if(is_array($lI1ILLI) && count($lI1ILLI)) {$sql=I10801; foreach ($lI1ILLI as $aRecord) {if($sql == I10801) {$sql .= "DELETE FROM cms_hst_res_dns_inst WHERE"; }else {$sql .= I10820; }$sql .= " id='".$aRecord[I10798]."'"; }if(!$this->db->query($sql)) {$res =false; }}return $res; }function TIlTllT($lI1ILLI) {if(is_array($lI1ILLI) && count($lI1ILLI)) {foreach ($lI1ILLI as $aRecord) {$aRecord['id_res_inst'] =$this->lI1ILLl; $aRecord['id_vhost'] =$this->IIlIIL1; $sql =$this->db->GenInsertSQL('cms_hst_res_dns_inst', $aRecord); $this->db->execute($sql); }}return true; }function TIlTllI($lI1ILLl) {$res =false; $sql ="SELECT d.id_vhost FROM cms_hst_res_inst r INNER JOIN cms_hst_res_dns_inst d ON d.id_res_inst=r.id WHERE d.id_res_inst='$lI1ILLl'"; $dbrs =&$this->db->select($sql); if($dbrs->nextRecord()){ $res =$dbrs->Record['id_vhost']; }return $res; }function _FormatRecordsCount(&$vItem, &$vData) {$vItem[I10790] =FormatNumber(intval($this->lI1IlIl[$vItem[I10791]]), 0, 0); }function TIlTlll($lI1ILLL) {$lI1IlL1 =Array(); $lI1II11 =$this->TIlITTl('DNS', 'addRecord'); if ($lI1II11 !== false && count($lI1II11)) {for ($i =0; $i <count($lI1II11); $i++) {if ($lI1II11[$i] == 0) {$lI1IlL1[] =$lI1ILLL[$i]; }}}return $lI1IlL1; }function TIlTll1($cId, $lI1ILL1 =true) {if ($this->TTTTIIl()) {return true; }if ($this->TTTTlTI()) {$field ="id_member"; }if ($this->TTTTII1()) {$field =I10786; }$lIL11L1 =$this->TIlITIl($cId, I10805); if($lIL11L1 == false) {return false; }$sql ="SELECT $field FROM cms_hst_res_inst WHERE id='".$lIL11L1[I10821]."'"; $idOwner =$this->db->getValue($sql); if($idOwner == $this->TTTTlII()) {return true; }if($lI1ILL1) {$this->cms->AddStatusMsg("status_resource_access_deny", I10803); }return false; }}?>