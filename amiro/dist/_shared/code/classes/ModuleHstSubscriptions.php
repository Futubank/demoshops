<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       84895 xkqwlnpyxqmzqtkksmpyqsmmpyxzysxpxmuulmmnilpgmmtsxpltnwwwkxgskmrwpsznpnir
 */ ?><?php foreach(array(11092=>'wjzddqd|gzTo',11093=>"D",11094=>"zWWQDD?vMHJZtMHn`",11095=>"tQxt",11096=>"fJt|SZtQQnS|frHI",11097=>"imN",11098=>"?#=?",11099=>"?JMKQ?",11100=>'nZIQ',11101=>"?=?",11102=>"D`HD|uDQr",11103=>'md|zsimN',11104=>"%WJMQnt|OMSSQn",11105=>"?zNs?I`JZnP='",11106=>'tZYJQD',11107=>'LHMnD',11108=>'jqFT',11109=>'I',11110=>"",11111=>"MS|GQrMHS",11112=>"GOG",11113=>"GKP|rHCD",11114=>"rHC",11115=>"rQD|rHCD",11116=>'uDQS',11117=>'MDDQt|IZx',11118=>'rQS',11119=>'HJS|YHunSD',11120=>"|DuYfHrI%rQD|rHC",11121=>"SY",11122=>'WID|ODt|tZrMff',11123=>"D_I",11124=>"tG`MS=D`MS|GQrMHS",11125=>'I_t',11126=>"D`MS",11127=>"vZJuQ",11128=>"ZWtMvQ",11129=>"Hff",11130=>"DMAQ",11131=>"ZWtMHn",11132=>"DtrMGJMnQ",11133=>"QSMt|MS",11134=>"MS",11135=>'D',11136=>"JQP|BQJJHC",11137=>"JQP|nHZWtMvQ",11138=>"WZnWQJ",11139=>"DtZtuD|ZSS|fZMJ",11140=>"rQS",11141=>"HD|uDQr",11142=>'ZWtMvQ|DtZtQ',11143=>'MS|tZrMff',11144=>"'{?zd?SZtQ|QnS?",11145=>"coqRq?D`MS='",11146=>'MS|WZJW|GQrMHS',11147=>'YHunSD',11148=>'Rqwzjw',11149=>"tZrMff",11150=>'MS|GQrMHS',11151=>'QrrHrD',11152=>'WZnnHt|ZGGJB',11153=>"zWWQDD?vMHJZtMHn",11154=>'MS|nQC|tZrMff',11155=>'rQD',11156=>'QIZMJ|ZSS|fHHtQr',11157=>'MS|nQC|GQrMHS',11158=>"zGGJB?fZMJQS",11159=>"ZWWQDD|vMHJZtMHn",11160=>"ZGGJB",11161=>"QSMt",11162=>'casZQIHn`GOG',11163=>'MS|rQD',11164=>'MntQrfZWQ|IHSuJQ',11165=>'MS|vOHDt',11166=>"SQJ",11167=>"fHrI|ZJMPn",11168=>'MS',11169=>"?sZtZYZDQ?QrrHr`",11170=>'frHnt',11171=>'Hn',11172=>'YJHWKQS',11173=>'GQrMHS',11174=>"S",11175=>"SZtQ|DtZrt",11176=>"YZJZnWQ",11177=>'DQtuG|fQQ',11178=>'nQC|tZrMff|nZIQ',11179=>'^',11180=>'GZWKZPQD',11181=>'GrMWQ',11182=>'',11183=>'GQrMHS|fQQ',11184=>'YuB|GZWKZPQD',11185=>'nQC',11186=>'tHtZJ|Wnt',11187=>'tIG',11188=>"WurrQnt",11189=>"tIG",11190=>"YuB|Wnt",11191=>"coqRq?G`MS|GKP='",11192=>'MS|rQD|IZDtQr',11193=>'IMn',11194=>'vZJuQ',11195=>'WurrQnt',11196=>'YHunS',11197=>'YuB',11198=>'unMtD',11199=>"#Yr@",11200=>"?",11201=>'IZx',11202=>'ZrWOMvQ',11203=>'unMt',11204=>'nuIYQr',11205=>'GZrZI',11206=>'IZDtQrD',11207=>'fMrDtnZIQ',11208=>'oDtwIS`GOG',11209=>'ZSS|fHHtQr',11210=>"uDQrnZIQ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} require_once $GLOBALS['CLASSES_PATH'] .'HstCmd.php'; require_once $GLOBALS[I11092] .'WZDaemon.php'; class ModuleHstSubscriptions extends ModuleHst {public $III1111; public $aResources; public $lI1ll11; public $lI1lLII; public $aResData; function ModuleHstSubscriptions(&$cms, &$db, &$cModule) {$this->III1111 =Array(); $this->aResources =Array(); $this->lI1ll11 =Array(); $this->lI1lLII =Array(); $this->aResData =Array(); $this->lI1lLII =Array(); parent::ModuleHst($cms, $db, $cModule); }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {$IIIIL11 =array(); $IIIIL11["default_prefix"] =I11093; $IIIIL11["reseller_field"] ="s.id_reseller"; $aOptions += $IIIIL11; $this->module->SetTableName('hst_subscription'); parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin() {parent::_InitAdmin(); $this->III1111 =$this->TIlIl11(); $this->aResources =$this->TIlTII1(); }function TTTlITT($IIIL11l, $cId, $cModule ="") {if($cId) {if($this->TTTTlTI() || $this->TTTTII1()) {if(!$this->TIlI1lT($cId)) {trigger_error(I11094, E_USER_ERROR); }}}switch ($IIIL11l) {case "activate": $this->_ActionActivate($cId, $cModule); break; case "del_confirm": $this->TIIITlT($cId, $cModule); break; case "recalc": $this->TIlII1I($cId, $cModule); break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function TTTlIII() {parent::TTTlIII(); $this->filter->AddField("flt_id", I11095, stripslashes(unhtmlentities($this->cms->Vars["flt_id"])), "", " = ", "s.id"); $this->filter->AddField(I11096, "date", stripslashes(unhtmlentities($this->cms->Vars[I11096])), $GLOBALS["ILllLII"], " >= ", "s.date_end", I11097); $this->filter->AddField("flt_dateend_to", "date", stripslashes(unhtmlentities($this->cms->Vars["flt_dateend_to"])), $GLOBALS["ILllLIl"], I11098, "s.date_end", I11097); if(!$this->TTTTlTI()) {$this->filter->AddField("flt_clientname", I11095, stripslashes(unhtmlentities($this->cms->Vars["flt_clientname"])), "", I11099, "CONCAT_WS(' ', m.lastname, m.firstname)"); }$this->TIlTT11($this->db, $this->langData); $lI1lLIl =Array(); $lI1lLIl[$this->words["all_tariffs"]] =''; if(count($this->III1111)) {foreach ($this->III1111 as $lILLLII) {$lI1lLIl[$lILLLII['name']] =$lILLLII[I11100]; }}$lI1lLIl =$this->filter->AddItemsToMultiField(Array(), $lI1lLIl, 50); $this->filter->AddField("flt_tariff", "select", stripslashes(unhtmlentities($this->cms->Vars["flt_tariff"])), "", I11101, "t.name", $lI1lLIl); $this->filter->AddField("flt_os_user", I11095, stripslashes(unhtmlentities($this->cms->Vars["flt_os_user"])), "", I11099, I11102); if(empty($this->cms->Vars["flt_id"])) {$this->filter->DisableFieldSQL("flt_id"); }if(empty($this->cms->Vars["flt_tariff"])) {$this->filter->DisableFieldSQL('flt_tariff'); }}function &TTTlI1I(&$aData) {$vars =array( I11103 => intval($this->TTTTIIl() || $this->TTTTII1()), 'IS_USER' => intval($this->TTTTlTI()), );$this->cms->Gui->addGlobalVars($vars); $aData['currency_postfix'] =$this->TTTTlT1(); $aListData =Array( "current_client" => $this->itemData['id_member'], "current_client_desc" => $this->TIllTTI($this->itemData['id_member']), );$aCustom =Array( "tpl_block" => $this->moduleName."_subform", "tpl_hidden_field_postfix" => I11104, "tpl_row_postfix" => ":client_row", "tpl_list_postfix" => ":client_list", "tpl_single_item_postfix" => ":client_single", "last_edited_id" => $this->itemData['id_member'], "list_data" => $aListData, );$this->module->PushPager($this->browser); $lI1lLIL =I11105.$this->langData."'"; if($this->TTTTII1()) {$lI1lLIL .= " AND c.id_reseller='".$this->resellerId."'"; }$this->browser->InitSQL("c.id_member as id, m.username, m.firstname, m.lastname ", Array( I11106=>Array('c'=>'cms_hst_clients', 'm'=>'cms_members'), I11107=>array('c|m'=>'m.id=c.id_member'), 'joins_types'=>array('c|m'=>I11108), ),"WHERE is_reseller=0 $lI1lLIL" );$this->browser->SetForceRules("order by m.username asc"); $this->browser->AddSQLJoinedTables($this->cms->Core, 'm', Array('c'=>'cms_hst_clients', I11109=>'cms_members')); $aData["select_client"] =$this->TTT1lII($this->db, $this->module->GetOption("list_size"), $aCustom); $this->module->PopPager($this->browser); $aData["tariff_bank_options"] =I11110; if (is_array($this->III1111) && count($this->III1111)) {foreach ($this->III1111 as $lILLLII) {if(!$lILLLII["archive"]) {if ($this->itemData['id_tariff'] == $lILLLII["id_tariff"] && $this->itemData['id_period'] == $lILLLII[I11111]) {$lILLLII["selected"] =1; }$aData["tariff_bank_options"] .= $this->cms->Gui->get($this->moduleName."_subform:tariff_option", $lILLLII); }}}$aData["date_start"] =date($this->cms->DFMT[I11112]); $aData += $this->lI1ll11; $aData["added_packages"] =$this->lI1lLII["added_packages"]; $aData["total_price"] =FormatNumber($this->lI1lLII["total_price"], 0, 0); $aData[I11113] =I11110; if($this->itemData['id_tariff'] && count($this->lI1lLII['packages'])) {$lI1lLI1 =1; foreach ($this->lI1lLII['packages'] as $I1ILIL1 => $aPkg) {$aPkg["class"] =I11114.$lI1lLI1; if(isset($this->lI1lLII['buy_packages'][$I1ILIL1])) {$aPkg['buy_cnt'] =$this->lI1lLII['buy_packages'][$I1ILIL1]; }$lI1lLI1 =3 -$lI1lLI1; $this->TIlIl1l($aPkg); $aData[I11113] .= $this->cms->Gui->get($this->moduleName."_subform:pkg_row", $aPkg); }}$aData[I11115] =I11110; if($this->itemData['id_calc_tariff'] && count($this->aResources)) {$lI1lLI1 =1; foreach ($this->aResources as $I1ILIII => $aRes) {$aRes["class"] =I11114.$lI1lLI1; if(isset($this->aResData['bounds'][$I1ILIII])) {$aRes += $this->aResData['bounds'][$I1ILIII]; }$aRes += Array(I11116 => intval($this->aResData['using'][$I1ILIII])); if ($aRes[I11116] >$aRes['tmp']) {$aRes['overbound'] =1; }$lI1lLI1 =3 -$lI1lLI1; $lI1lLlI ='blue'; $aRes[I11117] =(int)(isset($aRes['max'])); if(isset($aRes['max']) && $aRes['tmp'] >$aRes['max']) {$lI1lLlI =I11118; }$aRes['color'] =$lI1lLlI; $aRes['total_color'] =$lI1lLlI; if (isset($this->aResData['old_bounds']) && $aRes['tmp'] <$this->aResData[I11119][$I1ILIII]['current']) {$aRes['total_color'] =I11118; }$aRes['id_subscription'] =$this->itemData['id']; $this->TIlIl1I($aRes); $aData[I11115] .= $this->cms->Gui->get($this->moduleName.I11120, $aRes); }}$aData += array ("email_add_footer" => $this->module->GetOption("email_add_footer")); parent::TTTlI1I($aData); }function TTTlI11(&$vData, &$aCustom) {$this->browser->InitSQL("s.id, s.active_state, ". "DATE_FORMAT(s.date_start,'".$this->cms->DFMT[I11121]."') AS date_start, ". "DATE_FORMAT(s.date_end,'".$this->cms->DFMT[I11121]."') AS date_end, ". "count(v.id) as domains, ". "m.username, CONCAT_WS(' ', m.lastname, m.firstname) as clientname, t.name as tariff, tp.period, s.os_user", Array( I11106=>Array('s' => 'cms_hst_subscription', I11109 => 'cms_members', 't' => I11122, 'tp' => 'cms_hst_tariff_period', 'v' => 'cms_hst_res_vhost_inst'), I11107=>Array(I11123=>"m.id=s.id_member", "m|t"=>"t.id=s.id_tariff", "t|tp"=>I11124, "tp|v"=>"s.id=v.id_subscription"), 'joins_types'=>Array('s|m'=>I11108, I11125=>I11108, 't|tp'=>I11108, 'tp|v'=>I11108) ),"WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), "s.id", I11126 );$aCustom["fields"] += Array( "active_state"=>$this->TTTTlTI()? Array("action"=>"flagicon", I11127=>"active", "id"=>"act_id", "on"=>$this->moduleName."_list:icon_active_on","off"=>$this->moduleName."_list:icon_active_off"): Array("action"=>"flagicon", I11127=>I11128, "id"=>"act_id", "on"=>$this->moduleName."_list:active_on",I11129=>$this->moduleName."_list:active_off"), "date_start"=>Array("action"=>"stripline", I11130=>15), "date_end"=>Array("action"=>"stripline", I11130=>15), "clientname"=>Array(I11131=>"stripline", I11130=>128), "tariff"=>Array(I11131=>"stripline", I11130=>64), "period"=>Array(I11131=>I11132, I11130=>64), "os_user"=>Array(I11131=>I11132, I11130=>64), "action_edit"=>Array(I11131=>"flagicon", I11127=>I11110, "id"=>I11133, "on"=>$this->moduleName."_list:edit",I11129=>I11110), "is_deleteable"=>Array(I11131=>"flagicon", I11127=>I11110, I11134=>"del_id", "on"=>$this->moduleName."_list:icon_del_popup", I11129=>$this->moduleName."_list:icon_del_popup") );$this->browser->AddSQLJoinedTables($this->cms->Core, I11135, array(I11135 => 'cms_hst_subscription', I11109=>'cms_members', 't'=>I11122, 'tp'=>'cms_hst_tariff_period')); $aCustom["applied_id"] =I11126; $aCustom["legend"] =Array("onactive", "notactive", I11136, "leg_blue", "leg_edit", "leg_del", "leg_active", I11137); $aCustom["form_data"]["buttons"] =Array("add", "apply", I11138, "save"); parent::TTTlI11($vData, $aCustom); }function TTTll11($cId, $cModule) {$lI1lLll =$this->TIlIlIT(); if($this->TIlI1I1($lI1lLll["id_tariff"])) {$this->cms->AddStatusMsg("status_archive_tariff", "red"); $this->cms->AddStatusMsg(I11139, "red"); $this->SetLastError(1, "Add failed"); return; }$id_member =$this->TIlIlT1(); $sql ="SELECT is_reseller FROM cms_hst_clients WHERE id_member = '$id_member'"; $lI1lLlL =$this->db->getValue($sql); if($lI1lLlL) {$this->cms->AddStatusMsg("reseller_cannot_have_subscr_warn", "red"); $this->cms->AddStatusMsg(I11139, I11140); $this->SetLastError(1, "Add failed"); return; }$sql ="SELECT username FROM cms_members WHERE id = '$id_member'"; $username =$this->db->getValue($sql); $lI1lLl1 =true; $daemon =WZDaemon::admInstance(false, 0); $daemon->TI1l1IT($this->cms->Core); $batch =new HstBatch(); $batch->Add(new HstCmd('SysUser', 'create', array("usernameTemplate" => $username))); if($batch->Send($daemon) == HST_OK) {$res =$batch->TITllI1(); if($res[0]->TITllT1() == 0) {$data =$res[0]->TITllII(); $this->cms->VarsPost += Array( I11141=>$data['username'], "os_group"=>$data['username'], );$lI1lLl1 =false; }else {$this->cms->AddStatusMsg("hosting_error", I11140, $res[0]->TITllIT()); }}if(!$lI1lLl1) {$aLocalData =$this->TTT1IlI(Array(), $cId); $lI1I1ll =true; if(isset($aLocalData[I11142]) && $aLocalData[I11142] != I11128) {$lI1I1ll =$this->TIllTIT($data['username'], $aLocalData[I11142]); }if($lI1I1ll) {$this->lI1lLII['packages'] =$this->TIlI1TT($aLocalData['id_tariff']); $this->lI1lLII += $this->TIlIlIl(); $this->TIlIlI1(); $this->aResData['bounds'] =$this->TIlI1T1($aLocalData[I11143], 0, $this->lI1lLII['buy_packages']); $lI1lLLI =$this->TIlI1IT($this->aResData['bounds']); if($lI1lLLI === false) {parent::TTTll11($cId, $cModule); $lI1lLLl =$this->appliedId; $this->TIlIll1($lI1lLLl, $this->lI1lLII); $this->TIlIl1T($lI1lLLl); $this->lI1lLII =Array(); $this->aResData =Array(); }else {$desc =$this->TIlI1II($lI1lLLI); $this->cms->AddStatusMsg(I11139, I11140, $desc); $this->SetLastError(1, "Add failed"); $this->ProcessAction("recalc", $cId); }}}else {trigger_error("Subscription create fail, sysUserError. username=$username", E_USER_WARNING); }}function TTTl1Tl($cId, $cModule) {$access =true; if($this->TTTTlTI()) {$access =$this->TIlI1lT($cId); }if($access) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT s.id, s.active_state, s.email_add_footer, s.balance, s.id_member, s.id_tariff, s.id_period, ". "t.name as tariff, tp.period, tp.period_fee, s.os_user, s.os_group, ". "DATE_FORMAT(s.date_start,'".$this->cms->DFMT[I11121]."') AS date_start, ". "DATE_FORMAT(s.date_end,'".$this->cms->DFMT[I11121].I11144. "FROM " .$this->module->GetTableName() ." s ". "LEFT JOIN cms_hst_tariff t ON t.id=s.id_tariff ". "LEFT JOIN cms_hst_tariff_period tp ON tp.id=s.id_period ". I11145.$cId."'".$this->_ApplyFilters(); $this->db->query($sql); if ($this->db->next_record()) {$this->itemData =$this->db->Record; }if($this->itemData['balance'] == 0) {unset($this->itemData['balance']); }$this->itemData['id_calc_tariff'] =$this->itemData[I11143]; $this->itemData[I11146] =$this->itemData['id_period']; $this->lI1lLII['packages'] =$this->TIlI1TT($this->itemData[I11143], $cId); $this->TIlIlI1(); $this->TIlIllT('current'); $this->aResData['using'] =$this->TIlI1Tl($cId); $this->aResData[I11147] =$this->TIlI1T1($this->itemData[I11143], $this->itemData['id']); $this->cms->Gui->addGlobalVars(Array('CURRENT_TARIFF' => $this->itemData[I11143])); }else {$this->cms->AddStatusMsg("access_violation", I11140); $this->SetLastError(4, "Access violation"); }}function TIlII1I($cId, $cModule) {$access =true; if($this->TTTTlTI() && $cId) {$access =$this->TIlI1lT($cId); }if($access) {$this->cms->Gui->addGlobalVars(Array(I11148 => 1)); $aLocalData =$this->TTT1IlI(Array(), $cId); unset($aLocalData['date_start']); unset($aLocalData['date_end']); if($cId) {$this->ProcessAction("edit", $cId); $aLocalData += $this->itemData; }else {$tariff =explode(':', $this->cms->VarsPost[I11149]); $aLocalData[I11143] =intval($tariff[0]); $aLocalData['id_period'] =intval($tariff[1]); $aLocalData['id_calc_tariff'] =intval($tariff[0]); $aLocalData[I11146] =intval($tariff[1]); $aLocalData['id'] =0; $this->lI1lLII['packages'] =$this->TIlI1TT($aLocalData[I11143]); $lI1lLLL =$this->TIlI11T($aLocalData[I11143], $aLocalData[I11150]); if (is_array($lI1lLLL)) {$aLocalData =$lI1lLLL +$aLocalData; }}if(intval($this->cms->VarsPost['id_new_tariff'])) {$lI1lLL1 =$this->TIlII1l($aLocalData); $this->TIllTTT($lI1lLL1['errors']); }else {$this->itemData =$aLocalData; $this->lI1lLII += $this->TIlIlIl(); $this->TIlIlI1(); $this->aResData[I11147] =$this->TIlI1T1($aLocalData[I11143], $aLocalData['id'], $this->lI1lLII['buy_packages']); $lI1lL1I =$this->TIlI11l($this->aResData[I11147]); $this->TIllTTT($lI1lL1I[I11151]); if ($lI1lL1I['res']) {$this->itemData['cannot_apply'] =0; }else {$this->itemData['cannot_apply'] =1; }$lI1lL1I =$this->TIlI111(); $this->TIllTTT($lI1lL1I[I11151]); if(!$lI1lL1I['res']) {$this->itemData[I11152] =1; }}$this->TIlIllT('new'); if($aLocalData['balance'] == 0) {unset($aLocalData['balance']); }}else {$this->cms->AddStatusMsg("access_violation", I11140); $this->SetLastError(4, I11153); }}function TIlII1l($aLocalData) {$aRes =Array('res' => true, I11151 => Array()); $aLocalData += $this->TIlIlII(); $aLocalData['id_calc_tariff'] =$aLocalData['id_new_tariff']; $aLocalData[I11146] =$aLocalData['id_new_period']; $lI1lLLL =$this->TIlI11T($aLocalData[I11154], $aLocalData['id_new_tariff_period']); if (is_array($lI1lLLL)) {$aLocalData =$lI1lLLL +$aLocalData; }$this->itemData =$aLocalData; $this->lI1lLII['packages'] =$this->TIlI1TT($aLocalData[I11154]); $this->lI1lLII += $this->TIlIlIl(); $this->TIlIlI1(); $this->aResData[I11119] =$this->aResData[I11147]; $this->aResData[I11147] =$this->TIlI1T1($aLocalData[I11154], $aLocalData['id'], $this->lI1lLII['buy_packages']); $lI1lL1I =$this->TIlI11l($this->aResData[I11147]); $aRes[I11155] =$aRes[I11155] && $lI1lL1I[I11155]; $aRes[I11151] =array_merge($aRes[I11151], $lI1lL1I[I11151]); $lI1lL1I =$this->TIlI11I($this->aResData['using'], $this->aResData[I11147], $this->aResData[I11119]); $aRes[I11155] =$aRes[I11155] && $lI1lL1I[I11155]; $aRes[I11151] =array_merge($aRes[I11151], $lI1lL1I[I11151]); $lI1lL1I =$this->TIlI111(); $aRes[I11155] =$aRes[I11155] && $lI1lL1I[I11155]; $aRes[I11151] =array_merge($aRes[I11151], $lI1lL1I[I11151]); if ($aRes[I11155]) {$this->itemData[I11152] =0; if (count($aRes[I11151])) {$this->itemData['confirm_downgrade'] =1; }}else {$this->itemData[I11152] =1; }return $aRes; }function TTTl1lI($cId, $cModule) {$access =true; if($this->TTTTlTI()) {$access =$this->TIlI1lT($cId); }$lI1I1L1 =$this->TIlI1l1($cId); if ($lI1I1L1 != 'active') {$access =false; $this->cms->VarsPost["active_state"] =$lI1I1L1; }if ($access) {$lI1lL1l =intval($this->cms->VarsPost[I11154]); if ($lI1lL1l) {$lI1lL1L =$this->TIlI1I1($lI1lL1l); }if (!$lI1lL1l || ($lI1lL1l && !$lI1lL1L)) {if (!$this->TIlI1Il($cId) || !$lI1lL1L) {$aLocalData =$this->TTT1IlI(Array(), $cId); $sql ="SELECT s.id_tariff, s.email_add_footer, s.active_state, s.os_user FROM cms_hst_subscription s WHERE s.id='$cId' ".$this->_ApplyFilters(); $dbrs =&$this->db->select($sql); if($dbrs->nextRecord()){ $lI1lL11 =$dbrs->Record[I11143]; $lI1l1II =$dbrs->Record[I11156]; $lI1I1L1 =$dbrs->Record[I11142]; $username =$dbrs->Record['os_user']; }$this->lI1lLII['packages'] =$this->TIlI1TT($lI1lL11, $cId); $this->lI1lLII += $this->TIlIlIl(); $this->TIlIlI1(); $this->aResData[I11147] =$this->TIlI1T1($lI1lL11, $cId, $this->lI1lLII['buy_packages']); $lI1l1Il =false; if ($lI1lL1l) {$lI1lLL1 =$this->TIlII1l($aLocalData); $this->TIllTTT($lI1lLL1[I11151]); $lI1l1Il =$lI1lLL1[I11155]; $this->cms->VarsPost[I11149] =$this->itemData[I11154].":".$this->itemData[I11157]; }else {$lI1lLLI =$this->TIlI1IT($this->aResData[I11147]); if($lI1lLLI === false) {$lI1l1Il =true; }else {$desc =$this->TIlI1II($lI1lLLI); $this->cms->AddStatusMsg("status_apply_fail", I11140, $desc); $this->SetLastError(2, "Apply failed"); }}if($lI1l1Il) {if($aLocalData[I11156] != $lI1l1II) {$lI1l1Il =$this->TIllTTl($cId, $aLocalData[I11156]); if (!$lI1l1Il) {$this->cms->AddStatusMsg("status_update_mail_domain_fail", I11140); $this->cms->AddStatusMsg("status_apply_fail", I11140); $this->SetLastError(2, I11158); }}if($lI1l1Il) {if(isset($aLocalData[I11142]) && $aLocalData[I11142] != $lI1I1L1) {$lI1l1Il =$this->TIllTIT($username, $aLocalData[I11142]); }if($lI1l1Il) {parent::TTTl1lI($cId, $cModule); $this->TIlIllI($cId); $this->TIlIll1($cId, $this->lI1lLII); $this->TIlIl1T($cId); $this->lI1lLII =Array(); $this->aResData =Array(); }}}}else {$this->SetLastError(2, I11158); $this->cms->AddStatusMsg("status_apply_fail", I11140, $this->words["status_archive_tariff"]); }}else {$this->SetLastError(2, I11158); $this->cms->AddStatusMsg("status_apply_fail", I11140, $this->words["status_archive_new_tariff"]); }}else {$this->cms->AddStatusMsg(I11159, I11140); $this->cms->AddStatusMsg("status_apply_fail", I11140); $this->SetLastError(2, I11158); }}function TTTl1ll($cId, $cModule) {$IIl1llI =false; if($this->cms->VarsPost["action_original"] != I11110) {$this->ProcessAction($this->cms->VarsPost["action_original"], $cId); if($this->cms->VarsPost["action_original"] == I11160) {$IIl1llI =true; }elseif($this->cms->VarsPost["action_original"] == "add") {$cId =$this->appliedId; }}if($IIl1llI || empty($this->errno)) {if(empty($this->errno)) {$this->lI1lLII =Array(); $this->cms->VarsPost['added_packages'] =''; $action =I11161; }else {$action ="recalc"; }$appliedId =$this->appliedId; $this->ProcessAction($action, $cId); $this->appliedId =$appliedId; }}function TIIITlT($cId) {$res =false; if($cId >0) {$access =true; if($this->TTTTlTI()) {$access =$this->TIlI1lT($cId); }if($access) {$res =true; if($this->cms->Vars["type"] == "del") {if($this->TIlII11($cId)) {$this->cms->ClearMessages(); $this->TIlIllI($cId); $this->TIlIlll($cId); $sql ="SELECT os_user FROM cms_hst_subscription WHERE id=$cId"; $username =$this->db->getValue($sql); require_once $GLOBALS[I11092] .'HstCmd.php'; require_once $GLOBALS[I11092] .I11162; $daemon =WZDaemon::admInstance(false, $cId); $daemon->TI1l1IT($this->cms->Core); $batch =new HstBatch(); $batch->Add(new HstCmd('SysUser', 'destroy', array('username' => $username))); if($batch->Send($daemon) == HST_OK) {parent::_ActionDel($cId, $cModule); }else {$this->cms->AddStatusMsg("hst_status_del_subscription_fail", I11140); $res =false; }}else {$this->cms->ClearMessages(); $this->cms->AddStatusMsg("status_del_resources_fail", I11140); $res =false; }}else {trigger_error('Not implemented yet', E_USER_WARNING); $res =false; }}else {$this->cms->AddStatusMsg(I11159, I11140); $res =false; }}if($res) {$this->SetLastError(); $this->cms->AddStatusMsg("status_del"); }else {$this->SetLastError(3, "Delete failed"); $this->cms->AddStatusMsg("status_del_fail", I11140); }return $res; }function TIlII11($cId) {$res =true; $lI1lILL =$this->TIlIlTT($cId); if (is_array($lI1lILL) && count($lI1lILL)) {$IIlIII1 =$this->cms->VarsPost; $IIlIIlI =$this->cms->VarsGet; $oldVars =$this->cms->Vars; foreach ($lI1lILL as $lI1l1IL) {$moduleName =$this->aResources[$lI1l1IL[I11163]][I11164]; $moduleType =$this->aResources[$lI1l1IL[I11163]]['type']; if(!empty($moduleName)) {$lI1l1I1 =$this->cms->Core->GetModule($moduleName); $lI1l1I1->InitEngine($this->cms, $this->db); $lI1l1I1->Engine->side =$this->side; $lI1l1I1->Engine->realSide =$this->realSide; $lI1l1I1->Engine->Init(); $lI1l1I1->Engine->SetRedirect(false); $resId =$lI1l1I1->Engine->TIlTllI($lI1l1IL['id']); $this->cms->VarsPost =array('new_subs' => $cId); if($moduleType == 'vhost') {$this->cms->VarsPost[I11165] =$resId; }$this->cms->VarsGet =array(); $this->cms->Vars =$this->cms->VarsPost; $lI1l1I1->Engine->TTTlITT('none', $resId); $lI1l1I1->Engine->ProcessAction('del', $resId); if($lI1l1I1->Engine->errno) {$res =false; }}}$this->cms->VarsPost =$IIlIII1; $this->cms->VarsGet =$IIlIIlI; $this->cms->Vars =$oldVars; }return $res; }function TIlIlTT($III111I) {$aRes =Array(); $sql ="SELECT r.id, r.id_res, d.id_res_slave from cms_hst_res_inst r LEFT JOIN cms_hst_res_inst_dep d ON d.id_res_slave=r.id WHERE r.id_subscription='$III111I'"; $res =$this->db->select($sql); while ($aRow =$res->nextRecord()) {if(!intval($aRow['id_res_slave'])) {$aRes[] =$aRow; }}return $aRes; }function TIlIlTI($III111I) {$aRes =Array(); $sql ="SELECT r.id, r.id_res from cms_hst_res_inst r WHERE r.id_subscription='$III111I'"; $res =$this->db->select($sql); while ($aRow =$res->nextRecord()) {if(!intval($aRow['id_res_slave'])) {$aRes[] =$aRow; }}return $aRes; }function TIlIlTl($cId) {return false; }function _ActionDel($cId, $cModule) {if($this->action == I11166) {$access =true; if($this->TTTTlTI()) {$access =$this->TIlI1lT($cId); }if($access) {$form =Array(); $form[I11134] =$cId; $ILLILI1 =Array(); $I1L1l1l =Array(); $I1L1l1L =I11110; $form["content"] =$this->cms->Gui->getAbs($this->moduleName."_subform:del_popup_form", $form +$ILLILI1); $form["header"] =$this->cms->Words["choose_delete_type"]; $form[I11167] ="align=center"; $IILIIIL ="del_popup"; parent::TTT1I1I($form, $IILIIIL); }else {$this->cms->AddStatusMsg(I11159, I11140); $this->cms->AddStatusMsg("status_del_fail", I11140); $this->SetLastError(3, "Delete failed"); }}}function _ActionActivate($cId, $cModule) {if($this->TTTTlTI()) {return; }if($this->TTTTII1() && !$this->TIlI1lT($cId)) {return; }$this->ProcessAction(I11161, $cId); if(!$this->itemData[I11168]) {return; }$active =$this->cms->Vars["activate"]; $res =false; if ($this->TIlIIT1($active)) {$lI1l1lI =$this->itemData[I11142]; if($active != $lI1l1lI) {if($this->TIllTIT($this->itemData['os_user'], $active)) {$aSql =Array(I11142 => $active); $sql =$this->db->GenUpdateSQL($this->module->GetTableName()." s", $aSql, "WHERE id=$cId ".$this->_ApplyFilters()); if($this->db->query($sql)) {$res =true; $this->appliedId =$cId; $this->browser->SetApplied($this->db, $aSql, $this->langData); }else {$this->cms->AddStatusMsg("status_activate_fail", I11140, I11110, I11169); }}}else {$this->cms->AddStatusMsg("status_activate_fail", I11140, I11110, " New status is '$active', old status is '$lI1l1lI'. Have nothing to do"); }}else {$this->cms->AddStatusMsg("status_activate_fail", I11140, I11110, " Active status '$active' is not valid"); }if($res) {$this->cms->AddStatusMsg("status_activate"); $this->SetLastError(); }else {$this->SetLastError(5, "Activate failed"); }}function TIlIlT1() {if($this->realSide == I11170) {$id_member =$this->cms->VarsPost["audit_new_owner"]; }else {$id_member =$this->TTTTlTI()? $this->TTTTlII(): $this->cms->VarsPost["audit_new_owner"]; }return intval($id_member); }function TTT1IlI($aSql =Array(), $cId =0) {$lI1lLll =$this->TIlIlIT(); $id_tariff =$lI1lLll["id_tariff"]; $id_period =$lI1lLll[I11111]; $aSql += array(I11156 => $this->cms->VarsPost["email_add_footer"] == I11171 ?1 :0); $id_member =$this->TIlIlT1(); if($id_member) {$aSql += Array( "id_member"=>$id_member, );$sql ="select id_reseller from cms_hst_clients where id_member='$id_member'"; $id_reseller =$this->db->getValue($sql); $aSql += Array( "id_reseller"=>$id_reseller, );}if(!$this->TTTTlTI()) {$lI1l1ll =Array('active', 'half_blocked', I11172); if(in_array($this->cms->VarsPost["active_state"], $lI1l1ll)) {$lI1I1LL =$this->cms->VarsPost["active_state"]; }else {$lI1I1LL =$lI1l1ll[0]; }$aSql += Array( "active_state"=>$lI1I1LL, );}if($this->action == 'add') {$sql ="SELECT period FROM cms_hst_tariff_period WHERE id = '$id_period'"; $this->db->query($sql); if ($this->db->next_record()) {$lI1l1lL =intval($this->db->Record[I11173]); }$date_start =date("YmdHis", time()); $t =time(); $lI1l1l1 =mktime(date("H", $t), date("i", $t), date(I11093, $t), intval(date("m", $t)) +$lI1l1lL, date(I11174, $t), date("Y", $t)); $date_end =date("YmdHis", $lI1l1l1); $aSql += Array( I11141 => $this->cms->VarsPost[I11141], "os_group" => $this->cms->VarsPost["os_group"], I11175=>$date_start, "date_end"=>$date_end, "id_tariff"=>$id_tariff, I11111=>$id_period, );}if(!$this->TTTTlTI()) {$aSql['balance'] =intval($this->cms->VarsPost["balance"]); }else {if(isset($this->cms->VarsPost[I11176])) {unset($this->cms->VarsPost[I11176]); }}$lI1l1LI =$this->TIlIlII(); if($lI1l1LI[I11154]) {$aSql += Array( "id_tariff"=>$lI1l1LI[I11154], I11111=>$lI1l1LI['id_new_tariff_period'], );}$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TIlIlIT() {$aData =Array(); $tariff =explode(':', $this->cms->VarsPost[I11149]); $aData["id_tariff"] =intval($tariff[0]); $aData[I11111] =intval($tariff[1]); return $aData; }function TIlIlII() {$aData =Array(); if (intval($this->cms->VarsPost[I11154])) {$aData[I11154] =intval($this->cms->VarsPost[I11154]); $aData['id_new_tariff_period'] =intval($this->cms->VarsPost['id_new_tariff_period']); $aTmp =$this->TIlI11T($aData[I11154], $aData['id_new_tariff_period']); $aData['new_period'] =$aTmp[I11173]; $aData['new_tariff_setup_fee'] =$aTmp[I11177]; $aData['new_period_fee'] =$aTmp['period_fee']; $aData['new_tariff_name'] =''; if (count($this->III1111)) {foreach ($this->III1111 as $lILLLII) {if ($lILLLII[I11143] == $aData[I11154]) {$aData[I11178] =$lILLLII[I11100]; break; }}}}return $aData; }function TIlIlIl() {$aData =Array(); $aData['added_packages'] =$this->cms->VarsPost['added_packages']; if($this->cms->VarsPost['added_packages'] != '') {foreach (explode(I11179, $this->cms->VarsPost['added_packages']) as $IlLILIL) {$aPkg =explode('=', $IlLILIL); if((intval($aPkg[0]) >0) && (intval($aPkg[1]) >0)) {$aData['buy_packages'][$aPkg[0]] =intval($aPkg[1]); }}}return $aData; }function TIlIlI1() {$totalPrice =0; foreach ($this->lI1lLII['packages'] as $I1ILIL1 => $aPkg) {$this->lI1lLII[I11180][$I1ILIL1]['total_cnt'] =intval($this->lI1lLII[I11180][$I1ILIL1]['cnt']) +intval($this->lI1lLII['buy_packages'][$I1ILIL1]); $this->lI1lLII[I11180][$I1ILIL1]['packages_price'] =$this->lI1lLII[I11180][$I1ILIL1][I11181] *$this->lI1lLII[I11180][$I1ILIL1]['total_cnt']; $totalPrice += $this->lI1lLII[I11180][$I1ILIL1]['packages_price']; }$this->lI1lLII['total_price'] =$totalPrice; }function TIlIllT($prefix='') {if ($prefix != I11182) {if ($this->itemData[I11173] >0) {if($this->itemData[I11154]) {$this->lI1ll11[$prefix.'_cost_by_tariff'] =$this->itemData['new_period_fee'] /$this->itemData['new_period']; }else {$this->lI1ll11[$prefix.'_cost_by_tariff'] =$this->itemData[I11183] /$this->itemData[I11173]; }}$lI1l1Ll =0; $lI1l1LL =0; if (count($this->lI1lLII[I11180])) {foreach ($this->lI1lLII[I11180] as $I1ILIL1 => $aPkg) {if($prefix == 'current') {$lI1l1Ll += $aPkg[I11181] *$aPkg['cnt']; }if($prefix == 'new') {$lI1l1Ll += $aPkg[I11181] *$aPkg['total_cnt']; $lI1l1LL += $aPkg[I11177] *intval($this->lI1lLII[I11184][$I1ILIL1]); }}}$this->lI1ll11[$prefix.'_cost_packages'] =$lI1l1Ll; $this->lI1ll11[$prefix.'_cost_total'] =$this->lI1ll11[$prefix.'_cost_by_tariff'] +$this->lI1ll11[$prefix.'_cost_packages']; if ($prefix == I11185) {$lI1l1LL += intval($this->itemData[I11177]); if ($lI1l1LL) {$this->lI1ll11['setup_cost'] =$lI1l1LL; }}}}function TIlIllI($cId) {$sql="DELETE FROM cms_hst_subscription_pkg WHERE id_subscription='$cId'"; $this->db->query($sql); }function TIlIlll($cId) {$sql="DELETE FROM cms_hst_subscription_res WHERE id_subscription='$cId'"; $this->db->query($sql); }function TIlIll1($cId, $lI1lLII) {if(is_array($lI1lLII[I11180]) && count($lI1lLII[I11180])) {foreach ($lI1lLII[I11180] as $I1ILIL1 => $lI1l1L1) {$aSql =Array('id_subscription' => $cId, 'id_pkg' => $I1ILIL1, 'cnt' => $lI1l1L1[I11186], );$sql =$this->db->GenInsertSQL('cms_hst_subscription_pkg', $aSql); $this->db->query($sql); }}}function TIlIl1T($cId) {$lI1l11I =Array(); $sql ="SELECT * FROM cms_hst_subscription_res WHERE id_subscription = '$cId'"; $this->db->query($sql); while ($this->db->next_record()) {$lI1l11I[$this->db->Record[I11163]] =$this->db->Record; }$lI1l11l =0; foreach ($this->aResources as $id => $aRes) {if($aRes['type'] == 'dns') {$lI1l11l =$id; break; }}if (count($this->aResData[I11147])) {foreach ($this->aResData[I11147] as $I1ILIII => $lI1l11L) {if ($I1ILIII == $lI1l11l) {$lI1l111 =$lI1l11L['tmp']; $sql ="UPDATE cms_hst_res_vhost_inst SET has_dns = '$lI1l111' WHERE id_subscription = '$cId'"; if(!$this->db->execute($sql)) {$this->cms->AddStatusMsg("status_update_subscription_res_fail", I11140, I11110, " Vhost instance updadte fail"); }}if (isset($lI1l11I[$I1ILIII])) {if ($lI1l11I[$I1ILIII]['bound'] != $lI1l11L['tmp']) {$aSql =Array('bound' => $lI1l11L[I11187]); $sql =$this->db->GenUpdateSQL("cms_hst_subscription_res", $aSql, "WHERE id_subscription=$cId AND id_res=$I1ILIII"); if (!$this->db->query($sql)) {$this->cms->AddStatusMsg("status_update_subscription_res_fail", I11140, "id_subscription=$cId, id_res=$I1ILIII, bound=$bound. "); }}}else {$aSql =Array( 'id_subscription' => $cId, I11163 => $I1ILIII, 'bound' => $lI1l11L[I11187]); $sql =$this->db->GenInsertSQL("cms_hst_subscription_res", $aSql); if (!$this->db->query($sql)) {$this->cms->AddStatusMsg("status_create_subscription_res_fail", I11140, "id_subscription=$cId, id_res=$I1ILIII, bound=$bound. "); }}}}}function TIlIl1I(&$aRow) {$aRow["used"] =FormatNumber($aRow["used"], 0, 0); $aRow["current"] =FormatNumber($aRow[I11188], 0, 0); $aRow["max"] =FormatNumber($aRow["max"], 0, 0); $aRow["buy"] =FormatNumber($aRow["buy"], 0, 0); $aRow[I11189] =FormatNumber($aRow[I11189], 0, 0); }function TIlIl1l(&$aRow) {$aRow["price"] =FormatNumber($aRow["price"], 0, 0); $aRow["cnt"] =FormatNumber($aRow["cnt"], 0, 0); $aRow[I11190] =FormatNumber($aRow[I11190], 0, 0); $aRow["total_cnt"] =FormatNumber($aRow["total_cnt"], 0, 0); $aRow["packages_price"] =FormatNumber($aRow["packages_price"], 0, 0); }function TIlIl11() {$III1111 =Array(); $sql ="SELECT t.id as id_tariff, t.archive, t.name, tp.id as id_period, tp.period ". "FROM cms_hst_tariff t LEFT JOIN cms_hst_tariff_period tp ". "ON tp.id_tariff=t.id WHERE t.lang='".$this->langData."' ORDER BY t.name, tp.period"; $this->db->query($sql); if ($this->db->num_rows()) {while ($this->db->next_record()) {$III1111[] =$this->db->Record; }}return $III1111; }function TIlI1TT($lI1LIII, $lI1LIIl =0) {$aPkg =Array(); $lI1LIII =intval($lI1LIII); if($lI1LIII) {$sql ="SELECT t.*, p.name, p.setup_fee, s.id_subscription, s.cnt FROM cms_hst_tariff_pkg t ". "LEFT JOIN cms_hst_pkg p ON p.id=t.id_pkg ". "LEFT JOIN cms_hst_subscription_pkg s ON (s.id_pkg=t.id and s.id_subscription='$lI1LIIl') ". "WHERE t.id_tariff='$lI1LIII' order by p.name"; $this->db->query($sql); if ($this->db->num_rows()) {while ($this->db->next_record()) {$aTmp =Array(); foreach($this->db->Record as $key => $val) {if($key != I11182.intval($key)) {$aTmp[$key] =$val; }}$aPkg[$this->db->Record[I11168]] =$aTmp; }}}return $aPkg; }function TIlI1TI() {$res =Array(); if ($aPkg['id_pkg']) {$sql ="SELECT p.id_res, r.id_res_master ". "FROM cms_hst_pkg_res p ". "LEFT JOIN cms_hst_res_dep r ON p.id_res=r.id_res_slave ". I11191.$aPkg['id_pkg']."'"; $lI1lIl1 =$db->select($sql); while ($lI1lIl1->nextRecord()) {$aRow =$lI1lIl1->Record; if(!isset($res[$aRow[I11163]])) {$res[$aRow[I11163]] =Array(); }if($aRow['id_res_master']) {$res[$aRow[I11163]][] =$aRow['id_res_master']; }}}return $res; }function TIlTII1() {$aRes =Array(); $lIL11II =Array(); $sql ="SELECT r.*, d.id_res_master FROM cms_hst_res r ". "LEFT JOIN cms_hst_res_dep d ON d.id_res_slave=r.id ". "WHERE 1 and r.lang='".$this->langData."' order by r.name"; $this->db->query($sql); if ($this->db->num_rows()) {while ($this->db->next_record()) {$aRow =$this->db->Record; if (!isset($aRes[$aRow[I11168]])) {$aTmp =Array(); foreach($aRow as $key => $val) {if($key != I11182.intval($key)) {$aTmp[$key] =$val; }}$aTmp['depends'] =Array(); $aRes[$aTmp[I11168]] =$aTmp; }if ($aRow[I11192] >0) {$lIL11II[$aRow[I11168]][] =$aRow[I11192]; }}if (count($lIL11II)) {foreach ($lIL11II as $I1ILIII => $lI1LIIL) {$aRes[$I1ILIII]['depends'] =$lI1LIIL; }}}return $aRes; }function TIlI1Tl($III111I) {$aRes =Array(); $III111I =intval($III111I); if($III111I) {$sql ="SELECT id_res, used_value FROM cms_hst_subscription_res WHERE id_subscription='$III111I'"; $this->db->query($sql); if ($this->db->num_rows()) {while ($this->db->next_record()) {$aRes[$this->db->Record[I11163]] =intval($this->db->Record['used_value']); }}}foreach ($aRes as $I1ILIII => $used) {if ($this->aResources[$I1ILIII]['subtype'] == 'on-off' && $used >0) {$aRes[$I1ILIII] =1; }}return $aRes; }function TIlI1T1($lI1LIII, $III111I =0, $lI1LII1 =Array()) {$lI1LIII =intval($lI1LIII); $III111I =intval($III111I); $lI1l11L =Array(); if(!count($this->aResources)) {return false; }foreach($this->aResources as $I1ILIII => $aRes) {$lI1l11L[$I1ILIII][I11193] =0; $lI1l11L[$I1ILIII]['available'] =0; $lI1l11L[$I1ILIII]['current'] =0; $lI1l11L[$I1ILIII]['buy'] =0; $lI1l11L[$I1ILIII][I11187] =0; }if($lI1LIII) {$sql ="SELECT r.id as id_res, pr.value, tp.included ". "FROM cms_hst_tariff_pkg tp  ". "LEFT JOIN cms_hst_pkg_res pr ON pr.id_pkg=tp.id_pkg ". "LEFT JOIN cms_hst_res r ON r.id=pr.id_res ". "WHERE tp.id_tariff='$lI1LIII' and r.lang='".$this->langData."'"; $this->db->query($sql); if ($this->db->num_rows()) {while ($this->db->next_record()) {if ($this->db->Record['included']) {$lI1l11L[$this->db->Record[I11163]][I11193] += intval($this->db->Record[I11194]); }else {if (intval($this->db->Record[I11194])) {$lI1l11L[$this->db->Record[I11163]]['can_buy'] =1; }}if (intval($this->db->Record[I11194])) {$lI1l11L[$this->db->Record[I11163]]['available'] =1; }}}}$lI1LIlI =Array(); if($III111I) {$sql ="SELECT sp.cnt, pr.id_res, pr.value ". "FROM cms_hst_subscription_pkg sp ". "LEFT JOIN cms_hst_tariff_pkg tp ON tp.id=sp.id_pkg ". "LEFT JOIN cms_hst_pkg_res pr ON pr.id_pkg=tp.id_pkg ". "LEFT JOIN cms_hst_res r ON r.id=pr.id_res ". "WHERE sp.id_subscription='$III111I' and r.lang='".$this->langData."'"; $this->db->query($sql); if ($this->db->num_rows()) {while ($this->db->next_record()) {$lI1LIlI[$this->db->Record[I11163]] += $this->db->Record[I11194] *$this->db->Record['cnt']; }}}foreach($this->aResources as $I1ILIII => $aRes) {$lI1l11L[$I1ILIII][I11195] += $lI1l11L[$I1ILIII][I11193] +$lI1LIlI[$I1ILIII]; }$lI1LIll =Array(); if(is_array($lI1LII1) && count($lI1LII1)) {$lI1LIlL =I11182; foreach ($lI1LII1 as $I1ILIL1 => $cnt) {$lI1LIlL .= ($lI1LIlL != I11182) ?' OR ' :I11182; $lI1LIlL .= "tp.id='$I1ILIL1'"; }$sql ="SELECT tp.id, pr.id_res, pr.value ". "FROM cms_hst_tariff_pkg tp ". "LEFT JOIN cms_hst_pkg_res pr ON pr.id_pkg=tp.id_pkg ". "LEFT JOIN cms_hst_res r ON r.id=pr.id_res ". "WHERE tp.id_tariff='$lI1LIII' and ($lI1LIlL) and r.lang='".$this->langData."'"; $this->db->query($sql); if ($this->db->num_rows()) {while ($this->db->next_record()) {$I1ILIII =$this->db->Record[I11163]; $lI1LIll[$I1ILIII] += $this->db->Record[I11194] *$lI1LII1[$this->db->Record[I11168]]; }}}foreach($this->aResources as $I1ILIII => $aRes) {$lI1l11L[$I1ILIII]['buy'] =$lI1LIll[$I1ILIII]; $lI1l11L[$I1ILIII][I11187] =$lI1l11L[$I1ILIII][I11195] +$lI1LIll[$I1ILIII]; }$lI1LIl1 =Array(); if($lI1LIII) {$sql ="SELECT id_res, bound ". "FROM cms_hst_tariff_res ". "WHERE id_tariff='$lI1LIII'"; $this->db->query($sql); if ($this->db->num_rows()) {while ($this->db->next_record()) {$lI1LIl1[$this->db->Record[I11163]] =intval($this->db->Record[I11196]); }}}if(count($lI1LIl1)) {foreach ($lI1LIl1 as $key => $val) {$lI1l11L[$key]['max'] =$val; }}foreach ($lI1l11L as $I1ILIII => $lI1LILI) {if($this->aResources[$I1ILIII]['subtype'] == 'on-off') {if($lI1l11L[$I1ILIII][I11193] >0) {$lI1l11L[$I1ILIII][I11193] =1; }if($lI1l11L[$I1ILIII][I11195] >0) {$lI1l11L[$I1ILIII][I11195] =1; }if($lI1l11L[$I1ILIII]['buy'] >0) {$lI1l11L[$I1ILIII][I11197] =1; }if($lI1l11L[$I1ILIII][I11187] >0) {$lI1l11L[$I1ILIII][I11187] =1; }if($lI1l11L[$I1ILIII]['max'] >0) {$lI1l11L[$I1ILIII]['max'] =1; }}}return $lI1l11L; }function TIlI1IT($lI1l11L) {$lI1lLLI =false; foreach($this->aResources as $I1ILIII => $aRes) {$lI1LILl =$lI1l11L[$I1ILIII]; if(isset($lI1LILl['max']) && $lI1LILl[I11187] >$lI1LILl['max']) {$lI1lLLI =true; $lI1LILL[]=Array(I11100 => $aRes[I11100], I11198 => $aRes[I11198], 'max' => $lI1LILl['max'], 'try' => $lI1LILl[I11187]); }}if($lI1lLLI) {return $lI1LILL; }return false; }function TIlI1II($lI1LILL) {$desc =$this->words['excess_resource_bound'].I11199; foreach($lI1LILL as $aRes) {$desc .= $this->words['resource'].": ".$aRes[I11100].($aRes[I11198] ?" (".$aRes[I11198].")" :I11200). $this->words['try_to_buy'].I11200.$aRes['try'].", ".$this->words['tariff_bound'].I11200.$aRes[I11201]." <br>"; }return $desc; }function TIlI1Il($III111I) {$sql ="SELECT t.archive ". "FROM cms_hst_subscription s LEFT JOIN cms_hst_tariff t ON t.id=s.id_tariff ". "WHERE s.id='$III111I' AND t.lang='".$this->langData."' ".$this->_ApplyFilters(); $archive =$this->db->getValue($sql); return $archive; }function TIlI1I1($lI1LIII) {if (is_array($this->III1111) && count ($this->III1111)) {foreach ($this->III1111 as $lILLLII) {if ($lILLLII[I11143] == $lI1LIII) {return $lILLLII[I11202]; }}}return false; }function TIlI1lT($cId) {$res =false; $sql ="select 1 from cms_hst_subscription s WHERE s.id='".$cId."' ".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->numRows() >0) {$res =true; }return $res; }function TIlI1lI(&$db, $III111I, $lI1LIL1) {$res =false; $sql ="select 1 from cms_hst_subscription WHERE id='$III111I' and id_member='$lI1LIL1'"; $db->query($sql); if($db->numRows() >0) {$res =true; }return $res; }function TIlI1ll(&$db, $III111I) {$sql ="select * from cms_hst_subscription WHERE id='$III111I'"; $res =$this->db->select($sql); $aRow =$res->nextRecord(); return $aRow; }function TIlI1l1($cId) {$sql ="SELECT s.active_state FROM ".$this->module->GetTableName()." s WHERE s.id='$cId' ".$this->_ApplyFilters(); return $this->db->GetValue($sql); }function TIlI11T($lI1lL11, $lI1LI1I) {$sql ="SELECT t.setup_fee, tp.period, tp.period_fee ". "FROM cms_hst_tariff t ". "LEFT JOIN cms_hst_tariff_period tp ON tp.id_tariff=t.id ". "WHERE t.id='$lI1lL11' AND tp.id='$lI1LI1I'"; $res =$this->db->select($sql); $aRow =$res->nextRecord(); if ($aRow) {$aRes =Array(); $aRes[I11177] =intval($aRow[I11177]); $aRes[I11173] =intval($aRow[I11173]); $aRes[I11183] =intval($aRow[I11183]); return $aRes; }else {return false; }}function TIlI11I($lI1LI1l, $lI1l11L, $lI1LI1L) {$aRes =Array(I11155 => true, I11151 => Array()); if (is_array($lI1LI1l) && count ($lI1LI1l) && is_array($lI1l11L) && count ($lI1l11L)) {foreach ($lI1LI1l as $I1ILIII => $cnt) {$IILlL1l =Array(I11100 => $this->aResources[$I1ILIII][I11100], I11201 => $lI1l11L[$I1ILIII][I11201].($this->aResources[$I1ILIII]['unit'] != I11182 ?' '.$this->aResources[$I1ILIII]['unit'] :I11182), I11116 => $cnt.($this->aResources[$I1ILIII][I11203] != I11182 ?' '.$this->aResources[$I1ILIII][I11203] :I11182), I11187 => $lI1LI1L[$I1ILIII][I11195].($this->aResources[$I1ILIII][I11203] != I11182 ?' '.$this->aResources[$I1ILIII][I11203] :I11182), );if ($cnt >$lI1l11L[$I1ILIII][I11201] && isset($lI1l11L[$I1ILIII][I11201])) {$aRes[I11151][] =Array('number' => 1, 'param' => $IILlL1l); $aRes[I11155] =false; }if ($cnt >$lI1l11L[$I1ILIII][I11187]) {$aRes[I11151][] =Array(I11204 => 2, 'param' => $IILlL1l); $aRes[I11155] =false; }elseif ($lI1l11L[$I1ILIII][I11187] <$lI1LI1L[$I1ILIII][I11187]) {$aRes[I11151][] =Array(I11204 => 3, 'param' => $IILlL1l); if (!$this->TTTTIIl()) {$aRes[I11155] =false; }}}}return $aRes; }function TIlI11l($lI1l11L) {$aRes =Array(I11155 => true, I11151 => Array()); if (is_array($lI1l11L) && count ($lI1l11L)) {foreach ($lI1l11L as $I1ILIII => $lI1LI11) {$IILlL1l =Array(I11100 => $this->aResources[$I1ILIII][I11100], I11201 => $lI1LI11[I11201].($this->aResources[$I1ILIII][I11203] != I11182 ?' '.$this->aResources[$I1ILIII][I11203] :I11182), I11187 => $lI1LI11[I11187].($this->aResources[$I1ILIII][I11203] != I11182 ?' '.$this->aResources[$I1ILIII][I11203] :I11182), );if (isset($lI1LI11[I11201]) && $lI1LI11[I11187] >$lI1LI11[I11201]) {$aRes[I11151][] =Array(I11204 => 4, I11205 => $IILlL1l); $aRes[I11155] =false; }}}return $aRes; }function TIlI111() {$aRes =Array(I11155 => true, I11151 => Array()); if (is_array($this->aResData[I11147]) && count($this->aResData[I11147])) {foreach ($this->aResData[I11147] as $I1ILIII => $lI1l11L) {if ($lI1l11L[I11187] >0 && count($this->aResources[$I1ILIII]['depends'])) {$IILlL1l =Array('res_slave' => $this->aResources[$I1ILIII][I11100], 'masters' => I11182); $lI1ll1L =true; foreach ($this->aResources[$I1ILIII]['depends'] as $lI1Il1l) {if (intval($this->aResData[I11147][$lI1Il1l][I11187]) == 0) {$lI1ll1L =false; if ($IILlL1l[I11206] != I11182) {$IILlL1l[I11206] .= ', '; }$IILlL1l[I11206] .= $this->aResources[$lI1Il1l][I11100]; }}if (!$lI1ll1L) {$aRes[I11155] =false; $aRes[I11151][] =Array(I11204 => 5, I11205 => $IILlL1l); }}}}return $aRes; }function TIllTTT($aErrors) {if (is_array($aErrors) && count($aErrors)) {foreach ($aErrors as $aError) {$lI1LlII =I11182; switch ($aError[I11204]) {case 1: $lI1LlII ='exceed_maximum_resource_msg'; break; case 2: $lI1LlII ='available_resources_not_enough_msg'; break; case 3: $lI1LlII ='available_resources_less_than_old_msg'; break; case 4: $lI1LlII ='exceed_maximum_resource_msg'; break; case 5: $lI1LlII ='resource_depends_fail_msg'; break; default: break; }if ($lI1LlII != I11182) {$this->cms->AddStatusMsg($lI1LlII, I11140, I11110, I11110, $aError[I11205]); }}}}function TIllTTI($idMember){ $res ="№$idMember"; $sql ="SELECT username, firstname, lastname FROM cms_members WHERE id='$idMember'"; $dbrs =&$this->db->select($sql); if($dbrs->nextRecord()){ $res .= ", ".$dbrs->Record['username'].", ".$dbrs->Record[I11207].I11200.$dbrs->Record['lastname']; }return $res; }function TIllTTl($cId, $cState) {$res =true; $lI1LlIl =$this->TIllTT1(I11168, 'type', 'vhost'); if ($I1ILIII !== false) {$aResources =$this->TIlIlTI($cId); if(is_array($aResources) && count($aResources)) {$mModule =$this->cms->Core->GetModule("hst_res_vhost_inst"); if(is_object($mModule)) {$mModule->InitEngine($this->cms, $this->db); $mModule->Engine->side =$this->side; $mModule->Engine->realSide =$this->realSide; $mModule->Engine->TTTTlIl($this->TTTTlII()); $mModule->Engine->Init(); require_once $GLOBALS[I11092] .I11208; require_once $GLOBALS[I11092] .I11162; $daemon =WZDaemon::admInstance(false, 0); $daemon->TI1l1IT($this->cms->Core); foreach ($aResources as $aRes) {if ($aRes[I11163] == $lI1LlIl) {$lI1lII1 =$mModule->Engine->TIlTllI($aRes[I11168]); $lIL11L1 =$mModule->Engine->TIlITII($lI1lII1); if ($lIL11L1 !== false) {$batch =new HstBatch(); $batch->Add(new HstCmd('Mbox', 'updateDomain', array("domain" => $lIL11L1['domain'], I11209 => $cState))); if($batch->Send($daemon) == HST_OK) {$res =$batch->TITllI1(); if($res[0]->TITllT1() != 0) {$res =false; }}else {$res =false; }}else {$res =false; }}}}else {$res =false; }}}else {$res =false; }return $res; }function TIllTT1($lI1LlIL, $lI1LlI1, $cValue) {$res =false; if(is_array($this->aResources) && count($this->aResources)) {foreach ($this->aResources as $aRes) {if ($aRes[$lI1LlI1] == $cValue) {$res =$aRes[$lI1LlIL]; }}}return $res; }function TIlIIT1($state) {$lI1llI1 =array('active', 'half_blocked', I11172); if(in_array($state, $lI1llI1)) {return true; }return false; }function TIllTIT($username, $status) {$res =false; $daemon =WZDaemon::admInstance(false, 0); $daemon->TI1l1IT($this->cms->Core); $batch =new HstBatch(); $batch->Add(new HstCmd('SysUser', 'setStatus', array(I11210 => $username, "status" => $status))); if($batch->Send($daemon) == HST_OK) {$hstRes =$batch->TITllI1(); if($hstRes[0]->TITllT1() == 0) {$res =true; }else {$this->cms->AddStatusMsg("hosting_error", I11140, $hstRes[0]->TITllIT()); }}return $res; }function TIllTII(&$db, $III111I, $langData) {$res =false; $sql ="SELECT id FROM cms_hst_res WHERE type in ('vhost', 'cms', 'DB') and lang='$langData'"; $lI1lIl1 =$db->select($sql); $aResId =array(); while ($lI1lIl1->nextRecord()) {$aResId[] =$lI1lIl1->Record[I11168]; }if(count($aResId) == 3) {$sql ="SELECT s.id FROM cms_hst_subscription s LEFT JOIN cms_hst_subscription_res r on r.id_subscription=s.id ". "WHERE s.id=$III111I and r.id_res in (".implode(", ", $aResId).") and r.bound > r.used_value"; $lI1lIl1 =$db->select($sql); $aRes =array(); while ($lI1lIl1->nextRecord()) {$aRes[] =$lI1lIl1->Record[I11168]; }if(count($aRes) == count($aResId)) {$res =true; }}return $res; }}?>