<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       35037 xkqwsxgyknxmzqltyztiwtltupupgilxsqxmwwggtlrkrulyqxxmixrnpgmkqyqxntlwpnir
 */ ?><?php foreach(array(11579=>'JZnP|SZtZ',11580=>'QSMt',11581=>'SZtQfrHI',11582=>'funW|PuM`GOG',11583=>'fJt|MnDtZJJQS',11584=>'=',11585=>'MnDtZJJQS',11586=>'tQxt',11587=>'fJt|WHSQ',11588=>'',11589=>".MS.!?.JZnP.!?.MnDtZJJQS.!?.nZIQ.!?.SQfZuJt|tMtJQ.!?.MD|DBD.!?.LEuQrB|WSn.?",11590=>"coqRq?1?",11591=>'ZWtMHn',11592=>'Hn',11593=>'|JMDt%MD|MnDtZJJQS|Hn',11594=>'|JMDt%MD|MnDtZJJQS|Hff',11595=>'MS',11596=>'WZJJYZWK',11597=>'nHtMnDtZJJQS',11598=>'JQP|rQS',11599=>'YuttHnD',11600=>'SQfZuJt|WHuntrB',11601=>'ii~ss~bb?OO%II%DD',11602=>'DHurWQ|JZnP',11603=>'?WOQWKQS',11604=>"?coqRq?MS?=?",11605=>'MnDtZJJQS|JZnPD',11606=>"UgszTq?",11607=>"?dqT?.MnDtZJJQS.?=?0?coqRq?.MS.?=?",11608=>"coqRq?.MS.?=?",11609=>'JZnP',11610=>'SQfZuJt|MS',11611=>'~*Z+Az+a0+9\`?&-~',11612=>'SZtQfHrIZt|frHnt',11613=>'|',11614=>'LEuQrB|WSn',11615=>'SZtQfHrIZt|ZSIMn',11616=>"?",11617=>"coqRq?.MnDtZJJQS.?=?1",11618=>'SQfZuJt|MSD',11619=>'SZtQtH',11620=>']ZWtMHn=QSMt',11621=>'IQnu|tHG',11622=>'fMxQS|nZIQ',11623=>'IHSuJQ|nZIQ',11624=>'DOHC|IQ|Zt|GZrQnt',11625=>'YHSB',11626=>'JZB|f5|YHSB',11627=>'JZB|f10|YHSB',11628=>'MIP|IQnu|HvQr',11629=>'OtIJ|OQZS|tZMJ',11630=>'MG|ZrQZ',11631=>'MD|KC|IZnuZJ',11632=>'DBD|rMPOtD|S',11633=>'!',11634=>'fMJQnZIQ',11635=>'JZB|IZMn|YHSB',11636=>'JZB|f2|tBGQ',11637=>'JZB|f7|YHSB',11638=>'JZB|f9|tBGQ',11639=>'CA|tIG',11640=>'WID|JZBHutD',11641=>'JZBHut',11642=>'GZPQ',11643=>'CZrn|MnDtZJJZtMHn|fZMJQS',11644=>"dqjqwT?.MS.!?.WHntQnt.?FRhi?.WID|IHSuJQD|tQIGJZtQD|JZnPD.",11645=>'WHntQnt',11646=>'WID|IHSuJQD|tQIGJZtQD|JZnPD',11647=>'FUNw|mNwjUsqd|gzTo',11648=>'RhhT|gzTo',11649=>'~',11650=>"dqjqwT?[?FRhi?.WID|IHSuJQD|tQIGJZtQD.?coqRq?.nZIQ.?jmkq?':\|",11651=>'ohdT|gzTo',11652=>'\`tGJ$~',11653=>'WID|IHSuJQD|tQIGJZtQD',11654=>'::',11655=>"::",11656=>'nZIQ',11657=>"sqjqTq?FRhi?.WID|IHSuJQD|tQIGJZtQD.?coqRq?.nZIQ.?jmkq?':\|",11658=>'coqRq?.MS.?=?',11659=>'fMJQ',11660=>'~tQIGJZtQD',11661=>"'",11662=>'|JMDt%') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleLocales extends CMS_ActModule{ private $lI11ILL; private $lI11IL1; private $lI11I1I; private $lI11I1l =array( 'templates/lang', 'templates/tree', '_local/_admin/templates/lang', '_local/_admin/templates/lang/options', '_local/_admin/templates/reports/lang' );private $lI11I1L; function ModuleLocales(&$cms, &$db, &$cModule){ parent::CMS_ActModule($cms, $db, $cModule); }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {$IIIIL11 =array( I11579 => false, 'use_modified_date' => false, 'use_positions' => false, 'allowed_actions' => array('add', I11580, 'apply', 'save', 'del') );$aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin(){ parent::_InitAdmin(); if($this->filter->issetField('datefrom')){ $this->filter->TITI1l1(I11581); }if($this->filter->issetField('dateto')){ $this->filter->TITI1l1('dateto'); }$this->filter->IL11l1L =array('limit'); require_once $GLOBALS['FUNC_INCLUDES_PATH'] .I11582; $this->lI11I1L =defined('TEMPLATES_FROM_DISK') && constant('TEMPLATES_FROM_DISK'); }function TTTlIII(){ parent::TTTlIII(); $lIlL1lI =intval(!empty($this->cms->Vars[I11583])); $this->filter->AddField(I11583, 'checkbox', $lIlL1lI, '0', I11584, I11585); if(empty($lIlL1lI)){ $this->filter->DisableFieldSql(I11583); }$lIlL1lI =isset($this->cms->Vars['flt_code']) ?$this->cms->Vars['flt_code'] :''; $this->filter->AddField('flt_code', I11586, stripslashes(unhtmlentities($lIlL1lI)), '', ' like ', 'lang'); if($lIlL1lI == ''){ $this->filter->DisableFieldSql(I11587); }$lIlL1lI =isset($this->cms->Vars['flt_name']) ?$this->cms->Vars['flt_name'] :''; $this->filter->AddField('flt_name', I11586, stripslashes(unhtmlentities($lIlL1lI)), I11588, ' like ', 'name'); if($lIlL1lI == I11588){ $this->filter->DisableFieldSql('flt_name'); }}function TTTlI11(&$vData, &$aCustom){ $this->browser->InitSQL( I11589, "FROM `cms_locales`", I11590 .$this->_ApplyFilters() .$this->TTTlIl1(), "", "", "`name` ASC" );$aCustom['fields'] += array( I11585 => array(I11591 => 'flagicon', 'value' => 1, 'id' => 'pub_id', I11592 => $this->moduleName .I11593, 'off' => $this->moduleName .I11594), 'action_edit' => array(I11591 => 'flagicon', 'value' => I11588, I11595 => 'edit_id', I11592 => $this->moduleName .'_list:edit', 'off' => I11588), 'action_del' => array(I11591 => I11596, 'object' => &$this, 'method' => 'cbAdminRow') );$aCustom['legend'] =array(I11585, I11597, I11598, 'leg_yellow', 'leg_blue', 'leg_edit'); $aCustom['form_data'][I11599] =array('add', 'apply', 'cancel', 'save'); if(!isset($this->itemData[I11600])){ $defaults =array( 'lang' => I11588, 'name' => I11588, 'default_title' => I11588, I11585 => true, 'dateformat_front' => I11601, 'dateformat_admin' => 'MM/DD/YYYY hh:mm:ss' );foreach($defaults as $key => $value){ $vData[$key] =isset($this->lI11I1I[$key]) ?$this->lI11I1I[$key] :$value; }$vData[I11585] =$vData[I11585] ?' checked' :I11588; $vData[I11600] =TlTl11T($this->cms, isset($this->cms->VarsPost[I11600]) ?$this->cms->VarsPost[I11600] :I11588); }$vData['source_lang'] =$this->module->GetOption(I11602); parent::TTTlI11($vData, $aCustom); }function TTTl1Tl($cId, $cModule){ parent::TTTl1Tl($cId, $cModule); $sql ="SELECT * ". "FROM " .$this->module->GetTableName() ." ". "WHERE `id` = " .intval($cId) .$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()){ $this->itemData =$this->db->Record; $this->itemData[I11585] =$this->itemData[I11585] ?I11603: I11588; $this->itemData['default'] =$this->cms->Core->GetOption('default_data_lang') != $this->itemData['lang'] ?I11588 :I11603; $this->itemData[I11600] =TlTl11T($this->cms, $this->itemData[I11600]); }}function _ActionDel($cId, $cModule){ $id =intval($cId); if($id){ $sql ="SELECT * FROM " .$this->module->GetTableName() .I11604 .$id; $this->lI11IL1 =$this->db->getRecord($sql); if($this->lI11IL1 && !$this->lI11IL1['is_sys'] && $this->cms->Core->GetOption('default_data_lang') != $this->lI11IL1['lang']){ if($this->lI11IL1[I11585]){ $this->lI11ILL[I11605] =$this->cms->Core->GetOption(I11605); while(($index =array_search($this->lI11IL1['lang'], $this->lI11ILL[I11605])) !== false){ unset($this->lI11ILL[I11605][$index]); }$sql =I11606 .$this->module->GetTableName() .I11607 .$id; $this->db->execute($sql); $this->TIllIlT($id); }$this->TIllIl1($this->lI11IL1['lang']); parent::_ActionDel($id, $cModule); }}}function TTT1IlI($aSQL =array(), $cId =0){ $aSQL =array(); $this->lI11ILL =array(); $this->lI11IL1 =array(); if($cId){ $sql ="SELECT * ". "FROM " .$this->module->GetTableName() ." ". I11608 .intval($cId); $this->lI11IL1 =$this->db->getRecord($sql); }$error =false; if(!$cId){ if(preg_match('/[a-zA-Z]{2,3}/', $this->cms->VarsPost['lang'])){ $sql ="SELECT `lang` FROM " .$this->module->GetTableName() ." WHERE `lang` = '" .addslashes($this->cms->VarsPost[I11609]) ."'"; if((!$cId || $this->lI11IL1[I11609] != $this->cms->VarsPost[I11609]) && $this->db->getValue($sql)){ $this->cms->AddStatusMsg('warn_duplicate_lang', 'red'); $error =true; }else{ $aSQL[I11609] =$this->cms->VarsPost[I11609]; $this->lI11IL1[I11609] =$aSQL[I11609]; $sql ="SELECT MAX(`default_id`) FROM " .$this->module->GetTableName(); $aSQL[I11610] =intval($this->db->getValue($sql)) +10000; }}else {$this->cms->AddStatusMsg('warn_invalid_lang', 'red'); $error =true; }}if(empty($this->lI11IL1['is_sys'])){ $name =trim(strip_tags(unhtmlentities($this->cms->VarsPost['name']))); if($name == I11588 || !preg_match(I11611, $name)){ $this->cms->AddStatusMsg('warn_invalid_name', 'red'); $error =true; }else{ $aSQL['name'] =$this->cms->VarsPost['name']; }}foreach(array(I11612, 'dateformat_admin') as $key){ if(trim($this->cms->VarsPost[$key]) == I11588){ if(in_array($key, array(I11612, 'dateformat_admin'))){ $key ='dateformat'; }$this->cms->AddStatusMsg('warn_missing_' .trim($key, I11613), 'red'); $error =true; }}if($error){ $this->lI11I1I =$this->cms->VarsPost; return parent::TTT1IlI(array(), $cId); }$lI11I11 =$this->cms->Core->GetOption('default_data_lang'); foreach(array('default_title', I11600, I11612, 'dateformat_admin', I11614) as $key){ $aSQL[$key] =trim(strip_tags(unhtmlentities($this->cms->VarsPost[$key]))); }if($this->lI11IL1[I11609] != $lI11I11){ $installed =intval(!empty($this->cms->VarsPost[I11585])) || $this->lI11IL1[I11609] == 'en'; if(!isset($this->lI11IL1[I11585]) || $this->lI11IL1[I11585] != $installed){ $option =$this->cms->Core->GetOption(I11605); if($installed){ $option[] =$this->lI11IL1[I11609]; }else{ while(($index =array_search($this->lI11IL1[I11609], $option)) !== false){ unset($option[$index]); }}$this->lI11ILL[I11605] =$option; $aSQL[I11585] =$installed; }}if(!empty($this->cms->VarsPost['default'])){ $this->lI11ILL['default_data_lang'] =$this->lI11IL1[I11609]; }$aSQL =parent::TTT1IlI($aSQL, $cId); return $aSQL; }function TTTll11($cId, $cModule){ parent::TTTll11($cId, $cModule); $this->TIllIlT($this->appliedId); }function TTTl1lI($cId, $cModule){ parent::TTTl1lI($cId, $cModule); $this->TIllIlT($cId); }private function TIllIlT($id){ if(empty($this->errno)){ $saveOptions =true; $this->lI11ILL['lang_names'] =array(); $this->lI11ILL[I11612] =array(); $this->lI11ILL[I11615] =array(); $this->lI11ILL[I11600] =array(); $this->lI11ILL['default_title'] =array(); $this->lI11ILL['default_ids'] =array(); $sql ="SELECT `lang`, `name`, `dateformat_front`, `dateformat_admin`, `default_id`, `default_country`, `default_title` " ."FROM " .$this->module->GetTableName() .I11616. I11617; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ $lang =$record[I11609]; $this->lI11ILL['lang_names'][$lang] =$record['name']; $this->lI11ILL[I11600][$lang] =$record[I11600]; $this->lI11ILL['default_title'][$lang] =$record['default_title']; $this->lI11ILL[I11612][$lang] =$record[I11612]; $this->lI11ILL[I11615][$lang] =$record[I11615]; $this->lI11ILL[I11618][$lang] =$record[I11610]; }if(empty($this->lI11IL1[I11585]) && !empty($this->cms->VarsPost[I11585])){ $lI11lII =$this->module->GetOption(I11602); $saveOptions =$this->TIllIlI($lI11lII, $this->lI11IL1[I11609]); if(!$saveOptions){ $sql =$this->db->genUpdateSQL($this->module->GetTableName(), array(I11585 => 0), 'WHERE `id` = ' .$id); $this->db->execute($sql); }}if( isset($this->cms->VarsPost['delete_data']) && $this->lI11IL1[I11585] && empty($this->cms->VarsPost[I11585]) && $this->cms->Core->GetOption('default_data_lang') != $this->lI11IL1[I11609] ){$this->TIllIl1($this->lI11IL1[I11609]); }if($saveOptions){ $lI11lIl =$this->cms->Core->GetOption(I11615); if( isset($this->lI11ILL[I11615]) && $lI11lIl !== $this->lI11ILL[I11615] ){$lI11lIL =FALSE; $oServerCookie =AMI::getSingleton('env/cookie'); foreach($this->lI11ILL[I11615] as $lang => $lI11lI1){ if(isset($lI11lIl[$lang]) && $lI11lIl[$lang] !== $lI11lI1){ foreach(array(I11581, I11619) as $field){ $cookieName =AMI_Filter::getCookieName($field, $lang); $oServerCookie->deleteByName($cookieName); }$lI11lIL =TRUE; }}if($lI11lIL){ $this->cms->Core->UpdateRightsVersion(); $oServerCookie->save(); }}foreach($this->lI11ILL as $name => $value){ $this->cms->Core->SetOption($name, $value); }$this->cms->Core->SaveCoreOptions(); $this->cms->Core->Cache->ClearCacheNow(); if(in_array($this->cms->Vars[I11591], array('add', 'save'))){ if($this->cms->Vars[I11591] ='save'){ $this->IIlll1L ='id=' .$id .I11620; }$this->SetRedirect(true); }}}}private function TIllIlI($lI11lII, $lI11llI){ if($lI11lII == $lI11llI){ return true; }$error =false; $lI11lll =array(); $sql ="SELECT `lang`, `default_id` FROM " .$this->module->GetTableName() ." WHERE `lang` IN ('" .$lI11lII ."', '" .$lI11llI ."')"; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ $lI11lll[$record[I11609]] =$record[I11610]; }$sql ="SELECT `id` FROM `cms_pages` WHERE `id` = " .$lI11lll[$lI11llI]; if(!$this->db->getValue($sql)){ $lI11llL =array( 'public', 'removable', 'hidden', 'menu_main', I11621, 'menu_bottom', 'use_noindex', 'skip_in_prevnext', 'skip_search', I11622, I11623, 'script_link', 'last_changed', 'position', 'name', I11624, 'show_in_sitemap', 'show_siblings', 'is_section', 'visible_area', I11625, 'lay_f1_body', 'lay_f2_body', 'lay_f3_body', 'lay_f4_body', I11626, 'lay_f6_body', 'lay_f7_body', 'lay_f8_body', 'lay_f9_body', I11627, 'ext_picture', 'ext_popup_picture', 'ext_small_picture', 'img_menu_normal', I11628, 'img_menu_active', 'html_title', 'html_keywords', 'html_description', I11629, 'html_title_inherit', 'tmp_date', 'tmp_record', 'user_script', I11630, 'id_site', 'block_mask', 'is_printable', 'tpl_addon', I11631, 'sb_data', 'id_owner', 'sys_rights_r', 'sys_rights_w', I11632, 'last_modified', 'is_active', 'lay_id' );$sql ="SELECT " .implode(I11633, $lI11llL) ." FROM `cms_pages` WHERE `id` = " .$lI11lll[$lI11lII]; $I1llLl1 =$this->db->getRecord($sql); if($I1llLl1){ array_pop($lI11llL); $lI11ll1 =array( 'hidden', 'name', 'is_default', I11634, 'css_file', 'is_isolated', 'lay_body_type', 'lay_body', I11635, 'lay_main_body_original', 'lay_f1_type', 'lay_f1_body', 'lay_f1_body_original', I11636, 'lay_f2_body', 'lay_f2_body_original', 'lay_f3_type', 'lay_f3_body', 'lay_f3_body_original', 'lay_f4_type', 'lay_f4_body', 'lay_f4_body_original', 'lay_f5_type', I11626, 'lay_f5_body_original', 'lay_f6_type', 'lay_f6_body', 'lay_f6_body_original', 'lay_f7_type', I11637, 'lay_f7_body_original', 'lay_f8_type', 'lay_f8_body', 'lay_f8_body_original', I11638, 'lay_f9_body', 'lay_f9_body_original', 'lay_f10_type', I11627, 'lay_f10_body_original', I11639, 'block_mask', I11629 );$sql ="SELECT " .implode(I11633, $lI11ll1) ." FROM `cms_layouts` WHERE `id` = " .$I1llLl1['lay_id']; $lI11lLI =$this->db->getRecord($sql); if($lI11lLI){ $lI11lLI[I11609] =$lI11llI; foreach(array_keys($lI11lLI) as $key){ $lI11lLI[$key] =mysql_real_escape_string($lI11lLI[$key]); }$sql =$this->db->genInsertSQL(I11640, $lI11lLI); $this->db->execute($sql); $layoutId =$this->db->lastInsertId(); $I1llLl1[I11595] =$lI11lll[$lI11llI]; $I1llLl1[I11609] =$lI11llI; foreach(array_keys($I1llLl1) as $key){ $I1llLl1[$key] =mysql_real_escape_string($I1llLl1[$key]); }$I1llLl1['lay_id'] =$layoutId; $sql =$this->db->genInsertSQL('cms_pages', $I1llLl1); $this->db->execute($sql); }else{ $this->cms->AddStatusMsg('warn_source_layout_not_found', 'red', I11588, I11588, array(I11641 => $lI11lII .'/' .$I1llLl1['lay_id'])); $error =true; }}else{ $this->cms->AddStatusMsg('warn_source_default_page_not_found', 'red', I11588, I11588, array(I11642 => $lI11lII .'/' .$lI11lll[$lI11lII])); $error =true; }if($error){ $this->cms->AddStatusMsg(I11643, 'red'); unset($this->cms->VarsPost[I11585]); $this->TTTl1lI(); }else{ $this->cms->AddStatusMsg('layout_and_default_page_created'); }}if(!$error){ $sql =I11644; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ if($this->TIllIll($lI11lII, $lI11llI, $record['content'])){ $id =$record[I11595]; unset($record[I11595]); $record[I11645] =mysql_real_escape_string($record[I11645]); $record += array('parsed' => I11588, 'modified_date' => '=|NOW()'); $sql =$this->db->genUpdateSQL(I11646, $record, 'WHERE `id` = ' .$id); $this->db->execute($sql); }}require_once $GLOBALS[I11647] .'func_file_system.php'; if($this->lI11I1L){ foreach($this->lI11I1l as $path){ $path =$GLOBALS['HOST_PATH'] .$path; $files =getDirFileList($path, '*.lng'); foreach($files as $file){ $file =$path .'/' .$file; $content =file_get_contents($file); if($this->TIllIll($lI11lII, $lI11llI, $content)){ $res =file_put_contents($file, $content); if($res === false){ $this->cms->AddStatusMsg( 'warn_cannot_save_file', 'red', I11588, I11588, array('file' => $file) );}}}}}$lI11lLl =$this->cms->Core->GetModProperty('plugins_wizard', 'distr_path'); $lI11lLl =$GLOBALS[I11648] .$lI11lLl['local']; $plugins =getDirFileList($lI11lLl, '*', false, true); foreach($plugins as $pluginId){ $path =$lI11lLl .$pluginId .'/templates'; if(is_dir($path)){ $files =getDirFileList($path, '*.lng'); foreach($files as $file){ $file =$path .I11649 .$file; $content =file_get_contents($file); if($this->TIllIll($lI11lII, $lI11llI, $content)){ $res =file_put_contents($file, $content); if($res === false){ $this->cms->AddStatusMsg( 'warn_cannot_save_file', 'red', I11588, I11588, array('file' => $file) );}}}}}$sql =I11650 .$lI11lII .".tpl'"; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ $srcPath =$GLOBALS[I11651] .$record['path'] .$record['name']; unset($record[I11595]); $record['name'] =preg_replace('/_' .preg_quote($lI11lII) .I11652, I11613 .$lI11llI .'.tpl', $record['name']); $sql =$this->db->genInsertSQL(I11653, $record); $this->db->execute($sql, DBC_NO_HALT); if($this->lI11I1L && is_file($srcPath)){ $I11LlL1 =$GLOBALS[I11651] .$record['path'] .$record['name']; if(!is_file($I11LlL1)){ copy($srcPath, $I11LlL1); }}}}return !$error; }private function TIllIll($lI11lII, $lI11llI, &$content){ $res =false; $langData =explode(I11654, $content); $s =sizeof($langData); $s1 =$s -1; if($s){ $pattern ='/%' .$lI11lII ."/s"; $IILl1lL ='%' .$lI11llI; $lI11lLL =$langData[0]; for($j =1; $j <= $s1; $j++){ $tail =$j <$s1 ?$langData[$j +1] :I11588; if($j &1){ if(preg_match($pattern, $langData[$j])){ $lI11lLL .= "%%" .$langData[$j] .I11655 .$tail; $lI11lL1 =preg_replace($pattern, $IILl1lL, $langData[$j]); if(preg_match('/%%' .quotemeta($lI11lL1) .'%%/is', $content)){ continue; }$lI11lLL .= (I11655 .$lI11lL1 .I11655 ."\x0d\x0a" .trim($tail) ."\x0d\x0a"); $res =true; }else{ $lI11lLL .= I11654 .$langData[$j] .I11654 .$tail; }}}}if($res){ $content =$lI11lLL; }return $res; }private function TIllIl1($locale){ if($this->lI11I1L){ $sql =I11650 .$locale .".tpl'"; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ $path =$GLOBALS[I11651] .$record['path'] .$record[I11656]; if(is_file($path)){ unlink($path); }}}$sql =I11657 .$locale .".tpl'"; $this->db->execute($sql); $sql =I11644; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ if($this->TIllI1T($locale, $record[I11645])){ $id =$record[I11595]; unset($record[I11595]); $record[I11645] =mysql_real_escape_string($record[I11645]); $record += array('parsed' => I11588, 'modified_date' => '=|NOW()'); $sql =$this->db->genUpdateSQL(I11646, $record, I11658 .$id); $this->db->execute($sql); }}require_once $GLOBALS[I11647] .'func_file_system.php'; if($this->lI11I1L){ foreach($this->lI11I1l as $path){ $path =$GLOBALS[I11651] .$path; $files =getDirFileList($path, '*.lng'); foreach($files as $file){ $file =$path .I11649 .$file; $content =file_get_contents($file); if($this->TIllI1T($locale, $content)){ $res =file_put_contents($file, $content); if($res === false){ $this->cms->AddStatusMsg( 'warn_cannot_save_file', 'red', I11588, I11588, array(I11659 => $file) );}}}}}$lI11lLl =$this->cms->Core->GetModProperty('plugins_wizard', 'distr_path'); $lI11lLl =$GLOBALS[I11648] .$lI11lLl['local']; $plugins =getDirFileList($lI11lLl, '*', false, true); foreach($plugins as $pluginId){ $path =$lI11lLl .$pluginId .I11660; if(is_dir($path)){ $files =getDirFileList($path, '*.lng'); foreach($files as $file){ $file =$path .I11649 .$file; $content =file_get_contents($file); if($this->TIllI1T($locale, $content)){ $res =file_put_contents($file, $content); if($res === false){ $this->cms->AddStatusMsg( 'warn_cannot_save_file', 'red', I11588, I11588, array(I11659 => $file) );}}}}}$sql ="SELECT `id` FROM `cms_pages` WHERE `lang` = '" .$locale .I11661; $rs =$this->db->select($sql); $ids =array(); while($record =$rs->nextRecord()){ $ids[] =$record[I11595]; }if(sizeof($ids)){ $sql ="DELETE FROM `cms_pages_ver` WHERE `page_id` IN (" .implode(I11633, $ids) .")"; $this->db->execute($sql); $sql ="DELETE FROM `cms_pages` WHERE `lang` = '" .$locale .I11661; $this->db->execute($sql); }$sql ="DELETE FROM `cms_layouts` WHERE `lang` = '" .$locale .I11661; $this->db->execute($sql); $this->cms->AddStatusMsg('locale_data_is_deleted'); }private function TIllI1T($locale, &$content){ $res =false; $langData =explode(I11654, $content); $s =sizeof($langData); if($s){ $s--; $lI11lLL =$langData[0]; $pattern ='/\%' .preg_quote($locale) .'/s'; for($j =1; $j <= $s; $j++){ $tail =$j <$s ?$langData[$j +1] :I11588; if($j &1){ if(preg_match($pattern, $langData[$j])){ $j++; $res =true; }else{ $lI11lLL .= I11654 .$langData[$j]; }}else{ $lI11lLL .= I11654 .$langData[$j]; }}if($res){ $content =$lI11lLL; }}return $res; }public function cbAdminRow(&$aItem, &$aData){ $vars =array('del_id' => $aItem[I11595]); $aItem['action_del'] =$this->cms->Gui->get($this->moduleName .I11662 .(!$aItem['is_sys'] && $this->cms->Core->GetOption('default_data_lang') != $aItem[I11609] ?'del' :'icon_none'), $vars); }}