<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       22174 xkqwyimkiwyzmqknsqqwzstwkslyxtztzstrtsnxyxssqynnxilyxylxggiyrkmqkkzkpnir
 */ ?><?php foreach(array(11688=>'PrHuG|HGQrZtMHnD',11689=>'iHSuJQiQIYQrD|onS|zSI|zSS',11690=>'QSMt',11691=>'iHSuJQiQIYQrD|onS|zSI|qSMt',11692=>'iHSuJQiQIYQrD|onS|zSI|dZvQ',11693=>'iHSuJQiQIYQrD|onS|zSI|RQDQt',11694=>'iHSuJQiQIYQrD|onS|zSI|zWtMvZtQ',11695=>'SQJ',11696=>'iHSuJQiQIYQrD|onS|zSI|sQJQtQ',11697=>'zim|zjjhc|qFNdU',11698=>'uDQrnZIQ',11699=>'?jmkq?',11700=>"coqRq?1?",11701=>'ZWtMHn',11702=>'ZWtMvQ',11703=>'Hn',11704=>'nHnQ',11705=>'?SMDZYJQS',11706=>'ZSS',11707=>'HnZWtMvQ',11708=>'JQP|rQDQt',11709=>'rQDQt|MS',11710=>'|SQJ',11711=>'',11712=>'uDQr|DtZtuD',11713=>'#Yr?~@',11714=>'GZDDCHrS2',11715=>'SQDWrMGtMHn',11716=>'nMWKnZIQ',11717=>'FhRi|ihsq',11718=>'md|zUThpqNqRzTqs',11719=>'MnfH',11720=>'dozRqs|hgT',11721=>'HK',11722=>'Qrr',11723=>'QIZMJ',11724=>'ZGGJB',11725=>'ZWtMvZtQ') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleMembers extends CMS_ActModule{ public $lIlL1I1; public $oMember; public $lI11LIl; public $aPostData; protected $lI11LIL; function __construct(&$cms, &$db, &$cModule){ parent::CMS_ActModule($cms, $db, $cModule); }function _Init($IIll1l1 =array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =array()){ $IIIIL11 =array(I11688 => array('del')); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin(){ parent::_InitAdmin(); $sql ="SELECT m.id, m.username " ."FROM `cms_host_users` u " ."LEFT JOIN `cms_members` m ON m.id = u.id_member " ."WHERE u.sys_user = 1"; $this->lIlL1I1 =$this->db->getRecord($sql); $this->lI11LIl =$this->module->GetOption('admin_required_fields'); if(is_string($this->lI11LIl)){ $this->lI11LIl =explode('|', $this->lI11LIl); }$none =''; $this->oMember =new CMS_Member($none); $this->oMember->setObligatory($this->lI11LIl, true, true); $this->addHandler('add', I11689); $this->addHandler(I11690, I11691); $this->addHandler('save', I11692); $this->addHandler('apply', I11692); $this->addHandler('reset', I11693); $this->addHandler('activate', I11694); $this->addHandler(I11695, I11696); $this->aPostData =array(); $this->cms->Gui->addGlobalVars( array( 'allow_edit_at_front' => AMI::getOption('core', 'allow_edit_at_front'), 'AMI_ALLOW_EFNSU' => !empty($GLOBALS[I11697]) ));}function TTTlIII(){ parent::TTTlIII(); foreach(array('lastname', 'firstname', 'email', 'nickname', I11698) as $field){ $filterField ='flt_' .$field; $value =isset($this->cms->Vars[$filterField]) ?stripslashes(unhtmlentities($this->cms->Vars[$filterField])) :''; $this->filter->AddField($filterField, 'text', $value, '', I11699, $field); $this->filter->MoveField($filterField, _MOVE_START); if(!mb_strlen($value)){ $this->filter->DisableFieldSql($filterField); }}}function TTTlI11(&$vData, &$aCustom) {$this->browser->InitSQL( "*, date_format(date,'" .$this->cms->DFMT['db'] ."') fdate ", "FROM `cms_members` cm ", I11700 .$this->_ApplyFilters() .$this->TTTlIl1(), '', 'name', 'id desc' );$aCustom['fields'] += array( I11698 => array( I11701 => 'callback', 'object' => $this, 'method' => 'cbAdmListRow' ),I11702 => array( I11701 => 'flagicon', 'value' => 1, 'id' => 'act_id', I11703 => 'members_list:active_on', 'off' => 'members_list:active_off' ));$this->lI11LIL =$this->module->GetOption('confirmation_type') != I11704; $this->cms->Gui->AddGlobalVars(array('CONFIRM_NEED' => $this->lI11LIL)); $this->oMember->setObligatory('password', true); if(!$this->IIllIlI){ $aScripts =$this->oMember->getScripts($this->cms); $vData['header_memeber_script'] =$aScripts['header']; $vData['check_member_script'] =$aScripts['check_form']; $vData['member_form'] =$this->oMember->getForm($this->cms, $this->db, $this->aPostData); }if($this->cms->Core->IsInstalled('sys_users')){ $vData['disabled_allow_to_edit_at_front'] =I11705; }$aCustom['applied_id'] ='id'; $aCustom['form_data']['buttons'] =array(I11706, 'apply', 'save', 'cancel'); $aCustom['legend'] =array(I11707, 'notactive', 'leg_yellow', 'leg_blue', 'leg_edit', I11708, 'leg_del'); parent::TTTlI11($vData, $aCustom); }public function cbAdmListRow(&$aItem, &$aData){ $links['act_id'] =$links['edit_id'] =$links['del_id'] =$links[I11709] =$aItem['id']; $del =$aItem['id'] == $this->lIlL1I1['id'] ?'' :I11710; if($this->cms->Core->TTlllTI() && $aItem['id'] == $this->lIlL1I1['id']){ $aItem['actions'] =$this->cms->Gui->get('members_list:icon_none', $links) .$this->cms->Gui->get('members_list:icon_none', $links) .$this->cms->Gui->get('members_list:icon_none', $links); }else{ $aItem['actions'] =$this->cms->Gui->get('members_list:icons_edit_reset' .$del, $links) .($del != '' ?I11711 :$this->cms->Gui->get('members_list:icon_none', $links)); }if($this->lI11LIL){ $lI11LI1 =$this->module->GetOption('confirmation_type'); if($lI11LI1 === 'email' || $lI11LI1 === 'email|admin'){ $aItem[I11712] =$this->cms->Words[$aItem &1 ?'member_status_email' :'member_status_email_not']; }if($lI11LI1 === 'admin' || $lI11LI1 === 'email|admin'){ if(!empty($aItem[I11712])){ $aItem[I11712] .= I11713; }$aItem[I11712] .= $IlllLll->cms->Words[$aItem['status'] &2 ?'member_status_admin' :'member_status_admin_not']; }}}public function TT1llTl(){ unset($this->cms->VarsPost['password'], $this->cms->VarsPost[I11714]); $this->cms->VarsPost =removeSpecial($this->cms->VarsPost, 'slashes'); $this->aPostData =$this->cms->VarsPost; }public function _ActionDel($cId, $cModule){ $this->errno =0; if($cId && $this->lIlL1I1['id'] != $cId){ if ($this->oMember->deleteMember($this->cms, $this->db, $cId)){ $sql ="SELECT `id` FROM `cms_sessions` WHERE `id_member` = " .$cId ." AND `expired` >= NOW() LIMIT 1"; if($this->db->getValue($sql)){ $sql ="DELETE FROM `cms_sessions` WHERE `id_member` = " .$cId; $this->db->execute($sql); }}}else{ $this->errno =1; }}}class ModuleMembers_Hnd_Adm_Add implements CMS_Mod_ActionHandler_Interface{ public function processAction(CMS_ActModule $IlllLll, $data =null){ $aMember =$IlllLll->cms->VarsPost; $genData =array ();foreach (array (I11698, 'password') as $entity) {if (!in_array($entity, $IlllLll->lI11LIl) && !isset($aMember[$entity])){ $genData[] =$entity; }}if($IlllLll->cms->Core->IsInstalled('sys_users')){ unset($aMember['edit_front_allowed']); }else{ $aMember['edit_front_allowed'] =$aMember['allow_to_edit_at_front'] ?1 :0; }if($IlllLll->oMember->createMember($IlllLll->cms, $IlllLll->db, $aMember, false, implode('|', $genData))){ $appliedId =(int)$IlllLll->db->lastInsertId(); if(isset($aMember['description']) && mb_strlen($aMember['description'])){ $sql ="UPDATE `cms_members` SET `info` = '" .$aMember[I11715] ."' WHERE `id` = " .$appliedId; $IlllLll->db->execute($sql); }$IlllLll->cms->AddStatusMsg('status_add'); $IlllLll->appliedId =$appliedId; }else{ $I1lLIL1 =$IlllLll->oMember->TTI1I1I(); $field =$IlllLll->oMember->getLoginField(); if(in_array('email', $I1lLIL1)){ $field ='email'; }elseif(!in_array(I11698, $I1lLIL1)){ $field =I11716; }$IlllLll->cms->AddStatusMsg('status_error', 'red', I11711, I11711, array('login_field' => $IlllLll->cms->Messages['login_field_' .$field])); $IlllLll->TT1llTl(); }}}class ModuleMembers_Hnd_Adm_Edit implements CMS_Mod_ActionHandler_Interface{ public function processAction(CMS_ActModule $IlllLll, $data =null){ if(!$IlllLll->actionId){ return; }$sql ="SELECT * FROM `cms_members` WHERE `id` = " .$IlllLll->actionId; if($IlllLll->actionId != $IlllLll->lIlL1I1['id']){ $sql .= " AND `lang` = '" .$IlllLll->langData ."'"; }$aMember =$IlllLll->db->getRecord($sql); if($aMember){ $lI11LlI =!empty($IlllLll->cms->Vars['flt_edit_username']); $IlllLll->cms->Gui->AddGlobalVars(array( I11717 => 'EDIT', 'EDIT_USERNAME' => (string)(int)$lI11LlI, 'EMPTY_PASSWORD' => '1', I11718 => 1 ));$IlllLll->itemData =$aMember; $aCustomFields =@unserialize($aMember['custom_data']); if(is_array($aCustomFields)){ foreach($aCustomFields as $name => $value){ $aMember[$name] =$value; }}$aMember['website'] =$aMember['companyweb']; $IlllLll->itemData['info'] =$IlllLll->cms->htmlchars($aMember[I11719]); $aMember['forum_sign'] =$IlllLll->cms->htmlchars($aMember['forum_sign']); $aScripts =$IlllLll->oMember->getScripts($IlllLll->cms); $IlllLll->itemData['header_memeber_script'] =$aScripts['header']; $IlllLll->itemData['check_member_script'] =$aScripts['check_form']; $aMember['registration_date'] =date($IlllLll->cms->DFMT['php_dtime'], strtotime($aMember['date'])); if($lI11LlI && $IlllLll->oMember->getLoginField() != I11698){ $IlllLll->oMember->setUsed(array(I11698), TRUE, FALSE, TRUE); $IlllLll->oMember->setObligatory(array(I11698), TRUE, FALSE, TRUE); }$IlllLll->itemData['allow_to_edit_at_front'] =$aMember['edit_front_allowed'] ?' checked="checked"' :I11711; $IlllLll->itemData['member_form'] =$IlllLll->oMember->getForm($IlllLll->cms, $IlllLll->db, $aMember); $IlllLll->IIllIlI =$IlllLll->actionId; $IlllLll->redirect =false; }}}class ModuleMembers_Hnd_Adm_Save implements CMS_Mod_ActionHandler_Interface{ public function processAction(CMS_ActModule $IlllLll, $data =null){ if($IlllLll->actionId){ $aMember =$IlllLll->cms->VarsPost; $isSysUser =$IlllLll->lIlL1I1['id'] == $IlllLll->actionId; $lI11Lll =false; if($isSysUser) {if(isset($aMember[I11698])){ $lI11Lll =$aMember[I11698] != $IlllLll->lIlL1I1[I11698]; }$aMember[I11698] =$IlllLll->lIlL1I1[I11698]; if($IlllLll->cms->Core->TTlllTI()){ $lI11LlL =true; }}$sql ="SELECT `photo` FROM `cms_members` WHERE `id` =" .$IlllLll->actionId; $photo =$IlllLll->db->getValue($sql); if($photo){ $aMember['old_photo'] =$photo; }if($IlllLll->cms->Core->IsInstalled('sys_users')){ unset($aMember['edit_front_allowed']); }else{ $aMember['edit_front_allowed'] =$aMember['allow_to_edit_at_front'] ?1 :0; }if(empty($lI11LlL) && $IlllLll->oMember->updateMember($IlllLll->cms, $IlllLll->db, $IlllLll->actionId, $aMember, true)){ if($isSysUser && ($IlllLll->cms->Core->HostMode() &HOSTMODE_SHARED)){ $lI11Ll1 =&DB_si::admInstance(); $oSess =admSession(); $sql ="SELECT `id_member` FROM `cms_host_users` WHERE `domain_orig` = '" .$oSess->TlIT11I() ."'"; if($lI11Ll1->getValue($sql)){ $IlllLll->oMember->updateMember($IlllLll->cms, $lI11Ll1, $IlllLll->actionId, $aMember, true, true); }unset($lI11Ll1, $oSess); }$lI11LLI =I11711; if(!empty($IlllLll->cms->VarsPost['password']) && $IlllLll->cms->VarsPost['password'] == $IlllLll->cms->VarsPost[I11714]){ if($isSysUser){ $IlllLll->oMember->TTI1I1l(I11698, $IlllLll->lIlL1I1[I11698]); if(($IlllLll->cms->Core->HostMode() &HOSTMODE_SHARED) && !empty($GLOBALS[I11720]['ftp_passwd_sync'])){ require_once $GLOBALS['CLASSES_PATH'] .'WZDaemon.php'; $daemon =&WZDaemon::admInstance(); $lI11LLI =$daemon->TlTTIT1($IlllLll->lIlL1I1[I11698], html_entity_decode(stripslashes($IlllLll->cms->VarsPost['password']))) ?I11721 :'err'; }}else{ if(!isset($IlllLll->cms->VarsPost[I11698])){ $sql ="SELECT `username` FROM `cms_members` WHERE `id` = " .$IlllLll->actionId; $IlllLll->cms->VarsPost["username"] =$IlllLll->db->getValue($sql); }$IlllLll->oMember->TTI1I1l(I11698, $IlllLll->cms->VarsPost[I11698]); }$IlllLll->oMember->TTI1I1l('id', $IlllLll->actionId); if($lI11LLI != I11722){ $IlllLll->oMember->setPass($IlllLll->db, $IlllLll->cms->VarsPost['password']); }}$sql ="UPDATE `cms_members` SET `info` = '" .$aMember[I11715] ."' WHERE id = " .$IlllLll->actionId; $IlllLll->db->execute($sql); $IlllLll->cms->AddStatusMsg('status_apply'); if($lI11LLI == I11722){ $IlllLll->cms->AddStatusMsg('passwd_change_error', 'red'); }if($lI11Lll){ $IlllLll->cms->AddStatusMsg('sysuser_login_change_forbidden', 'red'); }}else{ $I1lLIL1 =$IlllLll->oMember->TTI1I1I(); $field =$IlllLll->oMember->getLoginField(); if(in_array('email', $I1lLIL1)){ $field =I11723; }elseif(!in_array(I11698, $I1lLIL1)){ $field =I11716; }$IlllLll->cms->AddStatusMsg('status_error', 'red', I11711, I11711, array('login_field' => $IlllLll->cms->Messages['login_field_' .$field])); }}else{ $IlllLll->ProcessAction(I11706, 0); }if(!$IlllLll->appliedId){ $IlllLll->appliedId =$IlllLll->actionId; }if($IlllLll->appliedId && $IlllLll->action != I11724){ $IlllLll->ProcessAction(I11690, $IlllLll->appliedId); }$IlllLll->browser->Position =$IlllLll->browser->TI1TT1l($IlllLll->db, 'id', $IlllLll->appliedId); $IlllLll->browser->TI1TT1I(); }}class ModuleMembers_Hnd_Adm_Reset implements CMS_Mod_ActionHandler_Interface{ public function processAction(CMS_ActModule $IlllLll, $data =null){ if( $IlllLll->actionId && ($IlllLll->cms->Core->TTlllTI() ?$IlllLll->actionId != $IlllLll->lIlL1I1['id'] :true) ){$IlllLll->oMember->TTI1lIl($IlllLll->cms, $IlllLll->db, $IlllLll->actionId, true); $IlllLll->cms->AddStatusMsg('status_reset'); $IlllLll->appliedId =$IlllLll->actionId; $IlllLll->redirect =false; }}}class ModuleMembers_Hnd_Adm_Activate implements CMS_Mod_ActionHandler_Interface{ public function processAction(CMS_ActModule $IlllLll, $data =null){ if ($IlllLll->actionId && $IlllLll->lIlL1I1['id'] != $IlllLll->actionId){ $IlllLll->oMember->activateMember($IlllLll->cms, $IlllLll->db, $IlllLll->actionId, (int)($IlllLll->cms->VarsGet[I11725] == I11703)); $IlllLll->cms->AddStatusMsg('status_activate'); $IlllLll->appliedId =$IlllLll->actionId; }}}class ModuleMembers_Hnd_Adm_Delete implements CMS_Mod_ActionHandler_Interface{ public function processAction(CMS_ActModule $IlllLll, $data =null){ if ($IlllLll->actionId && $IlllLll->lIlL1I1['id'] != $IlllLll->actionId && $IlllLll->oMember->deleteMember($IlllLll->cms, $IlllLll->db, $IlllLll->actionId) ){$IlllLll->cms->AddStatusMsg('status_del'); $sql ="SELECT `id` FROM `cms_sessions` WHERE `id_member` = " .$IlllLll->actionId ." AND `expired` >= NOW() LIMIT 1"; if($IlllLll->db->getValue($sql)){ $sql ="DELETE FROM `cms_sessions` WHERE `id_member` = " .$IlllLll->actionId; $IlllLll->db->execute($sql); }}else {$IlllLll->cms->AddStatusMsg('status_del_fail', 'red'); }}}