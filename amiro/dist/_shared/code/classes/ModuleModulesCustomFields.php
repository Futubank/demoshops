<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       39095 xkqwtwsngtryyrmrliyswkttguxzsxluygzkwplnusnliuprtsuukimrurwxmxnsiygypnir
 */ ?><?php foreach(array(11739=>"Mnt",11740=>"SZtQtMIQ",11741=>"rQJZtQS|MtQID",11742=>"ZJJHCQS|ZWtMHnD",11743=>"DZvQ",11744=>"SQJ",11745=>'IHSQ',11746=>'DrW|SZtZDQt|MS',11747=>'fJt|IHSuJQ|nZIQ',11748=>'SQfZuJt|GrQfMx',11749=>".IHSuJQ|nZIQ.?mN?}'",11750=>'OMSSQn',11751=>'IHSuJQ|nZIQ',11752=>'|vZJMSZtQiHSuJQmnDtZJJZtMHn',11753=>'fJt|SZtZDQt|MS',11754=>"dqjqwT?.MS.!?.nZIQ.!?.fMQJSD|IZG.!?.IHSuJQ|nZIQ.?",11755=>"FRhi?.WID|IHSuJQD|SZtZDQtD.?",11756=>"'?zNs?.IHSuJQ|nZIQ.?=?'",11757=>'nZIQ',11758=>'SZtZ',11759=>"W`MS",11760=>"!",11761=>'fJt|ZSIMn|fHrI',11762=>'',11763=>'rQDtHrQS|IHSuJQ|nZIQ',11764=>'IHSuJQ|nZIQ|rQZSHnJB',11765=>'IHSuJQ|nZIQ|JMDt',11766=>'WZGtMHn',11767=>'smdgjzb|ihsUjq|whj',11768=>'YHttHI',11769=>'ZSIMn|fHrI',11770=>'rQDtHrQS|ZSIMn|uM',11771=>'?DQJQWtQS',11772=>'ZSIMn|uM',11773=>'GHGuG',11774=>"dqjqwT?.MS.!?.nZIQ.!?.fMQJSD|IZG.!?.fMQJSD|DOZrQS.!?.IHSuJQ|nZIQ.?",11775=>"?zNs?.IHSuJQ|nZIQ.?=?'",11776=>'fMQJSD|IZG',11777=>'MS',11778=>'MD|fMQJS|DOZrQS',11779=>'IHSuJQ',11780=>'?',11781=>'WZnWQJ',11782=>"W`MS!?W`GuYJMW!?W`IHSuJQ|nZIQ!?W`DBDtQI|nZIQ!?W`ftBGQ!?W`nZIQ!?W`SQfZuJt|WZGtMHn!?WHunt}S`MS{?ZD?SZtZDQtD",11783=>"FRhi?.WID|IHSuJQD|WuDtHI|fMQJSD.?W?jqFT?lhmN?.WID|IHSuJQD|SZtZDQtD.?S?hN?ghdmTmhN}whNwzT}'^'!W`MS!'^'{?mN?S`fMQJSD|IZG{?@?0",11784=>"WID|IHSuJQD|SZtZDQtD",11785=>'fMQJSD',11786=>'GuY|MS',11787=>'ZWtMHn',11788=>'ZGGJMQS|MS',11789=>'ZGGJB',11790=>'JQP|YJuQ',11791=>'ftBGQ',11792=>'|JMDt%IHSuJQ|nZIQ|unKnHCn',11793=>'|JMDt%MWHnD|QSMt',11794=>'SQDWrMGtMHn',11795=>"FRhi?.WID|IHSuJQD|WuDtHI|fMQJSD.?",11796=>'GuYJMW',11797=>'YHSB|tBGQ',11798=>'DOHC|YHSB|tBGQ',11799=>"dqjqwT?.DBDtQI|nZIQ.!?.IHSuJQ|nZIQ.!?.ftBGQ.?",11800=>"coqRq?.MS.?=?",11801=>"sqjqTq?FRhi?.WID|IHSuJQD|WuDtHI|fMQJSD.?coqRq?.MS.?=?",11802=>'DBDtQI|nZIQ',11803=>"zjTqR?Tzyjq?",11804=>'WID|IHSuJQD|WuDtHI|fMQJSD',11805=>'coqRq?.MS.?=?',11806=>'IDP|WuDtHI|fMQJS|nHt|fHunS|Mn|IHSuJQ',11807=>"dqjqwT?[?",11808=>"FRhi?.WID|IHSuJQD|WuDtHI|fMQJSD.?W?",11809=>'GrQfMx',11810=>'^',11811=>"dqjqwT?.DBDtQI|nZIQ.!?.IHSuJQ|nZIQ.?",11812=>'QrrnH',11813=>'SrHG',11814=>"ZJJ",11815=>'SQfZuJt|WZGtMHn',11816=>'IDP|WuDtHI|fMQJS|QxMDtD|Mn|IHSuJQ',11817=>'rQS',11818=>'GHDtfMx',11819=>"dqjqwT?.MS.?",11820=>"^'!?'^'{",11821=>'WID|IHSuJQD|SZtZDQtD',11822=>"coqRq?.MS.?mN?}",11823=>'!?',11824=>"dqjqwT?.MS.!?.fMQJSD|WZGtMHnD.?FRhi?.WID|IHSuJQD|SZtZDQtD.?coqRq?.MS.?mN?}") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleModulesCustomFields extends CMS_ActModule{ protected $lI11LLl =array( "char" => "text", I11739 => "int(11)", "float" => "double", "date" => I11740, "picture" => "varchar(128)", "flagmap" => "bigint(64)", I11741 => "text", "related_cats" => "text", "ref_reference" => "int(11) not null default 0", "ref_set" => "text" );protected $lI11LLL; protected $lI11LL1; protected $lI11L1I; protected $lI11L1l; protected $lI11L1L; protected $_popup; protected $lILIlL1; protected $lI11L11; protected $I11I1II =0; public function __construct($cms, $db, $cModule){ parent::CMS_ActModule($cms, $db, $cModule); }function _Init($IIll1l1 =array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =array()){ $IIIIL11[I11742] =array("publish", "add", "edit", "apply", I11743, "del"); $IIIIL11["group_operations"] =array("publish_on", "publish_off", I11744); $IIIIL11["lang_data"] =false; $IIIIL11['default_prefix'] ='c'; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin(){ parent::_InitAdmin(); $this->_popup =isset($this->cms->Vars['mode']) && $this->cms->Vars[I11745] == 'popup'; $this->lILIlL1 =isset($this->cms->Vars['src_id']) ?(int)$this->cms->Vars['src_id'] :0; $this->lI11L11 =isset($this->cms->Vars['src_dataset_id']) ?(int)$this->cms->Vars[I11746] :0; if($this->lILIlL1){ $this->module->SetProperty('skip_filter', true); }$this->lI11LLL =CMS_API_ModulesCustomFields::getInstance(); $this->lI11LLL->init($this->cms, $this->db); }function &TTTlI1T(&$aCustom){ $this->lI11LL1 =array(); foreach(array(I11747) as $field){ $this->lI11LL1[$field] =isset($this->cms->Vars[$field]) ?$this->cms->Vars[$field] :null; }$this->lI11LLL->initModulesCaptions($this->words); return parent::TTTlI1T($aCustom); }function _ApplyFilters($prefix ='', $bodyType ='', $IIlLLl1 =true){ $res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1) ." AND " .$this->options[I11748] .I11749 .implode("', '", $this->lI11LLL->getInstalledModules()) ."')"; return $res; }function TTTlIII(){ parent::TTTlIII(); $this->filter->TITI1l1('datefrom'); $this->filter->TITI1l1('dateto'); if($this->_popup){ $this->filter->AddField(I11745, I11750, 'popup'); if($this->lILIlL1){ $this->filter->AddField('src_id', I11750, $this->lILIlL1); return; }if($this->lI11L11){ $this->filter->AddField(I11746, I11750, $this->lI11L11); }}$aAllowedModules =$this->lI11LLL->getAllowedModules(); $aData =array(); foreach(array_keys($aAllowedModules) as $moduleName){ $aData[$moduleName] =$moduleName; }$this->TIII1lI(I11751, $aData, 50, '', I11752); if(!empty($this->cms->Vars[I11747])){ $this->I11I1II =isset($this->cms->Vars['flt_dataset_id']) ?(int)$this->cms->Vars[I11753] :0; $aDatasets =array(); $aDatasets =$this->filter->TITI1TT($aDatasets, array($this->cms->Words["all"]=>0), 55); $sql =I11754 .I11755 ."WHERE `lang` = '" .$this->langData .I11756 .$this->cms->Vars[I11747] ."' ORDER BY `name` ASC"; $rs =$this->db->select($sql); $fieldsMap =""; while($record =$rs->nextRecord()){ $aDatasets =$this->filter->TITI1TT($aDatasets, array( $record[I11757] => $record['id'] ),500); if($record['id'] == $this->I11I1II){ $fieldsMap =$record["fields_map"]; }}if(isset($aDatasets['data']) && sizeof($aDatasets[I11758])){ $this->filter->AddField("flt_dataset_id", "select", isset($this->cms->VarsPost[I11753]) ?$this->cms->VarsPost[I11753] :$this->I11I1II, "", "=", I11759, $aDatasets); $this->filter->TITIll1("flt_dataset_id"); if($this->I11I1II == 0){ $this->filter->DisableFieldSQL("flt_dataset_id"); }else{ $I11I1lI =array(); foreach(explode(";", $fieldsMap) as $I11I1ll){ if(!empty($I11I1ll) && $I11I1ll >0 && $I11I1ll <100000){ $I11I1lI[] =$I11I1ll; }}if(sizeof($I11I1lI) >0){ $this->filter->TITI1II(I11753, " OR c.id in (" .implode(I11760, $I11I1lI).")", 'force'); }else{ $this->filter->DisableFieldSQL(I11753); }}}}$I11I1Il =isset($this->cms->VarsPost['flt_admin_form']) ?$this->cms->VarsPost['flt_admin_form'] :(isset($this->cms->VarsGet[I11761]) ?$this->cms->VarsGet[I11761] :null); $IL1Ll1L =array(); $IL1Ll1L =$this->filter->TITI1TT($IL1Ll1L, array($this->cms->Words['all'] => 0), 55); $IL1Ll1L =$this->filter->TITI1TT($IL1Ll1L, array($this->words['flt_admin_form_yes'] => 1), 55); $IL1Ll1L =$this->filter->TITI1TT($IL1Ll1L, array($this->words['flt_admin_form_no'] => 2), 55); $this->filter->AddField(I11761, 'select', $I11I1Il, I11762, '=', "IF(c.admin_form = 'none', 2, 1)", $IL1Ll1L); if(!$I11I1Il){ $this->filter->DisableFieldSQL(I11761); }if(!$this->_popup){ $this->filter->TITIll1(I11747); if($this->filter->issetField(I11753)){ $this->filter->TITIll1(I11753); }}}function TTTlI1I(&$vData){ if(!$this->TIlllTT($vData) && !$this->IIllIlI){ $vData['show_body_type_body_itemD'] =' selected'; }$selected =$this->itemData ?$this->itemData[I11751] :(isset($vData[I11763]) ?$vData[I11763] :(empty($this->cms->Vars[I11747]) ?I11762 :$this->cms->Vars[I11747])); $vData['system_name_readonly'] =$vData[I11764] =$this->itemData ?' disabled="true"' :I11762; $vData[I11765] =I11762; $lI111II =AmiExt_CustomFields_Service::getInstance()->getAllowedModules(); foreach($lI111II as $moduleName => $caption){ if(!in_array($moduleName, $this->lI11LLL->getInstalledModules()) && !$this->itemData){ continue; }$aRow =array( 'value' => $moduleName, 'selected' => $moduleName != $selected ?I11762 :' selected', I11766 => $caption );$vData[I11765] .= $this->cms->Gui->get($this->moduleName .'_subform:select_option', $aRow); }$this->cms->Gui->addGlobalVars(array(I11767 => empty($this->cms->Vars[I11747]))); $vData['admin_form'] =I11762; $selected =$this->itemData ?$this->itemData['admin_form'] :(isset($vData['restored_admin_form']) ?$vData['restored_admin_form'] :$this->module->GetOption('admin_form')); foreach(array('none', 'top', 'tab', I11768) as $place){ $aRow =array( 'value' => $place, 'selected' => $place != $selected ?I11762 :' selected', I11766 => $this->words['admin_form_' .mb_strtoupper($place)] );$vData[I11769] .= $this->cms->Gui->get($this->moduleName .'_subform:select_option', $aRow); }if($this->action == 'edit'){ $this->itemData[I11769] =$vData[I11769]; }$vData['admin_ui'] =I11762; $selected =$this->itemData ?$this->itemData['admin_ui'] :(isset($vData[I11770]) ?$vData[I11770] :I11762); foreach(array('text', 'textarea') as $type){ $aRow =array( 'value' => $type, 'selected' => $type != $selected ?I11762 :I11771, I11766 => $this->words['admin_ui_' .$type] );$vData['admin_ui'] .= $this->cms->Gui->get($this->moduleName .'_subform:select_option', $aRow); }if($this->action == 'edit'){ $this->itemData[I11772] =$vData[I11772]; }parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom){ $aCustom['list_data']['source_id'] =$this->lILIlL1; $vData['source_id'] =$this->lILIlL1; $vData['source_dataset_id'] =$this->lI11L11; $vData[I11773] =$this->_popup; $vData['is_field_shared'] =0; $vData['datasets_comment_required'] =1; $vData['datasets'] =I11762; $vData['js_datasets'] =array(); if(!empty($this->itemData[I11751])){ $lI111Il =$this->itemData[I11751]; }else{ $aAllowedModules =$this->lI11LLL->getInstalledModules(); $lI111Il =$aAllowedModules[0]; unset($aAllowedModules); }$vData['filtered_dataset_id'] =$this->I11I1II; $sql =I11774 .I11755 ."WHERE `lang` = '" .$this->langData ."'" .($this->itemData ?I11775 .$this->itemData[I11751] ."'" :I11762); $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ if($record[I11751] == $lI111Il){ $selected =!empty($this->itemData['id']) && mb_strpos($record[I11776], ';' .$this->itemData['id'] .';') !== false; $row =array( 'value' => $record[I11777], I11766 => $record[I11757], 'selected' => $selected ?I11771 :I11762 );if($selected){ $vData['datasets_comment_required'] =0; }$vData['datasets'] .= $this->cms->Gui->get($this->moduleName .'_subform:select_option', $row); $vData[I11778] =(int)(isset($this->itemData[I11777]) && mb_strpos($record['fields_shared'], ';' .$this->itemData[I11777] .';') !== false); }$row =array( I11777 => $record[I11777], I11779 => $record[I11751], I11766 => jparse($record[I11757]) );$vData['js_datasets'][] =$this->cms->Gui->get($this->moduleName ."_subform:js_dataset", $row); }$vData['js_datasets'] =implode(', ', $vData['js_datasets']); if($this->lILIlL1){ $db =clone($this->db); require_once $GLOBALS['CLASSES_PATH'] .'CMS_IteratorArray.php'; $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray(array()); $this->db->IIIll1L =false; $this->browser->InitSQL("*", "FROM xxx", "WHERE 1"); $this->browser->SetForceRules(' ', I11780); $aCustom['applied_id'] ='c.id'; $aCustom['form_data']['buttons'] =array(I11781, 'save'); }else{ $this->browser->InitSQL( I11782, I11783, "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), I11759 );$this->browser->AddSQLJoinedTables($this->cms->Core, 'c', array('d' => I11784)); $aCustom[I11785] =array( 'public' => array('action' => 'flagicon', 'value' => 1, I11777 => I11786, 'on' => $this->moduleName .'_list:public_on', 'off' => $this->moduleName .'_list:public_off'), I11757 => array(I11787 => 'callback', 'object' => $this, 'method' => 'cbAdmListRow') );$aCustom[I11788] ='c.id'; $aCustom['form_data']['buttons'] =array('add', I11789, I11781, 'save'); }$aCustom['legend'] =array('leg_red', 'leg_yellow', I11790, 'leg_edit', 'leg_del'); parent::TTTlI11($vData, $aCustom); if(isset($db)){ $this->db =$db; }}public function cbAdmListRow(&$aItem, &$aData){ foreach(array(I11757, 'default_caption') as $field){ $value =unserialize($aItem[$field]); $aItem[$field] =is_array($value) && isset($value[$this->langData]) ?$this->cms->stripLine($value[$this->langData], 25) :$this->words['unknown']; }foreach(array(I11791) as $field){ $aItem[$field] =$this->words[$field .'_' .$aItem[$field]]; }$aAllowedModules =$this->lI11LLL->getAllowedModules(); $aItem[I11751] =isset($aAllowedModules[$aItem[I11751]]) ?$aAllowedModules[$aItem[I11751]] :$this->cms->Gui->get($this->moduleName .I11792, $aItem); $links['del_id'] =$links['edit_id'] =$links[I11786] =$aItem[I11777]; $aItem['actions'] =$this->cms->Gui->get($this->moduleName .I11793, $links) .$this->cms->Gui->get($this->moduleName .'_list:del', $links); }function TTT1IlI($aSQL =array(), $cId =0){ $cId =(int)$cId; $this->lI11L1L =array(); if(!$this->TIllI11($cId)){ return array(); }$lI111IL =array( I11757 => array(), 'prefix' => array(), 'postfix' => array(), 'default_caption' => array(), I11794 => array() );if($cId){ $sql ="SELECT `name`, `prefix`, `postfix`, `default_caption`, `description` " .I11795 ."WHERE `id` = " .$cId; $record =$this->db->getRecord($sql); if($record){ foreach(array_keys($lI111IL) as $fieldName){ $lI111IL[$fieldName] =unserialize($record[$fieldName]); if(!is_array($lI111IL[$fieldName])){ $lI111IL[$fieldName] =array(); }}}}else{ $aSQL += array( I11751 => $this->cms->VarsPost[I11751], 'system_name' => mb_strtolower($this->cms->VarsPost['system_name']) );}foreach(array_keys($lI111IL) as $fieldName){ $lI111IL[$fieldName][$this->langData] =stripslashes($this->cms->VarsPost[$fieldName]); $aSQL[$fieldName] =addslashes(serialize($lI111IL[$fieldName])); }$aSQL += array( I11796 => empty($this->cms->VarsPost[I11796]) ?0 :1, 'isnot_all' => empty($this->cms->VarsPost['isnot_all']) ?0 :1, I11769 => $this->cms->VarsPost[I11769], I11772 => $this->cms->VarsPost[I11772], I11791 => $this->cms->VarsPost[I11791], 'admin_filter' => (int)!empty($this->cms->VarsPost['admin_filter']) );if(isset($this->cms->VarsPost[I11797]) && is_array($this->cms->VarsPost[I11797])){ $aSQL[I11797] =';' .implode(';', $this->cms->VarsPost[I11797]) .';'; }if(isset($this->cms->VarsPost['show_body_type']) && is_array($this->cms->VarsPost[I11798])){ $aSQL[I11798] =';' .implode(';', $this->cms->VarsPost[I11798]) .';'; }else{ $aSQL[I11798] =I11762; }$this->lI11L1L =$aSQL; $aSQL =parent::TTT1IlI($aSQL, $cId); return $aSQL; }function TTTll11($cId, $cModule){ parent::TTTll11($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno']) && $cId == 0 && $this->appliedId >0){ $appliedId =(int)$this->appliedId; $sql =I11799 .I11795 .I11800 .$appliedId; $record =$this->db->getRecord($sql); if($record){ $this->db->setSafeSQLOptions('alter'); $sql ="ALTER TABLE " .$this->lI11L1I ." ADD COLUMN " .$this->lI11L1l ." " .$this->lI11LLl[$record[I11791]]; if(!$this->db->execute($sql, DBC_NO_HALT)){ $sql =I11801 .$appliedId; $this->SetLastError(1, 'msg_cannot_alter_db'); }else{ $this->TIlllTI($appliedId, isset($this->cms->VarsPost['datasets']) ?$this->cms->VarsPost['datasets'] :array()); }$this->db->clearSafeSQLOptions(); }}}function TTTl1lI($cId, $cModule){ $cId =(int)$cId; $sql =I11799 .I11795 .I11800 .$cId; $record =$this->db->getRecord($sql); parent::TTTl1lI($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno']) && $record){ $sql ="SELECT `ftype` " .I11795 .I11800 .$cId; $lI111I1 =$this->db->getValue($sql); $this->lI11L1I =$this->cms->Core->GetModule($record[I11751])->GetTableName(); if($record[I11791] != $lI111I1){ $this->lI11L1l =mb_strtolower(CMS_API_ModulesCustomFields::PREFIX .$record[I11802]); $this->db->setSafeSQLOptions('DESCRIBE'); $sql ="DESCRIBE " .$this->lI11L1I; $rs =$this->db->select($sql); $this->db->clearSafeSQLOptions(); $lI111lI =false; while($rec =$rs->nextRecord()){ if(mb_strtolower($rec['Field']) == $this->lI11L1l){ $lI111lI =true; break; }}if($lI111lI){ $this->db->setSafeSQLOptions('alter'); $sql =I11803 .$this->lI11L1I ." " ."CHANGE " .$this->lI11L1l ." " .$this->lI11L1l ." " .$this->lI11LLl[$lI111I1]; if(!$this->db->execute($sql, DBC_NO_HALT)){ $sql =$this->db->genUpdateSQL(I11804, array(I11791 => $record[I11791]), I11805 .$cId); $this->db->execute($sql); $this->SetLastError(3, 'msg_cannot_alter_db'); }$this->db->clearSafeSQLOptions(); }else{ $this->cms->AddStatusMsg(I11806, 'red', I11762, I11762, $record); }}$this->TIlllTI($cId, isset($this->cms->VarsPost['datasets']) ?$this->cms->VarsPost['datasets'] :array()); }}function TTTl1Tl($cId, $cModule){ parent::TTTl1Tl($cId, $cModule); $cId =(int)$cId; $sql =I11807. I11808. I11800 .$cId .$this->_ApplyFilters(); $this->itemData =$this->db->getRecord($sql); if($this->itemData){ $this->lI11LL1[I11747] =$this->itemData[I11751]; $this->itemData[I11796] =$this->itemData[I11796] ?' checked' :I11762; $this->itemData['isnot_all'] =$this->itemData['isnot_all'] ?' checked' :I11762; $lI111IL =array( I11757 => array(), I11809 => array(), 'postfix' => array(), 'default_caption' => array(), I11794 => array() );foreach(array_keys($lI111IL) as $fieldName){ $lI111IL[$fieldName] =unserialize($this->itemData[$fieldName]); if(!is_array($lI111IL[$fieldName])){ $lI111IL[$fieldName] =array(); }$this->itemData[$fieldName] =isset($lI111IL[$fieldName][$this->langData]) ?$lI111IL[$fieldName][$this->langData] :I11762; }$this->itemData['ftype_' .$this->itemData[I11791]] =I11771; foreach(array(I11797, I11798) as $field){ foreach(explode(';', trim($this->itemData[$field], I11810)) as $bodyType){ $this->itemData['show_body_type_' .$bodyType] =I11771; }}$this->itemData['admin_filter'] =$this->itemData['admin_filter'] ?' checked' :I11762; }}function _ActionDel($cId, $cModule){ $cId =(int)$cId; $sql =I11811 .I11795 .I11800 .$cId; $record =$this->db->getRecord($sql); parent::_ActionDel($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL[I11812]) && $record){ $this->lI11L1I =$this->cms->Core->GetModule($record[I11751])->GetTableName(); $this->lI11L1l =mb_strtolower(CMS_API_ModulesCustomFields::PREFIX .$record[I11802]); $this->db->setSafeSQLOptions('DESCRIBE'); $sql ="DESCRIBE " .$this->lI11L1I; $rs =$this->db->select($sql); $this->db->clearSafeSQLOptions(); $lI111lI =false; while($record =$rs->nextRecord()){ if(mb_strtolower($record['Field']) == $this->lI11L1l){ $lI111lI =true; break; }}if($lI111lI){ $this->db->setSafeSQLOptions('alter'); $this->db->setSafeSQLOptions(I11813); $sql =I11803 .$this->lI11L1I ." DROP " .$this->lI11L1l; if(!$this->db->execute($sql, DBC_NO_HALT)){ $this->SetLastError(3, 'msg_cannot_alter_db'); }$this->db->clearSafeSQLOptions(); }else{ $this->cms->AddStatusMsg(I11806, 'red', I11762, I11762, $record); }$this->TIlllTI($cId, array()); }}protected function TIII1lI($fieldName, $aData, $lIIIIll, $default =null, $methodName =I11762) {$IILLLL1 ="flt_" .$fieldName; $aSelect =array ();if(!is_null($default)){ $aSelect =$this->filter->TITI1TT($aSelect, array($this->cms->Words[I11814] => $default)); }foreach($aData as $word => $value){ $caption =$this->words[$word]; if ($methodName != I11762 && !$this->$methodName($caption, $value)){ continue; }$aSelect =$this->filter->TITI1TT( $aSelect, array($caption => $value), $lIIIIll );}$this->filter->AddField( $IILLLL1, 'select', $this->lI11LL1[$IILLLL1], I11762, '=', $this->options[I11748] .$fieldName, $aSelect );$this->filter->MoveField($IILLLL1, _MOVE_PREV); if(!is_null($default) && $this->lI11LL1[$IILLLL1] == $default){ $this->filter->DisableFieldSQL($IILLLL1); }}protected function _validateModuleInstallation(&$caption, $value) {$res =in_array($value, $this->lI11LLL->getInstalledModules()); if($res){ $oModule =$this->cms->Core->GetModule($value); $IIlI11L =$oModule->GetParentName(); if($IIlI11L){ $caption =$this->words[$IIlI11L] .' : ' .$caption; }}return $res; }protected function TIllI11($id){ $lI111ll =true; $aRequiredFields =$id ?array(I11757, 'default_caption', I11791, I11769, I11772) :array(I11802, I11751, I11757, I11815, I11791, I11769, I11772); foreach($aRequiredFields as $lI111lL){ if(!isset($this->cms->VarsPost[$lI111lL]) || !mb_strlen($this->cms->VarsPost[$lI111lL])){ $lI111ll =false; break; }$this->cms->VarsPost[$lI111lL] =trim($this->cms->VarsPost[$lI111lL]); }$lI111ll =$lI111ll && ($id || (preg_match('/^[0-9a-z_]+$/si', $this->cms->VarsPost[I11802]) && in_array($this->cms->VarsPost[I11751], $this->lI11LLL->getInstalledModules()) ));if($lI111ll && !$id){ $sql ="SELECT `id` " .I11795 ."WHERE `system_name` = '" .$this->cms->VarsPost[I11802] .I11756 .$this->cms->VarsPost[I11751] ."'"; if($this->db->getValue($sql)){ $this->cms->AddStatusMsg('msg_custom_field_exists', 'red'); $lI111ll =false; }else{ $this->lI11L1I =$this->cms->Core->GetModule($this->cms->VarsPost[I11751])->GetTableName(); $this->lI11L1l =mb_strtolower(CMS_API_ModulesCustomFields::PREFIX .$this->cms->VarsPost[I11802]); $this->db->setSafeSQLOptions('DESCRIBE'); $sql ="DESCRIBE " .$this->lI11L1I; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ if(mb_strtolower($record['Field']) == $this->lI11L1l){ $this->cms->AddStatusMsg(I11816, I11817); $lI111ll =false; break; }}}}return $lI111ll; }protected function TIlllTT(&$aData){ if(!in_array($this->errno, array(1, 2)) || !sizeof($this->cms->VarsPost)){ return false; }$aData[I11796] =empty($this->cms->VarsPost[I11796]) ?I11762 :' checked'; $aData['isnot_all'] =empty($this->cms->VarsPost['isnot_all']) ?I11762 :' checked'; if(!empty($this->cms->VarsPost[I11751])){ $aData[I11763] =$this->cms->VarsPost[I11751]; }foreach(array(I11802, I11751, I11757, I11815, I11809, I11818, I11769, I11794) as $field){ if(isset($this->cms->VarsPost[$field])){ $aData[$field] =$this->cms->VarsPost[$field]; }}if(!empty($this->cms->VarsPost[I11791])){ $aData['ftype_' .$this->cms->VarsPost[I11791]] =I11771; }$IL1Ll1L =isset($this->cms->VarsPost[I11769]) ?(int)$this->cms->VarsPost[I11769] :2; if(!empty($this->cms->VarsPost[I11769])){ $aData['restored_admin_form'] =$this->cms->VarsPost[I11769]; }if(!empty($this->cms->VarsPost[I11772])){ $aData[I11770] =$this->cms->VarsPost[I11772]; }if(isset($this->cms->VarsPost[I11798]) && is_array($this->cms->VarsPost[I11798])){ foreach($this->cms->VarsPost[I11798] as $bodyType){ $aData['show_body_type_' .$bodyType] =I11771; }}return true; }public function TIlllTI($fieldId, $lI111l1){ if(!is_array($lI111l1) || ($this->_popup && !$this->lI11L11)){ return; }$lI111l1 =array_map('intval', $lI111l1); $lI111LI =array(); $sql =I11819 .I11755 ."WHERE `fields_shared` LIKE '%;" .$fieldId .";%'"; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ if(in_array($record[I11777], $lI111l1)){ $lI111LI[] =$record[I11777]; }else{ $aSQL =array( 'fields_shared' => "=|REPLACE(`fields_shared`, ';" .$fieldId. I11820 );$sql =$this->db->genUpdateSQL(I11821, $aSQL, "WHERE `lang` = '" .$this->cms->lang_data ."'"); $this->db->execute($sql); }}$lI111Ll =array(); $sql =I11819 .I11755 ."WHERE `fields_map` LIKE '%;" .$fieldId .";%'"; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ if(in_array($record[I11777], $lI111l1)){ $lI111LI[] =$record[I11777]; }else{ $lI111Ll[] =$record[I11777]; }}if(sizeof($lI111Ll)){ $aSQL =array( I11776 => "=|REPLACE(`fields_map`, ';" .$fieldId. I11820, 'fields_shared' => "=|REPLACE(`fields_shared`, ';" .$fieldId. I11820, 'fields_filter' => "=|REPLACE(`fields_filter`, ';" .$fieldId. I11820 );$sql =$this->db->genUpdateSQL(I11821, $aSQL, I11822 .implode(', ', $lI111Ll) .")"); $this->db->execute($sql); }$lI111l1 =array_diff($lI111l1, array_unique($lI111LI)); if(sizeof($lI111l1)){ $aSQL =array( I11776 => "=|CONCAT(`fields_map`, '" .$fieldId .";')" );$sql =$this->db->genUpdateSQL(I11821, $aSQL, I11822 .implode(I11823, $lI111l1) .")"); $this->db->execute($sql); $sql =I11824 .implode(I11823, $lI111l1) .")"; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ $aCaptions =unserialize($record['fields_captions']); if(!is_array($aCaptions)){ $aCaptions =array(); }$aNames =unserialize(stripslashes($this->lI11L1L[I11815])); $aCaptions[$fieldId] =$aNames[$this->langData]; $sql =$this->db->genUpdateSQL(I11821, array( 'fields_captions' => addslashes(serialize($aCaptions)) ),I11800 .$record[I11777]); $this->db->execute($sql); }}$oModule =$this->cms->Core->TTllTIl($this->lI11L1I); $this->cms->Core->Cache->clearModCache($oModule); }}