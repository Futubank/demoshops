<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       16206 xkqwpkinrnkgzxwyprptzsuktnxlmkszmwirqsguuztzxspnwtwtygmtkyimwzxlxyqmpnir
 */ ?><?php foreach(array(11897=>'WOQWK|GuYJMW',11898=>'rQIHvQ',11899=>'iHSuJQiHSuJQDsZtZDQtDgHGuG|onS|zSI|iHvQ',11900=>'iHSuJQiHSuJQDsZtZDQtDgHGuG|onS|zSI|RQIHvQ',11901=>'SZtZDQt|MS',11902=>'IHSuJQ|nZIQ',11903=>'WZtQPHrMQD',11904=>'NH?WZtQPHrB?IHSuJQ?fHr?DQJQWtQS?IHSuJQ',11905=>"dqjqwT?.MD|DBD.!?",11906=>"FRhi?.WID|IHSuJQD|SZtZDQtD.?",11907=>'^',11908=>".?",11909=>"coqRq?.MS.?mN?}",11910=>'fJt|IHSuJQ|nZIQ',11911=>'wURRqNT|dkmN|gzTo',11912=>'SZtQtH',11913=>'OMSSQn',11914=>'',11915=>'IHSuJQ|WZGtMHn',11916=>'HYLQWtD|WHuntQr',11917=>"?zNs?H`.IHSuJQ|nZIQ.?=?'",11918=>'~tZYJQ~IHSQJ',11919=>'DQJQWtQS|HYLQWtD',11920=>'!',11921=>'GuYJMW',11922=>'tZYJQD',11923=>'WID|IHSuJQD|SZtZDQtD',11924=>'.?zdw',11925=>"vZJuQ",11926=>"Hff",11927=>'HYLQWt',11928=>"HffDQt",11929=>'WZt|IHSuJQ',11930=>"|JMDt%nZIQ|",11931=>".!?'^",11932=>"^:'",11933=>'MS|SZtZDQt') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleModulesDatasetsPopup extends CMS_ActModule{ protected $lI11LLL; protected $lI11LL1; protected $IL1LlLI; protected $llIIIIl; protected $llIIIIL; protected $_moduleName; protected $llIIII1; protected $llIIIlI; public $II1LIL1; function __construct(&$cms, &$db, &$cModule){ parent::CMS_ActModule($cms, $db, $cModule); }function _Init($IIll1l1 =array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =array()){ $IIIIL11 =array( I11897 => false, 'group_operations' => array ('move'), 'allowed_actions' => array ('move', I11898), 'default_prefix' => 'o' );$aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin(){ $this->addHandler('move', I11899); $this->addHandler(I11898, I11900); $this->lI11LLL =CMS_API_ModulesCustomFields::getInstance(); $this->lI11LLL->init($this->cms, $this->db); $this->IL1LlLI =isset($this->cms->Vars['dataset_id']) ?(int)$this->cms->Vars[I11901] :0; $this->llIIIIL =isset($this->cms->Vars['mode']) ?$this->cms->Vars['mode'] :''; $this->_moduleName =isset($this->cms->Vars[I11902]) ?$this->cms->Vars[I11902] :''; if(!$this->IL1LlLI || !in_array($this->llIIIIL, array(I11903, 'pages')) || !in_array($this->_moduleName, $this->lI11LLL->getInstalledModules())){ trigger_error('Invalid url parameters', E_USER_ERROR); }if($this->llIIIIL == I11903 && !$this->cms->Core->IsInstalled($this->_moduleName .'_cat')){ trigger_error(I11904, E_USER_ERROR); }$this->llIIII1 ='used_' .$this->llIIIIL; $this->II1LIL1 =array(); $sql =I11905 .$this->llIIII1 ." " .I11906 ."WHERE `id` = " .$this->IL1LlLI; $record =$this->db->getRecord($sql); if(!($record)){ trigger_error('Invalid dataset id', E_USER_ERROR); }$this->llIIIIl =(bool)$record['is_sys']; $this->II1LIL1 =$record[$this->llIIII1]; $this->II1LIL1 =trim($this->II1LIL1, I11907); $this->II1LIL1 =mb_strlen($this->II1LIL1) ?explode(I11907, $this->II1LIL1) :array(); $this->llIIIlI =$this->llIIIIL == I11903 ?$this->cms->Core->GetModule($this->_moduleName .'_cat')->GetTableName() :'cms_pages'; $sql ="SELECT `id` " ."FROM `" .$this->llIIIlI .I11908 ."WHERE `id_dataset` = 0"; $aIds =array(); $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ $aIds[] =$record['id']; }if(sizeof($aIds)){ $aBackup =array($this->II1LIL1, $this->IL1LlLI); if(!$this->llIIIIl){ $this->IL1LlLI =$this->lI11LLL->getSysDatasetId($this->_moduleName); }$this->II1LIL1 =array(); $this->TIlllII(FALSE, $aIds); list($this->II1LIL1, $this->IL1LlLI) =$aBackup; unset($aBackup); }unset($aIds); if (sizeof($this->II1LIL1)) {$llIIIll =$this->II1LIL1; $sql ="SELECT `id` " ."FROM `" .$this->llIIIlI .I11908 .I11909 .implode(', ', $this->II1LIL1) .")"; $rs =$this->db->select($sql); while($record =$rs->nextRecord()){ $index =array_search($record['id'], $llIIIll); if($index !== FALSE){ unset($llIIIll[$index]); }}if(sizeof($llIIIll)){ $this->II1LIL1 =array_diff($this->II1LIL1, $llIIIll); $this->TIlllII(FALSE, $llIIIll); }}parent::_InitAdmin(); }function &TTTlI1T(&$aCustom){ $this->lI11LLL->initModulesCaptions($this->words); $data =parent::TTTlI1T($aCustom); $this->lI11LL1 =array(); foreach(array(I11910) as $field){ $this->lI11LL1[$field] =isset($this->cms->Vars[$field]) ?$this->cms->Vars[$field] :null; }$this->cms->Gui->delScript(); $this->cms->Gui->addScript("jsapi.php"); $this->cms->Gui->addScript($GLOBALS[I11911] .'_js/ami.admin.js'); $data['js'] =$this->cms->Gui->get($this->moduleName .':js', $data); $data['selected_objects_list'] =$this->cms->Gui->get($this->moduleName .':selected_objects_list', $data); $data['scripts'] =$this->cms->Gui->getScripts(); $data['metas'] =$this->cms->Gui->getMetas(); $data['status'] =$this->cms->GetStatusMessages(); global $conn; print $this->cms->Gui->get($this->moduleName, $data); $conn->Out(); die; }function TTTlIII(){ parent::TTTlIII(); $this->filter->TITI1l1('datefrom'); $this->filter->TITI1l1(I11912); $this->filter->IL11l1L =array('limit'); $this->filter->AddField(I11901, 'hidden', $this->IL1LlLI); $this->filter->AddField('mode', 'hidden', $this->llIIIIL); $this->filter->AddField(I11902, I11913, $this->_moduleName); $this->filter->AddField("flt_name", "text", isset($this->cms->Vars["flt_name"]) ?stripslashes(unhtmlentities($this->cms->Vars["flt_name"])) :I11914, "", " like ", "o.name"); }function TTTlI1I(&$vData) {$vData[I11901] =$this->IL1LlLI; $vData[I11902] =$this->_moduleName; $vData['mode'] =$this->llIIIIL; $aCaptions =$this->lI11LLL->getAllowedModules(); $vData[I11915] =$aCaptions[$this->_moduleName]; $vData[I11916] =sizeof($this->II1LIL1); parent::TTTlI1I($vData); }function _ApplyFilters($prefix =I11914, $bodyType =I11914, $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); if($this->llIIIIL == 'pages'){ $res .= I11917 .$this->lI11LLL->getParentForCatModule($this->_moduleName) ."'"; }return $res; }function TTTlI11(&$vData, &$aCustom){ $field ='name'; if( 'cms_pages' !== $this->llIIIlI && AMI::isResource($this->_moduleName .I11918) ){$oTable =AMI::getResourceModel($this->_moduleName .'/table'); if(!$oTable->hasField('name') && $oTable->hasField('header')){ $field ='header'; }}$selected =sizeof($this->II1LIL1); if ($selected) {$vData[I11919] =I11914; $sql ="SELECT `id`, `public`, `" .$field ."` `name` " ."FROM " .$this->llIIIlI ." " .I11909 .implode(I11920, $this->II1LIL1) .")"; $rs =$this->db->select($sql); $vData[$this->llIIIIL .'_counter'] =$rs->numRows(); while ($record =$rs->nextRecord()) {$record['public'] =$this->cms->Gui->getAbs($this->moduleName ."_list:icon_public_" .($record[I11921] ?'on' :'off'), I11914); $record['is_sys'] =$this->llIIIIl; $this->cbAdmListRow($record, $vData); $vData[I11919] .= $this->cms->Gui->get($this->moduleName .":selected_row", $record); }$vData['selected_objects_header'] =$this->cms->Gui->getAbs($this->moduleName .':selected_objects_header'); }else{ $vData[I11919] =$this->cms->Gui->getAbs($this->moduleName .':selected_objects_list_empty'); }$this->browser->InitSQL( "o.`id`, o.`public`, o.`" .$field ."` `name`, d.`name` dataset_name", array( I11922 => array('o' => $this->llIIIlI, 'd' => I11923), 'joins' => array('o|d' => 'd.id = o.id_dataset'), 'joins_types' => array('o|d' => 'LEFT OUTER') ),"WHERE 1 " .$this->_ApplyFilters() .($selected ?" AND o.`id` NOT IN (" .implode(', ', $this->II1LIL1) .')' :I11914) .$this->TTTlIl1() );$this->browser->AddSQLJoinedTables($this->cms->Core, 'd', I11923); $this->browser->SetForceRules('ORDER BY o.`' .$field .I11924); $aCustom['fields'] =array ("public" => array ("action"=>"flagicon", I11925=>1, "id"=>"pub_id", "on"=>$this->moduleName."_list:icon_public_on",I11926=>$this->moduleName."_list:icon_public_off"), 'name' => array('action' => 'callback', I11927 => $this, 'method' => 'cbAdmListRow') );$aCustom['applied_id'] ='id'; if(is_object($this->filter)){ $this->filter->UpdateField(I11928, $this->browser->Position); $aCustom['list_data']['filter_hidden_fields'] =$this->filter->GetFieldsAsHidden(); }if(in_array($this->appliedId, $this->II1LIL1)){ $this->appliedId =0; }parent::TTTlI11($vData, $aCustom); }public function cbAdmListRow(&$aItem, &$aData){ if($this->llIIIIL == I11903){ $aItem[I11929] =$this->_moduleName .'_cat'; }$aItem['name'] =$this->cms->Gui->getAbs($this->moduleName .I11930 .$this->llIIIIL, $aItem); }function TTTlITT($IIIL11l, $cId, $cModule =I11914){ $id =intval($cId); switch ($IIIL11l) {case 'grp_move': $this->TTTl1Il($this->aGroupIds, $cModule, 'move', 'status_grp_move'); break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}public function TIlllII($llIIIlL =false, $llIIIl1 =array()){ if($llIIIlL){ foreach($this->II1LIL1 as $id){ $sql =$this->db->genUpdateSQL( I11923, array( $this->llIIII1 => "=|REPLACE(`" .$this->llIIII1 .I11931 .$id .";', ';')" ),"WHERE `lang` = '" .$this->langData ."' AND " .$this->llIIII1 ." LIKE '%;" .$id .I11932 );$this->db->execute($sql); }}$sql =$this->db->genUpdateSQL(I11923, array( $this->llIIII1 => I11907 .(sizeof($this->II1LIL1) ?implode(I11907, $this->II1LIL1) .I11907 :I11914) ),'WHERE `id` = ' .$this->IL1LlLI); $this->db->execute($sql); if(sizeof($this->II1LIL1)){ $sql =$this->db->genUpdateSQL($this->llIIIlI, array( 'id_dataset' => $this->IL1LlLI ),I11909 .implode(', ', $this->II1LIL1) .")"); $this->db->execute($sql); }if(sizeof($llIIIl1)){ static $sysDatasetId =null; if(is_null($sysDatasetId)){ $sysDatasetId =$this->lI11LLL->getSysDatasetId($this->_moduleName); }$sql =$this->db->genUpdateSQL($this->llIIIlI, array( I11933 => $sysDatasetId ),I11909 .implode(', ', $llIIIl1) .")"); $this->db->execute($sql); }}}class ModuleModulesDatasetsPopup_Hnd_Adm_Move implements CMS_Mod_ActionHandler_Interface{ public function processAction(CMS_ActModule $IlllLll, $data =null){ if ($IlllLll->actionId && !in_array($IlllLll->actionId, $IlllLll->II1LIL1)){ $IlllLll->II1LIL1[] =$IlllLll->actionId; $IlllLll->TIlllII(true); $IlllLll->cms->AddStatusMsg('status_add_to_list'); $IlllLll->appliedId =$IlllLll->actionId; }}}class ModuleModulesDatasetsPopup_Hnd_Adm_Remove implements CMS_Mod_ActionHandler_Interface{ public function processAction(CMS_ActModule $IlllLll, $data =null){ if (in_array($IlllLll->actionId, $IlllLll->II1LIL1)){ unset($IlllLll->II1LIL1[array_search($IlllLll->actionId, $IlllLll->II1LIL1)]); $IlllLll->TIlllII(false, array($IlllLll->actionId)); $IlllLll->cms->AddStatusMsg('status_remove_from_list'); }}}