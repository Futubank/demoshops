<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       38120 xkqwuplzpgpkzgzqimngugrwmqutmxyrkmsrgwknxriiltrqzpqrlxxlsixpsykywzqlpnir
 */ ?><?php foreach(array(12228=>'SZtZ|QxWOZnPQ|WZt|IHSuJQ',12229=>"",12230=>"ZGGJB",12231=>"GuYJMDO|Hn",12232=>"MnSQx|SQtZMJD",12233=>"Zr",12234=>'~tZYJQ',12235=>'Qxt|MIZPQD',12236=>"|JMDt",12237=>"fJt|OQZSQr",12238=>'fHrI|CMStO',12239=>'Zr',12240=>"coqRq?1?",12241=>'tZYJQD',12242=>"vZJuQ",12243=>"Hff",12244=>"DMAQ",12245=>"ZWtMHn",12246=>"fJZPMWHn",12247=>"ZWtMHn|SQJ",12248=>"ZGGJMQS|MS",12249=>"WZnWQJ",12250=>"JQP|YJuQ",12251=>"YHSB|WZtD",12252=>"IuJtMWZt",12253=>'YHSB|urPQnt|WZtD',12254=>"LHMn",12255=>"MS",12256=>'|DEJ',12257=>'!?',12258=>'Qxt|SMDWuDDMHn',12259=>"ZnnHunWQ",12260=>"SY",12261=>"COQrQ",12262=>"ZutOHr",12263=>"DQJQWt",12264=>"tZYJQD",12265=>"IQtOHS",12266=>"GZPQ|MtQI|tBGQ",12267=>'JMDt|SZtZ',12268=>"YHSB|MtQIs",12269=>"tHG|JMnK",12270=>"MtQIs",12271=>"'",12272=>"MS|WZt",12273=>"WHnf",12274=>"YHSB",12275=>'Qxt|MIP',12276=>"MS|QxtQrnZJ",12277=>"MtQI",12278=>'',12279=>'nuJJ',12280=>"?jmimT?",12281=>"||MS|WZt||",12282=>"nZIQ|fMQJS|nZIQ",12283=>"WZt|DuYJMnK",12284=>"DuYMtQI",12285=>"MtQI|JMDt",12286=>"JMDt",12287=>"WZtD|nuI",12288=>"DGJMttQr|GrQfMx",12289=>'Zt|DGQW|YJHWK',12290=>"?hRsqR?yb?",12291=>"WZt|MS",12292=>"uDQ|MS|GZPQ",12293=>"WZtD|MSD",12294=>"'{?ZD?fSZtQ?",12295=>"?",12296=>"WZJJYZWK",12297=>"SQtMZJD",12298=>"SZtQ",12299=>"DIZJJ",12300=>"ZWtMvQ|MtQI|tBGQ",12301=>"nZv|SZtZ",12302=>"!?MS|WZt",12303=>'fJt|ZJY|WZt|MS',12304=>"DtZtMW|CZtQrIZrK") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModulePhotoalbum extends CMS_ActModule {public $IlIllI1; public $I1LIIl1; public $I1LIILI; public $I1LIILl; public $I1LIILL; public $II1lllI; public $I1LII1I; function ModulePhotoalbum(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $llIl1Ll =AMI_Registry::get(I12228, 'photoalbum_cat'); $this->I1LII1I =$this->cms->Core->IsInstalled($llIl1Ll) && $this->module->IssetAndTrueOption("use_categories"); if ($this->I1LII1I) {$this->IlIllI1 =new CMS_CategoriesFunctions($this->cms, $this, $llIl1Ll); }else {$this->IlIllI1 =new CMS_CategoriesFunctionsStub($this->cms, $this, $llIl1Ll); }$this->II1lllI =Array(); }function _Init($IIll1l1 =Array(), $IIll1LI =I12229, $IIll1Ll =I12229, $aOptions =Array()) {$IIIIL11["allowed_actions"] =Array("publish", "add", "edit", I12230, "save", "del", "repair"); $IIIIL11["group_operations"] =Array(I12231, "publish_off", "del", "gen_sublink", "gen_keywords", I12232, "no_index_details", "reset_ratings", "move_position"); $IIIIL11["default_prefix"] =I12233; $IIIIL11["use_id_page"] =true; $IIIIL11["use_options_form"] =true; $IIIIL11["name_field_name"] ="header"; $IIIIL11["description_field_name"] ="body"; $IIIIL11["picture_cat"] ="photoalbum"; $IIIIL11["use_positions"] =true; $aOptions += $IIIIL11; $this->TTITTI1( AMI::getResourceModel($this->moduleName .I12234) ->hasField('public_direct_link') );parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); if(!isset($this->ext['ext_images'])){ if($this->cms->Core->IsInstalled('ext_images')) {$ext =&$this->GetExtension('ext_images'); if(is_object($ext)) {$this->ext[I12235] =&$ext; $this->ext[I12235]->Init($this->cms, $this->module, $this); }}}$this->IlIllI1->_Init(); $this->IlIllI1->TTIT1IT("_ApplyCatFilters"); }function _InitAdmin() {if(!isset($this->ext[I12235])){ if($this->cms->Core->IsInstalled(I12235)) {$ext =&$this->GetExtension(I12235); if(is_object($ext)) {$this->ext[I12235] =&$ext; $this->ext[I12235]->Init($this->cms, $this->module, $this); }}}parent::_InitAdmin(); }function TTTlTI1() {parent::TTTlTI1(); $this->I1LIIl1 =$this->module->GetOption("show_subitems"); $this->I1LIILl =$this->module->GetOption("subitems_splitter_period"); $this->I1LIILL =$this->module->GetOption("subitems_cols"); $this->cms->SetsTemplate =$this->moduleName.I12236; }function TTTlITT($IIIL11l, $cId, $cModule =I12229) {parent::TTTlITT($IIIL11l, $cId, $cModule); }function GetHtml(&$aCustom) {return parent::GetHtml($aCustom); }function TTTlIII() {parent::TTTlIII(); if($this->IlIllI1->TTTlIII("flt_alb_cat_id")) {$this->filter->MoveField("flt_alb_cat_id", _MOVE_START); }$this->filter->AddField("flt_header", "text", stripslashes(unhtmlentities($this->cms->Vars[I12237])), I12229, " like ", "header"); $this->filter->MoveField(I12237, _MOVE_START); }function _ApplyCatFilters($prefix ='', $bodyType ='', $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); return $res; }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); $vData[I12238] ='100%'; }function TTTlI1l() {$res =false; if(parent::TTTlI1l()) {$res =$this->IlIllI1->TTTlI1l(); }return $res; }function TTTlI11(&$vData, &$aCustom) {$aCatSql =Array(); $aCatSql["join_to_alias"] =I12233; $this->IlIllI1->TTIT1lT("item_list", $aCatSql); $this->browser->InitSQL("ar.id, ar.public, ar.header, ar.announce, ". "DATE_FORMAT(ar.date,'".$this->cms->DFMT["db"]."') AS fdate" .$aCatSql["select"], Array('tables'=>Array(I12239=>'cms_photoalbum') +$aCatSql['tables'], 'joins'=>$aCatSql['joins']), I12240.$this->_ApplyFilters().$this->TTTlIl1(), I12229, "name", "ar.id desc", $aCatSql["order_replace"] );if(!empty($aCatSql['tables'])) {$this->browser->AddSQLJoinedTables($this->cms->Core, I12239, $aCatSql[I12241]); }$aCustom["fields"] += Array( "public"=>Array("action"=>"flagicon", I12242=>1, "id"=>"pub_id", "on"=>$this->moduleName."_list:public_on",I12243=>$this->moduleName."_list:public_off"), "cname"=>Array("action"=>"stripline", I12244=>35), "author"=>Array("action"=>"stripline", I12244=>35), "header"=>Array(I12245=>"stripline", I12244=>35), "announce"=>Array(I12245=>"stripline", I12244=>145), "action_edit"=>Array(I12245=>I12246, I12242=>I12229, "id"=>"edit_id", "on"=>$this->moduleName."_list:edit",I12243=>I12229), I12247=>Array(I12245=>I12246, I12242=>I12229, "id"=>"del_id", "on"=>$this->moduleName."_list:del",I12243=>I12229), );$aCustom[I12248] ="ar.id"; $aCustom["form_data"]["buttons"] =Array("add", I12230, I12249, "save"); $this->IlIllI1->TTTlI11($vData, $aCustom); parent::TTTlI11($vData, $aCustom); }function TTT11Tl(&$IILILII) {$IILILII[] ="published"; $IILILII[] ="notpublished"; $IILILII[] ="leg_yellow"; $IILILII[] =I12250; $IILILII[] ="leg_edit"; $IILILII[] ="leg_del"; parent::TTT11Tl($IILILII); }function TTTllTI(&$aCustom) {$flag =true; $I1LII1L =false; $cat =$this->IlIllI1->TTTllTI($aCustom); if($cat != -1) {if($this->id >0) {$this->SetBodyType("body_itemD"); $flag =false; $I1LII1L =true; }else {if($cat === 0) {$this->SetBodyType('body_urgent_cats'); $this->SetBodyType(I12251); $this->bodyType ='body_cats'; $flag =false; }else {if($this->id != -1) {$this->SetBodyType("body_items"); $this->SetBodyType('body_urgent_items'); }else {$this->SetBodyType("body_itemD"); $flag =false; $I1LII1L =true; }}}if($cat !== false) {if($flag && $this->module->GetOption(I12252)) {$this->SetBodyType('body_urgent_cats'); $this->SetBodyType(I12251); if ($this->bodyType == 'body_urgent_cats') {$this->bodyType ='body_cats'; }}if($I1LII1L && $this->module->GetOption("multicat_in_body_details")) {$this->SetBodyType(I12253); $this->SetBodyType(I12251); if ($this->bodyType == I12253) {$this->bodyType ='body_cats'; }}}}parent::TTTllTI($aCustom); }function TTTlllT(&$vData) {parent::TTTlllT($vData); }function TTTll1T(&$vData, &$aCustom) {$aDefault =Array(); $addSql =Array("select"=>", votes_rate, votes_count, rate_opt", "from"=>I12229, I12254=>I12229, "where"=>I12229, "group"=>I12229, "order"=>I12229); $IIlLIIL =Array(I12245=>"add_extention_sql", I12255=>0, "item_data"=>I12229, "data"=>&$addSql, "custom"=>&$aCustom); $this->TTT1lI1($IIlLIIL); foreach($this->IIllIL1 as $IIlL1L1 => $tmp) {$llIl1LL =false; $this->lIlLL11 =false; $IIlL1Ll =$this->TTITTT1($aCustom, $IIlL1L1); switch($IIlL1L1) {case I12251: case I12253: $IIlL1Ll["page_item_type"] =$IIlL1L1; $IIlL1Ll['show_urgent_elements'] =$this->cms->Core->getModOption('photoalbum_cat', 'show_urgent_elements'); if (in_array('ext_discussion', $this->IlIllI1->IILI1LI->GetOption('extensions'))) {$IIlL1Ll[I12256]['select'] =(isset($IIlL1Ll[I12256]['select']) ?$IIlL1Ll[I12256]['select'] :'') .I12257 .$this->IlIllI1->IILLL1l .'.disable_comments'; }$this->IlIllI1->TTTll1T($vData, $IIlL1Ll); if( isset($this->ext['ext_discussion']) && $this->ext['ext_discussion']->IsInstalled() && $this->IlIllI1->IILI1LI->issetOption('extensions') && !in_array(I12258, $this->IlIllI1->IILI1LI->GetOption('extensions')) ){$this->ext[I12258]->installed =false; $llIl1LL =true; }break; case "body_itemD": $IIlL1Ll["simple_set_fields"] =Array("header", I12259, "body"); $this->IlIllI1->TTTll1T($vData, $IIlL1Ll); $aCatSql =Array(); $this->IlIllI1->TTIT1lT("item_details", $aCatSql); $sql ="SELECT ar.*, ". "DATE_FORMAT(ar.date, '".$this->cms->DFMT[I12260]."') AS fdate ". "FROM cms_photoalbum AS ar ". "WHERE ar.id='".$this->id."'".$aCatSql[I12261].$this->_ApplyFilters(); $this->db->query($sql); $vData[I12255] =$this->id; break; case "body_items": case 'body_urgent_items': case "body_browse": $IIlL1Ll["simple_set_fields"] =Array(I12262, "source", I12259, "header", "body"); $this->TTTllll($vData, $IIlL1Ll); $aCatSql =Array(); $this->IlIllI1->TTIT1lT("item_list", $aCatSql); $this->browser->InitSQL("ar.id, ar.author, ar.source, ar.announce, ar.sublink, ". "ar.body, ar.header, ". "(LENGTH(ar.body) > 0) AS body_notempty, ". "date, `disable_comments`, DATE_FORMAT(ar.date, '".$this->cms->DFMT[I12260]."') AS fdate".$aCatSql[I12263], "FROM cms_photoalbum AS ar ".$aCatSql[I12254], I12240.$aCatSql[I12261].$this->_ApplyFilters('', $IIlL1L1 == 'body_urgent_items' ?$IIlL1L1 :'').$this->TTTlIl1(), I12229, $this->browser->TI1TTlT() );$this->browser->AddSQLJoinedTables($this->cms->Core, I12239, $aCatSql[I12264]); $IIlL1Ll["fields"]["detials"] =Array(I12245=>"callback", "object"=>&$this, I12265=>"_GetItemCB"); $this->lIlLL11 =true; if($IIlL1L1 != "body_browse"){ $IIlLIIL =Array(I12245=>"add_cat_extention_sql", I12255=>0, "item_data"=>&$IIlL1Ll); $this->TTT1lI1($IIlLIIL); }if(!$this->IlIllI1->TTTll1T($vData, $IIlL1Ll)) {$IIlL1Ll[I12266] ="body_empty"; }if ($this->IlIllI1->catId && $IIlL1L1 != 'body_browse' && $this->IlIllI1->IILI1LI->issetOption('extensions') && in_array(I12258, $this->IlIllI1->IILI1LI->GetOption('extensions')) ){$sql ="SELECT * FROM cms_photoalbum_cat WHERE id = " .intval($this->IlIllI1->catId); if ($record =$this->db->getRecord($sql)) {$this->module->PushPager($this->browser); $IIlLIIL =array ('action' => 'fill_front_data', 'data' => &$vData, 'custom' => &$IIlL1Ll[I12267]); $tmp =clone($this->IlIllI1->IILI1LI->Engine->ext[I12258]); unset($this->IlIllI1->IILI1LI->Engine->ext[I12258]); $this->IlIllI1->IILI1LI->Engine->TTT1lI1($IIlLIIL); $this->IlIllI1->IILI1LI->Engine->ext[I12258] =$tmp; foreach (array ('captcha_row' => 'EXTENSION_TWIST_PREVENTION_DISCUSSION_HTML_', 'captcha_script' => 'EXTENSION_TWIST_PREVENTION_DISCUSSION_SCRIPT_' )as $tmp => $newKey) {if (isset($vData[$tmp])) {$this->cms->Gui->addGlobalVars(array ($newKey .mb_strtoupper($this->IlIllI1->catModuleName) => $vData[$tmp])); }}$this->IlIllI1->IILI1LI->Engine->TTT1lTl($IIlL1L1, $record, $vData, $IIlL1Ll[I12267]); $this->module->PopPager($this->browser); }}break; }$this->lIlLL11 =false; parent::TTTll1T($vData, $IIlL1Ll); if($llIl1LL){ $this->ext[I12258]->installed =true; }}}function TTT1lTl($IIl1II1, &$record, &$vData, &$aData) {parent::TTT1lTl($IIl1II1, $record, $vData, $aData); switch($IIl1II1) {case I12268: $vData["item_link"] =$this->cms->Gui->get($this->moduleName."_list:itemD_item_link", $vData); $this->IlIllI1->TTT1lTl($IIl1II1, $record, $vData, $aData); $vData["top_link"] =$this->cms->TTITI1l("itemD", I12269, $vData); $vData["date"] =$this->cms->TTITI1l("itemD", "date", $record["fdate"]); if(!empty($record[I12262])) {$vData[I12262] =$this->cms->TTITI1l(I12270, I12262, $record); }if(!empty($record["source"])) {$vData["source"] =$this->cms->TTITI1l(I12270, "source", $record["source"]); }break; }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT ar.*, DATE_FORMAT(ar.date,'".$this->cms->DFMT[I12260]."') AS fdate, ". "IF(ar.public > 0, 'checked', '') AS public ". "FROM cms_photoalbum AS ar ". "WHERE ar.id='".$cId.I12271.$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData[I12259] =$this->cms->htmlchars($this->itemData[I12259]); $this->itemData["body"] =$this->cms->htmlchars($this->itemData["body"]); }}function _ActionDel($cId, $cModule) {$sql ="SELECT public, id_cat FROM cms_photoalbum WHERE id='".$cId.I12271; $this->db->query($sql); if($this->db->next_record()){ $this->IlIllI1->TTIT1ll($cId, $cModule, $this->db->Record["public"], $this->db->Record[I12272]); parent::_ActionDel($cId, $cModule); $err =$this->GetLastError(); if(empty($err["errno"])) {$this->IlIllI1->_ActionDel($cId, $cModule); }}}function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); if(empty($this->errno) && $this->appliedId >0) {$this->IlIllI1->TTTll11($cId, $cModule); }}function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); if(empty($this->errno)) {$this->IlIllI1->TTTl1lI($cId, $cModule); }}function _ActionPublish($cId, $cModule) {$this->IlIllI1->TTIT1ll($cId, $cModule); parent::_ActionPublish($cId, $cModule); $this->IlIllI1->_ActionPublish($cId, $cModule); }function TTT1Tl1($cType, $cModule, $condition ='') {$res =$this->IlIllI1->TTT1Tl1($cType, $cModule); if(!$res) {parent::TTT1Tl1($cType, $cModule, $condition); }}function TTT1IlI($aSql =Array(), $cId =0) {$announce =$this->cms->VarsPost[I12259]; $I1LIlII =$this->cms->VarsPost["header"]; $udate =DateTools::getCorrectUDate($this->cms->VarsPost["date"], $this->cms->DFMT[I12273]); $date =date($this->cms->DFMT["php"], $udate); $source =$this->cms->VarsPost["source"]; if(!empty($I1LIlII)) {$aSql =Array( $this->IIll1lL['date_created'] => DateTools::toMysqlDate($udate), "header"=>$I1LIlII, I12259=>$announce, I12274=>$this->cms->VarsPost[I12274], I12262=>$this->cms->VarsPost[I12262], "source"=>$this->cms->VarsPost["source"], "public"=>$this->cms->VarsPost["public"] );if(!$this->doMapping){ foreach(array(I12275, 'ext_img_popup', 'ext_img_small' )as $field){ if(isset($this->cms->VarsPost[$field])){ $aSql[$field] =$this->cms->VarsPost[$field]; }}}if(isset($this->cms->VarsPost["id_external"])) $aSql["id_external"] =$this->cms->VarsPost[I12276]; }$this->IlIllI1->TTT1IlI($aSql, $cId); $aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function _GetDetailsLinkCB(&$aItem, &$aData) {if(!empty($aItem[I12274])) {$aItem["details_link"] =1; }}function TIITIll(&$aItem, &$aData, $setPrefix =I12229) {$aItem["date"] =$aItem["fdate"]; $aItem["date"] =$this->cms->TTITI1l(I12277, "date", $aItem); if($aItem["body_notempty"]) {$aItem["more"] =$this->cms->TTITI1l(I12277, "more", $aItem); }}function _GetItemCB(&$aItem, &$aData) {$this->TIITIll($aItem, $aData); }function TIITIl1(&$IIL1lLI, $IIl1II1 =I12278) {$this->lIlLL11 =false; $II11L1L =" ar.urgent DESC, ar.".$this->module->GetOption("front_subitem_sort_col")." ".$this->module->GetOption("front_subitem_sort_dim"); $fields ="SELECT ar.id, ar.id_cat, ar.author, ar.source, ar.announce, ar.sublink, ar.body, ar.header, ". "(LENGTH(ar.body) > 0) AS body_notempty, ". "DATE_FORMAT(ar.date, '".$this->cms->DFMT[I12260]."') AS fdate, ar.urgent "; foreach($this->options["item_pictures"] as $fieldName) {if(!empty($fieldName) && $fieldName != I12279 && $fieldName != -222222){ $fields .= ", ar.ext_".$fieldName; }}$fields .= " FROM cms_photoalbum AS ar WHERE "; $this->_forceHideFutureItems =true; if($this->I1LIIl1 >0) {$sql =$fields."ar.id_cat='__id_cat__'".$this->_ApplyFilters()." ORDER BY ".$II11L1L.I12280.$this->I1LIIl1; }else {$sql =$fields."ar.id_cat IN('".implode("','", $IIL1lLI)."')".$this->_ApplyFilters(I12278, $IIl1II1, false)." ORDER BY ar.id_cat ASC, ".$II11L1L; }unset($this->_forceHideFutureItems); $this->I1LIILI =$this->IlIllI1->TTIITTI($sql, $IIL1lLI, I12281); $this->lIlLL11 =true; }function _DrawSubItemsCB(&$aItem, &$aData) {$I1LIlIl =$this->I1LIILI[$aItem[I12255]]; $aItem["item_list"] =I12229; if(is_array($I1LIlIl)) {$k =0; $numRows =sizeof($I1LIlIl); $vData["simple_prefix"] ="subitem_"; $I1LIlIL =$this->options["name_field_name"]; $this->options[I12282] ="header"; foreach($I1LIlIl as $index=>$aSubItem) {$k++; $aTmp["active_item_type"] ="body_items"; $aTmp["cat_id"] =$aItem[I12255]; $aTmp[I12283] =$aItem["sublink"]; $this->_GetNavDataCB($aSubItem, $aTmp); $aSubItem += $this->IIllllL; $IIlLIIL =Array(I12245=>"_GetPicturesCB", "data"=> $_data =array(&$aSubItem, &$vData)); $this->TTT1lI1($IIlLIIL, array(I12235)); $aSubItem["header"] =$this->cms->TTITI1l(I12284, "header", $aSubItem); $aSubItem[I12259] =$this->cms->TTITI1l(I12284, I12259, $aSubItem); $IIlLIIL =Array(I12245=>"add_subitem_data", I12255=>I12229, "item_data"=>&$aSubItem); $this->TTT1lI1($IIlLIIL); $this->TIITIll($aSubItem, $aData, "subitem_"); $aItem[I12285] .= $this->cms->TTITI1l(I12284, "row", $aSubItem); if($k >0 && $k != $numRows) {if((($k %$this->I1LIILL) == 0)) {$aItem[I12285] .= $this->cms->TTITI1l(I12284, "Vsplitter", $aItem); }elseif($k >1) {$aItem[I12285] .= $this->cms->TTITI1l(I12284, "Hsplitter", $aItem); }if($this->I1LIILl && $k%$this->I1LIILl == 0 ){$aItem[I12285] .= $this->cms->TTITI1l(I12284, "nSplitter", I12229); }}}$this->options[I12282] =$I1LIlIL; $aItem[I12285] =$this->cms->TTITI1l(I12284, I12286, $aItem); }}function TTTlIT1(&$aCustom, $cType ="small", $IIlLI11 =I12229, $IIlLlII ="_small") {$this->IlIllI1->TTTlITl($aCustom, $cType, $IIlLI11, $IIlLlII, true); $html =parent::TTTlIT1($aCustom, $cType, $IIlLI11, $IIlLlII); $this->IlIllI1->TTTlITl($aCustom, $cType, $IIlLI11, $IIlLlII, false); return $html; }function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {$I1LIlI1 =$this->module->GetOption("small_number_items"); $I1LIllI =$this->module->GetOption("small_category_ids"); $I1LIlll =$this->module->GetOption("small_number_categories"); $mode ="no_cats"; if( $this->cms->Core->IsInstalled($this->IlIllI1->catModuleName) && $this->module->issetAndTrueOption('use_categories') ){$mode ="cats_ids"; $I1LIllL =is_array($I1LIllI); if(!$I1LIllL || ($I1LIllL && sizeof($I1LIllI) == 0)) {if(empty($I1LIllI)) {if(empty($I1LIlll)) {$mode ="no_cats"; }else {$mode =I12287; }}else {$I1LIllI =Array($I1LIllI); }}}$I1LIll1 =" "; if(!empty($I1LIlI1)) {$I1LIll1 =" LIMIT 0,".$I1LIlI1; }$aDefault =Array(); $aDefault["simple_set_fields"] =Array(I12259); $aCustom += $aDefault; $aDefault["list_data"][I12288] ="small_"; $aCustom["list_data"] += $aDefault["list_data"]; $I1LIlLI =" ar.".$this->module->GetOption("small_items_sort_col")." ".$this->module->GetOption("small_items_sort_dim"); if ($this->I1LII1I && ($mode == 'cats_num' || $mode == 'cats_ids')) {$I1LIlLl =in_array(I12289, $this->IlIllI1->IILI1LI->GetAOption('show_urgent_elements')); $this->TTITTTI('push'); $sql ="SELECT c.id AS cat_id, c.sublink AS cat_sublink, c.name AS cat_name, c.announce AS cat_announce, c.urgent FROM cms_photoalbum_cat AS c WHERE 1".$this->_ApplyCatFilters('c', I12278, !$I1LIlLl); $I1LIlLL =I12290 .($I1LIlLl ?'c.urgent DESC, ' :I12278) ."c.".$this->module->GetOption("small_categories_sort_col")." ".$this->module->GetOption("small_categories_sort_dim"); if($mode == I12287) {$sql .= $I1LIlLL.I12280.$I1LIlll; }else {$sql .= " AND id IN('".implode("','", $I1LIllI)."')".$I1LIlLL; }$this->TTITTTI('pop'); $this->db->query($sql); $aCatIds =Array(); while($this->db->next_record()) {$aCatIds[] =$this->db->Record[I12291]; $this->II1lllI["aCats"][$this->db->Record[I12291]] =$this->db->Record; }}$I1LIlL1 =in_array(I12289, $this->module->GetAOption('show_urgent_elements')); if($mode == "no_cats") {$aCatSql =Array(); $this->IlIllI1->TTIT1lT('small_list', $aCatSql); }$IILL1ll =$this->options[I12292]; $this->options[I12292] =false; $this->_forceHideFutureItems =true; switch($mode) {case "no_cats": $this->options['use_id_page'] =$IILL1ll; $this->browser->InitSQL("ar.id, ar.header, ar.announce, ar.source, ar.author, ar.sublink, ar.urgent, ar.disable_comments " .$aCustom["sql_addon"][I12263] .", date_format(ar.date,'".$this->cms->DFMT[I12260]."') as fdate ".$aCatSql[I12263], "FROM cms_photoalbum AS ar ".$aCatSql[I12254], I12240.$this->_ApplyFilters(I12278, I12278, !$I1LIlL1).$aCatSql[I12261], I12229, $I1LIlLI );$this->browser->SetForceRules('ORDER BY ' .$I1LIlLI, $I1LIll1); $this->browser->AddSQLJoinedTables($this->cms->Core, I12239, $aCatSql[I12264]); if ($I1LIlL1) {$this->browser->TI1TII1(array ('ar.urgent DESC')); }break; case I12287: case I12293: $aItems =Array(); if(sizeof($aCatIds) >0) {$ILLILlL ="SELECT ar.id, ar.id_cat, c.id_page, ar.header, ar.announce, ar.source, ar.author, ar.sublink, ar.disable_comments, ". "c.sublink AS cat_sublink" .$aCustom["sql_addon"][I12263] .",  date_format(ar.date,'".$this->cms->DFMT[I12260].I12294; foreach($this->options["item_pictures"] as $fieldName) {if(!empty($fieldName) && $fieldName != I12279 && $fieldName != -222222){ $ILLILlL .= ", ar.ext_".$fieldName; }}if ($I1LIlL1) {$I1LIlLI =' ar.urgent DESC, ' .$I1LIlLI; }foreach($aCatIds as $catId) {$sql =$ILLILlL." FROM cms_photoalbum AS ar LEFT JOIN cms_photoalbum_cat c ON c.id=ar.id_cat WHERE id_cat=".$catId.I12295.$this->_ApplyFilters(I12278, I12278, !$I1LIlL1)." ORDER by".$I1LIlLI.$I1LIll1; $this->db->query($sql); while($this->db->next_record()) {$aItems[] =$this->db->Record +$this->II1lllI["aCats"][$this->db->Record[I12272]]; }}}require_once $GLOBALS['CLASSES_PATH'] .'CMS_IteratorArray.php'; $I1LIl1I =true; $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray($aItems); $this->browser->InitSQL(I12255, "FROM cms_photoalbum ", I12240 );$this->browser->SetForceRules(I12229, I12295); break; }unset($this->_forceHideFutureItems); $this->options[I12292] =$IILL1ll; if($this->cms->Core->IsInstalled("photoalbum_cat") && $this->module->IssetAndTrueOption("use_categories")) {$aCustom["fields"] += Array("cat_detials" => Array(I12245=>I12296, "object"=>&$this, I12265=>"_GetSmallCatDetailsCB")); $this->II1lllI["prevCatId"] =-1; }$aCustom["fields"] += Array(I12297 => Array(I12245=>I12296, "object"=>&$this, I12265=>"_GetSmallDetailsCB")); parent::TTTll1I($vRes, $aCustom, $cType, $IIlLlII); if(isset($I1LIl1I)) {$this->db =new DB_si; }}function _GetSmallDetailsCB(&$aItem, &$aData) {$aItem["date"] =$aItem["fdate"]; $aItem[I12298] =$this->cms->TTITI1l("small", I12298, $aItem); $aItem["front_link"] =$aData["front_link"]; $aItem["more"] =$this->cms->TTITI1l(I12299, "header", $aItem); $aItem["more"] =$this->cms->TTITI1l(I12299, "more", $aItem); }function _GetSmallCatDetailsCB(&$aItem, &$aData) {$this->II1lllI["prevCatId"] =$aItem[I12272]; $tmp =Array(I12300=>I12251); $tmp2 =Array(I12255=>$aItem[I12272], "sublink"=>$aItem[I12283]); $this->_GetNavDataCB($tmp2, $tmp); $aItem["front_link"] =$aData["front_link"]; $aItem["cat_nav_data"] =$tmp2[I12301]; $aItem["cat_detail"] =$this->cms->TTITI1l(I12299, "cat_detail", $aItem); }function TTT11IT($llIl1L1) {$navData =parent::TTT11IT($llIl1L1); $navData += $this->IlIllI1->TTT11IT($llIl1L1); return $navData; }function correctStopArgNames($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues"){ return $this->IlIllI1->correctStopArgNames($cData, $IIL1lL1, $res, $aData, $IIL1l1I); }function TTT1II1(&$db, &$aParams) {$aVars =parent::TTT1II1($db, $aParams) +$this->IlIllI1->TTT1II1($db, $aParams); return $aVars; }function TTT1TTI(&$IIl1ll1, $prefix) {if ($this->I1LII1I) {$IIl1ll1['select'] .= I12302; }}function TTT1TTl(&$record) {if ($this->I1LII1I) {$this->IlIllI1->catId =$record['id_cat']; }}function TTT1T1T(&$aIds, $cModule){ if($this->I1LII1I && $this->filter->issetField('flt_alb_cat_id')){ $this->filter->UpdateFieldDBName('flt_alb_cat_id', 'p.id_cat'); }parent::TTT1T1T($aIds, $cModule); if($this->I1LII1I && $this->filter->issetField(I12303)){ $this->filter->UpdateFieldDBName(I12303, 'ar.id_cat'); }}function setImagesWatermark($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues"){ switch($IIL1l1I){ case "getvalue": $res =$this->module->GetOption("static_watermark"); break; case I12230: if($this->module->GetOption(I12304) != $cData['value']){ require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_file_system.php"); $path =$GLOBALS["ROOT_PATH"].$GLOBALS["CUSTOM_PICTURES_HTTP_PATH"].$this->moduleName."/generated/"; $list =getDirFileList($path,"*_swt*"); foreach($list as $file){ @unlink($path.$file); }}break; }return true; }}?>