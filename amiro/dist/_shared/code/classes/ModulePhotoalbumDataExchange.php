<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       22616 xkqwwwssulkpuwggzztpmnkzngtzgtpilymkxkrgmkkgxnkgyinqilyzppgizlzrngpypnir
 */ ?><?php foreach(array(12310=>'WID|GOHtHZJYuI',12311=>'IHS|MS',12312=>'|JHWZJ~|ZSIMn~tQIGJZtQD~JZnP~IHSuJQD~',12313=>'SZtZ|QxWOZnPQ|WZt|IHSuJQ',12314=>"wzTqphRmqd|hN",12315=>"GrQGZrQ|MIZPQD",12316=>"|grHWQDDmtQID",12317=>"",12318=>"MS|GZPQ|IHSuJQ|nZIQ",12319=>"SQDtMnZtMHn|WZt|MS",12320=>'nZIQ|fMQJS|nZIQ',12321=>"WHIIHn",12322=>"OtIJ|ZrQZ|fMQJSD",12323=>"WZt|fMQJSD|IZG",12324=>"GrHWQDD|MtQID",12325=>"MS|QxtQrnZJ",12326=>"MS",12327=>"ZSS",12328=>'GMWturQ',12329=>'Qxt|MIP|DIZJJ',12330=>"fHrWQ|HvQrCrMtQ",12331=>'MS|QxtQrnZJ',12332=>"ZGGJB",12333=>"'",12334=>"PQt|WZt|MS",12335=>"~",12336=>"WZt|MIZPQ",12337=>"MIZPQ?nHt?fHunS",12338=>"DKMG|fMQJS",12339=>"GrMWQ|SY|fMQJS",12340=>"QSMt",12341=>"IZG",12342=>"ZJJHC|rZtMnPD",12343=>"DHrt|YB|rZtMnPD",12344=>"'?HrSQr?YB?nZIQ",12345=>"MS|WZt",12346=>"MIGHrt|IHSuJQ|fHrI",12347=>"|DuYfHrI%MIGHrt|IHSuJQ|fHrI") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModulePhotoalbumDataExchange extends CMS_DataExchangeModule {public $I11lLIl; public $I11lLlI; public $I11lLll; public $I11lLlL; public $llIl11I; public $llIl11l; public $I11l1l1; public $I11l1LI; public $I11l11I; public $IlIllI1; public $modId ='photoalbum'; public $llIl1Ll ='photoalbum_cat'; public $IIl11Il =I12310; public $llIl11L ='cms_photoalbum_cat'; protected $doMapping =TRUE; function ModulePhotoalbumDataExchange(&$cms, &$db, &$cModule) {parent::CMS_DataExchangeModule($cms, $db, $cModule); if(!empty($this->cms->Vars['mod_id'])){ $this->modId =str_replace('_data_exchange', '', $this->cms->Vars[I12311]); $this->llIl1Ll =$this->modId.'_cat'; $this->IIl11Il ='cms_'.$this->modId; $this->llIl11L ='cms_'.$this->llIl1Ll; if(substr($this->modId, 0, 5) == 'inst_'){ $langFile =$this->cms->Gui->ParseLangFile(I12312.$this->modId.'_data_exchange_messages.lng'); $this->cms->AddMessages($langFile); $this->TTITTI1( AMI::getResourceModel($this->llIl1Ll .'/table') ->hasField('name') );}AMI_Registry::set(I12313, $this->llIl1Ll); }if($this->cms->Core->IsInstalled($this->llIl1Ll)) {$this->cms->Gui->AddGlobalVars(Array("CATEGORIES_ON"=>"1")); $this->IlIllI1 =new CMS_CategoriesFunctions($this->cms, $this, $this->llIl1Ll); }else {$this->cms->Gui->AddGlobalVars(Array(I12314=>"0")); $this->IlIllI1 =new CMS_CategoriesFunctionsStub($this->cms, $this, $this->llIl1Ll); }$this->II1lII1["callbacks"] += Array( "prepare_categories"=>"_PrepareCategories", I12315=>"_PrepareImages", "process_categories"=>"_ProcessCategories", "process_items"=>I12316, "object_is_category"=>"_ObjectIsCategory" );$this->I11lLlI =Array(); $this->I11lLll =Array(); $this->I11lLlL =Array(); $this->llIl11I =""; $this->llIl11l =""; $this->_useNumberGtd =false; $this->_useManufacturers =false; $this->_numberGtdField =I12317; $this->_manufacturersField =I12317; $this->I11l1l1 =20; $this->I11l1LI =Array(); $this->I11l11I =true; }function _Init($IIll1l1 =Array(), $IIll1LI =I12317, $IIll1Ll =I12317, $aOptions =Array()) {$IIIIL11[I12318] =$this->modId; $IIIIL11["use_id_page"] =true; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->I11lLIl =0; if(isset($this->cms->Vars["cat_id"])) {$this->I11lLIl =intval($this->cms->Vars["cat_id"]); }$this->II1lII1 += Array("photoalbum_params"=>Array(I12319=>$this->I11lLIl, "cattype"=>(!empty($this->cms->VarsGet["cattype"]) ?$this->cms->VarsGet["cattype"] :I12317))); }function _InitAdmin() {parent::_InitAdmin(); $this->llIl11I ="photoalbum"; }function _InitImport(&$aParams){ if(!$this->doMapping){ $this->options[I12320] ='header'; $this->options['cat_name_field_name'] ='header'; }$res =true; switch($aParams["action"]) {case I12321: $res =parent::_InitImport($aParams); $this->II1lllI["vars_post"] =$this->cms->VarsPost; $this->II1lllI["vars"] =$this->cms->Vars; $aTmp =$this->cms->Core->GetProperty("html_area_fields"); $this->I11l1LI =array_flip($aTmp); $aTmp[] ="id_external"; $this->cms->Core->SetProperty(I12322, $aTmp); unset($aTmp); break; case "prepare_categories": $tmp =&$this->cms->Core->GetModule($this->llIl1Ll); if(!$tmp->IsInstalled()) {$res =false; $this->TTII1lT($tmp, "init", "photoalbum_cat_init", I12317, true); }break; case I12315: break; case "process_categories": $res =$this->TTII1IT($this->llIl1Ll, I12323); break; case "process_items": $res =$this->TTII1IT($this->modId, "item_fields_map"); break; }return $res; }function _FinalImport(&$aParams) {switch($aParams["action"]) {case I12321: parent::_FinalImport($aParams); break; case "prepare_categories": break; case I12315: break; case I12324: case "process_categories": }return true; }function _ProcessCategories(&$aData) {set_time_limit($this->I11l1l1); $this->TTII11T($this->II1llIl, $aData); if(isset($this->I11lLlL[$this->cms->VarsPost["id_external"]]) && $this->I11lLlL[$this->cms->VarsPost["id_external"]] >0) {$action ="none"; $this->I11lLlL[$this->cms->VarsPost[I12325]]--; }else {if (isset($this->I11lLll[$this->cms->VarsPost["id"]]) && $this->cms->Core->IsInstalled("ext_rating")) {$this->TIll1lI(); }$this->TTII1Il("apply", $this->cms->VarsPost["id"]); $action =(isset($this->I11lLll[$this->cms->VarsPost[I12326]])) ?"add" :"apply"; }$this->TTII1lT($this->II1llIL, $action, I12317, $this->cms->VarsPost[I12325]); }function _ProcessItems(&$aData) {set_time_limit($this->I11l1l1); $this->TTII11T($this->II1llIl, $aData, true, Array(I12325=>$aData["ID_EXTERNAL"])); $action =($this->cms->VarsPost[I12326] >0) ?"apply" :I12327; if(isset($this->II1lIl1[$action])){ $llIl111 =explode('|', $aData["ID_EXTERNAL"]); if (isset($llIl111[1]) && isset($this->I11lLlI[$llIl111[1]])) {$catId =$this->I11lLlI[$llIl111[1]]; if (isset($this->I11lLll[$catId])) {$this->cms->VarsPost["cat_id"] =$catId; }}if ($this->cms->Core->IsInstalled("ext_rating")) {$this->TIll1lI(); }foreach( array( I12328 => 'ext_img', 'popup_picture' => 'ext_img_popup', 'small_picture' => I12329 )as $from => $to ){if(isset($this->cms->VarsPost[$from])){ $this->cms->VarsPost[$to] =$this->cms->VarsPost[$from]; }}$this->TTII1Il($action, $this->cms->VarsPost[I12326]); }else {$action ="none"; }$this->TTII1lT($this->II1llIL, $action, I12317, $this->cms->VarsPost[I12325]); }function _PrepareImages($aData) {set_time_limit($this->I11l1l1); if(isset($aData["tmp_file_name"])) {$source =$aData["tmp_file_name"]; }else {$source =$aData["file_name"]; }$I11LlL1 =$GLOBALS["CUSTOM_PICTURES_PATH"].$this->llIl11I."/"; if(isset($aData["store_name"])) $I11LlL1 .= basename($aData["store_name"]); else $I11LlL1 .= basename($aData["file_name"]); if(!isset($aData[I12330])) $aData[I12330] =$this->I11l11I; if(!file_exists($I11LlL1) || $aData[I12330]) if(file_exists($this->importPath.$source) && AMI_Lib_FS::validatePath($this->importPath.$source)){ $res =$this->cms->TTITlTl($this->importPath.$source, $I11LlL1); }}function _PrepareCategories($aData) {set_time_limit($this->I11l1l1); $catId =$this->TIIIlll($aData[I12325]); if($catId == 0) {if(isset($this->II1lIl1[I12327])) {$llILIII =$this->doMapping ?'name' :'header'; $aSql =array( 'public' => 0, 'id_external' => $aData[I12331], $llILIII => $aData[I12331], 'lang' => $this->langData );$sql =$this->db->GenInsertSQL($this->llIl11L, $aSql); if($this->db->query($sql)) {$newId =$this->db->lastInsertId(); $this->I11lLlI[$aData[I12325]] =$newId; $this->I11lLll[$newId] =true; $sql ="UPDATE " .$this->llIl11L ." SET position=id WHERE id='".$newId."'"; $this->db->query($sql); }}else {if(isset($this->I11lLlL[$aData[I12325]])) {$this->I11lLlL[$aData[I12325]]++; }else {$this->I11lLlL[$aData[I12325]] =1; }}}else {if(isset($this->II1lIl1[I12332])) {}else {if(isset($this->I11lLlL[$aData[I12325]])) {$this->I11lLlL[$aData[I12325]]++; }else {$this->I11lLlL[$aData[I12325]] =1; }}}return true; }function _ObjectIsCategory($II1LI1I) {return ($this->TIIIlll($II1LI1I) >0); }function TIIIlll($II1LI1I) {$res =0; if(isset($this->I11lLlI[$II1LI1I])) {$res =$this->I11lLlI[$II1LI1I]; }else if(empty($II1LI1I)) {$res =$this->cms->VarsGet["cat_id"]; }else {$sql ="SELECT id FROM " .$this->llIl11L ." WHERE id_external='".addslashes($II1LI1I)."' AND lang='".$this->langData.I12333; $this->db->query($sql); if($this->db->next_record()) {$res =$this->db->Record[I12326]; $this->I11lLlI[$II1LI1I] =$res; }}return $res; }function TIIIl1T($II1LI1I, $tableName) {$res =0; if($II1LI1I != I12317) {$sql ="SELECT id FROM ".$tableName." WHERE id_external='".$II1LI1I."' AND lang='".$this->langData.I12333; $this->db->query($sql); if($this->db->next_record()) {$res =$this->db->Record[I12326]; }}return $res; }function TTII11l(&$aMap, $fieldName, &$fieldValue, &$IIll1lL, $params =Array()) {$II1L1IL =true; switch($aMap[$fieldName]["operation"]) {case I12334: $IIll1lL[I12326] =$fieldValue; case "get_parent_cat_id": $fieldValue =$this->TIIIlll($fieldValue); break; case "get_item_id": $IIll1lL[I12325] =$fieldValue; $fieldValue =$this->TIIIl1T($fieldValue, $this->IIl11Il); break; case "image": if(file_exists($GLOBALS["CUSTOM_PICTURES_PATH"].$this->llIl11I.I12335.$fieldValue)) {$fieldValue =$GLOBALS["CUSTOM_PICTURES_HTTP_PATH"].$this->llIl11I.I12335.$fieldValue; $this->TTII1lT($this->II1llIL, I12327, "images", $fieldValue); }else {$this->II1llIL->Engine->SetLastError(1, "image not found"); $this->TTII1lT($this->II1llIL, I12327, "images", $fieldValue); $this->II1llIL->Engine->SetLastError(); $fieldValue =I12317; }break; case I12336: if(!empty($fieldValue)){ $I11LLIl =!empty($this->llIl11l) ?I12335 :I12317; if(file_exists($GLOBALS["CUSTOM_PICTURES_PATH"].$this->llIl11l.$I11LLIl.$fieldValue) && !is_dir($GLOBALS["CUSTOM_PICTURES_PATH"].$this->llIl11l.$I11LLIl.$fieldValue)) {$fieldValue =$GLOBALS["CUSTOM_PICTURES_HTTP_PATH"].$this->llIl11l.$I11LLIl.$fieldValue; $this->TTII1lT($this->II1llIL, I12327, "cat_images", $fieldValue); }else {$this->II1llIL->Engine->SetLastError(1, I12337); $this->TTII1lT($this->II1llIL, I12327, "cat_images", $fieldValue); $this->II1llIL->Engine->SetLastError(); $fieldValue =I12317; }}break; case "get_cat_fields": $this->II1llIL->Engine->ProcessAction($a ="edit", $IIll1lL[I12326]); $I11LLIL =Array(); $itemData =$this->II1llIL->Engine->itemData; foreach($IIll1lL as $key=>$value) if(!isset($itemData[$key]) && isset($aMap[$fieldName]["new_fields"][$key])) $itemData[$key] =$IIll1lL[$key]; foreach($itemData as $key=>$value) {if(isset($aMap[$fieldName]["map_value_db_to_form"][$key][$value])) {$value =$aMap[$fieldName]["map_value_db_to_form"][$key][$value]; }if(isset($aMap[$fieldName]["map_db_to_form"][$key])) {$key =$aMap[$fieldName]["map_db_to_form"][$key]; }if(!is_numeric($key) && !isset($aMap[$fieldName]["new_fields"][$key]) && !isset($aMap[$fieldName][I12338][$key])) {if(preg_match('/^'.$aMap[$fieldName]["price_db_field"].'(\d+)$/si', $key, $matches)){ $prices =$this->oEshop->TT11TlT($value); $I11LLIL[$aMap[$fieldName]["price_db_field"].$matches[1]] =$prices[$aMap[$fieldName][I12339]]; $I11LLIL[$aMap[$fieldName]["currency_db_field"].$matches[1]] =$prices[$aMap[$fieldName]["currency_db_field"]]; }else{ if(isset($this->I11l1LI[$key])) {$value =unhtmlentities($value); }$I11LLIL[$key] =$value; }}else if(isset($aMap[$fieldName]["new_fields"][$key])) $I11LLIL[$key] =$IIll1lL[$key]; }$IIll1lL =$I11LLIL; $II1L1IL =false; break; case "get_item_fields": $this->II1llIL->Engine->ProcessAction($a =I12340, $IIll1lL[I12326]); $I11LLIL =Array(); foreach($this->II1llIL->Engine->itemData as $key=>$value) {if(!is_numeric($key)) {if(isset($aMap[$fieldName][I12338][$key])) {continue; }if(isset($aMap[$fieldName]["map_db_to_form"][$key])) {$key =$aMap[$fieldName]["map_db_to_form"][$key]; }if(isset($aMap[$fieldName]["map_value_db_to_form"][$key][$value])) {$value =$aMap[$fieldName]["map_value_db_to_form"][$key][$value]; }if(isset($this->I11l1LI[$key])) {$value =unhtmlentities($value); }$I11LLIL[$key] =$value; }}$aFields =$IIll1lL; foreach($aMap[$fieldName][I12341] as $IL1lIL1=>$I11LLLl) {if(isset($aFields[$IL1lIL1])) {$aFields[$I11LLLl] =$aFields[$IL1lIL1]; }else {$aFields[$I11LLLl] =$I11LLIL[$IL1lIL1]; }$aFields["_".$IL1lIL1] =$I11LLIL[$IL1lIL1]; }if(is_array($fieldValue)) {$I11LLLL =$aMap[$fieldName]["price_field"]; $aFields[$I11LLLL] =$fieldValue; for($i=0;$i<$this->II1llIL->Engine->oEshop->numPrices;$i++) {$numPrice =$this->II1llIL->Engine->oEshop->priceFields[$i]; $I11LLL1 =$aMap[$fieldName][I12339].$numPrice; if(isset($I11LLIL[$I11LLL1])) {$aFields[$I11LLLL][$numPrice][$I11LLL1] =$I11LLIL[$I11LLL1]; }}$I11LL1I =$this->TTII11T($this->II1llIl, $aFields, false); $IIll1lL += $I11LL1I; }$IIll1lL += $I11LLIL; $II1L1IL =false; break; default: $II1L1IL =parent::TTII11l($aMap, $fieldName, $fieldValue, $IIll1lL, $params); }return $II1L1IL; }function TIll1lI() {if (intval($this->cms->Core->GetModOption("ext_rating", "allow_ratings"))) {$this->cms->VarsPost[I12342] =1; }if (intval($this->cms->Core->GetModOption("ext_rating", "display_ratings"))) {$this->cms->VarsPost["display_ratings"] =1; }if (intval($this->cms->Core->GetModOption("ext_rating", I12343))) {$this->cms->VarsPost[I12343] =1; }if (intval($this->cms->Core->GetModOption("ext_rating", "display_votes"))) {$this->cms->VarsPost["display_votes"] =1; }}function TTTlI1I(&$vData) {parent::TTTlI1I($vData); $sql ="select id, name from cms_photoalbum_cat where lang='".$this->langData.I12344; $this->db->query($sql); while($this->db->next_record()){ $vData["categories_list"] .= "<option value=\"".$this->db->Record[I12326]."\">".$this->cms->stripLine($this->db->Record["name"], 50, true); }$vData[I12345] =0; $this->TTT11lT($vData); $this->IlIllI1->TTIT1I1($vData); $vData[I12346] .= $this->cms->Gui->get($this->moduleName.I12347, $vData); }function TTTlI11(&$vData, &$aCustom) {parent::TTTlI11($vData, $aCustom); }}