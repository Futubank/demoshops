<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       23689 xkqwmsumtgrxnqxqwpkzsykmwusywwttxmurzlsxqkgziqimkwkxsuwxpqgiwukslxyppnir
 */ ?><?php foreach(array(12348=>'JZnP|SZtZ',12349=>'wid|mnDtZJJZYJQgJuPMn`GOG',12350=>"MnDtZJJ",12351=>"unMnDtZJJ",12352=>'SZtQfrHI',12353=>'tQxt',12354=>'?JMKQ?',12355=>'fJt|MD|MnDtZJJQS',12356=>'MWHn|MnDtZJJQS|Hn',12357=>'MWHn|MnDtZJJQS|Hff',12358=>'=',12359=>'MD|MnDtZJJQS',12360=>"MS!?GJuPMn|MS!?vQrDMHn!?MD|MnDtZJJQS!?ZGM|vQrDMHn!?IHSuJQ|tBGQ!?HrMP|OQZSQr!?GJuPMn|IHSuJQ!?MnDtZJJQS|ZD!?MD|WHGMQS?",12361=>"nZIQ",12362=>"DtrMGJMnQ",12363=>"HYLQWt",12364=>"MD|MnDtZJJQS",12365=>"vZJuQ",12366=>"|JMDt%MD|MnDtZJJQS|Hn",12367=>"|JMDt%MD|MnDtZJJQS|Hff",12368=>"MD|WHGMQS",12369=>"Hn",12370=>"ZWtMHn",12371=>"|JMDt%QSMt",12372=>"|JMDt%MWHnD|QSMt|MnDtZJJ",12373=>"ZWtMHn|MnDtZJJ",12374=>"MnDtZJJ|MS",12375=>"|JMDt%MnDtZJJ",12376=>"Hff",12377=>"ZWtMHn|unMnDtZJJ",12378=>"unMnDtZJJ|MS",12379=>"|JMDt%unMnDtZJJ",12380=>"|JMDt%MWHn|nHnQ",12381=>"JQP|BQJJHC",12382=>"JQP|MnDtZJJQS",12383=>"JQP|nHtMnDtZJJQS",12384=>"JQP|MnDtZJJ",12385=>"JQP|unMnDtZJJ",12386=>"fHrI|OQZSQr",12387=>'MnDtZJJMnP',12388=>'MS',12389=>'HrMP|OQZSQr',12390=>'WHnfMP',12391=>'SMDtr|GZtO',12392=>'DEJ|MnDtZJJ',12393=>'DEJ|unMnDtZJJ',12394=>"'{?zNs?MD|MnDtZJJQS=0",12395=>'DtZtuD|SQJQtQS',12396=>"dqjqwT?GJuPMn|MS!?vQrDMHn!?MD|MnDtZJJQS?FRhi?WID|GJuPMnD?coqRq?GJuPMn|MS?Mn?}'",12397=>"'{",12398=>'GJuPMn|MS',12399=>'IHSuJQ|tBGQ',12400=>'GJuPMn',12401=>'DtZtuD|uGSZtQS',12402=>'QrrHrD',12403=>'',12404=>"'",12405=>"IHSuJQ|JMnK",12406=>'IHSuJQ',12407=>'OQZSQr|',12408=>'ZSIMn|GZPQ|OQZSQr',12409=>'ZSIMn',12410=>'MD|WHGMQS',12411=>'MnDtZJJQS',12412=>'HGtMHnD',12413=>'~ruJQD`GOG',12414=>"UgszTq?WID|GJuPMnD?dqT?GJuPMn|IHSuJQ='",12415=>"'!?MD|MnDtZJJQS=1!?MnDtZJJQS|ZD='",12416=>'GJuPMnD|WHunt',12417=>'GJuPMn|IHSuJQ',12418=>'MnDtZJJ|ZD',12419=>'WHGB|fMJQD',12420=>'DtZtuD|MnDtZJJQS',12421=>'DtZtuD|nHt|MnDtZJJQS',12422=>'DtZtuD|ZJrQZSB|MnDtZJJQS',12423=>'ZSIMn|IQnu|WZGtMHn',12424=>'DtZrt|SMDZYJQ',12425=>'~HGtMHnD`GOG',12426=>"UgszTq?WID|GJuPMnD?dqT?GJuPMn|IHSuJQ=0!?MD|MnDtZJJQS=0!?MnDtZJJQS|ZD=''!?MD|fMrDt|run=1!?MD|WHGMQS=0?coqRq?MS='",12427=>'DtZtuD|unMnDtZJJQS',12428=>'DtZtuD|ZJrQZSB|nHt|MnDtZJJQS',12429=>'MnDtZJJQS|ZD',12430=>'DtZtuD|MD|nHt|MnDtZJJQS',12431=>'rQS',12432=>'ZWtMHn|MnDtZJJ',12433=>'ZWtMHn|unMnDtZJJ',12434=>'jZBHutyJHWK',12435=>'QnuI|HnJB',12436=>'1',12437=>"ZGGJB",12438=>'vZJuQ') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModulePluginsWizard extends CMS_ActModule {public $plugin; function ModulePluginsWizard(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {$IIIIL11[I12348] =false; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); require_once $GLOBALS['CLASSES_PATH'] .I12349; $this->plugin =new CMS_InstallablePlugin($this->cms); }function TTTlITT($IIIL11l, $cId, $cModule ="") {if(!sizeof($this->cms->VarsGet) && !sizeof($this->cms->VarsPost)) {$IIIL11l ="check"; }switch($IIIL11l) {case "check": $this->TIll1II($cId, $cModule); $this->redirect =false; break; case I12350: $this->TIll1Il($cId, $cModule); $this->redirect =false; break; case I12351: $this->TIll1I1($cId, $cModule); $this->redirect =false; break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function _InitAdmin(){ parent::_InitAdmin(); if($this->filter->issetField(I12352)){ $this->filter->TITI1l1(I12352); }if($this->filter->issetField('dateto')){ $this->filter->TITI1l1('dateto'); }$this->filter->IL11l1L =array('limit'); }function TTTlIII() {parent::TTTlIII(); $this->filter->AddField( 'flt_plugin_id', I12353, isset($this->cms->Vars['flt_plugin_id']) ?stripslashes(unhtmlentities($this->cms->Vars['flt_plugin_id'])) :'', '', I12354, 'plugin_id' );$IIL1IIl =isset($this->cms->Vars[I12355]) ?(int)$this->cms->Vars[I12355] :-1; $aInstalled =array(); $aInstalled =$this->filter->TITI1TT($aInstalled, array($this->words['all'] => -1)); $aInstalled =$this->filter->TITI1TT($aInstalled, array($this->words[I12356] => 1)); $aInstalled =$this->filter->TITI1TT($aInstalled, array($this->words[I12357] => 0)); $this->filter->AddField( I12355, 'select', $IIL1IIl, '', I12358, $this->options['default_prefix'] .I12359, $aInstalled );if($IIL1IIl == -1) {$this->filter->DisableFieldSQL(I12355); }}function TTTlI11(&$vData, &$aCustom) {if(empty($this->itemData)) {$this->browser->InitSQL(I12360, "FROM cms_plugins ", "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), "", I12361, "id desc" );$aCustom["fields"] += Array( "plugin_id"=>Array("action"=>I12362, "size"=>64), "header"=>Array("action"=>"callback", I12363=>&$this, "method"=>"_GetItemDataCB"), I12364=>Array("action"=>"flagicon", I12365=>1, "id"=>"pub_id", "on"=>$this->moduleName.I12366,"off"=>$this->moduleName.I12367), I12368=>Array("action"=>"flagicon", I12365=>1, "id"=>"id", I12369=>$this->moduleName."_list:is_copied_on","off"=>$this->moduleName."_list:is_copied_off"), "action_edit"=>Array(I12370=>"flagicon", I12365=>"", "id"=>"edit_id", I12369=>$this->moduleName.I12371,"off"=>$this->moduleName.I12372), I12373=>Array(I12370=>"flagicon", I12365=>"", "id"=>I12374, I12369=>$this->moduleName.I12375,I12376=>$this->moduleName."_list:icon_none"), I12377=>Array(I12370=>"flagicon", I12365=>"", "id"=>I12378, I12369=>$this->moduleName.I12379,I12376=>$this->moduleName.I12380), );$aCustom["applied_id"] ="id"; $aCustom["legend"] =Array("leg_blue", I12381, I12382, I12383, "leg_is_copied_on", "leg_edit", I12384, I12385); parent::TTTlI11($vData, $aCustom); }else {$this->options['admin_views'] =array('form'); $vData += $this->itemData; parent::TTTlI11($vData, $aCustom); }}function TTTllTT(&$vData) {if(!empty($this->itemData)) {$vData[I12386] =$this->words[I12387].' "'.$this->itemData['header'].'"'; }parent::TTTllTT($vData); }function TIll1ll($plugin) {return array( 'plugin_id' => $plugin[I12388], 'version' => $plugin['version'], 'api_version' => $plugin['api_version'], I12389 => serialize($plugin[I12389]), 'admin' => $plugin['admin'], 'specblock' => $plugin['specblock'], I12390 => $plugin[I12390], 'icon' => $plugin['icon'], 'copy_allowed' => $plugin['copy_allowed'], I12391 => $plugin[I12391], I12392 => $plugin[I12392], I12393 => $plugin[I12393] );}function TIll1II($cId, $cModule) {$plugins =$this->plugin->TTI1IT1($this->module->GetProperty(I12391)); $aIds =array(); $llILIIl =array(); foreach($plugins as $key => $plugin) {if(sizeof($plugin['errors']) == 0) {$aIds[$key] =true; }else {$llILIIl[$key] =true; }}$llILIIL =implode("','", array_map('addslashes', array_keys($aIds))); $sql ="DELETE FROM cms_plugins WHERE plugin_id not in ('".$llILIIL.I12394; $this->db->execute($sql); $deleted =$this->db->affected_rows(); if($deleted) {$this->cms->AddStatusMsg(I12395, '', '', '', array('cnt' => strval($deleted))); }if(sizeof($aIds)) {$llILII1 =array(); $aSkipped =array(); $sql =I12396.$llILIIL.I12397; $this->db->query($sql); $rs1 =&$this->db->select($sql); while($rs1->nextRecord()) {if($plugins[$rs1->Record['plugin_id']]['version'] <= $rs1->Record['version'] || $rs1->Record[I12359]) {$aSkipped[$rs1->Record['plugin_id']] =true; }else {$id =$rs1->Record[I12398]; $aSql =$this->TIll1ll($plugins[$id]); $aSql =array_map('addslashes', $aSql); $sql =$this->db->GenUpdateSQL('cms_plugins', $aSql, "WHERE plugin_id='".$aSql[I12398]."'"); $this->db->execute($sql); $llILII1[$id] =true; }unset($aIds[$rs1->Record[I12398]]); }$llILIlI =$aIds; if(is_array($llILIlI)) {foreach(array_keys($llILIlI) as $id) {$aSql =$this->TIll1ll($plugins[$id]) +array(I12359 => 0, I12399 => I12400); $aSql =array_map('addslashes', $aSql); $sql =$this->db->GenInsertSQL('cms_plugins', $aSql); $this->db->execute($sql); }}if(sizeof($llILIlI) || sizeof($llILII1)) {$this->TIll1l1('status_added', $llILIlI); $this->TIll1l1('status_skipped', $aSkipped); $this->TIll1l1(I12401, $llILII1); }elseif(!$deleted) {$this->cms->AddStatusMsg('status_no_changes'); }}else {$this->cms->AddStatusMsg("status_no_plugins_found"); }if(sizeof($llILIIl)) {$this->TIll1l1('status_error', $llILIIl, 'red'); foreach(array_keys($llILIIl) as $key) {$llILIll =array( I12388 => $key, I12402 => '' );foreach(array_keys($plugins[$key][I12402]) as $err) {$llILIll[I12402] .= $this->words["status_".$err] .'; '; }$llILIll[I12402] =mb_substr($llILIll[I12402], 0, -2) .'.'; $this->cms->AddStatusMsg("status_plugin_error", "red", "", "", $llILIll); }}}function TIll1l1($status, $aIds, $style ='') {if(sizeof($aIds)) {$this->cms->AddStatusMsg($status, $style, I12403, I12403, array('cnt' => strval(sizeof($aIds)), 'list' => "'".implode("'; '", array_keys($aIds)).I12404)); }}function TIll11T($cId, $llILIlL, $llILIl1, $llILILI, $IlI1lIL) {$llILILl =CMS_InstallablePlugin::GetPluginName($llILIlL); $this->cms->Core->TTllT1l(array($llILILl)); $vMod =&$this->cms->Core->GetModule($llILILl); if(preg_match('/^([a-z0-9_]+)(::([a-z0-9_]+))?::([a-z0-9_]+)$/', $llILIl1, $match)) {$vMod->SetOption(I12405, array('owner' => $match[1], 'parent' => $match[3], I12406 => $match[4])); }$aCaption =unserialize($llILILI[I12389]); foreach(array_keys($aCaption) as $key) {if(isset($this->cms->Vars['header_'.$key])) {$aCaption[$key] =$this->cms->Vars[I12407.$key]; }}$vMod->SetOption('admin_menu_allowed', !empty($llILILI['admin'])); $vMod->SetOption('admin_menu_caption', $aCaption); $vMod->SetOption('admin_as_submenu_caption', $aCaption); $vMod->SetOption(I12408, array_map('mb_strtoupper', $vMod->GetOption('admin_menu_caption'))); $vMod->SetOption(I12398, $llILILI[I12398]); $vMod->SetOption('api_version', $llILILI['api_version']); $vMod->SetOption(I12409, $llILILI[I12409]); $vMod->SetOption('specblock', $llILILI['specblock']); $vMod->SetOption(I12390, $llILILI[I12390]); $vMod->SetOption('icon', $llILILI['icon']); $vMod->SetOption(I12391, $llILILI[I12391]); $vMod->SetOption(I12410, intval($IlI1lIL)); $vMod->SetOption('start_disable', true); $vMod->SetOption('cache_expire_force', I12403); $vMod->SetOption('cache_l3_enable', true); $vMod->SetOption(I12411, true); $vMod->SetOption(I12392, $llILILI[I12392]); $vMod->SetOption(I12393, $llILILI[I12393]); $llILILL =$GLOBALS['ROOT_PATH'] .$llILILI[I12391] .I12412; $llILIL1 =file_exists($llILILL) && is_dir($llILILL) && file_exists($llILILL .'/options.php'); if ($llILIL1) {$null =null; $api =new AMI_PluginState('setOption', $vMod, $this->cms, $null); require $llILILL .'/options.php'; }$vMod->SetOption('has_rules', $llILIL1 && file_exists($llILILL .I12413)); $this->cms->Core->SaveOptions($llILILl); $sql =I12414.$llILIlL.I12415.$llILIl1."', is_first_run=1".($IlI1lIL === false? "": ",is_copied=".$IlI1lIL)." WHERE id='".$cId.I12404; $this->db->execute($sql); $this->cms->Core->UpdateRightsVersion(); }function TIll1Il($cId, $cModule) {$sql ="SELECT plugin_id, api_version, distr_path, orig_header, admin, specblock, config, icon, sql_install, sql_uninstall FROM cms_plugins WHERE id='$cId' and is_installed=0"; $rec =&$this->db->getRecord($sql); if(!empty($rec)) {$llILI1I =$this->module->GetProperty(I12416); $sql ="SELECT SQL_CALC_FOUND_ROWS plugin_module FROM cms_plugins WHERE is_installed=1 ORDER BY plugin_module LIMIT $llILI1I"; $rs1 =&$this->db->select($sql); if($this->db->getValue("SELECT FOUND_ROWS()") <$llILI1I) {$llILI1l =1; while($llILI1L =$rs1->nextRecord()) {if($llILI1L[I12417] >$llILI1l) {break; }$llILI1l++; }$step =$this->cms->Vars['step']; if($step == 2) {$llILIl1 =mb_strtolower(trim($this->cms->Vars[I12418])); if($this->plugin->Install($rec[I12398], $rec[I12391], $llILIl1, !empty($this->cms->Vars['copy_files']), !empty($this->cms->Vars['overwrite']))) {$this->TIll11T($cId, $llILI1l, $llILIl1, $rec, intval(!empty($this->cms->Vars[I12419]))); $this->cms->AddStatusMsg(I12420); }else {$this->cms->AddStatusMsg(I12421, 'red'); $step =1; }}if($step == 1) {$this->itemData =$this->plugin->TTI1III($rec[I12398], $rec[I12391], $this->cms->Vars); $this->itemData[I12398] =$this->itemData[I12388]; $this->itemData[I12388] =$cId; }}else {$this->cms->AddStatusMsg('status_no_free_plugins', 'red', I12403, I12403, array('limit' => strval($llILI1I))); }}else {$this->cms->AddStatusMsg(I12422); }}function TIll1I1($cId, $cModule) {$sql ="SELECT plugin_id, api_version, plugin_module, distr_path FROM cms_plugins WHERE id='$cId' and is_installed=1"; $rec =&$this->db->getRecord($sql); if(!empty($rec)) {$llILILl =CMS_InstallablePlugin::GetPluginName($rec[I12417]); $this->cms->Core->TTllT1l(array($llILILl)); $vMod =&$this->cms->Core->GetModule($llILILl); $vMod->SetOption(I12405, array()); $vMod->SetOption(I12423, I12403); $vMod->SetOption('admin_as_submenu_caption', I12403); $vMod->SetOption(I12408, I12403); $vMod->SetOption(I12398, I12403); $vMod->SetOption('api_version', I12403); $vMod->SetOption(I12409, I12403); $vMod->SetOption('specblock', I12403); $vMod->SetOption('icon', I12403); $vMod->SetOption(I12424, true); $vMod->SetOption(I12411, false); $vMod->SetOption(I12392); $vMod->SetOption(I12393); $llILILL =$GLOBALS['ROOT_PATH'] .$vMod->GetOption(I12391) .I12412; $llILIL1 =file_exists($llILILL) && is_dir($llILILL) && file_exists($llILILL .'/options.php'); if ($vMod->issetAndTrueOption('has_rules')) {$null =null; $api =new AMI_PluginState('deleteOption', $vMod, $this->cms, $null); require $llILILL .I12425; }$vMod->SetOption('has_rules', false); $this->cms->Core->SaveOptions($llILILl); $sql =I12426.$cId.I12404; $this->db->execute($sql); $this->cms->Core->UpdateRightsVersion(); $this->cms->AddStatusMsg(I12427); if(!$this->plugin->Uninstall($rec[I12398], $rec[I12391])) {$this->cms->AddStatusMsg('status_delete_files_error', 'red'); }}else {$this->cms->AddStatusMsg(I12428); }}function TTTl1Tl($cId, $cModule) {$sql ="SELECT plugin_id, api_version, distr_path, orig_header, admin, specblock, icon, plugin_module, installed_as FROM cms_plugins WHERE id='$cId' and is_installed=1"; $rec =&$this->db->getRecord($sql); if(!empty($rec)) {$rec[I12418] =$rec[I12429]; foreach($this->cms->Core->TTlI1TI(CMS_InstallablePlugin::GetPluginName($rec[I12417]), I12423) as $lang => $header) {$rec[I12407.$lang] =$header; }$this->itemData =$this->plugin->TTI1III($rec['pluginId'], $rec[I12391], $rec, false); $this->itemData[I12398] =$this->itemData[I12388]; $this->itemData[I12388] =$cId; }else {$this->cms->AddStatusMsg(I12430); }}function TTTl1lI($cId, $cModule) {$sql ="SELECT plugin_id, api_version, distr_path, orig_header, admin, specblock, config, icon, plugin_module, installed_as FROM cms_plugins WHERE id='$cId' and is_installed=1"; $rec =&$this->db->getRecord($sql); if(!empty($rec)) {$llILIl1 =mb_strtolower(trim($this->cms->Vars[I12418])); $aInfo =$this->plugin->GetPluginInfo($rec[I12391]); $res =empty($aInfo[I12402]); if($res) {$aAllowed =$this->plugin->TTI1IIT($aInfo[I12418]); if(in_array($llILIl1, $aAllowed)) {$this->TIll11T($cId, $rec[I12417], $llILIl1, $rec, false); $this->cms->AddStatusMsg(I12420); }else {$res =false; }}if(!$res) {$this->cms->AddStatusMsg(I12421, I12431); $this->TTTl1Tl($cId, $cModule); }}}function _GetItemDataCB(&$aItem, &$aData) {if($aItem[I12359]) {$aHeaders =$this->cms->Core->GetModOption(CMS_InstallablePlugin::GetPluginName($aItem[I12417]), I12423); $aItem[I12432] =1; }else{ $aHeaders =unserialize($aItem[I12389]); $aItem[I12433] =1; $aItem['action_edit'] =1; }$aItem['header'] =isset($aHeaders[$this->langData]) ?$aHeaders[$this->langData] :I12403; }function getOptionsExpireCB($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues"){ switch($IIL1l1I){ case "getallvalues": if($IIL1lL1[I12434] == 'lay_body'){ $res =array( 'enum' => array( I12403, '-1 hour', '1' ),I12435 => array( I12403, '-1 hour' ),'result_type' => 'simple' );}else{ $res =array( 'enum' => array( I12403, I12436 ),I12435 => array( I12403 ),'result_type' => 'simple' );}break; case "getvalue": $res =$cData[I12365]; break; case "correctvalue": $res =array(); break; case I12437: if($IIL1lL1[I12434] != 'lay_body' && !empty($cData['value'])){ if(strpos($cData['value'], 'second') === false){ if(intval($cData[I12438]) <1){ $aData['real_value'] ='5 second'; }}else if(intval($cData[I12438]) <5){ $aData['real_value'] ='5 second'; }}break; }return true; }}