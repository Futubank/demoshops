<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       25690 xkqwzqgqlmwxrgtysnruxwywrlxxwtymxuqtywmtizylppspywiziqkigugqsgksrtrnpnir
 */ ?><?php foreach(array(12439=>"IHSuJQ?gRT?MnDtZJJQS#Or@",12440=>"HGtMHn%?",12441=>"DOHC|YB|tBGQ",12442=>"MS",12443=>"JZnP",12444=>"'{",12445=>"^",12446=>"MS|WZtQPHrB",12447=>"",12448=>"GuYJMW",12449=>"SZtQ",12450=>"WuDtHI|fMQJS|5",12451=>"tQWO",12452=>"SQDWrMGtMHn",12453=>"JMnK|ZJMZD",12454=>"SQtZMJD|nHMnSQx",12455=>"ZnnHunWQ",12456=>"?",12457=>"``~",12458=>"MS|MtQI",12459=>"'?coqRq?MS='",12460=>"fMJQnZIQ",12461=>"'",12462=>"YMP|fMJQnZIQ",12463=>"GHGuG|GMWturQ",12464=>"|YMP|",12465=>"DIZJJ|GMWturQ",12466=>"GMWturQ",12467=>"`PMf",12468=>"|DIZJJ`DCf",12469=>"\n",12470=>"Qn",12471=>"GHDMtMHn",12472=>"nZIQ",12473=>"DuYJMnK",12474=>"?coqRq?MS=10000") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModulePortfolioItem extends ModuleEshopItem{ public $fn; function ModulePortfolioItem(&$cms, &$db, &$cModule){ parent::ModuleEshopItem($cms, $db, $cModule); }function TIIlITI(){ return; echo "ActionUpdate called<hr>"; $llILI11 =false; $llILI11 =true; if($this->cms->Core->IsInstalled("prt")){ echo I12439; echo I12440 .intval($this->cms->Core->GetModOption("prt", "show_by_type")) ."<hr>"; if($this->cms->Core->GetModOption("prt", I12441)){ $llILI11 =true; echo "items are shown BY TYPE<hr>"; }}$sql ="SELECT DISTINCT id, name FROM cms_prt_groups"; $this->db->query($sql); $db =new DB_si; $llILlII =Array(); while($this->db->next_record()) {$llILlII[$this->db->Record["id"]] =$this->db->Record["name"]; }$sql ="SELECT DISTINCT id, name FROM cms_prt_types"; $this->db->query($sql); $aAllTypes =Array(); while($this->db->next_record()) {$aAllTypes[$this->db->Record["id"]] =$this->db->Record["name"]; }if($llILI11) {$sql ="SELECT * FROM cms_prt_groups"; }else {$sql ="SELECT * FROM cms_prt_types"; }$this->db->query($sql); $llILlIl =Array(); while($this->db->next_record()) {$llILlIl[$this->db->Record[I12442]] ="("; $llILlIl[$this->db->Record[I12442]] .= $this->db->Record[I12442] .", '"; $llILlIl[$this->db->Record[I12442]] .= $this->db->Record["name"] ."', '"; $llILlIl[$this->db->Record[I12442]] .= $this->db->Record[I12443] ."', '"; $llILlIl[$this->db->Record[I12442]] .= date("Y-m-d") ."', '"; $llILlIl[$this->db->Record[I12442]] .= $this->db->Record["name"] .I12444; }foreach($llILlIl as $id => $val){ $this->db->query("INSERT INTO cms_po_reference_0012(id, name, lang, date, value_1) VALUES" .$llILlIl[$id]); }echo "Inserting items...<hr>"; $sql ="SELECT * FROM cms_prt_items"; $this->db->query($sql); $llILlIL ="LOG FILE OF LOST DATA\n\n\n"; $aSql =Array(); while($this->db->next_record()) {$aSql[I12442] =$this->db->Record[I12442]; $aGroups =mb_split(I12445,$this->db->Record["ids_groups"]); if($llILI11){ if($this->db->Record[I12443] == "en"){ $aSql["id_category"] =$this->db->Record["id_type"] +10000; }else{ $aSql[I12446] =$this->db->Record["id_type"] +20000; }if($this->db->Record["ids_groups"] != I12445){ $aSql["custom_field_12"] =$this->db->Record["ids_groups"]; }}else{ $flag =true; foreach($aGroups as $key => $val){ if($val != I12447 && $flag){ if($this->db->Record[I12443] == "en"){ $aSql[I12446] =intval($val) +10000; }else{ $aSql[I12446] =intval($val) +20000; }$flag =false; $aGroups[$key] =I12447; }}if($this->db->Record["ids_types"] != I12445){ $aSql["custom_field_12"] =$this->db->Record["ids_types"]; }}$aSql[I12448] =$this->db->Record[I12448]; $aSql[I12443] =$this->db->Record[I12443]; $aSql["name"] =$this->db->Record["title"]; $aSql["position"] =$this->db->Record[I12442]; $aSql["custom_field_1"] =$this->db->Record[I12449]; $aSql["custom_field_2"] =$this->db->Record["customer"]; $aSql["custom_field_4"] =$this->db->Record["exp_date"]; $aSql[I12450] =$this->db->Record["url"]; $aSql["custom_field_6"] =$this->db->Record["customer_url"]; $llILlI1 =mb_split("\n", $this->db->Record[I12451]); $aSql["custom_field_7"] =join( ", ", $llILlI1); $aSql["custom_field_11"] =$this->db->Record["hidden_comment"]; if($this->db->Record[I12452] != I12447){ $aSql[I12452] =$this->db->Record[I12452]; }else{ $aSql[I12452] =$this->db->Record["customer_descr"]; }if($this->db->Record["sublink"] != I12447){ $aSql["sublink"] =$this->db->Record["sublink"]; $aSql[I12453] =$this->db->Record["sublink"]; }else{ $aSql["sublink"] =$this->db->Record[I12442]; $aSql[I12453] =$this->db->Record[I12442]; }$aSql["sm_data"] =$this->db->Record["sm_data"]; $aSql[I12454] =$this->db->Record[I12454]; $llILllI =200; if(mb_strlen($this->db->Record[I12452]) <$llILllI){ $aSql["announce"] =$this->db->Record[I12452]; }if(mb_strlen($this->db->Record[I12452]) >= $llILllI){ $desc =strip_tags($this->db->Record[I12452]); $aWords =mb_split(" ", $desc); $length =0; foreach($aWords as $key => $llILlll){ if($length <$llILllI){ $aSql["announce"] .= ($llILlll ." "); $length += mb_strlen($llILlll); }}$aSql[I12455] .= "..."; }$aSql["hs_item"] ="% " .$aSql["name"] .I12456 .$aSql[I12455]; $aSql =array_map("addslashes", $aSql); $sql =$this->db->GenInsertSQL("cms_po_items", $aSql); $db->query($sql); set_time_limit(10); }echo "Updating items pictures...<hr>"; $llILlIL .= "\n\n\nPictures:\n\n\n"; $llILllL ="_mod_files/ce_images/portfolio/"; $sql ="SELECT * FROM cms_prt_pics"; $this->db->query($sql); $llILll1 =Array(); while($this->db->next_record()) {if($this->db->Record["type"] == "main"){ $img =$llILllL.$this->db->Record["filename"]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET picture='".$img."' WHERE id='".$this->db->Record["id_item"]."'"); $llILll1[$this->db->Record[I12458]]["picture"] =1; }$img =$llILllL.$this->db->Record[I12442]."_".$this->db->Record["filename"]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET picture='".$img.I12459.$this->db->Record[I12458]."'"); $llILll1[$this->db->Record[I12458]]["picture"] =1; }$img =$llILllL.$this->db->Record[I12458]."_".$this->db->Record["filename"]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET picture='".$img.I12459.$this->db->Record[I12458]."'"); $llILll1[$this->db->Record[I12458]]["picture"] =1; }$llILlLI =str_replace(".gif", "_small.gif", $this->db->Record[I12460]); $llILlLI =str_replace(".jpg", "_small.jpg", $llILlLI); $llILlLI =str_replace(".swf", "_small.swf", $llILlLI); $img =$llILllL.$llILlLI; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET picture='".$img.I12459.$this->db->Record[I12458]."'"); $llILll1[$this->db->Record[I12458]]["picture"] =1; }$img =$llILllL.$this->db->Record[I12442]."_".$llILlLI; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]]["picture"] =1; }$img =$llILllL.$this->db->Record[I12458]."_".$llILlLI; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]]["picture"] =1; }if($this->db->Record[I12462] != I12447){ $img =$llILllL.$this->db->Record[I12462]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET popup_picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]]["popup_picture"] =1; }$img =$llILllL.$this->db->Record[I12458]."_".$this->db->Record[I12462]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET popup_picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12463] =1; }$img =$llILllL.$this->db->Record[I12442]."_".$this->db->Record[I12462]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET popup_picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12463] =1; }$img =$llILllL.$this->db->Record[I12458]."_big_".$this->db->Record[I12462]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET popup_picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12463] =1; }$img =$llILllL.$this->db->Record[I12442].I12464.$this->db->Record[I12462]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET popup_picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12463] =1; }}}if($this->db->Record["type"] == "icon"){ $img =$llILllL.$this->db->Record[I12460]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET small_picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12465] =1; }$img =$llILllL.$this->db->Record[I12458]."_".$this->db->Record[I12460]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET small_picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12465] =1; }$img =$llILllL.$this->db->Record[I12442]."_".$this->db->Record[I12460]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET small_picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12465] =1; }}}$sql ="SELECT pcs.*, itms.title FROM cms_prt_pics pcs, cms_prt_items itms WHERE pcs.id_item = itms.id"; $this->db->query($sql); while($this->db->next_record()) {if($this->db->Record["type"] == "other"){ $llILlLl =true; $llILlLL =true; if($this->db->Record[I12460] != I12447 && !isset($llILll1[$this->db->Record[I12458]]["picture"])){ $img =$llILllL.$this->db->Record[I12460]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12466] =1; $llILlLl =false; }$img =$llILllL.$this->db->Record[I12442]."_".$this->db->Record[I12460]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12466] =1; $llILlLl =false; }$img =$llILllL.$this->db->Record[I12458]."_".$this->db->Record[I12460]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12466] =1; $llILlLl =false; }$llILlLI =str_replace(I12467, "_small.gif", $this->db->Record[I12460]); $llILlLI =str_replace(".jpg", "_small.jpg", $llILlLI); $llILlLI =str_replace(".swf", I12468, $llILlLI); $img =$llILllL.$llILlLI; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12466] =1; $llILlLl =false; }$img =$llILllL.$this->db->Record[I12458]."_".$llILlLI; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12466] =1; $llILlLl =false; }$img =$llILllL.$this->db->Record[I12442]."_".$llILlLI; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12466] =1; $llILlLl =false; }}if($this->db->Record[I12462] != I12447 && !isset($llILll1[$this->db->Record[I12458]][I12463])){ $img =$llILllL.$this->db->Record[I12462]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET popup_picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12463] =1; $llILlLL =false; }$img =$llILllL.$this->db->Record[I12458]."_".$this->db->Record[I12462]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET popup_picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12463] =1; $llILlLL =false; }$img =$llILllL.$this->db->Record[I12442]."_".$this->db->Record[I12462]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET popup_picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12463] =1; $llILlLL =false; }$img =$llILllL.$this->db->Record[I12458].I12464.$this->db->Record[I12462]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET popup_picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12463] =1; $llILlLL =false; }$img =$llILllL.$this->db->Record[I12442].I12464.$this->db->Record[I12462]; if(file_exists(I12457.$img)){ $db->query("UPDATE cms_po_items SET popup_picture='".$img.I12459.$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12463] =1; $llILlLL =false; }}if($this->db->Record[I12460] != I12447 && $llILlLl){ $llILlIL .= "Item [" .$this->db->Record["title"]; $llILlIL .= "] has lost this image: " .$this->db->Record[I12460]; $llILlIL .= "\n"; }if($this->db->Record[I12462] != I12447 && $llILlLL){ $llILlIL .= "Item [" .$this->db->Record["title"]; $llILlIL .= "] has lost this popup image: " .$this->db->Record[I12462]; $llILlIL .= I12469; }}if(!isset($llILll1[$this->db->Record[I12458]][I12466]) && isset($llILll1[$this->db->Record[I12458]][I12465])){ $db->query("UPDATE cms_po_items SET picture=small_picture WHERE id='".$this->db->Record[I12458].I12461); $llILll1[$this->db->Record[I12458]][I12466] =1; }}echo "Inserting categories...<hr>"; if($llILI11){ $sql ="SELECT * FROM cms_prt_types"; }else{ $sql ="SELECT * FROM cms_prt_groups"; }$this->db->query($sql); $aSql =Array(); while($this->db->next_record()) {if($this->db->Record[I12442] != 0){ if($this->db->Record[I12443] == I12470){ $aSql[I12442] =$this->db->Record[I12442] +10000; $aSql["id_parent"] =10000; $aSql["all_parents"] =',10000,'; $aSql["dataset_id"] =59; $aSql[I12471] =$this->db->Record[I12442] +10000; $aSql[I12448] =1; }else{ $aSql[I12442] =$this->db->Record[I12442] +20000; $aSql["id_parent"] =20000; $aSql["all_parents"] =',20000,'; $aSql["dataset_id"] =59; $aSql[I12471] =$this->db->Record[I12442] +20000; $aSql[I12448] =1; }$aSql[I12443] =$this->db->Record[I12443]; $aSql[I12472] =$this->db->Record[I12472]; $aSql[I12455] =I12447; $aSql["instruction"] =I12447; if($llILI11){ $aSql[I12452] =$this->db->Record[I12452]; }else{ $aSql[I12452] =I12447; }if($this->db->Record["sublink"] != I12447){ $aSql["sublink"] =$this->db->Record["sublink"]; $aSql[I12453] =$this->db->Record[I12473]; }else{ $aSql[I12473] =$this->db->Record[I12442]; $aSql[I12453] =$this->db->Record[I12442]; }$aSql["sm_data"] =$this->db->Record["sm_data"]; $aSql[I12454] =$this->db->Record[I12454]; $sql =$this->db->GenInsertSQL("cms_po_cats", $aSql); $aSql =array_map("addslashes", $aSql); $db->query($sql); }set_time_limit(10); }echo "Updating items count...<hr>"; $sql ="SELECT id_category, count(id) as numtotal FROM `cms_po_items` GROUP BY id_category"; $this->db->query($sql); while($this->db->next_record()) {$sql ="UPDATE cms_po_cats SET count_childs=".$this->db->Record["numtotal"]." WHERE id='".$this->db->Record[I12446].I12461; $db->query($sql); }$sql ="SELECT id_category, count(id) as numpublic FROM `cms_po_items` WHERE `public`=1 GROUP BY id_category"; $this->db->query($sql); while($this->db->next_record()) {$sql ="UPDATE cms_po_cats SET count_public_childs=".$this->db->Record["numpublic"]." WHERE id='".$this->db->Record[I12446].I12461; $db->query($sql); }$sql ="SELECT sum(count_childs) as maintotal, sum(count_public_childs) as mainpublic FROM cms_po_cats WHERE id_parent=20000 OR id=20000"; $this->db->query($sql); while($this->db->next_record()) {$sql ="UPDATE cms_po_cats SET count_childs=" .$this->db->Record["maintotal"] .", count_public_childs=" .$this->db->Record["mainpublic"] ." WHERE id=20000"; $db->query($sql); }$sql ="SELECT sum(count_childs) as maintotal, sum(count_public_childs) as mainpublic FROM cms_po_cats WHERE id_parent=10000 OR id=10000"; $this->db->query($sql); while($this->db->next_record()) {$db->query("UPDATE cms_po_cats SET count_childs=" .$this->db->Record["maintotal"] .", count_public_childs=" .$this->db->Record["mainpublic"] .I12474); }$db->query("UPDATE cms_po_cats SET public=0 WHERE count_childs=0"); $sql ="SELECT dataset_data FROM `cms_po_cats` WHERE id=20000"; $this->db->query($sql); while($this->db->next_record()) {$db->query("UPDATE cms_po_cats SET dataset_data='".$this->db->Record["dataset_data"].I12461); }$llILlL1 ="__portfolio_log.txt"; $IlILLll =fopen($llILlL1, 'w'); $llILl1I =fwrite($IlILLll, $llILlIL); fclose($IlILLll); }}