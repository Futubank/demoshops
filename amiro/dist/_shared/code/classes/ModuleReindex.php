<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       18218 xkqwxnizkuxsgzxxwlgpkzzskiryptyitsrqgpltwzwwsyqrpqxzilytxtwkzpwpsnygpnir
 */ ?><?php foreach(array(12475=>"rQMnSQx",12476=>'JMKQ',12477=>"",12478=>"uDQ|GHDMtMHnD",12479=>'',12480=>'MnSQx|fMQJSD',12481=>"UGSZtQ|tMIQ",12482=>"GOG|StMIQ",12483=>"rQS",12484=>"sZtZ|JQnPtO",12485=>"WHnn",12486=>"MnDtZJJQS|JZnPD",12487=>'zjTqR?Tzyjq?',12488=>'MS',12489=>'IHSuJQ|nZIQ',12490=>'GZPQD',12491=>'DGQW|IHSuJQ|YHSB',12492=>'YHSB|MtQID',12493=>'!',12494=>'HrMPMnZJiHSuJQNZIQ',12495=>"DtHG|uDQ|DuYJMnKD",12496=>'IuJtM|DMtQD',12497=>'rQJZtMvQiHSuJQRHYHtDNHMnSQxFMQJS',12498=>'GZPQDsZtZ',12499=>'uDQ|WZtQPHrMQD',12500=>'rQJZtMvQ|IHSuJQ',12501=>'DQZrWOsZtZ',12502=>'?') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleReindex extends CMS_ActModule {public $llILl1l; public $lIl11IL; public $lIl11I1; public $II1lLL1; public $lIl111I; public $lIl111l; protected $mode ='like'; protected $llILl1L =''; function __construct(&$cms, &$db, &$cModule) {$this->llILl1l =false; $this->lIl11IL =0; $this->lIl11I1 =0; $this->lIl111I =0; $this->lIl111l =time(); parent::CMS_ActModule($cms, $db, $cModule); $this->mode =$this->cms->Core->IsInstalled(I12475) ?$this->cms->Core->GetModOption('reindex', 'mode') :'like'; if($this->mode != 'fulltext'){ $this->mode =I12476; }$this->llILl1L =$this->mode == 'fulltext' ?'cms_site_search_index' :'cms_site_search'; }function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll =I12477, $aOptions =Array()) {$IIIIL11["group_operations"] =Array(); $IIIIL11["use_id_page"] =false; $IIIIL11["use_options_form"] =true; $IIIIL11["multi_sites"] =false; $IIIIL11[I12478] =false; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin() {parent::_InitAdmin(); if(defined("DAEMON_LOGIN_OK")){ $this->TIll11l(1, 'reindex'); }}function TTTlITT($IIIL11l, $cId, $cModule =I12477) {switch($IIIL11l){ case I12475: $this->TIll11l($cId, $cModule); break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function GetHtml(&$aCustom) {return parent::GetHtml($aCustom); }function &TTTlI1T(&$aCustom) {return parent::TTTlI1T($aCustom); }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {$this->options['admin_views'] =array('form'); $vData += $this->itemData; $aTmp =array(); $aModules =&$this->cms->Core->GetAllModules(); $aModulesNames =array_keys($aModules); $lastUpdated =I12479; foreach($aModulesNames as $name){ $oModule =&$this->cms->Core->GetModule($name); $aSearchData =$oModule->TTlIIll(); if( $this->mode == I12476 && isset($aSearchData['index']) && is_array($aSearchData['index']) && sizeof($aSearchData['index']) >0 || $this->mode == 'fulltext' && is_array($aSearchData[I12480]) && sizeof($aSearchData[I12480]) >0 ){$this->db->setSafeSQLOptions("show"); $sql ="SHOW TABLE STATUS like '".$oModule->GetTableName()."'"; $this->db->query($sql); if($this->db->next_record()){ if($this->db->Record["Update_time"] >$lastUpdated){ $lastUpdated =$this->db->Record[I12481]; }}}}$llILl11 =DateTools::getCorrectUDate($lastUpdated, $this->cms->Core->GetProperty('dateformat_mysql')); $vData["last_update"] =date($this->cms->DFMT["php_dtime"], $llILl11); if($this->cms->Core->ReadOption($aTmp, I12477, I12475)) {$vData["last_reindex"] =date($this->cms->DFMT[I12482], $aTmp['value']); }$llILLII =DateTools::getCorrectUDate($vData["last_reindex"], $this->cms->DFMT["conf_dtime"]); if($llILl11 >$llILLII){ $this->cms->AddStatusMsg("data_changed", I12483); }$this->db->setSafeSQLOptions("show"); $sql ="SHOW TABLE STATUS like '" .$this->llILl1L ."'"; $this->db->query($sql); while($this->db->next_record()){ $vData["index_size"] =number_format($this->db->Record[I12484]/1048576, 2); }parent::TTTlI11($vData, $aCustom); }function TIll11I(){ $sql ='delete quick from ' .$this->llILl1L .' where active=1'; $this->db->query($sql); $sql ='update low_priority ' .$this->llILl1L .' set active=1'; $this->db->query($sql); }function TIll11l($cId, $cModule){ $this->II1lLL1 =TlT1I11(); $GLOBALS[I12485]->SetBenchType('LONG'); $this->llILl1l =defined('DAEMON_LOGIN_OK'); $this->lIl11IL =0; $this->fn->TII1lT1(true); if(!$this->llILl1l){ while(@ob_end_clean()); $vData['metas'] =$this->cms->Gui->getMetas(); $vData['progress_id'] =$this->II1lLL1; $html =$this->cms->Gui->get($this->moduleName."_subform:progress_popup_header", $vData); print $html; print str_repeat(' ', 140000); flush(); if (ob_get_level()) {ob_flush(); flush(); }}$llILLIl =$this->cms->Core->GetAOption(I12486); $llILLIL =sizeof($llILLIl); $llILLI1 =0; $llILLlI =$this->cms->Core->IsInstalled("srv_multi_sites"); $isMultiPageAllowed =$this->cms->Core->GetOption("multi_page_allowed"); $llILLll =$this->cms->Core->GetOption('default_ids'); $sql =I12487 .$this->llILl1L .' DISABLE KEYS'; $this->db->setSafeSQLOptions("alter"); $this->db->query($sql); $sql ='delete quick from ' .$this->llILl1L .' where active=0'; $this->db->query($sql); foreach($this->cms->Core->GetAOption(I12486) as $key => $llILLlL){ $llILLl1 =$llILLll[$llILLlL]; $sql ="SELECT id, parent_id, all_parents, script_link, module_name, name, skip_search, page_noindex, use_hreflang, sb_data FROM cms_pages WHERE lang='$llILLlL' and public=1 ORDER BY id asc"; $this->db->query($sql); $llILLLI =0; $llILLLl =array(); $llILLLL =array(); while($this->db->next_record()){ $llILLLl[$this->db->Record[I12488]] =$this->db->Record['all_parents']; if($this->db->Record['skip_search'] == 0 && $this->fn->TIll111($this->db->Record['script_link'])){ $llILLLL['pages'][$this->db->Record[I12488]] =$this->db->Record; if($this->db->Record[I12489] != I12490 && $this->db->Record[I12489] != 'guestbook'){ $llILLLL[$this->db->Record[I12489]][$this->db->Record[I12488]] =$this->db->Record; $llILLL1 =false; $llILL1I =false; if(!empty($this->db->Record['sb_data'])){ $aSBData =unserialize($this->db->Record['sb_data']); if(isset($aSBData[I12491]) && isset($aSBData[I12491][$this->db->Record[I12489]]) && isset($aSBData[I12491][$this->db->Record[I12489]]['disable_se_indexing_pages'])){ $llILLL1 =true; if(in_array(I12492, $aSBData[I12491][$this->db->Record[I12489]]['disable_se_indexing_pages'])){ $llILL1I =true; }}}if(!$llILLL1){ $llILL1l =&$this->cms->Core->GetModule($this->db->Record[I12489]); if($llILL1l != false){ $llILL1I =$llILL1l->issetOption("disable_se_indexing_pages") ?in_array(I12492, $llILL1l->GetOption("disable_se_indexing_pages")) :false; }}$llILLLL[I12490][$this->db->Record[I12488]]['seCalculatedNoindex'] =$llILL1I; }}}foreach($llILLLl as $id => $llILL1L){ $llILL11 =0; $llIL1II =explode(I12493, $llILL1L); for($pi =0; $pi <sizeof($llIL1II); $pi++){ if($llILL11 == 0 && $llIL1II[$pi] != 0){ $llILL11 =$llIL1II[$pi]; }if($llIL1II[$pi] == $llILLl1){ if(isset($llIL1II[$pi+1])) $llILL11 =$llIL1II[$pi+1]; }}$llILLLl[$id] =$llILL11; }$llIL1Il =$llILLLL; $llILLLL =array(); foreach($llIL1Il as $moduleName => $pagesData){ $this->TII1Il1(); if(sizeof($pagesData) >0 && $this->cms->Core->TTlI111($moduleName)){ $oModule =&$this->cms->Core->GetModule($moduleName); $searchData =$oModule->TTlIIll(); if($this->mode == I12476 && isset($searchData['index']) || $this->mode == 'fulltext' && isset($searchData[I12480])){ $llILLLL[$moduleName] =array( I12494 => $moduleName, 'tableName' => $oModule->GetTableName(), 'stopUseSublinks' => $oModule->issetAndTrueProperty(I12495), 'stopArgNames' => ($oModule->issetOption("stop_arg_names") ?$oModule->GetOption("stop_arg_names") :false), 'multiSites' => $oModule->issetAndTrueOption(I12496), 'multiPage' => ($isMultiPageAllowed && $oModule->issetAndTrueOption('multi_page')), 'useTags' => $this->fn->TIl1TTT($oModule), 'seoAllowIndexing' => (!in_array($moduleName, $this->cms->Core->GetProperty('disabled_se_indexing_mods'))) && ($oModule->issetOption("disable_se_indexing_pages") ?!in_array('body_itemD', $oModule->GetOption("disable_se_indexing_pages")) :true), 'searchData' => $searchData, I12497 => I12479, I12498 => $pagesData );if($moduleName == 'faq'){ $llILLLL[$moduleName]['listLayout'] =$oModule->GetOption("question_list_layout"); }if($oModule->IssetOption('use_categories') && !$oModule->GetOption(I12499)){ unset($llILLLL[$moduleName]['searchData'][I12500]); unset($searchData[I12500]); }if(isset($searchData[I12500]) && is_array($searchData[I12500]) && sizeof($searchData[I12500]) == 2){ if($this->cms->Core->TTlI111($searchData[I12500][0])){ $llIL1IL =&$this->cms->Core->GetModule($searchData[I12500][0]); $llIL1I1 =$llIL1IL->TTlIIll(); if($this->mode == I12476 && isset($llIL1I1['index']) || $this->mode == 'fulltext' && isset($llIL1I1[I12480])){ $llILLLL[$searchData[I12500][0]] =$llILLLL[$moduleName]; $llILLLL[$searchData[I12500][0]]['tableName'] =$llIL1IL->GetTableName(); $llILLLL[$searchData[I12500][0]][I12501] =$llIL1I1; $llILLLL[$searchData[I12500][0]]['useTags'] =$this->fn->TIl1TTT($llIL1IL); $llILLLL[$searchData[I12500][0]]['seoAllowIndexing'] =(!in_array($searchData[I12500][0], $this->cms->Core->GetProperty('disabled_se_indexing_mods'))) && ($oModule->issetOption("disable_se_indexing_pages") ?!in_array(I12492, $oModule->GetOption("disable_se_indexing_pages")) :true); $llILLLL[$moduleName][I12497] =$llIL1I1['robots_noindex_field']; }}}}}}if(($llIL1lI =sizeof($llILLLL)) >0){ $this->lIl11IL =$llILLIL*$llIL1lI; $this->lIl11I1 =$llILLI1 *$llIL1lI; $llILLI1++; }$db =new DB_si; foreach($llILLLL as $moduleName => $moduleData){ if($moduleName == I12490){ $this->fn->TIl1Tll($db, $llILLlL, $llILLlI, $moduleData, $llILLLl); }else{ $this->fn->TIl1TlI($db, $llILLlL, $llILLlI, $moduleName, $moduleData, $llILLLl); }$this->TII1Ill(); }}$this->TIll11I(); $this->cms->Core->WriteOption(I12477, I12475, time()); $sql =I12487 .$this->llILl1L .' ENABLE KEYS'; $this->db->setSafeSQLOptions("alter"); $this->db->query($sql); $sql ="OPTIMIZE TABLE " .$this->llILl1L; $this->db->query($sql); $this->TII1Ill(100); if(!$this->llILl1l){ $html =$this->cms->Gui->get($this->moduleName."_subform:progress_popup_footer", $vData); print $html; flush(); }else{ print "OK"; ob_flush(); }$GLOBALS[I12485]->TT1I1lT(); exit; }function TII1Ill($II1LI11 =-1){ if($II1LI11 == -1){ $this->lIl11I1 ++; $II1LI11 =0; if($this->lIl11I1 >$this->lIl11IL){ $II1LI11 =100; }else{ $II1LI11 =intval(100*$this->lIl11I1/$this->lIl11IL); }}else{ $this->lIl11I1 =intval($II1LI11*$this->lIl11IL/100); }if(!$this->llILl1l){ TlT1lTT($this->II1lLL1, $II1LI11, I12479); $html =$this->cms->Gui->getAbs($this->moduleName."_subform:progress_popup_iterator", Array("percent" => $II1LI11)); print $html; flush(); }else{ print ' '; ob_flush(); }}function TII1Il1(){ if((++$this->lIl111I) %50 == 0 && $this->lIl111l +5 <time()){ $this->lIl111l =time(); print I12502; $this->llILl1l ?ob_flush() :flush(); }}}