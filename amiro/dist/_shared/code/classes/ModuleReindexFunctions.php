<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       34085 xkqwmwqmtxrsymswspriyxgsswwwnkgiryzuqtypqmyknryymtgqqgnumwrmqgunpqtxpnir
 */ ?><?php foreach(array(12503=>"rQMnSQx",12504=>'rQMnSQx',12505=>'QxtQnDMHnD',12506=>'',12507=>'?ZD?MnSQx|fMQJS',12508=>'whNwzT}',12509=>'~#,++`[ ++@~D',12510=>'?',12511=>'|',12512=>"?",12513=>'~',12514=>'OMSQ|Mn|JMDt',12515=>'DtHGzrPNZIQD',12516=>'rQJZtMvQ|IHSuJQ',12517=>'DQZrWOsZtZ',12518=>'rQJZtMvQiHSuJQRHYHtDNHMnSQxFMQJS',12519=>'=0{',12520=>'!?mF}',12521=>'=t2`MS?',12522=>"GuYJMW|fMQJS",12523=>'HrMPMnZJiHSuJQNZIQ',12524=>'SZtQ|IHSMfMQS',12525=>'tMtJQ',12526=>'t1`',12527=>'IuJtMgZPQ',12528=>'!?t1`',12529=>'COQrQ?t1`JZnP="',12530=>'fZE',12531=>'MS',12532=>'nZv|SZtZ',12533=>' ',12534=>"WZt|MD|GuYJMW",12535=>'1',12536=>'MS|GZPQ|rQZJ',12537=>'DQHzJJHCmnSQxMnP',12538=>'0',12539=>'IHSuJQ|nZIQ',12540=>'MS|WZt',12541=>'ZnnHunWQ',12542=>'f2',12543=>'CHrSD',12544=>'DWrMGt|JMnK',12545=>'nZIQ',12546=>'GZPQD',12547=>'DQJQWt?t1`MS?ZD?MS!?t1`DWrMGt|JMnK!?t1`IHSuJQ|nZIQ!?t1`GZPQ|nHMnSQx!?',12548=>'""',12549=>'uDQTZPD',12550=>'"?ZnS?MS?mN?}',12551=>'GZPQDsZtZ',12552=>'ZWtMvQ',12553=>'MS|DMtQ',12554=>'~\*DtZtMW\&~',12555=>"tZPD",12556=>'ZnnHunWQ|fuJJ',12557=>'f3',12558=>'SQfZuJt|MSD',12559=>'!',12560=>'tZYJQNZIQ',12561=>'IuJtMdMtQD',12562=>'YHSB|MtQIs',12563=>"uDQ|WZtQPHrMQD",12564=>"SQJQtQ?EuMWK?frHI?",12565=>"?COQrQ?ZWtMvQ=1?ZnS?IHSuJQ|nZIQ='",12566=>"?DQt?ZWtMvQ=1?COQrQ?ZWtMvQ=0?ZnS?IHSuJQ|nZIQ='",12567=>"'",12568=>'~;}`[ {|WZt$~M',12569=>"?COQrQ?IHSuJQ|nZIQ='",12570=>"uGSZtQ?",12571=>"hgTmimaq?Tzyjq?",12572=>'#~') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleReindexFunctions extends CMS_Functions{ public $lILIlLl; public $llIL1ll; public $llIL1lL; public $llIL1l1; protected $llIL1LI =FALSE; protected $mode ='like'; protected $llILl1L =''; function ModuleReindexFunctions(&$cms, &$db, &$cModule, &$IlILIl1) {parent::CMS_Functions($cms, $db, $cModule, $IlILIl1); $this->llIL1ll =60; $this->llIL1lL =100; $this->llIL1l1 =192; $this->lILIlLl =false; $this->mode =$this->cms->Core->IsInstalled(I12503) ?$this->cms->Core->GetModOption('reindex', 'mode') :'like'; $this->llIL1LI =$this->cms->Core->IsInstalled('reindex') ?$this->cms->Core->GetModOption(I12504, 'fill_full_announce') :FALSE; if($this->mode != 'fulltext'){ $this->mode ='like'; }$this->llILl1L =$this->mode == 'fulltext' ?'cms_site_search_index' :'cms_site_search'; }function TII1lT1($lILIlLL){ $this->lILIlLl =$lILIlLL; }function TII1Il1(){ if($this->lILIlLl){ $this->IlILIlL->TII1Il1(); }}function TIll111($lILIlIl){ global $ROOT_PATH_WWW; $res =true; $llIL1Ll =mb_strtolower($ROOT_PATH_WWW); $llIL1LL =mb_strtolower($lILIlIl); if(mb_strpos($llIL1LL.'/', $llIL1Ll) === 0){ $lILIlIl =mb_substr($lILIlIl, mb_strlen($llIL1Ll)); $llIL1LL =mb_strtolower($link); }if(preg_match('/^https?:\/\//', $llIL1LL)) {$res =false; }return $res; }function TIl1TTT(&$oModule){ if($oModule->issetOption('extensions')){ $optExtensions =$oModule->getOption(I12505); if(is_array($optExtensions) && in_array('ext_tags', $optExtensions)){ return true; }}return false; }function TIl1TTI($llIL1L1, $tableAlias){ if($this->mode == 'like'){ $llIL11I =$llIL1L1['index']; $llIL11l =array(); if(is_array($llIL11I)){ $llIL11L =min(sizeof($llIL11I), 3); for($i =0; $i <$llIL11L; $i++){ if(is_array($llIL11I[$i])){ $llIL111 =array(); foreach($llIL11I[$i] as $sFieldName){ $llIL111[] =(!empty($tableAlias) ?$tableAlias.'.' :I12506).$sFieldName; }if(sizeof($llIL111) >0){ $llIL11l[] ='concat('.implode('," ",', $llIL111).') as index_field'.($i+1); }}else{ $llIL11l[] =(!empty($tableAlias) ?$tableAlias.'.' :I12506).$llIL11I[$i].I12507.($i+1); }}}return implode(', ', $llIL11l); }else if($this->mode == 'fulltext'){ $llIL11I =$llIL1L1['index_fields']; $aFields =array(); if(is_array($llIL11I)){ foreach($llIL11I as $fieldName){ $aFields[] =(!empty($tableAlias) ?$tableAlias.'.' :I12506) .$fieldName; }}$result =I12506; if(sizeof($aFields) >0){ $result =I12508 .implode('," ",', $aFields) .') as index_field'; }else{ $result ='"" as index_field'; }return $result; }}function TIl1TTl($content){ $content =mb_strtolower($content); $content =preg_replace('/##--.*?--##/s', I12506, $content); $content =preg_replace(I12509, I12506, $content); $content =preg_replace('/##[a-z0-9_]+##/', I12506, $content); $content =preg_replace('/<[a-z\/].*?>/s', ' ', $content); $content =preg_replace('/&(?:nbsp|raquo|laquo|amp|quot|lt|gt|_039|_035|_037)/', I12510, $content); if($this->mode == 'fulltext'){ return $content; }$content =preg_replace('/[\r\n_ ]+/', '_', $content); $content =preg_replace('/[^a-zа-ялёА-ЯЛЁ0-9\.,&_-]/u', I12511, $content); $content =preg_replace('/_+/', I12510, $content); return '-'.$content.'-'; }function TIl1TT1($content, $length){ if((mb_strlen($content) >$length) && ($length >0)){ $content =mb_substr($content, 0, $length -3); if(mb_substr($content, $length-4) != " ") {$ind =mb_strrpos($content, I12512); if($ind !== false) {$content =mb_substr($content, 0, $ind); }$content =trim($content); $content .= '...'; }}return $content; }function TIl1TIT($announce){ $announce =preg_replace('/(##.*?##)|(<.*?>)/', I12506, $announce); return $this->TIl1TT1($announce, $this->llIL1l1); }function TIl1TII($announce){ return $this->TIl1Tl1($this->TIl1TT1($announce, 8192)); }function TIl1TIl($pageName, $itemName =I12506){ $name =$this->TIl1TT1($pageName, $this->llIL1ll); if(!empty($itemName)){ $name .= (empty($name) ?I12506 :' / ').$this->TIl1TT1($itemName, $this->llIL1lL); }return $name; }function TIl1TI1($llI1III, $lILIlIl, $llI1IIl =I12506){ if(!isFullLink($lILIlIl)){ if($this->cms->Core->GetOption("allow_multi_lang")){ $lILIlIl =$llI1III.I12513.$lILIlIl; }}$lILIlIl =_fmtHrefLink($lILIlIl.$llI1IIl, I12506); return $lILIlIl; }function TIl1TlT($content){ if(!preg_match('/<!--\{no_data\}-->/', $content) && !preg_match('/<!--\{!pageId_changed\}-->/', $content)){ $content =preg_replace('/<script(.*?)\/script>/si', I12506, $content); $content =preg_replace('/<style(.*?)\/style>/si', I12506, $content); $content =preg_replace('/<!--{exclude}-->(.*?)<!--{\/exclude}-->/si', I12506, $content); $llI1IIL =I12506; if(preg_match('/<title>(.*?)<\/title>/i', $content, $matches)){ $llI1IIL =$matches[1]; }$content =$this->TIl1TTl($llI1IIL.I12510.$content); }else{ $content =I12506; }return $content; }function TIl1TlI(&$llI1II1, $llILLlL, $llILLlI, $moduleName, $moduleData, $llILLLl, $itemId =0){ set_time_limit(29); $ILLILII =I12506; $llI1IlI =I12506; $llI1Ill =isset($moduleData['searchData']['hide_in_list']) ?$moduleData['searchData'][I12514] :'public_direct_link'; if($moduleName == 'forum'){ $llI1IlI =' order by t1.id_thread, t1.id'; }$llI1IlL =($moduleData['stopUseSublinks'] && ($moduleData[I12515] !== false)); $llI1Il1 =I12506; $llI1ILI =I12506; $llI1ILl ='t1'; if(isset($moduleData['searchData'][I12516]) && is_array($moduleData['searchData'][I12516]) && sizeof($moduleData['searchData'][I12516]) == 2){ $llIL1IL =&$this->cms->Core->GetModule($moduleData[I12517][I12516][0]); if($llIL1IL !== false){ $llI1ILl ='t2'; $llI1Il1 =', t2.id as id2'. ($llI1IlL ?', t2.sublink as sublink2' :I12506). (!empty($moduleData[I12518]) ?', t2.'.$moduleData[I12518].' as cat_details_noindex' :I12506); $llI1ILL =array(); if( $this->cms->Core->TTlI1IT($moduleData[I12517][I12516][0], "use_special_list_view") && ('admin' != $this->IlILIlL->side ?!$this->db->attr('multi_user') :TRUE) ){$llI1ILL[] ='(t2.' .$llI1Ill .I12519; }if(mb_strlen($moduleData[I12517]['public_field']) >0){ $llI1ILL[] ='(t2.'.$moduleData[I12517]['public_field'].'=1)'; }if(sizeof($llI1ILL) >0){ $llI1Il1 .= I12520.implode('&', $llI1ILL).', 1, 0) as cat_is_public'; }$llI1ILI =' LEFT JOIN '.$llIL1IL->GetTableName().' t2 ON t1.'.$moduleData[I12517][I12516][1].I12521; $llI1IL1 =$llIL1IL->TTlIIll(); }}$llI1I1I =array(); if($this->cms->Core->TTlI1IT($moduleName, "use_special_list_view")){ $llI1I1I[] ='(t1.' .$llI1Ill .I12519; }if(mb_strlen($moduleData[I12517]["public_field"]) >0){ $llI1I1I[] ='(t1.'.$moduleData[I12517][I12522].'=1)'; }$llI1I1l =false; if($this->cms->Core->issetModOption($moduleData[I12523], 'use_categories') && !$this->cms->Core->GetModOption($moduleData[I12523], "use_categories")){ $llI1I1l =true; }$llI1I1L =isset($moduleData[I12517]['date_modified']) ?$moduleData[I12517][I12524] :'modified_date'; $sql ='select t1.id as id, '.$ILLILII. $this->TIl1TTI($moduleData[I12517], 't1').', '. (!empty($moduleData[I12517]['robots_noindex_field']) ?'t1.'.$moduleData[I12517]['robots_noindex_field'] :'""').' as item_details_noindex, '. (!empty($moduleData[I12517][I12525]) ?'t1.'.$moduleData[I12517][I12525] :'""').' as title, '. (!empty($moduleData[I12517]['announce']) ?I12526.$moduleData[I12517]['announce'] :'""').' as announce'. ($llI1IlL ?', t1.sublink as sublink' :I12506). ($moduleData[I12527] ?', '.$llI1ILl.'.id_page as id_page' :I12506). ($llILLlI && $moduleData['multiSites'] ?', t1.id_site as id_site' :I12506). I12528 .$llI1I1L .' as modified_date'. ($moduleData['useTags'] ?', t1.tags as tags' :I12506). (sizeof($llI1I1I) >0 ?I12520.implode('&', $llI1I1I).', 1, 0) as is_public' :'1 as is_public'). $llI1Il1.I12510. 'from '.$moduleData['tableName'].' t1 '.$llI1ILI. I12529.$llILLlL.'"'.($itemId >0 ?' and t1.id='.$itemId :I12506).($moduleName == 'forum_cat' ?' and is_separator!=1' :I12506). $llI1IlI; $this->db->query($sql); while($this->db->next_record()){ set_time_limit(29); $this->TII1Il1(); if($llI1IlL){ $aNavData =array(); foreach($moduleData[I12515] as $llI1I11 => $llI1lII){ if($llI1lII == $moduleName){ if($moduleName == I12530 && $moduleData['listLayout'] != 'link_to_separate_page'){ }else{ $aNavData[$llI1I11.'_sublink'] =$this->db->Record['sublink']; $aNavData[$llI1I11] =$this->db->Record[I12531]; }}else{ $aNavData[$llI1I11.'_sublink'] =$this->db->Record['sublink2']; $aNavData[$llI1I11] =$this->db->Record['id2']; }}$this->cms->InitNavSettings($moduleData[I12523]); $llI1lIl =$this->cms->ApplyNav($aNavData); if($moduleName == 'forum'){ $llI1lIl[I12532] =rtrim($llI1lIl[I12532], '?').'?id_message='.$this->db->Record[I12531]; }else if($moduleName == I12530 && $moduleData['listLayout'] != 'link_to_separate_page'){ $llI1lIl[I12532] =rtrim($llI1lIl[I12532], I12533).'#q'.$this->db->Record[I12531]; }}else{ $llI1lIl[I12532] =I12506; $llI1lIl[I12532] .= preg_replace('/\[id2\]/', $this->db->Record['id2'], $moduleData[I12517]['script']); $llI1lIl[I12532] .= $this->db->Record[I12531]; }if(isset($this->db->Record[I12534]) && !$this->db->Record[I12534] && $llI1I1l){ $this->db->Record[I12534] =1; }$llI1lIL =array( 'active' => 0, 'public' => $this->db->Record["is_public"], 'cat_public' => isset($this->db->Record[I12534]) ?$this->db->Record[I12534] :I12535, 'lang' => $llILLlL, 'id_site' => (isset($this->db->Record["id_site"]) ?intval($this->db->Record["id_site"]) :-1), I12536 => (isset($this->db->Record["id_page"]) ?intval($this->db->Record["id_page"]) :-1), 'link' => $llI1lIl[I12532], 'noindex' => (!$moduleData[I12537] ?I12535 :(!empty($this->db->Record['cat_details_noindex']) ?$this->db->Record['cat_details_noindex'] :(!empty($this->db->Record['item_details_noindex']) ?$this->db->Record['item_details_noindex'] :I12538))), 'tags' => (isset($this->db->Record["tags"]) ?addslashes($this->db->Record["tags"]) :I12506), I12539 => $moduleName, 'id_item' => $this->db->Record[I12531], I12540 => isset($this->db->Record['id2']) ?$this->db->Record['id2'] :0, I12524 => $this->db->Record['modified_date'], 'name' => addslashes($this->db->Record[I12525]), I12541 => addslashes($this->TIl1TIT($this->db->Record[I12541])), 'announce_full' => $this->llIL1LI ?addslashes($this->TIl1TII($this->db->Record[I12541])) :I12506, );if($this->mode == 'like'){ $llI1lIL['f1'] =addslashes($this->TIl1TTl($this->db->Record['index_field1'])); $llI1lIL[I12542] =addslashes($this->TIl1TTl($this->db->Record['index_field2'])); $llI1lIL['f3'] =addslashes($this->TIl1TTl($this->db->Record['index_field3'])); }else if($this->mode == 'fulltext'){ $llI1lIL[I12543] =addslashes($this->TIl1TTl($this->db->Record['index_field'])); }foreach($moduleData['pagesData'] as $idPage => $IlL1IIl){ if($llI1lIL[I12536] == -1 || $llI1lIL[I12536] == 0 || $llI1lIL[I12536] == $idPage){ $llI1lI1 =$llI1lIL; $llI1lI1['link'] =addslashes($this->TIl1TI1($llI1lI1['lang'], $IlL1IIl[I12544], $llI1lI1['link'])); $llI1lI1['id_page'] =$idPage; $llI1lI1['id_page_main'] =intval($llILLLl[$idPage]); $llI1lI1['name'] =$this->TIl1TIl($IlL1IIl[I12545], $llI1lI1[I12545]); $llI1lI1['noindex'] =$IlL1IIl['page_noindex'] == I12535 ?I12535 :$llI1lI1['noindex']; $sql =$llI1II1->genInsertSQL($this->llILl1L, $llI1lI1, DBC_LOW_PRI); $llI1II1->query($sql); if($llI1lIL[I12536] == -1){ break; }}}}}function TIl1Tll(&$llI1II1, $llILLlL, $llILLlI, $moduleData, $llILLLl){ set_time_limit(29); $lILIIl1 =$this->cms->Core->GetOption('allow_multi_lang'); $llI1llI =$this->cms->Core->TTlI1T1(I12546, 'use_rel_alternate_hreflang'); $llI1lll =array_keys($moduleData['pagesData']); $sql =I12547. $this->TIl1TTI($moduleData[I12517], 't1').', '. (!empty($moduleData[I12517][I12525]) ?I12526.$moduleData[I12517][I12525] :I12548).' as title, '. (!empty($moduleData[I12517][I12541]) ?I12526.$moduleData[I12517][I12541] :I12548).' as announce'. ($llILLlI && $moduleData['multiSites'] ?', t1.id_site as id_site' :I12506). ', t1.last_changed as modified_date'. ', '.(mb_strlen($moduleData[I12517][I12522]) >0 ?'IF(t1.'.$moduleData[I12517][I12522].'=1, 1, 0)' :I12535) .'as is_public'. ($moduleData[I12549] ?', t1.tags as tags' :I12506).I12510. 'from '.$moduleData['tableName'].' t1 '. I12529.$llILLlL.I12550.implode(',', $llI1lll).')'; $this->db->query($sql); while($this->db->next_record()){ $llI1llL =(in_array($this->db->Record[I12539], $this->cms->Core->GetProperty('disabled_se_indexing_mods')) || $this->db->Record["page_noindex"]) ?I12535 :I12538; if(!$llI1llL){ $llI1llL =$moduleData[I12551][$this->db->Record["id"]]['seCalculatedNoindex']; }$llI1ll1 =0; if($lILIIl1){ $parentId =$moduleData[I12551][$this->db->Record[I12531]]['parent_id']; if(!$parentId && $llI1llI){ $llI1ll1 =1; }elseif($parentId && $moduleData[I12551][$this->db->Record[I12531]]['use_hreflang']){ $llI1ll1 =1; }}set_time_limit(29); $this->TII1Il1(); $llI1lI1 =array( I12552 => 0, 'public' => $this->db->Record["is_public"], 'cat_public' => I12535, 'lang' => $llILLlL, I12553 => (isset($this->db->Record["id_site"]) ?intval($this->db->Record["id_site"]) :-1), I12536 => '-1', 'link' => addslashes($this->TIl1TI1($llILLlL, preg_replace(I12554, $this->db->Record[I12544], $moduleData[I12517]['script']), I12506)), 'noindex' => $llI1llL ?I12535 :I12538, 'use_hreflang' => $llI1ll1, 'tags' => (isset($this->db->Record[I12555]) ?addslashes($this->db->Record[I12555]) :I12506), I12539 => I12546, 'id_item' => $this->db->Record[I12531], I12540 => !empty($this->db->Record[I12539]) && $this->db->Record[I12539] != I12546 ?1 :0, 'id_page' => $this->db->Record[I12531], 'id_page_main' => intval($llILLLl[$this->db->Record[I12531]]), I12524 => $this->db->Record['modified_date'], I12545 => $this->TIl1TIl($this->db->Record[I12525]), I12541 => addslashes($this->TIl1TIT($this->db->Record[I12541])), I12556 => $this->llIL1LI ?addslashes($this->TIl1TII($this->db->Record[I12541])) :I12506, );if($this->mode == 'like'){ $llI1lI1['f1'] =addslashes($this->TIl1TTl($this->db->Record['index_field1'])); $llI1lI1[I12542] =addslashes($this->TIl1TTl($this->db->Record['index_field2'])); $llI1lI1[I12557] =addslashes($this->TIl1TlT($this->db->Record['index_field3'])); }else{ $llI1lI1[I12543] =addslashes($this->TIl1TTl($this->db->Record['index_field'])); }$sql =$llI1II1->genInsertSQL($this->llILl1L, $llI1lI1, DBC_LOW_PRI); $llI1II1->query($sql); }}function reindexById($itemId, &$oModule, &$oDB, $llILLlL){ $llILLlI =$this->cms->Core->IsInstalled("srv_multi_sites"); $isMultiPageAllowed =$this->cms->Core->GetOption("multi_page_allowed"); $llILLll =$this->cms->Core->GetOption(I12558); $locale =$this->IlILIlL instanceof CMS_ActModule ?$this->IlILIlL->langData :AMI_Registry::get('lang_data', 'en'); $llILLl1 =$llILLll[$locale]; $moduleName =$oModule->GetName(); $pagesData =array(); if($moduleName == 'guestbook'){ return; }if(intval($itemId) <= 0){ return; }$sql ="SELECT id, parent_id, all_parents, script_link, name, module_name, page_noindex FROM cms_pages WHERE lang='$llILLlL' and public=1 and skip_search=0 and module_name='$moduleName' ORDER BY id asc"; $oDB->query($sql); $llILLLl =array(); while($oDB->next_record()){ set_time_limit(29); $llILLLl[$oDB->Record[I12531]] =$oDB->Record['all_parents']; if($this->TIll111($oDB->Record[I12544])){ $pagesData[$oDB->Record[I12531]] =$oDB->Record; }}foreach($llILLLl as $id => $llILL1L){ set_time_limit(29); $llILL11 =0; $llIL1II =explode(I12559, $llILL1L); for($pi =0; $pi <sizeof($llIL1II); $pi++){ if($llILL11 == 0 && $llIL1II[$pi] != 0){ $llILL11 =$llIL1II[$pi]; }if($llIL1II[$pi] == $llILLl1){ if(isset($llIL1II[$pi+1])) $llILL11 =$llIL1II[$pi+1]; }}$llILLLl[$id] =$llILL11; }$llILLLL =array(); if(sizeof($pagesData) >0 && $this->cms->Core->TTlI111($moduleName)){ set_time_limit(29); $searchData =$oModule->TTlIIll(); if($this->mode =='like' && isset($searchData['index']) || $this->mode =='fulltext' && isset($searchData['index_fields'])){ $llILLLL[$moduleName] =array( I12523 => $moduleName, I12560 => $oModule->GetTableName(), 'stopUseSublinks' => $oModule->issetAndTrueProperty("stop_use_sublinks"), I12515 => ($oModule->issetOption("stop_arg_names") ?$oModule->GetOption("stop_arg_names") :false), I12561 => ($isMultiPageAllowed && $oModule->issetAndTrueOption('multi_sites')), I12527 => $oModule->issetAndTrueOption('multi_page'), I12549 => $this->TIl1TTT($oModule), I12537 => (!in_array($moduleName, $this->cms->Core->GetProperty('disabled_se_indexing_mods'))) && ($oModule->issetOption("disable_se_indexing_pages") ?!in_array(I12562, $oModule->GetOption("disable_se_indexing_pages")) :true), I12517 => $searchData, I12518 => I12506, I12551 => $pagesData );if($moduleName == I12530){ $llILLLL[$moduleName]['listLayout'] =$oModule->GetOption("question_list_layout"); }if((!$oModule->IssetOption("use_categories") || $oModule->GetOption(I12563)) && isset($searchData[I12516]) && is_array($searchData[I12516]) && sizeof($searchData[I12516]) == 2){ if($this->cms->Core->TTlI111($searchData[I12516][0])){ $llIL1IL =&$this->cms->Core->GetModule($searchData[I12516][0]); $llIL1I1 =$llIL1IL->TTlIIll(); if($this->mode =='like' && isset($llIL1I1['index']) || $this->mode =='fulltext' && isset($llIL1I1['index_fields'])){ $llILLLL[$searchData[I12516][0]] =$llILLLL[$moduleName]; $llILLLL[$searchData[I12516][0]][I12560] =$llIL1IL->GetTableName(); $llILLLL[$searchData[I12516][0]][I12517] =$llIL1I1; $llILLLL[$searchData[I12516][0]][I12549] =$this->TIl1TTT($llIL1IL); $llILLLL[$searchData[I12516][0]][I12537] =(!in_array($searchData[I12516][0], $this->cms->Core->GetProperty('disabled_se_indexing_mods'))) && ($oModule->issetOption("disable_se_indexing_pages") ?!in_array('body_items', $oModule->GetOption("disable_se_indexing_pages")) :true); $llILLLL[$moduleName][I12518] =$llIL1I1['robots_noindex_field']; }}}}}$db =new DB_si; foreach($llILLLL as $moduleName => $moduleData){ $this->TIl1TlI($db, $llILLlL, $llILLlI, $moduleName, $moduleData, $llILLLl, $itemId); $sql =I12564 .$this->llILl1L .I12565.$moduleName."' and id_item='".$itemId."'"; $oDB->query($sql); $sql ="update low_priority " .$this->llILl1L .I12566.$moduleName."' and id_item='".$itemId.I12567; $oDB->query($sql); }if(checkProbability(0.015)){ $query ="OPTIMIZE TABLE " .$this->llILl1L; $this->db->query($query); }}function publishById($itemId, &$oModule, &$oDB, $llILLlL){ $llILLlI =$this->cms->Core->IsInstalled("srv_multi_sites"); $isMultiPageAllowed =$this->cms->Core->GetOption("multi_page_allowed"); $llILLll =$this->cms->Core->GetOption(I12558); $llILLl1 =$llILLll[$llILLlL]; $moduleName =$oModule->GetName(); $pagesData =array(); if($moduleName == 'guestbook'){ return; }$isCatModule =false; if(preg_match(I12568, $moduleName, $aMatches)){ $isCatModule =true; $llI1lLI =$aMatches[1]; if(in_array($llI1lLI, array('eshop', 'po', 'kb'))){ $llI1lLI .= '_item'; }}$sql ="select public from " .$this->llILl1L .I12569.$moduleName."' and id_item='".$itemId.I12567; $llI1lLl =$this->db->getValue($sql) == I12535; $sql ="update " .$this->llILl1L ." set public=".($llI1lLl ?I12538 :I12535).I12569.$moduleName."' and id_item='".$itemId.I12567; $this->db->query($sql); if($isCatModule){ $sql =I12570 .$this->llILl1L ." set cat_public=".($llI1lLl ?I12538 :I12535).I12569.$llI1lLI."' and id_cat='".$itemId.I12567; $this->db->query($sql); }}function deleteFromIndexById($itemId, $moduleName){ if($moduleName == 'guestbook'){ return; }$sql =I12564 .$this->llILl1L .I12569.$moduleName."' and id_item='".$itemId.I12567; $this->db->query($sql); if(checkProbability(0.015)){ $query =I12571 .$this->llILl1L; $this->db->query($query); }}protected function TIl1Tl1($input){ $opened =array(); if(preg_match_all("/<(\/?[a-z]+)>?/i", $input, $matches)){ foreach($matches[1] as $tag){ if(preg_match("/^[a-z]+$/i", $tag, $regs)){ if(strtolower($regs[0]) != 'br'){ $opened[] =$regs[0]; }}elseif(preg_match("/^\/([a-z]+)$/i", $tag, $regs)){ unset($opened[array_pop(array_keys($opened, $regs[1]))]); }}}if($opened){ $llI1lLL =array_reverse($opened); foreach($llI1lLL as $tag) $input .= I12572 .$tag .'>'; }return $input; }}