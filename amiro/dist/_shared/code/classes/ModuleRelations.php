<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       30139 xkqwzsmiqwtgkrlygtzxnmztymlyngrkrwplgwsykytswnqyxittxrkkysstuwuuspznpnir
 */ ?><?php foreach(array(12573=>'WOQWK|GuYJMW',12574=>'rQIHvQ',12575=>'HYLQWtiHSuJQ',12576=>'',12577=>'fJt|IHSuJQ',12578=>'SQfZuJt|IHSuJQ|fMJtQr',12579=>"dqjqwT?.rQJZtQS|IHSuJQ.!?.rQJZtQS|HYLQWtD.?FRhi?.WID|rQJZtMHnD.?coqRq?.IHSuJQ.?=?'",12580=>'rQJZtQS|HYLQWtD',12581=>'rQJZtQS|IHSuJQ',12582=>'PrG|IHvQ',12583=>'SZtQtH',12584=>'OMSSQn',12585=>'IHSuJQ',12586=>'|LD~ZIM`ZSIMn`LD',12587=>"DWrMGtD",12588=>'DQJQWtQS|HYLQWtD',12589=>"?coqRq?MS?mN?}",12590=>'IHSuJQNZIQ',12591=>'ZnnHunWQ',12592=>'Hff',12593=>'rQJZtMHnD|nuIYQr',12594=>"{",12595=>'hRsqR?yb?nZIQ?zdw',12596=>'?',12597=>"vZJuQ",12598=>"Hff",12599=>'DMAQ',12600=>"HffDQt",12601=>"?zNs?JZnP='",12602=>'tZrPQtiHSuJQ',12603=>'QxtQnDMHnD',12604=>'DIZJJ|SMDGJZB|IHSuJQD',12605=>'|',12606=>'MS|WZt',12607=>'WZt',12608=>"?zNs?rQJZtQS|IHSuJQ?mN?}'",12609=>"'!'",12610=>'rQJZtMvQ|IHSuJQ',12611=>'YHSB|DIZJJ',12612=>'LHMn',12613=>'DuYJMnK',12614=>'DQJQWt',12615=>"mNNqR?lhmN?",12616=>'M`',12617=>"{?zNs?M`.JZnP.?=?'",12618=>'MS|WZtQPHrB',12619=>' ',12620=>'WZt|MS|GZPQ',12621=>'ftGPQtfMJQ`GOG IHSuJQ=fMJQD]MS=',12622=>'MS',12623=>"[",12624=>"sqdwRmyq?",12625=>"''",12626=>'OQZSQr',12627=>"sqjqTq?FRhi?.WID|rQJZtMHnD.?coqRq?.IHSuJQ.?=?'",12628=>'MS|HYLQWt',12629=>'GHDDMYJQ|IHSuJQD|JMDt',12630=>'Qxt|rQJZtMHnD',12631=>'WZGtMHn',12632=>'nZIQ',12633=>'vZJuQ') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleRelations extends CMS_ActModule {public $llI1lL1; public $llI1l1I; public $llI1l1l; public $llI1l1L; public $llI1l11; public $llI1LII; function ModuleRelations(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); }function _Init($IIll1l1 =Array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =Array()) {$IIIIL11[I12573] =false; $IIIIL11['group_operations'] =array ('move'); $IIIIL11['allowed_actions'] =array ('move', I12574); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin() {parent::_InitAdmin(); $this->llI1lL1 =isset($this->cms->Vars['objectId']) ?intval($this->cms->Vars['objectId']) :0; $this->llI1l1l =isset($this->cms->Vars[I12575]) ?(string)($this->cms->Vars[I12575]) :''; if (empty($this->cms->Vars['popup'])) {return; }if (!$this->llI1lL1 || $this->llI1l1l == I12576 || !$this->cms->Core->IsInstalled($this->llI1l1l)) {$this->cms->AddMessages($this->cms->Gui->ParseLangFile('templates/lang/_relations_msgs.lng')); $this->cms->AddStatusMsg('status_invalid_object', 'red'); die($this->cms->GetStatusMessages()); }$this->llI1l1L =isset($this->cms->Vars[I12577]) ?$this->cms->Vars[I12577] :$this->module->GetOption(I12578); if ($this->cms->Core->IsInstalled($this->llI1l1L)) {$this->llI1l11 =&$this->cms->Core->GetModule($this->llI1l1L); }else {$this->llI1l11 =null; }$this->llI1LII =array ();$sql =I12579 .$this->llI1l1l ."' AND `id_object` = " .$this->llI1lL1; $rs =&$this->db->select($sql); $llI1LIl =false; while ($record =$rs->nextRecord()) {$relatedObjects =trim($record[I12580], ','); if ($this->cms->Core->IsInstalled($record[I12581]) && preg_match('/^(\d+\,){0,}\d+$/', $relatedObjects)) {$this->llI1LII[$record[I12581]] =explode(',', $relatedObjects); }else {$llI1LIl =true; }}if ($llI1LIl) {$this->TIl1T1I(); }}function TTTlITT($IIIL11l, $cId, $cModule =I12576) {$id =intval($cId); switch ($IIIL11l) {case 'move': $this->_ActionMove($cId, $cModule); break; case I12574: $this->TIIlTTT($cId, $cModule); break; case I12582: $this->TIII111($this->aGroupIds, $cModule); break; default: parent::TTTlITT($IIIL11l, $cId, $cModule); break; }}function TIII111(&$aGroupIds, $cModule) {$this->TTTl1II($aGroupIds, $cModule, '_ActionMove', 'status_grp_move'); }function TTTlIII() {if($this->filter->issetField('datefrom')){ $this->filter->TITI1l1('datefrom'); }if($this->filter->issetField(I12583)){ $this->filter->TITI1l1(I12583); }$this->filter->IL11l1L =array('limit'); parent::TTTlIII(); $this->filter->AddField('popup', 'hidden', 1); $this->filter->AddField('objectId', I12584, $this->llI1lL1); $this->filter->AddField(I12575, I12584, $this->llI1l1l); $llI1LIL =$this->TIllI1l(); $aModules =array ();foreach ($llI1LIL as $module => $caption) {$aModules =$this->filter->TITI1TT($aModules, array ($caption => $module), 64); }$this->filter->AddField(I12577, 'select', $this->llI1l1L, I12576, '=', I12585, $aModules); $this->filter->TITIll1(I12577); }function TTTlIl1() {$this->filter->DisableFieldSQL(I12577); $res =parent::TTTlIl1(); $this->filter->TITI1lT(I12577); return $res; }function &TTTlI1T(&$aCustom) {$data =parent::TTTlI1T($aCustom); $this->cms->Gui->delScript(); $this->cms->Gui->addScript("jsapi.php"); $this->cms->Gui->addScript($GLOBALS['CURRENT_SKIN_PATH'].I12586); $data["js_relations"] =$this->cms->Gui->get($this->moduleName .':js_relations', $data); $data["selected_objects_list"] =$this->cms->Gui->get($this->moduleName.":selected_objects_list", $data); $data[I12587] =$this->cms->Gui->getScripts(); $data["metas"] =$this->cms->Gui->getMetas(); $data["status"] =$this->cms->GetStatusMessages(); global $conn; print $this->cms->Gui->get($this->moduleName, $data); $conn->Out(); die; }function TTTlI1I(&$vData) {$vData['relations_number'] =0; $vData['objectId'] =$this->llI1lL1; $vData[I12575] =$this->llI1l1l; parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {$llI1LI1 =true; if (sizeof($this->llI1LII) >0) {$captions =$this->TIllI1l(); $count =0; $vData[I12588] =I12576; foreach (array_keys($this->llI1LII) as $moduleName) {$ids =implode(',', $this->llI1LII[$moduleName]); if ($this->cms->Core->IsInstalled($moduleName) && preg_match('/^(\d+\,){0,}\d+$/', $ids)) {$module =&$this->cms->Core->GetModule($moduleName); $ILLILlL =$this->TIl1T1T($module); $sql ="SELECT id, public, " .$ILLILlL ." FROM " .$module->GetTableName() .I12589 .$ids .")"; $rs =&$this->db->select($sql); while ($record =$rs->nextRecord()) {$count++; $record[I12585] =$captions[$moduleName]; $record[I12590] =$moduleName; $record['name'] =$this->cms->stripLine($record['name'], 80); $record['announce'] =$this->cms->stripLine($record[I12591], 250); $record['public'] =$this->cms->Gui->getAbs($this->moduleName ."_list:icon_public_" .($record['public'] ?'on' :I12592), I12576); $vData[I12588] .= $this->cms->Gui->get($this->moduleName.":selected_row", $record); }}else {unset($this->llI1LII[$moduleName]); }}if (sizeof($this->llI1LII)) {$vData['selected_objects_header'] =$this->cms->Gui->getAbs($this->moduleName .':selected_objects_header', I12576); $vData['relations_number'] =$rs->numRows(); $llI1LI1 =false; $vData[I12593] =$count; }}if ($llI1LI1) {$vData["selected_objects"] =$this->cms->Gui->getAbs($this->moduleName.":selected_objects_list_empty"); }if (is_object($this->llI1l11)) {$ILLILlL =$this->TIl1T1T($this->llI1l11); $filter =array (1); if (!empty($this->llI1LII[$this->llI1l1L])) {$filter[] ="`id` NOT IN (" .implode(',', $this->llI1LII[$this->llI1l1L]) .I12594; }$this->browser->InitSQL( "id, `public`, " .$ILLILlL, "FROM " .$this->llI1l11->GetTableName(), "WHERE " .implode(' AND ', $filter) .$this->_ApplyFilters() .$this->TTTlIl1() );$this->browser->SetForceRules(I12595); }else {$this->browser->InitSQL("1 ", "FROM `cms_relations`","WHERE 0"); $this->browser->SetForceRules(' ', I12596); }$aCustom['fields'] =array ("public" => array ("action"=>"flagicon", I12597=>1, "id"=>"pub_id", "on"=>$this->moduleName."_list:icon_public_on",I12598=>$this->moduleName."_list:icon_public_off"), 'name' => array ('action' => 'stripline', I12599 => 80), I12591 => array ('action' => 'stripline', I12599 => 250) );$aCustom['applied_id'] ='id'; if (is_object($this->filter)) {$this->filter->UpdateField(I12600, $this->browser->Position); $aCustom['list_data']['filter_hidden_fields'] =$this->filter->GetFieldsAsHidden(); }if (isset($this->llI1LII[$this->llI1l11->Name]) && in_array($this->appliedId, $this->llI1LII[$this->llI1l11->Name])) {$this->appliedId =0; }parent::TTTlI11($vData, $aCustom); }function _ActionMove($cId, $cModule) {if (is_object($this->llI1l11)) {$llI1LlI =empty($this->llI1LII[$this->llI1l11->Name]) ?array ():$this->llI1LII[$this->llI1l11->Name]; $sql ="SELECT 1 FROM " .$this->llI1l11->GetTableName() ." WHERE id = " .$cId .I12601.$this->langData."'"; if (!in_array($cId, $llI1LlI) && $this->db->getValue($sql)) {$this->llI1LII[$this->llI1l11->Name][] =$cId; $this->TIl1T1I(); $this->cms->AddStatusMsg('status_add_to_list'); $this->appliedId =$cId; }}}function TIIlTTT($cId, $cModule) {$cId =intval($cId); $llI1Lll =$this->cms->Vars[I12602]; if (isset($this->llI1LII[$llI1Lll]) && in_array($cId, $this->llI1LII[$llI1Lll])) {unset($this->llI1LII[$llI1Lll][array_search($cId, $this->llI1LII[$llI1Lll])]); $this->TIl1T1I(); $this->cms->AddStatusMsg("status_remove_from_list"); }}function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {if(!$this->llI1l1l){ $this->llI1l1l =AMI_Registry::get('page/modId', null); if($this->llI1l1l && AMI::issetOption($this->llI1l1l, I12603)){ $aExt =AMI::getOption($this->llI1l1l, I12603); if(is_array($aExt) && in_array('ext_relations', $aExt)){ $this->llI1lL1 =AMI_Registry::get('page/itemId', $this->llI1lL1); $this->llI1l1I =AMI_Registry::get('page/catId', $this->llI1l1I); }}}$specBlockName =$this->module->GetProperty('active_spec_blocks'); $this->cms->Core->Cache->TT1Tl1l($specBlockName); $llI1LlL =$this->module->GetOption(I12604); $hash =$this->llI1lL1 .I12605 .$this->llI1l1I .I12605 .$this->llI1l1l .I12605 .$this->module->GetOption('source'); foreach ($llI1LlL as $h) {$hash .= I12605 .$h; }$this->cms->Core->Cache->TT1TI1l('relations', $hash, $specBlockName); $this->cms->Core->Cache->TT1TI1T($specBlockName .'_hash', $hash); if (!sizeof($llI1LlL)) {return; }$llI1Ll1 =$this->llI1l1l; if (!$this->llI1l1l) {$aData =$this->cms->Core->Cache->TT1TlTl($specBlockName); if (is_array($aData)) {$this->llI1lL1 =$aData['id']; $this->llI1l1I =isset($aData[I12606]) ?$aData[I12606] :0; $llI1Ll1 =$this->llI1l1l =$aData[I12585]; }}if (!$this->llI1lL1 && $this->llI1l1l != I12576 && $this->module->GetOption('source') == 'cat') {$vMod =$this->cms->Core->GetModule($this->llI1l1l); $I1LIL1I =$vMod->GetSubModules(); foreach (array_keys($I1LIL1I) as $moduleName) {if (mb_substr($moduleName, -4) == '_cat') {$this->llI1l1l =$moduleName; break; }}}if (($this->llI1lL1 || ($this->module->GetOption('source') == I12607 && $this->llI1l1I)) && $this->llI1l1l != I12576) {$aData =array ($specBlockName => array ('id' => $this->llI1lL1, I12606 => $this->llI1l1I, I12585 => $llI1Ll1)); $this->cms->Core->Cache->TT1TlTI($aData, $specBlockName); if(!$this->llI1lL1) {$this->llI1lL1 =$this->llI1l1I; }$aDefault =array ();$aDefault['simple_set_fields'] =array ('name', I12591); $aCustom += $aDefault; $rows =array ();$llI1LLI =in_array('all', $llI1LlL) ?I12576 :I12608 .implode(I12609, $llI1LlL) ."')"; $llI1LLl =$this->module->GetOption('source') == I12607 && $this->llI1lL1 != $this->llI1l1I; if($llI1LLl){ $tmp =array($this->llI1lL1, $this->llI1l1l); $this->llI1lL1 =$this->llI1l1I; $data =$this->cms->Core->GetModule($this->llI1l1l)->TTlIIll(I12610); if(is_array($data)){ $this->llI1l1l =$data[0]; }}$sql =I12579 .$this->llI1l1l ."' AND `id_object` = " .$this->llI1lL1 .$llI1LLI; if($llI1LLl){ list($this->llI1lL1, $this->llI1l1l) =$tmp; unset($tmp); }$rs =&$this->db->select($sql); $vData =array ('active_item_type' => I12611); while ($record =$rs->nextRecord()) {if ($this->cms->Core->IsInstalled($record[I12581])) {$ids =trim($record[I12580], ','); if (preg_match('/^(\d+\,){0,}\d+$/', $ids)) {$oModule =$this->cms->Core->GetModule($record[I12581]); $oModule->InitEngine($this->cms, $this->db); $oModule->Engine->Init(); $oModule->Engine->cms->InitNavSettings($oModule->Engine->options['stop_arg_names_mod_name']); $IIl1ll1 =array ('select' => I12576, I12612 => I12576, 'where' => I12576); $llI1LLL =$record[I12581] != 'files' && (!empty($oModule->Engine->I1LII1I) || mb_substr($record[I12581], -5) == '_item'); if ($llI1LLL) {$IIl1l1l =array ('cat_sublink' => I12613, 'cat_id_page' => 'id_page'); if (empty($oModule->Engine->I1LII1I)) {$llI1LL1 ='id_category'; $llI1L1I =&$this->cms->Core->GetModule($oModule->Engine->oEshop->ownerName .'_cat'); $IIl1ll1[I12614] =',' .$this->TIl1T1T($llI1L1I, 'c.', $IIl1l1l, false); $IL1Ll1I =$llI1L1I->GetTableName(); }else {$IIl1ll1[I12614] =',' .$this->TIl1T1T($oModule->Engine->IlIllI1->IILI1LI, 'c.', $IIl1l1l, false); $llI1LL1 =$oModule->Engine->IlIllI1->IILLL1I; $IL1Ll1I =$oModule->Engine->IlIllI1->IILLLl1; }$IIl1ll1[I12612] =I12615 .$IL1Ll1I ." c ON c.id = i." .$llI1LL1 .I12596; $IIl1ll1['where'] =" AND c.public = 1"; }$IIl1l1l =array (I12613, 'id_page'); if ($llI1LLL) {$IIl1l1l[] =$llI1LL1; }$ILLILlL =$this->TIl1T1T($oModule, I12616, $IIl1l1l); $sql ="SELECT i.id, " .$ILLILlL .$IIl1ll1[I12614] ." FROM " .$oModule->GetTableName() ." i " .$IIl1ll1[I12612] ."WHERE i.id IN (" .$ids .I12617 .$this->langData ."' AND i.`public` = 1" .$IIl1ll1['where']; $rs1 =&$this->db->select($sql); while ($aItem =$rs1->nextRecord()) {if ($record[I12581] != 'files') {if (isset($aItem['id_category'])) {$aItem[I12606] =$aItem[I12618]; }if (mb_substr($record[I12581], -4) == '_cat') {$aItem['nav_data'] ='/' .$aItem[I12613]; }else {$oModule->Engine->_GetNavDataCB($aItem, $vData); if (mb_substr($aItem['nav_data'], -1, 1) == I12619) {$aItem['nav_data'] =mb_substr($aItem['nav_data'], 0, -1); }}if ($oModule->HaveParent()) {$llI1L1l =&$oModule->TTlIIIT(); }else {$llI1L1l =$oModule; }if (isset($aItem['cat_id_page'])) {$aItem['id_page'] =$aItem[I12620]; }$aItem['nav_data'] =$llI1L1l->GetFrontLink($aItem['id_page']) .$aItem['nav_data']; }else {$aItem['nav_data'] =I12621 .$aItem[I12622]; }$aItem[I12585] =$record[I12581]; foreach (array ('name', I12591) as $field) {$setName =$this->moduleName .'_list:small_' .$aItem[I12585] .I12605 .$field; if ($this->cms->Gui->issetSet($setName)) {$aItem[$field] =$this->cms->Gui->get($setName, $aItem); }}$rows[] =$aItem; }$oModule->Engine =false; }}}$db =clone($this->db); require_once $GLOBALS['CLASSES_PATH'] .'CMS_IteratorArray.php'; $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray($rows); $this->db->IlI1Lll =sizeof($rows); $this->db->IIIll1L =false; $this->browser->InitSQL(I12623, "FROM xxx", "WHERE 1"); $this->browser->SetForceRules(I12596, I12596); parent::TTTll1I($vRes, $aCustom, $cType, $IIlLlII); $this->db =$db; }else{ $vRes['body'] =I12576; }}function TIl1T1T( CMS_Module &$oModule, $prefix =I12576, array $IIl1l1l =array(), $llI1L1L =TRUE ){$ILLILlL =array(); $llI1L11 =array(); $fields =array(); $modId =$oModule->Name; if($oModule->issetProperty('engine_classes')){ $oModule->InitEngine($this->cms, $this->db); if($llI1L1L){ $oModule->Engine->Init(); }$sql =I12624 .$oModule->GetTableName(); $rs =&$this->db->select($sql); while($record =$rs->nextRecord()){ $llI1L11[] =$record['Field']; }if($llI1L1L){ $llI11II =array('name', I12591); foreach($llI11II as $field){ if(in_array($oModule->Engine->options[$field .'_field_name'], $llI1L11)){ $fields[$field] =$oModule->Engine->options[$field .'_field_name']; }}foreach($llI11II as $field){ $ILLILlL[] =(isset($fields[$field]) ?$prefix .$fields[$field] :I12625) ." " .$field; }}}elseif(AMI::isResource($modId .'/table/model')){ $oTable =AMI::getResourceModel($modId .'/table'); $llI1L11 =$oTable->getAvailableFields(); if($llI1L1L){ $llI11II =array('name' => I12626, I12591 => I12591); foreach($llI11II as $field => $apiField){ if($oTable->hasField($apiField)){ $fields[$field] =$apiField; }}foreach(array_keys($llI11II) as $field){ $ILLILlL[] =(isset($fields[$field]) ?$prefix .$fields[$field] :I12625) ." " .$field; }}}foreach ($IIl1l1l as $key => $field) {if(in_array($field, $llI1L11)){ $ILLILlL[] =$prefix .$field .(is_numeric($key) ?I12576 :I12596 .$key); }}return implode(', ', $ILLILlL); }function TIl1T1I() {$sql =I12627 .$this->llI1l1l ."' AND `id_object` = " .$this->llI1lL1; $this->db->execute($sql); foreach (array_keys($this->llI1LII) as $module) {$ids =$this->llI1LII[$module]; if (sizeof($ids)) {$sql =$this->db->genInsertSQL('cms_relations', array (I12585 => $this->llI1l1l, I12628 => $this->llI1lL1, I12581 => $module, I12580 => ',' .implode(',', $ids) .',' ));$this->db->execute($sql); }else {unset($this->llI1LII[$module]); }}}function TIllI1l() {static $aModules; if (!is_array($aModules)) {$aLang =$this->cms->Gui->ParseLangFile('templates/lang/_menu_all.lng'); $possibleModules =$this->module->GetProperty(I12629); $supportedModules =array_keys(AMI_Ext::getSupportedModules(I12630)); $modules =array_merge($possibleModules, $supportedModules); $aModules =AMI_Service_Adm::getModulesCaptions($modules, TRUE, array(), FALSE, TRUE); }return $aModules; }function ruleSmallDisplayModulesCB($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ='getallvalues') {static $aModules; switch($IIL1l1I){ case 'getallvalues': if (!is_array($aModules)) {$aModules =$this->TIllI1l(); }$res =array (array ('name' => 'all', I12631 => $this->words['all'], 'selected' => intval(in_array('all', $cData['value'])) ));foreach ($aModules as $module => $caption) {$res[] =array (I12632 => $module, I12631 => $caption, 'selected' => intval(in_array($module, $cData['value'])) );}break; case 'correctvalue': break; case 'getvalue': $res =$cData[I12633]; break; }return true; }function TIl1T1l($module, $id, $categoryId =0) {$this->llI1lL1 =(int)$id; $this->llI1l1I =(int)$categoryId; $this->llI1l1l =(string)$module; }}