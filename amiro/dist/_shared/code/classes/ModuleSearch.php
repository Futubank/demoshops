<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       27820 xkqwxnswttytuqmzmtwkurntzzpqkzlrugyiqupigkpsmlttyxwgliwpzglrxpslptxtpnir
 */ ?><?php foreach(array(12634=>"",12635=>'ZSIMn',12636=>'WZGtMHn',12637=>'=',12638=>"fJt|GZPQD",12639=>"WOQWKYHx",12640=>"fJt|EuQrB",12641=>"SZtQtH",12642=>"OMSSQn",12643=>"SY",12644=>"?",12645=>"uGSZtQ|SZtQ?SQDW",12646=>"HYLQWt",12647=>"DtrMGJMnQ",12648=>"vZJuQ",12649=>"Hff",12650=>"SQJ|MS",12651=>"JQPQnS",12652=>'frHnt|JMnK',12653=>'',12654=>'!',12655=>"FUjj|FhRi",12656=>"WrQZtQ|SZtQ",12657=>"EuQrB",12658=>"DQZrWO|GZPQD",12659=>"frHnt|JMnK",12660=>"'",12661=>'EuZntMtB',12662=>"GZPQD",12663=>'WJZDDMfMQSD',12664=>'QDOHG|MtQI',12665=>"DQJQWt?MS!?nZIQ!?IHSuJQ|nZIQ?frHI?WID|GZPQD?COQrQ?JZnP='",12666=>'MS',12667=>'IHSuJQ|nZIQ',12668=>'?}',12669=>'IHSuJQ',12670=>"?ZnS?IHSuJQ|nZIQ='GZPQD'?Hr?IHSuJQ|nZIQ?Mn?}'",12671=>"'!'",12672=>'GZPQD',12673=>"PQtZJJvZJuQD",12674=>'ZJJ',12675=>'MD|ZSvZnWQS',12676=>'nZIQ',12677=>'ZJJ|IHSuJQD',12678=>'SMDZYJQS',12679=>'GZPQ|fMQJSD',12680=>'DQZrWO',12681=>'MD|ZSvZnWQS|DQZrWO',12682=>"|JMDt%DIZJJ|YJHWK",12683=>"MtQI|",12684=>"CHrSD",12685=>'DGZPQ',12686=>'rQS',12687=>'IHSQ',12688=>'ZWtMvQ=1',12689=>'ZqxWJuSQSgZPQD',12690=>'?zNs?}IHSuJQ|nZIQ,="GZPQD"?hR?MS|WZt=0{?zNs?}MS|GZPQ?Mn?}',12691=>'{?ZnS?IHSuJQ|nZIQ="GZPQD"{',12692=>'{{',12693=>"DGZPQ",12694=>"rQJ",12695=>"ZWtMHn",12696=>'CHrS',12697=>"MPnHrQS|CHrSD",12698=>'DQZrWO|IHSuJQ|SZtZ',12699=>'JZnP',12700=>'0') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleSearch extends CMS_ActModule {public $llI11Il; public $llI11IL; public $llI11I1; function ModuleSearch(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->cms->Gui->AddGlobalVars(Array("FULL_FORM"=>"0")); $this->llI11Il =null; $this->llI11IL =false; $this->llI11I1 =array(); }function _Init($IIll1l1 =Array(), $IIll1LI =I12634, $IIll1Ll =I12634, $aOptions =Array()) {$IIIIL11["use_options_form"] =true; $IIIIL11["check_public"] =false; $IIIIL11["group_operations"] =Array('del'); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); if($this->side == I12635){ $this->llI11I1 =$this->getSearchPages(true); }}function _InitAdmin() {parent::_InitAdmin(); $this->module->SetTableName('search_history'); }function TTTlIII() {parent::TTTlIII(); $llI11lI =$this->cms->Vars["flt_pages"]; if(!is_array($llI11lI)){ $llI11lI =array(0); }$aPages =array(); $aPages =$this->filter->TITI1TT($aPages, array($this->words['all'] => '0'), 50); for($i =0; $i <sizeof($this->llI11I1); $i++){ $aPages =$this->filter->TITI1TT($aPages, array($this->llI11I1[$i][I12636] => intval($this->llI11I1[$i]['name'])), 50); }$this->filter->AddField("flt_pages", "select", $llI11lI, '0', I12637, 'id', $aPages, 1, 3); if(is_array($llI11lI) && sizeof($llI11lI) >0 && !in_array(0, $llI11lI)){ $aFilter =array(); for($i =0; $i <sizeof($llI11lI); $i++){ $aFilter[] ='FIND_IN_SET("'.intval($llI11lI[$i]).'", pages) > 0'; }$aFilter[] ='FIND_IN_SET("0", pages) > 0'; $this->filter->TITI1II(I12638, ' OR '.implode(' OR ', $aFilter), "force"); }else{ $this->filter->DisableFieldSQL(I12638); }$this->filter->AddField("flt_query_group", I12639, !empty($this->cms->Vars['flt_query_group'])); $this->filter->MoveField("flt_query_group",_MOVE_START); $this->filter->AddField("flt_query", "text", stripslashes(unhtmlentities($this->cms->Vars[I12640])), I12634, " like ", "query"); $this->filter->MoveField(I12640,_MOVE_START); $this->filter->UpdateFieldDBName("datefrom", "update_date"); $this->filter->UpdateFieldDBName(I12641, "update_date"); $this->filter->MoveField(I12641,_MOVE_START); $this->filter->MoveField("datefrom",_MOVE_START); }function TTTlII1($IIlLlL1 =I12634) {parent::TTTlII1($IIlLlL1); if ($IIlLlL1 === "body_items") {$this->filter->AddField("words", I12642, isset($this->cms->Vars['words']) ?stripslashes(unhtmlentities($this->cms->Vars['words'])) :null); }}function TTTlI11(&$vData, &$aCustom) {$llI11ll =!empty($this->cms->Vars['flt_query_group']); $this->browser->InitSQL("id, query, front_link, date_format(create_date,'".$this->cms->DFMT[I12643]."') as cdate, date_format(update_date,'".$this->cms->DFMT[I12643]."') as udate, ".($llI11ll ?'sum(quantity) ' :'')."quantity, count_pages, ".($llI11ll ?'count(id)' :'1')." as inner_count ", "FROM " .$this->module->GetTableName() .I12644, "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), ($llI11ll ?'query' :''), "update_date", I12645 );$aCustom["fields"] += Array( "id"=>Array("action"=>"callback", I12646=>&$this, "method"=>"_GetFrontLinkCB"), "query"=>Array("action"=>I12647, "size" => 40), "action_view"=>Array("action"=>"flagicon", I12648=>I12634, "id"=>"view_id", "on"=>$this->moduleName."_list:view",I12649=>I12634), "action_del"=>Array("action"=>"flagicon", I12648=>I12634, "id"=>I12650, "on"=>$this->moduleName."_list:del",I12649=>I12634), );$aCustom["applied_id"] ="id"; $aCustom[I12651] =Array("leg_view", "leg_del"); $aCustom["form_data"]["buttons"] =Array(); parent::TTTlI11($vData, $aCustom); }function _GetFrontLinkCB(&$Item, &$vData){ if($Item[I12652] != '' && $Item['inner_count'] == 1){ $Item[I12652] =$GLOBALS['ROOT_PATH_WWW'].$Item[I12652]; }if($Item['inner_count'] >1){ $Item[I12652] =I12653; $Item['count_pages'] ='--'; }$Item['query_escaped'] =addslashes($Item['query']); }function TIl1T11($llI11lL, $llI11l1){ $pagesList =I12653; $llI11LI =explode(I12654, $llI11lL); if(!in_array(0, $llI11LI)){ for($i =0; $i <sizeof($llI11LI); $i++){ if(isset($llI11l1[$llI11LI[$i]])){ if(!empty($pagesList) >0){ $pagesList .= $this->cms->Gui->getAbs($this->moduleName.'_subform:search_pages_splitter'); }$pagesList .= $llI11l1[$llI11LI[$i]]; }}}if(empty($pagesList)){ $pagesList =$this->words['all']; }return $pagesList; }function TTTll1l($cId, $cModule) {parent::TTTll1l($cId, $cModule); $llI11l1 =array(); for($i =0; $i <sizeof($this->llI11I1); $i++){ $llI11l1[intval($this->llI11I1[$i]['name'])] =$this->llI11I1[$i][I12636]; }$sql ="SELECT id, query, date_format(create_date,'".$this->cms->DFMT[I12643]."') as cdate, date_format(update_date,'".$this->cms->DFMT[I12643]."') as udate, quantity, count_pages, pages, front_link". " from ".$this->module->GetTableName(). " where id='".$cId."'".$this->_ApplyFilters();; $this->db->query($sql); if($this->db->next_record()) {$this->cms->Gui->AddGlobalVars(Array(I12655=>"1")); $this->IIllIlI =$this->db->Record["id"]; $this->itemData["id"] =$this->db->Record["id"]; $this->itemData[I12656] =$this->db->Record["cdate"]; $this->itemData["update_date"] =$this->db->Record["udate"]; $this->itemData["query"] =$this->cms->htmlchars($this->db->Record[I12657]); $this->itemData["quantity"] =$this->db->Record["quantity"]; $this->itemData["count_pages"] =$this->db->Record["count_pages"]; $this->itemData[I12658] =$this->TIl1T11($this->db->Record["pages"], $llI11l1); $this->itemData["search_link"] =(empty($this->db->Record["front_link"]) ?I12653 :$GLOBALS['ROOT_PATH_WWW'].$this->db->Record[I12659]); $this->itemData['search_items'] =I12653; if(empty($this->cms->Vars['flt_query_group'])){ $this->itemData['search_items'] =$this->cms->Gui->get($this->moduleName.'_subform:item_block', $this->itemData); }else{ $sql ="SELECT date_format(create_date,'".$this->cms->DFMT[I12643]."') as cdate, date_format(update_date,'".$this->cms->DFMT[I12643]."') as udate, quantity, count_pages, pages, front_link". " from ".$this->module->GetTableName(). " where query='".mysql_real_escape_string($this->db->Record[I12657]).I12660.$this->_ApplyFilters(); $this->db->query($sql); while($this->db->next_record()){ $itemData =array( 'create_date' => $this->db->Record["cdate"], 'update_date' => $this->db->Record["udate"], I12661 => $this->db->Record["quantity"], 'count_pages' => $this->db->Record["count_pages"], 'search_pages' => $this->TIl1T11($this->db->Record[I12662], $llI11l1), 'search_link' => (empty($this->db->Record[I12659]) ?I12653 :$GLOBALS['ROOT_PATH_WWW'].$this->db->Record[I12659]) );if(!empty($this->itemData['search_items']) || $this->db->numRows() >1){ $this->itemData['search_items'] .= $this->cms->Gui->getAbs($this->moduleName.'_subform:item_block_splitter'); }$this->itemData['search_items'] .= $this->cms->Gui->get($this->moduleName.'_subform:item_block', $itemData); }}}}function getSearchPages($addModuleNames, $aValue =array()){ $res =array(); $supportedModules =array( 'news', 'articles', I12663, 'jobs', 'files', 'blog', 'forum', I12664, 'portfolio_item', 'kb_item' );if($addModuleNames){ $aModuleNames =$this->cms->Gui->parseLangFile('templates/lang/_menu_all.lng'); }$parentId =0; $sql =I12665.$this->langData."' and parent_id=0"; $this->db->query($sql); if($this->db->next_record()){ $parentId =$this->db->Record[I12666]; $pageId =$this->db->Record[I12666].':'.$this->db->Record[I12667]; $res[] =array( 'name' => $pageId, I12636 => $this->db->Record['name'].($addModuleNames && $this->db->Record[I12667] != 'pages' ?I12668.$this->words[I12669].': '.$aModuleNames[$this->db->Record[I12667]].')' :I12653), 'selected' => in_array($pageId, $aValue) ?1 :0 );}$sql =I12665.$this->langData."' and (parent_id=".$parentId.I12670.implode(I12671, $supportedModules)."'))"; $this->db->query($sql); $pagesData =array(); while($this->db->next_record()){ $pageId =$this->db->Record[I12666].':'.$this->db->Record[I12667]; $res[] =array( 'name' => $pageId, I12636 => $this->db->Record['name'].($addModuleNames && $this->db->Record[I12667] != I12672 ?I12668.$this->words[I12669].': '.$aModuleNames[$this->db->Record[I12667]].')' :I12653), 'selected' => in_array($pageId, $aValue) ?1 :0 );}return $res; }function GetSearchPagesCB($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues"){ switch($IIL1l1I){ case I12673: $res =Array(); $res[] =array( 'name' => 'all', I12636 => $this->words['all_site_search'], 'selected' => in_array(I12674, $cData[I12648]) ?1 :0 );$res += $this->getSearchPages(true, $cData['value']); break; case "correctvalue": break; case "getvalue": $res =$cData[I12648]; break; }return true; }function TIl1ITT(&$aSearchData, $llI11Ll, $llI11LL, $llI11L1, $llI111I =array()){ $llI111l =array(); if(!is_array($llI111I)) $llI111I =array(); $llI111L =array(); if($llI11LL >0 && sizeof($llI11L1) >1){ $llI1111 =$this->getSearchPages(false); for($i =0; $i <sizeof($llI1111); $i++){ $llI111L[intval($llI1111[$i]['name'])] =$llI1111[$i][I12636]; }}else{ $llI11LL =0; }$aSearchData[I12675] ='0'; $aSearchData['page_fields'] =I12653; $lllIIII =array(); if(sizeof($llI11L1) >0){ $lllIIIl =in_array(0, $llI111I) || empty($llI111I) && in_array(0, $llI11L1) ?'disabled' :I12653; for($i =0; $i <sizeof($llI11L1); $i++){ $idPage =intval($llI11L1[$i]); $fieldData =array('id_page' => $idPage); if($llI11LL >0){ if($idPage == 0) $fieldData[I12676] =$this->words[I12677]; else if(!empty($llI111L[$idPage])) $fieldData[I12676] =$llI111L[$idPage]; else continue; if(sizeof($llI111I) == 0 || in_array($idPage, $llI111I)){ $fieldData['checked'] ='checked'; $llI111l[] =$idPage; }else{ $fieldData['checked'] =I12653; }if($idPage != 0){ $fieldData['disabled'] =$lllIIIl; }else{ $fieldData[I12678] =I12653; }}else{ $llI111l[] =$idPage; }$lllIIII[] =$idPage; $aSearchData['page_fields'] .= $this->cms->Gui->get($this->moduleName.'_list:id_page_'.(!$llI11LL >0 ?'hidden_' :I12653).'field'.$llI11Ll, $fieldData); if($llI11LL >0){ $aSearchData[I12679] .= $this->cms->Gui->get($this->moduleName.'_list:id_page_splitter'.$llI11Ll, $fieldData); }}if($llI11LL >0 && sizeof($lllIIII) >0){ $aTmp =array(I12679 => $aSearchData[I12679], 'advanced_expanded' => $llI11LL == 2); $aSearchData[I12679] =$this->cms->Gui->get($this->moduleName.'_list:id_page_list'.$llI11Ll, $aTmp); $aSearchData[I12675] =intval($llI11LL); $aTmp =array('form_name' => I12680.$llI11Ll); $aSearchData['advanced_search_js'] =$this->cms->Gui->get($this->moduleName.'_list:advanced_search_js'.$llI11Ll, $aTmp); }}$aSearchData['page_fields_list'] =implode(I12654, $lllIIII); return $llI111l; }function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {$aSBData =Array( 'search_link' => $this->module->GetFrontLink() );$llI11LL =$this->module->GetOption(I12681); $llI11L1 =$this->module->GetOption('advanced_search_pages'); $this->TIl1ITT($aSBData, '_small', $llI11LL, $llI11L1); $aSBData['pf'] =1; $vRes["body"] =$this->cms->Gui->get($this->moduleName.I12682, $aSBData); }function TTTllTI(&$aCustom){ $this->SetBodyType("body_items"); parent::TTTllTI($aCustom); }function TTTll1T(&$vData, &$aCustom){ $aDefault =Array(); foreach($this->IIllIL1 as $IIlL1L1 => $tmp) {$IIlL1Ll =$this->TTITTT1($aCustom, $IIlL1L1); switch($IIlL1L1) {case "body_items": $IIlL1Ll["list_data"]["simple_prefix"] =I12683; if($this->cms->Core->IsInstalled('srv_multi_sites')){ $ILlL1lI =true; $lllIIIL =intval($this->cms->Core->GetModOption('srv_multi_sites', I12666)); }else{ $ILlL1lI =false; $lllIIIL =0; }$lllIII1 =false; $words =isset($this->cms->Vars['words']) ?$this->cms->Vars['words'] :I12653; $vData[I12662] =0; $vData[I12684] =$words; $vData['pf'] =1; $llI111I =array(); if(isset($this->cms->Vars['ia'])){ $llI11LL =intval($this->cms->Vars['ia']); $llI11L1 =explode(I12654, $this->cms->Vars[I12672]); if(is_array($this->cms->Vars['spage'])){ for($i =0; $i <sizeof($this->cms->Vars[I12685]); $i++){ $pageId =intval($this->cms->Vars[I12685][$i]); if($pageId >= 0) $llI111I[] =$pageId; }}}else{ $llI11LL =($this->module->IssetOption(I12681)) ?$this->module->GetOption(I12681) :false; $llI11L1 =($this->module->IssetOption('advanced_search_pages')) ?$this->module->GetOption('advanced_search_pages') :array(); }$llI111I =$this->TIl1ITT($vData, I12653, $llI11LL, $llI11L1, $llI111I); if (!empty($words) && !isset($this->cms->Vars['pf']) && !$this->llI11IL) {$this->cms->AddStatusMsg('enable_javascript', I12686); }$lllIIlI =empty($words) || !isset($this->cms->Vars['pf']); if(!$lllIIlI || $this->llI11IL) {require_once $GLOBALS['CLASSES_PATH'] .'searchCmd.php'; $this->llI11Il =new searchCmd($this->cms); $mode =$this->cms->Core->GetModOption('reindex', I12687); $words =stripslashes($words); $word =Array(); $lllIIll =!$this->llI11Il->parseCmd($words); if($lllIIll && !$this->llI11IL) {$vData["item_list"] =$this->cms->Gui->getAbs($this->moduleName."_list:wrong_query", I12634); }else {$filter =(!$lllIIlI && !$lllIIll ?"(".$this->llI11Il->getSuperSQL(false, $mode).") AND " :I12653).I12688; if($ILlL1lI){ $filter .= " AND (id_site='".$lllIIIL."' OR id_site='-1' OR (id_site>0 AND id_page_real=0))"; }$aExcludedPages =array(); $aEvent =array( 'oEngine' => $this, 'aSelectedPages' => &$llI111I, I12689 => &$aExcludedPages );AMI_Event::fire('v5_on_search_pages_filter', $aEvent, AMI_Event::MOD_ANY); if(sizeof($llI111I) >0 && !in_array(0, $llI111I)){ $filter .= I12690.implode(I12654, $llI111I).') OR id_page_main in ('.implode(I12654, $llI111I).I12691; }if(sizeof($aExcludedPages)){ $filter .= ' AND (id_page NOT IN (' .implode(I12654, $aExcludedPages) .') AND id_page_main NOT IN ('.implode(I12654, $aExcludedPages).I12692; }$this->filter->AddField("ia", I12642, $vData[I12675]); $this->filter->AddField("pf", I12642, 1 );if(!empty($vData['page_fields_list'])) $this->filter->AddField(I12662, I12642, $vData['page_fields_list']); if(sizeof($llI111I) >0){ $this->filter->AddField(I12693, I12642, $llI111I); }$relevance =I12653; if(!$lllIIlI && !$lllIIll){ if($mode == 'fulltext'){ $relevance =$this->llI11Il->getSuperSQL(false, $mode); }else{ $lllIIlL =$this->module->GetOption('relevance'); $lllIIl1 =$this->llI11Il->TlTIIIl("rel", "1", $lllIIlL[0]); $lllIILI =$this->llI11Il->TlTIIIl(I12694, "2", $lllIIlL[1]); $lllIILl =$this->llI11Il->TlTIIIl(I12694, "3", $lllIIlL[2]); $relevance ="($lllIIl1 + $lllIILI + $lllIILl)"; }}$IIlL1Ll["fields"]["name"] =Array(I12695=>"callback", I12646=>&$this, "method"=>"_FormatSearchRowCB"); $this->TTTllll($vData, $IIlL1Ll); $this->fn->TIl1ITl($filter.I12644.$this->_ApplyFilters().$this->TTTlIl1(), $this->module->GetOption('front_page_sort_col'), $this->module->GetOption('front_page_sort_dim'), $relevance); $lllIII1 =true; }if(!$lllIIlI && !$lllIIll){ $vData[I12657] =htmlspecialchars($this->llI11Il->TI1TIlT("##value##", true, true)); if(mb_strpos($vData[I12657], '##word##') !== false) {$this->cms->AddStatusMsg("replace_word_", "red", I12634, I12634, array(I12696 => $this->cms->Words["replace_word"])); $vData[I12657] =str_replace("##word##", $this->cms->Words["replace_word"], $vData[I12657]); }if (sizeof($this->llI11Il->Ignore) >0){ $ignored =I12634; foreach ($this->llI11Il->Ignore as $key) {$ignored .= ", '".htmlspecialchars($key).I12660; }$ignored =mb_substr($ignored, 2); $this->cms->AddStatusMsg(I12697, I12634, I12634, I12634, Array(I12684=>$ignored)); }}}else {$this->cms->Gui->AddGlobalVars(array("EMPTY_QUERY"=>1)); }if($lllIII1){ parent::TTTll1T($vData, $IIlL1Ll); if($this->cms->VarsGet['is'] == 1 && !is_null($this->llI11Il)){ $lllIILL =array(I12698 => array( 'is_initial' => true, 'words' => $words, I12699 => $this->cms->lang_data, I12672 => intval($vData['_total_rows']), 'current_url' => $GLOBALS['ActiveScriptFullLink'], 'search_pages' => sizeof($llI111I) >0 && !in_array(0, $llI111I) ?$llI111I :array(I12700) ));$this->cms->Core->Cache->TT1II1I($lllIILL); $this->llI11Il->TlTIIII( $this->cms, $this->db, $words, $lllIILL[I12698][I12672], $lllIILL[I12698]['current_url'], $lllIILL[I12698]['search_pages'] );if(CheckProbability(0.05)) {$this->llI11Il->TT1ITTl($this->db); }}}break; }}}function _FormatSearchRowCB(&$vItem, &$vData){ $this->fn->TIl1IT1($vItem, $vData, $this->llI11Il); }}?>