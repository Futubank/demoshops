<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       18410 xkqwkykptuqirrgixuxyquuplxnxwzpuxqxqwgnwkqizwsqurixlxgqmtuxrgnzsmmxlpnir
 */ ?><?php foreach(array(12701=>"PrHuG|HGQrZtMHnD",12702=>"SQfZuJt|GrQfMx",12703=>"ZnnHunWQ",12704=>'fHrI|CMStO',12705=>"fJt|GuYJMW",12706=>"fJt|WZt|MS",12707=>"FRhi?",12708=>"?coqRq?MS='",12709=>'',12710=>'Dt',12711=>"",12712=>'tZYJQD',12713=>"vZJuQ",12714=>"Hff",12715=>"DMAQ",12716=>"fJZPMWHn",12717=>"ZWtMHn|SQJ",12718=>"|JMDt%SQJ",12719=>"ZSS",12720=>"nHtGuYJMDOQS",12721=>"OQZSQr",12722=>"GuYJMW",12723=>"DQZrWO|fMQJS|WZt",12724=>"nH|WZtD",12725=>"fSZtQ",12726=>"JMDt|SZtZ",12727=>'W',12728=>"'{",12729=>'DIZJJ|JMDt',12730=>"'{?ZD?fSZtQ?",12731=>"COQrQ",12732=>"MtQI|GMWturQD",12733=>'wjzddqd|gzTo',12734=>"?",12735=>"HYLQWt",12736=>"SQtMZJD",12737=>"JMDt|DQt",12738=>"WZGtMHn",12739=>'DQZrWO|fMQJS|WZt',12740=>"nZIQ",12741=>"PQtvZJuQ",12742=>"frHnt|JMnK") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleStickers extends CMS_ActModule {public $IlIllI1; public $I1LII1I; function _Init($IIll1l1 =Array(), $IIll1LI ="", $IIll1Ll ="", $aOptions =Array()) {$IIIIL11[I12701] =Array("publish_on", "publish_off", "del", "move_position"); $IIIIL11[I12702] ="st"; $IIIIL11["name_field_name"] ="header"; $IIIIL11["description_field_name"] =I12703; $IIIIL11["use_positions"] =true; $aOptions += $IIIIL11; $catModuleName =$this->module->Name .'_cat'; $this->I1LII1I =$this->cms->Core->IsInstalled($catModuleName) && $this->module->IssetAndTrueOption("use_categories"); if ($this->I1LII1I) {$this->IlIllI1 =new CMS_CategoriesFunctions($this->cms, $this, $catModuleName); }else {$this->IlIllI1 =new CMS_CategoriesFunctionsStub($this->cms, $this, $catModuleName); }parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->IlIllI1->_Init(); $this->IlIllI1->TTIT1IT("_ApplyCatFilters"); }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); $vData[I12704] ='100%'; }function TTTlIII() {parent::TTTlIII(); $this->filter->AddField("flt_public", "checkbox", isset($this->cms->Vars["flt_public"]) ?$this->cms->Vars[I12705] :null, "0", "=", $this->options['default_prefix'] .'public'); $this->filter->MoveField(I12705, _MOVE_PREV); if (empty($this->cms->Vars[I12705])) {$this->filter->DisableFieldSQL(I12705); }$this->filter->TITIll1(I12705); if($this->IlIllI1->TTTlIII(I12706)) {$this->filter->MoveField(I12706, _MOVE_START); }}function TTT1lTl($IIl1II1, &$record, &$vData, &$aData) {parent::TTT1lTl($IIl1II1, $record, $vData, $aData); }function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT st.*, DATE_FORMAT(st.date,'".$this->cms->DFMT["db"]."') AS fdate, ". "IF(st.public > 0, 'checked', '') AS public ". I12707 .$this->module->GetTableName() ." AS st ". "WHERE st.id='".$cId."'".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData[I12703] =$this->cms->htmlchars($this->itemData[I12703]); }}function _ActionDel($cId, $cModule) {$sql ="SELECT public, id_cat FROM " .$this->module->GetTableName() .I12708.$cId."'"; $this->db->query($sql); if($this->db->next_record()){ $this->IlIllI1->TTIT1ll($cId, $cModule, $this->db->Record["public"], $this->db->Record["id_cat"]); parent::_ActionDel($cId, $cModule); $err =$this->GetLastError(); if(empty($err["errno"])) {$this->IlIllI1->_ActionDel($cId, $cModule); }}}function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); if(empty($this->errno) && $this->appliedId >0) {$this->IlIllI1->TTTll11($cId, $cModule); }}function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); if(empty($this->errno)) {$this->IlIllI1->TTTl1lI($cId, $cModule); }}function _ActionPublish($cId, $cModule) {$this->IlIllI1->TTIT1ll($cId, $cModule); parent::_ActionPublish($cId, $cModule); $this->IlIllI1->_ActionPublish($cId, $cModule); }function TTT1Tl1($cType, $cModule, $condition =I12709) {$res =$this->IlIllI1->TTT1Tl1($cType, $cModule); if(!$res) {parent::TTT1Tl1($cType, $cModule, $condition); }}function _ApplyCatFilters($prefix =I12709, $bodyType =I12709, $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); return $res; }function TTTlI11(&$vData, &$aCustom) {$aCatSql =Array(); $aCatSql["join_to_alias"] ="st"; $this->IlIllI1->TTIT1lT("item_list", $aCatSql); $this->browser->InitSQL("st.id, st.public, st.header, st.announce,  ". "DATE_FORMAT(st.date,'".$this->cms->DFMT["db"]."') AS fdate ".$aCatSql["select"], Array('tables'=>Array(I12710=>$this->module->GetTableName()) +$aCatSql['tables'], 'joins'=>$aCatSql['joins']), "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), I12711, "name", "st.id desc", $aCatSql["order_replace"] );if(!empty($aCatSql['tables'])) {$this->browser->AddSQLJoinedTables($this->cms->Core, I12710, $aCatSql[I12712]); }$aCustom["fields"] += Array( "public"=>Array("action"=>"flagicon", I12713=>1, "id"=>"pub_id", "on"=>$this->moduleName."_list:public_on",I12714=>$this->moduleName."_list:public_off"), "header"=>Array("action"=>"stripline", I12715=>35), I12703=>Array("action"=>"stripline", I12715=>145), "action_edit"=>Array("action"=>I12716, I12713=>I12711, "id"=>"edit_id", "on"=>$this->moduleName."_list:edit",I12714=>I12711), I12717=>Array("action"=>I12716, I12713=>I12711, "id"=>"del_id", "on"=>$this->moduleName.I12718,I12714=>I12711), );$aCustom["applied_id"] ="st.id"; $aCustom["form_data"]["buttons"] =Array(I12719, "apply", "cancel", "save"); $this->IlIllI1->TTTlI11($vData, $aCustom); parent::TTTlI11($vData, $aCustom); }function TTT11Tl(&$IILILII) {$IILILII[] ="published"; $IILILII[] =I12720; $IILILII[] ="leg_yellow"; $IILILII[] ="leg_blue"; $IILILII[] ="leg_edit"; $IILILII[] ="leg_del"; parent::TTT11Tl($IILILII); }function TTT1IlI($aSql =Array(), $cId =0) {$announce =$this->cms->VarsPost[I12703]; $I1LIlII =$this->cms->VarsPost[I12721]; $udate =DateTools::getCorrectUDate($this->cms->VarsPost["date"], $this->cms->DFMT["conf"]); $date =date($this->cms->DFMT["php"], $udate); if(!empty($I1LIlII)) {$aSql =Array( "date"=>DateTools::toMysqlDate($udate), I12721=>$I1LIlII, I12703=>$announce, I12722=>$this->cms->VarsPost[I12722], );}$this->IlIllI1->TTT1IlI($aSql, $cId); $aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TTTlIT1(&$aCustom, $cType ="small", $IIlLI11 =I12711, $IIlLlII ="_small") {$this->IlIllI1->TTTlITl($aCustom, $cType, $IIlLI11, $IIlLlII, true); $html =parent::TTTlIT1($aCustom, $cType, $IIlLI11, $IIlLlII); $this->IlIllI1->TTTlITl($aCustom, $cType, $IIlLI11, $IIlLlII, false); return $html; }function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {$I1LIlI1 =$this->module->GetOption("small_number_items"); $lllIIL1 =$this->module->GetOption("search_field_item"); $I1LIllI =$lllII1I =$this->module->GetOption(I12723); $Il1IIIL =$this->module->GetOption("small_items_sort_col"); $mode ="no_cats"; if( $this->cms->Core->IsInstalled($this->IlIllI1->catModuleName) && $this->module->issetAndTrueOption('use_categories') ){$mode ="cats_ids"; $I1LIllL =is_array($I1LIllI); if(!$I1LIllL || ($I1LIllL && sizeof($I1LIllI) == 0)) {if(empty($I1LIllI)) {$mode =empty($I1LIlll) ?I12724 :"cats_num"; }else {$I1LIllI =Array($I1LIllI); }}if(in_array(-1,$I1LIllI)){ $mode =I12724; }}$I1LIll1 =" "; if(!empty($I1LIlI1)) {$I1LIll1 =" LIMIT ".$I1LIlI1; }$aDefault =Array(); $aDefault["simple_set_fields"] =Array(I12725,I12703, I12721); $aCustom += $aDefault; $aDefault["list_data"]["splitter_prefix"] ="small_"; $aCustom["list_data"] += $aDefault[I12726]; if($Il1IIIL == 'rand'){ $I1LIlLI =" rand() "; }else{ $I1LIlLI =" st.".$Il1IIIL." ".$this->module->GetOption("small_items_sort_dim"); }if ($this->I1LII1I && ($mode == 'cats_num' || $mode == 'cats_ids')) {$this->TTITTTI('push'); $sql ="SELECT c.id AS cat_id, c.sublink AS cat_sublink, c.name AS cat_name, c.announce AS cat_announce  FROM cms_stickers_cat AS c WHERE 1".$this->_ApplyCatFilters(I12727, I12709, !$I1LIlLl); $I1LIlLL =I12709; if($mode == "cats_num") {$sql .= $I1LIlLL." LIMIT ".$I1LIlll; }else {$sql .= " AND id IN('".implode("','", $I1LIllI).I12728.$I1LIlLL; }$this->TTITTTI('pop'); $this->db->query($sql); $aCatIds =Array(); while($this->db->next_record()) {$aCatIds[] =$this->db->Record["cat_id"]; $this->II1lllI["aCats"][$this->db->Record["cat_id"]] =$this->db->Record; }}if($mode == I12724) {$this->IlIllI1->TTIT1lT(I12729, $aCatSql); }$lllII1l =I12709; if($lllIIL1 && !(sizeof($lllIIL1) == 1 && $lllIIL1[0] == -1)){ $lllII1l =" AND st.id IN ('".implode("','", $lllIIL1)."') "; }$this->_forceHideFutureItems =true; switch($mode) {case I12724: $this->options['use_id_page'] =$IILL1ll; $this->browser->InitSQL("st.id, st.header, st.announce " .$aCustom["sql_addon"]["select"] .", date_format(st.date,'".$this->cms->DFMT["db"].I12730.$aCatSql["select"], I12707 .$this->module->GetTableName() ." AS st ".$aCatSql["join"], "WHERE 1 ".$lllII1l.$this->_ApplyFilters(I12709, I12709, !$I1LIlL1).$aCatSql[I12731], I12711, $I1LIlLI );$this->browser->SetForceRules('ORDER BY ' .$I1LIlLI, $I1LIll1); $this->browser->AddSQLJoinedTables($this->cms->Core, I12710, $aCatSql["tables"]); break; case "cats_num": case "cats_ids": $aItems =Array(); if(sizeof($aCatIds) >0) {$ILLILlL ="SELECT st.id, st.id_cat, st.header, st.announce " .$aCustom["sql_addon"]["select"] .", date_format(st.date,'".$this->cms->DFMT["db"].I12730; if(isset($this->options[I12732])){ foreach($this->options[I12732] as $fieldName) {if(!empty($fieldName) && $fieldName != 'null' && $fieldName != -222222){ $ILLILlL .= ", st.ext_".$fieldName; }}}foreach($aCatIds as $catId) {$sql =$ILLILlL." FROM " .$this->module->GetTableName() ." AS st INNER JOIN " .$this->IlIllI1->IILLLl1 ." AS c ON c.id=st.id_cat WHERE st.id_cat='".$catId."' ".$lllII1l.$this->_ApplyFilters(I12709, I12709, !$I1LIlL1)." ORDER BY ".$I1LIlLI.$I1LIll1; $this->db->query($sql); while($this->db->next_record()) {$aItems[] =$this->db->Record +$this->II1lllI["aCats"][$this->db->Record["id_cat"]]; }}}require_once $GLOBALS[I12733] .'CMS_IteratorArray.php'; $I1LIl1I =true; $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray($aItems); $this->browser->InitSQL("id", I12707 .$this->IlIllI1->IILLLl1 ." ", "WHERE 1 " );$this->browser->SetForceRules(I12711, I12734); $aCustom["fields"] += Array("cat_detials" => Array("action"=>"callback", I12735=>&$this, "method"=>"_GetSmallCatDetailsCB")); $this->II1lllI["prevCatId"] =-1; break; }unset($this->_forceHideFutureItems); $aCustom["fields"] += Array(I12736 => Array("action"=>"callback", I12735=>&$this, "method"=>"_GetSmallDetailsCB")); $aCustom[I12737] ="small_list_list"; parent::TTTll1I($vRes, $aCustom, $cType, $IIlLlII); if(isset($I1LIl1I)) {$this->db =new DB_si; }}function getOptionsModColsCB($cData, $IIL1lL1, &$res, &$aData, $IIL1l1I ="getallvalues"){ switch($IIL1l1I){ case "getallvalues": $res =array(); $res[] =array( "name" => -1, I12738 => $this->words['all'], "selected" => I12709 );$db =new DB_si; $sql ="SELECT st.id,st.header,ct.name from cms_stickers AS st join cms_stickers_cat as ct on ct.id = st.id_cat "; $this->Il11lL1 =$this->cms->Core->GetModOption('stickers', I12739); if(!in_array(-1,$this->Il11lL1)){ $sql .= " WHERE st.id_cat IN('".implode("','", $this->Il11lL1)."') "; }$db->query($sql); while($db->next_record()) {$id =$db->Record["id"]; $name =$db->Record[I12740].': '.$db->Record[I12721]; $res[] =array( I12740 => $id, I12738 => $name, "selected" => (($cData[I12713] == $id) ?"selected" :I12711) );}break; case "correctvalue": break; case I12741: $res =$cData[I12713]; break; }return true; }function _GetSmallDetailsCB(&$aItem, &$aData) {$aItem["date"] =$aItem[I12725]; $aItem["date"] =$this->cms->TTITI1l("small", "date", $aItem); $aItem[I12742] =$aData[I12742]; if($this->module->GetOption("announce_mode_full")) {$aItem[I12703] =$this->cms->Gui->MYnl2br($aItem[I12703]); }elseif($this->module->GetOption("announce_small_length")) {$aItem[I12703] =$this->cms->stripLine($aItem[I12703], $this->module->GetOption("announce_small_length")); }if($this->module->GetOption("header_small_length")){ $aItem[I12721] =$this->cms->stripLine($aItem[I12721], $this->module->GetOption("header_small_length")); }$aItem['rand_id'] ='sticker_'.rand(1000,9999).rand(1000,9999); }function _GetSmallCatDetailsCB(&$aItem, &$aData) {}function TTTlI1l() {$res =false; if(parent::TTTlI1l()) {$res =$this->IlIllI1->TTTlI1l(); }return $res; }}