<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       22065 xkqwpyuzzzygtsizizgxrqtylwlnstkpxslrtmxtsgxruwwnqtnmlnkkqtxsyxypkuuqpnir
 */ ?><?php foreach(array(12794=>"SQfZuJt|GrQfMx",12795=>'MS',12796=>'zim|zjjhc|qFNdU',12797=>"SZtQtH",12798=>'',12799=>'GJuPMnD|CMAZrS',12800=>'IHSuJQ|JMnK',12801=>'HCnQr',12802=>'fMrDt|IHS|MS',12803=>'rQJZtMHnD',12804=>'GZPQ|404',12805=>'PuQDt|SMDZYJQS',12806=>"IHSuJQD",12807=>'IHSuJQ|JMDt',12808=>"P`JHPMn!?P`IHSQrZtHr!?P`IHSuJQD!?WHunt}u`MS{?ZD?uDQrD",12809=>"P",12810=>'ZWtMHn',12811=>'PuQDt',12812=>'vZJuQ',12813=>'IHSuJQD',12814=>'IQtOHS',12815=>'|wyiHSuJQD',12816=>'P`MS',12817=>'JQP|rQS',12818=>"fHrI|SZtZ",12819=>"DZvQ",12820=>"MD|SQfZuJt",12821=>'nHnQ',12822=>"1",12823=>'nZIQ',12824=>"'",12825=>'IHSuJQzWWQDD',12826=>"CrMtQ",12827=>"dqjqwT?IHSuJQ|nZIQ!ZWtMHn|nZIQ?FRhi?WID|DBD|ZWtMHnD|rMPOtD",12828=>'IHSuJQ|nZIQ',12829=>"mNdqRT?WID|DBD|ZWtMHnD|rMPOtD?}IHSuJQ|nZIQ!ZWtMHn|nZIQ!PrHuG|IZDK{?",12830=>"uDQr|MSD",12831=>'MD|SQfZuJt',12832=>'WOQWKQS',12833=>'?WOQWKQS',12834=>"SMDZYJQS",12835=>'uDQr|MSD',12836=>'I0',12837=>'SQDWrMGtMHn',12838=>'QSMt|frHnt|ZJJHCQS',12839=>'nuI|IHSuJQD') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleSysGroups extends CMS_ActModule {public $groupId; public $IlLlllL; function ModuleSysGroups(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); }function _Init($IIll1l1 =Array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =Array()) {$IIIIL11[I12794] ="g"; $IIIIL11["stop_use_sublinks"] =false; $IIIIL11["check_public"] =false; $IIIIL11["lang_data"] =false; $aOptions += $IIIIL11; $this->groupId =intval($this->cms->Vars[I12795]); parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->cms->Gui->addGlobalVars( array( 'allow_edit_at_front' => AMI::getOption('core', 'allow_edit_at_front'), 'AMI_ALLOW_EFNSU' => !empty($GLOBALS[I12796]) ));}function ProcessAction($IIIL11l, $cId, $cModule ='') {$id =intval($cId); switch ($IIIL11l) {default: parent::ProcessAction($IIIL11l, $cId, $cModule); break; }}function TTTlIII() {parent::TTTlIII(); if($this->filter->issetField("datefrom")) $this->filter->TITI1l1("datefrom"); if($this->filter->issetField("dateto")) $this->filter->TITI1l1(I12797); $this->filter->AddField("flt_name", "text", isset($this->cms->Vars["flt_name"]) ?stripslashes(unhtmlentities($this->cms->Vars["flt_name"])) :I12798, "", " like ", "g.name"); $this->filter->MoveField("flt_name",_MOVE_START); }function &TIl1IIT() {if(is_array($this->IlLlllL)) return $this->IlLlllL; if ($this->cms->Core->IsInstalled(I12799)) {$lllIlLI =$this->cms->Core->GetModProperty(I12799, 'config'); $IIL111L =&$this->cms->Core->GetAllModules(); foreach (array_keys($IIL111L) as $vModName) {$vMod =&$IIL111L[$vModName]; if ($vMod->issetOption(I12800)) {$modLink =$vMod->GetOption(I12800); if (!isset($modLink['parent']) || !$modLink['parent']){ $vMod->Owner =isset($modLink['owner']) ?$modLink[I12801] :null; $vMod->SetOption('start_disable', false); }}}}$this->IlLlllL =array(); $vOwners =&$this->cms->Core->GetOwnersList(); $IIL111L =&$this->cms->Core->GetAllModules(); foreach($vOwners as $vName=>$lllIlLl){ if(!$this->cms->Core->IsOwnerInstalled($vName)){ continue; }if(isset($lllIlLl['admin_link'])){ $lllIlLL =$lllIlLl['admin_link']; }elseif(isset($lllIlLl['first_mod_id'])){ $vMod =&$this->cms->Core->GetModule($lllIlLl[I12802]); $lllIlLL =$vMod->GetAdminLink(); unset($vMod); }if(empty($lllIlLL)){ continue; }$lllIlLl["admin_link"] =$lllIlLL; foreach($IIL111L as $vModName=>$lllIlLl){ $vMod =&$IIL111L[$vModName]; $section ='eshop_cart' !== $vModName ?$vMod->GetOwnerName() :'pmanager'; if( $vName != $section || ((!$vMod->IsAdminAllowed() || $vMod->issetAndTrueOption('start_disable')) && !in_array($vModName, array(I12803, 'page_404', 'print_version', 'sitemap', 'eshop_cart')) )){continue; }$link =$vMod->GetAdminLink(); if( !$vMod->IsInstalled() || I12798 != $vMod->GetParentName() || (empty($link) && !in_array($vModName, array(I12803, I12804, 'print_version', 'sitemap', 'eshop_cart')) )){continue; }$this->IlLlllL[$vModName] =&$vMod; }}return $this->IlLlllL; }function TIl1III($lllIlL1) {$lllIl1I =&$this->TIl1IIT(); return array_key_exists($lllIlL1,$lllIl1I); }function TIl1IIl() {$res =I12798; $lllIl1I =&$this->TIl1IIT(); foreach($lllIl1I as $name=>$mod) {if($mod->TTlITTT()===false) continue; $access =$this->groupId ?$this->cms->Core->TTllIlI($this->groupId,$name,true) :0; $res .= "<input type='hidden' name='modacc_$name' value='$access' collect_link_ignore=1>\n"; }return $res; }function TIl1II1($groupId) {$res =0; $lllIl1I =&$this->TIl1IIT(); foreach($lllIl1I as $name => $oMod){ if(FALSE === $oMod->TTlITTT()){ continue; }if($this->cms->Core->TTllIlI($groupId,$name)){ $res++; }}return $res; }function TTTlI1I(&$vData) {$vData['is_default_disabled'] =I12798; $vData[I12805] =I12798; $vData['users'] ='0'; $vData[I12806] ='0'; if($this->action=='del') $this->groupId =0; $vData[I12807] =$this->TIl1IIl(); parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {$this->browser->InitSQL("g.id, name, g.description, g.is_default, g.guest, g.group_mask, ". I12808, "FROM cms_sys_groups g LEFT JOIN cms_sys_users u ON g.id=u.id_group", "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), "g.id, u.id_group", "name" );$this->browser->AddSQLJoinedTables($this->cms->Core, I12809, Array("u"=>"cms_sys_users")); $aCustom['fields'] =Array( 'actions'=>Array(I12810=>'callback', 'object'=>&$this, 'method'=>'_CreateActions'), I12811=>Array(I12810=>'flagicon', 'value'=>1, I12795=>'spec_act_id', 'on'=>'sys_groups_list:spec_guest_on','off'=>'sys_groups_list:spec_guest_off'), 'login'=>Array(I12810=>'flagicon', I12812=>1, I12795=>'spec_act_id', 'on'=>'sys_groups_list:spec_login_on','off'=>'sys_groups_list:spec_login_off'), 'moderator'=>Array(I12810=>'flagicon', I12812=>1, I12795=>'spec_act_id', 'on'=>'sys_groups_list:spec_login_on','off'=>'sys_groups_list:spec_login_off'), I12813=>Array(I12810=>'callback', 'object'=>&$this, I12814=>I12815), 'name'=>Array(I12810=>'stripline', 'size'=>25), );$aCustom['applied_id'] =I12816; $aCustom['legend'] =Array('spec_default_leg', 'spec_guest_leg', 'spec_login_leg', I12817, 'leg_yellow', 'leg_blue', 'leg_edit', 'leg_del'); $aCustom[I12818]["buttons"] =Array("add", "apply", "cancel", I12819); parent::TTTlI11($vData, $aCustom); }function _CreateActions(&$aItem, &$aData){ $aItem["edit_id"] =$aItem["del_id"] =$aItem[I12795]; $aItem["actions"] =$this->cms->Gui->get('sys_groups_list:icons_edit_del'. (($aItem[I12820] == 1 || $aItem["guest"] == 1) ?"off" :""), $aItem); }function _CBModules(&$aItem, &$aData){ if(is_null($aItem[I12813])){ $aItem[I12813] ='-'; }}function TTTlT1l() {return $this->cms->Core->IsSysUser() ?SYS_A_RIGHT :0; }function TTTlT1T($IIIL11l,$id,$cModule,&$IIlLI1l) {return $this->cms->Core->IsSysUser() ?$IIIL11l :I12821; }function TTTll11($cId, $cModule) {$IIIILIl =Array(); $sql ="SELECT CONV(g.group_mask, 10, 2) AS mask FROM cms_sys_groups g"; $this->db->query($sql); while($this->db->next_record()){ $mask =$this->db->Record["mask"]; for($i =0; $i <mb_strlen($mask); $i++) if($mask[mb_strlen($mask)-$i-1] == "1") $IIIILIl[$i] ="1"; }$IIIILI1 =-1; for($i =0; $i <63; $i++){ if(isset($IIIILIl[$i]) && $IIIILIl[$i] =I12822) continue; else $IIIILI1 =$i; break; }if($IIIILI1<0){ $this->SetLastError(100, "Bitmask fail"); $this->cms->AddStatusMsg("bitmask_fail", "red"); return; }$this->db->query("SELECT id FROM cms_sys_groups WHERE name='".$this->cms->Vars[I12823]."'"); if($this->db->next_record()) {$this->cms->AddStatusMsg("group_exists", "red"); return; }$IIIILlI =$IIIILI1>31 ?0 :1<<$IIIILI1; $m1 =$IIIILI1>31 ?1<<($IIIILI1-32) :0; parent::TTTll11($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno']) && $this->appliedId >0){ $sql ="UPDATE cms_sys_groups SET group_mask=($m1<<32)+$IIIILlI WHERE id='".$this->appliedId.I12824; $this->db->query($sql); $this->TIl1Il1(); $this->TIl1Ill( empty($this->cms->VarsPost['is_default']) ?0 :$this->cms->VarsPost['is_default'], empty($this->cms->VarsPost[I12811]) ?0 :$this->cms->VarsPost[I12811] );$this->TIl1IlT(array($IIIILlI,$m1)); }}function TIl1IlT($mask) {$modlist =explode(';',$this->cms->Vars[I12825]); $lllIl1l =$this->TIl1IIT(); unset($modlist[sizeof($modlist)-1]); $this->db->TT1lT11(array("cms_sys_actions_rights"=>I12826)); $this->db->query(I12827); $lllIl1L =array(); while($this->db->next_record()) $lllIl1L[$this->db->Record[I12828]][$this->db->Record['action_name']] =1; $sql ="UPDATE cms_sys_actions_rights SET group_mask=group_mask & ~(($mask[1]<<32)+$mask[0]) "; $this->db->query($sql); for($modName=reset($modlist); $modName; $modName=next($modlist)) {if(!$this->TIl1III($modName)) continue; $Ill1LL1 =intval(next($modlist)); $mod =&$lllIl1l[$modName]; $this->TIl1IlI($mod,$lllIl1L,$Ill1LL1,$mask); $IlLlLIL =&$mod->GetSubModules(); if ($mod->issetProperty('inherit_rights')) {$IlllIlL =$mod->GetProperty('inherit_rights'); foreach ($IlllIlL as $moduleName) {$IlLlLIL[$moduleName] =&$this->cms->Core->GetModule($moduleName); }}if (!is_array($IlLlLIL)) {continue; }foreach (array_keys($IlLlLIL) as $lllIl11) {$lllILII =&$IlLlLIL[$lllIl11]; $this->TIl1IlI($lllILII,$lllIl1L,$Ill1LL1,$mask); }}$aModules =&$this->cms->Core->GetInstalledModuleNames(); $Ill1LL1 =SYS_A_RIGHT; foreach ($aModules as $moduleName) {$oModule =&$this->cms->Core->GetModule($moduleName); if ($oModule->issetAndTrueProperty('always_allowed')) {$this->TIl1IlI($oModule, $lllIl1L, SYS_A_RIGHT, $mask); }}$this->db->TT1lITT(); $this->cms->Core->UpdateRightsVersion(); }function TIl1IlI(&$mod,&$lllIl1L,$Ill1LL1,$mask) {$actions =$mod->TTlITT1($Ill1LL1); $modName =$mod->GetName(); foreach($actions as $action=>$Ill1LL1) if(isset($lllIl1L[$modName][$action])) {$sql ="UPDATE cms_sys_actions_rights ". "SET group_mask=group_mask | (($mask[1]<<32)+$mask[0]) ". "WHERE module_name='$modName' AND action_name='$action'"; $this->db->query($sql); }else {$lllIl1L[$modName][$action] =1; $sql =I12829. "VALUES('$modName','$action',($mask[1]<<32)+$mask[0])"; $this->db->query($sql); }}function TIl1Ill($default,$guest) {if(intval($guest)==1) {$sql ="UPDATE cms_sys_groups SET guest='0'"; $this->db->query($sql); $sql ="UPDATE cms_sys_groups SET guest='1' WHERE id='".$this->appliedId.I12824; $this->db->query($sql); }}function TIl1Il1() {$sql ="DELETE from cms_sys_users WHERE id_group='".$this->appliedId.I12824; $this->db->query($sql); $lllILIl =explode(";", $this->cms->VarsPost[I12830]); foreach($lllILIl as $value){ $value =intval($value); if($value >0){ $sql ="INSERT into cms_sys_users(id_member, id_group) VALUES('".$value."', '".$this->appliedId."')"; $this->db->query($sql); }}}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="select g.* from cms_sys_groups g where g.id='".$cId.I12824.$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData[I12831] =($this->itemData[I12831] == 1) ?'checked': I12798; $this->itemData[I12811] =($this->itemData[I12811] == 1) ?'checked': I12798; $this->itemData['login'] =($this->itemData['login'] == 1) ?I12832: I12798; $this->itemData['moderator'] =($this->itemData['moderator'] == 1) ?I12832: I12798; $this->itemData['edit_front_allowed'] =$this->itemData['edit_front_allowed'] ?I12833: I12798; $this->itemData[I12823] =$this->cms->htmlchars($this->db->Record["name"]); $this->itemData['description'] =$this->cms->htmlchars($this->db->Record["description"]); $this->itemData[I12806] =$this->TIl1II1($this->groupId); if($this->itemData[I12820]){ $this->itemData["is_default_disabled"] =I12834; }if($this->itemData["guest"]){ $this->itemData["guest_disabled"] =I12834; $this->itemData['login_disabled'] =' disabled="disabled"'; }$sql ="SELECT COUNT(*) AS count FROM cms_sys_users WHERE id_group='".$this->itemData["id"].I12824; $this->db->query($sql); if($this->db->next_record()) $this->itemData["users"] =$this->db->Record["count"]; }$sql ="select id_member from cms_sys_users where id_group='".$cId.I12824; $this->db->query($sql); $this->itemData[I12835] =I12798; while($this->db->next_record()){ $this->itemData[I12835] .= ";".$this->db->Record["id_member"]; }}function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno']) && $this->appliedId >0){ $sql ="SELECT group_mask>>32 AS m1,group_mask & 0x00000000ffffffff AS m0 ". "FROM cms_sys_groups WHERE id=$cId"; $this->db->query($sql); $this->db->next_record(); $IIIILlI =$this->db->Record[I12836]; $m1 =$this->db->Record['m1']; $this->TIl1Il1(); $this->TIl1Ill( empty($this->cms->VarsPost[I12831]) ?0 :$this->cms->VarsPost[I12831], empty($this->cms->VarsPost[I12811]) ?0 :$this->cms->VarsPost[I12811] );$this->TIl1IlT(array($IIIILlI, $m1)); }}function _ActionDel($cId, $cModule) {$sql ="SELECT * FROM cms_sys_groups WHERE id=$cId"; $this->db->query($sql); $this->db->next_record(); $mask =$this->db->Record['group_mask']; if($this->db->Record[I12811] || $this->db->Record[I12831]){ return; }parent::_ActionDel($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno']) && $cId >0){ $sql ="DELETE FROM cms_sys_users where id_group='".intval($cId).I12824; $this->db->query($sql); $sql ="UPDATE cms_sys_actions_rights SET group_mask=group_mask & ~$mask "; $this->db->query($sql); }$this->cms->Core->UpdateRightsVersion(); }function TTT1IlI($aSql =array(), $cId =0){ $name =$this->cms->VarsPost[I12823]; if($name == I12798){ return $aSql; }$aSql =array( I12823 => $name, I12837 => $this->cms->VarsPost[I12837], 'moderator' => isset($this->cms->VarsPost['moderator']) ?(int)$this->cms->VarsPost['moderator'] :0, 'edit_front_allowed' => (int)!empty($this->cms->VarsPost[I12838]), 'login' => (int)(empty($this->cms->VarsPost[I12811]) && (isset($this->cms->VarsPost['login']) ?$this->cms->VarsPost['login'] :0)), I12813 => empty($this->cms->VarsPost[I12839]) ?0 :(int)$this->cms->VarsPost[I12839] );return $aSql; }}