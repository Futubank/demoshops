<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       19485 xkqwlwsgukmygwktgxrkzkmzzxwyixpsprgtptulwitikrgrppgtrlgulyrlkskiqyrqpnir
 */ ?><?php foreach(array(12840=>"uDQrmS",12841=>"^",12842=>'P',12843=>"QSMt",12844=>'',12845=>"SZtQtH",12846=>"",12847=>"%LD|PrHuGD",12848=>"DtZtuD",12849=>"ZWtMHn",12850=>'0',12851=>'DBD|uDQr',12852=>"'!'",12853=>'PrHuG|tBGQ',12854=>"MS",12855=>"DGQW|ZWt|MS",12856=>"DMIGJQ",12857=>"DtBJQ",12858=>"PrHuG|MSD",12859=>"'{?",12860=>'WZJJYZWK',12861=>'ZWtMHn',12862=>'Hn',12863=>'fJZPMWHn',12864=>'Hff',12865=>'IHSuJQD',12866=>'|wyiHSuJQD',12867=>'DtrMGJMnQ',12868=>'DGQW|SQfZuJt|JQP',12869=>'JQP|YJuQ',12870=>"fHrI|SZtZ",12871=>"DZvQ",12872=>"PuQDt",12873=>"IHSuJQD",12874=>'nHnQ',12875=>"'",12876=>"1",12877=>'nZIQ',12878=>"DtZtuD|ZSS|tH|JMDt",12879=>'MD|SQfZuJt',12880=>'JHPMn',12881=>"MD|SQfZuJt",12882=>'JHPMn|SMDZYJQS',12883=>"SMDZYJQS",12884=>"ZSS|tH|JMDt",12885=>'SQDWrMGtMHn') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleSysGroupsPopup extends CMS_ActModule {public $userId; public $IIl1lLL; function ModuleSysGroupsPopup(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); }function Init($IIll1l1 =Array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =Array()) {if(isset($this->cms->Vars[I12840]) && $this->cms->Vars[I12840] != "") $this->userId =intval($this->cms->Vars[I12840]); else $this->userId =0; if(isset($this->cms->Vars["group_ids"]) && $this->cms->Vars["group_ids"] != "") $this->IIl1lLL =explode(I12841, $this->cms->Vars["group_ids"]); else $this->IIl1lLL =Array(); $IIlLLLL =$this->IIl1lLL; $this->IIl1lLL =Array(); $count =count($IIlLLLL); for($i =0; $i <$count; $i++){ $sql ="SELECT COUNT(*) AS count FROM cms_sys_groups WHERE id=".intval($IIlLLLL[$i]); $this->db->query($sql); if($this->db->next_record()){ if($this->db->Record["count"] >0) $this->IIl1lLL[] =intval($IIlLLLL[$i]); }}$IIIIL11["default_prefix"] =I12842; $IIIIL11["lang_data"] =false; $IIIIL11["allowed_actions"] =Array("active", "add", I12843, "apply", "save", "move", "remove"); $aOptions += $IIIIL11; parent::Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->cms->Gui->addGlobalVars( array( 'allow_edit_at_front' => AMI::getOption('core', 'allow_edit_at_front'), 'AMI_ALLOW_EFNSU' => !empty($GLOBALS['AMI_ALLOW_EFNSU']) ));}function ProcessAction($IIIL11l, $cId, $cModule =I12844) {$id =intval($cId); switch ($IIIL11l) {case 'move': $this->_ActionMove($cId, $cModule); break; case 'remove': $this->TIIlTTT($cId, $cModule); break; default: parent::ProcessAction($IIIL11l, $cId, $cModule); break; }}function TTTlIII() {parent::TTTlIII(); if($this->filter->issetField("datefrom")) $this->filter->TITI1l1("datefrom"); if($this->filter->issetField(I12845)) $this->filter->TITI1l1(I12845); $this->filter->AddField("flt_name", "text", isset($this->cms->Vars["flt_name"]) ?stripslashes(unhtmlentities($this->cms->Vars["flt_name"])) :I12844, I12846, " like ", "g.name"); $this->filter->MoveField("flt_name",_MOVE_START); }function &TTTlI1T(&$aCustom) {$data =parent::TTTlI1T($aCustom); $data["js_functions"] =$this->cms->Gui->get($this->module->GetName().I12847, $data); $data["selected_groups_list"] =$this->cms->Gui->get($this->module->GetName().":selected_groups_list", $data); $data["scripts"] =$this->cms->Gui->getScripts(); $data["metas"] =$this->cms->Gui->getMetas(); $data[I12848] =$this->cms->GetStatusMessages(); $data["filter"] =$this->filter->getFilterHtml(); global $conn; print $this->cms->Gui->get($this->module->GetName(), $data); $conn->Out(); die(); }function TTTlI1I(&$vData) {$vData["submit_add"] =I12846; $vData["submit_apply"] ="disabled"; $vData[I12849] ="add"; $vData["add_to_list"] =I12846; $vData["user_id"] =$this->userId; $vData["num_groups"] =I12850; $vData['is_default_disabled'] =I12844; $vData['guest_disabled'] =I12844; parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {$sql ="SELECT sys_user FROM cms_host_users WHERE id_member=".intval($vData['user_id']); $this->db->query($sql); $this->db->next_record(); $sys_user =$this->db->Record[I12851]; $sql =I12846; $lIllLII =Array(); if(count($this->IIl1lLL) >0) $sql ="select g.id, name, g.description, g.is_default, g.guest, ". "g.group_mask, g.login  ". "FROM cms_sys_groups g ". "WHERE 1 AND g.id in('".implode(I12852, $this->IIl1lLL)."') "; else $vData["selected_groups"] =$this->cms->Gui->getAbs($this->module->GetName().":selected_groups_list_empty"); $i =0; if(!empty($sql)){ $this->db->query($sql); if($this->db->num_rows() >0) {$this->IIl1lLL =Array(); $vData['selected_groups'] =I12844; while($this->db->next_record()){ $i++; $lllILIL =$this->db->Record; $this->db->Record[I12853] =0; if(empty($this->db->Record[I12853])){ $lllILIL['remove_ok'] =1; }else{ $lllILIL['remove_ok'] =$sys_user ?0 :1; }$this->_CreateActions($lllILIL, $vData); $this->_CBModules($lllILIL, $vData); $lllILIL["is_default"] =$lllILIL["is_default"] == 1 ?$this->cms->Gui->getAbs($this->module->GetName()."_list:spec_default_on", Array("spec_act_id" => $lllILIL["id"])) :$this->cms->Gui->getAbs($this->module->GetName()."_list:spec_default_off", Array("spec_act_id" => $lllILIL[I12854])); $lllILIL["guest"] =$lllILIL["guest"] == 1 ?$this->cms->Gui->getAbs($this->module->GetName()."_list:spec_guest_on", Array("spec_act_id" => $lllILIL[I12854])) :$this->cms->Gui->getAbs($this->module->GetName()."_list:spec_guest_off", Array("spec_act_id" => $lllILIL[I12854])); $lllILIL["login"] =$lllILIL["login"] == 1 ?$this->cms->Gui->getAbs($this->module->GetName()."_list:spec_login_on", Array(I12855 => $lllILIL[I12854])) :$this->cms->Gui->getAbs($this->module->GetName()."_list:spec_login_off", Array(I12855 => $lllILIL[I12854])); $lllILIL["name"] =$this->cms->stripLine($lllILIL["name"], 25); $lllILIL["style"] =$this->browser->style[I12856]; if($i %2 == 0) $lllILIL["style"] =$this->browser->style["even"]; if($lllILIL[I12854] == $this->id) $lllILIL["style"] =$this->browser->style["edited"]; if($lllILIL[I12854] == $this->appliedId) $lllILIL[I12857] =$this->browser->style["last_edited"]; $lllILIL["is_selected_in_use"] =true; $lIllLII[] =$lllILIL[I12854]; $this->IIl1lLL[] =$lllILIL[I12854]; $vData["selected_groups"] .= $this->cms->Gui->get($this->module->GetName().":selected_row", $lllILIL); }$vData["selected_groups_header"] =$this->cms->Gui->getAbs($this->module->GetName().":selected_groups_header", I12846); }else{ $vData["selected_groups"] =$this->cms->Gui->getAbs($this->module->GetName().":selected_groups_list_empty"); }}$vData["num_groups"] =count($this->IIl1lLL); $vData[I12858] =implode(I12841, $this->IIl1lLL); if(mb_strlen($vData[I12858]) == 0) $vData[I12858] =I12841; else $vData[I12858] =I12841.$vData[I12858].I12841; $this->browser->InitSQL("g.id, name, g.description, g.is_default, g.guest,g.group_mask, g.login ", "FROM cms_sys_groups g", "WHERE 1 ".(count($lIllLII) >0 ?"AND id NOT IN ('".implode(I12852, $lIllLII).I12859 :I12846).$this->_ApplyFilters().$this->TTTlIl1(), I12846, "name" );$aCustom['fields'] =Array( 'actions'=>Array('action'=>I12860, 'object'=>&$this, 'method'=>'_CreateActions'), 'guest'=>Array(I12861=>'flagicon', 'value'=>1, 'id'=>'spec_act_id', I12862=>'sys_groups_popup_list:spec_guest_on','off'=>'sys_groups_popup_list:spec_guest_off'), 'login'=>Array(I12861=>I12863, 'value'=>1, 'id'=>'spec_act_id', I12862=>'sys_groups_popup_list:spec_login_on',I12864=>'sys_groups_popup_list:spec_login_off'), I12865=>Array(I12861=>I12860, 'object'=>&$this, 'method'=>I12866), 'name'=>Array(I12861=>I12867, 'size'=>25), );$aCustom['applied_id'] ='g.id'; $aCustom['legend'] =Array(I12868, 'spec_guest_leg', 'spec_login_leg', 'leg_red', 'leg_yellow', I12869, "leg_move", "leg_remove", 'leg_edit', 'leg_del'); $aCustom[I12870]["buttons"] =Array("add", "apply", "cancel", I12871); parent::TTTlI11($vData, $aCustom); }function _CreateActions(&$aItem, &$aData){ $aItem["edit_id"] =$aItem["del_id"] =$aItem['id']; $off =(($aItem["is_default"] == 1 || $aItem[I12872] == 1 || !empty($aItem[I12853])) ?"off" :I12846); $aItem["actions"] =$this->cms->Gui->get('sys_groups_popup_list:icons_edit_del'.$off, $aItem); }function _CBModules(&$aItem, &$aData){ $aItem[I12873] =sizeof($this->cms->Core->TTllI1T($aItem['id'])); }function TTTlT1l() {return $this->cms->Core->IsSysUser() ?SYS_A_RIGHT :0; }function TTTlT1T($IIIL11l,$id,$cModule,&$IIlLI1l) {return $this->cms->Core->IsSysUser() ?$IIIL11l :I12874; }function _ActionMove($cId, $cModule) {$lIllLll =false; if(in_array($cId, $this->IIl1lLL)) $lIllLll =true; if(!$lIllLll) array_push($this->IIl1lLL, $cId); $this->cms->AddStatusMsg("status_add_to_list"); $this->appliedId =$cId; }function TIIlTTT($cId, $cModule) {if(in_array($cId, $this->IIl1lLL)){ $key =array_search($cId, $this->IIl1lLL); unset($this->IIl1lLL[$key]); $this->appliedId =$cId; $this->browser->SetApplied($this->db, $asql, $this->langData); }$this->cms->AddStatusMsg("status_remove_from_list"); }function TIl1Ill($default,$guest) {if(intval($guest)==1) {$sql ="UPDATE cms_sys_groups SET guest='0'"; $this->db->query($sql); $sql ="UPDATE cms_sys_groups SET guest='1' WHERE id='".$this->appliedId.I12875; $this->db->query($sql); }}function TTTll11($cId, $cModule) {$IIIILIl =Array(); $sql ="SELECT CONV(g.group_mask, 10, 2) AS mask FROM cms_sys_groups g"; $this->db->query($sql); while($this->db->next_record()){ $mask =$this->db->Record["mask"]; for($i =0; $i <mb_strlen($mask); $i++) if($mask[mb_strlen($mask)-$i-1] == "1") $IIIILIl[$i] ="1"; }$IIIILI1 =-1; for($i =0; $i <63; $i++){ if(isset($IIIILIl[$i]) && $IIIILIl[$i] =I12876) continue; else $IIIILI1 =$i; break; }if($IIIILI1<0){ $this->SetLastError(100, "Bitmask fail"); $this->cms->AddStatusMsg("bitmask_fail", "red"); return; }$this->db->query("SELECT id FROM cms_sys_groups WHERE name='".$this->cms->Vars[I12877].I12875); if($this->db->next_record()) {$this->cms->AddStatusMsg("group_exists", "red"); return; }$IIIILlI =$IIIILI1>31 ?0 :1<<$IIIILI1; $m1 =$IIIILI1>31 ?1<<($IIIILI1-32) :0; parent::TTTll11($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno']) && $this->appliedId >0){ if($this->cms->VarsPost["add_to_list"] == I12876){ array_push($this->IIl1lLL, $this->appliedId); $this->cms->AddStatusMsg(I12878); }$sql ="UPDATE cms_sys_groups SET group_mask=($m1<<32)+$IIIILlI WHERE id='".$this->appliedId.I12875; $this->db->query($sql); $this->TIl1Ill($this->cms->VarsPost['is_default'],$this->cms->VarsPost['guest']); }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT g.* FROM cms_sys_groups g WHERE g.id='".$cId.I12875.$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData['is_default'] =($this->itemData[I12879] == 1) ?'checked': I12844; $this->itemData['guest'] =($this->itemData['guest'] == 1) ?'checked': I12844; $this->itemData[I12880] =($this->itemData[I12880] == 1) ?'checked': I12844; $this->itemData[I12877] =$this->cms->htmlchars($this->db->Record["name"]); $this->itemData['description'] =$this->cms->htmlchars($this->db->Record["description"]); if($this->itemData[I12881]){ $this->itemData["is_default_disabled"] ="disabled"; }if($this->itemData[I12872]){ $this->itemData["guest_disabled"] ="disabled"; $this->itemData[I12882] =' disabled="disabled"'; }if(in_array($cId, $this->IIl1lLL)) $this->itemData["add_to_list"] ="checked"; }$this->itemData["submit_add"] =I12883; $this->itemData["submit_apply"] =I12846; $this->itemData[I12849] ="apply"; }function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno']) && $this->appliedId >0){ if($this->cms->VarsPost["add_to_list"] == I12876 && !in_array($cId, $this->IIl1lLL)){ array_push($this->IIl1lLL, $this->appliedId); $this->cms->AddStatusMsg(I12878); }else if($this->cms->VarsPost[I12884] != I12876 && in_array($cId, $this->IIl1lLL)){ $key =array_search($cId, $this->IIl1lLL); unset($this->IIl1lLL[$key]); }$this->TIl1Ill($this->cms->VarsPost[I12879],$this->cms->VarsPost['guest']); }}function _ActionDel($cId, $cModule) {$sql ="SELECT * FROM cms_sys_groups WHERE id=$cId"; $this->db->query($sql); $this->db->next_record(); $mask =$this->db->Record['group_mask']; parent::_ActionDel($cId, $cModule); $II1LLLL =$this->GetLastError(); if(empty($II1LLLL['errno']) && $cId >0){ $sql ="DELETE FROM cms_sys_users where id_group='".intval($cId).I12875; $this->db->query($sql); $sql ="UPDATE cms_sys_actions_rights SET group_mask=group_mask & ~$mask "; $this->db->query($sql); }$this->cms->Core->UpdateRightsVersion(); }function TTT1IlI($aSql =array(), $cId =0){ $name =$this->cms->VarsPost[I12877]; if($name == I12844){ return $aSql; }$aSql =Array( I12877 => $name, I12885 => $this->cms->VarsPost[I12885], I12880 => intval($this->cms->VarsPost[I12880]) && empty($this->cms->VarsPost['guest']) );return $aSql; }}