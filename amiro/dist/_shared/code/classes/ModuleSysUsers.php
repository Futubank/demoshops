<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       16777 xkqwqtpqnuxniiqgyizrzpnwskknpngqwkixzpskzxtlpzwtnutzwiugzrinyipkutrtpnir
 */ ?><?php foreach(array(12906=>'SQfZuJt|GrQfMx',12907=>"uDQr",12908=>'',12909=>"SZtQtH",12910=>"",12911=>"qigTb|gzddchRs",12912=>"IQIYQr|fHrI",12913=>"yUmjsqR|VqRdmhN",12914=>"I`MS!?u`MS|IQIYQr",12915=>"Ou",12916=>"coqRq?1?",12917=>"W",12918=>"WZJJYZWK",12919=>"ZWtMHn",12920=>"Hn",12921=>"DtrMGJMnQ",12922=>"DMAQ",12923=>"nHtZWtMvQ",12924=>"JQP|QSMt",12925=>"JHPMn",12926=>"WZnWQJ",12927=>'DBD|uDQr',12928=>'rQDQt|MS',12929=>"DtZtuD|uDQr|ZSS",12930=>'FhRi|ihsq',12931=>'1',12932=>"PrHuG|MSD",12933=>"PrHuGD",12934=>'MS',12935=>"GZDDCHrS",12936=>"DJZDOQD",12937=>'mnvZJMS?IHSuJQ?ZWtMHn',12938=>"rQS",12939=>"ZWtMvZtQ",12940=>"DtZtuD|ZWtMvZtQ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleSysUsers extends CMS_ActModule {public $user; public $permissions; public $domain; protected $lIlL1I1 =array(); function ModuleSysUsers(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); }function _Init($IIll1l1 =Array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =Array()) {$oSess =admSession(); $this->domain =$oSess->TlIT11I(); $IIIIL11[I12906] ='m'; $IIIIL11['check_public'] =false; $IIIIL11['lang_data'] =false; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $this->permissions =Array(); $none =""; $this->user =new CMS_Member($none, I12907); $sql ="SELECT m.id, m.username " ."FROM `cms_host_users` u " ."LEFT JOIN `cms_members` m ON m.id = u.id_member " ."WHERE u.sys_user = 1"; $this->lIlL1I1 =$this->db->getRecord($sql); }function ProcessAction($IIIL11l, $cId, $cModule =I12908) {$id =intval($cId); switch ($IIIL11l) {case "activate": $this->_ActionActivate($cId, $cModule); break; case "reset": $this->_ActionReset($cId, $cModule); break; default: parent::ProcessAction($IIIL11l, $cId, $cModule); break; }}function TTTlIII() {parent::TTTlIII(); if($this->filter->issetField("datefrom")){ $this->filter->TITI1l1("datefrom"); }if($this->filter->issetField(I12909)){ $this->filter->TITI1l1(I12909); }$this->filter->AddField("flt_name", "text", isset($this->cms->Vars["flt_name"]) ?stripslashes(unhtmlentities($this->cms->Vars["flt_name"])) :I12908, I12910, " like ", "m.username"); $this->filter->MoveField("flt_name", _MOVE_START); }function TTTlI1I(&$vData) {if($this->action == "edit") {$I1lLIll[I12911] ="1"; $this->cms->Gui->addGlobalVars($I1lLIll); }$I1lLII1 =$this->user->getScripts($this->cms, $this->action=='edit'? $this->module->GetName() :I12908); $vData["header_memeber_script"] =$I1lLII1["header"]; $vData["check_member_script"] =$I1lLII1["check_form"]; if($this->action != "add") {$vData["on_change_member_script"] =$I1lLII1["on_change"]; }$vData[I12912] =$this->user->getForm($this->cms, $this->db, $this->itemData); $vData['groups'] ='0'; $vData['group_ids'] =';'; parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {if($GLOBALS[I12913] <2){ $this->browser->InitSQL("m.id, m.username, m.firstname, m.lastname, m.email, m.active, count(u.id) as groups,hu.sys_user ", "FROM cms_members m LEFT JOIN cms_sys_users u ON m.id=u.id_member ". "LEFT JOIN cms_host_users hu ON m.id=hu.id_member ", "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), I12914, "username" );$this->browser->AddSQLJoinedTables($this->cms->Core, "m", Array("u"=>"cms_sys_users",I12915=>"cms_host_users")); }else{ $this->browser->InitSQL("m.id, m.username, m.firstname, m.lastname, m.email, m.active, count(u.id) as groups,c.is_sys as sys_user ", "FROM cms_members m LEFT JOIN cms_sys_users u ON m.id=u.id_member ". "LEFT JOIN cms_hst_res_cms_inst c ON m.id=c.id_admin ", I12916.$this->_ApplyFilters().$this->TTTlIl1(), I12914, "username" );$this->browser->AddSQLJoinedTables($this->cms->Core, "m", Array("u"=>"cms_sys_users",I12917=>"cms_hst_res_cms_inst")); }$aCustom["fields"] += Array( "id"=>Array("action"=>I12918, "object"=>&$this, "method"=>"_CBProcessId"), "active"=>Array(I12919=>"flagicon", "value"=>1, "id"=>"act_id", I12920=>$this->module->GetName()."_list:active_on","off"=>$this->module->GetName()."_list:active_off"), "username"=>Array(I12919=>I12921, "size"=>20), "lastname"=>Array(I12919=>I12921, "size"=>15), "firstname"=>Array(I12919=>I12921, I12922=>15), );$aCustom["applied_id"] ="m.id"; $aCustom["legend"] =Array("onactive", I12923, "spec_login_leg", "leg_red", "leg_yellow", "leg_blue", I12924, "leg_reset", "leg_del"); if($this->appliedId>0) $this->browser->ArrangePosSQL($this->db, $this->appliedId, $aCustom["applied_id"]); $this->browser->ProcessSQL($this->db); $lllILIl =Array(); while($this->db->next_record()) $lllILIl[] =$this->db->Record["id"]; foreach($lllILIl as $value){ $this->permissions[$value][I12925] =0; $sql ="select g.login from cms_sys_users u LEFT JOIN cms_sys_groups g on u.id_group=g.id where u.id_member='$value'"; $this->db->query($sql); while($this->db->next_record()){ $this->permissions[$value][I12925] |= $this->db->Record[I12925]; }}$aCustom["form_data"]["buttons"] =Array("add", "apply", I12926, "save"); parent::TTTlI11($vData, $aCustom); }function _CBProcessId(&$aItem, &$aData){ $aItem[I12925] =$this->cms->Gui->get($this->module->GetName().'_list:spec_login_'.($this->permissions[$aItem["id"]][I12925] == 1 ?I12920 :"off"), $aItem); $del =$aItem[I12927]==1 ?I12910 :"_del"; $id =$aItem['id']; $links =array('edit_id'=>$id,'del_id'=>$id,I12928=>$id); if($this->cms->Core->TTlllTI() && $id == $this->lIlL1I1['id']){ $aItem['actions'] =$this->cms->Gui->get('members_list:icon_none', $links) .$this->cms->Gui->get('members_list:icon_none', $links) .$this->cms->Gui->get('members_list:icon_none', $links); }else{ $aItem['actions'] =$this->cms->Gui->getAbs($this->module->GetName()."_list:icons_edit", $links); }}function TIl1I1T() {$lllIL1I =explode(';',$this->cms->VarsPost["group_ids"]); $lllIL1l =array(); foreach($lllIL1I as $gid) {$gid =intval($gid); if(!$gid) continue; $lllIL1l[] =$gid; }$lllIL1I =array(); if(sizeof($lllIL1l)) {$sql ="SELECT id FROM cms_sys_groups WHERE id IN(".implode(',',$lllIL1l).")"; $this->db->query($sql); while($this->db->next_record()) $lllIL1I[] =$this->db->Record['id']; }$memberId =intval($this->appliedId); $this->db->query("DELETE FROM cms_sys_users WHERE id_member=$memberId"); foreach($lllIL1I as $gid) $this->db->query("INSERT cms_sys_users (id_member,id_group) VALUES($memberId,$gid)"); $this->cms->Core->UpdateRightsVersion(); }function TTTlT1l() {return $this->cms->Core->IsSysUser() ?SYS_A_RIGHT :0; }function TTTlT1T($IIIL11l,$id,$cModule,&$IIlLI1l) {return $this->cms->Core->IsSysUser() ?$IIIL11l :'none'; }function TTTll11($cId, $cModule) {$IlIl1LI =$this->cms->VarsPost; $id_member =$this->user->checkUsername($this->db, $IlIl1LI[$this->user->getLoginField()]); if($id_member == 0 && $this->user->createMember($this->cms, $this->db, $IlIl1LI, false)){ $this->appliedId =$this->db->lastInsertId(); $this->browser->SetApplied($this->db, $asql, $this->langData); $this->TIl1I1T(); $this->SetLastError(); $this->cms->AddStatusMsg(I12929); }else {$this->itemData =removeSpecial($IlIl1LI, "slashes"); $this->SetLastError(1, "Adding failed"); $this->cms->AddStatusMsg("status_add_fail", "red"); }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $this->cms->Gui->AddGlobalVars( array( I12930 => 'EDIT', 'EDIT_USERNAME' => '0', 'EMPTY_PASSWORD' => I12931 ));$sql ="SELECT * FROM cms_members m WHERE m.id='".$cId."'".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData["website"] =$this->itemData["companyweb"]; }$this->itemData[I12932] =";"; $this->itemData["groups"] =0; $sql ="SELECT id_group FROM cms_sys_users WHERE id_member='$cId'"; $this->db->query($sql); if($this->db->next_record()){ $this->itemData[I12932] .= intval($this->db->Record["id_group"]).";"; $this->itemData[I12933] ++; $this->itemData['registration_date'] =date($this->cms->DFMT['php_dtime'], strtotime($this->itemData['date'])); }}function TTTl1lI($cId, $cModule) {$IlIl1LI =$this->cms->VarsPost; unset($IlIl1LI['username']); if($this->cms->Core->TTlllTI() && $cId == $this->lIlL1I1[I12934]){ $this->SetLastError(2, 'Apply failed'); $this->cms->AddStatusMsg('status_error', 'red'); }else{ if($this->user->updateMember($this->cms, $this->db, $cId, $IlIl1LI, true)){ $this->appliedId =$cId; $this->browser->SetApplied($this->db, $asql, $this->langData); $this->TIl1I1T(); if(!empty($this->cms->VarsPost["password"]) && $this->cms->VarsPost[I12935]==$this->cms->VarsPost["password2"]) {$this->user->TTI1I1l("username", $this->cms->VarsPost[$this->user->getLoginField()]); $this->user->TTI1I1l("id", $cId); $this->user->setPass($this->db, $this->cms->VarsPost[I12935]); }$this->SetLastError(); $this->cms->AddStatusMsg("status_user_apply"); }else{ $this->itemData =removeSpecial($IlIl1LI, I12936); $this->SetLastError(2, "Apply failed"); $this->cms->AddStatusMsg("status_error", "red"); }}}function _ActionDel($cId, $cModule) {trigger_error(I12937, E_USER_ERROR); if($GLOBALS[I12913] <2){ $this->db->query("SELECT id FROM cms_host_users WHERE id_member=$cId AND sys_user=1"); }else{ $this->db->query("SELECT id FROM cms_hst_res_cms_inst WHERE id_admin=$cId AND is_sys=1"); }if($this->db->next_record()) {$this->cms->AddStatusMsg("status_admin_del_fail",I12938); return; }if($this->user->deleteMember($this->cms, $this->db, $cId)) {$sql ="DELETE FROM cms_sys_users WHERE id_member='".$cId."'"; $this->db->query($sql); $this->cms->AddStatusMsg("status_user_del"); $this->SetLastError(); }else {$this->cms->AddStatusMsg("status_del_fail"); }$this->cms->Core->UpdateRightsVersion(); }function _ActionActivate($cId, $cModule) {if(isset($this->cms->VarsGet[I12939]) && $this->cms->VarsGet[I12939] == I12920) $active ="1"; else $active ="0"; if($GLOBALS[I12913] <2){ $sql ="SELECT m.active,u.sys_user ". "FROM cms_members m LEFT JOIN cms_host_users u ON u.id_member=m.id WHERE m.id='$cId'"; }else{ $sql ="SELECT m.active,c.is_sys as sys_user ". "FROM cms_members m LEFT JOIN cms_hst_res_cms_inst c ON c.id_admin=m.id WHERE m.id='$cId'"; }$this->db->query($sql); if($this->db->next_record() && $this->db->Record[I12927]==0){ $sql ="UPDATE cms_members SET active='$active' WHERE id='$cId'"; $this->db->query($sql); $this->cms->AddStatusMsg(I12940); }else {$this->cms->AddStatusMsg("status_activate_fail", I12938); }$this->appliedId =$cId; $this->browser->SetApplied($this->db, $asql, $this->langData); }function _ActionReset($cId, $cModule) {trigger_error(I12937, E_USER_ERROR); if($this->cms->Core->TTlllTI() && $cId == $this->lIlL1I1[I12934]){ $this->cms->AddStatusMsg('status_reset_fail', 'red'); }else{ $this->user->TTI1lIl($this->cms, $this->db, $cId, true); $this->cms->AddStatusMsg("status_reset"); $this->appliedId =$cId; $this->browser->SetApplied($this->db, $asql, $this->langData); }}}