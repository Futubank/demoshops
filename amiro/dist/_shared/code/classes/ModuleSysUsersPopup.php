<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       22163 xkqwlwmukspmyingpgpuzuwxxkurzitmipltrwzprpqwwwqlzwuwqswqziigxqnzxsslpnir
 */ ?><?php foreach(array(12941=>"PrHuGmS",12942=>"^",12943=>"I",12944=>'IHvQ',12945=>"SZtQtH",12946=>'',12947=>"LD|funWtMHnD",12948=>"IQtZD",12949=>"IQIYQrD",12950=>'QSMt',12951=>"ZSS",12952=>"",12953=>"PrHuG|MS",12954=>'ZWtMHnD',12955=>"|SQJ",12956=>"ZWtMvQ",12957=>"ZWt|MS",12958=>"QvQn",12959=>"DtBJQ",12960=>"fMrDtnZIQ",12961=>"DQJQWtQS|uDQrD",12962=>"nuI|uDQrD",12963=>"coqRq?1?",12964=>"u",12965=>"'!'",12966=>'fMQJSD',12967=>"Hn",12968=>"ZWtMHn",12969=>"DMAQ",12970=>'IQtOHS',12971=>"HnZWtMvQ",12972=>"JQP|IHvQ",12973=>"fHrI|SZtZ",12974=>'DBD|uDQr',12975=>"yUmjsqR|VqRdmhN",12976=>"rQS",12977=>'mnvZJMS?IHSuJQ?ZWtMHn',12978=>"ZSS|tH|JMDt",12979=>"zSSMnP?fZMJQS",12980=>'DtZtuD|ZSS|fZMJ',12981=>'qsmT',12982=>'GOG|StMIQ',12983=>"DuYIMt|ZGGJB",12984=>"DtZtuD|QrrHr",12985=>"MS",12986=>"DtZtuD|uDQr|ZGGJB") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleSysUsersPopup extends CMS_ActModule {public $groupId; public $lllILIl; protected $lIlL1I1 =array(); function ModuleSysUsersPopup(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); }function Init($IIll1l1 =Array(), $IIll1LI ='', $IIll1Ll ='', $aOptions =Array()) {if(isset($this->cms->Vars[I12941]) && $this->cms->Vars[I12941] != "") $this->groupId =intval($this->cms->Vars[I12941]); else $this->groupId =0; if(isset($this->cms->Vars["user_ids"]) && $this->cms->Vars["user_ids"] != "") $this->lllILIl =explode(I12942, $this->cms->Vars["user_ids"]); else $this->lllILIl =Array(); $IIlLLLL =$this->lllILIl; $this->lllILIl =Array(); $count =count($IIlLLLL); for($i =0; $i <$count; $i++){ $sql ="SELECT COUNT(*) AS count FROM cms_members WHERE id=".intval($IIlLLLL[$i]); $this->db->query($sql); if($this->db->next_record()){ if($this->db->Record["count"] >0) $this->lllILIl[] =intval($IIlLLLL[$i]); }}$IIIIL11["default_prefix"] =I12943; $IIIIL11["lang_data"] =false; $aOptions += $IIIIL11; parent::Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); $none =""; $this->user =new CMS_Member($none, "user"); $sql ="SELECT m.id, m.username " ."FROM `cms_host_users` u " ."LEFT JOIN `cms_members` m ON m.id = u.id_member " ."WHERE u.sys_user = 1"; $this->lIlL1I1 =$this->db->getRecord($sql); }function ProcessAction($IIIL11l, $cId, $cModule ='') {$id =intval($cId); switch ($IIIL11l) {case "activate": $this->_ActionActivate($cId, $cModule); break; case I12944: $this->_ActionMove($cId, $cModule); break; case 'remove': $this->TIIlTTT($cId, $cModule); break; default: parent::ProcessAction($IIIL11l, $cId, $cModule); break; }}function TTTlIII() {parent::TTTlIII(); if($this->filter->issetField("datefrom")){ $this->filter->TITI1l1("datefrom"); }if($this->filter->issetField("dateto")){ $this->filter->TITI1l1(I12945); }$this->filter->AddField("flt_name", "text", isset($this->cms->Vars['flt_name']) ?stripslashes(unhtmlentities($this->cms->Vars['flt_name'])) :I12946, "", " like ", "m.username"); $this->filter->MoveField("flt_name", _MOVE_START); }function &TTTlI1T(&$aCustom) {$data =parent::TTTlI1T($aCustom); $data[I12947] =$this->cms->Gui->get($this->module->GetName().":js_users", $data); $data["selected_users_list"] =$this->cms->Gui->get($this->module->GetName().":selected_users_list", $data); $data["scripts"] =$this->cms->Gui->getScripts(); $data[I12948] =$this->cms->Gui->getMetas(); $data["status"] =$this->cms->GetStatusMessages(); $data["filter"] =$this->filter->getFilterHtml(); global $conn; print $this->cms->Gui->get($this->module->GetName(), $data); $conn->Out(); die(); }function TTTlI1I(&$vData) {if(isset($this->itemData['id']) && $this->itemData['id']>0) {$mMembers =$this->cms->Core->GetModule(I12949); $this->cms->Gui->AddGlobalVars(Array("FORM_MODE"=>"EDIT")); $this->cms->Gui->AddGlobalVars(Array('EMPTY_PASSWORD'=>1)); $this->user->setObligatory($mMembers->GetOption('admin_required_fields'), true, true); }$I1lLII1 =$this->user->getScripts($this->cms, $this->action==I12950? $this->module->GetName() :I12946); $vData["header_memeber_script"] =$I1lLII1["header"]; $vData["check_member_script"] =$I1lLII1["check_form"]; if($this->action != I12951) {$vData["on_change_member_script"] =$I1lLII1["on_change"]; }$vData["member_form"] =$this->user->getForm($this->cms, $this->db, $this->itemData); $vData["submit_add"] =I12952; $vData["submit_apply"] ="disabled"; $vData["action"] =I12951; $vData["add_to_list"] =I12952; $vData[I12953] =$this->groupId; $vData["num_users"] ="0"; parent::TTTlI1I($vData); }function TTTlI11(&$vData, &$aCustom) {$sql =I12952; $lIllLII =Array(); if(count($this->lllILIl) >0) if($GLOBALS["BUILDER_VERSION"] <2){ $sql ="SELECT m.id, m.active, m.username, m.lastname, m.firstname, m.email, u.sys_user ". "FROM cms_members m LEFT JOIN cms_host_users u ON m.id=u.id_member ". "WHERE 1 AND m.id IN('".implode("','", $this->lllILIl)."') "; }else{ $sql ="SELECT m.id, m.active, m.username, m.lastname, m.firstname, m.email, c.is_sys as sys_user ". "FROM cms_members m LEFT JOIN cms_hst_res_cms_inst c ON m.id=c.id_admin ". "WHERE 1 AND m.id IN('".implode("','", $this->lllILIl)."') "; }else $vData["selected_users"] =$this->cms->Gui->getAbs($this->module->GetName().":selected_users_list_empty"); $i =0; if(!empty($sql)){ $this->db->query($sql); if($this->db->num_rows() >0) {$this->lllILIl =Array(); $vData['selected_users'] =I12946; while($this->db->next_record()){ $i++; $lllIL1L =$this->db->Record; $lllIL1L['remove_ok'] =1; if($this->cms->Core->TTlllTI() && $lllIL1L['id'] == $this->lIlL1I1['id']){ $lllIL1L[I12954] =$this->cms->Gui->get('members_list:icon_none', $links) .$this->cms->Gui->get('members_list:icon_none', $links) .$this->cms->Gui->get('members_list:icon_none', $links); }else{ if(intval($this->db->Record['sys_user'])==1) {$del =I12952; }else {$del =I12955; }$lllIL1L["actions"] =$this->cms->Gui->getAbs($this->module->GetName()."_list:icons_edit", Array("edit_id" => $lllIL1L["id"])); }$lllIL1L[I12956] =$lllIL1L[I12956] == 1 ?$this->cms->Gui->getAbs($this->module->GetName()."_list:active_on", Array("act_id" => $lllIL1L["id"])) :$this->cms->Gui->getAbs($this->module->GetName()."_list:active_off", Array(I12957 => $lllIL1L["id"])); $lllIL1L["style"] =$this->browser->style["simple"]; if($i %2 == 0) $lllIL1L["style"] =$this->browser->style[I12958]; if($lllIL1L["id"] == $this->id) $lllIL1L["style"] =$this->browser->style["edited"]; if($lllIL1L["id"] == $this->appliedId) $lllIL1L[I12959] =$this->browser->style["last_edited"]; $lllIL1L["is_selected_in_use"] =true; $lllIL1L["username"] =$this->cms->stripLine($lllIL1L["username"], 25); $lllIL1L[I12960] =$this->cms->stripLine($lllIL1L[I12960], 25); $lllIL1L["lastname"] =$this->cms->stripLine($lllIL1L["lastname"], 25); $lIllLII[] =$lllIL1L["id"]; $this->lllILIl[] =$lllIL1L["id"]; $vData[I12961] .= $this->cms->Gui->get($this->module->GetName().":selected_row", $lllIL1L); }$vData["selected_users_header"] =$this->cms->Gui->getAbs($this->module->GetName().":selected_users_header", I12952); }else{ $vData[I12961] =$this->cms->Gui->getAbs($this->module->GetName().":selected_users_list_empty"); }}$vData[I12962] =count($this->lllILIl); $vData["user_ids"] =implode(I12942, $this->lllILIl); if($GLOBALS["BUILDER_VERSION"] <2){ $this->browser->InitSQL("m.id, m.active, m.username, m.lastname, m.firstname, m.email, u.sys_user ", "FROM cms_members m LEFT JOIN cms_host_users u ON u.id_member=m.id ", I12963.(count($lIllLII) >0 ?"AND m.id NOT IN ('".implode("','", $lIllLII)."') " :I12952).$this->_ApplyFilters().$this->TTTlIl1(), I12952, "username" );$this->browser->AddSQLJoinedTables($this->cms->Core, I12943, Array(I12964=>"cms_host_users")); }else{ $this->browser->InitSQL("m.id, m.active, m.username, m.lastname, m.firstname, m.email, c.is_sys as sys_user ", "FROM cms_members m LEFT JOIN cms_hst_res_cms_inst c ON c.id_admin=m.id ", I12963.(count($lIllLII) >0 ?"AND m.id NOT IN ('".implode(I12965, $lIllLII)."') " :I12952).$this->_ApplyFilters().$this->TTTlIl1(), I12952, "username" );$this->browser->AddSQLJoinedTables($this->cms->Core, I12943, Array("c"=>"cms_hst_res_cms_inst")); }$aCustom[I12966] =Array( I12956=>Array("action"=>"flagicon", "value"=>1, "id"=>I12957, I12967=>$this->module->GetName()."_list:active_on","off"=>$this->module->GetName()."_list:active_off"), "username"=>Array(I12968=>"stripline", "size"=>25), "lastname"=>Array(I12968=>"stripline", I12969=>25), I12960=>Array(I12968=>"stripline", I12969=>25), I12954=>Array('action'=>'callback', 'object'=>&$this, I12970=>'_CBActions') );$aCustom['applied_id'] ='m.id'; $aCustom["legend"] =Array(I12971, "notactive", "leg_red", "leg_yellow", "leg_blue", I12972, "leg_remove", "leg_edit", "leg_reset", "leg_del"); $aCustom[I12973]["buttons"] =Array(I12951, "apply", "cancel", "save"); parent::TTTlI11($vData, $aCustom); }function _CBActions(&$aItem,&$aData) {$del =$aItem[I12974]==1 ?I12952 :I12955; $id =$aItem['id']; $links =array('edit_id'=>$id); if($this->cms->Core->TTlllTI() && $id == $this->lIlL1I1['id']){ $aItem[I12954] =$this->cms->Gui->get('members_list:icon_none', $links) .$this->cms->Gui->get('members_list:icon_none', $links) .$this->cms->Gui->get('members_list:icon_none', $links); }else{ $aItem[I12954] =$this->cms->Gui->getAbs($this->module->GetName()."_list:icons_edit", $links); }}function TTTlT1l() {return $this->cms->Core->IsSysUser() ?SYS_A_RIGHT :0; }function TTTlT1T($IIIL11l,$id,$cModule,&$IIlLI1l) {return $this->cms->Core->IsSysUser() ?$IIIL11l :'none'; }function _ActionMove($cId, $cModule) {$lIllLll =false; if(in_array($cId, $this->lllILIl)) $lIllLll =true; if(!$lIllLll) array_push($this->lllILIl, $cId); $this->cms->AddStatusMsg("status_add_to_list"); $this->appliedId =$cId; }function TIIlTTT($cId, $cModule) {if(in_array($cId, $this->lllILIl)){ $key =array_search($cId, $this->lllILIl); unset($this->lllILIl[$key]); $this->appliedId =$cId; $this->browser->SetApplied($this->db, $asql, $this->langData); }$this->cms->AddStatusMsg("status_remove_from_list"); }function _ActionActivate($cId, $cModule) {if(isset($this->cms->VarsGet["activate"]) && $this->cms->VarsGet["activate"] == I12967) $active ="1"; else $active ="0"; if($GLOBALS[I12975] <2){ $sql ="SELECT m.active,u.sys_user ". "FROM cms_members m LEFT JOIN cms_host_users u ON u.id_member=m.id WHERE m.id='$cId'"; }else{ $sql ="SELECT m.active,c.is_sys as sys_user ". "FROM cms_members m LEFT JOIN cms_hst_res_cms_inst c ON c.id_admin=m.id WHERE m.id='$cId'"; }$this->db->query($sql); if($this->db->next_record() && $this->db->Record[I12974]==0){ $sql ="UPDATE cms_members SET active='$active' WHERE id='$cId'"; $this->db->query($sql); $this->cms->AddStatusMsg("status_activate"); }else {$this->cms->AddStatusMsg("status_activate_fail", I12976); }$this->appliedId =$cId; if(!in_array($cId, $this->lllILIl)) $this->browser->SetApplied($this->db, $asql, $this->langData); }function _ActionReset($cId, $cModule) {trigger_error(I12977, E_USER_ERROR); $this->user->TTI1lIl($this->cms, $this->db, $cId, true); if($this->cms->Core->TTlllTI() && $cId == $this->lIlL1I1['id']){ $this->cms->AddStatusMsg('status_reset_fail', 'red'); }else{ $this->cms->AddStatusMsg("status_reset"); $this->appliedId =$cId; if(!in_array($cId, $this->lllILIl)){ $this->browser->SetApplied($this->db, $asql, $this->langData); }}}function TTTll11($cId, $cModule) {$IlIl1LI =$this->cms->VarsPost; $id_member =$this->user->checkUsername($this->db, $IlIl1LI[$this->user->getLoginField()]); if($id_member == 0 && $this->user->createMember($this->cms, $this->db, $IlIl1LI, false)){ $this->appliedId =$this->db->lastInsertId(); if($IlIl1LI[I12978] == "1"){ array_push($this->lllILIl, $this->appliedId); $this->cms->AddStatusMsg("status_add_to_list"); }else $this->browser->SetApplied($this->db, $asql, $this->langData); $this->SetLastError(); $this->cms->AddStatusMsg("status_user_add"); }else {$this->itemData =removeSpecial($IlIl1LI, "slashes"); $this->SetLastError(1, I12979); $I1lLIL1 =$this->user->TTI1I1I(); $field =$this->user->getLoginField(); if(in_array('email', $I1lLIL1)){ $field ='email'; }elseif(!in_array('username', $I1lLIL1)){ $field ='nickname'; }$this->cms->AddStatusMsg(I12980, 'red', I12946, I12946, array('login_field' => $this->cms->Messages['login_field_' .$field])); }}function _ActionDel($cId, $cModule) {trigger_error(I12977, E_USER_ERROR); if($GLOBALS[I12975] <2){ $this->db->query("SELECT id FROM cms_host_users WHERE id_member=$cId AND sys_user=1"); }else{ $this->db->query("SELECT id FROM cms_hst_res_cms_inst c WHERE id_admin=$cId AND is_sys=1"); }if($this->db->next_record()) {$this->cms->AddStatusMsg("status_admin_del_fail",I12976); return; }if($this->user->deleteMember($this->cms, $this->db, $cId)) {$sql ="DELETE FROM cms_sys_users WHERE id_member='".$cId."'"; $this->db->query($sql); $this->cms->Core->UpdateRightsVersion(); $this->cms->AddStatusMsg("status_user_del"); $this->SetLastError(); }else {$this->cms->AddStatusMsg("status_del_fail"); }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $this->cms->Gui->AddGlobalVars( array( 'FORM_MODE' => I12981, 'EDIT_USERNAME' => '0', 'EMPTY_PASSWORD' => '1' ));$sql ="SELECT * FROM cms_members m WHERE m.id='".$cId."'".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()) {$this->itemData =$this->db->Record; $this->itemData["website"] =$this->itemData["companyweb"]; $this->itemData['registration_date'] =date($this->cms->DFMT[I12982], strtotime($this->itemData['date'])); }if(in_array($cId, $this->lllILIl)){ $this->itemData[I12978] ="checked"; }$this->itemData["submit_add"] ="disabled"; $this->itemData[I12983] =I12952; $this->itemData[I12968] ="apply"; }function TTTl1lI($cId, $cModule) {$IlIl1LI =$this->cms->VarsPost; unset($IlIl1LI['username']); if($this->cms->Core->TTlllTI() && $cId == $this->lIlL1I1['id']){ $this->SetLastError(2, "Apply failed"); $this->cms->AddStatusMsg(I12984, I12976); }elseif($this->user->updateMember($this->cms, $this->db, $cId, $IlIl1LI, true)){ if(!empty($IlIl1LI["password"]) && $IlIl1LI["password"]==$IlIl1LI["password2"]) {$this->user->TTI1I1l("username", $IlIl1LI[$this->user->getLoginField()]); $this->user->TTI1I1l(I12985, $cId); $this->user->setPass($this->db, $IlIl1LI["password"]); }$this->appliedId =$cId; if($IlIl1LI[I12978] == "1" && !in_array($cId, $this->lllILIl)){ array_push($this->lllILIl, $this->appliedId); $this->cms->AddStatusMsg("status_add_to_list"); }else if($IlIl1LI[I12978] != "1" && in_array($cId, $this->lllILIl)){ $key =array_search($cId, $this->lllILIl); unset($this->lllILIl[$key]); }if(!in_array($cId, $this->lllILIl)) $this->browser->SetApplied($this->db, $asql, $this->langData); $this->SetLastError(); $this->cms->AddStatusMsg(I12986); }else{ $this->itemData =removeSpecial($IlIl1LI, "slashes"); $this->SetLastError(2, "Apply failed"); $this->cms->AddStatusMsg(I12984, I12976); }}}