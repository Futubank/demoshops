<?php /**
 * @author     Aleksey Bezzubov <clumsy@amiro.ru> 
 * @version    1.0. Last changes: 04/03/2008 by Aleksey Bezzubov 
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @size       21654 xkqwngssgmkmqsnrnuuqknuxqlzgllwmtnltquluwtrngmyxsgsurtqzsyuktpqpswilpnir
 */ ?><?php foreach(array(12987=>"",12988=>"PrHuG|HGQrZtMHnD",12989=>"uDQ|HGtMHnD|fHrI",12990=>"tZPD",12991=>"SZtQfrHI",12992=>"GHGuG",12993=>"fJt|tZP",12994=>"CHrSD",12995=>"!?tZPD{",12996=>"DQZrWO|nHt|MnDtZJJQS",12997=>"FRhi?WID|tZPD?t?",12998=>"ZWtMHn|QSMt",12999=>"QSMt|MS",13000=>"ZWtMHn",13001=>"Hn",13002=>"vZJuQ",13003=>"|JMDt%DQJQWt|MWHn",13004=>"fHrI",13005=>"QSMt",13006=>"JQP|YJuQ",13007=>'YHSB|tZPD',13008=>"MtQI|",13009=>"JMDt|DQt|nHt|fHunS",13010=>"MtQI|rHCD",13011=>"Drv|tZPD",13012=>"DI|SZtZ",13013=>"iHSuJQotIJ",13014=>"MS",13015=>'tZP',13016=>"MtQId|",13017=>"fMQJSD",13018=>"|FHrIZtdQZrWORHCwy",13019=>"GZPQ|DMAQ",13020=>"'",13021=>'IQtZD',13022=>"nQCD",13023=>".?coqRq?tZPD?#@?''",13024=>"'?coqRq?MS?=?'",13025=>"ZGGJB",13026=>'vZJuQ',13027=>"WHunt",13028=>"|pQtdIZJJsQtZMJDwy",13029=>"DIZJJ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleTags extends CMS_ActModule {public $_filter; public $llI11Il; public $navData; public $viewType; public $IL1L1ll; function ModuleTags(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); $this->llI11Il =null; $this->navData =""; $this->viewType =""; }function _Init($IIll1l1 =Array(), $IIll1LI =I12987, $IIll1Ll =I12987, $aOptions =Array()) {$this->IL1L1ll =$this->cms->Core->IsInstalled('srv_tags_reindex'); if (empty($this->cms->Vars['popup'])) {$IIIIL11["group_operations"][] ="del"; }$IIIIL11[I12988][] ="apply"; $IIIIL11[I12988][] ="gen_keywords"; $IIIIL11[I12988][] ="gen_sublink"; $IIIIL11["use_id_page"] =true; $IIIIL11[I12989] =true; $IIIIL11["name_field_name"] ="tag"; $IIIIL11["allowed_actions"] =array ("select"); $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function _InitAdmin() {parent::_InitAdmin(); }function TTTlIII() {if($this->cms->Vars[I12990]){ $sql ="SELECT id FROM `cms_tags` WHERE LOCATE(CONCAT(',', tag, ','), ',".mysql_real_escape_string($this->cms->Vars[I12990]).",') > 0"; $rs =&$this->db->select($sql); while($IL1L1lL =$rs->nextRecord()){ $this->aGroupIds[] =$IL1L1lL["id"]; }}parent::TTTlIII(); if($this->filter->issetField("datefrom")) $this->filter->TITI1l1(I12991); if($this->filter->issetField("dateto")) $this->filter->TITI1l1("dateto"); if ($this->cms->Vars['popup'] == "1") {$this->filter->AddField(I12992, "hidden", "1"); }$this->filter->AddField("flt_tag", "text", $this->cms->Vars[I12993], I12987, " like ", "tag"); }function TTTlTI1() {parent::TTTlTI1(); if ($this->id >0) {$this->module->SetTableName('site_search'); }$this->options["check_public"] =false; }function TTTlII1($IIlLlL1 =I12987) {parent::TTTlII1($IIlLlL1); if ($this->id >0) {if($this->filter->issetField(I12994)) {$this->filter->TITI1l1(I12994); }$this->filter->AddField(I12990, "hidden", "0", I12987, "=", I12990); $this->filter->TITI1II(I12990, " OR FIND_IN_SET(" .$this->id .I12995, "force"); }}function &TTTlI1T(&$aCustom) {if (!$this->IL1L1ll) {$this->module->SetProperty('skip_filter', true); }return parent::TTTlI1T($aCustom); }function TTTlI11(&$vData, &$aCustom) {$vData[I12996] =I12987; if (!$this->IL1L1ll) {$vData[I12996] ="1"; }$this->browser->InitSQL( "t.* ", I12997, "WHERE 1 ". $this->_ApplyFilters().$this->TTTlIl1(), I12987, "`count`", "`count` desc" );$aCustom["fields"] += Array (I12998=>Array("action"=>"flagicon", "value"=>I12987, "id"=>I12999, "on"=>$this->moduleName."_list:edit","off"=>I12987), "action_del"=>Array(I13000=>"flagicon", "value"=>I12987, "id"=>"del_id", I13001=>$this->moduleName."_list:del","off"=>I12987), "action_select" => array (I13000 => "flagicon", I13002 => 1, "id" => "sel_id", I13001 => $this->moduleName ."_list:select_icon", "off" => $this->moduleName .I13003 ),);$aCustom["applied_id"] ="id"; $aCustom["list_data"]["form_name"] =$this->cms->Vars[I13004]; $aCustom["form_data"]["buttons"] =Array("add", "apply", I13005, "cancel", "repair"); parent::TTTlI11($vData, $aCustom); }function TTT11Tl(&$IILILII) {$IILILII[] ="leg_red"; $IILILII[] ="leg_yellow"; $IILILII[] =I13006; if ($this->cms->Vars['popup'] != "1") {$IILILII[] ="leg_edit"; $IILILII[] ="leg_del"; }parent::TTT11Tl($IILILII); }function &TTTllTl(&$aCustom) {$res =array ();if ($this->IL1L1ll) {$res =parent::TTTllTl($aCustom); }return $res; }function TTTllTI(&$aCustom){ if($this->id == 0){ $this->SetBodyType(I13007); }elseif($this->id >0){ $this->SetBodyType('body_items'); }else{ $this->SetBodyType('body_empty'); }parent::TTTllTI($aCustom); }function TTTll1T(&$vData, &$aCustom){ if($this->id == 0){ $IIlL1Ll =array(); $IIlL1Ll += $aCustom; $IIlL1Ll["list_data"]["simple_prefix"] =I13008; $IIlL1Ll["list_set"] ="item_list"; $IIlL1Ll["list_set_empty"] ="item_list_empty"; $IIlL1Ll[I13009] ="item_list_not_found"; $IIlL1Ll["row_set"] ="item_row"; $IIlL1Ll["list_table"] =I13010; $IIlL1Ll["page_item_type"] ="body_items"; $this->TTTllll($vData, $IIlL1Ll); if ($this->module->issetOption("tags_presense_number")) {$level =$this->module->getOption("tags_presense_number"); $level =mb_substr($level, 3); }else {$level =5; }if ($this->cms->Core->ReadOption($aOption, I13011, "tags_elements_count")) {$counter =$aOption['value']; if (($counter <= 0) || ($counter == I12987)) {$counter =1; }if ($level >1) {$level =$level -1; }$this->browser->InitSQL("id, tag, sublink, count, tmp_count, sm_data, details_noindex, description, 1 + $level - round($level - $level*((count/$counter))) as level ", "FROM `cms_tags` ", "WHERE 1 AND count > 0 ".$this->_ApplyFilters().I12987, I12987, I12987 );}else {$this->browser->InitSQL("id, tag, sublink, count, tmp_count, sm_data, details_noindex, description ", "FROM `cms_tags` ", "WHERE 1 AND count > 0 ".$this->_ApplyFilters(), I12987, I12987 );}}elseif($this->id >0){ $sql ="SELECT id, tag, sublink, count, tmp_count, sm_data, details_noindex, description FROM `cms_tags` WHERE id = '".$this->id."'"; $this->db->query($sql); $this->db->nextRecord(); $IIl1IL1 =unserialize($this->db->Record[I13012]); $GLOBALS[I13013]["headers"] =$this->cms->TITlTl1($GLOBALS[I13013]["headers"], $IIl1IL1); if($this->db->Record["details_noindex"] == '1') {$this->TTTllT1(); }$navData[I13014] =$this->db->Record[I13014]; $navData["id_sublink"] =$this->db->Record["sublink"]; $this->navData =$this->cms->ApplyNav($navData); $aCustom['pager_navdata'] =$this->navData['nav_data']; $vData[I13015] =$this->db->Record["tag"]; $IIlL1Ll =$this->TTITTT1($aCustom, 'body_items'); $IIlL1Ll["list_data"]["simple_prefix"] =I13016; $IIlL1Ll["row_set"] ="itemS_row"; require_once $GLOBALS['CLASSES_PATH'] .'searchCmd.php'; $this->llI11Il =new searchCmd($this->cms); $IIlL1Ll[I13017]["name"] =Array(I13000=>"callback", "object"=>&$this, "method"=>I13018); $lllIL11 =$this->cms->Core->GetModOption($this->moduleName, "front_page_sort_col"); if ($this->module->issetOption("front_page_sort_col_result")) {$this->cms->Core->SetModOption($this->moduleName, "front_page_sort_col", $this->cms->Core->GetModOption($this->moduleName, "front_page_sort_col_result")); }else {$this->cms->Core->SetModOption($this->moduleName, "front_page_sort_col", "name"); }$lllI1II =$this->cms->Core->GetModOption($this->moduleName, "front_page_sort_dim"); if ($this->module->issetOption("front_page_sort_dim_result")) {$this->cms->Core->SetModOption($this->moduleName, "front_page_sort_dim", $this->cms->Core->GetModOption($this->moduleName, "front_page_sort_dim_result")); }else {$this->cms->Core->SetModOption($this->moduleName, "front_page_sort_dim", "asc"); }$lllI1Il =$this->cms->Core->GetModOption($this->moduleName, "page_size"); if ($this->module->issetOption("page_size_result")) {$this->cms->Core->SetModOption($this->moduleName, I13019, $this->cms->Core->GetModOption($this->moduleName, "page_size_result")); }else {$this->cms->Core->SetModOption($this->moduleName, I13019, "20"); }$this->TTTllll($vData, $IIlL1Ll); $filter =" 1 "; $this->fn->TIl1ITl($filter." ".$this->_ApplyFilters().$this->TTTlIl1(), I12987); }parent::TTTll1T($vData, $IIlL1Ll); if(isset($lllIL11)){ $this->cms->Core->SetModOption($this->moduleName, "front_page_sort_col", $lllIL11); $this->cms->Core->SetModOption($this->moduleName, "front_page_sort_dim", $lllI1II); $this->cms->Core->SetModOption($this->moduleName, I13019, $lllI1Il); }}function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); }function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT * ". "FROM `cms_tags` ". "WHERE id='".$cId.I13020; $this->db->query($sql); if ($this->db->nextRecord()) {$this->itemData =$this->db->Record; }}function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); }function TTTl1ll($cId, $cModule) {parent::TTTl1ll($cId, $cModule); }function _ActionDel($cId, $cModule) {parent::_ActionDel($cId, $cModule); }function TTT1Tl1($cType, $cModule, $condition ='') {$llILl1l =defined('DAEMON_LOGIN_OK'); if (!$llILl1l) {while(ob_get_level()){ $aStatus =ob_get_status(); if('ob_gzhandler' === $aStatus['name']){ break; }ob_end_clean(); }$vData[I13021] =$this->cms->Gui->getMetas(); $html =$this->cms->Gui->get($this->moduleName."_subform:progress_popup_header", $vData); print $html; flush(); }$aModules =array("articles", "blog", "files", I13022, "photoalbum"); $aCounters =array(); for ($i =0; $i <count($aModules); $i++) {$moduleName =$aModules[$i]; if ($this->cms->Core->TTlI111($moduleName)) {$oModule =&$this->cms->Core->GetModule($moduleName); $tableName =$oModule->GetTableName(); $extensions =$oModule->GetOption("extensions"); if (($tableName !== I12987) && (in_array("ext_tags", $extensions))) {$sql ="SELECT tags FROM `".$tableName.I13023; $this->db->query($sql); while ($this->db->nextRecord()) {$tags =$this->db->Record['tags']; $aTags =explode(",", $tags); for ($j =0; $j <count($aTags); $j++) {if (array_key_exists($aTags[$j], $aCounters)) {$aCounters[$aTags[$j]] =$aCounters[$aTags[$j]] +1; }else {$aCounters[$aTags[$j]] =1; }}}sleep(3); }}}$this->TII1Ill(100); $sql ="UPDATE `cms_tags` SET count = 0"; $this->db->query($sql); if (count($aCounters) >0) {foreach ($aCounters as $lllI1IL => $counter) {$sql ="UPDATE `cms_tags` SET count = '".$counter.I13024.$lllI1IL."' LIMIT 1"; $this->db->query($sql); }}parent::TTT1Tl1($cType, $cModule, $condition); if (!$this->llILl1l) {$html =$this->cms->Gui->get($this->moduleName."_subform:progress_popup_footer", $vData); print $html; flush(); }else {print "OK"; ob_flush(); }$GLOBALS["conn"]->TT1I1lT(); exit; die(); }function TII1Ill($II1LI11 =-1){ if($II1LI11 == -1){ $this->lIl11I1 ++; $II1LI11 =0; if($this->lIl11I1 >$this->lIl11IL){ $II1LI11 =100; }else{ $II1LI11 =intval(100*$this->lIl11I1/$this->lIl11IL); }}else{ $this->lIl11I1 =intval($II1LI11*$this->lIl11IL/100); }if(!$this->llILl1l){ $html =$this->cms->Gui->getAbs($this->moduleName."_subform:progress_popup_iterator", Array("percent" => $II1LI11)); print $html; flush(); }else{ print ' '; ob_flush(); }}function TTTlITT($IIIL11l, $cId, $cModule =I12987) {parent::TTTlITT($IIIL11l, $cId, $cModule); }function ProcessAction($IIIL11l, $cId, $cModule =I12987) {parent::ProcessAction($IIIL11l, $cId, $cModule); }function TTT1IlI($aSql =Array(), $cId =0) {$tag =$this->cms->VarsPost["tag"]; if ($tag != I12987) {$aSql =Array( "tag" => $tag, );}if ($this->action != I13025) {$sql ="SELECT id FROM `cms_tags` WHERE lower(tag) = '".mb_strtolower($tag)."' LIMIT 1"; $this->db->query($sql); if ($this->db->nextRecord() != 0) {$aSql =array(); }}$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function TTTlIT1(&$aCustom, $cType ="small", $IIlLI11 =I12987, $IIlLlII ="_small") {$res =array ();if ($this->IL1L1ll) {$res =parent::TTTlIT1($aCustom, $cType, $IIlLI11, $IIlLlII); }return $res; }function TTTll1I(&$vRes, &$aCustom, $cType, $IIlLlII) {if ($this->module->issetOption("body_small_view_type")) {$this->viewType =$this->module->getOption("body_small_view_type"); }if ($this->module->issetOption("tags_presense_number")) {$level =$this->module->getOption("tags_presense_number"); $level =mb_substr($level, 3); }else {$level =5; }if ($this->cms->Core->ReadOption($aOption, I13011, "tags_elements_count")) {$counter =$aOption[I13026]; if (($counter <= 0) || ($counter == I12987)) {$counter =1; }if ($level >1) {$level =$level -1; }$this->browser->InitSQL("id, tag, sublink, count, tmp_count, 1 + $level - round($level - $level*((count/$counter))) as level " .$aCustom["sql_addon"]["select"] ,"FROM `cms_tags` ", "WHERE 1 AND count > 0 " .$this->_ApplyFilters() ,I12987, I13027); }else {$this->browser->InitSQL("id, tag, sublink, count, tmp_count " .$aCustom["sql_addon"]["select"] ,"FROM `cms_tags` ", "WHERE 1 AND count > 0 " .$this->_ApplyFilters() ,I12987, I13027); }$aCustom[I13017]["detials"] =Array(I13000=>"callback", "object"=>&$this, "method"=>I13028); $aCustom["list_set"] ="small_list_".$this->viewType; parent::TTTll1I($vRes, $aCustom, $cType, $IIlLlII); }function _GetSmallDetailsCB(&$aItem, &$aData) {$aItem['tag_front_link'] =$this->cms->Core->GetModFrontLink(I13011); $aItem["small_tag"] =$this->cms->TTITI1l(I13029, "tag_".$this->viewType, $aItem); $aItem["small_count"] =$this->cms->TTITI1l(I13029, "count_".$this->viewType, $aItem); }function _FormatSearchRowCB(&$vItem, &$vData){ $this->fn->TIl1IT1($vItem, $vData, $this->llI11Il); }function TTT11IT($IILILIL) {$navData =parent::TTT11IT($IILILIL); return $navData; }}?>