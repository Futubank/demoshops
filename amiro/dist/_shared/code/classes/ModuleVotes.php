<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @package    core 
 * @version    $Id$ 
 * @size       52972 xkqwxkwxxytnyskgxxzmwmxykuywqqymmnzlizktlkkgykttmxsmwlgxrzsgngmpyqllpnir
 */ ?><?php foreach(array(13246=>'',13247=>"PQn|DuYJMnK",13248=>'uDQ|HGtMHnD|fHrI',13249=>'ZWtMHn',13250=>'rQDQt',13251=>'fJt|EuQDtMHn',13252=>'frHnt',13253=>'GOG',13254=>"FRhi?.WID|vHtQD.?v",13255=>'=_DtZtuD',13256=>'MS',13257=>'fJZPMWHn',13258=>'Hff',13259=>'vHtQD|JMDt%rQDuJt',13260=>'vHtQD|JMDt%SQJ',13261=>'JQP|BQJJHC',13262=>'JQP|SQJ',13263=>'WZnWQJ',13264=>'HYLQWt',13265=>'GMWturQTQIGJZtQ',13266=>'wjzddqd|gzTo',13267=>'fHrI|OQZSQr',13268=>'MtQI|DQt|QIGtB',13269=>'vHtQSzJrQZSB',13270=>'vHtQ|ZSSQS',13271=>'rQDuJtDUnZvZMJZYJQ',13272=>'JMDt|SZtZ',13273=>'MtQIs|rQDuJt|',13274=>'MtQI|DQt',13275=>'DMIGJQ|GrQfMx',13276=>'vHtQD',13277=>'fMQJSD',13278=>'YHSB|YrHCDQ',13279=>'v',13280=>"vv_v",13281=>'vv',13282=>'|pQtmtQIjMDtRHCwy',13283=>'DIZJJ|',13284=>'|pQtmtQIRQDuJtDwy',13285=>'IQtOHS',13286=>'uTMIQqxGMrZtMHn',13287=>"FRhi?WID|vHtQD?",13288=>'GuYJMW',13289=>'EuQDtMHn',13290=>'SZtQ|QnS',13291=>'tHtZJ',13292=>'EuQDtMHn|JQnPtO',13293=>"'",13294=>'GMWturQ',13295=>'vHMWQD',13296=>'ZnDCQr',13297=>'CMStO2',13298=>"vHMWQD",13299=>'ZnDCQrD',13300=>'GMWturQD|LD|DWrMGt',13301=>'MD|HtOQr',13302=>'Qxt|MIZPQD',13303=>'?zNs?MD|HtOQr=0',13304=>'ZnDCQr|',13305=>'ZnDCQr|vZJ|',13306=>'IQDDZPQ',13307=>"?zNs?v`MS?NhT?mN?}",13308=>"[",13309=>"FRhi?WID|vHtQD?v?",13310=>"[!?",13311=>"[?",13312=>'WJHDQS',13313=>'DtZtuD',13314=>'nZv|SZtZ',13315=>'|JMDt',13316=>'ZJJHCHtOQr',13317=>"'?zNs?MD|HtOQr=0?",13318=>"GMWturQ",13319=>'nuI',13320=>'WOQWK|fHrI|',13321=>'|DIZJJ',13322=>'tH|JMDt',13323=>'DOHC|nuIQrMW',13324=>'EtBGQ',13325=>"MD|HtOQr",13326=>"CMStO1",13327=>":01`2f",13328=>'vHMWQDNuIQrMW',13329=>'OMSSQn',13330=>'|nH|GQrWQntZPQ',13331=>"vHtQS",13332=>'vHtQJMnQ',13333=>'vHtQHtOQr',13334=>'WID|vHtQvZJD',13335=>"coqRq?.MS|vHtQ.?=?",13336=>'=_vHMWQD-1',13337=>'rQS',13338=>'GrQfMx') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class ModuleVotes extends CMS_ActModule {public $_specialAction =''; public $llllL1I =0; private $llllL1l; function ModuleVotes(&$cms, &$db, &$cModule) {parent::CMS_ActModule($cms, $db, $cModule); }function _Init($IIll1l1 =Array(), $IIll1LI ='', $IIll1Ll =I13246, $aOptions =Array()) {$IIIIL11["group_operations"] =Array( "publish_on", "publish_off", "del", I13247, "gen_keywords", "index_details", "no_index_details", "move_position" );$IIIIL11[I13248] =true; $IIIIL11['name_field_name'] ='question'; $IIIIL11['description_field_name'] ='question'; $IIIIL11['announce_field_name'] ='question'; $IIIIL11['picture_cat'] ='votes'; $IIIIL11["use_positions"] =true; $aOptions += $IIIIL11; parent::_Init($IIll1l1, $IIll1LI, $IIll1Ll, $aOptions); }function TTTlTI1() {if (!isset($this->cms->VarsGet[I13249]) || $this->cms->VarsGet[I13249] != 'vote') {$this->_specialAction ='results'; }parent::TTTlTI1(); $this->llllL1l =null; }function TTTlITT($IIIL11l, $cId, $cModule =I13246) {if ($cId >0) {if ($IIIL11l == 'results' || $IIIL11l == 'result') {$this->TIl1llT($cId, $cModule); }else if ($IIIL11l == I13250) {$this->_ActionReset($cId, $cModule); }}parent::TTTlITT($IIIL11l, $cId, $cModule); }function TTlTll1() {parent::TTlTll1(); }function TTTlIII() {parent::TTTlIII(); $this->filter->UpdateFieldDBName("datefrom", "date_start"); $this->filter->UpdateFieldDBName("dateto", "date_start"); $this->filter->AddField(I13251, 'text', isset($this->cms->Vars[I13251]) ?stripslashes(unhtmlentities($this->cms->Vars[I13251])) :I13246, I13246, ' like ', 'question'); $this->filter->MoveField("flt_question", _MOVE_START); }function _ApplyFilters($prefix =I13246, $bodyType =I13246, $IIlLLl1 =true) {$res =parent::_ApplyFilters($prefix, $bodyType, $IIlLLl1); if ($this->side == I13252) {if (!is_object($this->cms->Member) || !$this->cms->Member->isLoggedIn()) {$res .= ' AND registered_users_only = 0'; }if ($this->isSmallMode) {$res .= ' AND special = 1'; }}return $res; }function TTTlI1I(&$vData) {parent::TTTlI1I($vData); if ($this->action != 'edit') {$time =time(); $vData['fdate_start'] =date($this->cms->DFMT[I13253], $time); $vData['fdate_end'] =date($this->cms->DFMT[I13253], strtotime("+1 year", $time)); $vData['special'] ='checked'; $vData['registered_users_only'] =$this->module->GetOption('registered_users_only') ?'checked' :I13246; }$vData['form_width'] ='100%'; }function TTTlI11(&$vData, &$aCustom) {$this->browser->InitSQL( "v.*, DATE_FORMAT(v.date_start,'".$this->cms->DFMT['db']."') fdate_start, DATE_FORMAT(v.date_end,'".$this->cms->DFMT['db']."') fdate_end, NOW() BETWEEN date_start AND date_end status ", I13254, "WHERE 1 ".$this->_ApplyFilters().$this->TTTlIl1(), I13246, 'date_start', "v.id DESC", array ('status' => I13255) );$aCustom['fields'] += Array( 'public' => Array( I13249 => 'flagicon', 'value' => 1, I13256 => 'pub_id', 'on' => 'votes_list:public_on', 'off' => 'votes_list:public_off' ),'question' => Array(I13249=>'stripline', 'size'=>250), 'action_edit' =>Array( I13249 => I13257, 'value' => I13246, I13256 => 'edit_id', 'on' => 'votes_list:edit', I13258 => I13246 ),'action_result' => Array( I13249 => I13257, 'value' => I13246, I13256 => 'edit_id', 'on' => I13259, I13258 => I13246 ),'action_reset_num' => Array( I13249 => I13257, 'value' => I13246, I13256 => 'edit_id', 'on' => 'votes_list:reset_num', I13258 => I13246 ),'action_del' => Array( I13249 => I13257, 'value' => I13246, I13256 => 'del_id', 'on' => I13260, I13258 => I13246 ),);$aCustom['legend'] =Array('published', 'notpublished', 'leg_red', I13261, 'leg_blue', 'leg_edit', 'leg_result', 'leg_reset_num', I13262); $aCustom['form_data']['buttons'] =Array('add', 'apply', I13263, 'save'); $aCustom['fields']['total'] =Array(I13249 => 'callback', I13264 => &$this, 'method' => '_AdminGetItemListRow'); $IIlLIIL =array(I13249 => '_preparePicsData', 'data'=> $_data =array(&$vData, I13265)); $this->TTT1lI1($IIlLIIL, array('ext_images')); if(isset($vData['item_pictureTemplate'])){ $vData['item_pictureTemplate'] =jparse($vData['item_pictureTemplate']); }if (count($this->itemData) == 0) {$IILIIL1 =$this->db; require_once $GLOBALS[I13266] .'CMS_IteratorArray.php'; $this->db =new CMS_IteratorArray($this->module); $this->db->SetArray(Array ());$this->TIl1llI($vData); $this->db =$IILIIL1; }$aCustom['applied_id'] ='v.id'; parent::TTTlI11($vData, $aCustom); if ($this->_specialAction == 'results') {$vData[I13267] =$this->cms->Words['votes_result']; }}function TTTllTI(&$aCustom) {if ($this->id >0) {$this->SetBodyType('body_itemD'); }elseif ($this->id != -1) {$this->SetBodyType('body_items'); }parent::TTTllTI($aCustom); }function TTTll1T(&$vData, &$aCustom) {$llllL1L =$this->module->GetOption('view_results_before_voting'); $llllL11 =$this->module->GetOption('show_after_voices_count'); $aDefault =Array(); foreach($this->IIllIL1 as $IIlL1L1 => $tmp) {$IIlL1Ll =$this->TTITTT1($aCustom, $IIlL1L1); switch($IIlL1L1) {case 'body_itemD': $IIlL1Ll['list_data']['simple_prefix'] ='itemD_'; $llll1II =I13246; $sql ="SELECT v.*, NOW() BETWEEN date_start AND date_end status ". "FROM cms_votes v ". "WHERE v.id='".$this->id."' ". "AND NOW() >= date_start".$this->_ApplyFilters().$this->TTTlIl1(); $this->db->query($sql); if (!$this->db->next_record()) {$IIlL1Ll[I13268] ='item_details_empty'; break; }$llll1Il =$llllL11 ?$this->db->Record['total'] >= $llllL11 :true; $llll1IL ='pollForm'; if ($this->action == 'add') {if ($this->_alreadyVoted($this->id)) {$llll1IL =I13269; }else if ($llll1Il) {$langFile =$this->cms->Gui->ParseLangFile("templates/lang/_votes_msgs.lng"); $this->cms->InitMessages($langFile); $this->cms->AddStatusMsg('vote_added'); $llll1IL ='results'; }else {$langFile =$this->cms->Gui->ParseLangFile("templates/lang/_votes_msgs.lng"); $this->cms->InitMessages($langFile); $this->cms->AddStatusMsg(I13270); $llll1IL ='thanks'; }}else if ($this->_specialAction == 'results') {if ($llll1Il && ($llllL1L || $this->_alreadyVoted($this->id) || !$this->db->Record['status'] )){$llll1IL ='results'; }else {$llll1IL =I13271; }}else if ($this->_alreadyVoted($this->id)) {$llll1IL =I13269; }else if (!$this->db->Record['status']) {$llll1IL ='FinishedPoll'; }switch ($llll1IL) {case 'pollForm': $llll1II ='_GetItemDetailsCB'; $IIlL1Ll[I13272]['simple_prefix'] ='itemD_'; break; case I13269: $this->action ='none'; $IIlL1Ll[I13272]['simple_prefix'] =I13273; $IIlL1Ll['item_set'] ='item_details_already_voted'; break; case 'results': $IIlL1Ll['item_set'] ='item_details_results'; $IIlL1Ll[I13272]['simple_prefix'] =I13273; $llll1II ='_GetItemResultsCB'; break; case 'thanks': $IIlL1Ll[I13272]['simple_prefix'] =I13273; $IIlL1Ll[I13274] ='item_details_thanks'; break; case I13271: $IIlL1Ll[I13272]['simple_prefix'] =I13273; $IIlL1Ll[I13274] ='item_details_results_unavailable'; break; case 'FinishedPoll': $IIlL1Ll[I13272][I13275] =I13273; $IIlL1Ll[I13274] =I13246; $langFile =$this->cms->Gui->ParseLangFile("templates/lang/_votes_msgs.lng"); $this->cms->InitMessages($langFile); $this->cms->AddStatusMsg('finished_poll', 'red'); break; }$vData['vote_link'] =$this->cms->Core->GetModFrontLink(I13276); $vData['to_list'] =$this->cms->Gui->get($this->moduleName.'_list:to_list', $vData); $this->TIl1l1T( $vData, $this->moduleName.'_list', $IIlL1Ll[I13272][I13275], array ('to_list') );$this->db->seek(0); if ($llll1II) {$IIlL1Ll[I13277]['question'] =Array(I13249=>'callback', I13264=>&$this, 'method'=>$llll1II); }break; case 'body_items': case I13278: if ($IIlL1L1 == 'body_items') {$IIlL1Ll[I13272][I13275] ='item_'; }$this->TTTllll($vData, $IIlL1Ll); $this->browser->InitSQL( "v.id, question, sublink, NOW() BETWEEN date_start AND date_end status, SUM(vv.voices) total", Array('tables'=>Array(I13279=>'cms_votes', 'vv'=>'cms_votevals'), 'joins'=>Array(I13280=>"vv.id_vote=v.id"), 'joins_types'=>Array('vv|v'=>'LEFT') ),"WHERE NOW() >= date_start ".$this->_ApplyFilters().$this->TTTlIl1(), 'v.id', I13246, I13246, Array( 'total' =>'=|total', 'status'=>I13255 ));$this->browser->AddSQLJoinedTables($this->cms->Core, I13279, array (I13281 => 'cms_votevals')); $IIlL1Ll[I13277]['question'] =Array(I13249=>'callback', I13264=> $this, 'method'=>I13282); break; }parent::TTTll1T($vData, $IIlL1Ll); }}function TTTlIT1(&$aCustom, $cType ="small", $IIlLI11 ="", $IIlLlII ="_small") {$this->isSmallMode =true; $llll1II ='_GetSmallDetailsCB'; $aCustom[I13275] =I13283; $llll1I1 =false; $pollId =$this->TIl1ll1($llll1I1, true); $this->cms->Core->Cache->TT1TI1l("pollId", $pollId); if ($llll1I1) {$aCustom['row_set'] ='small_row_results'; $aCustom[I13275] ='small_result_'; $llll1II =I13284; }$this->browser->SetForceRules(' ', ' '); $aCustom[I13277]['detials'] =Array(I13249=>'callback', I13264=>&$this, I13285=>$llll1II); $specName =$this->module->GetProperty("active_spec_blocks"); $parameters =array ('isResult' => $llll1I1, 'notChanged' => $pollId == $this->_previousPollId );if ($parameters['isResult']) {$parameters[I13286] =strtotime($this->module->GetOption('small_cache_expire')); }$this->cms->Core->Cache->TT1TI1T($specName."_expiration", $parameters); parent::TTTlIT1($aCustom, $cType, $IIlLI11, $IIlLlII); }function TTTll11($cId, $cModule) {parent::TTTll11($cId, $cModule); if (empty($this->cms->VarsPost['question']) || !isset($this->cms->VarsPost['answersOrder'])) {return; }$this->TIl1lll($this->db->lastInsertId()); if ($this->id) {$this->appliedId =$this->id; }}function TTTl1Tl($cId, $cModule) {parent::TTTl1Tl($cId, $cModule); $sql ="SELECT *, DATE_FORMAT(date_start,'".$this->cms->DFMT['db']."') fdate_start, DATE_FORMAT(date_end,'".$this->cms->DFMT['db']."') fdate_end ". I13287. "WHERE id='".$cId."'".$this->_ApplyFilters(); $this->db->query($sql); $this->itemData['answers'] =I13246; if ($this->db->next_record()) {$this->itemData =$this->db->Record; $checkboxes =Array ('public' => I13288, 'allowother' => 'allow_other', 'special' => 'special', 'registered_users_only' => 'registered_users_only', );foreach ($checkboxes as $from => $to) {if ($this->itemData[$from]) {$this->itemData[$to] ='checked'; }}$this->itemData['question'] =$this->cms->htmlchars($this->itemData['question']); $sql ="SELECT COUNT(1) cnt FROM cms_votevals ". "WHERE id_vote='".$cId."' and is_other=1"; $this->db->query($sql); $this->db->next_record(); $this->cms->Gui->addGlobalVars(Array('OTHER_ANSWERS_COUNT'=>$this->db->Record['cnt']>0)); $sql ="SELECT * FROM cms_votevals ". "WHERE id_vote='".$cId."' AND is_other=0 ORDER BY id ASC"; $this->db->query($sql); $this->itemData['pictures_js_vars'] =I13246; $this->itemData['pictures_js_script'] =I13246; $this->TIl1llI($this->itemData); }}function _ActionDel($cId, $cModule) {$this->db->query("DELETE FROM cms_votevals WHERE id_vote='".$cId."'"); parent::_ActionDel($cId, $cModule); }function TTTl1lI($cId, $cModule) {parent::TTTl1lI($cId, $cModule); if (!empty($this->cms->VarsPost['question']) && isset($this->cms->VarsPost['answersOrder'])) {$this->TIl1lll($cId, isset($this->cms->VarsPost['reset_other'])); }}function TTT1IlI($aSql =Array(), $cId =0) {$question =trim($this->cms->VarsPost[I13289]); if ($question != I13246) {$aSql =array ();$checkboxes =Array (I13288 => I13288, 'allow_other' => 'allowother', 'special' => 'special', 'registered_users_only' => 'registered_users_only' );foreach ($checkboxes as $from => $to) {$aSql[$to] =isset($this->cms->VarsPost[$from]) ?1 :0; }$aSql += Array( I13289 => $question, 'date_start' => DateTools::toMysqlDate(DateTools::getCorrectUDate($this->cms->VarsPost['date_start'], $this->cms->DFMT['conf'])), I13290 => DateTools::toMysqlDate(DateTools::getCorrectUDate($this->cms->VarsPost[I13290], $this->cms->DFMT['conf'])), 'qtype' => $this->cms->VarsPost['qtype'], 'lang' => $this->langData, I13291 => intval($this->cms->VarsPost[I13291]) );}$aSql =parent::TTT1IlI($aSql, $cId); return $aSql; }function _GetSmallDetailsCB(&$aItem, &$aData) {$aData[I13275] =I13283; $this->_GetItemDetailsCB($aItem, $aData); $aItem['to_list'] =$this->cms->Gui->get($this->moduleName.'_list:to_list_small', $aItem); $aItem['front_link'] =$aData['front_link']; $aItem[I13289] =$this->cms->stripLine($aItem[I13289], $this->module->GetOption(I13292)); $this->TIl1l1T( $aItem, $this->moduleName.'_list', $aData[I13275], array (I13289) );}function TIl1llT($cId, $cModule) {$this->_specialAction ='results'; $this->redirect =false; $form['answers'] =I13246; $sql ="SELECT * FROM cms_votes WHERE id='".$cId.I13293; $this->db->query($sql); $llll1lI =in_array('show_numeric_percentage', $this->module->GetOption('show_numeric')); $llll1ll =in_array('show_numeric_total', $this->module->GetOption('show_numeric')); if ($this->db->next_record()) {$this->itemData[I13256] =$cId; $this->itemData[I13289] =$this->db->Record[I13289]; $this->itemData['show_numeric_percentage'] =$llll1lI; $this->itemData['show_numeric_total'] =$llll1ll; $this->itemData[I13291] =$this->db->Record[I13291]; $order =$this->module->GetOption('result_answers_sort_col') .' ' .$this->module->GetOption('result_answers_sort_dim'); $sql ="SELECT message, picture, voices FROM cms_votevals WHERE id_vote='".$this->cms->Vars[I13256]."' ORDER BY " .$order; $this->db->query($sql); if ($this->db->num_rows()) {$IIIILl1 =0; $llll1lL =0; $llll1l1 =0; $llll1LI =Array(); while ($this->db->next_record()) {$IIIILl1++; $llll1LI[$IIIILl1]['answer'] =$this->db->Record['message']; $llll1LI[$IIIILl1]['picture'] =$this->db->Record[I13294]; $llll1LI[$IIIILl1]['voices'] =intval($this->db->Record['voices']); $llll1l1 +=$llll1LI[$IIIILl1]['voices']; if ($llll1LI[$IIIILl1]['voices']>$llll1lL) {$llll1lL =$llll1LI[$IIIILl1][I13295]; }}($llll1l1==0)?$llll1Ll=1:$llll1Ll=$llll1l1; for($i =1; $i<=$IIIILl1; $i++) {$v =intval($llll1LI[$i][I13295]/$llll1Ll*$this->module->GetOption('bar_width')); $this->itemData['answers'] .= $this->cms->Gui->getAbs('votes_subform:answer_line', Array('answer'=>$llll1LI[$i][I13296], I13294=>mb_strlen($llll1LI[$i][I13294]) ?$GLOBALS['ROOT_PATH_WWW'] .$llll1LI[$i][I13294] :I13246, 'width1'=>$v+1, "voicesNumeric" => $llll1LI[$i]["voices"], I13297=>($this->module->GetOption('bar_width') -$v), 'hidden'=>$llll1LI[$i][I13295] <$llll1l1 ?I13246 :'display:none;visibility:hidden', "voicesNumeric" => $llll1LI[$i][I13298], I13295=>sprintf("%01.2f",$llll1LI[$i][I13295]/$llll1Ll*100) ));}}else {$this->itemData['answers'] =$this->cms->Gui->getAbs('votes_list:no_answers', I13246); $this->itemData[I13291] =0; }$this->IIllIlI =$cId; }else {$this->itemData[I13289] =$this->cms->Gui->getAbs('votes_list:no_vote', I13246); $this->itemData[I13291] =0; }}function _ActionReset($cId, $cModule) {$this->redirect =false; $this->db->query("DELETE FROM cms_votevals WHERE id_vote='".$cId."' AND is_other=1"); $this->db->query("UPDATE cms_votevals SET voices=0 WHERE id_vote='".$cId.I13293); $this->cms->AddStatusMsg('status_reset'); }function TIl1llI(&$llll1LL) {$max =max($this->db->num_rows(), $this->module->GetOption('default_answers_count')); $llll1LL[I13299] =I13246; for($i =1; $i <= $max; $i++) {$row =Array( 'num' => $i, 'pictures_js_vars' => $llll1LL['pictures_js_vars'], 'pictures_js_script' => $llll1LL[I13300] );if ($this->db->next_record()) {$row[I13296] =$this->db->Record['message']; $row['picture_'.$i] =$this->db->Record[I13294]; $row['answer_value'] =$this->db->Record[I13295]; $row['is_other'] =$this->db->Record[I13301]; }$IIlLIIL =Array("action"=>"_preparePicsData", "data"=> $_data =array(&$row, 'picture_'.$i)); $this->TTT1lI1($IIlLIIL, array(I13302)); $llll1LL['pictures_js_vars'] =$row['pictures_js_vars']; $llll1LL[I13300] =$row[I13300]; $llll1LL[I13299] .= $this->cms->Gui->get('votes_subform:answer_line', $row); }}function TIl1lll($pollId, $llll1L1 =false) {if ($pollId) {$this->db->query("DELETE FROM cms_votevals WHERE id_vote='".$pollId.I13293.($llll1L1 ?I13246 :I13303)); }$answers =Array(); $order =explode(';', $this->cms->VarsPost['answersOrder']); $max =max($this->module->GetOption('default_answers_count'), count($order)); for($i =1; $i <= $max; $i++) {if (isset($this->cms->VarsPost['answer_'.$i]) && (!empty($this->cms->VarsPost[I13304.$i]) || !empty($this->cms->VarsPost['picture_'.$i])) ){$index =array_search($i, $order); $answers[$index]['message'] =$this->cms->VarsPost[I13304.$i]; $answers[$index][I13294] =$this->cms->VarsPost['picture_'.$i]; $answers[$index]['val'] =0; if (isset($this->cms->VarsPost[I13305.$i]) && !empty($this->cms->VarsPost[I13305.$i])) {$answers[$index]['val'] =intval($this->cms->VarsPost[I13305.$i]); }}}ksort($answers); foreach ($answers as $answer) {if (isset($answer['message']) && (!empty($answer['message']) || !empty($answer[I13294]))) {$asql =Array( 'id_vote' => $pollId, I13301 => 0, I13306 => $answer[I13306], I13294 => $answer[I13294], I13295 => $answer['val'] );$sql =$this->db->GenInsertSQL('cms_votevals', $asql); $this->db->query($sql); }}}function TIl1ll1(&$llll1I1, $llll11I =false) {$llll1I1 =false; $cookie =$this->module->GetProperty('prefix').'PollId'; $llll11l =isset($this->cms->VarsCookie) && isset($this->cms->VarsCookie[$cookie]) ?(int)$this->cms->VarsCookie[$cookie] :0; if ($llll11l <0) {$llll11l =0; }$this->_previousPollId =$llll11l; $llll11L =$this->TIl1l1l(); $llll111 =count($llll11L) ?I13307.implode(',', $llll11L).") " :I13246; $llllL1L =$this->module->GetOption('view_results_before_voting'); $llllL11 =$this->module->GetOption('show_after_voices_count'); $order =$this->module->GetOption('page_sort_col_small'); if ($order == 'rand') {$order =' ORDER BY RAND() '; }else {$order =' ORDER BY '.$order.' '.$this->module->GetOption('page_sort_dim_small'); }$lllLIII =", " .intval($llllL1L) ." view_results_before_voting "; if ($llll11l) {$sql ="SELECT * FROM cms_votes v WHERE id = ".$llll11l." AND NOW() BETWEEN date_start AND date_end ". $llll111.$this->_ApplyFilters().$this->TTTlIl1(); $this->db->query($sql); if ($this->db->num_rows() >0) {if ($llll11I) {$this->browser->InitSQL(I13308 .$lllLIII, I13287, "WHERE id = ".$llll11l );}}else {$llll11l =0; }}if ($llll11l == 0) {$sql ="SELECT v.*, SUM(vv.voices) total ". "FROM cms_votes v ". "LEFT JOIN cms_votevals vv ON vv.id_vote=v.id ". "WHERE NOW() BETWEEN date_start AND date_end". $llll111.$this->_ApplyFilters().$this->TTTlIl1(). " GROUP BY v.id".$order." LIMIT 1"; $this->db->query($sql); if ($this->db->next_record()) {$llll11l =$this->db->Record[I13256]; if ($llll11I) {$this->browser->InitSQL(I13308 .$lllLIII, I13287, "WHERE id = ".$llll11l );}}}if ($llll11l == 0) {$sql ="SELECT v.*, SUM(vv.voices) total, NOW() BETWEEN date_start AND date_end status ". I13309. "LEFT JOIN cms_votevals vv ON vv.id_vote=v.id ". "WHERE NOW() >= date_start". $this->_ApplyFilters().$this->TTTlIl1(). " GROUP BY v.id".$order; $rs =$this->db->select($sql); $qty =$rs->numRows(); while ($r =$rs->nextRecord()) {$lllLIIl =$this->_alreadyVoted($r[I13256]); if (($llllL11 ?($r[I13291] >= $llllL11) :true) && $r[I13291] && ($r['status'] ?((($qty == 1) && ($this->llllL1I == $r[I13256])) || $lllLIIl || $llllL1L) :true) ){$llll11l =$r[I13256]; $llll1I1 =true; if ($llll11I) {$this->browser->InitSQL(I13310.$r[I13291]." total, ".$r['status']." status" .$lllLIII, I13287, "WHERE id = ".$llll11l );}$llll11l =-$llll11l; break; }}}if ($llll11l == 0) {if ($llll11I) {$this->browser->InitSQL(I13311, I13287, "WHERE id = -1" );}}$this->cms->VarsCookie[$cookie] =$llll11l; SetLocalCookie($cookie, $llll11l, time()+60*60*24*365, I13246, true); return $llll11l; }function _AdminGetItemListRow(&$aItem, &$aData) {$aItem[I13291] =intval($aItem[I13291]); $aItem['status'] =$aItem['status'] ?'available' :I13312; }function _GetItemListRowCB(&$aItem, &$aData) {$llllL1L =$this->module->GetOption('view_results_before_voting'); $llllL11 =$this->module->GetOption('show_after_voices_count'); $aItem[I13289] =$this->cms->stripLine($aItem[I13289], $this->module->GetOption(I13292)); $lllLIIL =$aItem['status'] && !$this->_alreadyVoted($aItem[I13256]); $lllLII1 =($llllL11 ?$aItem[I13291] >= $llllL11 :true) && ($lllLIIL ?$this->_alreadyVoted($aItem[I13256]) || $llllL1L :true); $aItem['status'] =$aItem[I13313] ?$this->cms->Gui->getAbs('votes_list:status_available', I13246) :$this->cms->Gui->getAbs('votes_list:status_closed', I13246); if (!isset($aItem['nav_data'])) {$aItem['nav_data'] =$aData[I13314]; }if (!isset($aItem[I13314])) {$aItem[I13314] =$aData[I13314]; }$aItem['action_vote'] =$lllLIIL ?$this->cms->Gui->get('votes_list:action_vote', $aItem) :I13246; $aItem['action_view_results'] =$lllLII1 ?$this->cms->Gui->get('votes_list:list_action_view_results', $aItem) :I13246; $this->TIl1l1T( $aItem, $this->moduleName.I13315, $aData[I13275], array (I13289, I13313, 'action_vote', 'action_view_results') );}function _GetItemDetailsCB(&$aItem, &$aData) {$lllLIlI =$this->moduleName .'_list:' .($this->isSmallMode ?I13283: I13246); $aItem['view_results_before_voting'] =intval($this->module->GetOption('view_results_before_voting')); $pollId =$aItem[I13256]; $qtype =$aItem['qtype']; $aItem['offset'] =$this->cms->Vars['offset']; $answers =$this->cms->Gui->getAbs($lllLIlI.'answer_header_'.($aItem[I13316] ?'other_' :I13246).$qtype, I13246); $sql ="SELECT id, message, picture " ."FROM cms_votevals " ."WHERE id_vote='" .$pollId .I13317 ."ORDER BY id ASC"; $this->db->query($sql); $IIL1lI1 =$aData[I13275] .($aItem['qtype'] == 'single_select' ?'single_select_' :I13246); $i =0; while ($this->db->next_record()) {$i++; $picture =$this->db->Record[I13318]; $llll1LI =Array( 'num' => $i, I13256 => $this->db->Record[I13256], I13296 => $this->db->Record[I13306], I13294 => $picture ?$this->cms->Gui->getAbs($lllLIlI.I13294, array (I13294 => $picture)) :I13246 );$this->TIl1l1T( $llll1LI, $this->moduleName.I13315, $IIL1lI1, array (I13296) );$answers .= $this->cms->Gui->get($lllLIlI.'answer_row_'.$qtype, $llll1LI); }$answers .= $this->cms->Gui->getAbs($lllLIlI.'answer_footer_'.$qtype, I13246); if ($aItem[I13316]) {if ($i == 0) {$answers =$this->cms->Gui->getAbs($lllLIlI.'answer_row_other_no_answers_'.$qtype, Array(I13319=>($i))); }else {$answers .= $this->cms->Gui->getAbs($lllLIlI.'answer_row_other_'.$qtype, Array(I13319=>($i))); }}$aItem[I13299] =$answers; if ($i == 0) {$aItem['check_script'] =$this->cms->Gui->getAbs($lllLIlI.'check_form_no_answers_'.$qtype, I13246); }else {$aItem['check_script'] =$this->cms->Gui->getAbs($lllLIlI.I13320.$qtype, I13246); }$aItem['vote_link'] =$this->cms->Core->GetModFrontLink(I13276); if (!isset($aItem[I13314])) {$aItem[I13314] =$aData[I13314]; }$aItem['action_view_results'] =$this->cms->Gui->get($this->moduleName .'_list:' .'action_view_results' .($this->isSmallMode ?I13321: I13246), $aItem); $this->TIl1l1T( $aItem, $this->moduleName.I13315, $aData[I13275], array ('action_view_results') );}function _GetItemResultsCB(&$aItem, &$aData) {$setPrefix =$this->isSmallMode ?I13283: I13246; $lllLIlI =$this->moduleName .'_list:' .$setPrefix; $aItem['vote_link'] =$this->cms->Core->GetModFrontLink(I13276); if ($this->isSmallMode) {$aItem[I13289] =$this->cms->stripLine($aItem[I13289], $this->module->GetOption(I13292)); $aData[I13275] ='small_result_'; $aItem[I13322] =$this->cms->Gui->get($this->moduleName.'_list:to_list', $aItem); $this->TIl1l1T( $aItem, $this->moduleName.I13315, $aData[I13275], array (I13322) );}$llll1ll =in_array('show_numeric_total', $this->module->GetOption('show_numeric')); $llll1lI =in_array('show_numeric_percentage', $this->module->GetOption(I13323)); $lllLIll =$this->module->GetOption($this->isSmallMode ?'small_bar_width' :'bar_width'); $lllLIlL =$this->cms->Gui->getAbs($lllLIlI.'other', I13246); $lllLIl1 =$aItem["allowother"]; $pollId =$aItem[I13256]; $qtype =$aItem[I13324]; $aItem['offset'] =$this->cms->Vars['offset']; $answers =$this->cms->Gui->getAbs($lllLIlI.'answer_header_'.($aItem[I13316] ?'other_' :I13246).$qtype, I13246); $order =$this->module->GetOption('result_answers_sort_col') .' ' .$this->module->GetOption('result_answers_sort_dim'); $sql ="SELECT id, message, picture, voices, is_other FROM cms_votevals WHERE id_vote='".$pollId."' ORDER BY " .$order; $this->db->query($sql); $answers =I13246; if ($this->db->num_rows()) {$IIIILl1 =0; $llll1lL =0; $llll1l1 =0; $lllLILI =0; $lllLILl =false; $llll1LI =Array(); while($this->db->next_record()){ $lllLILL =$this->db->Record[I13325]; $lllLIL1 =intval($this->db->Record[I13298]); if ($lllLIl1 && $lllLILL){ $lllLILl =true; $lllLILI += $lllLIL1; }elseif (!$lllLILL) {$picture =$this->db->Record[I13318]; $IIIILl1++; $llll1LI[$IIIILl1][I13298] =$lllLIL1; $llll1LI[$IIIILl1]["answer"] =$this->db->Record["message"]; $llll1LI[$IIIILl1][I13318] =$picture ?$this->cms->Gui->getAbs($lllLIlI.I13294, array (I13294 => $picture)) :I13246; }$llll1l1 += $lllLIL1; if($lllLIL1>$llll1lL) $llll1lL =$lllLIL1; }($llll1l1==0)?$llll1Ll=1:$llll1Ll=$llll1l1; for($i =1; $i<=$IIIILl1; $i++){ $v =intval($llll1LI[$i][I13298]/$llll1Ll*$lllLIll); $lllLI1I =Array("answer"=>$llll1LI[$i]["answer"], I13318=>$llll1LI[$i][I13318], I13326=>$v+1, "width2"=>($lllLIll -$v), 'hidden'=>$llll1LI[$i][I13295] <$llll1l1 ?I13246 :';display:none;visibility:hidden', "voicesNumeric" => $llll1LI[$i][I13298], I13298=>sprintf(I13327,$llll1LI[$i][I13298]/$llll1Ll*100), 'show_numeric_percentage' => $llll1lI, 'show_numeric_total' => $llll1ll );$lllLI1I[I13295] =$this->cms->Gui->get($lllLIlI.I13295, $lllLI1I); $lllLI1I['voicesNumeric'] =$this->cms->Gui->get($lllLIlI.'voicesNumeric', $lllLI1I); $this->TIl1l1T( $lllLI1I, $this->moduleName.I13315, $aData[I13275], array (I13296, I13295, I13328) );$lllLI1l =($IIIILl1 >1) || $lllLILI ?I13246 :'_no_percentage'; $answers .= $this->cms->Gui->get($lllLIlI.'row_result'.$lllLI1l, $lllLI1I); }if($lllLILl){ $v =intval($lllLILI/$llll1Ll*$lllLIll); $lllLI1I =Array("answer"=>$lllLIlL, I13326=>$v+1, "width2"=>($lllLIll -$v), I13329=>$lllLILI <$llll1l1 ?I13246 :';display:none;visibility:hidden', "voicesNumeric" => $lllLILI, I13298=>sprintf(I13327,$lllLILI/$llll1Ll*100), 'show_numeric_percentage' => $llll1lI, 'show_numeric_total' => $llll1ll );$lllLI1I[I13295] =$this->cms->Gui->get($lllLIlI.I13295, $lllLI1I); $lllLI1I[I13328] =$this->cms->Gui->get($lllLIlI.I13328, $lllLI1I); $this->TIl1l1T( $lllLI1I, $this->moduleName.I13315, $aData[I13275], array (I13296, I13295, I13328) );$lllLI1l =$IIIILl1 >0 ?I13246 :I13330; $answers .= $this->cms->Gui->get($lllLIlI.'row_result'.$lllLI1l, $lllLI1I); }}else {$answers =$this->cms->Gui->getAbs($lllLIlI.'no_answers', ""); }$aItem[I13299] =$answers; $this->TIl1l1T( $aItem, $this->moduleName.I13315, $aData[I13275], array (I13289) );}function TTT1ITI($cId, $cModule) {$cId =(int)$cId; if ($cId == 0 || !isset($this->cms->VarsPost["voted"]) || $this->cms->VarsPost[I13331] != 1) {return; }if ($this->_alreadyVoted($this->id)) {return; }$sql ="SELECT qtype, allowother FROM cms_votes WHERE id='".$cId.I13293; $this->db->query($sql); if (!$this->db->next_record()) {return; }$qtype =$this->db->Record[I13324]; $allowother =$this->db->Record[I13316]; if ($qtype == 'multiple_checkboxes' && !$allowother && isset($this->cms->VarsPost['multiple_checkboxes']) && !is_array($this->cms->VarsPost['multiple_checkboxes']) ){return; }$checkboxes =isset($this->cms->VarsPost[I13332]) && is_array($this->cms->VarsPost[I13332]) ?array_map('intval', $this->cms->VarsPost[I13332]) :($allowother && $this->db->num_rows() == 0 ?Array (0) :Array ());$I1IllII =Array ();$lllLI1L =0; $other =I13246; if ($allowother) {if ($qtype == 'multiple_checkboxes') {if (array_search(0, $checkboxes) !== false) {$other =trim($this->cms->VarsPost['voteother']); }}else {if (isset($this->cms->VarsPost[I13332]) && ($this->cms->VarsPost[I13332] == 'other') ){$other =trim($this->cms->VarsPost[I13333]); }}}$lllLI11 =mb_strtolower($other); $lllLlII =false; if($allowother && $other !== I13246){ $sql =$this->db->genUpdateSQL( 'cms_votevals', array(I13295 => '=|voices+1'), 'WHERE `id_vote` = ' .$cId ." AND LCASE(`message`) = '" .mysql_real_escape_string($lllLI11) .I13293 );$this->db->execute($sql); if($this->db->affectedRows()){ $lllLlII =true; }else{ $I1IllII[] =$this->db->genInsertSQL(I13334, array( I13295 => '1', 'id_vote' => $cId, I13306 => mysql_real_escape_string($other), I13301 => 1 ));}}$sql ="SELECT `id`, LCASE(`message`) `lc_message` " ."FROM `cms_votevals` " .I13335 .$cId ." AND `is_other` = 0 " ."ORDER BY id ASC"; $rs =$this->db->select($sql); $voteline =0; while($record =$rs->nextRecord()){ $voteline++; $id =(int)$record[I13256]; if($lllLlII && $record['lc_message'] === $lllLI11){ continue; }$lllLlIl =false; if($qtype == 'multiple_checkboxes'){ if(array_search($id, $checkboxes) !== false){ $lllLlIl =true; }}else{ if(isset($this->cms->VarsPost[I13332]) && ($this->cms->VarsPost[I13332] == $voteline)){ $lllLlIl =true; }}if($lllLlIl){ $I1IllII[] =$this->db->genUpdateSQL( I13334, array(I13295 => I13336), 'WHERE `id` = ' .$id );}}foreach($I1IllII as $sql) {$this->db->query($sql); }if(sizeof($I1IllII) || $lllLlII){ $sql ="UPDATE `cms_votes` SET total = total + 1 WHERE id = '".$cId.I13293; $this->db->execute($sql); $this->cms->Gui->AddGlobalVars(Array ("REGISTERED_NEW_VOTE" => "1")); $this->TIl1l1I($cId); $llll1I1 =false; $this->TIl1ll1($llll1I1); }else {$langFile =$this->cms->Gui->ParseLangFile("templates/lang/_votes_msgs.lng"); $this->cms->InitMessages($langFile); if ($allowother) {$this->cms->AddStatusMsg( $i >0 ?'select_or_enter_answer' :'enter_answer_warn', 'red' );}else {$this->cms->AddStatusMsg('select_answer_warn', I13337); }$this->action ='none'; $this->_specialAction =I13246; }}function TIl1l1T(&$vData, $blockName, $prefix, $fields, $lllLlIL =true) {foreach ($fields as $field) {if ($lllLlIL && empty($vData[$field])) {continue; }$vData[$field] =$this->cms->Gui->getAbs($blockName.":".$prefix.$field, $vData); }}function TIl1l1I($pollId) {$pollId =(int)$pollId; $this->llllL1I =$pollId; $cookie =$this->module->GetProperty('prefix')."Votes"; if (is_null($this->llllL1l)) {$this->llllL1l =isset($this->cms->VarsCookie) && isset($this->cms->VarsCookie[$cookie]) ?unserialize($this->cms->VarsCookie[$cookie]) :Array ();}$this->llllL1l[$pollId] =1; $this->cms->VarsCookie[$cookie] =serialize($this->llllL1l); SetLocalCookie($cookie, $this->cms->VarsCookie[$cookie], time()+60*60*24*365); }function _alreadyVoted($pollId) {$pollId =(int)$pollId; if ($this->llllL1I == $pollId) {return false; }if (!is_null($this->llllL1l)) {return isset($this->llllL1l[$pollId]); }$cookie =$this->module->GetProperty(I13338).'Votes'; $this->llllL1l =isset($this->cms->VarsCookie) && isset($this->cms->VarsCookie[$cookie]) ?unserialize($this->cms->VarsCookie[$cookie]) :Array ();return isset($this->llllL1l[$pollId]); }function TIl1l1l() {if (!is_null($this->llllL1l)) {return array_keys($this->llllL1l); }$cookie =$this->module->GetProperty(I13338).'Votes'; $this->llllL1l =isset($this->cms->VarsCookie) && isset($this->cms->VarsCookie[$cookie]) ?unserialize($this->cms->VarsCookie[$cookie]) :Array ();return array_keys($this->llllL1l); }}