<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       31747 xkqwplxyuwtwpnnnrstxqnzkuxgzssmlxyxmwzmpszzxxlqztgyyqwusprzsirurkqsgpnir
 */ ?><?php foreach(array(13355=>'tZr|DZvQ',13356=>'fHrWQ|WOIHS|SMr',13357=>'',13358=>"?",13359=>'nZIQ',13360=>'zdwmm',13361=>'tBGQ',13362=>'WOKDuI',13363=>'~',13364=>'j',13365=>'q|TzR|cRmTq',13366=>'CMn',13367=>'tHrQZS',13368=>'QxtrZWtQSyBtQD',13369=>'CrMttQnyBtQD',13370=>'~;\`\~~',13371=>'~\~~',13372=>"uMS",13373=>"0",13374=>'PrHuG',13375=>'IHSQ',13376=>'0',13377=>'~;\~}`[{~',13378=>'GrQfMx',13379=>'GHDMx|PQtGCuMS',13380=>'5',13381=>'YZDQSMr',13382=>'~\~$~',13383=>'CY') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} require_once $GLOBALS['CLASSES_PATH'] .'BaseObject.php'; class PHPTar extends BaseObject {public $fname; public $gz; public $fd; public $I1ILlII; public $lllLLLl; public $bufSize; public $files; public $dirs; public $exclude; public $lllLLLL; public $_options; public $lllLLL1; public $lllLL1I; public $lllLL1l; public $lllLL1L; public $lllLL11; public $lllLlll; public $lllLllL; public $archSize; public $lllL1II; public $filesDone; public $lllL1Il; function PHPTar($fname,$gz=true) {$this->BaseObject(); $this->TTTIT1I(I13355); $this->TTTIT1I('tar_extract'); $this->fname =$fname; $this->gz =$gz; $this->fd =false; $this->bufSize =1024*512; $this->files =array(); $this->dirs =array(); $this->exclude =array(); $this->lllLLL1 =''; $this->lllLlll =$this->lllLL1L =$this->lllLL11 =$this->I1ILlII =$this->archSize =0; $this->lllLllL =$this->bufSize; $this->filesDone =$this->lllL1II =0; $this->_options =array( 'basedir' => './', I13356 => -1, 'force_chmod_file' => -1, 'num_events' => 10, 'event_step' => 50 );$this->timeLimit =240; $this->lllLL1I ='.meta'; $this->lllLL1l =false; $this->lllLLLl =str_repeat(chr(0),512); $this->lllLLLL =false; }function TIl11II($fname,$mode,$gz) {$fd =$gz ?@gzopen($fname,$mode) :@fopen($fname,$mode); if($fd===false) {return $this->TTTITTI("Cannot open file '$fname', mode='$mode'"); }return $fd; }function _open($mode) {if(!($this->fd=$this->TIl11II($this->fname,$mode,$this->gz))) return false; return true; }function _read($IL11lLI) {if($IL11lLI==0) return I13357; $I1IlLLl =$this->gz ?gzread($this->fd,$IL11lLI) :fread($this->fd,$IL11lLI); if($I1IlLLl===false) {$this->TTTITTI("Cannot read $IL11lLI bytes from archive"); return false; }$this->I1ILlII += mb_strlen($I1IlLLl, 'ASCII'); $lllLl1I =intval($this->I1ILlII/$this->lllLllL); if($lllLl1I>$this->lllLlll) {$this->_fireEvent(3); $this->lllLlll =$lllLl1I; }return $I1IlLLl; }function _write($str) {$len =mb_strlen($str, 'ASCII'); if($len==0) return 0; $n =$this->gz ?@gzwrite($this->fd,$str) :@fwrite($this->fd,$str); if($n===false || $n==0 && $len!=0) {$this->TTTITTI("Cannot write $len bytes to archive",'E_TAR_WRITE'); return false; }$this->I1ILlII += mb_strlen($str, 'ASCII'); $lllLl1I =intval($this->I1ILlII/$this->lllLllL); if($lllLl1I>$this->lllLlll) {$this->_fireEvent(4); $this->lllLlll =$lllLl1I; }return $n; }function _close() {return $this->gz ?@gzclose($this->fd) :@fclose($this->fd); }function __computeUnsignedChecksum($lllL1IL) {$lllL1I1 =0; for($i=0; $i<512; $i++) $lllL1I1 += ord($lllL1IL[$i]); for($i=0; $i<8; $i++) $lllL1I1 -= ord($lllL1IL[148 +$i]); $lllL1I1 += ord(I13358) *8; return $lllL1I1; }function __parseNullPaddedString($string) {$position =mb_strpos($string,chr(0), 0, 'ASCII'); if ($position !== false) return mb_substr($string,0,$position, 'ASCII'); return ($string); }function TIl11Il() {if(($block=$this->_read(512))===false) {return false; }if($block==I13357 || $block==$this->lllLLLl) {return array(); }$file =array(); $prefix =$this->__parseNullPaddedString(mb_substr($block,345,155, 'ASCII')); if($prefix!=I13357) $prefix .= '/'; if($this->lllLLL1!=I13357) {$file[I13359] =$this->lllLLL1; $this->lllLLL1 =I13357; }else $file[I13359] =$prefix.$this->__parseNullPaddedString(mb_substr($block,0,100, 'ASCII')); $file['mode'] =mb_substr($block,100,8, 'ASCII')+0; $file['uid'] =octdec(mb_substr($block,108,8, I13360)); $file['gid'] =octdec(mb_substr($block,116,8, I13360)); $file['size'] =octdec(mb_substr($block,124,12, I13360)); $file['time'] =octdec(mb_substr($block,136,12, I13360)); $file['chksum'] =octdec(mb_substr($block,148,6, I13360)); $_type =mb_substr($block,156,1, I13360); $file[I13361] =$_type=='L' ?'L' :octdec($_type); $file['uname'] =$this->__parseNullPaddedString(mb_substr($block,265,32, I13360)); $file['gname'] =$this->__parseNullPaddedString(mb_substr($block,297,32, I13360)); $lllL1lI =$this->__computeUnsignedChecksum($block); if($lllL1lI != $file[I13362]) {$this->TTTITTI("Checksum error: file=$file[name], offset=$this->I1ILlII: expected $file[chksum], got $lllL1lI"); return false; }$file['toread'] =(ceil($file['size'] /512) *512); return $file; }function TIl11I1($basedir,$path,$mode,$mtime=false) {if($mode>0) $lllL1ll =$this->_options[I13356]>0 ?$this->_options[I13356] :octdec($mode); $lllL1lL =$basedir.$path; if(file_exists($lllL1lL)) {if($mtime!==false) @touch($lllL1lL,$mtime); if($mode>0 && !@chmod($lllL1lL,$lllL1ll)) $this->TTTITlT("Cannot chmod $lllL1lL"); return true; }$dirs =explode('/',$path); $lllL1l1 =$basedir; while($dir=array_shift($dirs)) {$lllL1l1 .= $dir; if(!file_exists($lllL1l1)) {if(!@mkdir($lllL1l1)) {$this->TTTITTI("Cannot mkdir $lllL1l1",'E_TAR_WRITE'); return false; }}$lllL1l1 .= I13363; $this->III1Ill =true; $this->filesDone++; if($this->lllL1Il) $this->_fireEvent(1); }if($mtime!==false) @touch($lllL1l1,$mtime); if($mode>0 && !@chmod($lllL1l1,$lllL1ll)) $this->TTTITlT("Cannot chmod $lllL1l1"); return true; }function TIl11lT($file,$dest) {if($this->filesDone==0 && $file[I13359]==$this->lllLL1I) {$this->lllLL1l =$this->TIl11lI($file); if($this->lllLL1l===false) {return false; }return true; }$name =$dest.$file[I13359]; $lllL1LI =$file['size']; if($file[I13361]==5) {if($this->_read($file['toread'])===false) return false; return $this->TIl11I1($dest,$file[I13359],$file['mode'],$file['time']); }elseif($file[I13361]===I13364) {$this->lllLLL1 =I13357; $bs =$lllL1LI>$this->bufSize ?$this->bufSize :$lllL1LI; while($lllL1LI>0) {if(($I1IlLLl=$this->_read($bs))===false) return false; $this->lllLLL1 .= $I1IlLLl; $lllL1LI -= mb_strlen($I1IlLLl, I13360); if($lllL1LI<$bs) $bs =$lllL1LI; }$this->lllLLL1 =mb_substr($this->lllLLL1,0,mb_strlen($this->lllLLL1, I13360)-1, I13360); if($this->_read($file['toread']-$file['size'])===false) return false; return true; }else {$tmp =explode(I13363,$file[I13359]); $fname =array_pop($tmp); if(!$this->TIl11I1($dest,implode(I13363,$tmp),-1,$file['time'])) {return false; }$bs =$lllL1LI>$this->bufSize ?$this->bufSize :$lllL1LI; if(!($f=@fopen($name,'wb'))) {$this->TTTITTI("Cannot open $name for writing",I13365); return false; }$this->III1Ill =true; while($lllL1LI>0) {if(($I1IlLLl=$this->_read($bs))===false) {@fclose($f); return false; }$lllL1LI -= mb_strlen($I1IlLLl, I13360); if($lllL1LI<$bs) $bs =$lllL1LI; if(@fwrite($f,$I1IlLLl)===false) {@fclose($f); $this->TTTITTI("Cannot write ".mb_strlen($I1IlLLl, I13360)." bytes to $name",I13365); return false; }}if($this->_read($file['toread']-$file['size'])===false) {@fclose($f); return false; }@fclose($f); @touch($name,$file['time']); $this->filesDone++; if($this->lllL1Il) $this->_fireEvent(1); if(mb_strpos(strtolower(PHP_OS),I13366, 0, I13360)!==false) {$lllL1ll =$this->_options['force_chmod_file']>0 ?$this->_options['force_chmod_file'] :octdec($file['mode']); if(!@chmod($name,$lllL1ll)) $this->TTTITlT("Cannot chmod $name"); }return true; }}function TIl11lI($file) {if($file[I13361]!=0) {return $this->TTTITTI("Cannot extract file of type '$file[type]' to string"); }$lllL1LI =$file['size']; $bs =$lllL1LI>$this->bufSize ?$this->bufSize :$lllL1LI; $res =I13357; $this->III1Ill =true; while($lllL1LI>0) {if(($I1IlLLl=$this->_read($bs))===false) {return false; }$lllL1LI -= mb_strlen($I1IlLLl, I13360); if($lllL1LI<$bs) $bs =$lllL1LI; $res .= $I1IlLLl; }if($this->_read($file[I13367]-$file['size'])===false) {return false; }return $res; }function _fireEvent($op,$done=false) {$event =$done ?'done' :'progress'; switch($op) {case 1: if(!$done && $this->filesDone %$this->_options['event_step']) return; case 3: $data =array(I13368=>$this->I1ILlII,'extractedFiles'=>$this->filesDone, 'archSize'=>$this->archSize,'gz'=>$this->gz); $this->TTTIITI('tar_extract',$event,$data); break; case 2: if(!$done && $this->filesDone<$this->lllLL1L) return; $this->lllLL1L += $this->lllLL11; case 4: $data =array(I13369=>$this->I1ILlII, 'savedFiles'=>$this->filesDone,'totalFiles'=>$this->lllL1II); $this->TTTIITI(I13355,$event,$data); break; default: trigger_error('PHPTar::_fireEvent($op): unknown opcode',E_USER_ERROR); break; }return true; }function TIl11ll(&$path) {$path =preg_replace('/\/+/', I13363,$path); $path =preg_replace(I13370, I13357,$path); if(preg_match('/\.\.\//',$path)) {$this->TTTITTI("../ in paths not allowed"); return false; }return true; }function TIl11l1($dir) {if(!$this->TIl11ll($dir)) return false; if($dir!=I13357) {$this->dirs[$dir] =1; }return true; }function TIl111T($fname ){$base =$fname[0]==I13363 ?I13357 :$this->TI1TTTl(); if(!$this->TIl11ll($fname)) return false; if($fname!=I13357) {$this->_excludeDone =false; $this->files[$fname] =1; }return true; }function TIl111I($dir) {@set_time_limit($this->timeLimit); $lllL1Ll =$dir!=I13357 && $dir[0]==I13363 ?$dir :$this->TI1TTTl().$dir; if(!($dh=opendir($lllL1Ll))) {$this->TTTITTI("Cannot opendir $lllL1Ll"); return false; }if(!$this->TIl11l1($dir)) {closedir($dh); return false; }$this->_excludeDone =false; while($de=readdir($dh)) {if($de=='.' || $de=='..') continue; $lllL1lL =$lllL1Ll.$de; if(is_dir($lllL1lL) && !is_link($lllL1lL)) {if(!$this->TIl111I($dir.$de.I13363)) {closedir($dh); return false; }}elseif(is_file($lllL1lL) && !is_link($lllL1lL)) {if(!$this->TIl111T($dir.$de)) {closedir($dh); return false; }}else {}}return true; }function TIl111l() {if($this->_excludeDone) return true; foreach($this->exclude as $lllL1LL=>$tmp) {$lllL1LL =preg_replace(I13371,"\\/",$lllL1LL); foreach($this->files as $f=>$tmp) if(preg_match("/^$lllL1LL/",$f)) unset($this->files[$f]); foreach($this->dirs as $f=>$tmp) if(preg_match("/^$lllL1LL/",$f)) unset($this->dirs[$f]); }$this->_excludeDone =true; return true; }function TIl1111($info) {$header =I13357; $header .= str_pad($info['fname'],100,chr(0)); $header .= str_pad(decoct($info["mode"]),7,"0",STR_PAD_LEFT) .chr(0); $header .= str_pad(decoct($info[I13372]),7,"0",STR_PAD_LEFT) .chr(0); $header .= str_pad(decoct($info["gid"]),7,"0",STR_PAD_LEFT) .chr(0); $header .= str_pad(decoct($info['size']),11,I13373,STR_PAD_LEFT) .chr(0); $header .= str_pad(decoct($info["mtime"]),11,I13373,STR_PAD_LEFT) .chr(0); $header .= str_repeat(I13358,8); $header .= $info[I13361]; $header .= str_repeat(chr(0),100); $header .= str_pad("ustar",6,chr(0)); $header .= '00'; $header .= str_pad($info['user'],32,chr(0)); $header .= str_pad($info[I13374],32,chr(0)); $header .= '0000000'.chr(0); $header .= '0000000'.chr(0); $header .= str_pad($info['prefix'],155,chr(0)); $header .= str_repeat(chr(0),12); $lllL1lI =$this->__computeUnsignedChecksum($header); $checksum =str_pad(decoct($lllL1lI),6,I13373,STR_PAD_LEFT); for($i=0; $i<6; $i++) {$header[(148 +$i)] =mb_substr($checksum,$i,1, I13360); }$header[154] =chr(0); $header[155] =chr(32); return $header; }function TI1TTTT() {if($this->lllLL1l===false) {return true; }$info =array( 'fname' => $this->lllLL1I, I13375 => 0600, 'uid' => 0, 'gid' => 0, 'size' => mb_strlen($this->lllLL1l, I13360), 'mtime' => time(), I13361 => I13376, 'user' => I13357, I13374 => I13357, 'prefix' => I13357 );$header =$this->TIl1111($info); if(!$this->_write($header)) {return false; }$this->III1Ill =true; if($this->_write($this->lllLL1l)===false) {return false; }if($this->_write(str_repeat(chr(0),ceil($info['size']/512)*512-$info['size']))===false) {return false; }return true; }function _saveFile($fname) {$lllL1Ll =$fname[0]==I13363 ?$fname :$this->TI1TTTl().$fname; if(!($info =@stat($lllL1Ll))) {$this->TTTITTI("Cannot stat $lllL1Ll"); $this->_close(); return false; }$fname =preg_replace(I13377,'$1',$fname); $lllL1L1 =mb_strlen($fname, I13360); if($lllL1L1>100) {for($i=$lllL1L1-101; $i<$lllL1L1; $i++) if($fname[$i]==I13363) break; $info['prefix'] =mb_substr($fname,0,$i, I13360); $info['fname'] =mb_substr($fname,$i+1, 100, I13360); if ($info['fname'] == I13357 or mb_strlen($info[I13378], I13360) >155) {$this->filesDone++; if($this->lllL1Il) {$this->_fireEvent(2); }return true; }}else {$info[I13378] =I13357; $info['fname'] =$fname; }$info[I13361] =$info[I13375] &040000 ?'5' :I13376; if($info[I13361]=='5') {$info['size'] =0; }$a =array(); if(function_exists(I13379)) $a =posix_getpwuid($info['uid']); $info['user'] =isset($a[I13359]) ?$a[I13359] :I13357; $a =array(); if(function_exists('posix_getgrgid')) $a =posix_getgrgid($info['gid']); $info[I13374] =isset($a[I13359]) ?$a[I13359] :I13357; $header =$this->TIl1111($info); if(!$this->_write($header)) {return false; }$this->III1Ill =true; if($info[I13361]==I13380) {$this->filesDone++; if($this->lllL1Il) {$this->_fireEvent(2); }return true; }if(!($f=@fopen($lllL1Ll,'rb'))) {$this->TTTITTI("Cannot open $lllL1Ll for reading"); return false; }if(!$this->TI1TTTI($f,$lllL1Ll)) {@fclose($f); return false; }if($this->_write(str_repeat(chr(0),ceil($info['size']/512)*512-$info['size']))===false) {@fclose($f); return false; }@fclose($f); $this->filesDone++; if($this->lllL1Il) {$this->_fireEvent(2); }return true; }function TI1TTTI($f,$fname='input file') {while(!feof($f)) {if(($I1IlLLl=@fread($f,$this->bufSize))===false) return $this->TTTITTI("Tar: Error while reading from $fname"); if($this->_write($I1IlLLl)===false) return false; }return true; }function TI1TTTl() {return $this->_options[I13381]; }function TI1TTT1() {if(!file_exists($this->lllLLLL)) return $this->TTTITTI("Tar: cannot append '$this->lllLLLL': file does not exits"); $gz =preg_match('/\.gz$/',$this->lllLLLL) ?true :false; if(!($fd=$this->TIl11II($this->lllLLLL,'rb',$gz))) return false; if(!$this->TI1TTTI($fd,$this->lllLLLL)) {@fclose($fd); return false; }@fclose($fd); return true; }function options($opt) {if(!is_array($opt)) {$this->TTTITTI("Invalid argument passed to options()"); return false; }while(list($name,$val)=each($opt)) {if($name==I13381) {if($val==I13357) $val ='./'; elseif(!preg_match(I13382,$val)) $val .= I13363; $this->_options[I13381] =$val; }elseif(isset($this->_options[$name])) $this->_options[$name] =$val; }return true; }function extract($dir=false) {if($dir===false) $dir =$this->TI1TTTl(); $lllL11I =$dir; $dir =realpath($dir); if($dir!==false) {$dir =str_replace("\\",I13363,$dir); if(!preg_match(I13382,$dir)) $dir .= I13363; }if($dir===false || !is_dir($dir)) return $this->TTTITTI("Target '$lllL11I' (real path: '$dir') is not a directory or does not exist"); if($this->_open('rb')===false) return false; $this->lllLLL1 =I13357; $this->I1ILlII =0; $this->TTTITTT(); if($this->TTTIITl('tar_extract')) {$this->lllL1Il =true; }$this->archSize =filesize($this->fname); $this->filesDone =0; $n =0; while(true) {@set_time_limit($this->timeLimit); $file =$this->TIl11Il(); if($file===false) {$this->_close(); return false; }if(sizeof($file)==0) {$this->_close(); if($this->lllL1Il) $this->_fireEvent(1,true); return true; }if(!$this->TIl11lT($file,$dir)) {$this->_close(); return false; }}}function add($fname) {$lllL1Ll =$fname!=I13357 && $fname[0]==I13363 ?$fname :$this->TI1TTTl().$fname; if(is_file($lllL1Ll)) {return $this->TIl111T($fname); }elseif(is_dir($lllL1Ll)) {if($fname==I13357) $fname ='./'; elseif(!preg_match(I13382,$fname)) $fname .= I13363; return $this->TIl111I($fname); }else {$this->TTTITTI("File $lllL1Ll does not exist or is of unsupported type"); return false; }}function exclude($path) {if(!$this->TIl11ll($path)) return false; if($path!=I13357) $this->exclude[$path] =1; $this->_excludeDone =false; return true; }function TI1TTIT() {$this->TIl111l(); $this->lllL1II =sizeof($this->dirs)+sizeof($this->files); return $this->lllL1II; }function save() {if($this->_open(I13383)===false) {return false; }$this->TI1TTIT(); if($this->lllLLLL!==false) $this->lllL1II++; $this->lllLL11 =$this->lllL1II/$this->_options['num_events']; $this->lllLL1L =$this->lllLL11; $this->filesDone =0; $this->I1ILlII =0; if($this->TTTIITl(I13355)) {$this->lllL1Il =true; }if(!$this->TI1TTTT()) {$this->_close(); return false; }reset($this->dirs); $n =0; while(list($dir,)=each($this->dirs)) {@set_time_limit($this->timeLimit); if(!$this->_saveFile($dir)) {$this->_close(); return false; }}reset($this->files); while(list($file,)=each($this->files)) {@set_time_limit($this->timeLimit); if(!$this->_saveFile($file)) {$this->_close(); return false; }}if($this->lllLLLL!==false) {if(!$this->TI1TTT1()) return false; }else {if(!$this->_write($this->lllLLLl)) {return false; }}$this->_close(); if($this->lllL1Il) {$this->_fireEvent(2,true); }return true; }function TI1TTII($fname) {$this->lllLLLL =$fname; }function meta($meta=false) {if($meta===false) {if($this->lllLL1l!==false) {return $this->lllLL1l; }if($this->_open('rb')===false) {return false; }$this->lllLLL1 =I13357; $this->I1ILlII =0; $this->TTTITTT(); $this->archSize =filesize($this->fname); $this->filesDone =0; $res =false; do {$file =$this->TIl11Il(); if($file===false) {break; }if(sizeof($file)==0 || $file[I13359]!=$this->lllLL1I) {break; }$res =$this->TIl11lI($file); }while(false); $this->_close(); return $res; }else {$this->lllLL1l =$meta; }}}