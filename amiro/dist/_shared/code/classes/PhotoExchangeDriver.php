<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       15511 xkqwsyzlqmugilksuzitmtyltmimmwsqkmmzprlpyqnrpzpsigzkkqxpxwktuwrgwwrupnir
 */ ?><?php foreach(array(13629=>"DuGGHrtQS|ZWtMHnD",13630=>"[`LGP",13631=>"|fHrI",13632=>"GOHtHZJYuI|GZrZID",13633=>"10010",13634=>"SMrD",13635=>"WZtnZIQ",13636=>"fMJQD|GrHW",13637=>"ZWtMHn",13638=>"wzTqphRb",13639=>"SMrD|GrHW",13640=>"fMQJSD",13641=>"GrHWQDD|MtQID",13642=>"~",13643=>"GrQGZrQ|MIZPQD",13644=>"GrQGZrQ|WZtQPHrMQD",13645=>"WZJJYZWK|QrrHr",13646=>"\\",13647=>"MS",13648=>"`",13649=>"_",13650=>"|",13651=>"",13652=>"vZJuQ",13653=>"WHunt|SMrD",13654=>"ZJJ",13655=>"fMJQD") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class PhotoExchangeDriver extends ExchangeDriver{ public $Il11l1L; public $importPath; public $lll1Ll1; function PhotoExchangeDriver(&$gui, &$module) {parent::ExchangeDriver($gui, $module); require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_translit.php"); $this->name ="PhotoExchangeDriver"; $this->Il11l1L =0; }function GetInfo() {$aInfo =Array( "name"=>"PhotoExchangeDriver", "title"=>$this->words["title"], I13629=>Array("import"), "pathtypes"=>Array("dirs"), "filemask"=>Array(I13630, "*.jpeg", "*.gif", "*.png") );return $aInfo; }function GetForm($type, &$formData) {parent::GetForm($type, $formData); $html =$this->gui->get($this->name.":".$type.I13631, $formData); return $html; }function TTIIlIl($I1IIl1I, $I1IIl1l){ if($I1IIl1I >$I1IIl1l) $I1IIl1I =$I1IIl1l; return parent::TTIIlIl($I1IIl1I, $I1IIl1l); }function Start($actionType, &$aParams) {$II1LIlI =parent::Start($actionType, $aParams); $this->_config["fields"] =$this->module->TTII111("fields_map"); if(empty($aParams["photoalbum_params"]["cattype"]) || (($aParams[I13632]["cattype"] == 2) && !$aParams[I13632]["destination_cat_id"] && !$aParams["vars"]["catname"])){ $this->TTIIlT1(I13633, "empty_destination"); $II1LIlI =false; }if($II1LIlI) {$dataSource =$aParams["data_source"]; $lll1LLI =false; if ($aParams[I13632]["cattype"] == "1") {$outType =I13634; }else {$outType ="files"; if (trim($aParams["vars"]["catname"])) {$this->lll1Ll1 =trim($aParams["vars"][I13635]); $lll1LLI =true; }}if($this->TIT1lll($dataSource, $I1lIllL, $outType, $lll1LLI)){ $this->II1LIIL =$I1lIllL["count"]*2+1; $this->TTIIlIl(0, $this->II1LIIL); $II1LIlI =$this->TTIIlIT(Array("action"=>"common")); if($II1LIlI) {$I1lIllL["dirs_proc"] =$this->TIT1lI1($I1lIllL); $I1lIllL[I13636] =$this->TIT1llT($I1lIllL, $aParams[I13632]["destination_cat_id"], $aParams[I13632]["cattype"]); $II1LIlI =$this->TIT1lIl($I1lIllL); if($II1LIlI) {$II1LIlI =$this->TT1TTlI($I1lIllL); }if($II1LIlI) {$II1LIlI =$this->_PrepareImages($I1lIllL, $aParams["import_path"]); }if($II1LIlI) {$II1LIlI =$this->TT1TTll($I1lIllL); }if($II1LIlI) $this->TTIIlIl($this->II1LIIL, $this->II1LIIL); }}else {$this->TTIIlT1(I13633, "data_not_found"); $II1LIlI =false; }}return $II1LIlI; }function TT1TTlI(&$I1lIll1) {if($this->TTIIlIT(Array(I13637=>"process_categories"))) {$II1LIlI =true; $Il11L11 =0; if(is_array($I1lIll1["dirs_proc"])){ foreach($I1lIll1["dirs_proc"] as $path => $aData){ $aCatData =Array(); $Il11L11++; foreach($this->_config["fields"][I13638] as $fieldName => $fieldData) {if($fieldName == "UPDATE_FIELDS") continue; $I1lIlLI =array(); $aCatData[$fieldName] =$this->TT1TIT1($fieldData, $aData, $I1lIlLI); }$this->II1I1IL->{$this->II1I1I1["process_categories"]}($aCatData); $this->Il11l1L++; $this->TTIIlIl($this->Il11l1L, $this->II1LIIL); }}if(isset($I1lIll1["dirs_proc"]["ROOTPATH"])) unset($I1lIll1[I13639]["ROOTPATH"]); }else {$this->TTIIlT1("10012", "callback_error"); $II1LIlI =false; }return $II1LIlI; }function TT1TTll(&$I1lIll1) {if($this->TTIIlIT(Array(I13637=>"process_items"))) {$II1LIlI =true; $Il11L11 =0; if(is_array($I1lIll1[I13636])){ foreach($I1lIll1[I13636] as $path => $aData){ $aItemData =Array(); $Il11L11++; foreach($this->_config[I13640]["CATALOG"] as $fieldName=>$fieldData) {$aItemData[$fieldName] =$this->TT1TIT1($fieldData, $aData); }$aItemData += $this->TT1TITI($aData); $this->II1I1IL->{$this->II1I1I1["process_items"]}($aItemData); $this->Il11l1L++; $this->TTIIlIl($this->Il11l1L, $this->II1LIIL); }}}else {$this->TTIIlT1("10012", "callback_error"); $II1LIlI =false; }$this->TTIIlII(Array(I13637=>I13641)); return $II1LIlI; }function _PrepareImages(&$I1lIll1, $I1lIlLl) {$II1LIlI =true; if(is_array($I1lIll1["files"]) && sizeof($I1lIll1["files"]) >0) {if($this->TTIIlIT(Array(I13637=>"prepare_images"))) {$I1lIlLL =str_replace("\\", I13642, $I1lIlLl); if($I1lIlLL[mb_strlen($I1lIlLL)-1] == I13642) $I1lIlLL =mb_substr($I1lIlLL, 0, mb_strlen($I1lIlLL)-1); foreach($I1lIll1["files"] as $key => $fileName) {$I1lIlL1 =str_replace("\\", I13642, $fileName); if(mb_strlen($I1lIlLL) >0) if(($pos =mb_strpos($I1lIlL1, $I1lIlLL)) !== false) if($pos == 0) $I1lIlL1 =mb_substr($I1lIlL1, mb_strlen($I1lIlLL) +1); $I1lIl1I =$this->TIT1ll1($I1lIlL1, $I1lIll1[I13636][$fileName]["id"]); $I1lIll1[I13636][$fileName]["store_name"] =$I1lIl1I; $this->II1I1IL->{$this->II1I1I1[I13643]}(Array("file_name"=>$I1lIlL1, "store_name"=>$I1lIl1I)); $this->Il11l1L++; $this->TTIIlIl($this->Il11l1L, $this->II1LIIL); }}else {$this->TTIIlT1("10012", "callback_error"); $II1LIlI =false; }$this->TTIIlII(Array(I13637=>I13643)); }return $II1LIlI; }function TIT1lIl(&$I1lIll1) {$II1LIlI =true; if($this->TTIIlIT(Array(I13637=>I13644))) {$numCats =sizeof($I1lIll1[I13639]); $i =0; foreach($I1lIll1[I13639] as $path => $data) {$this->II1I1IL->{$this->II1I1I1[I13644]}(Array("id_external"=>$I1lIll1[I13639][$path]["id"], "is_mark_deleted"=>0)); $this->Il11l1L++; $this->TTIIlIl($this->Il11l1L, $this->II1LIIL); $i++; }}else {$this->TTIIlT1("10012", I13645); $II1LIlI =false; }$this->TTIIlII(Array(I13637=>I13644)); return $II1LIlI; }function TIT1lI1(&$I1lIll1){ $I1lIl11 =array(); if(is_array($I1lIll1[I13634])){ foreach($I1lIll1[I13634] as $key => $dir){ $I1lILII =str_replace(array(I13642, "\\"), array(".", "."), $dir[mb_strlen($dir)-1] == I13642 ?$dir[mb_strlen($dir)-2] :$dir[mb_strlen($dir)-1]); if($this->module->TTII111("use_transliterate")) $I1lILII =str_replace(array(I13646, I13642), array("_", "_"), cms_transliterate($I1lILII, $this->langData)); $I1lIl11[$dir]["id"] =mb_substr(md5($dir), 16, 8).$I1lILII; }foreach($I1lIl11 as $dir => $data){ $I1lILIl =$this->TIT1llI($dir); $I1lIl11[$dir]["pid"] =$I1lIl11[$I1lILIl[1]][I13647]; $I1lIl11[$dir]["dir"] =$this->lll1Ll1 ?$this->lll1Ll1 :$I1lILIl[0]; }}return $I1lIl11; }function TIT1llT(&$I1lIll1, $lll1LLl, $lll1LLL){ $I1lIl11 =array(); if(is_array($I1lIll1["files"])){ foreach($I1lIll1["files"] as $key => $file){ $fileName =$file; $filePath =""; if(($pos =mb_strrpos($fileName, I13648)) !== false) $fileName =mb_substr($fileName, 0, $pos); $I1lILIL =mb_strrpos($fileName, I13642); if($I1lILIL === false) $I1lILIL =-1; $I1lILI1 =mb_strrpos($fileName, I13646); if($I1lILI1 === false) $I1lILI1 =-1; $pos =max($I1lILIL, $I1lILI1); if($pos >= 0){ $filePath =mb_substr($fileName, 0, $pos); $fileName =mb_substr($fileName, $pos+1); }$I1lIl11[$file]["cid"] =((isset($I1lIll1[I13639][$filePath]) && $lll1LLL != 2) ?$I1lIll1[I13639][$filePath][I13647] :""); $I1lIl11[$file]["name"] =$fileName; if (sizeof($I1lIll1[I13634]) == 1) {$filePath =$I1lIll1[I13634][0]; }$I1lIl11[$file][I13647] =(isset($I1lIll1[I13639][$filePath]) ?($lll1LLL == 2 ?"cat".$lll1LLl.I13649 :"").$I1lIll1[I13639][$filePath][I13647] :"cat".$lll1LLl).I13649.mb_substr(md5($file), 16, 8); $I1lILlI =mb_substr($fileName, max(0, mb_strlen($fileName)-50)); if($this->module->TTII111("use_transliterate")) $I1lILlI =str_replace(array(I13646, I13642), array("_", I13650), cms_transliterate($I1lILlI, $this->langData)); $I1lIl11[$file][I13647] =addslashes($I1lILlI.I13648.$I1lIl11[$file][I13647].($this->module->TTII111("use_transliterate") ?"tr" :"")); }}return $I1lIl11; }function TIT1llI($cPath){ $I1lILll =$cPath; $I1lILlL =""; if($cPath[mb_strlen($cPath)-1] == I13642 || $cPath[mb_strlen($cPath)-1] == I13646) $cPath =mb_substr($cPath, 0, mb_strlen($cPath)-1); $I1lILIL =mb_strrpos($cPath, I13642); if($I1lILIL === false) $I1lILIL =-1; $I1lILI1 =mb_strrpos($cPath, I13646); if($I1lILI1 === false) $I1lILI1 =-1; $pos =max($I1lILIL, $I1lILI1); if($pos >= 0){ $I1lILll =mb_substr($cPath, $pos+1); $I1lILlL =mb_substr($cPath, 0, $pos); }return array($I1lILll, $I1lILlL); }function TT1TIT1($fieldData, &$aRowData, $I1lIlLI =I13651) {$value =I13651; switch($fieldData["type"]) {case "proc_data": $value =$aRowData[$fieldData["value"]]; break; case "value": $value =$fieldData[I13652]; break; }return $value; }function TIT1lll($Ill1III, &$vRes, $outType =I13634, $lll1LLI =false, $Ill1IlI =true){ if($Ill1III[mb_strlen($Ill1III)-1] == '/' || $Ill1III[mb_strlen($Ill1III)-1] == '\\') $Ill1III =mb_substr($Ill1III, 0, mb_strlen($Ill1III)-1); if($Ill1IlI) $vRes =array("count" => 0, "count_files" => 0, I13653 => 0, "all" => array(), "files" => array(), I13634 => array()); if(is_dir($Ill1III)){ if($dir =opendir($Ill1III)){ if($outType != "files" || ($lll1LLI && $Ill1IlI)){ $vRes["count"] ++; $vRes[I13653] ++; $vRes[I13634][] =$Ill1III; $vRes[I13654][] =$Ill1III; }while(($file =readdir($dir)) !== false){ if(!in_array($file, array(I13648, ".."))){ if(is_dir($Ill1III.I13642.$file)){ $this->TIT1lll($Ill1III.I13642.$file, $vRes, $outType, false, false); }else{ if(preg_match('/^.*\.((jpg)|(jpeg)|(gif)|(png))$/i', $file)){ $vRes["count"] ++; $vRes["count_files"] ++; $vRes[I13655][] =$Ill1III.I13642.$file; $vRes[I13654][] =$Ill1III.I13642.$file; }}}}closedir($dir); return true; }}return false; }function TIT1ll1($file, $key){ $ext =".dat"; if(($pos =mb_strrpos($file, I13648)) !== false) $ext =mb_substr($file, $pos); $key =str_replace(I13646, I13642, $key); if(($pos =mb_strrpos($key, I13642)) !== false) $key =mb_substr($key, $pos+1); $key =preg_replace('/[^a-zA-Z0-9_\-А-Яа-я]/u', '_', $key); return $key.$ext; }function TT1TITI(&$aRowData) {$images =Array(); foreach($this->_config[I13640]["IMAGE"] as $fieldName=>$fieldData) {$images[$fieldName] =$this->TT1TIT1($fieldData, $aRowData); }return $images; }}?>