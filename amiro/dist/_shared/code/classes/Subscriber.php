<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       17174 xkqwsqnmixyyrnxizysnnwlpsgzzmnwlylxzxtukpulxnugpnlrsywkurmynkpqiswktpnir
 */ ?><?php foreach(array(14205=>'DuYD|QxGHrt',14206=>'+',14207=>'?',14208=>'ZWtMHn',14209=>"tHGMWD",14210=>'ZWtMvQ',14211=>"",14212=>'QxWJuSQ',14213=>"MS",14214=>"^",14215=>'MS|IQIYQr') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class Subscriber extends CMS_Member {public $ll1IIl1; function Subscriber(&$sess, $IIIL1ll ="subscriber", $ll1IILI ='subscribe') {$this->ll1IIl1 =$ll1IILI; parent::CMS_Member($sess, $IIIL1ll); $apiKey =AMI::getOption(I14205, 'api_key'); if(!empty($apiKey) && AMI::issetAndTrueOption(I14205, 'autoexport_enabled')){ $ll1IILl =AMI::getResource('subs_export/form/controller/adm'); AMI_Event::addHandler('on_change_subscriber', array($ll1IILl, 'handleChangeSubscriber'), $this->ll1IIl1); }}function TI1ll1T(&$cms, &$db, &$data, $sendMail =false, $update =true) {if($this->IllIII1){ if(isset($data[$this->IllIIIL]) && $data[$this->IllIIIL] != ''){ if($this->IllIIIL == 'phone'){ $username =str_replace(array('(', ')', I14206, '.', '+'), ' ', $data[$this->IllIIIL]); $username =preg_replace('/\s{2,}/', I14207, trim($username)); $username =str_replace(I14207, I14206, $username); }else{ $username =$data[$this->IllIIIL]; }$data['username'] =$username; $this->UsedFields[] ='username'; $IllIll1 =true; }}$res =0; $topics =$data["topics"]; $id_member =$this->checkUsername($db, $data["username"]); if($id_member >0) {$sql ="SELECT id FROM cms_subs_members WHERE id_member='$id_member'"; $db->query($sql); $add =!$db->next_record(); if($update) {$this->updateMember($cms, $db, $id_member, $data, true); }}else {$add =$this->createMember($cms, $db, $data, $sendMail); $id_member =$db->lastInsertId(); }if($add) {$sql ="INSERT INTO cms_subs_members (id_member, active, topics) VALUES ('$id_member', '1', '$topics')"; $db->query($sql); $res =$id_member; }$aEvent =array( I14208 => 'update', 'id_member' => $id_member, 'subscribe' => true );AMI_Event::fire('on_change_subscriber', $aEvent, $this->ll1IIl1); if(isset($IllIll1)){ array_pop($this->UsedFields); }return $res; }function TI1ll1I(&$cms, &$db, $id, $data, $IIIL1lL =false) {$res =0; $topics =$data[I14209]; if($this->updateMember($cms, $db, $id, $data, $IIIL1lL)) {$ll1IILL =&$cms->Core->GetModule($this->ll1IIl1); if($ll1IILL->GetOption(I14209)) {$sql ="UPDATE cms_subs_members SET topics='$topics' WHERE id_member='$id'"; $db->query($sql); $aEvent =array( I14208 => 'update', 'id_member' => $id, 'topics' => $topics, 'subscribe' => true );AMI_Event::fire('on_change_subscriber', $aEvent, $this->ll1IIl1); }$res =$id; }return $res; }function replaceSubscriber(&$db, $id, $active, $topics, $email ='') {$sql ="REPLACE cms_subs_members (id_member, active, topics) VALUES ('$id', '$active', '$topics')"; $db->query($sql); $aEvent =array( I14208 => 'update', 'id_member' => $id, 'email' => $email, I14210 => $active, 'topics' => $topics );AMI_Event::fire('on_change_subscriber', $aEvent, $this->ll1IIl1); }function TI1ll1l(&$cms, &$db, $id) {$sql ="DELETE FROM cms_subs_members WHERE id_member='$id'"; $db->query($sql); $sql ="DELETE FROM cms_subs_details WHERE id_member='$id'"; $db->query($sql); parent::TTI1lTl($cms, $db, $id); }function TI1ll11(&$db, $id, $active) {$res =false; $sql ="SELECT active FROM cms_members WHERE id='$id'"; $db->query($sql); if($active=="0" || ($db->next_record() && $db->Record["active"]==1)) {$stop =I14211; if($active=="0") {$stop =", date_stop=now() "; $aEvent =array( I14208 => 'activate', 'id_member' => $id, I14210 => 0, I14212 => true );}else{ $aEvent =array( I14208 => 'activate', 'id_member' => $id, I14210 => 1, 'subscribe' => true );}AMI_Event::fire('on_change_subscriber', $aEvent, $this->ll1IIl1); $sql ="UPDATE cms_subs_members SET active='$active' $stop WHERE id_member='$id'"; $db->query($sql); $res =true; }return $res; }function TT1I1Tl(&$db, $id, $status) {$res =false; $sql ="SELECT 1 FROM cms_subs_members WHERE id_member='$id'"; $db->query($sql); if(!$db->next_record()) {$sql ="INSERT INTO cms_subs_members (id_member, active) VALUES ('$id', '0')"; $db->query($sql); }$res =$this->TI1ll11($db, $id, $status); return $res; }function TT1I1T1(&$db, $id =0) {if(empty($id)) {$id =$this->User[I14213]; }$sql ="SELECT (cm.active & csm.active) as active FROM cms_members cm ". "INNER JOIN cms_subs_members csm ON csm.id_member=cm.id WHERE cm.id='$id'"; $db->query($sql); $db->next_record(); $res =($db->Record["active"] == 1); return $res; }function TI1l1TT(&$db, $id, $IIIl1I1) {if($this->TT1I1T1($db, $id)) {$sql ="SELECT topics FROM cms_subs_members WHERE active=1 AND id_member='$id'"; $db->query($sql); $db->next_record(); $ll1IIL1 =$db->Record[I14209]; }else {$ll1IIL1 =';'; }if($IIIl1I1) {$ll1IIL1 =mb_substr($ll1IIL1, 1); $res =Array(); while(!empty($ll1IIL1)) {$res[intval($ll1IIL1)] =1; $ll1IIL1 =mb_substr($ll1IIL1, mb_strpos($ll1IIL1, ';') +1); }}else {$res =(empty($ll1IIL1)) ?I14214 :$ll1IIL1; }return $res; }function TI1l1TI(&$db, $id, $ll1II1I) {$sql ="UPDATE cms_subs_members SET topics='".addslashes($ll1II1I)."' WHERE id_member='".intval($id)."'"; $db->query($sql); $aEvent =array( I14208 => 'set_topics', I14215 => $id, I14210 => 1, 'topics' => $ll1II1I );AMI_Event::fire('on_change_subscriber', $aEvent, $this->ll1IIl1); }}?>