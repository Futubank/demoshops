<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       43619 xkqwxktypsgxppgmmympsiqrrqgkltplrnzznxwwlkikxmmxpurizwtymttsliksmistpnir
 */ ?><?php foreach(array(14221=>"",14222=>"unKnHCn",14223=>"Drv|IuJtM|DMtQD",14224=>"DOHC|IQ|Zt|GZrQnt",14225=>"IQnu|IZMn",14226=>"IQnu|tHG",14227=>"IHSuJQ|nZIQ",14228=>"OtIJ|SQDWrMGtMHn",14229=>"MIP|IQnu|HvQr",14230=>"MD|GrMntZYJQ",14231=>"JZB|f1|YHSB",14232=>"JZB|f6|YHSB",14233=>"vMDMYJQ|ZrQZ",14234=>"WJMQnt|MG|ZrQZ",14235=>"'",14236=>"?ZnS?IQnu|IZMn=1",14237=>"ZSIMn",14238=>"'{",14239=>"'?",14240=>'~',14241=>"'?Hr?IHSuJQ|nZIQ,='GZPQD'{",14242=>'DQJQWt?MS!JZnP!IHSuJQ|nZIQ!DWrMGt|JMnK!MG|ZrQZ!GZPQ|nHMnSQx',14243=>'?',14244=>'DWrMGt|JMnK',14245=>"DWrMGt|JMnK=''?ZnS?IHSuJQ|nZIQ,='GZPQD'",14246=>"?Hr?}DWrMGt|JMnK=''?ZnS?IHSuJQ|nZIQ,='GZPQD'{{?",14247=>'?JMIMt?1',14248=>"GZrQnt|MS",14249=>"MIZPQ|ZJt|",14250=>'JMnQD',14251=>"MIP",14252=>"JMnQD",14253=>"MIP|fHJSQrIZDK",14254=>"GZPQ|tBGQ",14255=>'GZPQ|tBGQ',14256=>'',14257=>"IHSuJQ",14258=>"rQSMrQWt|MS",14259=>"\r\n",14260=>"*",14261=>"MtQI|IZDK",14262=>"?",14263=>"MIP|MnW",14264=>"YHSB",14265=>"MtQI|DQJQWtQS",14266=>"WMS",14267=>"|DBD|rMPOt|C",14268=>"trQQ%",14269=>"dqjqwT?MS!?GZrQnt|MS!?MS|DMtQ!?GuYJMW!?nZIQ!?IHSuJQ|nZIQ!?DWrMGt|JMnK!?rQSMrQWt|MS!?GZPQ|nHMnSQx!?MD|DQWtMHn!?YJHWK|IZDK!?GZrQZ|MS?",14270=>'GZrQnt|MS',14271=>"MS",14272=>"GZrQZ|MS",14273=>'|DBD|rMPOt|C',14274=>"IMnuDYHttHI",14275=>"0",14276=>"JQvQJ",14277=>"|",14278=>"nZIQ",14279=>"GZrQnt|MS?ZDW!",14280=>"DtZrt|MS",14281=>"fMQJSD",14282=>"fMJtQr",14283=>"SQfMnQS",14284=>"dqjqwT?.MS.!?.JZnP.!?.IHSuJQ|nZIQ.!?.DWrMGt|JMnK.!?.GuYJMW.!?.nZIQ.!?.MS|DMtQ.?",14285=>"coqRq?jqNpTo}.IHSuJQ|nZIQ.{?@?0?zNs?.IHSuJQ|nZIQ.?,=?'GZPQD'?zNs?.GuYJMW.?=?1?",14286=>'GZPQD',14287=>'IHSuJQ|nZIQ',14288=>'MS',14289=>'uDQS|vMrtuZJ|IHSuJQD',14290=>"dqjqwT?.IHSuJQ|nZIQ.?FRhi?.WID|GZPQD.?",14291=>"coqRq?.IHSuJQ|nZIQ.?mN}'",14292=>'DOHC|IQ|Zt|GZrQnt',14293=>"DOHC|DMYJMnPD='",14294=>"'!?",14295=>'OtIJ|SQDWrMGtMHn',14296=>"IQnu|IZMn='",14297=>'IQnu|tHG',14298=>"MIP|IQnu|ZWtMvQ='",14299=>'zim|qdwzgq|RqeUqdT',14300=>"MDdWZntB",14301=>'trMZJ|OZDO',14302=>"?coqRq?IHSuJQ|nZIQ='MnMt'?zNs?nZIQ='DtZrt'?zNs?SZtQ|IHSMfMQS#=FRhi|UNmXTmiq}",14303=>"dqjqwT?MS!?GZrQnt|MS!?IHSuJQ|nZIQ!?DWrMGt|JMnK!?JZDt|WOZnPQS?FRhi?WID|GZPQD?hRsqR?yb?MS?SQDW?jmimT?10") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} class Tree{ const NODE_CLEAR =0x0; const NODE_OPEN =0x1; const NODE_FOLDER =0x2; const NODE_NO_PUBLIC =0x4; const NODE_PROTECTED =0x40; const NODE_SECTION =0x10; const NODE_FIXED_BLOCK =0x20; const NODE_FOLDER_MASK =0xF; const NODE_ICONS_MASK =0xF0; public $ll1IlIl; public $lang_data; public $table; public $ll1IlIL; public $ll1IlI1; public $IILIlL1; public $ll1IllI; public $ll1Illl; public $ll1IllL; public $ll1Ill1; public $ll1IlLI; public $ll1IlLl; public $parentId; public $message; public $ll1IlLL; public $ll1IlL1; public $ll1Il1I; public $ll1Il1l; public $UseLang; public $ll1Il1L; public $ll1Il11; public $UseHidden; public $ll1ILII; public $ll1ILIl; public $ll1ILIL; public $ll1ILI1; public $idSite; public $ll1ILlI; public $ll1ILll; public $ll1ILlL; public $ll1ILl1; public $ll1ILLI; public $ll1ILLl; public $ll1ILLL; public $ll1ILL1; public $IlLLIIl; public $db; public $ll1IL1I; public $ll1IL1l; public $ll1IL1L; public $ll1IL11; private static $ll1I1II; private function __construct(&$IlLLIIl, $ll1I1Il =false){ require_once($GLOBALS["FUNC_INCLUDES_PATH"]."func_url.php"); $this->db =new DB_Si; $this->Cms =&$IlLLIIl; $this->ll1ILL1 =&$this->Cms->Gui; $this->ll1IlIl =$this->ll1ILL1->ll1IlIl; $this->lang_data =$this->ll1ILL1->lang_data; $this->ll1IlLL =true; $this->ll1IlL1 =true; $this->ll1IlIL =false; $this->ll1IlI1 =I14221; $this->ll1Il1I =false; $this->ll1Il1l ="%m/%d/%Y %h:%i:%s"; $this->UseLang =true; $this->ll1ILlI =$ll1I1Il; $this->BitHintsMsgs =array(); $this->ll1Il1L =false; $this->ll1Il11 =false; $this->UseHidden =true; $this->ll1ILII =false; $this->ll1ILIl =false; $this->ll1ILIL =$this->Cms->Core->GetOption("use_ip_filter"); $this->ll1ILI1 =$this->Cms->Core->IsInstalled("srv_multi_sites"); $this->idSite =0; if($this->ll1ILI1) {if($this->Cms->Side == "admin") {if($this->Cms->ActiveModule == I14222 || $this->Cms->Core->TTlI1T1($this->Cms->ActiveModule, "multi_site")) {$this->idSite =intval($this->Cms->Vars["id_site"]); }}else {if($this->Cms->Core->issetModOption("srv_multi_sites", "id")) {$this->idSite =intval($this->Cms->Core->GetModOption(I14223, "id")); }}}$this->ll1ILll ="all"; $this->ll1ILlL =true; $this->ll1ILl1 =false; $this->ll1ILLl =0; $this->ItemSimpleFields =array( "public","removable",I14224,"show_in_sitemap","show_siblings", "redirect_id", "fixed_name",I14225, "menu_bottom", "use_noindex", "page_noindex", 'use_hreflang', I14226, I14227, "script_link", "position", "html_title", "html_keywords", I14228, 'html_head_tail', "html_title_inherit", "lay_id", "img_menu_normal",I14229,"img_menu_active", "is_section", 'redirection_code', 'dest_link' );$this->ll1ILLI =array_merge($this->ItemSimpleFields, Array( I14230, "skip_search", "id_site", "block_mask", "tpl_addon", I14231, "lay_f2_body", "lay_f3_body", "lay_f4_body", "lay_f5_body", I14232, "lay_f7_body", "lay_f8_body", "lay_f9_body", "lay_f10_body", I14233, "_sys_right_r", "_sys_right_w", "_sys_right_d")); $this->ll1ILLL =array(); if($this->ll1ILlI){ $this->BitHintsMsgs =$this->ll1ILL1->ParseLangFile("templates/tree/tree.lng"); }if($this->ll1ILIL) {$this->ll1IL1I =$this->Cms->Core->GetAOption(I14234); }$this->ll1IL1l =false; $this->ll1IL1L =2147483647; $this->ll1IL11 =true; }public static function &getInstance(&$IlLLIIl, $ll1I1Il =false) {if(is_null(self::$ll1I1II)) {self::$ll1I1II =new Tree($IlLLIIl, $ll1I1Il); }$instance =clone(self::$ll1I1II); return $instance; }function TI1l1II($IllLI1I){ $this->ll1IL1L =($IllLI1I == 0)? 2147483647: $IllLI1I; return $this->ll1IL1L; }function TI1l1Il($ll1I1IL ="simple", $ll1I1I1=", "){ $res =I14221; switch ($ll1I1IL){ case "all": $aFields =&$this->ll1ILLI; break; default: $aFields =&$this->ItemSimpleFields; break; }$res =implode($ll1I1I1, $aFields); return $res; }function TI1l1I1($llL1LLl=I14221){ $res =$llL1LLl; if(!empty($res)) $res =" $res"; if($this->ll1ILlL) $res =" position asc, id asc, $res"; return $res; }function _applyFilters($llL1LLl=I14221, $mode=I14221){ $res =$llL1LLl; if(!empty($res)) $res ="($res) "; if($this->UseLang) $res .= " and lang='".$this->lang_data.I14235; if($this->ll1Il1L) $res .= " and public=1"; if($this->UseHidden) $res .= " and hidden='0'"; if($this->ll1ILl1) $res .= " and skip_in_prevnext='0'"; if($this->ll1ILII){ switch($this->ll1ILll){ case "main": $res .= I14236; break; case "bottom": $res .= " and menu_bottom=1"; break; case "top": $res .= " and menu_top=1"; break; default: $res .= " and (menu_main=1 or menu_bottom=1 or menu_top=1)"; break; }}if($this->ll1ILIl) $res .= " and show_in_sitemap='1'"; if($this->ll1ILIL) $res .= " and (ip_area IN (".$this->ll1IL1I['allowed'].") OR ip_area < 0)"; if($this->ll1ILI1) {if($this->Cms->Side == I14237) {if($this->idSite >0 || $mode["force_id_site"]) {$res .= " and (id_site='".$this->idSite."')"; }}else {$res .= " and (id_site='".$this->idSite.I14238; }}return $res; }function TI1l1lT($mode =I14221){ $res =$this->_applyFilters(I14221, $mode); return $res; }function getDefaultPageIds(){ $res =false; if($this->ll1ILI1) {$sql ="SELECT default_pages FROM cms_sites WHERE id='".$this->idSite.I14235; $this->db->query($sql); if($this->db->next_record()) {$res =unserialize($this->db->Record['default_pages']); }}if(!is_array($res)){ $res =$this->Cms->Core->GetOption('default_ids'); }return $res; }public function TI1l1lI($cid, &$ll1I1lI){ $res =0; $cid =intval($cid); if($cid >0) {$filter =$this->_ApplyFilters(); $sql ="select id, redirect_id from cms_pages where id='" .$cid .I14239 .$filter; $this->db->query($sql); if($this->db->next_record()){ $res =1; $ll1I1lI =$this->db->Record["redirect_id"]; }}return $res; }function TI1l1ll($cid){ $res =0; $sql ="select parent_id from cms_pages where id='$cid' ".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()){ $res =$this->db->Record["parent_id"]; }return $res; }public function TI1l1l1($IIILl1L, $IlL1ILI =false, $IlL1ILl =false){ $res =array(); if(!empty($IIILl1L)){ $filter =$this->_ApplyFilters(); if($IlL1ILI!==false){ $filter .= " and id<>'" .$IlL1ILI .I14239; }$ll1I1ll =mb_substr($IIILl1L, -1) != '/' ?$IIILl1L .I14240 :mb_substr($IIILl1L, 0, -1); $filter .= " and (BINARY script_link='".$IIILl1L."' or BINARY script_link='".$ll1I1ll.I14241; $sLink ="BINARY script_link='".$IIILl1L."' or BINARY script_link='".$ll1I1ll.I14235; $sql =I14242 .($IlL1ILI || $IlL1ILl ?I14243 :',redirect_id ') .'from cms_pages ' .'where '; if(mb_strpos($IIILl1L, I14240) !== false){ $I1IllII ='0'; TlT1IIl($IIILl1L, $I1IllII, I14244, I14245); $sql .= '('. $sLink .I14243 .$I1IllII .') '; }else{ $sql .= '(' .$sLink .I14246; }$sql .= $filter .' order by length(script_link) desc, id asc'; if(!$IlL1ILl){ $sql .= I14247; }$this->db->query($sql); if($IlL1ILl){ while($this->db->next_record()){ $res[][$this->db->Record['lang']] =$this->db->Record; }}elseif($this->db->next_record()){ $res[$this->db->Record['lang']] =$this->db->Record; }}return $res; }function TI1l11T($cId){ $res =Array(); if($cId>0){ $filter =$this->_ApplyFilters(); $sql ="select id, lang, module_name, script_link, ip_area from cms_pages where (id='$cId') $filter limit 1"; $this->db->query($sql); while($this->db->next_record()){ $res[$this->db->Record["lang"]] =$this->db->Record; }}return $res; }function TI1l11I($ll1I1lL, $ll1I1l1 =0){ $_count =1; if(!isset($ll1I1lL)||!$ll1I1lL) trigger_error("Wrong citemid",E_USER_ERROR); $NONE =false; if(!$this->TI1l1lI($ll1I1lL, $NONE)) return 0; if(!$ll1I1l1){ $sql ="select parent_id, removable from cms_pages where id='$ll1I1lL' "; $this->db->query($sql); if(!$this->db->next_record()){ return 0; }if($this->db->Record[I14248] == "0" || $this->db->Record["removable"] == "0"){ return 0; }}$sql ="select id from cms_pages where parent_id='$ll1I1lL' "; $rs =&$this->db->select($sql); while($row =&$rs->nextRecord()) {$_count += $this->TI1l11I($row["id"], 1); }if (isset($this->deletedModulesNames)) {$sql ="SELECT `module_name` FROM `cms_pages` WHERE id='$ll1I1lL'"; if (mb_strlen($moduleName =$this->db->getValue($sql))) {$this->deletedModulesNames[] =$moduleName; }}$sql ="delete from cms_pages where id='$ll1I1lL'"; $this->db->execute($sql); return $_count; }function TI1l11l($cMask, $I1llII1 =I14249, $ll1I1I1="\r\n"){ $res =I14221; $mask =$cMask; $c =1; $s =I14221; while($c<=$cMask){ $code =($mask &$c );if($code && !empty($this->BitHintsMsgs[$I1llII1.sprintf("%b",$code)])){ $res .= $s .$this->BitHintsMsgs[$I1llII1.sprintf("%b",$code)]; $s =$ll1I1I1; }$c <<= 1; }return $res; }function TI1l111($cid, $ll1I1LI, $ll1I1Ll, $ll1I1LL, $ll1I1L1, $vars){ global $_SIDE; if(!isset($vars['lines'])){ $vars[I14250] =''; }for($i =1; $i<$ll1I1Ll; $i++){ $ll1I11I ="empty"; if($ll1I1LL[$i]=="1") $ll1I11I ="line"; $vars[I14251] =$ll1I11I; $vars["lines"] .= $this->ll1ILL1->get("tree:img_path", $vars); }$lIIl1Il ="select_link"; if($ll1I1Ll){ $vars["alt"] =I14221; $vars[I14251] =$ll1I1L1; $vars[I14252] .= $this->ll1ILL1->get("tree:img_link", $vars); }$vars["img_iconsmask"] =sprintf("%b",$vars["item_mask"] &self::NODE_ICONS_MASK); $vars[I14253] =sprintf("%b",$vars["item_mask"] &self::NODE_FOLDER_MASK); if ($_SIDE == I14237){ $vars["img_alt"] =$this->TI1l11l($vars["item_mask"]); $vars[I14254] ="static"; if (!empty($vars["img_alt"])){ $vars["img_alt"] .= "\r\n"; }$pageType =isset($this->BitHintsMsgs[I14255]) ?$this->BitHintsMsgs[I14255] .I14243 :''; $link =isset($this->BitHintsMsgs['link']) ?$this->BitHintsMsgs['link'] .I14243 :''; $modId =I14256; if ($vars[I14227] != "pages"){ $IlLI11I =$this->Cms->Core->GetModule($vars[I14227]); if (is_object($IlLI11I)){ $vars["img_alt"] .= $pageType .$this->Cms->GetModHeader($IlLI11I); $vars["img_alt"] .= "\r\n"; $vars[I14254] =I14257; $modId =$IlLI11I->Name; }}else if (($vars[I14258] != 0 )){$vars["img_alt"] .= $pageType .$link ."[".$vars[I14258]."]"; $vars["img_alt"] .= I14259; $vars[I14254] ="link"; }else if (isFullLink($vars["script_link"])){ $vars["img_alt"] .= $pageType ." " .$link .I14260.$vars["script_link"]."]"; $vars["img_alt"] .= I14259; $vars[I14254] ="link"; }$vars[I14254] .= ($vars[I14261] &self::NODE_NO_PUBLIC) ?"_d": I14221; $vars["img_alt"] .= (isset($this->BitHintsMsgs["page_id"]) ?$this->BitHintsMsgs["page_id"] .I14262 :I14256) .$cid; if(!empty($modId)){ $vars["img_alt"] .= ' ['.$modId.']'; }}if( empty($vars["itemLink"]) )$lIIl1Il =I14263; $vars[I14252] .= $this->ll1ILL1->get("tree:".$lIIl1Il, $vars); return $vars; }function TI11TTT($cid, $ll1I1LI, $ll1I1Ll, $cname, $ll1I11l, $ll1I1LL, $ll1I1L1, $modName =I14221, $IIILl1L =I14221, $IlLLlI1, $ll1I11L, $ll1I111=self::NODE_CLEAR, $llL1LlI =Array()){ $ll1lIII ="item_normal"; $vars["base"] =I14221; if($ll1I11l){ $sql ="select *, date_format(last_changed, '".$this->ll1Il1l."') as ltime from cms_pages where id='$cid'"; $this->db->query($sql); if($this->db->next_record()){ $this->selectedData =Array(); foreach($this->ll1ILLI as $fname){ $this->selectedData[$fname] =isset($this->db->Record[$fname]) ?$this->db->Record[$fname] :null; }$this->selectedDeepLevel =$ll1I1Ll; $this->selectedLay_body_body= $this->db->Record[I14264]; $this->ll1Ill1 =$this->db->Record["ltime"]; $this->ll1IlLI =$this->db->Record["public"]; $this->selectedRemovable =$this->db->Record["removable"]; $this->ll1IlLl =$this->db->Record[I14224]; $this->selectedFixedName =$this->db->Record["fixed_name"]; }$anchor =I14221; if($this->ll1IlL1) $ll1lIII =I14265; $this->IILIlL1 =$cid; $this->ll1Illl =$cname; $this->ll1IllI =$ll1I1LI; $this->parentId =$ll1I1LI; }$vars["itemLink"] =$this->TI11TIT($IIILl1L); $vars["script_link"] =$IIILl1L; $vars[I14258] =$IlLLlI1; $vars["itemName"] =$cname; $vars["pid"] =$ll1I1LI; $vars[I14266] =$cid; $vars["page_noindex"] =$ll1I11L; $vars[I14261] =$ll1I111; $vars[I14227] =$modName; $vars["_sys_right_r"] =$llL1LlI["_sys_right_r"]; $vars["_sys_right_w"] =$llL1LlI[I14267]; $vars["_sys_right_d"] =$llL1LlI["_sys_right_d"]; if ($this->ll1IL11) {$vars =$this->TI1l111($cid, $ll1I1LI, $ll1I1Ll, $ll1I1LL, $ll1I1L1, $vars); }$vars["level"] =$ll1I1Ll; $vars["item"] =$this->ll1ILL1->get(I14268.$ll1lIII, $vars); $vars["items_out"] =$this->ll1IL1l-1; if( ($vars["items_out"]!==0) && ($vars["items_out"]%$this->ll1IL1L==0) ){$vars["nSplitter"] =$this->ll1ILL1->getDefPostf("tree:item_nSplitter", "_level_".$ll1I1Ll, $vars); }return $this->ll1ILL1->getDefPostf("tree:item", "_level_".$ll1I1Ll, $vars); }function TI11TTI($I1LL11l, &$ll1lIIl, $IIL11IL, $Ill1L1L, $ll1lIIL =I14248) {$filter =($IIL11IL >0)? $Ill1L1L: I14221; $sql =I14269. "FROM cms_pages WHERE $ll1lIIL in ($I1LL11l) $filter"; $rs =&$this->db->select($sql); $ll1lIIl[$IIL11IL] =Array(); $aIds =Array(); while($row =&$rs->nextRecord()) {if(!isset($ll1lIIl[$IIL11IL][$row['parent_id']]) || !is_array($ll1lIIl[$IIL11IL][$row[I14270]])){ $ll1lIIl[$IIL11IL][$row[I14248]] =Array(); }$ll1lIIl[$IIL11IL][$row[I14248]][$row["id"]] =$row; $aIds[] =$row["id"]; }if(sizeof($aIds) >0 && ($this->ll1ILLl==0 || $IIL11IL <$this->ll1ILLl)){ $this->TI11TTI(implode(",", $aIds), $ll1lIIl, $IIL11IL +1, $Ill1L1L); }}function TI11TTl(&$ll1lIIl, $cId, $IlLLlLL, $IIL11IL, $lastItem, $ll1lII1, $ll1lIlI, $ll1lIll){ $aItem =$ll1lIIl[$IIL11IL][$IlLLlLL][$cId]; $isSelected =($aItem["id"] == $ll1lII1)? 1: 0; $IL11lIl =$this->ll1IlLL || in_array($aItem[I14271], $ll1lIlI) ?1 :0; $ll1lIlL =$aItem["id_site"]; $ll1lIl1 =self::NODE_CLEAR; $ll1lIl1 |= ($aItem["public"])?0:self::NODE_NO_PUBLIC; $ll1lIl1 |= ($aItem["is_section"])?self::NODE_SECTION:0; $ll1lIl1 |= ($aItem["block_mask"])?self::NODE_FIXED_BLOCK:0; $ll1lIl1 |= ($aItem[I14272])?self::NODE_PROTECTED:0; $llL1LlI =array( '_sys_right_r' => isset($aItem['_sys_right_r']) && $aItem['_sys_right_r'] == 0 ?0 :1, '_sys_right_w' => isset($aItem[I14273]) && $aItem[I14273] == 0 ?0 :1, '_sys_right_d' => isset($aItem['_sys_right_d']) && $aItem['_sys_right_d'] == 0 ?0 :1, );$hc =isset($ll1lIIl[$IIL11IL +1][$aItem[I14271]]) ?sizeof($ll1lIIl[$IIL11IL +1][$aItem[I14271]]) :0; $ll1lILI ="joinbottom"; if($hc){ $ll1lIl1 |= self::NODE_FOLDER; $ll1lIl1 |= ($IL11lIl)?self::NODE_OPEN:0; if($lastItem){ $ll1lILI =($IL11lIl)?I14274:"plusbottom"; }else{ $ll1lILI =($IL11lIl)?"minus":"plus"; }}else{ if($lastItem) $ll1lILI ="join"; }$ll1lILl =$ll1lIll.(($lastItem)? I14275: "1"); $this->table .= $this->TI11TTT($aItem[I14271], $aItem[I14248], $IIL11IL, $aItem["name"], $isSelected, $ll1lILl, $ll1lILI, $aItem[I14227], $aItem["script_link"], $aItem[I14258], $aItem['page_noindex'], $ll1lIl1, $llL1LlI); $i =1; $this->ll1IL1l =$i; $ll1lILL =$IIL11IL +1; if($IL11lIl && isset($ll1lIIl[$ll1lILL][$cId]) && sizeof($ll1lIIl[$ll1lILL][$cId]) >0 && ($this->ll1ILLl==0 || $IIL11IL <$this->ll1ILLl )&& (!$this->ll1ILI1 || ($this->idSite == $ll1lIlL))) {$vData =array(I14276=>$IIL11IL, "selected"=>$isSelected, "last_item"=>$lastItem, "pid" => $aItem[I14248], I14266 => $aItem[I14271]); $this->table .= $this->ll1ILL1->getDefPostf("tree:level_start", I14277.$IIL11IL, $vData); foreach($ll1lIIl[$ll1lILL][$cId] as $id => $aChild) {$this->ll1IL1l =$i; $this->TI11TTl($ll1lIIl, $id, $cId, $ll1lILL, $i==$hc, $ll1lII1, $ll1lIlI, $ll1lILl); $i++; }$this->table .= $this->ll1ILL1->getDefPostf("tree:level_end", I14277.$IIL11IL, $vData); }}function TTlll11($cid){ $aPath =Array($cid); $ll1I1LI =$cid; while($ll1I1LI){ $sql ="select parent_id from cms_pages where id='$ll1I1LI'"; $this->db->query($sql); if($this->db->next_record()){ $ll1I1LI =$this->db->Record[I14248]; array_unshift($aPath, $ll1I1LI); }else{ $ll1I1LI =0; }}return $aPath; }function TI11TT1($cid, $ll1lII1, $ll1lIL1){ $ll1lIlI =Array(); if(!empty($ll1lII1)) $ll1lIL1 .= ",$ll1lII1"; if(!empty($ll1lIL1)){ $ll1lI1I =mb_split(",",$ll1lIL1); if(is_array($ll1lI1I)) {for($i =0; $i<count($ll1lI1I); $i++){ if(mb_strlen($ll1lI1I[$i])>0) $ll1lIlI =array_merge($ll1lIlI, $this->TTlll11($ll1lI1I[$i])); }}}$idField =I14271; $filter =$this->_ApplyFilters(); if($this->ll1Il11) $filter .= " and show_me_at_parent=1"; $filter .= " order by ".$this->TI1l1I1(I14278); $ll1lIIl =Array(); $this->TI11TTI($cid, $ll1lIIl, 0, $filter, I14271); $parentId =key($ll1lIIl[0]); $this->TI11TTl($ll1lIIl, $cid, $parentId, 0, 0, $ll1lII1, $ll1lIlI, I14221); $this->table =$this->ll1ILL1->getAbs("tree", "map", $this->table); return true; }function TI11TIT($IIILl1L=I14221){ $res =$IIILl1L; if(!isFullLink($res)){ if($this->ll1IlIl) $res =$this->lang_data."/".$res; if($this->ll1IlIL) $res =$this->ll1IlI1.$res; }return $res; }function TI11TII($ll1lI1l, $ll1lI1L =0, $ll1lI11 =true, $ll1llII =false){ $res =array(); $filter =$this->_ApplyFilters(); if($ll1lI11 && $this->ll1Il11) $filter .= " and show_me_at_parent=1"; $ll1llIl =($ll1llII? I14279: I14221).$this->TI1l1I1(I14278); if($ll1lI1L){ $sql ="select id, lang, parent_id, name, ".$this->TI1l1Il().I14262. "from cms_pages where parent_id in ($ll1lI1l) $filter order by $ll1llIl"; }else{ $sql ="select id, name from cms_pages where parent_id in ($ll1lI1l) $filter order by $ll1llIl"; }$this->db->query($sql); while($this->db->next_record()){ if($ll1lI1L){ $res[$this->db->Record[I14271]] =$this->db->Record; }else{ $res[$this->db->Record[I14271]] =$this->db->Record[I14278]; }}return $res; }function TI11TIl($ll1lI1L =0){ $res =array(); $filter =$this->_ApplyFilters(); if($this->ll1Il11) $filter .= " and show_me_at_parent=1"; $ll1llIl =$this->TI1l1I1(I14278); if($ll1lI1L){ $sql ="select id, lang, parent_id, name, ".$this->TI1l1Il().I14262. "from cms_pages where 1 $filter order by $ll1llIl"; }else{ $sql ="select id, name from cms_pages where 1 $filter order by $ll1llIl"; }$this->db->query($sql); while($this->db->next_record()){ if($ll1lI1L){ $res[$this->db->Record[I14271]] =$this->db->Record; }else{ $res[$this->db->Record[I14271]] =$this->db->Record[I14278]; }}return $res; }function TI11TI1($cid, $ll1lI1L =0, $IlLL1Il =0){ if(!isset($cid)) trigger_error("Wrong cid...",E_USER_ERROR); $path =array(); $ll1I1LI =$cid; while($ll1I1LI && $ll1I1LI!=$IlLL1Il){ if($ll1lI1L){ $sql ="select id, id_site, lang, parent_id, name, ".$this->TI1l1Il().I14262. "from cms_pages where id='$ll1I1LI'"; }else{ $sql ="select id, id_site, parent_id, name from cms_pages where id='$ll1I1LI'"; }$this->db->query($sql); if($this->db->next_record()){ $ll1I1LI =$this->db->Record[I14248]; if(($this->idSite >0 && $this->idSite == $this->db->Record["id_site"])|| $this->idSite == 0) {if($ll1lI1L){ $path[$this->db->Record[I14271]] =$this->db->Record; }else{ $path[$this->db->Record[I14271]] =$this->db->Record[I14278]; }}}else{ $ll1I1LI =0; }}return $path; }function getParent($cid, $ll1lI1L=0){ $res =Array(); $ll1llIL =I14221; if($ll1lI1L){ $ll1llIL =", ".$this->TI1l1Il(); }$sql ="select parent_id from cms_pages where id='$cid' ".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()){ $pid =$this->db->Record[I14248]; $sql ="select id, name $ll1llIL from cms_pages where id='$pid' ".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()){ if($ll1lI1L){ $res =$this->db->Record; }else{ $res[I14271] =$this->db->Record[I14271]; $res[I14278] =$this->db->Record[I14278]; }}}return $res; }function TI11TlT($cid){ $res =Array(); $pid =$cid; while($pid){ $sql ="select id, name, parent_id from cms_pages where id='$pid'"; $this->db->query($sql); if($this->db->next_record()){ $pid =$this->db->Record[I14248]; $res[I14271] =$this->db->Record[I14271]; $res[I14278] =$this->db->Record[I14278]; }else{ $pid =0; }}return $res; }function TI11TlI($cid, $ll1lI1L=0){ $res =Array(); $ll1llIL =I14221; if($ll1lI1L){ $ll1llIL =", ".$this->TI1l1Il(); }$sql ="select id, name $ll1llIL from cms_pages where id='$cid' ".$this->_ApplyFilters(); $this->db->query($sql); if($this->db->next_record()){ if($ll1lI1L){ $res =$this->db->Record; }else{ $res[I14271] =$this->db->Record[I14271]; $res[I14278] =$this->db->Record[I14278]; }}return $res; }function TI11Tll($cId, $ll1llI1 =I14221, $Ill1L1L =I14221){ $this->ll1ILLL["defined"] =true; $this->ll1ILLL[I14280] =$cId; $this->ll1ILLL["fields"] =$ll1llI1; if(!empty($this->ll1ILLL["fields"])) $this->ll1ILLL["fields"] =", ".$this->ll1ILLL[I14281]; $this->ll1ILLL["filter"] =$Ill1L1L; $this->ll1ILLL["counter"] =0; $this->ll1ILLL["nodes"] =array(); return true; }function TI11Tl1(&$vData){ $res =false; if(empty($this->ll1ILLL["defined"])){ trigger_error("Walk error, WalkStart was not called... itemid=[$cId]...", E_USER_ERROR); }$fields =$this->ll1ILLL[I14281]; $filter =$this->ll1ILLL[I14282]; $cId =intval($this->ll1ILLL[I14280]); if($cId>0){ $sql ="select id $fields from cms_pages where id='$cId' $filter "; $this->db->query($sql); if($this->db->next_record()){ array_push($this->ll1ILLL["nodes"], $this->db->Record); }$this->ll1ILLL[I14280] =0; }$vData =array_pop($this->ll1ILLL["nodes"]); if($vData!==false && intval($vData[I14271])>0){ $cId =$vData[I14271]; $this->ll1ILLL["counter"]++; $sql ="select id $fields from cms_pages where parent_id='$cId' $filter "; $this->db->query($sql); while($this->db->next_record()){ array_push($this->ll1ILLL["nodes"], $this->db->Record); }$res =true; }if(!$res){ $this->ll1ILLL[I14283] =false; }if($this->ll1ILLL["counter"]>200) die; return $res; }function TI11T1T($cid){ $hc =$this->TI11TII($cid, 1); if(count($hc)>0){ return current($hc); }while($cid){ $ll1I1LI =$this->TI1l1ll($cid); $hc =$this->TI11TII($ll1I1LI, 1); $ll1lllI =0; $ll1llll =0; if(count($hc)>0){ foreach($hc as $vData){ if($vData[I14271] == $cid){ $ll1lllI =1; continue; }if($ll1lllI){ $ll1llll =$vData; break; }}if($ll1llll!==0) return $ll1llll; }$cid =$ll1I1LI; }return false; }function TI11T1I($cid){ $ll1lllL =$cid; $pid =0; while($cid){ $ll1I1LI =$this->TI1l1ll($cid); $hc =$this->TI11TII($ll1I1LI, 1); $ll1lll1 =0; if(count($hc)>0){ foreach($hc as $vData){ $id =$vData[I14271]; if($id == $cid){ break; }$ll1lll1 =$id; }if($ll1lll1){ $pid =$ll1lll1; break; }else{ $pid =$ll1I1LI; break; }}else{ $pid =$ll1I1LI; break; }$cid =$ll1I1LI; }$ll1llLI =$this->TI11TlI($pid, 1); if($pid){ do{ $hc =$this->TI11TII($pid, 1); if(!count($hc)){ return $ll1llLI; }$cid =$pid; foreach($hc as $vData){ $pid =$vData[I14271]; if($pid == $ll1lllL){ return $ll1llLI; }$ll1llLI =$vData; }}while(true); }return false; }function TI11T1l(&$Core){ $ll1llLl =$this->ll1Il1L; $this->ll1Il1L =false; $filter =$this->TI1l1lT('force_id_site'); $sql =I14284 ."FROM `cms_pages` " .I14285 .$filter ." ORDER BY `id` ASC"; $aVirtualLinks =$Core->GetModProperty(I14286, 'virtual_links'); $ll1llLL =array(); $ll1llL1 =array(); $rs =$this->db->select($sql); while($vRec =$rs->nextRecord()){ $vMod =&$Core->GetModule($vRec[I14287]); if(is_object($vMod)){ if(isset($aVirtualLinks[$vRec[I14287]])) {$ll1llLL[$vRec[I14287]] =$vRec['id']; $ll1llL1[$vRec[I14287]] =$vRec[I14244]; }$vMod->Ill1llI =true; $vMod->Ill1lll =$vRec['public']; if($vMod->TTlIT1l()){ $vMod->SetOption('first_page_id', $vRec[I14288]); }$vMod->SetFrontLink($this->TI11TIT($vRec[I14244]), $vRec[I14288], $vRec['name'], $vRec['id_site']); }}$aUsedVirtualModules =$Core->GetModOption(I14286, I14289); $ll1ll1I =Array(); foreach($ll1llLL as $ll1ll1l => $IlL1II1){ $aVirtualModules =array_keys($aVirtualLinks[$ll1ll1l]); $aVirtualModules =array_intersect($aVirtualModules, $aUsedVirtualModules); foreach($aVirtualModules as $modName){ if($Core->IsFrontAllowed($modName)){ $vMod =&$Core->GetModule($modName); if(!$vMod->Ill1llI){ $ll1ll1I[] =$modName; $scriptLink =$ll1llL1[$ll1ll1l] .I14240 .$aVirtualLinks[$ll1ll1l][$modName]; $vMod->Ill1llI =true; $vMod->Ill1lll =1; $vMod->ILlIL1l =true; if($vMod->TTlIT1l()){ $vMod->SetOption('first_page_id', $IlL1II1); }$vMod->SetFrontLink($this->TI11TIT($scriptLink), $IlL1II1, I14256, 0); }}}}if(sizeof($ll1ll1I) >0){ $sql =I14290 .I14291 .implode("','", $ll1ll1I) ."') AND `public` = 0 " .$filter ." ORDER BY `id` ASC"; $this->db->query($sql); while($this->db->next_record()){ $vMod =&$Core->GetModule($this->db->Record[I14287]); $vMod->Ill1llI =false; $vMod->Ill1lll =0; }}$IILllLl =$Core->GetAllModules(); foreach(array_keys($IILllLl) as $vModName){ if(!$IILllLl[$vModName]->Ill1llI){ $IILllLl[$vModName]->SetOption('first_page_id', -1); $ll1ll1L =$IILllLl[$vModName]->GetParentName(); if(!empty($ll1ll1L) && is_object($IILllLl[$ll1ll1L]) && $IILllLl[$ll1ll1L]->Ill1llI && $IILllLl[$vModName]->TTlIT1l()){ $IILllLl[$vModName]->SetFrontLink($IILllLl[$ll1ll1L]->GetFrontLink()); }else{ $IILllLl[$vModName]->SetFrontLink('404'); }}}$this->ll1Il1L =$ll1llLl; }public static function TI11T11(&$aData){ $res ="show_me_at_parent='" .intval(!empty($aData[I14292])) ."', " ."show_in_sitemap='" .intval(!empty($aData['show_in_sitemap'])) ."', " .I14293 .intval(!empty($aData['show_siblings'])) ."', " ."is_printable='" .intval(!empty($aData['is_printable'])) .I14294 ."skip_search='" .intval(!empty($aData['skip_search'])) .I14294 ."html_title='" .addslashes($aData['html_title']) .I14294 ."html_title_inherit='" .intval(!empty($aData['html_title_inherit'])) .I14294 ."html_keywords='" .addslashes($aData['html_keywords']) .I14294 ."html_description='" .addslashes($aData[I14295]) .I14294 ."html_head_tail='" .self::TI11ITT(unhtmlentities($aData['html_head_tail'])) .I14294 ."is_section='" .intval(!empty($aData['is_section'])) .I14294 .I14296 .intval(!empty($aData['menu_main'])) .I14294 ."menu_bottom='" .intval(!empty($aData['menu_bottom'])) .I14294 ."menu_top='" .intval(!empty($aData[I14297])) .I14294 ."img_menu_normal='" .$aData['img_menu_normal'] .I14294 ."img_menu_over='" .$aData['img_menu_over'] .I14294 .I14298 .$aData['img_menu_active'] .I14294; if(!empty($aData['visible_area'])){ $res .="visible_area='" .$aData['visible_area'] .I14294; }return $res; }public static function TI11ITT($string){ if($GLOBALS[I14299]){ $string =str_replace( array('\'', '"'), array('\\\'', '\\"'), $string );}return $string; }public static function TI11ITI($password) {global $db; if(defined(I14300) && isScanty) {$ll1ll11 =(func_num_args() == 2)? func_get_arg(1): null; $ll1lLII =($password == I14301 && is_object($ll1ll11) && mb_strtolower(get_class($ll1ll11)) == 'db_si'); $text =I14256; $ll1lLIl =I14256; $where =I14302.filectime($GLOBALS['CLASSES_PATH'].'CMS_Base.php').")"; $sql ="SELECT value FROM cms_options".$where; $db->query($sql,DBC_SYS_QUERY); if($db->next_record()){ $aHash =@unserialize($db->Record['value']); if(is_array($aHash)) {$ll1lLIl =$aHash['h1']; }unset($aHash); }$sql =I14303; $db->query($sql,DBC_SYS_QUERY); while($db->next_record()){ $text .= ($ll1lLII? implode('am230', $db->Record): implode($password.';', $db->Record)); }$ll1lLIL =md5($text.$ll1lLIl); $sql ="UPDATE cms_options SET value='".addslashes(serialize(array('h1' => $ll1lLIl, 'h2' => $ll1lLIL))).I14235.$where; $db->execute($sql); $GLOBALS['ILllll1'] =false; }}}