<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       10171 xkqwguwiixqztyimxmrppzmnmpkxpmqgmymsyulsuygxnqkgmxzrynrtutqpikyqgisgpnir
 */ ?><?php foreach(array(14650=>"QrrHr",14651=>"HrSQr?MD?IMDDQS",14652=>"YuttHn",14653=>"rQturn",14654=>"YZJZnWQ",14655=>"SMDZYJQS",14656=>"urJ",14657=>"MtQI|nuIYQr",14658=>"coqRq?QH`MS?=?'",14659=>'DOMGGMnP',14660=>'wjzddqd|gzTo') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} if(!class_exists("BILL_driver_account", false)){ class BILL_driver_account extends BILL_driver_base {public $dbTablePrefix; public function __construct($ll11ILl){ parent::__construct($ll11ILl); $this->currencies =$this->TlTTlIl("#USD RUR EUR GBR"); $this->initialCurrencies =$this->currencies; $this->dbTablePrefix =$dbTablePrefix; }function getPayButton(array &$vRes, array $cData, $ll11ILL =false){ $res =true; $data =$cData; $vRes[I14650] ="Success"; $vRes["errno"] =0; if(empty($data["order"])){ $vRes["errno"] =1; $vRes[I14650] =I14651; $res =false; }else if(empty($data["process_url"])){ $vRes["errno"] =2; $vRes[I14650] ="process_url is missed"; $res =false; }else if(empty($data["button_name"]) && empty($data[I14652])){ $vRes["errno"] =3; $vRes[I14650] ="button_name is missed"; $res =false; }$ll11IL1 =$data; if(isset($ll11IL1["order"])) unset($ll11IL1["order"]); if(isset($ll11IL1[I14653])) unset($ll11IL1[I14653]); if(isset($ll11IL1["button_name"])) unset($ll11IL1["button_name"]); if(isset($ll11IL1[I14652])) unset($ll11IL1[I14652]); foreach($ll11IL1 as $key => $value) $data["hiddens"] .= "<input type=\"hidden\" name=\"$key\" value=\"$value\">\r\n"; $db =new DB_si; $sql ="SELECT m.balance FROM (cms_es_orders eo ". "LEFT JOIN cms_es_users eu ON eo.id_member = eu.id_member) ". "LEFT JOIN cms_members m ON eu.id_member = m.id ". "WHERE eo.id = '".$data["order"]."'"; $db->query($sql); $db->next_record(); $balance =doubleval($db->Record[I14654]); if($balance <$data["amount"]) {$data["disabled"] ="disabled"; }$data[I14652] =trim($data[I14652]); if(!empty($data[I14652])) {$data["_button_html"] =1; if($data[I14655] == I14655) {$data[I14652] =preg_replace("/<input/", "<input disabled", $data[I14652]); }}if(!$res) {$data[I14655] =I14655; }return parent::getPayButton($vRes, $data, $ll11ILL); }function getPayButtonParams(array $cData, array &$vRes){ $data =$cData; $vRes[I14650] ="Success"; $vRes["errno"] =0; if(empty($data[I14656])){ $vRes["errno"] =1; $vRes[I14650] ="url is missed"; return false; }else if(empty($data["order"])){ $vRes["errno"] =2; $vRes[I14650] =I14651; return false; }$ll11IL1 =$data; if(isset($ll11IL1[I14657])) unset($ll11IL1[I14657]); if(isset($ll11IL1[I14656])) unset($ll11IL1[I14656]); foreach($ll11IL1 as $key => $value) $data["hiddens"] .= "<input type=\"hidden\" name=\"$key\" value=\"$value\">\r\n"; return parent::getPayButtonParams($data, $vRes); }function payProcess(array $cGet, array $cPost, array &$vRes, array $ll11I1I, array $aOrderData){ $res =false; $orderId =intval($cPost[I14657]); $db =new DB_si; $sql ="SELECT m.balance, eo.total, eo.tax, eo.shipping, eu.id_member, eo.ext_data FROM (cms_es_orders eo ". "LEFT JOIN cms_es_users eu ON eo.id_member = eu.id_member) ". "LEFT JOIN cms_members m ON eu.id_member = m.id ". I14658.$orderId."'"; $db->query($sql); $db->next_record(); $balance =doubleval($db->Record[I14654]); $total =doubleval($db->Record["total"] +$db->Record["tax"]); if(!empty($cPost['add_shipping'])){ $total += $db->Record[I14659]; }$extData =unserialize($db->Record["ext_data"]); $idMember =$db->Record["id_member"]; if($balance >= $total) {require_once $GLOBALS['CLASSES_PATH'] .'CMS_Member.php'; require_once $GLOBALS[I14660] .'EshopUser.php'; EshopUser::updateBalance($db, $idMember, $balance -$total, $extData["base_currency"]["code"], true, "user"); $res =true; }return $res; }}}