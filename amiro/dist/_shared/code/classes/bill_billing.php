<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       40602 xkqwplsipslzkksmqqnsnznmyngzptuklrqlmykpkmwyqsprwgzwtrgznyzpmwtzlnpxpnir
 */ ?><?php foreach(array(14682=>"QrrHr",14683=>"HrSQr?MD?IMDDQS",14684=>"QrrnH",14685=>"urJ",14686=>"IQrWOZnt|MS",14687=>"WurrQnWB",14688=>"GrHWQDD|urJ",14689=>"GZBQr|QIZMJ",14690=>"JZDtnZIQ",14691=>"WuDtHI3",14692=>"|YuttHn|OtIJ",14693=>"HrSQr",14694=>"SQDWrMGtMHn",14695=>"YuttHn|nZIQ",14696=>"QIZMJ",14697=>"WuDtHI1",14698=>'DtZtuD',14699=>"GZBIQnt|fQQ",14700=>"%",14701=>"DtrWIG}ZJMZD!?'",14702=>"'",14703=>"ZffMJMZtQ|WHuntQr",14704=>"ZIHunt",14705=>"rQturn",14706=>"MtQI|nZIQ",14707=>"",14708=>"p",14709=>"k",14710=>"YMJJ|uDQr",14711=>"ymjj|SMDWHunt",14712=>"rI",14713=>"fuJJ|GZtO",14714=>"fMJQ|QxMDtD",14715=>"'{=0",14716=>"COQrQ?ms=",14717=>"MtQI|nuIYQr",14718=>"trMZJ|ZIHunt",14719=>"trMZJ|GQrMHS",14720=>"trMZJ|GQrMHS|unMtD",14721=>"rQWurrMnP|tMIQD",14722=>"MD|rQWurrMnP",14723=>"DtZrt|SZtQ",14724=>"GZMS",14725=>"ms",14726=>"WZnWQJ",14727=>"DtZtuD") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} if(!class_exists("BILL_driver_billing", false)){ class BILL_driver_billing extends BILL_driver_base {public function __construct($ll11ILl){ parent::__construct($ll11ILl); $this->currencies =$this->TlTTlIl("#USD"); $this->initialCurrencies =$this->currencies; }function getPayButton(array &$vRes, array $cData, $ll11ILL =false){ $res =true; $data =(is_array($cData))? $cData: Array(); $vRes[I14682] ="Success"; $vRes["errno"] =0; if(empty($data["order"])){ $vRes["errno"] =2; $vRes[I14682] =I14683; $res =false; }else if(empty($data["amount"])){ $vRes["errno"] =6; $vRes[I14682] ="amount is missed"; $res =false; }else if(empty($data["merchant_id"])){ $vRes[I14684] =7; $vRes[I14682] ="merchant_id is missed"; $res =false; }else if(empty($data["button_name"]) && empty($data["button"])){ $vRes[I14684] =8; $vRes[I14682] ="button_name is missed"; $res =false; }$ll11IL1 =$data; if(isset($ll11IL1[I14685])) unset($ll11IL1[I14685]); if(isset($ll11IL1["order"])) unset($ll11IL1["order"]); if(isset($ll11IL1["description"])) unset($ll11IL1["description"]); if(isset($ll11IL1[I14686])) unset($ll11IL1[I14686]); if(isset($ll11IL1["type"])) unset($ll11IL1["type"]); if(isset($ll11IL1["amount"])) unset($ll11IL1["amount"]); if(isset($ll11IL1[I14687])) unset($ll11IL1[I14687]); if(isset($ll11IL1["button_name"])) unset($ll11IL1["button_name"]); if(isset($ll11IL1["button"])) unset($ll11IL1["button"]); if(isset($ll11IL1[I14688])) unset($ll11IL1[I14688]); if(isset($ll11IL1["cancel"])) unset($ll11IL1["cancel"]); if(isset($ll11IL1["return"])) unset($ll11IL1["return"]); if(isset($ll11IL1[I14689])) unset($ll11IL1["email"]); if(isset($ll11IL1["first_name"])) unset($ll11IL1["firstname"]); if(isset($ll11IL1["last_name"])) unset($ll11IL1[I14690]); if(isset($ll11IL1["custom1"])) unset($ll11IL1["custom1"]); if(isset($ll11IL1["custom2"])) unset($ll11IL1["custom2"]); if(isset($ll11IL1[I14691])) unset($ll11IL1[I14691]); foreach($ll11IL1 as $key => $value) $data["hiddens"] .= "<input type=\"hidden\" name=\"$key\" value=\"$value\">\r\n"; $data["button"] =trim($data["button"]); if(!empty($data["button"])) {$data[I14692] =1; }if(!$res) {$data["disabled"] ="disabled"; }return parent::getPayButton($vRes, $data, $ll11ILL); }function getPayButtonParams(array $cData, array &$vRes){ $data =(is_array($cData))? $cData: Array(); $vRes[I14682] ="Success"; $vRes[I14684] =0; if(empty($data[I14685])){ $vRes[I14684] =1; $vRes[I14682] ="url is missed"; return false; }else if(empty($data[I14693])){ $vRes[I14684] =2; $vRes[I14682] =I14683; return false; }else if(empty($data["amount"])){ $vRes[I14684] =6; $vRes[I14682] ="amount is missed"; return false; }else if(empty($data[I14686])){ $vRes[I14684] =7; $vRes[I14682] ="merchant_id is missed"; return false; }$ll11IL1 =$data; if(isset($ll11IL1[I14685])) unset($ll11IL1[I14685]); if(isset($ll11IL1[I14693])) unset($ll11IL1[I14693]); if(isset($ll11IL1["description"])) unset($ll11IL1[I14694]); if(isset($ll11IL1[I14686])) unset($ll11IL1[I14686]); if(isset($ll11IL1["type"])) unset($ll11IL1["type"]); if(isset($ll11IL1["amount"])) unset($ll11IL1["amount"]); if(isset($ll11IL1[I14687])) unset($ll11IL1[I14687]); if(isset($ll11IL1[I14695])) unset($ll11IL1[I14695]); if(isset($ll11IL1[I14688])) unset($ll11IL1[I14688]); if(isset($ll11IL1["cancel"])) unset($ll11IL1["cancel"]); if(isset($ll11IL1["return"])) unset($ll11IL1["return"]); if(isset($ll11IL1[I14689])) unset($ll11IL1[I14696]); if(isset($ll11IL1["first_name"])) unset($ll11IL1["firstname"]); if(isset($ll11IL1["last_name"])) unset($ll11IL1[I14690]); if(isset($ll11IL1["custom1"])) unset($ll11IL1[I14697]); if(isset($ll11IL1["custom2"])) unset($ll11IL1["custom2"]); if(isset($ll11IL1[I14691])) unset($ll11IL1[I14691]); foreach($ll11IL1 as $key => $value) $data["hiddens"] .= "<input type=\"hidden\" name=\"$key\" value=\"$value\">\r\n"; return parent::getPayButtonParams($data, $vRes); }function payProcess(array $cGet, array $cPost, array &$vRes, array $ll11I1I, array $aOrderData){ $status ='fail'; if(!empty($cGet[I14698])) $status =$cGet[I14698]; if(!empty($cPost[I14698])) $status =$cPost[I14698]; return ($status == 'ok'); }function payCallback(array $cGet, array $cPost, array &$vRes, array $additionalParams, array $aOrderData){ return ($cPost["md5hash"] == md5($cPost["payment_gross"].":".$cPost[I14699].":".$cPost["payment_status"].":".$cPost["txn_id"].I14700.$cPost["subscr_id"].I14700.$additionalParams["pass_phrase"])); }function TlTTlTT(&$vRes, &$I1lLIlI, &$vData, $cID, $ll11llL ="", $ll11ll1 ="KAG"){ $DEFAULT_BUSINESS_EMAIL =$this->ll11LIl->parameters["DEFAULT_BUSINESS_EMAIL"]; $DEFAULT_RETURN_ADDRESS =$this->ll11LIl->parameters["DEFAULT_RETURN_ADDRESS"]; $DEFAULT_CANCEL_ADDRESS =$this->ll11LIl->parameters["DEFAULT_CANCEL_ADDRESS"]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14682] ="Success"; $vRes[I14684] =0; if($cID == ""){ $vRes[I14682] ="Item ID cannot be null"; $vRes[I14684] =1; return false; }$ll11lLl =false; for($i =0;$i <3;$i++){ if($ll11ll1[$i] == "G") $addon ="strcmp(alias, 'service_GENERIC_".$cID."')=0"; else if($ll11ll1[$i] == "A") $addon =I14701.$cID."')=0"; else if($ll11ll1[$i] == "K") $addon ="strcmp(item_number, '".$cID."')=0"; else continue; $sql ="select * from bill_product where type='service' and ".$addon." and status='active'"; $result =mysql_query($sql, $ll11lLI); if(mysql_num_rows($result) >0){ $ll11lLl =true; break; }}if(!$ll11lLl){ $vRes[I14682] ="The item with such ID cannot be found or it is inactive"; $vRes[I14684] =2; return false; }$data =mysql_fetch_array($result); if($ll11llL != ""){ $ll11lLL ="select ID, affiliate_counter from bill_user where ROLE='f' AND affiliate_id='".$ll11llL.I14702; $ll11lL1 =mysql_query($ll11lLL, $ll11lLI); if($ll11l1I =mysql_fetch_array($ll11lL1)) if($ll11l1I["ID"] >0){ $vData["custom"] =$ll11l1I["ID"]; mysql_query($this->ll11LIl->GenUpdateSql("bill_user", Array(I14703 => $ll11l1I[I14703]+1), "where ID=".$ll11l1I["ID"]), $ll11lLI); }}if(@class_exists("BILL_independent_discount")){ $ll11l1l =new BILL_independent_discount($ll11lLI, $this->ll11LIl); if($ll11l1l->TT11ITI($ll11l1L, $data["item_number"])){ $data[I14704] =$ll11l1L[I14704]; }}else if(@class_exists("BILL_discount")){ $ll11l1l =new BILL_discount($ll11lLI); if($ll11l1l->TT11ITI($ll11l1L, $data["item_number"])){ $data[I14704] =$ll11l1L[I14704]; }}$vData["business_email"] =$DEFAULT_BUSINESS_EMAIL; $vData["return"] =$data[I14705]; $vData["cancel"] =$data["cancel"]; $vData["rm"] =$data["rm"]; $vData[I14706] =$data[I14706]; $vData["item_number"] =$data["item_number"]; $vData[I14695] =$data[I14695]; $vData[I14704] =$this->ll11LIl->FormatNumber($data[I14704], true); if($vData[I14705] == "") $vData[I14705] =$DEFAULT_RETURN_ADDRESS; if($vData["cancel"] == I14707) $vData["cancel"] =$DEFAULT_CANCEL_ADDRESS; $data =$vData; foreach($vData as $key => $value) $vData[$key] =stripslashes($vData[$key]); foreach($data as $key => $value) $data[$key] =$this->ll11LIl->TlTITll($data[$key]); $I1lLIlI =$this->gui->get("billing_service_form", $data); return true; }function TlTTlTI(&$vRes, &$I1lLIlI, &$vData, $cID, $ll11llL =I14707, $ll11ll1 ="KAG"){ $PRODUCT_FILE_ROOT =$this->ll11LIl->parameters["PRODUCT_FILE_ROOT"]; $DEFAULT_BUSINESS_EMAIL =$this->ll11LIl->parameters["DEFAULT_BUSINESS_EMAIL"]; $DEFAULT_RETURN_ADDRESS =$this->ll11LIl->parameters["DEFAULT_RETURN_ADDRESS"]; $DEFAULT_CANCEL_ADDRESS =$this->ll11LIl->parameters["DEFAULT_CANCEL_ADDRESS"]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14682] ="Success"; $vRes[I14684] =0; if($cID == I14707){ $vRes[I14682] ="Item ID cannot be null"; $vRes[I14684] =1; return false; }$ll11lLl =false; for($i =0;$i <3;$i++){ if($ll11ll1[$i] == I14708) $addon ="strcmp(alias, 'product_GENERIC_".$cID."')=0"; else if($ll11ll1[$i] == "A") $addon =I14701.$cID."')=0"; else if($ll11ll1[$i] == I14709) $addon ="strcmp(item_number, '".$cID."')=0"; else continue; $sql ="select * from bill_product where type='product' and ".$addon." and status='active'"; $result =mysql_query($sql, $ll11lLI); if(mysql_num_rows($result) >0){ $ll11lLl =true; break; }}if(!$ll11lLl){ $vRes[I14682] ="The item with such ID cannot be found or it is inactive"; $vRes[I14684] =2; return false; }$data =mysql_fetch_array($result); if($ll11llL != I14707){ $ll11lLL ="select ID, affiliate_counter from bill_user where ROLE='f' AND affiliate_id='".$ll11llL.I14702; $ll11lL1 =mysql_query($ll11lLL, $ll11lLI); if($ll11l1I =mysql_fetch_array($ll11lL1)) if($ll11l1I["ID"] >0){ $vData["custom"] =$ll11l1I["ID"]; mysql_query($this->ll11LIl->GenUpdateSql(I14710, Array(I14703 => $ll11l1I[I14703]+1), "where ID=".$ll11l1I["ID"]), $ll11lLI); }}if(@class_exists("BILL_independent_discount")){ $ll11l1l =new BILL_independent_discount($ll11lLI, $this->ll11LIl); if($ll11l1l->TT11ITI($ll11l1L, $data["item_number"])){ $data[I14704] =$ll11l1L[I14704]; }}else if(@class_exists(I14711)){ $ll11l1l =new BILL_discount($ll11lLI); if($ll11l1l->TT11ITI($ll11l1L, $data["item_number"])){ $data[I14704] =$ll11l1L[I14704]; }}$vData["business_email"] =$DEFAULT_BUSINESS_EMAIL; $vData[I14705] =$data[I14705]; $vData["cancel"] =$data["cancel"]; $vData[I14712] =$data[I14712]; $vData[I14706] =$data[I14706]; $vData["item_number"] =$data["item_number"]; $vData[I14695] =$data[I14695]; $vData[I14704] =$this->ll11LIl->FormatNumber($data[I14704], true); $vData["path"] =$data["path"]; $vData[I14713] =addslashes($PRODUCT_FILE_ROOT).$data["path"]; if($vData[I14705] == I14707) $vData[I14705] =$DEFAULT_RETURN_ADDRESS; if($vData["cancel"] == I14707) $vData["cancel"] =$DEFAULT_CANCEL_ADDRESS; $filePath =stripslashes($vData[I14713]); $vRes["file_exists"] =true; if(!@is_file($filePath)){ $vRes[I14714] =false; $vRes[I14682] ="The file doesn't exist"; $vRes[I14684] =3; }$data =$vData; foreach($vData as $key => $value) $vData[$key] =stripslashes($vData[$key]); foreach($data as $key => $value) $data[$key] =$this->ll11LIl->TlTITll($data[$key]); $I1lLIlI =$this->gui->get("billing_product_form", $data); return true; }function TlTTlTl(&$vRes, &$I1lLIlI, &$vData, $cID, $ll11llL =I14707, $ll11ll1 ="KAG"){ $DEFAULT_BUSINESS_EMAIL =$this->ll11LIl->parameters["DEFAULT_BUSINESS_EMAIL"]; $DEFAULT_RETURN_ADDRESS =$this->ll11LIl->parameters["DEFAULT_RETURN_ADDRESS"]; $DEFAULT_CANCEL_ADDRESS =$this->ll11LIl->parameters["DEFAULT_CANCEL_ADDRESS"]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14682] ="Success"; $vRes[I14684] =0; if($cID == I14707){ $vRes[I14682] ="Item ID cannot be null"; $vRes[I14684] =1; return false; }$ll11lLl =false; for($i =0;$i <3;$i++){ if($ll11ll1[$i] == I14708) $addon ="strcmp(alias, 'subscription_GENERIC_".$cID.I14715; else if($ll11ll1[$i] == "A") $addon =I14701.$cID.I14715; else if($ll11ll1[$i] == I14709) $addon ="strcmp(item_number, '".$cID.I14715; else continue; $sql ="select * from bill_product where type='subscription' and ".$addon." and status='active'"; $result =mysql_query($sql, $ll11lLI); if(mysql_num_rows($result) >0){ $ll11lLl =true; break; }}if(!$ll11lLl){ $vRes[I14682] ="The item with such ID cannot be found or it is inactive"; $vRes[I14684] =2; return false; }$data =mysql_fetch_array($result); if($ll11llL != I14707){ $ll11lLL ="select ID, affiliate_counter from bill_user where ROLE='f' AND affiliate_id='".$ll11llL.I14702; $ll11lL1 =mysql_query($ll11lLL, $ll11lLI); if($ll11l1I =mysql_fetch_array($ll11lL1)) if($ll11l1I["ID"] >0){ $vData["custom"] =$ll11l1I["ID"]; mysql_query($this->ll11LIl->GenUpdateSql(I14710, Array(I14703 => $ll11l1I[I14703]+1), I14716.$ll11l1I["ID"]), $ll11lLI); }}$vData["business_email"] =$DEFAULT_BUSINESS_EMAIL; $vData[I14705] =$data[I14705]; $vData["cancel"] =$data["cancel"]; $vData[I14712] =$data[I14712]; $vData[I14706] =$data[I14706]; $vData[I14717] =$data[I14717]; $vData[I14695] =$data[I14695]; $vData[I14718] =$this->ll11LIl->FormatNumber($data[I14718], true); $vData[I14719] =$data[I14719]; $vData[I14720] =$data[I14720]; $vData["regular_amount"] =$this->ll11LIl->FormatNumber($data["regular_amount"], true); $vData["regular_period"] =$data["regular_period"]; $vData["regular_period_units"] =$data["regular_period_units"]; $vData["is_recurring"] =$data["is_recurring"] == "yes" ?true :false; $vData[I14721] =$data[I14721] >0 ?$data[I14721] :"0"; if($vData[I14705] == I14707) $vData[I14705] =$DEFAULT_RETURN_ADDRESS; if($vData["cancel"] == I14707) $vData["cancel"] =$DEFAULT_CANCEL_ADDRESS; $data =$vData; $data["is_recurring"] =$data[I14722] ?"1" :"0"; foreach($vData as $key => $value) $vData[$key] =stripslashes($vData[$key]); foreach($data as $key => $value) $data[$key] =$this->ll11LIl->TlTITll($data[$key]); $I1lLIlI =$this->gui->get("billing_subscription_form", $data); return true; }function TlTTlT1(&$vRes, &$I1lLIlI, &$vData, $cID, $ll11llL =I14707){ $DEFAULT_BUSINESS_EMAIL =$this->ll11LIl->parameters["DEFAULT_BUSINESS_EMAIL"]; $DEFAULT_RETURN_ADDRESS =$this->ll11LIl->parameters["DEFAULT_RETURN_ADDRESS"]; $DEFAULT_CANCEL_ADDRESS =$this->ll11LIl->parameters["DEFAULT_CANCEL_ADDRESS"]; $LOCAL_GMT =$this->ll11LIl->parameters["LOCAL_GMT"]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14682] ="Success"; $vRes[I14684] =0; if($cID == I14707){ $vRes[I14682] ="Item ID cannot be null"; $vRes[I14684] =1; return false; }$sql ="select * from bill_invoice where STRCMP(item_number, '".$cID.I14715; $result =mysql_query($sql, $ll11lLI); if(!(mysql_num_rows($result) >0)){ $vRes[I14682] ="The item with such ID cannot be found"; $vRes[I14684] =2; return false; }$data =mysql_fetch_array($result); $ll11l11 =@date("Y/m/d H:i:s", time()-($LOCAL_GMT-$data["customer_gmt"])*3600); $start_date =@date("Y/m/d H:i:s", strtotime($data[I14723])); $final_date =@date("Y/m/d H:i:s", strtotime($data["final_date"])); if($ll11l11 <$start_date || $ll11l11 >$final_date){ $vRes[I14682] ="Invoice is expired"; $vRes[I14684] =3; return false; }if($data["status"] == I14724){ $vRes[I14682] ="Invoice have already paid"; $vRes[I14684] =4; return false; }if($ll11llL != I14707){ $ll11lLL ="select ID, affiliate_counter from bill_user where ROLE='f' AND affiliate_id='".$ll11llL.I14702; $ll11lL1 =mysql_query($ll11lLL, $ll11lLI); if($ll11l1I =mysql_fetch_array($ll11lL1)) if($ll11l1I["ID"] >0){ $vData["custom"] =$ll11l1I[I14725]; mysql_query($this->ll11LIl->GenUpdateSql(I14710, Array(I14703 => $ll11l1I[I14703]+1), I14716.$ll11l1I[I14725]), $ll11lLI); }}$vData["business_email"] =$DEFAULT_BUSINESS_EMAIL; $vData[I14705] =$data[I14705]; $vData["cancel"] =$data["cancel"]; $vData[I14712] =$data[I14712]; $vData[I14706] =$data[I14706]; $vData[I14717] =$data[I14717]; $vData[I14694] =$data[I14694]; $vData[I14695] =$data[I14695]; $vData[I14704] =$this->ll11LIl->FormatNumber($data[I14704], true); if($vData[I14705] == I14707) $vData[I14705] =$DEFAULT_RETURN_ADDRESS; if($vData["cancel"] == I14707) $vData[I14726] =$DEFAULT_CANCEL_ADDRESS; $data =$vData; foreach($vData as $key => $value) $vData[$key] =stripslashes($vData[$key]); foreach($data as $key => $value) $data[$key] =$this->ll11LIl->TlTITll($data[$key]); $I1lLIlI =$this->gui->get("billing_invoice_form", $data); return true; }function TlTTlIT(&$vRes, $cID){ $LOCAL_GMT =$this->ll11LIl->parameters["LOCAL_GMT"]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14682] ="Success"; $vRes[I14684] =0; if($cID == I14707){ $vRes[I14682] ="Subscriber ID cannot be null"; $vRes[I14684] =1; return false; }$sql ="select * from bill_subscribers where strcmp(subscr_id, '".$cID.I14715; $result =mysql_query($sql, $ll11lLI); if(!(mysql_num_rows($result) >0)){ $vRes[I14682] ="The subscriber with such ID cannot be found"; $vRes[I14684] =2; return false; }$data =mysql_fetch_array($result); $ILII11I =date("Y/m/d H:i:s", strtotime($data["exp_date"])+$LOCAL_GMT*3600); if($ILII11I <date("Y/m/d H:i:s") || $data[I14727] != "active"){ $vRes[I14682] ="The subscriber has expired"; $vRes[I14684] =3; return false; }return true; }}}?>
