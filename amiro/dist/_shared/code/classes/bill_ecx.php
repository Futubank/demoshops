<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       86147 xkqwnlxtuusirkskyupwgwkgnniiqzyklskiwpyiiixnzlsuquxxuriukxyqkgnsgkknpnir
 */ ?><?php foreach(array(14734=>"ymjj|qwX|grHWQDDiHSuJQURj",14735=>"ymjj|qwX|is5VZJuQ",14736=>"QrrnH",14737=>"QrrHr",14738=>"]x|TrZn|kQB=",14739=>"]x|qnWZG|wOZr=",14740=>"]x|zIHunt=",14741=>"&",14742=>"EuZntMtB",14743=>"b~I~S?o%M%D",14744=>"Uds",14745=>"",14746=>"GZBQr|MS",14747=>"MnDtZnt",14748=>"GZBIQnt|PrHDD",14749=>"txn|MS",14750=>"\1",14751=>"zjjhc|zsimN|whgb",14752=>"0",14753=>"uGSZtQ",14754=>"JZDt|nZIQ",14755=>"'{=0",14756=>"GrHSuWt",14757=>"MtQI|nuIYQr",14758=>"*kqb&",14759=>"qizmj",14760=>"MtQI|nZIQ",14761=>"*gRhsUwT&",14762=>"GZBQr|QIZMJ",14763=>"*szTq&",14764=>"GZMS",14765=>"YMJJ|trZnDZWtMHn",14766=>"KQB",14767=>"DQrvMWQ|pqNqRmw|",14768=>"QWx|fHrI|urJ",14769=>"DtZtuD",14770=>'1',14771=>"GZtO",14772=>"!",14773=>"ZWtMvQ",14774=>"duWWQDD",14775=>"fMnZJ|SZtQ",14776=>"QWx|GrHWQDD|urJ",14777=>"YMJJ|MnvHMWQ",14778=>"1",14779=>"qMtOQr?trMZJ?Hr?rQPuJZr?GrMWQ?DOHuJS?YQ?DQt",14780=>"qMtOQr?trMZJ?Hr?rQPuJZr?GQrMHS?DOHuJS?YQ?DQt",14781=>"TrMZJ?GQrMHS?unMt?DOHuJS?OZD?Z?WHrrQWt?fHrIZt",14782=>"~*sib&)1(~",14783=>"trMZJ|ZIHunt",14784=>"`",14785=>"trMZJ|GQrMHS",14786=>"trMZJ|GQrMHS|unMtD",14787=>"rQWurrMnP|tMIQD",14788=>"YuttHn|nZIQ",14789=>"p",14790=>"'",14791=>"ZffMJMZtQ|WHuntQr",14792=>"ZIHunt",14793=>"fHrI|urJ",14794=>"ms",14795=>"ymjj|SMDWHunt",14796=>"fMJQ|QxMDtD",14797=>"WuDtHI",14798=>"rQPuJZr|ZIHunt",14799=>"MD|rQWurrMnP",14800=>"DtZrt|SZtQ",14801=>"COQrQ?ms=",14802=>"WuDtHIQr|QIZMJ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} if(!class_exists("BILL_driver_ecx", false)){ @set_time_limit(300); class BILL_driver_ecx extends BILL_driver_base {public $gui; public $ILLLllI; public $ll11LII; public $ll11LIl; public function __construct($ll11ILl){ parent::__construct($ll11ILl); $this->gui =&$ll11ILl; $this->TlTTlll(0); $this->ll11LII =false; }function TlTTlll($cValue =1){ if($cValue != 1 && $cValue != 2) $this->ILLLllI =0; else $this->ILLLllI =$cValue; }function TlTTl11(&$vRes, &$vData, $IIIL1L1, $ll111LL, $ll111L1, $cCustom, $ll1111I, $ll1111l, $ll1111L, $ll11111, $lLIIIII){ $BILL_ECX_TransactionKey =$this->ll11LIl->parameters["BILL_ECX_TransactionKey"]; $BILL_ECX_ProcessModuleURL =$this->ll11LIl->parameters[I14734]; $BILL_ECX_MD5Value =$this->ll11LIl->parameters[I14735]; $BILL_ECX_Login =$this->ll11LIl->parameters["BILL_ECX_Login"]; $LOCAL_GMT =$this->ll11LIl->parameters["LOCAL_GMT"]; $vRes["error"] ="Success"; $vRes[I14736] =0; if($ll111LL == ""){ $vRes["error"] ="Item number should not be null"; $vRes[I14736] =2; return false; }if(!($ll111L1 >= 0)){ $vRes["error"] ="Amount should be equal or greater than 0"; $vRes[I14736] =3; return false; }if($ll1111I == ""){ $vRes["error"] ="Customer's first name should not be null"; $vRes[I14736] =4; return false; }if($ll1111l == ""){ $vRes[I14737] ="Customer's last name should not be null"; $vRes[I14736] =5; return false; }if($ll1111L == ""){ $vRes[I14737] ="Customer's e-mail should not be null"; $vRes[I14736] =6; return false; }if($ll11111 == ""){ $vRes[I14737] ="Card number should not be null"; $vRes[I14736] =7; return false; }if(!preg_match("/[0-1]{1}[0-9]{1}\/[0-3]{1}[0-9]{1}/", $lLIIIII)){ $vRes[I14737] ="Card expiration date should has a format: mm/dd"; $vRes[I14736] =8; return false; }if($this->ILLLllI != 1){ $response =""; $content ="x_Login=".rawurlencode($BILL_ECX_Login). I14738.rawurlencode($BILL_ECX_TransactionKey). ($this->ILLLllI == 2 ?"&x_Test_Request=TRUE" :""). "&x_Delim_Data=TRUE". "&x_Delim_Char=;". I14739.rawurlencode('"'). "&x_First_Name=".rawurlencode($ll1111I). "&x_Last_Name=".rawurlencode($ll1111l). "&x_Email=".rawurlencode($ll1111L). "&x_Email_Customer=FALSE". "&x_Invoice_Num=".rawurlencode($cCustom). "&x_Description=".rawurlencode($IIIL1L1." [".$ll111LL."]"). I14740.rawurlencode($this->ll11LIl->FormatNumber($ll111L1, true)). "&x_Method=CC". "&x_Type=AUTH_CAPTURE". "&x_Card_Num=".rawurlencode($ll11111). "&x_Exp_Date=".rawurlencode($lLIIIII); ob_start(); $ll11lll =curl_init ("https://secure.authorize.net/gateway/transact.dll"); curl_setopt($ll11lll, CURLOPT_HEADER, 0); curl_setopt($ll11lll, CURLOPT_TIMEOUT, 300); curl_setopt($ll11lll, CURLOPT_POST, 1); curl_setopt($ll11lll, CURLOPT_POSTFIELDS, $content); if(!curl_exec($ll11lll)){ $vRes[I14737] ="CURL execution error: ".curl_error($ll11lll); $vRes[I14736] =9; curl_close ($ll11lll); return false; }curl_close ($ll11lll); $response =ob_get_contents(); ob_end_clean(); ob_end_flush(); }else{ $response ="\"1\";\"1\";\"1\";\"This transaction is accepted.\";\"000000\";\"P\";\"0\";\"".$cCustom."\";\"".$IIIL1L1." [".$ll111LL.I14741."\";\"".$this->ll11LIl->FormatNumber($ll111L1, true)."\";\"CC\";\"auth_capture\";\"\";\"".$ll1111I."\";\"".$ll1111l."\";\"\";\"\";\"\";\"\";\"\";\"\";\"\";\"\";\"".$ll1111L."\";\"\";\"\";\"\";\"\";\"\";\"\";\"\";\"\";\"\";\"\";\"\";\"\";\"\";\"".md5($BILL_ECX_MD5Value.$BILL_ECX_Login."0".$this->ll11LIl->FormatNumber($ll111L1, true))."\""; }if(!$this->TlTT1TT($lLIIIIl, $response)){ $vRes[I14737] ="Invalid response from the gateway"; $vRes[I14736] =10; return false; }if(!$this->TlTT1TI($lLIIIIl[38], $lLIIIIl[7], $lLIIIIl[10])){ $vRes[I14737] ="The transaction didn't come from ECX. Or check the parameters."; $vRes[I14736] =11; return false; }if($lLIIIIl[1] == 2){ $vRes[I14737] ="Transaction is declined. Reason #".$lLIIIIl[3]; $vRes[I14736] =12; return false; }else if($lLIIIIl[1] == 3){ $vRes[I14737] ="Error #".$lLIIIIl[3]." in transaction"; $vRes[I14736] =13; return false; }$vData =Array( "item_name" => $IIIL1L1, "item_number" => $ll111LL, I14742 => 1, "custom" => $cCustom, "payment_status" => "Completed", "payment_date" => date(I14743, time()-$LOCAL_GMT*3600), "mc_gross" => $this->ll11LIl->FormatNumber($ll111L1, true), "mc_fee" => "0.00", "mc_currency" => I14744, "txn_id" => $lLIIIIl[7], "txn_type" => "web_accept", "subscr_id" => I14745, "subscr_num" => 0, "first_name" => $ll1111I, "last_name" => $ll1111l, "payer_email" => $ll1111L, I14746 => "000000", "payer_status" => "unverified", "payment_type" => I14747, "notify_version" => "3.1", "verify_sign" => "ADDED_FROM_ECX. NO SIGN.", I14748 => $this->ll11LIl->FormatNumber($ll111L1, true), "payment_fee" => "0.00", "type" => "ecx" );if($this->ILLLllI != 0 && ($vData[I14749] == "0" || $vData[I14749] == I14745)){ $vData[I14749] ="ECXTEST".mb_strtoupper(mb_substr($this->ll11LIl->TlTITI1(), 0, 17)); }return true; }function TlTT1TT(&$vData, $cData){ $vData =Array(); $cData =str_replace('";"', "\1", $cData); $cData =mb_substr($cData, 1, mb_strlen($cData)-2); $cData =I14750.$cData; $vData =explode(I14750, $cData); if(count($vData) <= 38) return false; return true; }function TlTT1TI($lLIIIIL, $lLIIII1, $ll111L1){ $BILL_ECX_MD5Value =$this->ll11LIl->parameters[I14735]; $BILL_ECX_Login =$this->ll11LIl->parameters["BILL_ECX_Login"]; $hash =md5($BILL_ECX_MD5Value.$BILL_ECX_Login.$lLIIII1.$ll111L1); if(strcasecmp($hash, $lLIIIIL)) return false; return true; }function TlTT1Tl(&$vRes, $cData){ $ALLOW_TRUE_TRANSACTION =$this->ll11LIl->parameters["ALLOW_TRUE_TRANSACTION"]; $FROM_EMAIL =$this->ll11LIl->parameters["FROM_EMAIL"]; $ADMIN_EMAIL =$this->ll11LIl->parameters["ADMIN_EMAIL"]; $ALLOW_ADMIN_COPY =$this->ll11LIl->parameters[I14751]; $DOWNLOAD_AFTER_COMPLETED =$this->ll11LIl->parameters["DOWNLOAD_AFTER_COMPLETED"]; $MESSAGE_TITLE =$this->ll11LIl->parameters["MESSAGE_TITLE"]; $MESSAGE_TEXT =$this->ll11LIl->parameters["MESSAGE_TEXT"]; $MESSAGE_TEXT_NO_FILE =$this->ll11LIl->parameters["MESSAGE_TEXT_NO_FILE"]; $PRODUCT_DOWNLOAD_LINK =$this->ll11LIl->parameters["PRODUCT_DOWNLOAD_LINK"]; $SERVICE_SEND_AFTER_CONFIRMED =$this->ll11LIl->parameters["SERVICE_SEND_AFTER_CONFIRMED"]; $SERVICE_MESSAGE_TITLE =$this->ll11LIl->parameters["SERVICE_MESSAGE_TITLE"]; $SERVICE_MESSAGE_TEXT =$this->ll11LIl->parameters["SERVICE_MESSAGE_TEXT"]; $SUBSCRIPTION_SEND_AFTER_CONFIRMED =$this->ll11LIl->parameters["SUBSCRIPTION_SEND_AFTER_CONFIRMED"]; $SUBSCRIPTION_MESSAGE_TITLE =$this->ll11LIl->parameters["SUBSCRIPTION_MESSAGE_TITLE"]; $SUBSCRIPTION_MESSAGE_TEXT =$this->ll11LIl->parameters["SUBSCRIPTION_MESSAGE_TEXT"]; $INVOICE_SEND_AFTER_CONFIRMED =$this->ll11LIl->parameters["INVOICE_SEND_AFTER_CONFIRMED"]; $INVOICE_MESSAGE_TITLE =$this->ll11LIl->parameters["INVOICE_MESSAGE_TITLE"]; $INVOICE_MESSAGE_TEXT =$this->ll11LIl->parameters["INVOICE_MESSAGE_TEXT"]; $UNKNOWN_MESSAGE_TITLE =$this->ll11LIl->parameters["UNKNOWN_MESSAGE_TITLE"]; $UNKNOWN_MESSAGE_TEXT =$this->ll11LIl->parameters["UNKNOWN_MESSAGE_TEXT"]; $BUY_NOTIFICATION_TO_USER_TITLE =$this->ll11LIl->parameters["BUY_NOTIFICATION_TO_USER_TITLE"]; $BUY_NOTIFICATION_TO_USER_MESSAGE =$this->ll11LIl->parameters["BUY_NOTIFICATION_TO_USER_MESSAGE"]; $vRes[I14737] ="Success"; $vRes[I14736] =0; $ll11lLI =$this->ll11LIl->TlTITIl(); if($ALLOW_TRUE_TRANSACTION){ if(mb_strlen($cData[I14749]) == I14745 || $cData[I14749] == I14752){ $vRes[I14737] ="The transaction ID is null."; $vRes[I14736] =1; return false; }$lLIIIlI ="insert"; $lLIIIll ="select payment_status from bill_transaction where txn_id='".$cData[I14749]."'"; $lLIIIlL =mysql_query($lLIIIll, $ll11lLI); $lLIIIl1 =mysql_fetch_array($lLIIIlL); if(mysql_num_rows($lLIIIlL) >0) $lLIIIlI =I14753; $cData["verify_status"] ="verified"; $lLIIILI =Array( "first_name" => $cData["first_name"], I14754 => $cData[I14754], "email" => $cData["payer_email"] );$sql ="select count(*) as count from bill_customer where STRCMP(email, '".$lLIIILI["email"].I14755; $lLIIILl =mysql_query($sql, $ll11lLI); $lLIIILL =mysql_fetch_array($lLIIILl, MYSQL_ASSOC); if($lLIIILL["count"] == 0){ $sql =$this->ll11LIl->GenInsertSql("bill_customer", $lLIIILI); mysql_query($sql, $ll11lLI); }$lLIIIL1 ="unknown"; if(mb_strpos($cData["item_number"], I14756) === 0){ $cData["download_key"] =$this->ll11LIl->TlTITlT($ll11lLI); $sql ="select count(*) as count from bill_product where STRCMP(item_number, '".$cData["item_number"].I14755; $lLIII1I =@mysql_query($sql, $ll11lLI); $lLIII1l =@mysql_fetch_array($lLIII1I); if($lLIII1l["count"] >= 1){ $lLIIIL1 =I14756; if($DOWNLOAD_AFTER_COMPLETED == 1){ $lLIII1L =$this->ll11LIl->TlTITlI($cData[I14757], $ll11lLI); $this->ll11LIl->TlTITl1(stripslashes($cData["payer_email"]),$FROM_EMAIL,$MESSAGE_TITLE,str_replace("[KEY]", $cData["download_key"], str_replace("[URL]", $PRODUCT_DOWNLOAD_LINK, ($lLIII1L ?$MESSAGE_TEXT :$MESSAGE_TEXT_NO_FILE)))); if($ALLOW_ADMIN_COPY) $this->ll11LIl->TlTITl1($ADMIN_EMAIL,$FROM_EMAIL,$MESSAGE_TITLE,str_replace(I14758, $cData["download_key"], str_replace("[URL]", $PRODUCT_DOWNLOAD_LINK, ($lLIII1L ?$MESSAGE_TEXT :$MESSAGE_TEXT_NO_FILE)))); $lLIII11 ="select u.EMAIL, r.product_id from bill_user u LEFT JOIN bill_rights r on u.ID=r.user_id where STRCMP(r.product_id, '".$cData[I14757]."')=0 AND u.DENY_SENDING_BUY='no' AND u.SEND_EMAIL_BUY='yes'"; $lLIIlII =@mysql_query($lLIII11, $ll11lLI); while($lLIIlIl =@mysql_fetch_array($lLIIlII)) $this->ll11LIl->TlTITl1(stripslashes($lLIIlIl[I14759]),$FROM_EMAIL,$BUY_NOTIFICATION_TO_USER_TITLE,str_replace("[DATE]", FormatDate(1, 1, I14745, false),str_replace("[PRODUCT]", stripslashes($cData["item_name"]), $BUY_NOTIFICATION_TO_USER_MESSAGE))); }}}else if(mb_strpos($cData[I14757], "service") === 0){ $sql ="select count(*) as count from bill_product where STRCMP(item_number, '".$cData[I14757].I14755; $lLIII1I =@mysql_query($sql, $ll11lLI); $lLIII1l =@mysql_fetch_array($lLIII1I); if($lLIII1l["count"] >= 1){ $lLIIIL1 ="service"; if(!$SERVICE_SEND_AFTER_CONFIRMED){ $this->ll11LIl->TlTITl1(stripslashes($cData["payer_email"]),$FROM_EMAIL,$SERVICE_MESSAGE_TITLE,str_replace("[NAME]", stripslashes($cData[I14760]), $SERVICE_MESSAGE_TEXT)); if($ALLOW_ADMIN_COPY) $this->ll11LIl->TlTITl1($ADMIN_EMAIL,$FROM_EMAIL,$SERVICE_MESSAGE_TITLE,str_replace("[NAME]", stripslashes($cData[I14760]), $SERVICE_MESSAGE_TEXT)); $lLIII11 ="select u.EMAIL, r.product_id from bill_user u LEFT JOIN bill_rights r on u.ID=r.user_id where STRCMP(r.product_id, '".$cData[I14757]."')=0 AND u.DENY_SENDING_BUY='no' AND u.SEND_EMAIL_BUY='yes'"; $lLIIlII =@mysql_query($lLIII11, $ll11lLI); while($lLIIlIl =@mysql_fetch_array($lLIIlII)) $this->ll11LIl->TlTITl1(stripslashes($lLIIlIl[I14759]),$FROM_EMAIL,$BUY_NOTIFICATION_TO_USER_TITLE,str_replace("[DATE]", FormatDate(1, 1, I14745, false),str_replace(I14761, stripslashes($cData[I14760]), $BUY_NOTIFICATION_TO_USER_MESSAGE))); }}}else if(mb_strpos($cData[I14757], "invoice") === 0){ $sql ="select count(*) as count from bill_invoice where STRCMP(item_number, '".$cData[I14757].I14755; $lLIII1I =@mysql_query($sql, $ll11lLI); $lLIII1l =@mysql_fetch_array($lLIII1I); if($lLIII1l["count"] >= 1){ $lLIIIL1 ="invoice"; if(!$INVOICE_SEND_AFTER_CONFIRMED){ $this->ll11LIl->TlTITl1(stripslashes($cData[I14762]),$FROM_EMAIL,$INVOICE_MESSAGE_TITLE,str_replace("[ID]", $cData[I14757], $INVOICE_MESSAGE_TEXT)); if($ALLOW_ADMIN_COPY) $this->ll11LIl->TlTITl1($ADMIN_EMAIL,$FROM_EMAIL,$INVOICE_MESSAGE_TITLE,str_replace("[ID]", $cData[I14757], $INVOICE_MESSAGE_TEXT)); $lLIII11 ="select u.EMAIL, r.product_id from bill_user u LEFT JOIN bill_rights r on u.ID=r.user_id where STRCMP(r.product_id, '".$cData[I14757]."')=0 AND u.DENY_SENDING_BUY='no' AND u.SEND_EMAIL_BUY='yes'"; $lLIIlII =@mysql_query($lLIII11, $ll11lLI); while($lLIIlIl =@mysql_fetch_array($lLIIlII)) $this->ll11LIl->TlTITl1(stripslashes($lLIIlIl[I14759]),$FROM_EMAIL,$BUY_NOTIFICATION_TO_USER_TITLE,str_replace(I14763, FormatDate(1, 1, I14745, false),str_replace(I14761, stripslashes($cData[I14760]), $BUY_NOTIFICATION_TO_USER_MESSAGE))); }}}if($lLIIIL1 == "unknown") {$this->ll11LIl->TlTITl1(stripslashes($cData[I14762]),$FROM_EMAIL,$UNKNOWN_MESSAGE_TITLE, $UNKNOWN_MESSAGE_TEXT); if($ALLOW_ADMIN_COPY) $this->ll11LIl->TlTITl1($ADMIN_EMAIL,$FROM_EMAIL,$UNKNOWN_MESSAGE_TITLE, $UNKNOWN_MESSAGE_TEXT); }if($lLIIIL1 == "invoice") {$sql =$this->ll11LIl->GenUpdateSql("bill_invoice", Array("status" => I14764), "where STRCMP(item_number, '".$cData[I14757].I14755); @mysql_query($sql, $ll11lLI); }if($lLIIIlI == I14753) $sql =$this->ll11LIl->GenUpdateSql("bill_transaction", $cData, "where txn_id='".$cData[I14749]."'"); else $sql =$this->ll11LIl->GenInsertSql(I14765, $cData); if(!mysql_query($sql, $ll11lLI)){ $vRes[I14737] ="Unable to insert data to the billing."; $vRes[I14736] =2; return false; }}else{ $vRes[I14737] ="The transaction creating is disabled"; $vRes[I14736] =3; return false; }return true; }function TlTTll1(&$vRes, $cID, $ll11LLL, $ll11LL1, $ll11L1I, $lLIIlIL, $lLIIlI1, $ll11L11 ='1'){ $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14737] ="Success"; $vRes[I14736] =0; $vRes[I14766] =I14745; if($cID == I14745){ $vRes[I14737] ="Item ID cannot be null"; $vRes[I14736] =2; return false; }if($ll11LLL == I14745){ $vRes[I14737] ="Item title cannot be null"; $vRes[I14736] =3; return false; }if($ll11LL1 == I14745){ $vRes[I14737] ="Item price cannot be null"; $vRes[I14736] =4; return false; }if($ll11L1I == I14745){ $vRes[I14737] ="Button name cannot be null"; $vRes[I14736] =5; return false; }$sql ="select count(*) as count from bill_product where strcmp(alias, 'service_GENERIC_".$cID.I14755; $result =mysql_query($sql, $ll11lLI); $data =mysql_fetch_array($result); if($data["count"] >0){ $vRes[I14737] ="Such alias already exists"; $vRes[I14736] =1; return false; }$data =Array( I14760 => $ll11LLL, I14757 => "service".$this->ll11LIl->TlTITI1(), "alias" => I14767.$cID, "category" => I14752, "amount" => str_replace(",", ".", $ll11LL1), I14768 => $lLIIlIL, "ecx_process_url" => $lLIIlI1, "buy_times" => I14752, "type" => "service", I14769 => "active", "create_time" => date(I14743), "button_name" => $ll11L1I );$vRes[I14766] =$data[I14757]; $sql =$this->ll11LIl->GenInsertSql("bill_product", $data); mysql_query($sql, $ll11lLI); return true; }function TlTTl1T(&$vRes, $cID, $ll11LLL, $cPath, $ll11LL1, $ll11L1I, $lLIIlIL, $lLIIlI1, $ll11L11 =I14770){ $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14737] ="Success"; $vRes[I14736] =0; $vRes[I14766] =I14745; if($cID == I14745){ $vRes[I14737] ="Item ID cannot be null"; $vRes[I14736] =2; return false; }if($ll11LLL == I14745){ $vRes[I14737] ="Item title cannot be null"; $vRes[I14736] =3; return false; }if($cPath == I14745){ $vRes[I14737] ="Path cannot be null"; $vRes[I14736] =4; return false; }if($ll11LL1 == I14745){ $vRes[I14737] ="Item price cannot be null"; $vRes[I14736] =5; return false; }if($ll11L1I == I14745){ $vRes[I14737] ="Button name cannot be null"; $vRes[I14736] =6; return false; }$sql ="select count(*) as count from bill_product where strcmp(alias, 'product_GENERIC_".$cID.I14755; $result =mysql_query($sql, $ll11lLI); $data =mysql_fetch_array($result); if($data["count"] >0){ $vRes[I14737] ="Such alias already exists"; $vRes[I14736] =1; return false; }$data =Array( I14771 => $cPath, I14760 => $ll11LLL, I14757 => I14756.$this->ll11LIl->TlTITI1(), "alias" => "product_GENERIC_".$cID, "category" => I14752, "amount" => str_replace(I14772, ".", $ll11LL1), I14768 => $lLIIlIL, "ecx_process_url" => $lLIIlI1, "buy_times" => I14752, "type" => I14756, I14769 => I14773, "create_time" => date(I14743), "button_name" => $ll11L1I );$vRes[I14766] =$data[I14757]; $sql =$this->ll11LIl->GenInsertSql("bill_product", $data); mysql_query($sql, $ll11lLI); return true; }function TlTTl1I(&$vRes, $ll11LLL, $IllI111, $ll11LL1, $ll111II, $ll111Il, $ll111IL, $ll11L1I, $lLIIlIL, $lLIIlI1, $ll11L11 =I14770){ $LOCAL_GMT =$this->ll11LIl->parameters["LOCAL_GMT"]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14737] =I14774; $vRes[I14736] =0; $vRes[I14766] =I14745; if($ll11LLL == I14745){ $vRes[I14737] ="Item title cannot be null"; $vRes[I14736] =1; return false; }if($IllI111 == I14745){ $vRes[I14737] ="Description cannot be null"; $vRes[I14736] =2; return false; }if($ll11LL1 == I14745){ $vRes[I14737] ="Item price cannot be null"; $vRes[I14736] =3; return false; }if($ll111II == I14745){ $vRes[I14737] ="Start date cannot be null"; $vRes[I14736] =4; return false; }if($ll111Il == I14745){ $vRes[I14737] ="Final date cannot be null"; $vRes[I14736] =5; return false; }if($ll11L1I == I14745){ $vRes[I14737] ="Button name cannot be null"; $vRes[I14736] =6; return false; }$data =Array( I14760 => $ll11LLL, I14757 => "invoice".$this->ll11LIl->TlTITI1(), "description" => $IllI111, "start_date" => date(I14743, strtotime($ll111II)-$LOCAL_GMT*3600), I14775 => date(I14743, strtotime($ll111Il)-$LOCAL_GMT*3600), "customer_gmt" => $ll111IL, "category" => I14752, "amount" => str_replace(I14772, ".", $ll11LL1), I14768 => $lLIIlIL, I14776 => $lLIIlI1, I14769 => "notpaid", "create_time" => date(I14743), "button_name" => $ll11L1I, "owner" => I14752 );$vRes[I14766] =$data[I14757]; $sql =$this->ll11LIl->GenInsertSql(I14777, $data); mysql_query($sql, $ll11lLI); return true; }function TlTTl1l(&$vRes, $cID, $ll11LLL, $ll111I1, $ll111lI, $ll111ll, $ll111lL, $ll111l1, $ll111LI, $ll111Ll, $ll11L1I, $lLIIlIL, $lLIIlI1, $ll11L11 =I14770){ $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14737] =I14774; $vRes[I14736] =0; $vRes[I14766] =I14745; $lLIIllI =$ll111Ll <= 0 ?I14752 :$ll111Ll; $ll111Ll =$ll111Ll == 0 ?"no" :"yes"; $ll111I1 ="0.00"; $ll111lI =I14752; $ll111ll ="D"; $lLIIllI =I14752; $ll111l1 =I14778; $ll111LI ="M"; if($cID == I14745){ $vRes[I14737] ="Item ID cannot be null"; $vRes[I14736] =2; return false; }if($ll11LLL == I14745){ $vRes[I14737] ="Item title cannot be null"; $vRes[I14736] =3; return false; }if(!($ll111I1 >0 || $ll111lL >0)){ $vRes[I14737] =I14779; $vRes[I14736] =4; return false; }if(!($lLIIlll >0 || $ll111l1 >0)){ $vRes[I14737] =I14780; $vRes[I14736] =5; return false; }if(!preg_match("/[DMY]{1}/", $ll111ll)){ $vRes[I14737] =I14781; $vRes[I14736] =6; return false; }if(!preg_match(I14782, $ll111LI)){ $vRes[I14737] ="Regular period unit should has a correct format"; $vRes[I14736] =7; return false; }if($ll11L1I == I14745){ $vRes[I14737] ="Button name cannot be null"; $vRes[I14736] =8; return false; }$sql ="select count(*) as count from bill_product where strcmp(alias, 'subscription_GENERIC_".$cID.I14755; $result =mysql_query($sql, $ll11lLI); $data =mysql_fetch_array($result); if($data["count"] >0){ $vRes[I14737] ="Such alias already exists"; $vRes[I14736] =1; return false; }$data =Array( I14760 => $ll11LLL, I14757 => "subscri".$this->ll11LIl->TlTITI1(), "alias" => "subscription_GENERIC_".$cID, "category" => I14752, I14783 => str_replace(I14772, I14784, $ll111I1), I14785 => $ll111lI, I14786 => $ll111ll, "regular_amount" => str_replace(I14772, I14784, $ll111lL), "regular_period" => $ll111l1, "regular_period_units" => $ll111LI, "is_recurring" => $ll111Ll, I14787 => $lLIIllI, I14768 => $lLIIlIL, I14776 => $lLIIlI1, "buy_times" => I14752, "type" => "subscription", I14769 => I14773, "create_time" => date(I14743), I14788 => $ll11L1I );$vRes[I14766] =$data[I14757]; $sql =$this->ll11LIl->GenInsertSql("bill_product", $data); mysql_query($sql, $ll11lLI); return true; }function TlTTlTT(&$vRes, &$I1lLIlI, &$vData, $cID, $ll11llL =I14745, $ll11ll1 ="KAG"){ $BILL_ECX_PaymentFormURL =$this->ll11LIl->parameters["BILL_ECX_PaymentFormURL"]; $BILL_ECX_ProcessModuleURL =$this->ll11LIl->parameters[I14734]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14737] =I14774; $vRes[I14736] =0; if($cID == I14745){ $vRes[I14737] ="Item ID cannot be null"; $vRes[I14736] =1; return false; }$ll11lLl =false; for($i =0;$i <3;$i++){ if($ll11ll1[$i] == I14789) $addon ="strcmp(alias, 'service_GENERIC_".$cID.I14755; else if($ll11ll1[$i] == "A") $addon ="strcmp(alias, '".$cID.I14755; else if($ll11ll1[$i] == "K") $addon ="strcmp(item_number, '".$cID.I14755; else continue; $sql ="select * from bill_product where type='service' and ".$addon." and status='active'"; $result =mysql_query($sql, $ll11lLI); if(mysql_num_rows($result) >0){ $ll11lLl =true; break; }}if(!$ll11lLl){ $vRes[I14737] ="The item with such ID cannot be found or it is inactive"; $vRes[I14736] =2; return false; }$data =mysql_fetch_array($result); if($ll11llL != I14745){ $ll11lLL ="select ID, affiliate_counter from bill_user where ROLE='f' AND affiliate_id='".$ll11llL.I14790; $ll11lL1 =mysql_query($ll11lLL, $ll11lLI); if($ll11l1I =mysql_fetch_array($ll11lL1)) if($ll11l1I["ID"] >0){ $vData["custom"] =$ll11l1I["ID"]; mysql_query($this->ll11LIl->GenUpdateSql("bill_user", Array(I14791 => $ll11l1I[I14791]+1), "where ID=".$ll11l1I["ID"]), $ll11lLI); }}if(@class_exists("BILL_independent_discount")){ $ll11l1l =new BILL_independent_discount($ll11lLI, $this->ll11LIl); if($ll11l1l->TT11ITI($ll11l1L, $data[I14757])){ $data["amount"] =$ll11l1L[I14792]; }}else if(@class_exists("BILL_discount")){ $ll11l1l =new BILL_discount($ll11lLI); if($ll11l1l->TT11ITI($ll11l1L, $data[I14757])){ $data[I14792] =$ll11l1L[I14792]; }}$vData["form_url"] =$BILL_ECX_PaymentFormURL; $vData["process_url"] =$BILL_ECX_ProcessModuleURL; $vData[I14760] =$data[I14760]; $vData[I14757] =$data[I14757]; $vData[I14788] =$data[I14788]; $vData[I14792] =$this->ll11LIl->FormatNumber($data[I14792], true); if($vData["form_url"] == I14745) $vData[I14793] =$BILL_ECX_PaymentFormURL; $data =$vData; foreach($vData as $key => $value) $vData[$key] =stripslashes($vData[$key]); foreach($data as $key => $value) $data[$key] =$this->ll11LIl->TlTITll($data[$key]); $I1lLIlI =$this->gui->get("billing_service_form", $data); return true; }function TlTTlTI(&$vRes, &$I1lLIlI, &$vData, $cID, $ll11llL =I14745, $ll11ll1 ="KAG"){ $PRODUCT_FILE_ROOT =$this->ll11LIl->parameters["PRODUCT_FILE_ROOT"]; $BILL_ECX_PaymentFormURL =$this->ll11LIl->parameters["BILL_ECX_PaymentFormURL"]; $BILL_ECX_ProcessModuleURL =$this->ll11LIl->parameters[I14734]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14737] =I14774; $vRes[I14736] =0; if($cID == I14745){ $vRes[I14737] ="Item ID cannot be null"; $vRes[I14736] =1; return false; }$ll11lLl =false; for($i =0;$i <3;$i++){ if($ll11ll1[$i] == I14789) $addon ="strcmp(alias, 'product_GENERIC_".$cID.I14755; else if($ll11ll1[$i] == "A") $addon ="strcmp(alias, '".$cID.I14755; else if($ll11ll1[$i] == "K") $addon ="strcmp(item_number, '".$cID.I14755; else continue; $sql ="select * from bill_product where type='product' and ".$addon." and status='active'"; $result =mysql_query($sql, $ll11lLI); if(mysql_num_rows($result) >0){ $ll11lLl =true; break; }}if(!$ll11lLl){ $vRes[I14737] ="The item with such ID cannot be found or it is inactive"; $vRes[I14736] =2; return false; }$data =mysql_fetch_array($result); if($ll11llL != I14745){ $ll11lLL ="select ID, affiliate_counter from bill_user where ROLE='f' AND affiliate_id='".$ll11llL.I14790; $ll11lL1 =mysql_query($ll11lLL, $ll11lLI); if($ll11l1I =mysql_fetch_array($ll11lL1)) if($ll11l1I[I14794] >0){ $vData["custom"] =$ll11l1I[I14794]; mysql_query($this->ll11LIl->GenUpdateSql("bill_user", Array(I14791 => $ll11l1I[I14791]+1), "where ID=".$ll11l1I[I14794]), $ll11lLI); }}if(@class_exists("BILL_independent_discount")){ $ll11l1l =new BILL_independent_discount($ll11lLI, $this->ll11LIl); if($ll11l1l->TT11ITI($ll11l1L, $data[I14757])){ $data[I14792] =$ll11l1L[I14792]; }}else if(@class_exists(I14795)){ $ll11l1l =new BILL_discount($ll11lLI); if($ll11l1l->TT11ITI($ll11l1L, $data[I14757])){ $data[I14792] =$ll11l1L[I14792]; }}$vData[I14793] =$BILL_ECX_PaymentFormURL; $vData["process_url"] =$BILL_ECX_ProcessModuleURL; $vData[I14760] =$data[I14760]; $vData[I14757] =$data[I14757]; $vData[I14788] =$data[I14788]; $vData[I14792] =$this->ll11LIl->FormatNumber($data[I14792], true); $vData[I14771] =$data[I14771]; $vData["full_path"] =addslashes($PRODUCT_FILE_ROOT).$data[I14771]; if($vData[I14793] == I14745) $vData[I14793] =$BILL_ECX_PaymentFormURL; $filePath =stripslashes($vData["full_path"]); $vRes["file_exists"] =true; if(!@is_file($filePath)){ $vRes[I14796] =false; $vRes[I14737] ="The file doesn't exist"; $vRes[I14736] =3; }$data =$vData; foreach($vData as $key => $value) $vData[$key] =stripslashes($vData[$key]); foreach($data as $key => $value) $data[$key] =$this->ll11LIl->TlTITll($data[$key]); $I1lLIlI =$this->gui->get("billing_product_form", $data); return true; }function TlTTlTl(&$vRes, &$I1lLIlI, &$vData, $cID, $ll11llL =I14745, $ll11ll1 ="KAG"){ $BILL_ECX_PaymentFormURL =$this->ll11LIl->parameters["BILL_ECX_PaymentFormURL"]; $BILL_ECX_ProcessModuleURL =$this->ll11LIl->parameters[I14734]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14737] =I14774; $vRes[I14736] =0; if($cID == I14745){ $vRes[I14737] ="Item ID cannot be null"; $vRes[I14736] =1; return false; }$ll11lLl =false; for($i =0;$i <3;$i++){ if($ll11ll1[$i] == I14789) $addon ="strcmp(alias, 'subscription_GENERIC_".$cID.I14755; else if($ll11ll1[$i] == "A") $addon ="strcmp(alias, '".$cID.I14755; else if($ll11ll1[$i] == "K") $addon ="strcmp(item_number, '".$cID.I14755; else continue; $sql ="select * from bill_product where type='subscription' and ".$addon." and status='active'"; $result =mysql_query($sql, $ll11lLI); if(mysql_num_rows($result) >0){ $ll11lLl =true; break; }}if(!$ll11lLl){ $vRes[I14737] ="The item with such ID cannot be found or it is inactive"; $vRes[I14736] =2; return false; }$data =mysql_fetch_array($result); if($ll11llL != I14745){ $ll11lLL ="select ID, affiliate_counter from bill_user where ROLE='f' AND affiliate_id='".$ll11llL.I14790; $ll11lL1 =mysql_query($ll11lLL, $ll11lLI); if($ll11l1I =mysql_fetch_array($ll11lL1)) if($ll11l1I[I14794] >0){ $vData[I14797] =$ll11l1I[I14794]; mysql_query($this->ll11LIl->GenUpdateSql("bill_user", Array(I14791 => $ll11l1I[I14791]+1), "where ID=".$ll11l1I[I14794]), $ll11lLI); }}$vData[I14793] =$BILL_ECX_PaymentFormURL; $vData["process_url"] =$BILL_ECX_ProcessModuleURL; $vData[I14760] =$data[I14760]; $vData[I14757] =$data[I14757]; $vData[I14788] =$data[I14788]; $vData[I14783] =$this->ll11LIl->FormatNumber($data[I14783], true); $vData[I14785] =$data[I14785]; $vData[I14786] =$data[I14786]; $vData["regular_amount"] =$this->ll11LIl->FormatNumber($data[I14798], true); $vData["regular_period"] =$data["regular_period"]; $vData["regular_period_units"] =$data["regular_period_units"]; $vData[I14799] =$data[I14799] == "yes" ?true :false; $vData[I14787] =$data[I14787] >0 ?$data[I14787] :I14752; $vData[I14792] =$vData[I14798] == 0 ?$vData[I14783] :$vData[I14798]; if($vData[I14793] == I14745) $vData[I14793] =$BILL_ECX_PaymentFormURL; $data =$vData; $data[I14799] =$data[I14799] ?I14778 :I14752; foreach($vData as $key => $value) $vData[$key] =stripslashes($vData[$key]); foreach($data as $key => $value) $data[$key] =$this->ll11LIl->TlTITll($data[$key]); $I1lLIlI =$this->gui->get("billing_subscription_form", $data); return true; }function TlTTlT1(&$vRes, &$I1lLIlI, &$vData, $cID, $ll11llL =I14745){ $BILL_ECX_PaymentFormURL =$this->ll11LIl->parameters["BILL_ECX_PaymentFormURL"]; $BILL_ECX_ProcessModuleURL =$this->ll11LIl->parameters[I14734]; $LOCAL_GMT =$this->ll11LIl->parameters["LOCAL_GMT"]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14737] =I14774; $vRes[I14736] =0; if($cID == I14745){ $vRes[I14737] ="Item ID cannot be null"; $vRes[I14736] =1; return false; }$sql ="select * from bill_invoice where STRCMP(item_number, '".$cID."')=0 and status='notpaid'"; $result =mysql_query($sql, $ll11lLI); if(!(mysql_num_rows($result) >0)){ $vRes[I14737] ="The item with such ID cannot be found or it is already paid"; $vRes[I14736] =2; return false; }$data =mysql_fetch_array($result); $ll11l11 =@date(I14743, time()-($LOCAL_GMT-$data["customer_gmt"])*3600); $start_date =@date(I14743, strtotime($data[I14800])); $final_date =@date(I14743, strtotime($data[I14775])); if($ll11l11 <$start_date || $ll11l11 >$final_date){ $vRes[I14737] ="Invoice is expired"; $vRes[I14736] =3; return false; }if($data[I14769] == I14764){ $vRes[I14737] ="Invoice have already paid"; $vRes[I14736] =4; return false; }if($ll11llL != I14745){ $ll11lLL ="select ID, affiliate_counter from bill_user where ROLE='f' AND affiliate_id='".$ll11llL.I14790; $ll11lL1 =mysql_query($ll11lLL, $ll11lLI); if($ll11l1I =mysql_fetch_array($ll11lL1)) if($ll11l1I[I14794] >0){ $vData[I14797] =$ll11l1I[I14794]; mysql_query($this->ll11LIl->GenUpdateSql("bill_user", Array(I14791 => $ll11l1I[I14791]+1), I14801.$ll11l1I[I14794]), $ll11lLI); }}$vData[I14793] =$BILL_ECX_PaymentFormURL; $vData["process_url"] =$BILL_ECX_ProcessModuleURL; $vData[I14760] =$data[I14760]; $vData[I14757] =$data[I14757]; $vData["description"] =$data["description"]; $vData[I14788] =$data[I14788]; $vData[I14792] =$this->ll11LIl->FormatNumber($data[I14792], true); if($vData[I14793] == I14745) $vData[I14793] =$BILL_ECX_PaymentFormURL; $data =$vData; foreach($vData as $key => $value) $vData[$key] =stripslashes($vData[$key]); foreach($data as $key => $value) $data[$key] =$this->ll11LIl->TlTITll($data[$key]); $I1lLIlI =$this->gui->get("billing_invoice_form", $data); return true; }function TlTT1T1(&$vRes, &$I1lLIlI, $IIIL1L1, $ll111LL, $ll111L1, $cCustom =I14745, $lLIIllL =I14745, $lLIIll1 =I14745, $lLIIlLI =I14745, $ll11111 =I14745, $lLIIIII =I14745){ $BILL_ECX_ProcessModuleURL =$this->ll11LIl->parameters[I14734]; $vRes[I14737] =I14774; $vRes[I14736] =0; if($ll111LL == I14745){ $vRes[I14737] ="Item number should not be null"; $vRes[I14736] =2; return false; }if(!($ll111L1 >= 0)){ $vRes[I14737] ="Amount should be equal or greater than 0"; $vRes[I14736] =3; return false; }$data["process_url"] =$BILL_ECX_ProcessModuleURL; $data[I14760] =$IIIL1L1; $data[I14757] =$ll111LL; $data[I14792] =$this->ll11LIl->FormatNumber($ll111L1, true); $data[I14797] =$cCustom; $data["customer_first_name"] =$lLIIllL; $data["customer_last_name"] =$lLIIll1; $data[I14802] =$lLIIlLI; $data["card_number"] =$ll11111; $data["expiration_date"] =$lLIIIII; if($data[I14793] == I14745) $data[I14793] =$BILL_ECX_PaymentFormURL; foreach($data as $key => $value) $data[$key] =$this->ll11LIl->TlTITll($data[$key]); $I1lLIlI =$this->gui->get("billing_checkout_form", $data); return true; }}}?>
