<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       12753 xkqwzqiysyskpuklyiwlsytuqulpgkwzlitwrususrstwrmytsimlnsklyzlzlxlngkmpnir
 */ ?><?php foreach(array(14816=>"QrrnH",14817=>"YuttHn|nZIQ",14818=>"DQWrQt|KQB",14819=>"urJ",14820=>'urJ',14821=>'HrSQr|MS',14822=>'DOMGGMnP',14823=>'MtQI|MnfH',14824=>'SQtZMJD',14825=>'IMSSJQnZIQ',14826=>'WHntZWt',14827=>'GZrtnQrhrSQrmS',14828=>"HrSQr|SZtZ",14829=>'WZtQPHrB',14830=>"DMP|CMtO|DOMGGMnP",14831=>"SMDZYJQS",14832=>"HrSQr?MD?IMDDQS",14833=>"GZrtnQr|nZIQ",14834=>'DtZtuD',14835=>'SQWJMnQS',14836=>'') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} require_once $GLOBALS['FUNC_INCLUDES_PATH'] .'func_eshop.php'; if(!class_exists("BILL_driver_kupivkredit", false)){ class BILL_driver_kupivkredit extends BILL_driver_base{ public function getPayButton(array &$aRes, array $cData, $bAutoRedirect =false){ global $frn; $res =true; $aData =$cData; $aRes["error"] ="Success"; $aRes["errno"] =0; if(empty($aData["order"])){ $aRes[I14816] =1; $aRes["error"] ="order is missed"; $res =false; }elseif(empty($aData["process_url"])){ $aRes[I14816] =2; $aRes["error"] ="process_url is missed"; $res =false; }$ll11IL1 =$aData; if(isset($ll11IL1["order"])) unset($ll11IL1["order"]); if(isset($ll11IL1["return"])) unset($ll11IL1["return"]); if(isset($ll11IL1[I14817])) unset($ll11IL1[I14817]); if(isset($ll11IL1["button"])) unset($ll11IL1["button"]); if(isset($ll11IL1["partner_id"])) unset($ll11IL1["partner_id"]); if(isset($ll11IL1[I14818])) unset($ll11IL1[I14818]); if(isset($ll11IL1["partner_name"])) unset($ll11IL1["partner_name"]); if(isset($ll11IL1["button_color"])) unset($ll11IL1["button_color"]); if(isset($ll11IL1[I14819])) unset($ll11IL1[I14819]); foreach($ll11IL1 as $key => $value) $aData["hiddens"] .= "<input type=\"hidden\" name=\"$key\" value=\"$value\">\r\n"; foreach(Array("return", "description") as $fldName){ $aData[$fldName] =htmlspecialchars($aData[$fldName]); }$oTpl =AMI::getSingleton('env/template_sys'); $oTpl->addScript($aData[I14820], false, true); $aLocale =$oTpl->parseLocale($GLOBALS['LOCAL_FILES_REL_PATH'] .'eshop/pay_drivers/kupivkredit/driver.lng'); $aOrderData =array(); $aOrderData['items'] =array(); $oOrderItem =AMI::getResourceModel('eshop_order/table')->find($aData[I14821]); $oEshopOrder =AMI::getSingleton('eshop_order'); $aOrderItems =$oEshopOrder->getItems($aOrders =array($oOrderItem)); $lLIIlL1 =$oEshopOrder->getOrderData($oOrderItem); $aData["amount_wo_shipping"] =$lLIIlL1['amount'] -$lLIIlL1['shipping']; $shipping =$lLIIlL1[I14822]; if(is_array($aOrderItems[$aData[I14821]]) && sizeof($aOrderItems[$aData[I14821]])){ foreach($aOrderItems[$aData[I14821]] as $oOrderItem){ $aOrderData['items'][] =array( 'title' => $oOrderItem->data['name'], 'category' => $oOrderItem->data[I14823]['cat_name'], 'qty' => $oOrderItem->qty, 'price' => $oOrderItem->data[I14823]['order_price'] );}}$aOrderData[I14824] =array( 'firstname' => $aData['firstname'], 'lastname' => $aData['lastname'], I14825 => '', 'email' => $aData['email'], 'cellphone' => $aData[I14826] );$aOrderData['partnerId'] =$aData['partner_id']; $aOrderData['partnerName'] =$aData['partner_name']; $aOrderData[I14827] =$aData[I14821]; $aOrderData['deliveryType'] =''; $aData["order_data"] =base64_encode(json_encode($aOrderData)); $aData["sig"] =$this->TlTT1IT($aData[I14828], $aData['secret_key']); $aOrderData['items'][] =array( 'title' => $aLocale['shipping_item'], I14829 => $aLocale['shipping_item'], 'qty' => 1, 'price' => $shipping );$aData["order_data_with_shipping"] =base64_encode(json_encode($aOrderData)); $aData[I14830] =$this->TlTT1IT($aData["order_data_with_shipping"], $aData['secret_key']); $aData['amount_format'] =AMI_Lib_String::jParse($frn->Eshop->formatMoney($aData['amount']/10, $frn->Member->Cart->currency, false)); if(!$res){ $aData[I14831] =I14831; }return parent::getPayButton($aRes, $aData, $bAutoRedirect); }public function TlTT1IT($data, $salt, $lLIIl1I =1102){ $data =$data.$salt; $result =md5($data).sha1($data); for($i =0; $i <$lLIIl1I; $i++){ $result =md5($result); }return $result; }public function getPayButtonParams(array $aData, array &$vRes){ $data =$aData; $vRes["error"] ="Success"; $vRes[I14816] =0; if(empty($data["order"])){ $vRes[I14816] =2; $vRes["error"] =I14832; return false; }$ll11IL1 =$data; if(isset($ll11IL1["item_number"])) unset($ll11IL1["item_number"]); if(isset($ll11IL1[I14819])) unset($ll11IL1[I14819]); if(isset($ll11IL1["partner_id"])) unset($ll11IL1["partner_id"]); if(isset($ll11IL1[I14818])) unset($ll11IL1[I14818]); if(isset($ll11IL1[I14833])) unset($ll11IL1[I14833]); foreach($ll11IL1 as $key => $value) $data["hiddens"] .= "<input type=\"hidden\" name=\"$key\" value=\"$value\">\r\n"; return parent::getPayButtonParams($data, $vRes); }public function payProcess(array $aGet, array $aPost, array &$aRes, array $aCheckData, array $aOrderData){ $status ='fail'; if(!empty($aGet['status'])) $status =$aGet['status']; if(!empty($aPost[I14834])) $status =$aPost[I14834]; return ($status == 'ok'); }public function payCallback(array $aGet, array $aPost, array &$aRes, array $aCheckData, array $aOrderData){ $returnVal =0; if($aPost['order_status'] == 'approved'){ $returnVal =1; }elseif($aPost['order_status'] == I14835){ $returnVal =0; }elseif($aPost['order_status'] == 'wait'){ $returnVal =-1; }return $returnVal; }public function getProcessOrder(array $aGet, array $aPost, array &$aRes, array $aAdditionalParams){ return parent::getProcessOrder($aGet, $aPost, $aRes, $aAdditionalParams); }public function TlTT1II(){ $status ='fail'; $data =file_get_contents('php://input'); preg_match('/<base64encodedmessage>(.*)<\/base64encodedmessage>/i', $data, $matches); $lLIIl1l =!empty($matches[1]) ?$matches[1] :''; preg_match('/<requestsignature>(.*)<\/requestsignature>/i', $data, $matches); $lLIIl1L =!empty($matches[1]) ?$matches[1] :''; preg_match('/<messagevalidityhash>(.*)<\/messagevalidityhash>/i', $data, $matches); $lLIIl11 =!empty($matches[1]) ?$matches[1] :I14836; $lLIILII =TlTll1I($GLOBALS['db'], 'kupivkredit'); $lLIILIl =$this->TlTT1IT($lLIIl1l, $lLIILII['secret_key'], 1102); if($lLIIl1L === $lLIILIl){ $lLIILIL =base64_decode($lLIIl1l); preg_match('/<PartnerOrderId>(.*)<\/PartnerOrderId>/i', $lLIILIL, $matches); $lLIILI1 =!empty($matches[1]) ?$matches[1] :I14836; preg_match('/<NewStatus>(.*)<\/NewStatus>/i', $lLIILIL, $matches); $lLIILlI =!empty($matches[1]) ?$matches[1] :I14836; $_POST[I14821] =$lLIILI1; $_POST['order_status'] =$lLIILlI; $status ='ok'; }return($status == 'ok'); }}}