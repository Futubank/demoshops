<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       65122 xkqwgrpgwxqikxywqripsqllizzutttuptwqznspzxnxrxkpzmgqylpkwmxwrumppqknpnir
 */ ?><?php foreach(array(14855=>"QrrHr",14856=>"",14857=>"QrrnH",14858=>"MtQI|nZIQ",14859=>"WZtQPHrB",14860=>"rQturn",14861=>"tBGQ",14862=>"b~I~S?o%M%D",14863=>"1",14864=>"MtQI|nuIYQr",14865=>"ZIHunt",14866=>"YuB|tMIQD",14867=>"WrQZtQ|tMIQ",14868=>"duWWQDD",14869=>"MnvHMWQ",14870=>"0",14871=>"DtZtuD",14872=>"YMJJ|MnvHMWQ",14873=>"qMtOQr?trMZJ?Hr?rQPuJZr?GrMWQ?DOHuJS?YQ?DQt",14874=>"qMtOQr?trMZJ?Hr?rQPuJZr?GQrMHS?DOHuJS?YQ?DQt",14875=>"TrMZJ?GQrMHS?unMt?DOHuJS?OZD?Z?WHrrQWt?fHrIZt",14876=>"2",14877=>"trMZJ|ZIHunt",14878=>"`",14879=>"trMZJ|GQrMHS",14880=>"trMZJ|GQrMHS|unMtD",14881=>"MD|rQWurrMnP",14882=>"DuYDWrMGtMHn",14883=>"YuDMnQDD|QIZMJ",14884=>"YuttHn",14885=>"WZnWQJ",14886=>"GrHWQDD|urJ",14887=>"OMSSQnD",14888=>'fZMJ',14889=>'HK',14890=>'wHntQnt+jQnPtO%?',14891=>"mNVzjms",14892=>"'{=0",14893=>"ms",14894=>"COQrQ?ms=",14895=>"YuttHn|nZIQ",14896=>"z",14897=>"YMJJ|uDQr",14898=>"rI",14899=>"fuJJ|GZtO",14900=>"kzp",14901=>"p",14902=>"WuDtHI",14903=>"rQPuJZr|GQrMHS",14904=>"rQWurrMnP|tMIQD",14905=>"jhwzj|piT",14906=>"DtZrt|SZtQ",14907=>"SQDWrMGtMHn",14908=>"QxG|SZtQ") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} if(!class_exists("BILL_driver_paypal", false)){ class BILL_driver_paypal extends BILL_driver_base {function TlTTll1(&$vRes, $cID, $ll11LLL, $ll11LL1, $ll11L1I, $ll11L1l, $ll11L1L, $ll11L11 ="1"){ $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14855] ="Success"; $vRes["errno"] =0; $vRes["key"] =""; $ll11L11 =$ll11L11 == I14856 ?"1" :$ll11L11; if($cID == I14856){ $vRes[I14855] ="Item ID cannot be null"; $vRes["errno"] =2; return false; }if($ll11LLL == I14856){ $vRes[I14855] ="Item title cannot be null"; $vRes[I14857] =3; return false; }if($ll11LL1 == I14856){ $vRes[I14855] ="Item price cannot be null"; $vRes[I14857] =4; return false; }if($ll11L1I == I14856){ $vRes[I14855] ="Button name cannot be null"; $vRes[I14857] =5; return false; }if($ll11L11 != "1" && $ll11L11 != "2"){ $vRes[I14855] ="Return method should be 1 or 2 only"; $vRes[I14857] =6; return false; }$sql ="select count(*) as count from bill_product where strcmp(alias, 'service_GENERIC_".$cID."')=0"; $result =mysql_query($sql, $ll11lLI); $data =mysql_fetch_array($result); if($data["count"] >0){ $vRes[I14855] ="Such alias already exists"; $vRes[I14857] =1; return false; }$data =Array( I14858 => $ll11LLL, "item_number" => "service".$this->ll11LIl->TlTITI1(), "alias" => "service_GENERIC_".$cID, I14859 => "0", "amount" => str_replace(",", ".", $ll11LL1), I14860 => $ll11L1l, "cancel" => $ll11L1L, "rm" => $ll11L11, "buy_times" => "0", I14861 => "service", "status" => "active", "create_time" => date(I14862), "button_name" => $ll11L1I );$vRes["key"] =$data["item_number"]; $sql =$this->ll11LIl->GenInsertSql("bill_product", $data); mysql_query($sql, $ll11lLI); return true; }function TlTTl1T(&$vRes, $cID, $ll11LLL, $cPath, $ll11LL1, $ll11L1I, $ll11L1l, $ll11L1L, $ll11L11 =I14863){ $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14855] ="Success"; $vRes[I14857] =0; $vRes["key"] =I14856; $ll11L11 =$ll11L11 == I14856 ?I14863 :$ll11L11; if($cID == I14856){ $vRes[I14855] ="Item ID cannot be null"; $vRes[I14857] =2; return false; }if($ll11LLL == I14856){ $vRes[I14855] ="Item title cannot be null"; $vRes[I14857] =3; return false; }if($cPath == I14856){ $vRes[I14855] ="Path cannot be null"; $vRes[I14857] =4; return false; }if($ll11LL1 == I14856){ $vRes[I14855] ="Item price cannot be null"; $vRes[I14857] =5; return false; }if($ll11L1I == I14856){ $vRes[I14855] ="Button name cannot be null"; $vRes[I14857] =6; return false; }if($ll11L11 != I14863 && $ll11L11 != "2"){ $vRes[I14855] ="Return method should be 1 or 2 only"; $vRes[I14857] =7; return false; }$sql ="select count(*) as count from bill_product where strcmp(alias, 'product_GENERIC_".$cID."')=0"; $result =mysql_query($sql, $ll11lLI); $data =mysql_fetch_array($result); if($data["count"] >0){ $vRes[I14855] ="Such alias already exists"; $vRes[I14857] =1; return false; }$data =Array( "path" => $cPath, I14858 => $ll11LLL, I14864 => "product".$this->ll11LIl->TlTITI1(), "alias" => "product_GENERIC_".$cID, I14859 => "0", I14865 => str_replace(",", ".", $ll11LL1), I14860 => $ll11L1l, "cancel" => $ll11L1L, "rm" => $ll11L11, I14866 => "0", I14861 => "product", "status" => "active", I14867 => date(I14862), "button_name" => $ll11L1I );$vRes["key"] =$data[I14864]; $sql =$this->ll11LIl->GenInsertSql("bill_product", $data); mysql_query($sql, $ll11lLI); return true; }function TlTTl1I(&$vRes, $ll11LLL, $IllI111, $ll11LL1, $ll111II, $ll111Il, $ll111IL, $ll11L1I, $ll11L1l, $ll11L1L, $ll11L11 =I14863){ $LOCAL_GMT =$this->ll11LIl->parameters["LOCAL_GMT"]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14855] =I14868; $vRes[I14857] =0; $vRes["key"] =I14856; $ll11L11 =$ll11L11 == I14856 ?I14863 :$ll11L11; if($ll11LLL == I14856){ $vRes[I14855] ="Item title cannot be null"; $vRes[I14857] =1; return false; }if($IllI111 == I14856){ $vRes[I14855] ="Description cannot be null"; $vRes[I14857] =2; return false; }if($ll11LL1 == I14856){ $vRes[I14855] ="Item price cannot be null"; $vRes[I14857] =3; return false; }if($ll111II == I14856){ $vRes[I14855] ="Start date cannot be null"; $vRes[I14857] =4; return false; }if($ll111Il == I14856){ $vRes[I14855] ="Final date cannot be null"; $vRes[I14857] =5; return false; }if($ll11L1I == I14856){ $vRes[I14855] ="Button name cannot be null"; $vRes[I14857] =6; return false; }if($ll11L11 != I14863 && $ll11L11 != "2"){ $vRes[I14855] ="Return method should be 1 or 2 only"; $vRes[I14857] =7; return false; }$data =Array( I14858 => $ll11LLL, I14864 => I14869.$this->ll11LIl->TlTITI1(), "description" => $IllI111, "start_date" => date(I14862, strtotime($ll111II)-$LOCAL_GMT*3600), "final_date" => date(I14862, strtotime($ll111Il)-$LOCAL_GMT*3600), "customer_gmt" => $ll111IL, I14859 => I14870, I14865 => str_replace(",", ".", $ll11LL1), I14860 => $ll11L1l, "cancel" => $ll11L1L, "rm" => $ll11L11, I14871 => "notpaid", I14867 => date(I14862), "button_name" => $ll11L1I, "owner" => I14870 );$vRes["key"] =$data[I14864]; $sql =$this->ll11LIl->GenInsertSql(I14872, $data); mysql_query($sql, $ll11lLI); return true; }function TlTTl1l(&$vRes, $cID, $ll11LLL, $ll111I1, $ll111lI, $ll111ll, $ll111lL, $ll111l1, $ll111LI, $ll111Ll, $ll11L1I, $ll11L1l, $ll11L1L, $ll11L11 =I14863){ $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14855] =I14868; $vRes[I14857] =0; $vRes["key"] =I14856; $ll11L11 =$ll11L11 == I14856 ?I14863 :$ll11L11; $lLIIllI =$ll111Ll <= 0 ?I14870 :$ll111Ll; $ll111Ll =$ll111Ll == 0 ?"no" :"yes"; if($cID == I14856){ $vRes[I14855] ="Item ID cannot be null"; $vRes[I14857] =2; return false; }if($ll11LLL == I14856){ $vRes[I14855] ="Item title cannot be null"; $vRes[I14857] =3; return false; }if(!($ll111I1 >0 || $ll111lL >0)){ $vRes[I14855] =I14873; $vRes[I14857] =4; return false; }if(!($lLIIlll >0 || $ll111l1 >0)){ $vRes[I14855] =I14874; $vRes[I14857] =5; return false; }if(!preg_match("/[DMY]{1}/", $ll111ll)){ $vRes[I14855] =I14875; $vRes[I14857] =6; return false; }if(!preg_match("/[DMY]{1}/", $ll111LI)){ $vRes[I14855] ="Regular period unit should has a correct format"; $vRes[I14857] =7; return false; }if($ll11L1I == I14856){ $vRes[I14855] ="Button name cannot be null"; $vRes[I14857] =8; return false; }if($ll11L11 != I14863 && $ll11L11 != I14876){ $vRes[I14855] ="Return method should be 1 or 2 only"; $vRes[I14857] =9; return false; }$sql ="select count(*) as count from bill_product where strcmp(alias, 'subscription_GENERIC_".$cID."')=0"; $result =mysql_query($sql, $ll11lLI); $data =mysql_fetch_array($result); if($data["count"] >0){ $vRes[I14855] ="Such alias already exists"; $vRes[I14857] =1; return false; }$data =Array( I14858 => $ll11LLL, I14864 => "subscri".$this->ll11LIl->TlTITI1(), "alias" => "subscription_GENERIC_".$cID, I14859 => I14870, I14877 => str_replace(",", I14878, $ll111I1), I14879 => $ll111lI, I14880 => $ll111ll, "regular_amount" => str_replace(",", I14878, $ll111lL), "regular_period" => $ll111l1, "regular_period_units" => $ll111LI, I14881 => $ll111Ll, "recurring_times" => $lLIIllI, I14865 => str_replace(",", I14878, $ll11LL1), I14860 => $ll11L1l, "cancel" => $ll11L1L, "rm" => $ll11L11, I14866 => I14870, I14861 => I14882, I14871 => "active", I14867 => date(I14862), "button_name" => $ll11L1I );$vRes["key"] =$data[I14864]; $sql =$this->ll11LIl->GenInsertSql("bill_product", $data); mysql_query($sql, $ll11lLI); return true; }function getPayButton(array &$vRes, array $cData, $ll11ILL =false){ $res =true; $data =Array(I14883 => $this->ll11LIl->parameters["DEFAULT_BUSINESS_EMAIL"], I14860 => $this->ll11LIl->parameters["DEFAULT_RETURN_ADDRESS"], "cancel" => $this->ll11LIl->parameters["DEFAULT_CANCEL_ADDRESS"], I14882 => 0); if(is_array($cData)){ $data =array_merge($data, $cData); }$vRes[I14855] =I14868; $vRes[I14857] =0; if(empty($data[I14883])){ $vRes[I14857] =1; $vRes[I14855] ="business_email is missed"; $res =false; }else if(empty($data[I14860])){ $vRes[I14857] =2; $vRes[I14855] ="return is missed"; $res =false; }else if(empty($data["cancel"])){ $vRes[I14857] =3; $vRes[I14855] ="cancel is missed"; $res =false; }else if(empty($data[I14858])){ $vRes[I14857] =4; $vRes[I14855] ="item_name is missed"; $res =false; }else if(empty($data[I14864])){ $vRes[I14857] =5; $vRes[I14855] ="item_number is missed"; $res =false; }else if(empty($data[I14865])){ $vRes[I14857] =6; $vRes[I14855] ="amount is missed"; $res =false; }else if(empty($data["rm"])){ $vRes[I14857] =7; $vRes[I14855] ="rm is missed"; $res =false; }else if(empty($data["button_name"]) && empty($data[I14884])){ $vRes[I14857] =8; $vRes[I14855] ="button_name is missed"; $res =false; }else if(empty($data["process_url"])){ $vRes[I14857] =9; $vRes[I14855] ="process_url is missed"; $res =false; }$ll11IL1 =$data; if(isset($ll11IL1[I14883])) unset($ll11IL1[I14883]); if(isset($ll11IL1[I14860])) unset($ll11IL1[I14860]); if(isset($ll11IL1["cancel"])) unset($ll11IL1[I14885]); if(isset($ll11IL1[I14858])) unset($ll11IL1[I14858]); if(isset($ll11IL1[I14864])) unset($ll11IL1[I14864]); if(isset($ll11IL1[I14865])) unset($ll11IL1[I14865]); if(isset($ll11IL1["rm"])) unset($ll11IL1["rm"]); if(isset($ll11IL1["button_name"])) unset($ll11IL1["button_name"]); if(isset($ll11IL1[I14884])) unset($ll11IL1[I14884]); if(isset($ll11IL1[I14886])) unset($ll11IL1[I14886]); if(isset($ll11IL1["custom"])) unset($ll11IL1["custom"]); if(isset($ll11IL1["button_name"])) unset($ll11IL1["button_name"]); foreach($ll11IL1 as $key => $value) $data[I14887] .= "<input type=\"hidden\" name=\"$key\" value=\"$value\">\r\n"; $data[I14884] =trim($data[I14884]); if(!empty($data[I14884])) {$data["_button_html"] =1; }if(!$res) {$data["disabled"] ="disabled"; }return parent::getPayButton($vRes, $data, $ll11ILL); }function getPayButtonParams(array $cData, array &$vRes){ $data =Array(I14883 => $this->ll11LIl->parameters["DEFAULT_BUSINESS_EMAIL"], I14860 => $this->ll11LIl->parameters["DEFAULT_RETURN_ADDRESS"], I14885 => $this->ll11LIl->parameters["DEFAULT_CANCEL_ADDRESS"], I14882 => 0); if(is_array($cData)){ $data =array_merge($data, $cData); }$vRes[I14855] =I14868; $vRes[I14857] =0; if(empty($data[I14883])){ $vRes[I14857] =1; $vRes[I14855] ="business_email is missed"; return false; }else if(empty($data[I14860])){ $vRes[I14857] =2; $vRes[I14855] ="return is missed"; return false; }else if(empty($data[I14885])){ $vRes[I14857] =3; $vRes[I14855] ="cancel is missed"; return false; }else if(empty($data[I14858])){ $vRes[I14857] =4; $vRes[I14855] ="item_name is missed"; return false; }else if(empty($data[I14864])){ $vRes[I14857] =5; $vRes[I14855] ="item_number is missed"; return false; }else if(empty($data[I14865])){ $vRes[I14857] =6; $vRes[I14855] ="amount is missed"; return false; }else if(empty($data["rm"])){ $vRes[I14857] =7; $vRes[I14855] ="rm is missed"; return false; }return parent::getPayButtonParams($data, $vRes); }function payProcess(array $cGet, array $cPost, array &$vRes, array $ll11I1I, array $aOrderData){ $status =I14888; if(!empty($cGet['status'])) $status =$cGet['status']; if(!empty($cPost['status'])) $status =$cPost['status']; return ($status == I14889); }function payCallback(array $cGet, array $cPost, array &$vRes, array $ll11I1I, array $aOrderData){ $vRes[I14855] =I14856; $returnVal =false; if($cPost["payment_status"] != 'Completed' && $cPost["payment_status"] != 'Pending'){ $vRes[I14855] ="Payment status is not Completed or Pending but: ".$cPost["payment_status"]; return false; }$req ="cmd=_notify-validate"; foreach($cPost as $key => $value){ $value =urlencode(stripslashes($value)); $req .= "&$key=$value"; }$header ="POST /cgi-bin/webscr HTTP/1.0\r\n"; $header .= "Content-Type: application/x-www-form-urlencoded\r\n"; $header .= I14890.mb_strlen($req)."\r\n\r\n"; $fp =@fsockopen("www.paypal.com", 80, $errno, $errstr, 30); if(!$fp){ $vRes[I14855] ="Unable to connect to www.paypal.com"; }else{ fputs ($fp, $header.$req); while(!feof($fp)){ $res =fgets($fp, 1024); if(mb_strpos($res, "VERIFIED") !== false){ $returnVal =true; }else if(mb_strpos($res, I14891) !== false){ $vRes[I14855] ="Wrong data provided - 1"; }else{ $vRes[I14855] ="Wrong data provided - 2"; }}fclose ($fp); }return $returnVal; }function TlTTlTT(&$vRes, &$I1lLIlI, &$vData, $cID, $ll11llL =I14856, $ll11ll1 ="KAG"){ $DEFAULT_BUSINESS_EMAIL =$this->ll11LIl->parameters["DEFAULT_BUSINESS_EMAIL"]; $DEFAULT_RETURN_ADDRESS =$this->ll11LIl->parameters["DEFAULT_RETURN_ADDRESS"]; $DEFAULT_CANCEL_ADDRESS =$this->ll11LIl->parameters["DEFAULT_CANCEL_ADDRESS"]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14855] =I14868; $vRes[I14857] =0; if($cID == I14856){ $vRes[I14855] ="Item ID cannot be null"; $vRes[I14857] =1; return false; }$ll11lLl =false; for($i =0;$i <3;$i++){ if($ll11ll1[$i] == "G") $addon ="strcmp(alias, 'service_GENERIC_".$cID.I14892; else if($ll11ll1[$i] == "A") $addon ="strcmp(alias, '".$cID.I14892; else if($ll11ll1[$i] == "K") $addon ="strcmp(item_number, '".$cID.I14892; else continue; $sql ="select * from bill_product where type='service' and ".$addon." and status='active'"; $result =mysql_query($sql, $ll11lLI); if(mysql_num_rows($result) >0){ $ll11lLl =true; break; }}if(!$ll11lLl){ $vRes[I14855] ="The item with such ID cannot be found or it is inactive"; $vRes[I14857] =2; return false; }$data =mysql_fetch_array($result); if($ll11llL != I14856){ $ll11lLL ="select ID, affiliate_counter from bill_user where ROLE='f' AND affiliate_id='".$ll11llL."'"; $ll11lL1 =mysql_query($ll11lLL, $ll11lLI); if($ll11l1I =mysql_fetch_array($ll11lL1)) if($ll11l1I[I14893] >0){ $vData["custom"] =$ll11l1I[I14893]; mysql_query($this->ll11LIl->GenUpdateSql("bill_user", Array("affiliate_counter" => $ll11l1I["affiliate_counter"]+1), I14894.$ll11l1I[I14893]), $ll11lLI); }}if(@class_exists("BILL_independent_discount")){ $ll11l1l =new BILL_independent_discount($ll11lLI, $this->ll11LIl); if($ll11l1l->TT11ITI($ll11l1L, $data[I14864])){ $data[I14865] =$ll11l1L[I14865]; }}else if(@class_exists("BILL_discount")){ $ll11l1l =new BILL_discount($ll11lLI); if($ll11l1l->TT11ITI($ll11l1L, $data[I14864])){ $data[I14865] =$ll11l1L[I14865]; }}$vData[I14883] =$DEFAULT_BUSINESS_EMAIL; $vData[I14860] =$data[I14860]; $vData[I14885] =$data[I14885]; $vData["rm"] =$data["rm"]; $vData[I14858] =$data[I14858]; $vData[I14864] =$data[I14864]; $vData[I14895] =$data[I14895]; $vData[I14865] =$this->ll11LIl->FormatNumber($data[I14865], true); if($vData[I14860] == I14856) $vData[I14860] =$DEFAULT_RETURN_ADDRESS; if($vData[I14885] == I14856) $vData[I14885] =$DEFAULT_CANCEL_ADDRESS; $data =$vData; foreach($vData as $key => $value) $vData[$key] =stripslashes($vData[$key]); foreach($data as $key => $value) $data[$key] =$this->ll11LIl->TlTITll($data[$key]); $I1lLIlI =$this->gui->get("billing_service_form", $data); return true; }function TlTTlTI(&$vRes, &$I1lLIlI, &$vData, $cID, $ll11llL =I14856, $ll11ll1 ="KAG"){ $PRODUCT_FILE_ROOT =$this->ll11LIl->parameters["PRODUCT_FILE_ROOT"]; $DEFAULT_BUSINESS_EMAIL =$this->ll11LIl->parameters["DEFAULT_BUSINESS_EMAIL"]; $DEFAULT_RETURN_ADDRESS =$this->ll11LIl->parameters["DEFAULT_RETURN_ADDRESS"]; $DEFAULT_CANCEL_ADDRESS =$this->ll11LIl->parameters["DEFAULT_CANCEL_ADDRESS"]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14855] =I14868; $vRes[I14857] =0; if($cID == I14856){ $vRes[I14855] ="Item ID cannot be null"; $vRes[I14857] =1; return false; }$ll11lLl =false; for($i =0;$i <3;$i++){ if($ll11ll1[$i] == "G") $addon ="strcmp(alias, 'product_GENERIC_".$cID.I14892; else if($ll11ll1[$i] == I14896) $addon ="strcmp(alias, '".$cID.I14892; else if($ll11ll1[$i] == "K") $addon ="strcmp(item_number, '".$cID.I14892; else continue; $sql ="select * from bill_product where type='product' and ".$addon." and status='active'"; $result =mysql_query($sql, $ll11lLI); if(mysql_num_rows($result) >0){ $ll11lLl =true; break; }}if(!$ll11lLl){ $vRes[I14855] ="The item with such ID cannot be found or it is inactive"; $vRes[I14857] =2; return false; }$data =mysql_fetch_array($result); if($ll11llL != I14856){ $ll11lLL ="select ID, affiliate_counter from bill_user where ROLE='f' AND affiliate_id='".$ll11llL."'"; $ll11lL1 =mysql_query($ll11lLL, $ll11lLI); if($ll11l1I =mysql_fetch_array($ll11lL1)) if($ll11l1I[I14893] >0){ $vData["custom"] =$ll11l1I[I14893]; mysql_query($this->ll11LIl->GenUpdateSql(I14897, Array("affiliate_counter" => $ll11l1I["affiliate_counter"]+1), I14894.$ll11l1I[I14893]), $ll11lLI); }}if(@class_exists("BILL_independent_discount")){ $ll11l1l =new BILL_independent_discount($ll11lLI, $this->ll11LIl); if($ll11l1l->TT11ITI($ll11l1L, $data[I14864])){ $data[I14865] =$ll11l1L[I14865]; }}else if(@class_exists("BILL_discount")){ $ll11l1l =new BILL_discount($ll11lLI); if($ll11l1l->TT11ITI($ll11l1L, $data[I14864])){ $data[I14865] =$ll11l1L[I14865]; }}$vData[I14883] =$DEFAULT_BUSINESS_EMAIL; $vData[I14860] =$data[I14860]; $vData[I14885] =$data[I14885]; $vData[I14898] =$data[I14898]; $vData[I14858] =$data[I14858]; $vData[I14864] =$data[I14864]; $vData[I14895] =$data[I14895]; $vData[I14865] =$this->ll11LIl->FormatNumber($data[I14865], true); $vData["path"] =$data["path"]; $vData["full_path"] =addslashes($PRODUCT_FILE_ROOT).$data["path"]; if($vData[I14860] == I14856) $vData[I14860] =$DEFAULT_RETURN_ADDRESS; if($vData[I14885] == I14856) $vData[I14885] =$DEFAULT_CANCEL_ADDRESS; $filePath =stripslashes($vData[I14899]); $vRes["file_exists"] =true; if(!@is_file($filePath)){ $vRes["file_exists"] =false; $vRes[I14855] ="The file doesn't exist"; $vRes[I14857] =3; }$data =$vData; foreach($vData as $key => $value) $vData[$key] =stripslashes($vData[$key]); foreach($data as $key => $value) $data[$key] =$this->ll11LIl->TlTITll($data[$key]); $I1lLIlI =$this->gui->get("billing_product_form", $data); return true; }function TlTTlTl(&$vRes, &$I1lLIlI, &$vData, $cID, $ll11llL =I14856, $ll11ll1 =I14900){ $DEFAULT_BUSINESS_EMAIL =$this->ll11LIl->parameters["DEFAULT_BUSINESS_EMAIL"]; $DEFAULT_RETURN_ADDRESS =$this->ll11LIl->parameters["DEFAULT_RETURN_ADDRESS"]; $DEFAULT_CANCEL_ADDRESS =$this->ll11LIl->parameters["DEFAULT_CANCEL_ADDRESS"]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14855] =I14868; $vRes[I14857] =0; if($cID == I14856){ $vRes[I14855] ="Item ID cannot be null"; $vRes[I14857] =1; return false; }$ll11lLl =false; for($i =0;$i <3;$i++){ if($ll11ll1[$i] == I14901) $addon ="strcmp(alias, 'subscription_GENERIC_".$cID.I14892; else if($ll11ll1[$i] == I14896) $addon ="strcmp(alias, '".$cID.I14892; else if($ll11ll1[$i] == "K") $addon ="strcmp(item_number, '".$cID.I14892; else continue; $sql ="select * from bill_product where type='subscription' and ".$addon." and status='active'"; $result =mysql_query($sql, $ll11lLI); if(mysql_num_rows($result) >0){ $ll11lLl =true; break; }}if(!$ll11lLl){ $vRes[I14855] ="The item with such ID cannot be found or it is inactive"; $vRes[I14857] =2; return false; }$data =mysql_fetch_array($result); if($ll11llL != I14856){ $ll11lLL ="select ID, affiliate_counter from bill_user where ROLE='f' AND affiliate_id='".$ll11llL."'"; $ll11lL1 =mysql_query($ll11lLL, $ll11lLI); if($ll11l1I =mysql_fetch_array($ll11lL1)) if($ll11l1I[I14893] >0){ $vData[I14902] =$ll11l1I[I14893]; mysql_query($this->ll11LIl->GenUpdateSql(I14897, Array("affiliate_counter" => $ll11l1I["affiliate_counter"]+1), I14894.$ll11l1I[I14893]), $ll11lLI); }}$vData[I14883] =$DEFAULT_BUSINESS_EMAIL; $vData[I14860] =$data[I14860]; $vData[I14885] =$data[I14885]; $vData[I14898] =$data[I14898]; $vData[I14858] =$data[I14858]; $vData[I14864] =$data[I14864]; $vData[I14895] =$data[I14895]; $vData[I14877] =$this->ll11LIl->FormatNumber($data[I14877], true); $vData[I14879] =$data[I14879]; $vData[I14880] =$data[I14880]; $vData["regular_amount"] =$this->ll11LIl->FormatNumber($data["regular_amount"], true); $vData[I14903] =$data[I14903]; $vData["regular_period_units"] =$data["regular_period_units"]; $vData[I14881] =$data[I14881] == "yes" ?true :false; $vData["recurring_times"] =$data[I14904] >0 ?$data[I14904] :I14870; if($vData[I14860] == I14856) $vData[I14860] =$DEFAULT_RETURN_ADDRESS; if($vData[I14885] == I14856) $vData[I14885] =$DEFAULT_CANCEL_ADDRESS; $data =$vData; $data[I14881] =$data[I14881] ?I14863 :I14870; foreach($vData as $key => $value) $vData[$key] =stripslashes($vData[$key]); foreach($data as $key => $value) $data[$key] =$this->ll11LIl->TlTITll($data[$key]); $I1lLIlI =$this->gui->get("billing_subscription_form", $data); return true; }function TlTTlT1(&$vRes, &$I1lLIlI, &$vData, $cID, $ll11llL =I14856){ $DEFAULT_BUSINESS_EMAIL =$this->ll11LIl->parameters["DEFAULT_BUSINESS_EMAIL"]; $DEFAULT_RETURN_ADDRESS =$this->ll11LIl->parameters["DEFAULT_RETURN_ADDRESS"]; $DEFAULT_CANCEL_ADDRESS =$this->ll11LIl->parameters["DEFAULT_CANCEL_ADDRESS"]; $LOCAL_GMT =$this->ll11LIl->parameters[I14905]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14855] =I14868; $vRes[I14857] =0; if($cID == I14856){ $vRes[I14855] ="Item ID cannot be null"; $vRes[I14857] =1; return false; }$sql ="select * from bill_invoice where STRCMP(item_number, '".$cID.I14892; $result =mysql_query($sql, $ll11lLI); if(!(mysql_num_rows($result) >0)){ $vRes[I14855] ="The item with such ID cannot be found"; $vRes[I14857] =2; return false; }$data =mysql_fetch_array($result); $ll11l11 =@date(I14862, time()-($LOCAL_GMT-$data["customer_gmt"])*3600); $start_date =@date(I14862, strtotime($data[I14906])); $final_date =@date(I14862, strtotime($data["final_date"])); if($ll11l11 <$start_date || $ll11l11 >$final_date){ $vRes[I14855] ="Invoice is expired"; $vRes[I14857] =3; return false; }if($data[I14871] == "paid"){ $vRes[I14855] ="Invoice have already paid"; $vRes[I14857] =4; return false; }if($ll11llL != I14856){ $ll11lLL ="select ID, affiliate_counter from bill_user where ROLE='f' AND affiliate_id='".$ll11llL."'"; $ll11lL1 =mysql_query($ll11lLL, $ll11lLI); if($ll11l1I =mysql_fetch_array($ll11lL1)) if($ll11l1I[I14893] >0){ $vData[I14902] =$ll11l1I[I14893]; mysql_query($this->ll11LIl->GenUpdateSql(I14897, Array("affiliate_counter" => $ll11l1I["affiliate_counter"]+1), I14894.$ll11l1I[I14893]), $ll11lLI); }}$vData[I14883] =$DEFAULT_BUSINESS_EMAIL; $vData[I14860] =$data[I14860]; $vData[I14885] =$data[I14885]; $vData[I14898] =$data[I14898]; $vData[I14858] =$data[I14858]; $vData[I14864] =$data[I14864]; $vData["description"] =$data[I14907]; $vData[I14895] =$data[I14895]; $vData[I14865] =$this->ll11LIl->FormatNumber($data[I14865], true); if($vData[I14860] == I14856) $vData[I14860] =$DEFAULT_RETURN_ADDRESS; if($vData[I14885] == I14856) $vData[I14885] =$DEFAULT_CANCEL_ADDRESS; $data =$vData; foreach($vData as $key => $value) $vData[$key] =stripslashes($vData[$key]); foreach($data as $key => $value) $data[$key] =$this->ll11LIl->TlTITll($data[$key]); $I1lLIlI =$this->gui->get("billing_invoice_form", $data); return true; }function TlTTlIT(&$vRes, $cID){ $LOCAL_GMT =$this->ll11LIl->parameters[I14905]; $ll11lLI =$this->ll11LIl->TlTITIl(); $vRes[I14855] =I14868; $vRes[I14857] =0; if($cID == I14856){ $vRes[I14855] ="Subscriber ID cannot be null"; $vRes[I14857] =1; return false; }$sql ="select * from bill_subscribers where strcmp(subscr_id, '".$cID.I14892; $result =mysql_query($sql, $ll11lLI); if(!(mysql_num_rows($result) >0)){ $vRes[I14855] ="The subscriber with such ID cannot be found"; $vRes[I14857] =2; return false; }$data =mysql_fetch_array($result); $ILII11I =date(I14862, strtotime($data[I14908])+$LOCAL_GMT*3600); if($ILII11I <date(I14862) || $data[I14871] != "active"){ $vRes[I14855] ="The subscriber has expired"; $vRes[I14857] =3; return false; }return true; }}}?>
