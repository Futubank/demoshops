<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       38989 xkqwpwrszyrmrxixuxxulsxpnygnlwiymspnqpnmrmpzwipxqywyuuuwwqgqgnltzlyypnir
 */ ?><?php foreach(array(18338=>'MnMt`GOG',18339=>"GMWturQ|IZxCMStO",18340=>"CZtQrIZrK|ZJGOZ",18341=>"85",18342=>"PQnQrZtQ|GMWturQD",18343=>"DtZtMW|CZtQrIZrK",18344=>"DIZJJ|",18345=>'Qxt|MIZPQD',18346=>'GMWturQ',18347=>"DrW",18348=>"GMWturQ|CMStO",18349=>"OQMPOt",18350=>"|PQnjMnKTHgMW",18351=>'MS',18352=>"GZrZI",18353=>"",18354=>"GMWturQ",18355=>"tBGQ",18356=>"|EuZntMtB",18357=>"|DtZtuD",18358=>"nZIQ",18359=>"GrHGQrtB|MnfH",18360=>"WZrt",18361=>"tQIGJZtQD~WHIIHn|IHSuJQD|DQtD`tGJ",18362=>"tQIGJZtQD~JZnP~|",18363=>'Qn',18364=>'ZWtMHn',18365=>'ZDKGZrZID',18366=>'wjzddqd|gzTo',18367=>'qDOHGhrSQr`GOG',18368=>'_',18369=>'nuI',18370=>"rQWZJW",18371=>"EtB",18372=>"WurrQnWB",18373=>"GrHGmS",18374=>'`',18375=>"nHnQ",18376=>'DBDMnfH',18377=>'GQrDHn|tBGQ',18378=>"!?gQrDHn|tBGQ=",18379=>'SMDZYJQ|QrrHr|IZMJ',18380=>'uDQr',18381=>'DWrMGt|fuJJ|JMnK',18382=>'urJ',18383=>"FUNw|mNwjUsqd|gzTo",18384=>"tHtZJ",18385=>"SQfZuJt|tHtZJ",18386=>"tHtZJ|WHHKMQ|nZIQ",18387=>"YHSB|",18388=>"ZWtMvQ|DGQW|YJHWKD",18389=>"DQJQWtQS",18390=>"DQJ",18391=>"MS",18392=>"MS|GrHSuWt",18393=>"HCnQr|nZIQ",18394=>"MtQI",18395=>"DuYJMnK",18396=>"MS|GrHG",18397=>"WZt|nZv|SZtZ",18398=>"GrHG|MnfH",18399=>"rQDt",18400=>"CQMPOt",18401=>"HvQr|rQDt",18402=>"GrMWQ|nuJJ",18403=>"tBGQ|GrMWQ",18404=>"HrMPMnZJ|GrMWQ",18405=>"ZYDHJutQ|SMDWHunt",18406=>"DIZJJ|GMWturQ",18407=>"VDGJMttQr",18408=>"tHtZJ|QxZWt|vZJuQ",18409=>"WZrt|WZtZJHP|JMnK") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} $lLI111I =intval(isset($mode) && $mode == 'small'); if($lLI111I){ $lLI111l =$frn->SetsTemplate; CreateEshop($frn, true); }else{ $eshop =1; require_once $GLOBALS['DEFAULT_INCLUDES_PATH'] .I18338; }if(!function_exists("_GetPictures")) {function TlTlTl1($moduleName) {global $Core; $aOptions =Array(); $lLlLlLl =$Core->IssetModOption($moduleName, "generate_pictures"); $aNames =Array("generate_picture_postf", "generate_small_picture_postf", I18339, "picture_maxheight", "popup_picture_maxwidth", "popup_picture_maxheight", "small_picture_maxwidth", "small_picture_maxheight", "watermark_postf", "static_watermark"); $aOptions["watermark_method"] ="center"; $aOptions[I18340] ="100"; $aOptions["static_watermark_method"] ="center"; $aOptions["static_watermark_alpha"] =I18341; if($lLlLlLl) {$aNames += Array("watermark_method", I18340, "static_watermark_method", "static_watermark_alpha"); foreach($aNames as $optName) {if($Core->IssetModOption($moduleName, $optName)) {$aOptions[$optName] =$Core->GetModOption($moduleName, $optName); }else {$aOptions[$optName] =""; }}$aOptions[I18342] =$Core->GetModOption($moduleName, I18342); $aOptions["generate_bigger_image"] =$Core->GetModOption($moduleName, "generate_bigger_image"); }else {foreach($aNames as $optName) {$aOptions[$optName] =""; }$aOptions[I18342] =array(); $aOptions["generate_bigger_image"] =false; }if(!empty($aOptions[I18343]) && !is_file($GLOBALS["ROOT_PATH"].$aOptions[I18343])) {$aOptions[I18343] =""; }return $aOptions; }function _GetPictures($moduleName, &$aOptions, &$vItem) {global $frn; $vRes =array(); $vResP =array(); $level =3; foreach(array("popup_", "", I18344) as $picpref){ if(!empty($vItem[$picpref."picture"])){ $origFilePath =$vItem[$picpref."picture"]; $origFileLevel =$level; break; }$level --; }$oModule =$frn->Core->GetModule($moduleName); $lLlLlLL =new CMS_ActModule($frn, $frn->db, $oModule); $lLlLlLL->options =$aOptions; $ext =&$lLlLlLL->GetExtension('ext_images'); $lLlLlLL->ext['ext_images'] =&$ext; $lLlLlLL->ext[I18345]->Init($lLlLlLL->cms, $lLlLlLL->module, $lLlLlLL); foreach(array("", I18344) as $preffx){ $lLlLlL1 =false; $IIlLIIL =Array("action"=>"_genLinkToPic", "data"=> $_data =array($moduleName, $preffx, $origFilePath, $origFileLevel, $vItem[$preffx .I18346], $vItem['id'], &$vRes)); $lLlLlLL->TTT1lI1($IIlLIIL, array(I18345)); $lLlLlL1 =$vRes['_return']; if ($lLlLlL1) {$vItem[$preffx."picture_src"] =$picData["picture"] =$picData[I18347] =$vRes[I18347]; $vItem[$preffx."picture_title"] =$picData["title"] =$picData["alt"] =$vItem[$aOptions["name_field_name"]]; $vItem[$preffx.I18348] =$picData[$preffx.I18348] =$picData["width"] =$vRes["width"]; $vItem[$preffx."picture_height"] =$picData[$preffx."picture_height"] =$picData[I18349] =$vRes[I18349]; if($preffx == I18344) {$vItem["small_popup_picture"] =$vItem["small_picture"] =$frn->Gui->get("cart:item_small_picture", $picData); }$lLlLlL1 =false; $IIlLIIL =Array("action"=>I18350, "data"=> $_data =array($moduleName, 'popup_', $origFilePath, $origFileLevel, isset($vItem["popup_picture"]) ?$vItem["popup_picture"] :null, $vItem[I18351], &$vRes)); $lLlLlLL->TTT1lI1($IIlLIIL, array(I18345)); $lLlLlL1 =$vRes['_return']; if($lLlLlL1) {if($preffx == "" || empty($vItem["picture"])) {$vItem["popup_picture_src"] =$picData[I18347] =$vResP[I18352]; $vItem["popup_picture_width"] =$picData["width"] =$vResP["width"]; $vItem["popup_picture_height"] =$picData[I18349] =$vResP[I18349]; if($preffx == I18353) $vItem["picture"] =$frn->Gui->get("cart:item_popup_picture", $picData); }if($preffx == I18344) $vItem["small_popup_picture"] =$frn->Gui->get("cart:item_small_popup_picture", $picData); }else if($preffx == I18353){ $vItem[I18354] =$frn->Gui->get("cart:item_picture", $picData); }}}}function TlTlT1T($varName){ global $frn; $res =isset($frn->VarsPost[$varName]) ?$frn->VarsPost[$varName] :(isset($frn->VarsGet[$varName]) ?$frn->VarsGet[$varName] :null); if(!is_array($res)) {$res =array($res); }return $res; }function TlTlT1I(&$cms, &$oCart, &$lLlLl1I) {$res =false; $lLlLl1I =I18353; $lLlLl1l =$oCart->getNumberErrors(); if($lLlLl1l >0) {$lLlLl1L =$oCart->getErrors(); for($i=0;$i<$lLlLl1l;$i++) {if($lLlLl1L[$i]["type"] == "err") {$color ="red"; }elseif($lLlLl1L[$i][I18355] == "msg") {$color ="blue"; }$lLlLl11 =I18353; if(isset($lLlLl1L[$i]["quantity"]) && $lLlLl1L[$i]["quantity"] >1) {$lLlLl11 =I18356; $lLlLl1L[$i]["quantity"] .= I18353; }if($cms->TTITIIl($lLlLl1L[$i]["text"].$lLlLl11."_status")) {$lLlLl1I =$cms->AddStatusMsg($lLlLl1L[$i]["text"].$lLlLl11.I18357, $color, I18353, I18353, $lLlLl1L[$i]); }elseif($cms->TTITIIl($lLlLl1L[$i]["text"].I18357)) {$lLlLl1I =$cms->AddStatusMsg($lLlLl1L[$i]["text"].I18357, $color, I18353, I18353, $lLlLl1L[$i]); }if($cms->TTITIIl($lLlLl1L[$i]["text"].$lLlLl11)) {$lLlLl1L[$i]["name"] =jparse(unhtmlentities($lLlLl1L[$i][I18358])); $lLlLl1L[$i]["property_info"] =jparse(unhtmlentities($lLlLl1L[$i]["property_info"])); $cms->AddStatusMsg($lLlLl1L[$i]["text"].$lLlLl11, $color, I18353, I18353, $lLlLl1L[$i]); }elseif($cms->TTITIIl($lLlLl1L[$i]["text"])) {$lLlLl1L[$i][I18358] =jparse(unhtmlentities($lLlLl1L[$i][I18358])); $lLlLl1L[$i][I18359] =jparse(unhtmlentities($lLlLl1L[$i][I18359])); $cms->AddStatusMsg($lLlLl1L[$i]["text"], $color, I18353, I18353, $lLlLl1L[$i]); }}$oCart->cleanErrors(); $res =true; }return $res; }}$oEshop =&$frn->Eshop; $mEshopOrder =&$frn->Core->GetModule($oEshop->ownerName."_order"); $itemId =isset($frn->VarsPost[I18351]) ?$frn->VarsPost[I18351] :(isset($frn->VarsGet[I18351]) ?$frn->VarsGet[I18351] :0); if(!empty($itemId)) {$tmp =explode("_", $itemId); if(is_array($tmp)) {$lLlLLII =sizeof($tmp); if($lLlLLII >1 && $frn->Core->IsOwnerInstalled($tmp[0])) {$ownerName =$tmp[0]; $oEshop->initByOwnerName($ownerName); $itemId =intval($tmp[1]); }else if($lLlLLII >0) {$itemId =intval($tmp[0]); }if($lLlLLII >2) {$itemPropId =$tmp[2]; }}unset($tmp); }$frn->SetsTemplate ="cart"; $frn->Gui->AddBlock(I18360, I18361, true); $frn->Gui->mergeBlock(I18360,"templates/".$oEshop->ownerName."_cart.tpl"); $frn->Words += $frn->Gui->ParseLangFile("templates/lang/".$oEshop->ownerName."_cart.lng"); $frn->InitMessages($frn->Gui->ParseLangFile(I18362.$oEshop->ownerName."_cart_msgs.lng")); $mEshopCart =&$frn->Core->GetModule($oEshop->ownerName."_cart"); CreateCart($frn, $oSession); if($frn->Member->Cart->currency == I18353 || !$mEshopCart->GetOption('allow_to_select_currency')) {$defCur =$mEshopCart->GetOption("default_currency"); $frn->Member->Cart->currency =isset($defCur[$lang_data]) ?$defCur[$lang_data] :$defCur[I18363]; }$_tmp =I18353; $lLlLLIl =TlTlT1I($frn, $frn->Member->Cart, $_tmp); if($lLI111I){ if(isset($special) && $special == 1){ $lLlLLIL =!$mEshopCart->GetOption("disable_dynamic_specblock"); $Core->Cache->TT1TI1I("spec_eshop_cart", $lLlLLIL); $oCart =&$frn->Member->Cart; EventApplyVars($frn, $oEshop->ownerName."_order_action", $NONE); if(isset($frn->Vars['action']) && in_array($frn->Vars[I18364], array('del', 'empty', 'recalc', 'add', I18365, 'process', 'PaymentSuccess'))){ if($frn->Vars[I18364] == 'PaymentSuccess') {$frn->Vars[I18364] ='process'; }require_once $GLOBALS[I18366] .'billing.php'; require_once $GLOBALS[I18366] .$GLOBALS['lLIll1I']['BASE_DRIVER'] .'.php'; require_once $GLOBALS[I18366] .I18367; $oOrder =new EshopOrder(); $oOrder->aCurrency =&$oEshop->aCurrency; $lLlLLI1 =&$frn->Core->GetModule("billing"); $driverName =$lLlLLI1->GetOption("driver"); if(!empty($frn->Vars['billing_driver']) && !empty($frn->VarsPost['person_type_name']) && mb_strpos(I18368.$mEshopOrder->TTlITIl('allowed_drivers', $frn->VarsPost['person_type_name']).I18368, I18368.$frn->Vars['billing_driver'].I18368) !== false) {$driverName =$frn->Vars['billing_driver']; }$lLlLLlI =TlTll1T($driverName, $frn->Gui, $lLlLLI1, $oEshop->dbTablePrefix, $lang_data); $oCart->cleanup(); $oCart->recalcTotal($db, true); $numPrice =isset($frn->VarsPost[I18369]) ?$frn->VarsPost[I18369] :(isset($frn->VarsGet[I18369]) ?$frn->VarsGet[I18369] :null); $lLlLLll =false; $lLlLLlL =false; switch ($frn->Vars["action"]) {case "del" :if($itemId >0) {$lLlLLlL =true; $numPrice =intval($numPrice); $oCart->remove($itemId, $numPrice, $itemPropId); }else {$action ="none"; }break; case "empty" :$lLlLLlL =true; $oCart->init(); break; case I18370 :$minUnit =$mEshopOrder->getOption("minimal_unit"); $allowFloat =$mEshopOrder->getOption("allow_fractional_quantity"); if(is_array($frn->VarsPost["qty"]) && sizeof($frn->VarsPost["qty"]) >0) {$lLlLLlL =true; $oEshop->saveCurrentConfig(); foreach ($frn->VarsPost[I18371] as $i => $qty) {$tmp =explode("_", $i); $oEshop->initByOwnerName($tmp[0]); $oCart->set($tmp[1], $qty, $tmp[2], $tmp[3]); }if (isset($frn->VarsPost['currency']) && isset($oEshop->aCurrency[$frn->VarsPost['currency']]) && $mEshopCart->GetOption('allow_to_select_currency')) {$oCart->currency =$frn->VarsPost[I18372]; }$oEshop->setSavedConfig(); }else {$action ="none"; }break; case "add" :$lIIL1Il =TlTlT1T("itemId"); $lLlLLl1 =TlTlT1T(I18371); $lLlLLLI =TlTlT1T("num"); $lLlLLLl =TlTlT1T(I18373); $lLlLLLL =TlTlT1T("price"); $lLlLLL1 =(sizeof($lIIL1Il) == 1); if($lLlLLL1) {$lIIL1Il[0] =intval($lIIL1Il[0]); }$lLlLL1I =(sizeof($lLlLLLI) == 1); if($lLlLL1I) {$lLlLLLI[0] =intval($lLlLLLI[0]); }$lLlLL1l =(sizeof($lLlLLLl) == 1); if($lLlLL1l) {$lLlLLLl[0] =max(-1, intval($lLlLLLl[0])); }$lLlLL1L =(sizeof($lLlLLLL) == 1); if($lLlLL1L) {$lLlLLLL[0] =floatval(str_replace(',', '.', $lLlLLLL[0])); }$lLlLL11 =false; $unrealPropIdCounter =0; $lLlL1II =!(isset($frn->VarsPost[I18371]) || isset($frn->VarsGet[I18371])); foreach($lLlLLl1 as $index => $qty) {if($qty == 0 && $lLlL1II) {$qty =1; }$itemId =($lLlLLL1 ?$lIIL1Il[0] :intval($lIIL1Il[$index])); $numPrice =($lLlLL1I ?$lLlLLLI[0] :intval($lLlLLLI[$index])); $itemPropId =($lLlLL1l ?$lLlLLLl[0] :max(-1, intval($lLlLLLl[$index]))); $itemPropId =(($itemPropId == -1) ?($itemPropId -$unrealPropIdCounter++): $itemPropId); $itemPrice =($lLlLL1L ?$lLlLLLL[0] :floatval(str_replace(',', I18374, $lLlLLLL[$index]))); if($itemId >0 && $qty >0) {$oCart->add($itemId, $qty, $numPrice, $itemPropId, $itemPrice); $lLlLL11 =true; }}if($lLlLL11) {$lLlLLlL =true; $lLlLLll =true; $frn->Vars[I18364] ='none'; $frn->Core->Cache->Disable(); }else {$action ="none"; }break; case "askparams" :if ($oCart->itemcount()>0) {$lLlLLlL =true; if($lLlL1Il == $oCart->getProductidList()) {}else {$lLlL1IL ="cart_changed"; }}else {$action =I18375; }break; case "process" :$lLlL1I1 =true; if ($oCart->itemcount()>0) {$lLlLLlL =true; require_once $GLOBALS[I18366] .I18367; $I1lLIlI =Array(); class TMP_PaymentSystemDriver extends AMI_PaymentSystemDriver{} $lLlL1lI =new TMP_PaymentSystemDriver($cms->Gui); $aTmp =array(); $order_id =$lLlL1lI->getProcessOrder($frn->VarsGet, $frn->VarsPost, $aTmp, array()); if($order_id <= 0 && !empty($frn->Vars["billing_driver"])) {TlTll1l($frn, $lLlLLI1, $lLlLLlI, $frn->Vars["billing_driver"], $lang_data, $oEshop->dbTablePrefix); $lLlL1ll =Array(); if(is_object($lLlLLlI)) {if(!isset($vRes) || !is_array($vRes)){ $vRes =array(); }$order_id =intval($lLlLLlI->getProcessOrder($frn->VarsGet, $frn->VarsPost, $vRes, $lLlL1ll)); }}if($order_id >0){ $sql ="SELECT sysinfo, status, tax, excise_tax, shipping_tax, shipping, total FROM cms_es_orders WHERE id='$order_id' AND id_member='".$frn->Member->getUserInfo(I18351)."'"; $db->query($sql); $db->next_record(); $aSysInfo =unserialize($db->Record[I18376]); unset($db->Record[I18376]); $aOrderData =$db->Record; $aOrderData['order_amount'] =$aOrderData['total'] +$aOrderData['tax']; if(!empty($aSysInfo['driver']) && !empty($aSysInfo[I18377]) && mb_strpos(I18368.$mEshopOrder->TTlITIl('allowed_drivers', $aSysInfo[I18377]).I18368, I18368.$aSysInfo['driver'].I18368) !== false) {$driverName =$aSysInfo['driver']; TlTll1l($frn, $lLlLLI1, $lLlLLlI, $driverName, $lang_data, $oEshop->dbTablePrefix); }else {AMI_Registry::push('disable_error_mail', true); trigger_error("Eshop: Inavalid data. Order=$order_id, Member=".$frn->Member->getUserInfo(I18351). I18378.$aSysInfo[I18377].", Payment_type=".$aSysInfo['payment_type']. ", Driver=".$aSysInfo['driver'], E_USER_ERROR); AMI_Registry::pop(I18379); }if($frn->Member->Cart->itemcount()>0) {$aCheckData =TlTll1I($GLOBALS['db'], $driverName); $aCheckData['script_full_url'] =$ROOT_PATH_WWW.$ActiveScriptFullLink; $aCheckData['lang_data'] =$lang_data; if(!isset($vRes) || !is_array($vRes)){ $vRes =array(); }$lLlL1lL =$lLlLLlI->payProcess($frn->VarsGet, $frn->VarsPost, $vRes, $aCheckData, $aOrderData); $lLlL1l1 =-1; if($mEshopOrder->GetOption("use_requirements_order") && $oSession->IssetVar("eshop_order_request_id")) {$lLlL1l1 =$oSession->GetVar("eshop_order_request_id"); }if($lLlL1lL) {$lLlL1LI ='accepted'; if ($lLlLLlI->TlTITIT()) {$oCart->init(); }}else {$lLlL1LI ='cancelled'; }$oOrder->updateStatus($frn, $order_id, 'user', $lLlL1LI); if($lLlL1l1 >0) {$oOrder->updateStatus($frn, $lLlL1l1, I18380, "requirements_".$lLlL1LI); }}}else{ $lLlL1I1 =false; }}break; }if($lLlLLlL) {$oCart->cleanup(); $oCart->recalcTotal($db, true); }$itemCount =$oCart->itemcountTpl(); $total =$oEshop->formatMoney($oCart->total, $oCart->currency); $oSession->addJsSessionCookie("eshop_cart_count", $itemCount); $oSession->addJsSessionCookie("eshop_cart_total", $total); $oSession->addJsSessionCookie("eshop_cart_total_plain", $oCart->total); if($frn->ActiveModule->issetAndTrueProperty('redirect_spec_to_cart') && (isset($frn->Vars['eshop_special']) && $frn->Vars['eshop_special']==1)) {if($lLlLLlL) {setCartSessionVar(true); $lLlLLIl =false; }$oSession->Location($ROOT_PATH_WWW.$mEshopCart->GetFrontLink()); }if($lLlLLlL && (isset($frn->Vars['eshop_cart_simple']) && $frn->Vars['eshop_cart_simple']==1)) {if($lLlLLlL){ $lIl1LlI =I18353; TlTlT1I($frn, $oCart, $lIl1LlI); setCartSessionVar(false); echo "cart updated|eshop_cart_count|eshop_cart_total|".unhtmlentities($lIl1LlI); }else{ echo "cart not updated|eshop_cart_count|eshop_cart_total|none"; }$conn->Out(); die(); }if($lLlLLll && !isset($frn->Vars["force_action"])){ $frn->Vars['url'] =base64_encode($GLOBALS['vGlobVars'][I18381]); }if(((isset($frn->Vars['eshop_special']) && $frn->Vars['eshop_special']==1) || $lLlLLll) && isset($frn->Vars['url']) && $frn->Vars['url'] != I18353) {if($lLlLLlL) {setCartSessionVar(true); $lLlLLIl =false; }$url =base64_decode($frn->Vars[I18382]); if(!isset($frn->Vars["force_action"])) {$reg1 ='/^(.+)(&|\\?)action=[^&]*(&.*)?$/'; $reg2 ='\\1\\2\\3'; $url =preg_replace($reg1, $reg2, $url); }$aUrl =explode("?", $url); if(isset($aUrl[1])) {require_once($GLOBALS[I18383]."func_url.php"); parse_str($aUrl[1], $IIl1Il1); mb_internal_encoding('UTF-8'); TlT1ITI($IIl1Il1); $lLlL1Ll =I18353; TlT1ITl($IIl1Il1, $lLlL1Ll); }$Core->Cache->Disable(); doRedirect($frn->Gui, $ROOT_PATH_WWW.$aUrl[0]."?".$lLlL1Ll, $conn); }if($lLlLLlL) {$_tmp =I18353; TlTlT1I($frn, $oCart, $_tmp); setCartSessionVar(false); $lLlLLIl =false; $oCart->cms =&$frn; }}else {$oCart->cleanup(); }$frn->SetsTemplate =$lLI111l; unset($special); }else {$lLlL1LL =Array(); if(is_object($frn->Member->Cart)) {$oCart =&$frn->Member->Cart; $lLlL1L1 =empty($oCart->cms); if($lLlL1L1){ $oCart->cms =$frn; }$lLlL1LL["_item_count"] =$oCart->itemcountTpl(); if($lLlL1L1){ unset($oCart->cms); }unset($lLlL1L1); $lLlL1LL[I18384] =$oEshop->formatMoney($oCart->total, $oCart->currency); if($lLlL1LL["_item_count"]>0) {$lLlL1LL['CART_NOT_EMPTY'] ="1"; }$lLlL1LL["default_item_count"] =0; $lLlL1LL[I18385] =$oEshop->formatMoney(0, $oCart->currency); $lLlL1LL["item_count"] =$lLlL1LL["_item_count"]; $lLlL1LL["item_count_cookie_name"] ="eshop_cart_count"; $lLlL1LL[I18386] ="eshop_cart_total"; $allowFloat =$mEshopOrder->getOption("allow_fractional_quantity"); $lLlL1LL['item_count'] =$frn->Gui->get("cart:item_count", $lLlL1LL); }EventApplyVars($frn, I18387.$oEshop->ownerName."_cart", $lLlL1LL); $lLlL11I =$frn->Gui->get("cart:special_menu_list", $lLlL1LL); $lLlL11l =$frn->Gui->getAbs("cart:body_special_block", 'special_menu_list', $lLlL11I); if($mEshopCart->issetProperty(I18388)){ $frn->SetSpecialBlock($mEshopCart->GetProperty(I18388), $lLlL11l); }elseif($mEshopCart->issetProperty("spec_blocks")){ $frn->SetSpecialBlock($mEshopCart->GetProperty("spec_blocks"), $lLlL11l); }}$lLI111I =0; if($lLlLLIl) {setCartSessionVar(false); $lLlLLIl =false; $oCart->cms =&$frn; }}else {if(in_array($ActiveModule, $frn->Core->GetProperty('disabled_se_indexing_mods'))){ $frn->Gui->setRobotsMeta(false); }$oCart =&$frn->Member->Cart; if($lLlLLIl) {setCartSessionVar(false); $lLlLLIl =false; $oCart->cms =&$frn; }$II111lL ="body_cart"; $frn->Member->Cart->calcPayment($db, $itemsArray, true, false, I18353); $countItems =sizeof($itemsArray) -1; if($countItems >0) {if($oEshop->ILlLLL1->IsInstalled() && $mEshopCart->GetOption('allow_to_select_currency')) {if(sizeof($oEshop->aCurrency) >1) {foreach($oEshop->aCurrency as $key=>$val) {if($key !=I18353 && isset($oEshop->aCurrency[$key]) && ($oEshop->aCurrency[$key]["on_small"] != 0 || $oEshop->aCurrency[$key]["is_base"] == 1)) {$option["value"] =$key; $option[I18358] =$oEshop->aCurrency[$key][I18358]; $option["code"] =$key; $option[I18389] =($oCart->currency == $key)?I18389:I18353; $lLlL11L["currency_sel_row"] .= $frn->TTITI1l("currency_sel", "row", $option); }}$lLlL11L["currency_sel"] =$frn->TTITI1l(I18372, I18390, $lLlL11L); }}if ($oEshop->otherPricesEnabled) {$lLlL11L["type_price_header"] =$frn->TTITI1l("type_price", "header", I18353); }$itemIds =Array(); for($index=0; $index <$countItems; $index++) {$itemIds[$itemsArray[$index]["owner_name"]][] =$itemsArray[$index][I18391]; }$oEshop->saveCurrentConfig(); foreach($itemIds as $ownerName=>$tmp) {$oEshop->initByOwnerName($ownerName); $sql ="SELECT i.id AS id_product, c.id AS cat_id, c.sublink".$oEshop->getPriceFields("c.price_caption%d")." FROM ".$oEshop->dbTablePrefix."_cats c INNER JOIN ".$oEshop->dbTablePrefix."_items i ON i.id_category=c.id WHERE i.id IN (".implode(",", $itemIds[$ownerName]).")"; $db->query($sql); $lLlL111 =Array(); while($db->next_record()) {for($i=0;$i<$oEshop->numPrices;$i++) {$aCaptions[$oEshop->priceFields[$i]] =$db->Record["price_caption".$oEshop->priceFields[$i]]; }$priceCaptions[$ownerName][$db->Record["id_product"]] =$aCaptions; $lLlL111[$db->Record[I18392]] =Array("cat_id"=>$db->Record["cat_id"], "sublink"=>$db->Record["sublink"]); }}$numOwners =sizeof($oEshop->aCloneOwners); $lLl1III =0; if($mEshopOrder->GetOption("use_requirements_order")) {$frn->Gui->AddGlobalVars(Array('SHOW_REST_COLUMN'=>'1')); }if($countItems >0) {$oEshop->saveCurrentConfig(); for($index=0; $index <$countItems; $index++) {if($index == 0 || $itemsArray[$index]["owner_name"] != $itemsArray[$index -1]["owner_name"]) {$oEshop->initByOwnerName($itemsArray[$index][I18393]); $frn->InitNavSettings($itemsArray[$index][I18393]."_item"); if($numOwners >0) {$ILLl11l["owner_title"] =$frn->Words[$itemsArray[$index][I18393]."_title"]; $lLlL11L["item_list"] .= $frn->TTITI1l(I18394, "owner_splitter", $ILLl11l); }}$ILLl11l =Array(); $id =$itemsArray[$index][I18391]; $ILLl11l["catid"] =$lLlL111[$id]["cat_id"]; $ILLl11l["catid_sublink"] =$lLlL111[$id][I18395]; $IL1L1l1 =$frn->ApplyNav($ILLl11l); if($oEshop->showDetailLink || !$aItem["descr_empty"]) {$ILLl11l[I18391] =$id; $ILLl11l["id_sublink"] =$itemsArray[$index][I18395]; }$ILLl11l =$frn->ApplyNav($ILLl11l); $ILLl11l[I18391] =$itemsArray[$index][I18393]."_".$id."_".$itemsArray[$index][I18396]; $ILLl11l["num_price"] =$itemsArray[$index]["price_number"]; $ILLl11l["variable_price"] =$itemsArray[$index]["variable_price"]; $ILLl11l[I18358] =$frn->TTITI1l(I18394, I18358, $itemsArray[$index][I18358]); $ILLl11l[I18397] =$IL1L1l1["nav_data"]; $ILLl11l["cat_name"] =$frn->Gui->get("cart:cat_name", $itemsArray[$index]); $ILLl11l["property_caption"] =TlTll11($itemsArray[$index][I18396], $frn->Member->Cart->ext, $itemsArray[$index][I18398], I18360); $ILLl11l["sku"] =$frn->TTITI1l(I18394, "sku", $itemsArray[$index]["sku"]); $qty =$oCart->getQuantity($itemsArray[$index][I18393], $id, $itemsArray[$index][I18396], $itemsArray[$index]["price_number"]); $ILLl11l[I18371] =$frn->TTITI1l(I18394, I18371, $qty); $ILLl11l[I18399] =$frn->TTITI1l(I18394, I18399, $itemsArray[$index][I18399]); $ILLl11l["total_weight"] =$frn->TTITI1l(I18394, "total_weight", $itemsArray[$index]["weight"] *$qty); $ILLl11l["weight"] =$frn->TTITI1l(I18394, I18400, $itemsArray[$index][I18400]); $ILLl11l["size"] =$frn->TTITI1l(I18394, "size", $itemsArray[$index]["size"]); $lLl1IIl =$qty -$itemsArray[$index][I18399]; if($qty >$itemsArray[$index][I18399]) {$ILLl11l["over_rest"] =$frn->TTITI1l(I18394, I18401, $lLl1IIl); }else {$ILLl11l[I18401] =$frn->TTITI1l(I18394, "over_rest_na", $lLl1IIl); }$price =$itemsArray[$index]["cur_price"]; if($itemsArray[$index]["price_null"]) {$ILLl11l["price"] =$frn->TTITI1l(I18394, I18402, I18353); }else {$ILLl11l["price"] =$oEshop->formatMoney($price, $oCart->currency); }if($oEshop->otherPricesEnabled) {if($itemsArray[$index]["price_number"] >0) {$caption =$priceCaptions[$ownerName][$id][$itemsArray[$index]["price_number"]]; $ILLl11l["type_price_col"] =$frn->TTITI1l(I18403, "col", Array(I18403 => $caption)); }else {$caption =$frn->Words["base_price_caption"]; }$ILLl11l["type_price_col"] =$frn->TTITI1l(I18403, "col", Array(I18403 => $caption)); }$ILLl11l[I18404] =$oEshop->formatMoney($itemsArray[$index][I18404], $oCart->currency); $ILLl11l["percentage_discount"] =empty($itemsArray[$index]["percentage_discount"]) ?"&nbsp;" :$itemsArray[$index]["percentage_discount"]; $lLl1III += ($d =$itemsArray[$index][I18405]); $ILLl11l[I18405] =$oEshop->formatMoney($d, $oCart->currency); $total =$qty *$oEshop->formatNumber($price, true, true); $total =$oEshop->formatNumber($total, true, false); $ILLl11l[I18384] =$frn->TTITI1l(I18394, I18384, $oEshop->getCurrencyString($total, $oCart->currency)); $lLl1IIL += $total; if(!isset($aOptions[$itemsArray[$index][I18393]])) {$aOptions[$itemsArray[$index][I18393]] =TlTlTl1($itemsArray[$index][I18393]."_item"); }$aPicData =Array(); $aPicData[I18391] =$itemsArray[$index][I18391]; $aPicData[I18354] =$itemsArray[$index][I18354]; $aPicData["popup_picture"] =$itemsArray[$index]["popup_picture"]; $aPicData["small_picture"] =$itemsArray[$index][I18406]; _GetPictures($itemsArray[$index][I18393]."_item", $aOptions[$itemsArray[$index][I18393]], $aPicData); $ILLl11l += $aPicData; EventApplyVars($frn, $II111lL, $ILLl11l); $lLlL11L["item_list"] .= $frn->TTITI1l(I18394, "row", $ILLl11l); $lLlL11L["item_list"] .= $frn->TTITI1l(I18394, I18407, I18353); }}$lLl1IIL =$itemsArray[$countItems]["price"]; $lLlL11L["grand_total_weight"] =$itemsArray[$countItems]["total_weight"]; $lLlL11L["total_value"] =$lLl1IIL; $lLlL11L[I18408] =$itemsArray[$countItems]["price_value"]; $lLlL11L[I18384] =$oEshop->formatMoney($lLl1IIL, $oCart->currency); $lLlL11L["grand_discount"] =$oEshop->formatMoney($lLl1III, $oCart->currency); $lLl1II1["cart_detail"] =$frn->TTITI1l(I18360, "detail", $lLlL11L); if($oEshop->mEshop->IsInstalled() && $oEshop->mEshop->IsFrontAllowed()) {$lLl1II1[I18409] =$frn->TTITI1l(I18360, "catalog_link", $oEshop->mEshop->GetFrontLink()); }$oEshop->setSavedConfig(); }else {$lLl1II1["cart_detail"] =$frn->TTITI1l(I18360, "empty", I18353); }$lLlLlLI =$frn->Gui->get("cart:$II111lL", $lLl1II1); $HtmlBody =$frn->Gui->getAbs(I18360, "body", $lLlLlLI); require $GLOBALS['DEFAULT_INCLUDES_PATH'] .'done.php'; }