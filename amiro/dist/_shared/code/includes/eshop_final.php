<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       5694 xkqwgxtqxngsgstsuluwzlpwptnslzxgpgpmlrztgwmnztnyyutiwlryqynkqkuqrtutpnir
 */ ?><?php foreach(array(18416=>'YMJJMnP`GOG',18417=>'wjzddqd|gzTo',18418=>'ZJJHCQS|SrMvQrD',18419=>'CI',18420=>'QDOHG~GZB|SrMvQrD~',18421=>'IHS|MS',18422=>'DBDMnfH',18423=>'SrMvQr',18424=>'_',18425=>"QrrHr",18426=>"QDOHG",18427=>"tMtJQ",18428=>'WHntQnt+tBGQ') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} $ActiveModule ="eshop_final"; $eshop =1; if($_SIDE == "front") {$skip_detect_page =1; require_once $GLOBALS['DEFAULT_INCLUDES_PATH'] .files_subpath .'detector.php'; }require_once $GLOBALS['DEFAULT_INCLUDES_PATH'] .'init.php'; require_once $GLOBALS['CLASSES_PATH'] .I18416; require_once $GLOBALS['CLASSES_PATH'] .$GLOBALS['lLIll1I']['BASE_DRIVER'] .'.php'; require_once $GLOBALS[I18417] .'EshopOrder.php'; $cms->Core->Cache->Disable(); $oEshop =&$frn->Eshop; $oOrder =new EshopOrder(); $oOrder->aCurrency =&$oEshop->aCurrency; $lLlLLI1 =&$frn->Core->GetModule("billing"); $driverName =$lLlLLI1->GetOption("driver"); $mEshopOrder =&$frn->Core->GetModule($oEshop->ownerName."_order"); class TMP_PaymentSystemDriver extends AMI_PaymentSystemDriver{} $lLlL1lI =new TMP_PaymentSystemDriver($cms->Gui); $aTmp =array(); $order_id =$lLlL1lI->getProcessOrder($frn->VarsGet, $frn->VarsPost, $aTmp, array()); if(!$order_id){ $lLl1Ill =array(); $aAllowedDrivers =$mEshopOrder->GetOption(I18418); $aDrivers =array(); foreach($aAllowedDrivers as $II1IILI){ $aDrivers += explode('|', $II1IILI); }foreach($aDrivers as $driverName){ if(isset($GLOBALS['BILLING_DRIVERS_ALIASES'][$driverName])){ require_once $GLOBALS[I18417] .'bill_' .($driverName == 'webmoney' ?I18419 :($driverName == 'authorize' ?'billing' :$driverName)) .'.php'; }require_once $GLOBALS['LOCAL_FILES_PATH'] .I18420 .$driverName .'/driver.php'; $lLIIL11 =BILL_services::TlTT11T($driverName); if(is_callable(array($lLIIL11, 'getOrderIdVarName'))){ $lLl1Ill[] =call_user_func(array($lLIIL11, 'getOrderIdVarName')); }}if(sizeof($lLl1Ill)){ $aTmp =array(); $order_id =$lLlL1lI->getProcessOrder($frn->VarsGet, $frn->VarsPost, $aTmp, array('aPossibleVarNames' => $lLl1Ill)); }}$aEvent =array( I18421 => $oEshop->ownerName."_order", 'order_id' => &$order_id, 'aGet' => $frn->VarsGet, 'aPost' => $frn->VarsPost );AMI_Event::fire('on_get_final_order_id', $aEvent, $oEshop->ownerName."_order"); $sql ="SELECT sysinfo, order_date, status, tax, excise_tax, shipping_tax, shipping, total FROM ".$oEshop->dbTablePrefix."_orders WHERE id='".intval($order_id)."'"; $db->query($sql); $db->next_record(); $aSysInfo =unserialize($db->Record[I18422]); unset($db->Record[I18422]); $aOrderData =$db->Record; $aOrderData['order_amount'] =$aOrderData['total'] +$aOrderData['tax']; $lLl1IlL =true; if(!empty($aSysInfo['driver']) && ($aSysInfo[I18423] == 'kupivkredit') && empty($lLIll1L)){ $lLl1IlL =false; }if(!empty($aSysInfo[I18423]) && !empty($aSysInfo['person_type']) && $lLl1IlL && mb_strpos('|'.$mEshopOrder->TTlITIl(I18418, $aSysInfo['person_type']).I18424, I18424.$aSysInfo[I18423].I18424) !== false) {$driverName =$aSysInfo[I18423]; TlTll1l($frn, $lLlLLI1, $lLlLLlI, $driverName, $lang_data, $oEshop->dbTablePrefix); }else {echo "Order not found"; $conn->Out(); die; }$url =getCurrentURL(); $aCheckData =TlTll1I($GLOBALS['db'], $driverName); $aCheckData['script_full_url'] =$url; $aCheckData['lang_data'] =$lang_data; $lLlL1lL =$lLlLLlI->payCallback($frn->VarsGet, $frn->VarsPost, $vRes, $aCheckData, $aOrderData); if($lLlL1lL == 1) {if($vRes[I18425] == "TEST") {}else {$oEshop->initByOwnerName("eshop"); $lLlL1lL =$oOrder->updateStatus($frn, $order_id, 'auto', 'confirmed'); $lLlLLlI->onPaymentConfirmed($order_id); }}else if($lLlL1lL != -1) {$oEshop->initByOwnerName(I18426); $oOrder->updateStatus($frn, $order_id, 'auto', 'rejected'); }$lLl1Il1 =$cms->Core->GetModOption("pages", "site_title"); $html[I18427] =$lLl1Il1[$lang]; $html["base"] =$cms->Gui->getTag("base"); $html["order_id"] =$order_id; $html['meta'] =$cms->Gui->getMeta(I18428); $frn->Gui->addBlock('eshop_final', 'templates/eshop_final.tpl', FALSE); $Content =$frn->Gui->get("eshop_final", $html); $conn->Sign($Content); echo $Content; $conn->Out(); die; 