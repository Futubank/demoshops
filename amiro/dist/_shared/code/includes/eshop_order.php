<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       112896 xkqwlsitzygslsgkngrzwzxszzsgsrkxtxpulkpmmyywlixnngwiutwuilnqqgzystrzpnir
 */ ?><?php foreach(array(18441=>"",18442=>"HrSQr",18443=>"GrHGmSjMDt",18444=>"rQWHrS|tBGQ",18445=>"rQDt",18446=>"DOMGGMnP|tZx",18447=>"MS",18448=>"DOMGGMnP|WHnfJMWtD",18449=>'WHuGHn|HCnQr',18450=>"fMrDtnZIQ",18451=>'',18452=>"HrSQr|nZIQ",18453=>'^',18454=>'DMnPJQ|MtQI|nZIQ',18455=>'DtZtuD',18456=>'MtQID',18457=>'DQJQWtQS|IQtOHS',18458=>'DOMGGMnP|WHnfJMWtD',18459=>'0',18460=>'GQrDHn|tBGQ',18461=>'MnMt`GOG',18462=>"YMJJMnP",18463=>'?',18464=>'WHuGHn',18465=>"fMQJSDQtD|HGtMHnD",18466=>'GHDtfMx',18467=>'_',18468=>"uDQ|DOMGGMnP|IHSuJQ",18469=>"nHnQ",18470=>"MD|ZPrQQ",18471=>'ZPrQQIQnt',18472=>"ZWtMHn",18473=>"funW|PuM`GOG",18474=>"ZSS",18475=>"QDOHG|HrSQr",18476=>'tZx|DBDtQI',18477=>"GurWOZDQ",18478=>'QrrHr',18479=>'YJZWK',18480=>"nZturZJ",18481=>'GQrDHn|tBGQ|nZIQ',18482=>'md|lURmsmwzj',18483=>"DtZtuD|CrHnP",18484=>'MG',18485=>'WHntZWt',18486=>'WHuntrB|WuDtHI',18487=>'WMtB',18488=>'IQIYQrD',18489=>'QIZMJ',18490=>'nHnQ',18491=>'uDQrnZIQ_GZDDCHrS',18492=>'DtZtuD|fHunS',18493=>'WuDtHI|SZtZ',18494=>"GZBIQnt|tBGQ|",18495=>'WOQWKQS',18496=>"GrHWQDDMnP",18497=>'|WuDtHI',18498=>'QDOHG|SMDWHunt',18499=>"JZDtnZIQ",18500=>"WHntZWt",18501=>"!?",18502=>"ZSSrQDD",18503=>"f|WHIIQntD",18504=>"GQrDHn|tBGQ|nZIQ",18505=>"!",18506=>"PQt|tBGQ|",18507=>'!',18508=>"nZIQ",18509=>"WZt|nZIQ",18510=>"DKu",18511=>"MtQI",18512=>"GrMWQ|WZGtMHn",18513=>"ZYDHJutQ|SMDWHunt",18514=>"GrMWQ|nuJJ",18515=>"tHtZJ|CQMPOt",18516=>"DMAQ",18517=>"MtQI|JMDt",18518=>"tZx|vZJuQ",18519=>"|tZx|WJZDDQD",18520=>"tZx",18521=>'ZYD',18522=>"tZx|rHC",18523=>"PrZnS|SMDWHunt",18524=>"DOMGGMnP",18525=>"DOMGGMnP|rHC",18526=>"DuYtHtZJ|rHC",18527=>'GQrDHnZJ|SMDWHunt',18528=>'tHtZJ',18529=>'PrZnS|tHtZJ',18530=>"rQEuMrQIQntD|SrZft",18531=>'GOHnQ',18532=>'uDQr',18533=>"YHSB|GurWOZDQ|fHrI",18534=>'ZWtMHn',18535=>"SrMvQr|nZIQ",18536=>"|",18537=>"|WHntrZWt|GrMnt|",18538=>'HrSQr|MS',18539=>"nH",18540=>"SrMvQr|WurrQnWB",18541=>"GrHGQrtB|WZGtMHn",18542=>"GrMWQ|nuIYQr",18543=>"GrMWQ",18544=>"HrMPMnZJ|GrMWQ",18545=>"tZx|MtQI|vZJuQ",18546=>"CQMPOt",18547=>"GQrWQnt",18548=>"GurWOZDQ|GrMnt",18549=>"QxWMDQ|tZx|vZJuQ",18550=>"fQQ|WHnDt",18551=>"?",18552=>"grMnt?QrrHr",18553=>'DOMGGMnP',18554=>'IQrWOZnt|MS',18555=>'YuDMnQDD|QIZMJ',18556=>"rQturn",18557=>"WZnWQJ",18558=>"WZJJYZWK",18559=>'rI',18560=>'HrSQr',18561=>'IHSJMnK',18562=>'JZDtnZIQ',18563=>'WuDtMnfH',18564=>'ZJJHCQS|SrMvQrD',18565=>'urJ',18566=>'wjzddqd|gzTo',18567=>'IQrWOZnt|WurrQnWB',18568=>"WHnDt",18569=>"GZB|WOZrPQ|WHnDt",18570=>'ZIHunt|fHrIZttQS',18571=>"ZIHunt",18572=>'WurrQnWB',18573=>'SrMvQrD',18574=>'GZB|ZIHunt',18575=>'fHrI',18576=>'GrHWQDDMnP|fHrI',18577=>'ZWWHunt',18578=>"ZSS|DOMGGMnP",18579=>'SrMvQr|nZIQ',18580=>"WOQWKHut|rQturn",18581=>"WOQWKHut|WZnWQJ",18582=>"WOQWKHut|WZJJYZWK",18583=>"WOQWKHut",18584=>'SQDWrMGtMHn',18585=>"GZDD|GOrZDQ",18586=>'fMrDtnZIQ',18587=>'WHIIQntD',18588=>'GZBDQrvMWQ|tGJ',18589=>'fQQ|Wurr',18590=>"coqRq?MS='",18591=>'WOQWKHut|fHrI',18592=>'rQDuJt|ZWWQGtQS',18593=>"rQDuJt|fHrI",18594=>'rQturn',18595=>'MS|QxtQrnZJ',18596=>'SZtQ|ZGGrHvQS',18597=>'PQt|tBGQ|nZIQ',18598=>'WuDtHI|MnfH',18599=>'MtQI|MnfH',18600=>'HrSQr|SZtZ|MtQI',18601=>'HrSQr|SZtZ',18602=>"?}",18603=>"QrrHr|IQDDZPQ",18604=>"uDQr|WHuntrB",18605=>'1',18606=>'_SQIH',18607=>'|GurWOZDQ`JnP',18608=>'WHIIQnt',18609=>'|MtQI',18610=>"DBDMnfH",18611=>'NhT|jhppqs|mN',18612=>"WOQWK|fHrI",18613=>'HGQrZtMHn|MS',18614=>'GOHnQ+QxtrZ',18615=>'OHuDQ',18616=>'fJZt',18617=>'WHSQ',18618=>'IQtrH',18619=>"DOHC|MntQrDQWtMHn",18620=>"FRhi?.",18621=>"{?",18622=>'WuDtHI|WHnSMtMHnD',18623=>"MS|tBGQ",18624=>"WHIIQntD",18625=>'MS',18626=>'nZIQ',18627=>'CZrn|WOZnPQ|HrSQr',18628=>"mNNqR?lhmN?.",18629=>"~\_\$~",18630=>"fMQJSDQtD",18631=>"GrHSuWtD|MnSMWQD",18632=>"fMQJSDQtD|EtB",18633=>"'",18634=>"DOMGGMnP|ZSSHn",18635=>'QDOHG',18636=>'zNs?.MS.?mN}:D{',18637=>'tBGQ') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} function TlTlT1l() {global $frn, $db; $aItems =$frn->Member->Cart->getItems(); $lII1ILI =Array(); $ext =&createEshopExtensionObject($frn); foreach($aItems as $ownerName => $aItemData) {$frn->Eshop->initByOwnerName($ownerName); $inClause =$frn->Member->Cart->getProductidList($ownerName); $lLl1ILL =Array(); if($inClause!="") {$addSql =Array("select"=>I18441, "from"=>I18441, "join"=>I18441, "where"=>I18441, "group"=>I18441, I18442=>I18441); $aCustom =Array(); $aCustom["sql_type"] ="prop_join"; $aCustom["prefix"] ="i"; $aCustom[I18443] =$frn->Member->Cart->getPropidList($ownerName); $none =false; $ext->ProcessAction($a ="add_extention_sql", 0, $addSql, $addSql, $aCustom); $sql ="SELECT i.id".$addSql["select"]." FROM ".$frn->Eshop->dbTablePrefix."_items i INNER JOIN ".$frn->Eshop->dbTablePrefix."_cats c ON i.id_category=c.id ".$addSql["join"]."WHERE i.id IN (".$inClause.") AND i.public=1"; $db->query($sql); $aCustom[I18444] ="item_record"; while($db->next_record()) {$ext->ProcessAction($a ="prepare_record", 0, $db->Record, $none, $aCustom); $lLl1ILL[$db->Record["id"]][intval($db->Record["propId"])] =$db->Record[I18445]; }$aRecord =Array(); $itemNum =0; }foreach($aItemData as $productId => $lLl1IL1) {foreach($lLl1IL1 as $itemPropId => $aPriceData) {$lLl1I1I =$lLl1ILL[$productId][$itemPropId]; $lLl1I1l =0; foreach($aPriceData as $priceNum => $qty) {$lII1ILI[$ownerName][$productId][$itemPropId][$priceNum] =0; if($lLl1I1l >$lLl1I1I) {$lII1ILI[$ownerName][$productId][$itemPropId][$priceNum] += $qty; }else {if(($lLl1I1l +$qty) >$lLl1I1I) {$lII1ILI[$ownerName][$productId][$itemPropId][$priceNum] += (($lLl1I1l +$qty) -$lLl1I1I); }}$lLl1I1l += $qty; }}}}$lLl1I1L =new Cart($frn); $lLl1I1L->init(); foreach($lII1ILI as $ownerName => $aItemData) {$frn->Eshop->initByOwnerName($ownerName); $lLl1I1L->simpleInit(); foreach($aItemData as $productId => $lLl1IL1) {foreach($lLl1IL1 as $itemPropId => $aPriceData) {foreach($aPriceData as $priceNum => $qty) {if($qty >0) {$lLl1I1L->add($productId, $qty, $priceNum, $itemPropId); if($qty == $aItems[$ownerName][$productId][$itemPropId][$priceNum]) {$frn->Member->Cart->remove($productId, $priceNum, $itemPropId); }else {$lLl1I11 =$aItems[$ownerName][$productId][$itemPropId][$priceNum] -$qty; $frn->Member->Cart->set($productId, $lLl1I11, $itemPropId, $priceNum); }}}}}}return $lLl1I1L; }function createOrder($itemsArray, &$oCart, $status) {global $frn, $mEshopOrder, $oOrder, $db, $_useShippingModule, $aCustomData, $aSysData, $aStatuses, $lang_data; $countItems =sizeof($itemsArray) -1; $order_id =0; if ($countItems >0) {$ll1LLI1 =Array(); for($index=0; $index <$countItems; $index++) {$id =$itemsArray[$index]["id"]; $ll1LLI1[] =$id; }if($frn->Eshop->otherPricesEnabled) {$priceInfo =$frn->Eshop->TITTIIT($itemsArray); $priceCaptions =$priceInfo["captions"]; }$oldTotal =$oCart->total; $frn->Eshop->setForceTaxOff(); $oCart->recalcTotal($db); $frn->Eshop->resetForceTaxOff(); $countItems =sizeof($itemsArray) -1; $tax =$itemsArray[$countItems]["tax_value"]; $excise_tax =$itemsArray[$countItems]["excise_tax"]; $shipping_tax =$itemsArray[$countItems][I18446]; $shipping =$itemsArray[$countItems]["shipping"]; $lIIII1L =&$frn->Core->GetModule($frn->Eshop->ownerName."_digitals"); $aExtInfo =Array(); if($lIIII1L->IsInstalled()) {$sql ="SELECT ef.id, ef.id_product, ef.original_fname FROM ".$frn->Eshop->dbTablePrefix."_items i, ".$frn->Eshop->dbTablePrefix."_files ef WHERE i.id IN('".implode("','",$ll1LLI1)."') AND i.item_type='eshop_digitals' AND i.id=ef.id_product ORDER BY ef.id_product"; $db->query($sql); $aExtInfo =Array(); while($db->next_record()) {$aExtInfo[$db->Record["id_product"]]["eshop_digitals"][$db->Record[I18447]]["name"] =$db->Record["original_fname"]; }}if ($_useShippingModule) {$aCustomData["shipping_conflicts"] =isset($frn->Vars["shipping_conflicts"]) ?$frn->Vars[I18448] :$shippingConflicts; }if (isset($frn->Vars["contact"])) {$aCustomData["contact"] =$frn->Vars["contact"]; }if (!empty($oCart->couponId) && $frn->Eshop->ILl1IIL === true) {$aCustomData['id_coupon'] =$oCart->couponId; $aCustomData[I18449] =$oCart->couponOwner; }if($status === 'draft'){ $status =''; $lLl1lII =TRUE; }$order_id =$oOrder->create($frn, $frn->Member->GetUserInfo(I18447), $frn->Member->GetUserInfo("username"), 'user', $status, $frn->VarsPost[I18450], $frn->VarsPost["lastname"], $frn->VarsPost["company"], $frn->VarsPost["email"], addslashes(serialize($aCustomData)), addslashes(serialize($aSysData)), '', I18451, $frn->VarsPost["comments"], array("tax" => $tax, "excise_tax" => $excise_tax, I18446 => $shipping_tax), $shipping, $oCart->total, $lang_data, $oCart->currency );$oCart->total =$oldTotal; $priceInfo =$frn->Eshop->TITTIIT($itemsArray); $aOwners =$oCart->InsertItems($itemsArray, $order_id, $priceInfo, $aExtInfo); $aTmp =Array("order_id"=>$order_id); $lLl1lIl =TlTlT11($aTmp, $itemsArray, $countItems, I18442); $I1lLIlI[I18452] =$lLl1lIl; $aSql =Array('name'=>$lLl1lIl, 'owners'=>';'.implode(";", $aOwners).I18453); $sql =$db->GenUpdateSQL("cms_es_orders", $aSql, "WHERE id='$order_id'"); $db->query($sql); if(isset($lLl1lII)){ $oOrder->updateStatus($frn, $order_id, 'user', 'draft'); }$aEvent =array( 'id' => $order_id );AMI_Event::fire('on_order_after_create', $aEvent, AMI_Event::MOD_ANY); }return $order_id; }function TlTlT11(&$lLl1lIL, &$itemsArray, $countItems, $setName) {global $frn; $lLl1lIL['single_item_name'] =I18451; $lLl1lIL['items_name_list'] =I18451; if($countItems==1) {$lLl1lIL['single_item_name'] =$itemsArray[0]['name']; }else {$separator =$frn->TTITI1l($setName, "item_name_separator"); for($i=0;$i<$countItems;$i++) {$lLl1lIL['single_item_name'] =$itemsArray[$i]['name']; $lLl1lIL['items_name_list'] .= $separator.$itemsArray[$i]['name']; }$lLl1lIL[I18454] =I18451; $lLl1lIL['items_name_list'] =mb_substr($lLl1lIL['items_name_list'], mb_strlen($separator)); }return $frn->TTITI1l($setName, "item_name", $lLl1lIL); }function TTIT1T1(array &$aVars){ foreach(array( 'action', I18455, 'item_number', 'order_id' )as $name){ if(isset($aVars['ami_' .$name])){ $aVars[$name] =$aVars['ami_' .$name]; }}}TTIT1T1($frn->Vars); TTIT1T1($frn->VarsGet); TTIT1T1($frn->VarsPost); $eshop =1; $lLl1lI1 =false; $lLl1llI =(bool)AMI_Registry::get('srv_get_available_shippings', false); $lLl1lll =AMI_Registry::get('srv_get_order_cost', false) ?true :false; if($lLl1llI || $lLl1lll){ $lLl1lI1 =true; }if($lLl1lll){ $lLl1llL =!empty($frn->VarsPost['json_data']) ?AMI_Lib_JSON::decode($frn->VarsPost['json_data'], true, true) :array(); if(is_array($lLl1llL)){ $frn->VarsPost["types_to_indices"] =array(); foreach($lLl1llL as $lLl1ll1 => $lLl1lLI){ $lLl1lLl =I18451; if(is_array($lLl1lLI[I18456])){ foreach($lLl1lLI[I18456] as $llLlLI1 => $itemData){ $lLl1lLl .= $llLlLI1.','; }$lLl1lLl =trim($lLl1lLl, ','); }if(sizeof($lLl1llL) == 1){ $frn->VarsPost["types_to_indices"][] =$lLl1lLl; $frn->VarsPost["get_type"] =isset($lLl1lLI[I18457]) ?$lLl1lLI[I18457] :$lLl1lLI['methods']['0']['id']; $frn->VarsPost['shipping_conflicts'] =$frn->Vars[I18458] ="show_intersection"; }else{ $frn->VarsPost["types_to_indices"][$lLl1ll1] =$lLl1lLl; $frn->VarsPost["get_type_".$lLl1ll1] =isset($lLl1lLI[I18457]) ?$lLl1lLI[I18457] :$lLl1lLI['methods'][I18459]['id']; $frn->VarsPost[I18458] =$frn->Vars[I18458] ="show_shipping_for_each_type"; }}}else{ $aOrderCostData =array('error' => 'invalid_json_data'); return; }if(!empty($frn->VarsPost[I18460])){ $frn->VarsPost['person_type_name'] =$frn->VarsPost[I18460]; }else{ $frn->VarsPost['person_type_name'] ='natural'; }}require_once $GLOBALS['DEFAULT_INCLUDES_PATH'] .I18461; if(!is_object($frn->Eshop)) {CreateEshop($frn, true); }if(in_array($ActiveModule, $frn->Core->GetProperty('disabled_se_indexing_mods'))){ $frn->Gui->setRobotsMeta(false); }$mEshopOrder =&$frn->Core->GetModule($frn->Eshop->ownerName."_order"); $lLl1lLL =&$frn->Core->GetModule($frn->Eshop->ownerName."_agreement"); $lLl1lL1 =&$frn->Core->GetModule($frn->Eshop->ownerName."_goods"); $lLlLLI1 =&$frn->Core->GetModule(I18462); $lLl1l1I =$lLl1lL1->IsInstalled(); $frn->InitMessages($frn->Gui->ParseLangFile($GLOBALS["LOCAL_FILES_REL_PATH"]."_admin/templates/lang/_".$frn->Eshop->ownerName."_purchase_msgs.lng")); $lLl1l1l =$mEshopOrder->GetOption('minimal_order_amount'); if ($lLl1l1l >0 && $frn->Eshop->convertCurrency($frn->Member->Cart->total, $frn->Member->Cart->currency, $frn->Eshop->baseCurrency) <$lLl1l1l) {$lLl1l1l =$frn->Eshop->getCurrencyPrefix($frn->Member->Cart->currency) .$frn->Eshop->convertCurrency($lLl1l1l, $frn->Eshop->baseCurrency, $frn->Member->Cart->currency) .I18463 .$frn->Eshop->getCurrencyPostfix($frn->Member->Cart->currency); $frn->AddStatusMsg('status_invalid_minimal_order_amount', 'red', I18451, I18451, array ('min' => $lLl1l1l)); if($lLl1lll){ $aOrderCostData['error'] ='invalid_minimal_order_amount'; return; }elseif($lLl1llI){ die('invalid_minimal_order_amount'); }$HtmlBody =I18451; require $GLOBALS['DEFAULT_INCLUDES_PATH'] .'done.php'; die; }if (isset($frn->VarsPost['coupon'])) {$lLl1l1L =$frn->Member->Cart->coupon; $frn->VarsPost[I18464] =trim($frn->VarsPost[I18464]); if ($frn->VarsPost[I18464] == I18451) {$frn->Member->Cart->couponId =$frn->Member->Cart->couponDiscountId =$frn->Member->Cart->couponDiscountParentId =0; }else {$frn->Member->Cart->couponId =$frn->Eshop->checkCoupon($frn->Member->Cart->couponDiscountId, $frn->Member->Cart->couponDiscountParentId, $frn->VarsPost[I18464]); $frn->Member->Cart->couponOwner =$frn->Eshop->ownerName; if (!$frn->Member->Cart->couponId) {$lLl1l11 =1; }}$frn->Member->Cart->coupon =$frn->VarsPost[I18464]; if ($lLl1l1L != $frn->VarsPost[I18464]) {$frn->Eshop->TT11lI1($frn->Eshop->ownerName); $frn->Eshop->TT1l1l1('options', array ('useTotalDiscounts', 'totalDiscountsArePresent', '_discountsDisabled', '_useProductsDiscountsSyncopationSum', '_useDiscountsSyncopationSum', '_discountsData', '_commonDiscountsEnabled' ));$frn->Member->Cart->recalcTotal($db); }if(!$lLl1lI1){ $lLl1LII =clone($frn->Member->Cart); setCartSessionVar(true, $lLl1LII); unset($lLl1LII); }}$lLl1LIl =$frn->Eshop->ownerName ."_shipping_methods"; $lLl1LIL =$frn->Core->GetModOption($lLl1LIl, I18465); $lLl1LI1 =$frn->Core->GetModOption($lLl1LIl, "use_yandex_fast_order"); $oShippingFieldsList =AMI::getResourceModel('eshop_shipping_fields/table')->getList(); $oShippingFieldsList ->addColumns(array('id', 'header', I18466)) ->addWhereDef('AND public = 1') ->addWhereDef(DB_Query::getSnippet('AND lang = %s')->q($lang_data)) ->addOrder('id', ' asc') ->load(); $lLl1LlI =array(); foreach($oShippingFieldsList as $oShippingFieldModelItem){ $lLl1LlI[] =$oShippingFieldModelItem->postfix; }$lLl1Lll =sizeof($lLl1LlI); foreach($lLl1LIL as $lLl1LlL => $lLl1Ll1){ $lLl1LLI =explode(I18467, $lLl1Ll1); foreach($lLl1LLI as $group){ preg_match("/\d+$/", $group, $matches); if(!in_array($matches[0], $lLl1LlI)){ $lLl1LlI[] =$matches[0]; $lLl1Lll += 1; }}}$_useShippingModule =$frn->Core->IsInstalled($lLl1LIl) && $frn->Core->GetModOption($lLl1LIl, I18468); if ($_useShippingModule) {$shippingConflicts =isset($frn->VarsPost[I18458]) ?$frn->Vars[I18458] :$frn->Core->GetModOption($lLl1LIl, I18448); }if(isset($frn->Vars['eshop_special']) && $frn->Vars['eshop_special']==1) {$frn->Vars["action"] =I18469; $frn->VarsGet["action"] =I18469; if(sizeof($frn->VarsPost) >0) {$frn->VarsPost["action"] =I18469; }}if($frn->Member->Cart->itemcount()>0 && $frn->Core->IsInstalled($frn->Eshop->ownerName."_agreement") && $lLl1lLL->IsPresentInPM() && !$lLl1lll) {if(!isset($frn->VarsCookie["is_agree"])) {if(isset($frn->VarsPost[I18470])) {SetLocalCookie(I18470, "1", 0); if(!is_object($oOrder)) {require_once $GLOBALS['CLASSES_PATH'] .'EshopOrder.php'; $oOrder =new EshopOrder(); $oOrder->aCurrency =&$frn->Eshop->aCurrency; }$oOrder->updateStatus($frn, $order_id, 'user', $aStatuses[I18471]); }else {$lLl1LLl =$lLl1lLL->GetOption("step_when_shown"); $frontLink =$lLl1lLL->GetFrontLink(); $lLl1LLL =false; switch($lLl1LLl) {case "before order": if($frn->Vars["action"] == I18469) {$lLl1LLL =true; }break; case "before confirm": if($frn->Vars[I18472] == "add") {$lLl1LLL =true; }break; case "before secure": if($frn->Vars[I18472] == "apply") {$lLl1LLL =true; }break; default: $lLl1LLL =false; }if($lLl1LLL) {require_once($GLOBALS["FUNC_INCLUDES_PATH"].I18473); if(sizeof($frn->VarsPost) == 0) {$frn->VarsGet["modlink"] =$frn->ActiveScript; TlT1TTT($frn->Gui, $frontLink, $frn->VarsGet, "agreement_", "add"); }else {TlT1TTT($frn->Gui, $frontLink, $frn->VarsPost, "agreement_", I18474); }}}}}$mMembers =&$frn->Core->GetModule("members"); $aStatuses =$mEshopOrder->GetOption('events_statuses'); $fast_register =$mEshopOrder->GetOption('fast_register'); if(!$lLl1lll){ if($fast_register){ if($frn->Vars[I18472] != I18469 && $frn->Vars[I18472] != "login" && $frn->Vars[I18472] != I18474){ $frn->Member->requireLogin($ROOT_PATH_WWW.$mMembers->GetFrontLink(), $ROOT_PATH_WWW.$mEshopOrder->GetFrontLink(), I18475); }}else{ $frn->Member->requireLogin($ROOT_PATH_WWW.$mMembers->GetFrontLink(), $ROOT_PATH_WWW.$mEshopOrder->GetFrontLink(), I18475); }}$numberDecimals =$frn->Eshop->mEshop->GetOption("number_decimal_digits"); if($frn->Vars[I18472]=="print") {$frn->SetsTemplate ="purchase_print"; }else {$frn->SetsTemplate ="purchase"; if ($frn->Eshop->_taxesData[I18476] == 'us') {$frn->Gui->addBlock("purchase","templates/".$frn->Eshop->ownerName."_purchase_us.tpl"); }else {$frn->Gui->addBlock(I18477,"templates/".$frn->Eshop->ownerName."_purchase.tpl"); }}if (isset($lLl1l11)) {$frn->AddStatusMsg('warn_wrong_coupon', 'red'); if($lLl1lll){ $aOrderCostData[I18478] ='warn_wrong_coupon'; }}if ($frn->Eshop->couponId >0 && $frn->Eshop->ILl1IIL === false && $frn->Vars['action'] == 'add') {$frn->AddStatusMsg('warn_coupon_not_applied', I18479); if($lLl1lll){ $aOrderCostData[I18478] ='warn_coupon_not_applied'; }}$II111lL =I18441; $lII11IL =false; if($mEshopOrder->GetOption('person_type_on')) {$lII11I1 =$mEshopOrder->GetOption('person_type_accessible_lang'); if(is_array($lII11I1)) {$lII11IL =in_array($frn->lang, $lII11I1); }else {$lII11IL =($lII11I1==$frn->lang); }}$lLl1LL1 =$mEshopOrder->GetOption('person_type_default'); if($lLl1LL1 != I18480 && $lLl1LL1 != "juridical") {$lLl1LL1 =I18480; }if($lII11IL) {$frn->Gui->AddGlobalVars(Array('IS_JURIDICAL_ON'=>'1')); if(empty($frn->VarsPost['person_type_name']) || !in_array($frn->VarsPost[I18481], array('natural', 'juridical'))){ $frn->VarsPost[I18481] =$lLl1LL1; }if($frn->VarsPost["person_type_name"] == "juridical") {$frn->Gui->AddGlobalVars(Array(I18482=>'1')); }}if($fast_register && $frn->Vars[I18472]=="login") {$IllIIIL =$frn->Member->getLoginField(); $username =stripslashes($frn->Vars["username"]); if(!empty($username) && !$frn->Member->verifyLogin($frn, $username, stripslashes($frn->VarsPost["password"]))) {$frn->AddStatusMsg(I18483, "red"); }$frn->Gui->addGlobalVars(Array("MEMBER_LOGGED_IN"=> ($frn->Member->isLoggedIn() ?"1" :"0"))); $frn->Vars[I18472] =I18469; }$memberStatus =true; if($fast_register && !$frn->Member->isLoggedIn() && $frn->Vars[I18472]==I18474 && !$lLl1lll){ $vMember =$frn->VarsPost; $vMember[I18484] =getenv("REMOTE_ADDR"); $vMember['address1'] =$frn->VarsPost['address']; $vMember['phone'] =$frn->VarsPost[I18485]; if($frn->Eshop->_taxesData[I18476] == 'us'){ $vMember['state'] =$frn->VarsPost['state_custom']; $vMember['country'] =$frn->VarsPost[I18486]; $vMember['zip'] =$frn->VarsPost['zip_custom']; $vMember['address2'] =$frn->VarsPost['address2_custom']; $vMember[I18487] =$frn->VarsPost['city_custom']; $lLl1L1I ='email|firstname|lastname|address1|phone|company|ip|state|country|zip|address2|city|phone'; }else{ $lLl1L1I ='email|firstname|lastname|address1|phone|company|ip|phone'; }$frn->Member->setUsed($lLl1L1I, true, true); $frn->Member->setObligatory('email|firstname|lastname|address1', true, true); if($frn->Core->IsFrontAllowed(I18488)){ $sql ="SELECT id FROM cms_members WHERE email='".$frn->VarsPost['email']."'"; $db->query($sql); $doesEMailExists =$db->num_rows() >0; $allowSameEMail =$mEshopOrder->GetOption('allow_user_email_double'); $doForceGenUsername =$doesEMailExists && $allowSameEMail && $frn->Member->getLoginField() == I18489; if($doesEMailExists && !$allowSameEMail){ sleep(1); $frn->AddStatusMsg("status_found_email", "red"); $memberStatus =false; $frn->Vars[I18472] =I18469; }elseif($doForceGenUsername && empty($frn->VarsPost['same_email'])){ $memberStatus =FALSE; $IIl1llI =TRUE; $frn->Vars['action'] =I18490; $frn->VarsPost['same_email'] =1; }}if($memberStatus){ $sendRegEmail =intval($mEshopOrder->GetOption("send_registration_email")); $lLl1L1l =$mMembers->getOption('confirmation_type'); $mMembers->setOption('confirmation_type', I18490); if($frn->Member->createMember($frn, $db, $vMember, $sendRegEmail, I18491, !empty($doForceGenUsername) && !empty($frn->VarsPost['same_email']), $doesEMailExists && $allowSameEMail)){ if(!$frn->Member->verifyLogin($frn, $vMember["username"], $vMember["password"])) {$frn->AddStatusMsg(I18483, "red"); }else {$id =$frn->Member->getUserInfo(I18447); $frn->Member->replaceUser($frn, $db, $id, 1); }$frn->Member->updateCacheStatus(); }else {$frn->AddStatusMsg(I18492, 'red', I18451, I18451, array('login_field' => $frn->Messages['login_field_' .$frn->Member->getLoginField()])); $memberStatus =false; $frn->Vars[I18472] =I18469; }$mMembers->setOption('confirmation_type', $lLl1L1l); unset($lLl1L1l); }}$I1lLIlI =$frn->Member->getUserInfo(); if(!is_array($I1lLIlI)) $I1lLIlI =Array(); $I1lLIlI += $frn->VarsPost; if(isset($I1lLIlI[I18493]) && is_array($I1lLIlI[I18493])){ $I1lLIlI =array_merge($I1lLIlI, $I1lLIlI[I18493]); }$I1lLIlI["custom_payment_type"] =(isset($frn->VarsPost['custom_payment_type'])) ?$frn->VarsPost['custom_payment_type'] :'cash'; $I1lLIlI[I18494 .$I1lLIlI["custom_payment_type"]] ="checked"; $I1lLIlI["person_type_name"] =(isset($frn->VarsPost[I18481])) ?$frn->VarsPost[I18481] :$lLl1LL1; $I1lLIlI["person_type_".$lLl1LL1] =I18495; $days =$mEshopOrder->GetOption("show_delivery_days"); $I1lLIlI['delivery_rows'] =I18451; for($i =intval($mEshopOrder->GetOption("min_delivery_days")); $i <$days; $i++) {$I1lLIlI['delivery_rows'] .= $frn->TTITI1l(I18496, "delivery_row", Array("date"=>date($frn->DFMT["php"], strtotime("+$i days")))); }$I1lLIlI["custom_fields"] =I18441; $aCustomData =Array(); foreach($frn->VarsPost as $name => $val) {if(mb_substr($name, -7) == I18497) {$var_name =mb_substr($name, 0, mb_strlen($name) -7); $var_value =stripslashes($frn->VarsPost[$name]); $I1lLIlI[$var_name] =$var_value; if($var_value != I18441) {$frn->VarsPost[$var_name] =$var_value; $frn->Member->TTI1I1l($var_name, $var_value); }$aCustomData[$var_name] =$var_value; $I1lLIlI["custom_fields"] .= "<input type='hidden' name='$name' value='$var_value'>\n"; }}if(!empty($I1lLIlI['phone'])) $I1lLIlI[I18485] =$I1lLIlI['phone']; $frn->Member->TTI1I11(); $aSysData =Array( I18460 => $frn->VarsPost[I18481], I18484=> getenv("REMOTE_ADDR") );if (isset($frn->VarsPost["custom_payment_type"])) {$aSysData["custom_payment_type"] =$frn->VarsPost["custom_payment_type"]; }if($frn->Member->Cart->itemcount() >0 && $frn->Member->isLoggedIn() && $frn->Vars['action'] != I18490){ $oCart->personalDiscount =array( 'amount' => $frn->Member->getUserInfo(I18498), 'type' => $frn->Member->getUserInfo('eshop_discount_type'), 'exp_date' => $frn->Member->getUserInfo('eshop_discount_exp_date') );}while ($frn->Vars[I18472] == I18474) {$I1lLIlI =array_merge($I1lLIlI, $frn->VarsPost); $passed =$memberStatus; $I1lLIlI[I18450] =stripslashes($frn->VarsPost[I18450]); $I1lLIlI[I18499] =stripslashes($frn->VarsPost[I18499]); $I1lLIlI["company"] =stripslashes($frn->VarsPost["company"]); $I1lLIlI["email"] =stripslashes($frn->VarsPost["email"]); $I1lLIlI[I18500] =stripslashes($frn->VarsPost[I18500]); if(!$frn->VarsPost["address"]){ $frn->VarsPost["address"] =$frn->Member->GetUserInfo("address1") .($frn->Member->GetUserInfo("address2") ?I18501.$frn->Member->GetUserInfo("address2") :I18441); }$I1lLIlI["address"] =nl2br(stripslashes($frn->VarsPost["address"])); $I1lLIlI["f_address"] =stripslashes($frn->VarsPost[I18502]); if($mEshopOrder->GetOption("use_requirements_order")) {$lLl1L1L =TlTlT1l(); }if($frn->Member->Cart->itemcount()>0) {$II111lL ="body_purchase_confirm"; $I1lLIlI["date"] =date($frn->DFMT["php"]); $I1lLIlI[I18503] =stripslashes($frn->VarsPost["comments"]); $I1lLIlI["comments"] =nl2br($I1lLIlI[I18503]); $custinfo =$frn->TTITI1l(I18477, "custinfo", $I1lLIlI); $I1lLIlI["f_custinfo"] =$custinfo; $I1lLIlI[I18504] =$frn->VarsPost[I18504]; if ($_useShippingModule && isset($frn->VarsPost["types_to_indices"]) && is_array($frn->VarsPost["types_to_indices"])) {if ($shippingConflicts == "show_intersection") {$frn->Member->Cart->selectedShippingMethodsToProductsIndices[$frn->VarsPost["get_type"]] =explode(I18505, $frn->VarsPost["types_to_indices"][0]); }else {$selectedShippingMethodsToProductsIndices =array ();$lLl1L11 =false; foreach ($frn->VarsPost["types_to_indices"] as $typeId => $lLl11II) {if (!isset($frn->VarsPost["get_type_" .$typeId])) {$lLl1L11 =true; break; }if (!isset($selectedShippingMethodsToProductsIndices[$frn->VarsPost["get_type_" .$typeId]])) {$selectedShippingMethodsToProductsIndices[$frn->VarsPost[I18506 .$typeId]] =array ();}$selectedShippingMethodsToProductsIndices[$frn->VarsPost[I18506 .$typeId]] =array_merge( $selectedShippingMethodsToProductsIndices[$frn->VarsPost[I18506 .$typeId]], explode(I18505, $frn->VarsPost["types_to_indices"][$typeId]) );}foreach ($selectedShippingMethodsToProductsIndices as $index => $row) {$selectedShippingMethodsToProductsIndices[$index] =array_unique($row); }$frn->Member->Cart->selectedShippingMethodsToProductsIndices =$lLl1L11 ?null :$selectedShippingMethodsToProductsIndices; unset($selectedShippingMethodsToProductsIndices); }if(!$lLl1lI1){ $lLl11Il =clone($frn->Member->Cart); setCartSessionVar(true, $lLl11Il); unset($lLl11Il); }}if ($_useShippingModule) {if (empty($frn->VarsPost['types_to_indices']) && isset($frn->VarsPost[I18464]) && isset($frn->VarsPost['shipping_methods_to_products'])) {$a =array ();foreach ($frn->VarsPost['shipping_methods_to_products'] as $shippingMethodId => $lLl11II) {$a[$shippingMethodId] =explode(I18507, $lLl11II); }$frn->Member->Cart->selectedShippingMethodsToProductsIndices =$a; }$lLl11IL =is_array($frn->Member->Cart->selectedShippingMethodsToProductsIndices); $shippingData =$lLl11IL ?$frn->Member->Cart->selectedShippingMethodsToProductsIndices :(isset($frn->VarsPost["shipping_methods_to_products"]) && is_array($frn->VarsPost["shipping_methods_to_products"]) ?$frn->VarsPost["shipping_methods_to_products"] :array ());$I1lLIlI["shipping_methods_to_products"] =I18441; foreach ($shippingData as $lLl11I1 => $lLl11II) {$I1lLIlI["shipping_methods_to_products"] .= $frn->Gui->getAbs("purchase:shipping_methods_to_products", array ("method_id" => $lLl11I1, "products" => $lLl11IL ?implode(I18505, $lLl11II) :$lLl11II ));}}$oldTotal =$frn->Member->Cart->total; $frn->Member->Cart->calcPayment($db, $itemsArray, false, true); $countItems =sizeof($itemsArray) -1; if ($countItems >0) {if($frn->Eshop->otherPricesEnabled) {$priceInfo =$frn->Eshop->TITTIIT($itemsArray); $priceCaptions =$priceInfo["captions"]; }$ll1LLI1 =Array(); $lLl1III =0; for($index=0; $index <$countItems; $index++) {$ILLl11l =Array(); $id =$itemsArray[$index][I18447]; $ll1LLI1[] =$id; $ILLl11l[I18508] =$frn->TTITI1l("item", I18508, $itemsArray[$index][I18508]); $ILLl11l["property_caption"] =TlTll11($itemsArray[$index]["id_prop"], $frn->Member->Cart->ext, $itemsArray[$index]["prop_info"], $frn->SetsTemplate); $ILLl11l[I18509] =$frn->Gui->get("purchase:cat_name", $itemsArray[$index]); $ILLl11l["sku"] =$frn->TTITI1l("item", "sku", $itemsArray[$index][I18510]); $qty =$oCart->getQuantity($itemsArray[$index]["owner_name"], $id, $itemsArray[$index]["id_prop"], $itemsArray[$index]["price_number"]); $ILLl11l["qty"] =$frn->TTITI1l(I18511, "qty", $qty); if($frn->Eshop->otherPricesEnabled) {if($itemsArray[$index]["price_number"] >0) {$caption =$priceCaptions[$id][$itemsArray[$index]["price_number"]]; }else {$caption =$frn->Words["base_price_caption"]; }if($caption != I18441) {$ILLl11l[I18512] =$frn->TTITI1l("price", "caption", Array(I18512 => $caption)); }}$ILLl11l["original_price"] =$oEshop->formatMoney($itemsArray[$index]["original_price"], $oCart->currency); $ILLl11l["percentage_discount"] =mb_strlen($itemsArray[$index]["percentage_discount"]) >0 ?$itemsArray[$index]["percentage_discount"] :"&nbsp;"; $lLl1III += ($d =$itemsArray[$index]["absolute_discount"]); $ILLl11l[I18513] =$oEshop->formatMoney($d, $oCart->currency); $price =$itemsArray[$index]["cur_price"]; $lLl11lI =$itemsArray[$index]["cur_price_tax"]; if($itemsArray[$index]["price_null"]) {$ILLl11l["price"] =$frn->TTITI1l(I18511, I18514, I18441); $ILLl11l["price_tax"] =$frn->TTITI1l(I18511, I18514, I18441); }else {$ILLl11l["price"] =$frn->Eshop->formatMoney($price, $oCart->currency); $ILLl11l["price_tax"] =$frn->Eshop->formatMoney($lLl11lI, $oCart->currency); }$ILLl11l["total_weight"] =$frn->TTITI1l(I18511, I18515, $itemsArray[$index]["weight"] *$qty); $ILLl11l["weight"] =$frn->TTITI1l(I18511, "weight", $itemsArray[$index]["weight"]); $ILLl11l[I18516] =$frn->TTITI1l(I18511, I18516, $itemsArray[$index][I18516]); $total =$qty *$oEshop->formatNumber($price, true, true); $ILLl11l["total"] =$frn->Eshop->formatMoney($total, $oCart->currency); $lII111I =$qty *$oEshop->formatNumber($lLl11lI, true, true); $ILLl11l["total_tax"] =$frn->Eshop->formatMoney($lII111I, $oCart->currency); EventApplyVars($frn, $II111lL, $ILLl11l); $I1lLIlI["item_list"] .= $frn->TTITI1l(I18511, "row", $ILLl11l); $I1lLIlI[I18517] .= $frn->TTITI1l(I18511, "Vsplitter", I18441); if($lLl1lll){ $aOrderCostData[I18456][] =$ILLl11l; }}$I1lLIlI["price_value"] =$itemsArray[$countItems]["price_value"]; $I1lLIlI["tax_value"] =$itemsArray[$countItems][I18518]; $lLl1IIL =$itemsArray[$countItems]["price"] +$itemsArray[$countItems]["tax"] +$itemsArray[$countItems]["shipping"]; if($frn->Core->IsInstalled($frn->Eshop->ownerName."_tax_classes") && $frn->Core->issetModOption($frn->Eshop->ownerName.I18519, "tax_scheme")){ $taxScheme =$frn->Core->GetModOption($frn->Eshop->ownerName.I18519, "tax_scheme"); }else{ $taxScheme =$frn->Eshop->mEshop->GetOption("tax_scheme"); }if($taxScheme != "no") {$I1lLIlI[I18520] =$frn->Eshop->formatMoney($itemsArray[$countItems][I18520], $oCart->currency); if ($frn->Eshop->_taxesData[I18476] == 'us' && $frn->Eshop->_taxesData['abs'] >0) {$I1lLIlI["excise_tax"] =$frn->Eshop->formatMoney($frn->Eshop->_taxesData['abs'], $oCart->currency); $lLl1IIL += $frn->Eshop->_taxesData[I18521]; }elseif ($frn->Eshop->_taxesData[I18476] == 'us') {$I1lLIlI["excise_tax"] =0; }$I1lLIlI["sales_tax_percent"] =$frn->Eshop->_taxesData['percent']; $I1lLIlI[I18522] =$frn->TTITI1l(I18477, I18522, $I1lLIlI); }$I1lLIlI["grand_total_weight"] =$itemsArray[$countItems][I18515]; $I1lLIlI["total_without_shipping"] =$frn->Eshop->formatMoney($lLl1IIL -$itemsArray[$countItems]["shipping"], $oCart->currency, false); $I1lLIlI["total"] =$frn->Eshop->formatMoney($lLl1IIL, $oCart->currency, false); if ($frn->Eshop->showDiscountsRow) {$I1lLIlI[I18523] =$frn->Eshop->formatMoney($lLl1III, $oCart->currency, false); $I1lLIlI["grand_discount_row"] =$frn->TTITI1l(I18477, "grand_discount_row", $I1lLIlI); }else {$I1lLIlI["grand_discount_row"] =I18441; }if($itemsArray[$countItems]["shipping"] != 0) {$I1lLIlI[I18524] =$frn->Eshop->formatMoney($itemsArray[$countItems][I18524], $oCart->currency); if($mEshopOrder->GetOption('shipping_checkbox_enable')) {$I1lLIlI["shipping_row"] =$frn->TTITI1l(I18477, "shipping_row_checkbox", $I1lLIlI); }else {$I1lLIlI["shipping_row"] =$frn->TTITI1l(I18477, I18525, $I1lLIlI); }}if($frn->Eshop->_taxesData[I18476] == 'us'){ if($taxScheme != "no"){ $I1lLIlI["subtotal"] =$frn->Eshop->formatMoney($lLl1IIL -$frn->Eshop->_taxesData[I18521] -$itemsArray[$countItems][I18520] -$itemsArray[$countItems][I18524], $oCart->currency); }else{ $I1lLIlI["subtotal"] =$frn->Eshop->formatMoney($lLl1IIL -$itemsArray[$countItems][I18524], $oCart->currency); }$I1lLIlI[I18526] =$frn->TTITI1l(I18477, I18526, $I1lLIlI); }$I1lLIlI['discount_coupon'] =$frn->Eshop->TT11llI(); if($frn->Member->getUserInfo(I18498)){ $tmp =$oCart->personalDiscount; $tmp['type'] =$tmp['type'] != I18521 ?'%' :$frn->Eshop->getCurrencyPrefix($frn->Eshop->baseCurrency) .$frn->Eshop->getCurrencyPostfix($frn->Eshop->baseCurrency); $I1lLIlI[I18527] =$frn->TTITI1l('purchase', I18527, $tmp); }if($lLl1lll){ $aOrderCostData['total'] =$itemsArray[sizeof($itemsArray) -1]; $aOrderCostData['total']['shipping'] =$I1lLIlI[I18524]; $aOrderCostData[I18528]['subtotal'] =isset($I1lLIlI["subtotal"]) ?$I1lLIlI["subtotal"] :0; $aOrderCostData[I18528]['grand_discount'] =isset($lLl1III) ?$lLl1III :I18451; $aOrderCostData[I18528][I18529] =$lLl1IIL; $frn->Member->Cart->total =$oldTotal; break; }$order_id =createOrder($itemsArray, $frn->Member->Cart, "draft"); $oOrder->updateStatus($frn, $order_id, 'user', $aStatuses['confirm']); if($mEshopOrder->GetOption("use_requirements_order")) {$lLl11ll =Array(); $lLl1L1L->calcPayment($db, $lLl11ll, false, true); $lLlL1l1 =createOrder($lLl11ll, $lLl1L1L, I18530); $oSession->SetVar("eshop_order_request_id", $lLlL1l1); $lLl1LII =clone($frn->Member->Cart); setCartSessionVar(true, $lLl1LII); unset($lLl1LII); unset($lLl11ll); unset($lLl1L1L); }$I1lLIlI["order_id"] =$order_id; }$frn->Member->Cart->total =$oldTotal; $lLl1II1["purchase_confirm"] =$frn->TTITI1l(I18477, "confirm", $I1lLIlI); $frn->Member->setObligatory('firstname|lastname|username',true,true); $frn->Member->updateMember($frn, $db, $frn->Member->getUserInfo(I18447), array('firstname'=>$frn->VarsPost['firstname'], 'lastname'=>$frn->VarsPost['lastname'], I18531=>$frn->VarsPost[I18485], 'username'=>$frn->Member->getUserInfo("username")), true );$frn->Member->replaceUser($frn, $db, $frn->Member->getUserInfo(I18447), 1); }else {if($lLl1lll){ $aOrderCostData[I18478] ='empty_cart'; return; }$IIl1llI =false; if($mEshopOrder->GetOption("use_requirements_order")) {$lLl11ll =Array(); $lLl1L1L->calcPayment($db, $lLl11ll, false, true); $lLlL1l1 =createOrder($lLl11ll, $lLl1L1L, I18530); $oOrder->updateStatus($frn, $lLlL1l1, I18532, "requirements_accepted"); $frn->Member->Cart->init(); $lLl11lL =clone($frn->Member->Cart); setCartSessionVar(true, $lLl11lL); unset($lLl11lL); $IIl1llI =true; $frn->Vars['action'] =I18451; $lLl1II1["purchase_form"] =$frn->TTITI1l(I18477, "requirements_accepted", I18441); $II111lL =I18533; }if(!$IIl1llI) {$lLl11l1 =$frn->Vars; $lLl11l1['description'] ='Error adding new order'; $lLl11l1['type'] ='empty_cart'; $frn->Vars[I18534] =I18478; }}break; }if($frn->Member->Cart->itemcount()>0 && $frn->Vars[I18472]=="print") {$lLl11LI =(isset($frn->VarsPost["driver_name"]) && $frn->VarsPost["driver_name"] != I18441 && isset($GLOBALS['BILLING_DRIVERS_ALIASES'][$frn->VarsPost[I18535]])); if($lLl11LI) {$frn->Gui->addBlock("purchase_print","templates/".$frn->Eshop->ownerName."_order_".mb_strtolower($GLOBALS['BILLING_DRIVERS_ALIASES'][$frn->VarsPost[I18535]]).I18536.$lang_data.".tpl"); }else {if(isset($frn->Vars["print_form"]) && $frn->Vars["print_form"] == "contract") {$lLl11Ll =I18537; }else {$lLl11Ll ="_order_print_"; }$frn->Gui->addBlock("purchase_print","templates/".$frn->Eshop->ownerName.$lLl11Ll.$lang_data.".tpl"); }$order_id =intval($frn->VarsPost[I18538]); $passed =1; if($frn->Member->Cart->itemcount()>0) {$II111lL ="body_purchase_print"; if($frn->Core->IsInstalled($frn->Eshop->ownerName.I18519) && $frn->Core->issetModOption($frn->Eshop->ownerName.I18519, "tax_scheme")){ $taxScheme =$frn->Core->GetModOption($frn->Eshop->ownerName.I18519, "tax_scheme"); }else{ $taxScheme =$frn->Eshop->mEshop->GetOption("tax_scheme"); }if($taxScheme != I18539) {$frn->Gui->AddGlobalVars(Array('ESHOP_TAX_ON' => '1')); }else {$frn->Gui->AddGlobalVars(Array('ESHOP_TAX_ON' => I18459)); }$lLl11LL =$frn->Member->Cart->currency; if(isset($frn->VarsPost["driver_currency"]) && $frn->VarsPost[I18540] != I18441) {$frn->Member->Cart->currency =$frn->VarsPost[I18540]; }if (isset($frn->VarsPost["shipping_methods_to_products"]) && is_array($frn->VarsPost["shipping_methods_to_products"])) {$frn->Member->Cart->selectedShippingMethodsToProductsIndices =array ();foreach ($frn->VarsPost["shipping_methods_to_products"] as $index => $value) {$frn->Member->Cart->selectedShippingMethodsToProductsIndices[$index] =explode(I18505, $value); }}$frn->Member->Cart->calcPayment($db, $itemsArray); $countItems =sizeof($itemsArray) -1; if($countItems >0) {if($frn->Eshop->otherPricesEnabled) {$priceInfo =$frn->Eshop->TITTIIT($itemsArray); $priceCaptions =$priceInfo["captions"]; }for($index=0; $index <$countItems; $index++) {$ILLl11l =Array(); $id =$itemsArray[$index][I18447]; $ILLl11l[I18508] =$itemsArray[$index][I18508]; $ILLl11l[I18509] =$itemsArray[$index][I18509]; $ILLl11l[I18541] =TlTll11($itemsArray[$index]["id_prop"], $frn->Member->Cart->ext, $itemsArray[$index]["prop_info"], $frn->SetsTemplate); $ILLl11l[I18510] =$itemsArray[$index][I18510]; $qty =$frn->Member->Cart->getQuantity($itemsArray[$index]["owner_name"], $id, $itemsArray[$index]["id_prop"], $itemsArray[$index][I18542]); $ILLl11l["quantity"] =$qty; if($itemsArray[$index][I18514]) {$ILLl11l["price"] =$frn->TTITI1l("price", "null", I18441); }else {$ILLl11l[I18543] =$frn->Eshop->formatMoney($itemsArray[$index]["cur_price"], $oCart->currency); }if($frn->Eshop->otherPricesEnabled) {if($itemsArray[$index][I18542] >0) {$caption =$priceCaptions[$id][$itemsArray[$index][I18542]]; }else {$caption =$frn->Words["base_price_caption"]; }if($caption != I18441) {$ILLl11l[I18512] =$frn->TTITI1l(I18543, "caption", Array(I18512 => $caption)); }}$ILLl11l["original_price"] =$oEshop->formatMoney($itemsArray[$index][I18544], $oCart->currency); $ILLl11l["percentage_discount"] =$itemsArray[$index]["percentage_discount"]; $lLl1III += ($d =$itemsArray[$index][I18513]); $ILLl11l[I18513] =$oEshop->formatMoney($d, $oCart->currency); $total =$qty *$oEshop->formatNumber($itemsArray[$index]["cur_price"], true, true); $tax =$itemsArray[$index][I18520]; $ILLl11l[I18520] =$frn->Eshop->formatMoney($tax, $oCart->currency); $total_tax =$frn->Eshop->formatMoney($total +$tax, $oCart->currency); $ILLl11l["total_tax"] =$total_tax; $ILLl11l[I18518] =$oEshop->TT11IlT($itemsArray[$index][I18545], $itemsArray[$index]["tax_type"], true, $oEshop->baseCurrency, $frn->Member->Cart->currency); $ILLl11l["total"] =$frn->Eshop->formatMoney($total, $oCart->currency); $ILLl11l[I18515] =$itemsArray[$index]["weight"] *$qty; $ILLl11l["weight"] =$itemsArray[$index][I18546]; $ILLl11l[I18516] =$itemsArray[$index][I18516]; EventApplyVars($frn, $II111lL, $ILLl11l); $I1lLIlI["purchase_print_item"] .= $frn->TTITI1l("purchase_print", I18511, $ILLl11l); }$lLl11L1 =$itemsArray[$countItems][I18520]; $lLl1IIL =$itemsArray[$countItems][I18543]; $lLl111I =$lLl11L1 +$lLl1IIL; if($mEshopOrder->GetOption("shipping_checkbox_enable") && !$frn->VarsPost["add_shipping"]) {$itemsArray[$countItems][I18524] =0; }if($itemsArray[$countItems][I18524] >0) {if($frn->Core->IsInstalled($frn->Eshop->ownerName.I18519) && $frn->Core->issetModOption($frn->Eshop->ownerName.I18519, I18446)){ $shippingTax =doubleval($frn->Core->GetModOption($frn->Eshop->ownerName.I18519, I18446)); }else{ $shippingTax =doubleval($frn->Eshop->mEshop->GetOption(I18446)); }$shipping =$itemsArray[$countItems][I18524]; $lLl111l =$frn->Eshop->TT11T1l($shipping, $shippingTax, I18547, "detach"); $lLl111L =Array(); $lLl111L[I18524] =$frn->Eshop->formatMoney($lLl111l, $oCart->currency); $lLl111L[I18446] =$frn->Eshop->formatMoney($shipping -$lLl111l, $oCart->currency); $lLl111L["shipping_total"] =$frn->Eshop->formatMoney($shipping, $oCart->currency); $lLl111L["shipping_tax_value"] =$shippingTax; $I1lLIlI["purchase_print_shipping"] =$frn->TTITI1l(I18548, I18524, $lLl111L); $lLl1IIL += $lLl111l; $lLl11L1 += $shipping -$lLl111l; $lLl111I += $shipping; }$excise_tax =0; if (($taxScheme != I18539) && $frn->Eshop->_taxesData[I18476] == 'us' && $frn->Eshop->_taxesData[I18521] >0) {$excise_tax =$frn->Eshop->_taxesData[I18521]; $lLl111I += $excise_tax; }$I1lLIlI["grand_total"] =$frn->Eshop->formatMoney($lLl1IIL, $oCart->currency); $I1lLIlI["grand_tax"] =$frn->Eshop->formatMoney($lLl11L1, $oCart->currency); $I1lLIlI["grand_total_tax"] =$frn->Eshop->formatMoney($lLl111I, $oCart->currency); $I1lLIlI[I18549] =doubleval($excise_tax); $I1lLIlI["excise_tax"] =$frn->Eshop->formatMoney($excise_tax, $oCart->currency); $I1lLIlI["grand_total_weight"] =$itemsArray[$countItems][I18515]; if($lLl11LI) {$aOptions =TlTll1I($GLOBALS['db'], $frn->VarsPost[I18535]); $lLl111I =$lLl111I +$lLl111I *$aOptions["fee_percent"]/100; $feeConst =$frn->Eshop->convertCurrency($aOptions[I18550], $aOptions["fee_curr"], $oCart->currency); $lLl111I += $feeConst; }$lLl111I =$frn->Eshop->formatNumber($lLl111I, true, true); $lLl1111 =intval($lLl111I); $lLLIIII =$frn->Eshop->numberDecimals; $frn->Eshop->numberDecimals =0; $I1lLIlI["grand_total_tax_fraction"] =$frn->Eshop->formatNumber(($lLl111I -$lLl1111) *100, true, true); $I1lLIlI["grand_total_tax_fraction"] =sprintf("%02d", $I1lLIlI["grand_total_tax_fraction"]); $frn->Eshop->numberDecimals =$lLLIIII; $I1lLIlI["grand_total_tax_int"] =$lLl1111; $lLLIIIl =false; $lLLIIIL =$mEshopOrder->GetOption('spelled_out_accessible_lang'); if(is_array($lLLIIIL)) {$lLLIIIl =in_array($frn->lang, $lLLIIIL); }else {$lLLIIIl =($lLLIIIL == $frn->lang); }if($lLLIIIl) {require_once $GLOBALS['CLASSES_PATH'] .'ValueSpelledOut.php'; $lIlIIIL =new ValueSpelledOut(); if($frn->Eshop->ILlLLL1->IsInstalled() && $lIlIIIL->TlTTTIl($oCart->currency)) {$lIlL1ll =$oCart->currency; }else {$lIlL1ll =$mEshopOrder->GetOption('spelled_out_currency'); }$I1lLIlI["grand_total_tax_spelled_out"] =$lIlIIIL->TlTTTI1($lLl111I, $lIlL1ll); }else {$I1lLIlI["grand_total_tax_spelled_out"] =$frn->Eshop->formatMoney($lLl111I, $oCart->currency); }$I1lLIlI[I18452] =stripslashes($frn->VarsPost[I18452]); $I1lLIlI[I18502] =nl2br(stripslashes($frn->VarsPost[I18502])); $I1lLIlI[I18500] =$frn->VarsPost[I18500]; $I1lLIlI["current_date"] =date($frn->DFMT["php"]); $lLLIII1 =$I1lLIlI; if(($lII11IL && $frn->VarsPost[I18504] == I18480) || (!$lII11IL && $lLl1LL1 == I18480)) {$lLLIII1[I18508] =stripslashes($frn->VarsPost[I18450]).I18551.stripslashes($frn->VarsPost[I18499]); $I1lLIlI["purchase_print_person"] =$frn->TTITI1l(I18548, I18480, $lLLIII1); }else {$lLLIII1["company"] =stripslashes($frn->VarsPost["company"]); $lLLIII1["contact_person"] =stripslashes($frn->VarsPost[I18450]).I18551.stripslashes($frn->VarsPost[I18499]); $I1lLIlI["purchase_print_person"] =$frn->TTITI1l(I18548, "juridical", $lLLIII1); }}$I1lLIlI[I18538] =$order_id; if(!is_object($oOrder)){ require_once $GLOBALS['CLASSES_PATH'] .'EshopOrder.php'; $oOrder =new EshopOrder(); $oOrder->aCurrency =&$frn->Eshop->aCurrency; }$oOrder->updateStatus($frn, $order_id, I18532, $aStatuses['print']); $frn->Member->Cart->currency =$lLl11LL; echo $frn->Gui->get(I18548, $I1lLIlI); $conn->Out(); die(); }else {trigger_error(I18552, E_USER_ERROR); $conn->Out(); die(); }}if($frn->Vars[I18472]==I18474 || $frn->Vars[I18472]=="apply" || $frn->Vars[I18472]=="askparams") {$frn->VarsPost =removeSpecial($frn->VarsPost, 'slashes'); $order_id =(empty($order_id)) ?intval($frn->VarsPost[I18538]) :$order_id; if($frn->VarsPost['add_shipping'] == 1 && isset($frn->VarsPost['shipping_methods_to_products'])) {$frn->Member->Cart->selectedShippingMethodsToProductsIndices =array(); foreach ($frn->VarsPost['shipping_methods_to_products'] as $shippingMethodId => $lLl11II) {$frn->Member->Cart->selectedShippingMethodsToProductsIndices[$shippingMethodId] =explode(I18507, $lLl11II); }}$oldTotal =$frn->Member->Cart->total; $frn->Member->Cart->calcPayment($db, $itemsArray); $countItems =sizeof($itemsArray) -1; $shipping =$itemsArray[$countItems]["shipping_value"]; if($frn->Vars[I18472]!=I18474 && $mEshopOrder->GetOption("shipping_checkbox_enable") && !$frn->VarsPost["add_shipping"]) {$shipping =0; $aSql =Array(I18553=>$shipping); $sql =$db->GenUpdateSQL("cms_es_orders", $aSql, "WHERE id='$order_id'"); $db->query($sql); }$frn->Member->Cart->total =$oldTotal; }if($frn->Vars[I18472]=="apply" || $frn->Vars[I18472]==I18474) {if($frn->Member->Cart->itemcount()>0) {$lIILIII ="body_processing_form"; if(empty($II111lL)) $II111lL =$lIILIII; $lLl1IIL =$itemsArray[$countItems][I18543] +$itemsArray[$countItems][I18520] +$shipping; if($lLl1lll){ $aOrderItems['drivers'] =array(); }$cData =Array(); $lLl1lIL =Array(); $lLl1lIL[I18538] =$order_id; $lLl1lIL[I18452] =stripslashes($frn->VarsPost[I18452]); $lLl1lIL[I18554] =$mEshopOrder->GetOption(I18554); $lLl1lIL[I18528] =$frn->Member->Cart->total; $lLl1lIL['company'] =$frn->VarsPost['company']; $lLl1lIL['items_name_list'] =I18451; $cData['business_email'] =$lLlLLI1->issetOption(I18555) ?$lLlLLI1->GetOption(I18555) :NULL; $cData['return'] =$frn->TTITI1l("processing_return", $driverName, $lLl1lIL); if(empty($cData['return'])) {$cData['return'] =$frn->TTITI1l(I18496, I18556, $lLl1lIL); }$cData['cancel'] =$frn->TTITI1l("processing_cancel", $driverName, $lLl1lIL); if(empty($cData['cancel'])) {$cData['cancel'] =$frn->TTITI1l(I18496, I18557, $lLl1lIL); }$cData['callback'] =$frn->TTITI1l("processing_callback", $driverName, $lLl1lIL); if(empty($cData['callback'])) {$cData['callback'] =$frn->TTITI1l(I18496, I18558, $lLl1lIL); }$cData['item_name'] =TlTlT11($lLl1lIL, $itemsArray, $countItems, I18496); $cData['item_number'] =$frn->TTITI1l(I18496, "item_number", $lLl1lIL); $cData['amount'] =$frn->Member->Cart->total; $cData[I18559] ='1'; $cData['button_name'] =$frn->TTITI1l(I18496, "button_name"); $cData['process_url'] =$frn->SubmitterLink; $cData[I18560] =$order_id; $cData['description'] =$frn->TTITI1l(I18496, "item_name", $lLl1lIL); $cData['description_title'] =$frn->Words["description_title"];; $cData[I18554] =$mEshopOrder->GetOption(I18554); $cData[I18561] =$frn->ActiveScript; $cData[I18534] ='askparams'; $cData['firstname'] =stripslashes($frn->VarsPost['firstname']); $cData['lastname'] =stripslashes($frn->VarsPost[I18562]); $cData['company'] =stripslashes($frn->VarsPost['company']); $cData[I18485] =stripslashes($frn->VarsPost[I18485]); $cData[I18489] =stripslashes($frn->VarsPost[I18489]); $cData['address'] =stripslashes($frn->VarsPost['address']); $cData[I18563] =stripslashes($frn->VarsPost[I18563]); $cData['comments'] =stripslashes($frn->VarsPost['comments']); $cData[I18481] =stripslashes($frn->VarsPost[I18481]); if (isset($frn->VarsPost['custom_payment_type'])) {$cData['custom_payment_type'] =stripslashes($frn->VarsPost['custom_payment_type']); }$cData[I18538] =$order_id; $cData['add_shipping'] =$frn->VarsPost['add_shipping']; if (isset($frn->Member->Cart->selectedShippingMethodsToProductsIndices) && is_array($frn->Member->Cart->selectedShippingMethodsToProductsIndices)) {foreach ($frn->Member->Cart->selectedShippingMethodsToProductsIndices as $shippingMethodId => $indices) {$cData["shipping_methods_to_products[" .$shippingMethodId ."]"] =implode(I18505, $indices); }}$lLLIIlI =$cData; $aDrivers =explode(I18467, $mEshopOrder->TTlITIl(I18564, $frn->VarsPost[I18481])); $lLLIIll =(sizeof($aDrivers)==1) && $mEshopOrder->GetOption('auto_redirect'); EventApplyVars($frn, "allowed_billing_drivers", $aDrivers); foreach($aDrivers as $num => $driverName) {if($driverName == 'RUPAY_DRIVER'){ continue; }$vRes =Array(); $I1lLIlI =Array(); $cData =$lLLIIlI; $aOptions =TlTll1I($GLOBALS['db'], $driverName); if(sizeof($aOptions) == 0){ continue; }$aOptions[I18565] =$frn->Gui->parseText($aOptions[I18565], $cData); unset($aOptions["pass_phrase"]); unset($aOptions["cb_pass"]); unset($aOptions["disabled_languages"]); $cData =array_merge($cData, $aOptions); $lLLIIlL =$frn->TTITI1l("processing_button_name", isset($GLOBALS['BILLING_DRIVERS_ALIASES'][$driverName]) ?$GLOBALS['BILLING_DRIVERS_ALIASES'][$driverName] :$driverName); if(!empty($lLLIIlL)) {$cData['button_name'] =$lLLIIlL; }$cData['button'] =$frn->TTITI1l("processing_button", isset($GLOBALS['BILLING_DRIVERS_ALIASES'][$driverName]) ?$GLOBALS['BILLING_DRIVERS_ALIASES'][$driverName] :$driverName); $cData['billing_driver'] =$driverName; require_once $GLOBALS['CLASSES_PATH'] .'billing.php'; require_once $GLOBALS[I18566] .$GLOBALS['lLIll1I']['BASE_DRIVER'] .'.php'; if(!is_object($oOrder)) {require_once $GLOBALS[I18566] .'EshopOrder.php'; $oOrder =new EshopOrder(); $oOrder->aCurrency =&$frn->Eshop->aCurrency; }$lLlLLlI =TlTll1T($driverName, $frn->Gui, $lLlLLI1, $oEshop->dbTablePrefix, $lang_data); $lLLIIl1 =$lLlLLlI->TlTTllT(); if (empty($aOptions[I18567])) {$lLLIILI =$lLlLLlI->getCurrencies($aOptions, $frn->Member->Cart->currency); $lLLIILl =$lLLIILI[0]; }else {$lLLIILl =$aOptions[I18567]; }$lLLIILL =$lLl1IIL +$lLl1IIL *$lLLIIl1[I18547]/100; $lLLIIl1["const"] =$frn->Eshop->convertCurrency($lLLIIl1["const"], $lLLIIl1["curr"], $frn->Member->Cart->currency); $lLLIILL += $lLLIIl1["const"]; $lLLIIL1 =$frn->Eshop->formatNumber($lLl1IIL*$lLLIIl1[I18547]/100 +$lLLIIl1[I18568], true, true); $lLLIIL1 =$frn->Eshop->formatMoney($lLLIIL1, $frn->Member->Cart->currency); $lLLII1I =$frn->Eshop->convertCurrency($lLLIILL, $frn->Member->Cart->currency, $lLLIILl); $cData['amount'] =$frn->Eshop->formatNumber($lLLII1I, true, true); $cData['fee_amount'] =$lLLIIL1; $lLLIILL= $frn->Eshop->formatNumber($lLLIILL, true, true); if($lLLIIl1[I18568] != 0) {$I1lLIlI["pay_charge_const"] =$frn->Eshop->formatMoney($lLLIIl1[I18568], $frn->Member->Cart->currency); $I1lLIlI["pay_charge_const"] =$frn->TTITI1l(I18496, I18569, $I1lLIlI); }if($lLLIIl1[I18547] != 0) {$I1lLIlI["pay_charge_percent"] =$lLLIIl1[I18547]; $I1lLIlI["pay_charge_percent"] =$frn->TTITI1l(I18496, "pay_charge_percent", $I1lLIlI); }$I1lLIlI["pay_amount"] =$frn->Eshop->formatMoney($lLLIILL, $frn->Member->Cart->currency); $cData[I18570] =$I1lLIlI["pay_amount"]; $I1lLIlI["pay_amount"] =$frn->TTITI1l(I18496, "pay_amount", $I1lLIlI); $I1lLIlI["amount"] =I18441; if($lLLIIl1[I18547] != 0 || $lLLIIl1[I18568] != 0) {$I1lLIlI[I18571] =$frn->Eshop->formatMoney($lLl1IIL, $frn->Member->Cart->currency); $I1lLIlI[I18571] =$frn->TTITI1l(I18496, I18571, $I1lLIlI); }$cData['currency'] =$cData['driver_currency'] =$lLLIILl; if($lLl1lll){ $aOrderItems['drivers'][$driverName]['currency'] =$cData[I18572]; $aOrderItems['drivers'][$driverName]['fee'] =$lLLIIl1; $aOrderItems['drivers'][$driverName]['fee_amount'] =$lLLIIL1; $aOrderItems[I18573][$driverName]['pay_charge_const'] =empty($I1lLIlI[I18569]) ?I18451 :$I1lLIlI[I18569]; $aOrderItems[I18573][$driverName]['pay_charge_percent'] =empty($I1lLIlI["pay_charge_percent"]) ?I18451 :$I1lLIlI["pay_charge_percent"]; $aOrderItems[I18573][$driverName][I18574] =strip_tags($I1lLIlI["pay_amount"]); $aOrderItems[I18573][$driverName]['amount'] =strip_tags($cData['amount']); }if($lLlLLlI->TlTT11I($vRes, $cData, $lLLIIll)) {$frn->Gui->dropBlock('billing_service_form'); if($num >0) {$I1lLIlI[I18575] .= $frn->TTITI1l("processing_form", "Vsplitter", $I1lLIlI); }$I1lLIlI[I18575] .= $vRes[I18575]; EventApplyVars($frn, $lIILIII, $I1lLIlI); $formData["form"] .= $frn->TTITI1l(I18496, "form_row", $I1lLIlI); }$lLl1II1[I18576] =$frn->TTITI1l(I18496, "form", $formData); }if($lLl1lll){ if(isset($aOrderItems[I18573]['authorize'])){ $aOrderItems[I18573]['billing'] =$aOrderItems[I18573]['authorize']; }if(isset($aOrderItems[I18573][I18577])){ $aOrderItems[I18573]['acc'] =$aOrderItems[I18573][I18577]; }$aOrderCostData[I18573] =$aOrderItems[I18573]; return; }if($frn->Vars[I18534] != I18478) {$oOrder->updateStatus($frn, $order_id, I18532, $aStatuses['process']); }}else {if($lLl1lll){ $aOrderCostData[I18478] ='empty_cart'; return; }$lLl11l1 =Array(); $lLl11l1['description'] ='Apply called with empty cart'; $lLl11l1['type'] ='empty_cart'; $frn->Vars[I18534] =I18478; }}if($frn->Vars[I18472]=="askparams") {if($frn->Member->Cart->itemcount()>0) {$frn->VarsPost =removeSpecial($frn->VarsPost, 'slashes'); if ($_useShippingModule) {if (isset($frn->VarsPost['shipping_methods_to_products'])) {$a =array ();foreach ($frn->VarsPost['shipping_methods_to_products'] as $shippingMethodId => $lLl11II) {$a[$shippingMethodId] =explode(I18507, $lLl11II); }$frn->Member->Cart->selectedShippingMethodsToProductsIndices =$a; }}$aOptions =TlTll1I($GLOBALS['db'], $frn->VarsPost['billing_driver']); if (empty($aOptions[I18567])) {$lLLIILI =$lLlLLlI->getCurrencies($aOptions, $frn->Member->Cart->currency); $lLLIILl =$lLLIILI[0]; }else {$lLLIILl =$aOptions[I18567]; }$itemsArray =Array(); $lLl11LL =$frn->Member->Cart->currency; $frn->Member->Cart->currency =$lLLIILl; $frn->Member->Cart->calcPayment($db, $itemsArray); if ($lLl11LL != $lLLIILl) {$frn->Member->Cart->currency =$lLl11LL; $tmp =array ();$frn->Member->Cart->calcPayment($db, $tmp); unset($tmp); }$countItems =sizeof($itemsArray) -1; $shipping =$itemsArray[$countItems][I18524]; if($mEshopOrder->GetOption("shipping_checkbox_enable") && !$frn->VarsPost[I18578]) {$shipping =0; }$lLl1IIL =$itemsArray[$countItems][I18543] +$itemsArray[$countItems][I18520] +$shipping; $lLLIIl1 =$lLlLLlI->TlTTllT(); $lLLIILL =$lLl1IIL +$lLl1IIL *$lLLIIl1[I18547]/100; $lLLIIl1[I18568] =$frn->Eshop->convertCurrency($lLLIIl1[I18568], $lLLIIl1["curr"], $lLLIILl); $lLLIILL += $lLLIIl1[I18568]; $lLLIILL= $frn->Eshop->formatNumber($lLLIILL, true, true); $I1lLIlI =Array(); $order_id =intval($frn->VarsPost[I18538]); $lLl1lIL =Array(); $lLl1lIL[I18538] =$order_id; $lLl1lIL[I18554] =$mEshopOrder->GetOption(I18554); $lLl1lIL[I18528] =$lLLIILL; $lLl1lIL['company'] =$frn->VarsPost['company']; $lLl1lIL['items_name_list'] =I18451; $cData[I18579] =$lLlLLlI->getDriverName(); $cData[I18572] =$cData['driver_currency'] =$lLLIILl; $cData[I18555] =$lLlLLI1->issetOption(I18555) ?$lLlLLI1->GetOption(I18555) :NULL; $cData['add_shipping'] =$frn->VarsPost['add_shipping']; $cData['return'] =$frn->TTITI1l(I18580, $driverName, $lLl1lIL); if(empty($cData['return'])) {$cData['return'] =$frn->TTITI1l("checkout", I18556, $lLl1lIL); }$cData['cancel'] =$frn->TTITI1l(I18581, $driverName, $lLl1lIL); if(empty($cData['cancel'])) {$cData['cancel'] =$frn->TTITI1l("checkout", I18557, $lLl1lIL); }$cData['callback'] =$frn->TTITI1l(I18582, $driverName, $lLl1lIL); if(empty($cData['callback'])) {$cData['callback'] =$frn->TTITI1l("checkout", I18558, $lLl1lIL); }$cData['item_name'] =TlTlT11($lLl1lIL, $itemsArray, $countItems, I18583); $cData['item_number'] =$frn->TTITI1l(I18583, "item_number", $lLl1lIL); $cData['amount'] =$lLLIILL; $cData[I18559] ='1'; $cData[I18560] =$order_id; $cData[I18538] =$order_id; $cData[I18584] =$frn->TTITI1l(I18496, "item_name", $lLl1lIL); $cData['description_title'] =$frn->Words["description_title"];; $cData[I18554] =$mEshopOrder->GetOption(I18554); $aOptions =TlTll1I($GLOBALS['db'], $driverName); unset($aOptions[I18585]); unset($aOptions["cb_pass"]); unset($aOptions["disabled_languages"]); if($aOptions['all_data']) {$cData['firstname'] =stripslashes($frn->VarsPost[I18586]); $cData[I18562] =stripslashes($frn->VarsPost[I18562]); $cData['company'] =stripslashes($frn->VarsPost['company']); $cData[I18485] =stripslashes($frn->VarsPost[I18485]); $cData[I18489] =stripslashes($frn->VarsPost[I18489]); $cData['address'] =stripslashes($frn->VarsPost['address']); $cData[I18563] =stripslashes($frn->VarsPost[I18563]); $cData[I18587] =stripslashes($frn->VarsPost[I18587]); $cData[I18481] =stripslashes($frn->VarsPost[I18481]); if (isset($frn->VarsPost['custom_payment_type'])) {$cData['custom_payment_type'] =stripslashes($frn->VarsPost['custom_payment_type']); }$sql ="SELECT custinfo FROM cms_es_orders WHERE id='$order_id'"; $aCustInfo =unserialize($db->getValue($sql)); if(is_array($aCustInfo)) {$cData += $aCustInfo; }}$aOptions[I18565] =$frn->Gui->parseText($aOptions[I18565], $cData); $cData =array_merge($cData, $aOptions); $cData[I18534] ='process'; $cData[I18561] =$frn->ActiveScript; if(!empty($aOptions[I18588])) {$frn->Gui->addBlock('billing_payservice_form', $aOptions[I18588]); }$cData += $frn->VarsPost; if (isset($cData["shipping_methods_to_products"]) && is_array($cData["shipping_methods_to_products"])) {$lLLII1l =$cData["shipping_methods_to_products"]; unset($cData["shipping_methods_to_products"]); foreach ($lLLII1l as $shippingMethodId => $indices) {$cData["shipping_methods_to_products[" .$shippingMethodId ."]"] =$indices; }}$cData['language'] =$lang_data; $aEvent =array( 'aData' => &$cData );AMI_Event::fire('v5_on_eshop_order_before_pay_button_params', $aEvent, AMI_Event::MOD_ANY); $vRes =array(); if($lLlLLlI->TlTT11l($cData, $vRes)) {$I1lLIlI[I18575] =$vRes[I18575]; $lIILIII ="body_checkout_form"; if(empty($II111lL)) $II111lL =$lIILIII; EventApplyVars($frn, $II111lL, $I1lLIlI); $aSysData['driver'] =$driverName; $aSysData['fee_percent'] =$aOptions['fee_percent']; $aSysData[I18589] =$aOptions[I18589]; $aSysData['fee_const'] =$aOptions['fee_const']; $asql =Array('sysinfo'=>addslashes(serialize($aSysData))); $sql =$db->GenUpdateSQL("cms_es_orders", $asql, I18590.$order_id."' AND id_member='".$frn->Member->getUserInfo('id')."'"); $db->query($sql); $oOrder->updateStatus($frn, $order_id, I18532, $aStatuses['checkout']); $lLl1II1[I18591] =$frn->TTITI1l(I18583, "form", $I1lLIlI); }else {$lLl11l1 =$vRes; $lLl11l1[I18584] ='Error in pay button creating'; $lLl11l1['type'] ='system'; $frn->Vars[I18534] =I18478; }}else {$lLl11l1 =Array(); $lLl11l1[I18584] ='Askparams called with empty cart'; $lLl11l1['type'] ='empty_cart'; $frn->Vars[I18534] =I18478; }}if($frn->Vars[I18472]=="process") {$lIILIII ="body_result_form"; if(empty($II111lL)) $II111lL =$lIILIII; if($lLlL1lL) {$oCart->init(); $oCart->onSerialize(); $oSession->SetVar($sess_cart_name, $oCart); $oSession->UnsetVar("eshop_order_request_id"); $oCart->cms =&$frn; $itemCount =$oCart->itemcountTpl(); unset($oCart->cms); $total =$oEshop->formatMoney($oCart->total, $oCart->currency); $oSession->addJsSessionCookie("eshop_cart_count", $itemCount); $oSession->addJsSessionCookie("eshop_cart_total", $total); $oSession->addJsSessionCookie("eshop_cart_total_plain", $oCart->total); if(empty($I1lLIlI[I18560])){ $I1lLIlI[I18560] =$order_id; }EventApplyVars($frn, $II111lL, $I1lLIlI); $lLl1II1["driver_result_form"] =$frn->TTITI1l(I18592, $aSysInfo['driver'], $I1lLIlI); $lLl1II1["result_form"] =$frn->TTITI1l("result", 'accepted', $I1lLIlI); }else if($lLlL1I1) {EventApplyVars($frn, $II111lL, $I1lLIlI); $lLl1II1[I18593] =$frn->TTITI1l("result", "cancelled", $I1lLIlI); }else{ $lLl1II1[I18593] =$frn->TTITI1l("result", "wrong_request", $I1lLIlI); }$oOrder->updateStatus($frn, $order_id, I18532, $aStatuses[I18594]); if($lLlL1lL || $lLlL1I1){ $lLLII1L =array('card', 'card_exp', 'adm_comments', 'owners', I18595, 'id_user', 'login', 'status_history', 'date_modified', I18596, 'date_exported', 'data'); $lLLII11 =array('owner_name'); $lLLIlII =array('owner_name', I18595); $lLLIlIl =array(I18485, I18597, I18458); if(!empty($I1lLIlI[I18538])){ $lLLIlIL =AMI::getResourceModel('eshop_order/table')->getAvailableFields(); $lLLIlI1 =AMI::getResourceModel('eshop_order/table')->find($I1lLIlI[I18538], array('*')); $aOrderData =array(); foreach($lLLIlIL as $orderField){ if(!in_array($orderField, $lLLII1L)){ if(is_array($lLLIlI1->$orderField)){ $lLLIllI =array(); foreach($lLLIlI1->$orderField as $lLLIlll => $lLLIllL){ if(($orderField != 'custom_info') || (($orderField == I18598) && in_array($lLLIlll, $lLLIlIl))){ $lLLIllI[] =$frn->TTITI1l('result', 'order_data_row', $aData =array('name' => $lLLIlll, 'value' => AMI_Lib_String::jParse($lLLIllL))); }}$aOrderData[$orderField] =implode(I18507, $lLLIllI); }else{ $aOrderData[$orderField] =AMI_Lib_String::jParse($lLLIlI1->$orderField); }}}$aOrderData['data_shipping_const'] =AMI_Lib_String::jParse($lLLIlI1->data['shipping_const']); $ILLLIlI =AMI::getSingleton('eshop_order'); $lLLIll1 =$ILLLIlI->getItems($lLLIlLI =array($lLLIlI1)); if(is_array($lLLIll1[$I1lLIlI[I18538]]) && sizeof($lLLIll1[$I1lLIlI[I18538]])){ $lLLIlLl =AMI::getResourceModel('eshop_order_item/table')->getAvailableFields(); $lLLIlLL =array(); foreach($lLLIll1[$I1lLIlI[I18538]] as $lLLIlL1){ $lLLIl1I =array(); foreach($lLLIlLl as $lLLIl1l){ if(!in_array($lLLIl1l, $lLLII11)){ if($lLLIl1l == 'data'){ $lLLIl1L =array(); foreach($lLLIlL1->data as $lLLIl11 => $lLLILII){ if(!is_array($lLLILII)){ $lLLIl1L[$lLLIl11] =AMI_Lib_String::jParse($lLLIlL1->data[$lLLIl11]); }else{ if($lLLIl11 == I18599){ $aData =$lLLIlL1->data[I18599]; foreach($lLLIlII as $lLLILIl){ unset($aData[$lLLILIl]); }foreach($aData as $lLLILIL => $lLLILI1){ if(is_array($lLLILI1)){ $aData[$lLLILIL] =json_encode($lLLILI1); }}$lLLIl1L[$lLLIl11] =$frn->TTITI1l('result', 'order_item_info', $aData); }else{ $lLLIl1L[$lLLIl11] =json_encode($lLLILII); }}}$lLLIl1I['data'] =$frn->TTITI1l('result', I18600, $lLLIl1L); }else{ $lLLIl1I[$lLLIl1l] =AMI_Lib_String::jParse($lLLIlL1->$lLLIl1l); }}}$lLLIlLL[] =$frn->TTITI1l('result', 'order_product', $lLLIl1I); }$aOrderData['products'] =implode(I18507, $lLLIlLL); }$lLLILlI =$frn->TTITI1l('result', I18601, $aOrderData); }}}if($frn->Vars[I18472]=="error") {$lIILIII ="body_error"; if(empty($II111lL)) $II111lL =$lIILIII; AMI_Registry::push('disable_error_mail', true); trigger_error("ESHOP-ORDER: ".$lLl11l1[I18584].I18602.$lLl11l1[I18478]."). Passed data: ".serialize($cData), E_USER_WARNING); AMI_Registry::pop('disable_error_mail'); $I1lLIlI[I18489] =$mEshopOrder->GetOption('eshop_admin_email'); EventApplyVars($frn, $II111lL, $I1lLIlI); $lLl1II1["error"] =$frn->TTITI1l(I18603, $lLl11l1['type'], $I1lLIlI); }if($frn->Vars[I18472]==I18469) {$lIILIII =I18533; if(empty($II111lL)){ $II111lL =$lIILIII; }if($frn->Member->Cart->itemcount()>0) {require_once($GLOBALS["FUNC_INCLUDES_PATH"].I18473); if(!isset($I1lLIlI['country'])){ $I1lLIlI['country'] =I18451; }$I1lLIlI[I18604] =$I1lLIlI['country']; $I1lLIlI["country_options"] =TlTl11T($frn, $I1lLIlI['country']); $I1lLIlI["states_js"] =TlTl11l($frn); if($lLl1l1I) {$itemIds =$frn->Member->Cart->getProductidList(); $sql ="SELECT count(id) as num FROM ".$oEshop->dbTablePrefix."_items WHERE id IN(".$itemIds.") AND item_type='eshop_goods'"; $db->query($sql); $db->next_record(); if($db->Record["num"] >0) {$frn->Gui->AddGlobalVars(Array('IS_SHIPPING_INFO_ON'=>I18605)); }}$oEshopOrder =AMI::getSingleton('eshop_order'); $aAllowedDrivers =$oEshopOrder->getPaymentMethods(); if( $frn->Core->GetOption('demo_mode') || 'inst2/' == files_subpath ){$aAllowedDrivers['natural'] .= I18606; $aAllowedDrivers['juridical'] .= I18606; }$lLLILll =array('natural', 'juridical'); $lLLILlL =$frn->Gui->ParseLangFile('templates/lang/' .$frn->Eshop->ownerName .I18607); foreach($lLLILll as $lLLILl1){ $I1lLIlI['payment_methods_'.$lLLILl1] =I18451; if(!empty($aAllowedDrivers[$lLLILl1])){ $lLLILLI =explode(I18467, trim($aAllowedDrivers[$lLLILl1], I18467)); foreach($lLLILLI as $drvName){ $aData =array( 'name' => $drvName, );if(isset($lLLILlL['pay_with_' .$drvName .'_comment'])){ $aData[I18608] =AMI_Lib_String::htmlChars($lLLILlL['pay_with_' .$drvName .'_comment']); }$I1lLIlI['payment_methods_'.$lLLILl1] .= $frn->Gui->get( 'purchase:payment_methods_' .$lLLILl1 .I18609, $aData );}}unset($lLLILLI); }unset($lLLILlL); EventApplyVars($frn, $II111lL, $I1lLIlI); if($frn->Member->isLoggedIn() && $frn->Core->IsFrontAllowed(I18488)) {$userId =$frn->Member->getUserInfo(I18447); $sql ="SELECT custinfo, sysinfo FROM cms_es_orders WHERE id_member='".$userId."' AND lang='".$lang_data."' ORDER BY id DESC LIMIT 1"; $db->query($sql); if($db->next_record()) {$aCustomData =unserialize($db->Record["custinfo"]); $aSysData =unserialize($db->Record[I18610]); if(is_array($aCustomData)) {$I1lLIlI =array_merge($I1lLIlI, $aCustomData); }if(is_array($aSysData)) {$I1lLIlI[I18504] =$aSysData["person_type"]; if (isset($aSysData['custom_payment_type'])) {$I1lLIlI["custom_payment_type"] =$aSysData["custom_payment_type"]; }}}}if($fast_register && !$frn->Member->isLoggedIn() && $frn->Core->IsFrontAllowed(I18488)) {$I1lLIlI[I18611] =I18605; $I1lLIlI['username'] =$username; $I1lLIlI['member_script_link'] =$mMembers->GetFrontLink(); $frn->Member->setUsed("username", true, true); $I1lLIl1 =$frn->Member->getScripts($frn); $I1lLIlI["check_member_script"] =$I1lLIl1[I18612]; }$oldTotal =$frn->Member->Cart->total; $frn->Member->Cart->calcPayment($db, $itemsArray, false, true); $frn->Member->Cart->total =$oldTotal; $index =sizeof($itemsArray) -1; if($mEshopOrder->GetOption("use_requirements_order")) {$lLLILLl =false; for($i =0; $i <$index; $i++) {$qty =$frn->Member->Cart->getQuantity($itemsArray[$i]["owner_name"], $itemsArray[$i][I18447], $itemsArray[$i]["id_prop"], $itemsArray[$i][I18542]); if($qty >$itemsArray[$i][I18445]) {$lLLILLl =true; break; }}if($lLLILLl) {$I1lLIlI["request_order_warn"] =$frn->Gui->getAbs("purchase:request_order_warn", I18441); }}$I1lLIlI["shipping_value"] =$itemsArray[$index]["shipping_value"]; $I1lLIlI[I18518] =$itemsArray[$index][I18518]; $I1lLIlI["price_value"] =$itemsArray[$index]["price_value"]; $frn->Member->Cart->total =$oldTotal; $frn->Gui->AddGlobalVars(array ("SKIP_SHIPPING_METHOD_CHECK" => false)); $I1lLIlI[I18468] =$_useShippingModule; $aShippingData =array(); if ($_useShippingModule) {$I1LLLlL =array ();$I1lLIlI["fieldsets_qty"] =$lLl1Lll; $I1lLIlI["shipping_fields"] =AMI_Lib_String::jParse(json_encode($lLl1LlI)); if(!empty($lLl1LI1)){ $aData =array(); $I1LLLlL['yandex_fast_order_btn'] =$frn->Gui->get("purchase:yandex_fast_order_btn", $aData); if(!empty($frn->VarsPost[I18613]) && !empty($frn->VarsPost['id']) && !empty($frn->VarsPost['title'])){ $I1lLIlI[I18562] =$frn->VarsPost[I18562]; $I1lLIlI[I18586] =$frn->VarsPost[I18586]; $I1lLIlI['fathersname'] =$frn->VarsPost['fathersname']; $I1lLIlI[I18489] =$frn->VarsPost[I18489]; $I1lLIlI[I18531] =$frn->VarsPost[I18531]; $I1lLIlI[I18485] =$frn->VarsPost[I18531]; $I1lLIlI[I18614] =$frn->VarsPost[I18614]; $I1lLIlI[I18487] =$frn->VarsPost[I18487]; $I1lLIlI['country'] =$frn->VarsPost['country']; $I1lLIlI['street'] =$frn->VarsPost['street']; $I1lLIlI[I18615] =$frn->VarsPost['building']; $I1lLIlI['building'] =$frn->VarsPost['suite']; $I1lLIlI['app'] =$frn->VarsPost[I18616]; $I1lLIlI['entrance'] =$frn->VarsPost['entrance']; $I1lLIlI['floor'] =$frn->VarsPost['floor']; $I1lLIlI[I18617] =$frn->VarsPost['intercom']; $I1lLIlI['zip'] =$frn->VarsPost['zip']; $I1lLIlI['station'] =$frn->VarsPost[I18618]; $I1lLIlI['cargolift'] =$frn->VarsPost['cargolift']; $I1lLIlI[I18587] =$frn->VarsPost[I18608]; }}$I1LLLlL['custom_shipping_list'] =I18451; foreach($lLl1LlI as $i){ $fieldset ="custom_shipping_" .$i; $I1LLLlL['custom_shipping_list'] .= $frn->Gui->get("purchase:" .$fieldset, $I1lLIlI); }$orderDirection =$frn->Core->GetModOption($lLl1LIl, "page_sort_dim"); $orderField =$frn->Core->GetModOption($lLl1LIl, "page_sort_col"); $shippingTypesIds =array_keys($frn->Member->Cart->shippingTypesToProductsIndices); $lLLILLL =$frn->Core->GetModOption($lLl1LIl, 'range_field'); if($lLLILLL){ $lLLILL1 =new AMI_EshopShippingMethod($lLLILLL, $frn); }if ($shippingConflicts == I18619) {$shippingTypesIdsQty =count($shippingTypesIds); if ($shippingTypesIdsQty == 1) {$sql ="SELECT m.id, m.name, m.custom_fields, m.comments, m.delivery_time, m.custom_conditions, t2m.id_type " ."FROM `" .$frn->Eshop->dbTablePrefix ."_shipping_methods` m " ."INNER JOIN `" .$frn->Eshop->dbTablePrefix ."_shipping_types_methods` t2m ON t2m.id_method = m.id " ."WHERE t2m.id_type = " .$shippingTypesIds[0] .I18551 ."ORDER BY `" .$orderField ."` " .$orderDirection; }else {$sql ="SELECT m.id, m.name, m.custom_fields, m.comments, m.delivery_time, m.custom_conditions, t2m.id_type " .I18620 .$frn->Eshop->dbTablePrefix ."_shipping_types_methods` t2m " ."INNER JOIN `" .$frn->Eshop->dbTablePrefix ."_shipping_methods` m ON m.id = t2m.id_method " ."WHERE `id_type` IN (" .implode(I18505, $shippingTypesIds) .I18621 ."GROUP BY m.id " ."HAVING COUNT(t2m.id_type) = " .$shippingTypesIdsQty .I18551 ."ORDER BY m." .$orderField .I18551 .$orderDirection; }$db->query($sql); $I1LLLlL["shipping_methods_list"] =I18441; if ($db->num_rows() >0) {$lLLIL1I =array(); while ($db->next_record()) {if ($db->num_rows() == 1 && empty($db->Record[I18508])) {$SKIP_SHIPPING_METHOD_CHECK =true; break; }if($lLLILLL && $db->Record[I18622] === 'value'){ if(!$lLLILL1->TTTI1II($db->Record['id_type'], $db->Record['id'])){ continue; }}$row =array (I18447 => $db->Record[I18447], "id_type" => $db->Record[I18623], I18508 => $db->Record[I18508], "fieldsets" => preg_replace(array ("/^\|/", "/\|$/"), I18441, $db->Record["custom_fields"]), I18624 => mb_strlen($db->Record[I18624]) >0 ?$frn->Gui->get("purchase:shipping_method_comments_row", $db->Record) :I18441, "delivery_time" => htmlspecialchars($db->Record["delivery_time"]) );$lLLIL1I[] =array( 'id' => $row[I18625], 'id_type' => $row['id_type'], 'name' => $row['name'] );$I1LLLlL["shipping_methods_list"] .= $frn->Gui->get("purchase:shipping_method_radio_row", $row); $lLl11II =array_keys($itemsArray); array_pop($lLl11II); $I1LLLlL["products_indices"] =implode(I18505, $lLl11II); }foreach($lLLIL1I as $lLLIL1l){ $lLl1ll1 =$lLLIL1l['id_type']; $aShippingData[$lLl1ll1][I18625] =$lLl1ll1; $aShippingData[$lLl1ll1]['methods'][] =array( I18625 => $lLLIL1l[I18625], I18626 => $lLLIL1l[I18626], );}foreach($frn->Member->Cart->shippingTypesToProductsIndices as $lLLIL1L){ foreach($lLLIL1L as $lLLIL11){ $aShippingData[$lLl1ll1][I18456][$lLLIL11] =$itemsArray[$lLLIL11]; }}}else {if ($frn->Core->GetModOption($lLl1LIl, "on_intersection_emptiness") == "ask_to_change_order") {$frn->AddStatusMsg("warn_change_order", "red"); $lLLI1II =true; $aShippingData[I18478] =I18627; }else {$shippingConflicts ="show_shipping_for_each_type"; }}}if ($shippingConflicts == "show_shipping_for_each_type") {if (sizeof($frn->Member->Cart->shippingTypesToProductsIndices) == 1) {$sql ="SELECT m.id, m.name, m.custom_fields, m.comments, m.custom_conditions, t2m.id_type " .I18620 .$frn->Eshop->dbTablePrefix ."_shipping_methods` m " .I18628 .$frn->Eshop->dbTablePrefix ."_shipping_types_methods` t2m ON t2m.id_method = m.id " ."WHERE t2m.id_type = " .$shippingTypesIds[0] .I18551 ."ORDER BY `" .$orderField ."` " .$orderDirection; $db->query($sql); $I1LLLlL["shipping_methods_list"] =I18441; if ($db->num_rows() >0) {$aShippingData[$shippingTypesIds[0]] =array(I18625 => $shippingTypesIds[0]); $ids =array ();while ($db->next_record()) {$ids[] =$db->Record[I18447]; if ($db->num_rows() == 1 && empty($db->Record[I18508])) {$SKIP_SHIPPING_METHOD_CHECK =true; break; }if($lLLILLL && $db->Record[I18622] === 'value'){ if(!$lLLILL1->TTTI1II($db->Record['id_type'], $db->Record[I18625])){ continue; }}$row =array (I18447 => $db->Record[I18447], I18623 => $db->Record[I18623], I18508 => $db->Record[I18508], "fieldsets" => preg_replace(array ("/^\|/", I18629), I18441, $db->Record["custom_fields"]), I18624 => mb_strlen($db->Record[I18624]) >0 ?$frn->Gui->get("purchase:shipping_method_comments_row", $db->Record) :I18441 );$aShippingData[$shippingTypesIds[0]]['methods'][] =array( I18625 => $row[I18625], I18626 => $row[I18626] );$I1LLLlL["shipping_methods_list"] .= $frn->Gui->get("purchase:shipping_method_radio_row", $row); }$lLl11II =array_keys($itemsArray); array_pop($lLl11II); $I1LLLlL["products_indices"] =implode(I18505, $lLl11II); $I1LLLlL[I18623] =$shippingTypesIds[0]; $I1LLLlL[I18447] =implode(I18505, $ids); $shippingConflicts =I18619; foreach($frn->Member->Cart->shippingTypesToProductsIndices[$shippingTypesIds[0]] as $lLLIL11){ $aShippingData[$shippingTypesIds[0]][I18456][$lLLIL11] =$itemsArray[$lLLIL11]; }}else {$frn->AddStatusMsg("warn_change_order", "red"); $lLLI1II =true; $aShippingData[I18478] =I18627; }}else {$sql ="SELECT t2m.id_type, t.name type_name, m.id, m.name, m.custom_fields, m.comments, m.custom_conditions, t2m.id_type " .I18620 .$frn->Eshop->dbTablePrefix ."_shipping_methods` m " .I18628 .$frn->Eshop->dbTablePrefix ."_shipping_types_methods` t2m ON t2m.id_method = m.id " .I18628 .$frn->Eshop->dbTablePrefix ."_shipping_types` t ON t.id = t2m.id_type " ."WHERE t2m.id_type IN (" .implode(I18505, $shippingTypesIds) .I18621 ."ORDER BY t.name ASC"; $db->query($sql); if ($db->num_rows() >0) {$I1LLLlL["shipping_types_list"] =I18441; $lLLI1Il =array ();$lLLI1IL =array ();$lIlLL1I =array ();$lLLI1I1 =array ();while ($db->next_record()) {if ($db->num_rows() == 1 && empty($db->Record[I18508])) {$SKIP_SHIPPING_METHOD_CHECK =true; break; }if($lLLILLL && $db->Record[I18622] === 'value'){ if(!$lLLILL1->TTTI1II($db->Record['id_type'], $db->Record[I18625])){ continue; }}$fieldsets =preg_replace(array ("/^\|/", I18629), I18441, $db->Record["custom_fields"]); $lLLI1Il[$db->Record[I18623]][] =array (I18623 => $db->Record[I18623], I18447 => $db->Record[I18447], I18508 => $db->Record[I18508], I18630 => $fieldsets, I18624 => mb_strlen($db->Record[I18624]) >0 ?$frn->Gui->get("purchase:shipping_method_comments_row", $db->Record) :I18441 );$lLLI1IL[$db->Record[I18623]] =$db->Record["type_name"]; $lIlLL1I[$db->Record[I18447]] =$fieldsets; }$I1LLLlL["shipping_types_list"] =I18441; if (!isset($SKIP_SHIPPING_METHOD_CHECK)) {foreach ($lLLI1Il as $typeId => $methods) {$lLl11II =array ();$lLLI1lI =array ();$aShippingData[$typeId] =array( I18625 => $typeId, I18626 => $lLLI1IL[$typeId] );foreach ($frn->Member->Cart->shippingTypesToProductsIndices[$typeId] as $lLLIL11) {$lLLI1lI[] =$itemsArray[$lLLIL11][I18508]; $lLl11II[] =$lLLIL11; $aShippingData[$typeId][I18456][$lLLIL11] =$itemsArray[$lLLIL11]; }$lLLI1ll =array (I18623 => $typeId, "type_name" => $lLLI1IL[$typeId], I18631 => implode(I18505, $lLl11II), "products" => implode(I18501, $lLLI1lI), "shipping_methods_list" => I18441 );$lLLI1lL =false; foreach ($methods as $method) {if (empty($method[I18508])) {$lLLI1lL =true; $setName ="complex_hidden_method_row"; }else {$setName ="complex_shipping_method_radio_row"; }$lLLI1ll["shipping_methods_list"] .= $frn->Gui->get("purchase:" .$setName, $method); if(isset($aShippingData[$method['id_type']])){ $aShippingData[$method['id_type']]['methods'][] =array( I18625 => $method[I18625], I18626 => $method[I18626] );}}$I1LLLlL["shipping_types_list"] .= $frn->Gui->get( "purchase:" .($lLLI1lL ?"shipping_hidden_type_row": "shipping_type_row"), $lLLI1ll );}$I1LLLlL["shipping_types_ids"] =implode(I18501, $shippingTypesIds); $I1LLLlL[I18632] =$lLl1Lll; $I1LLLlL["shipping_methods_ids"] =implode(I18505, array_keys($lIlLL1I)); $I1LLLlL["custom_shippings"] ="'" .implode("','", $lIlLL1I) .I18633; }}else {$frn->AddStatusMsg("warn_change_order", "red"); $lLLI1II =true; $aShippingData[I18478] =I18627; }}}unset($lLLILL1); $I1lLIlI[I18448] =$I1LLLlL[I18448] =$shippingConflicts; if (isset($SKIP_SHIPPING_METHOD_CHECK)) {$aShippingData =array(); $I1lLIlI["shipping_addon"] =I18441; $frn->Gui->AddGlobalVars(array ("SKIP_SHIPPING_METHOD_CHECK" => true)); }else {$I1lLIlI[I18634] =$frn->Gui->get("purchase:shipping_addon_" .$shippingConflicts, $I1LLLlL); }}else {$I1lLIlI[I18634] =$frn->Gui->get("purchase:shipping_addon", $I1lLIlI); }if($lLl1llI){ return; }else{ $I1lLIlI["cart_shipping"] =AMI_Lib_String::jParse(json_encode($aShippingData)); }if(AMI::getOption(I18488,'user_source_app')){ $I1lLIlI['user_source_app_buttons'] =AMI::getSingleton('user_source_app')->getButtons() ;}$I1lLIlI['login_field'] =$frn->Member->getLoginField(); $lLl1II1["purchase_form"] =$frn->TTITI1l(I18477, "form", $I1lLIlI); $tmp =$frn->Gui->UseFullPath; $frn->Gui->UseFullPath =false; $frn->Gui->addScript('http://www.pickpoint.ru/select/postamat.js', true); $frn->Gui->UseFullPath =$tmp; }else {$lLl1II1["purchase_form"] =$frn->TTITI1l(I18477, "empty", I18441); }}if (isset($lLLI1II)) {$HtmlBody =I18441; }else {$lLlLlLI =$frn->Gui->get("purchase:$II111lL", $lLl1II1); $HtmlBody =$frn->Gui->getAbs(I18477, Array("body"=>$lLlLlLI, 'order_details' => empty($lLLILlI) ?I18451 :$lLLILlI)); }class AMI_EshopShippingMethod{ protected $lLLILLL; protected $oCMS; protected $aCartItems =array(); protected $lLLI1l1 =array(); public function __construct($lLLILLL, Front $oCMS){ $this->lLLILLL =$lLLILLL; $this->oCMS =$oCMS; $aCartItems =$this->oCMS->Member->Cart->getItems(); $ownerName =$this->oCMS->Member->Cart->ownerName ?$this->oCMS->Member->Cart->ownerName :I18635; if(isset($aCartItems[$ownerName])){ $this->aCartItems =$aCartItems[$ownerName]; $this->lLLI1l1 =array_keys($this->aCartItems); }}public function TTTI1II($typeId, $lIlLLL1){ $aProductIds =array(); foreach($this->oCMS->Member->Cart->shippingTypesToProductsIndices[$typeId] as $index){ $aProductIds[] =$this->lLLI1l1[$index]; }$oQuery =new DB_Query($this->oCMS->Eshop->dbTablePrefix .'_items'); $oQuery->addFields(array('`id`', '`' .$this->lLLILLL .'`')); $oQuery->addWhereDef( DB_Query::getSnippet(I18636)->implode($aProductIds) );$oDB =AMI::getSingleton('db'); $oRS =$oDB->select($oQuery); $sum =0; foreach($oRS as $aProduct){ if(empty($aProduct[$this->lLLILLL])){ continue; }$qty =0; foreach($this->aCartItems[$aProduct[I18625]] as $aPrices){ $qty += array_sum($aPrices); }$sum += $aProduct[$this->lLLILLL] *$qty; }$oQuery =new DB_Query($this->oCMS->Eshop->dbTablePrefix .'_shipping_methods'); $oQuery->addFields(array('`type`', '`max_value`')); $oQuery->addWhereDef( DB_Query::getSnippet('AND `id_parent` = %s')->q($lIlLLL1) );$oQuery->addOrder('`id`', 'ASC'); $oRS =$oDB->select($oQuery); foreach($oRS as $aRecord){ if(is_null($aRecord['max_value']) || ($sum <$aRecord['max_value'])){ return $aRecord[I18637] == I18521; }}return true; }}if($lLl1llI){ die('invalid_minimal_order_amount'); }require $GLOBALS['DEFAULT_INCLUDES_PATH'] .'done.php'; 