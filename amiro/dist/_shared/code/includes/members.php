<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       45596 xkqwxxknitliltkmgsiuwtyqiypltspquzuruligliztxupykzxgrsgnltzmptupptykpnir
 */ ?><?php foreach(array(18897=>"pQtqxtQnDMHn",18898=>'wid|qxtiHSuJQ`GOG',18899=>'`GOG',18900=>"IQIYQrD%%pQtqxtQnDMHn%?WJZDD|nZIQ?MD?nHt?DGQWMfMQS?fHr?IHSuJQ?",18901=>':',18902=>"ZutHrQSMrQWt|tH|IHSuJQD",18903=>"IQIYQrD",18904=>'MnMt`GOG',18905=>"",18906=>'',18907=>'nMWKnZIQ',18908=>"JZDtnZIQ|WHHKMQ",18909=>"YZJZnWQ|WHHKMQ",18910=>"DIZJJ",18911=>"1",18912=>'DQttMnPD|DtBJQ',18913=>'fHrPHt|DtBJQ',18914=>"JHPPQS|Mn",18915=>"IHSuJQ|nZIQ",18916=>"GZPQ|nZIQ",18917=>"WuDtHI",18918=>"vZrD",18919=>"WuDtHI|IQnu|JMDt",18920=>"YZJZnWQ",18921=>"IQIYQr",18922=>'JHPHut',18923=>'GrMvZtQ|IQDDZPQD',18924=>'JMnK',18925=>"DIZJJ|IQnu|MnfH",18926=>"rQPMDtrZtMHn",18927=>"DIZJJ|IQnu|JMDt",18928=>'ZWtMHn',18929=>"uDQrnZIQ|WHHKMQ",18930=>"MS|WHHKMQ",18931=>'ZIM|QfZ',18932=>"CZntDurJ",18933=>"MS",18934=>"MnvZJMS|uDQrnZIQ",18935=>"JHPHut",18936=>"fHrPHt",18937=>"ZSS",18938=>'RqeUqdT|iqTohs',18939=>"QIZMJ",18940=>"uDQrnZIQ",18941=>"rQS",18942=>"fHrI",18943=>"WrQZtQ",18944=>"GZDDCHrS",18945=>'DHurWQ|ZGG|MS',18946=>"ZWtMHn",18947=>"WHnfMrI",18948=>'uDQrnZIQ',18949=>"YHSB|rQPMDtQr",18950=>'uDQrnZIQ_WHSQ',18951=>"JHPMn",18952=>"WHnfMrI|fHrI",18953=>'uDQrD~rZtMnP',18954=>'SZtQ',18955=>'uDQr|DtZtuD',18956=>'HffJMnQ',18957=>'MS',18958=>'uDQr|MS',18959=>"GOHtH|OQMPOt",18960=>'fHruI|DMPn',18961=>'rZtMnP|vZJuQ',18962=>'WurrQnt|uDQr|MS',18963=>"SQtZMJD|QIGtB",18964=>"DOHrt|",18965=>"ZWtMvQ",18966=>"DHurWQ|ZGG|MS",18967=>"WHnfMrIQS",18968=>"WHnfMrIZtMHn|tBGQ",18969=>"YHSB|OHIQ",18970=>"OHIQ",18971=>"qsmT",18972=>'QIZMJ',18973=>"qigTb|gzddchRs",18974=>'SZtQ|tMIQDtZIG',18975=>'fHruI|CZtWOMnP',18976=>'MS|tOrQZS',18977=>"'",18978=>'DtHG|uDQ|DuYJMnKD',18979=>' ',18980=>'rQZJ|fHrI',18981=>"YHSB|fHrPHt",18982=>"='",18983=>"fHrPHt|WuDtHI",18984=>"DtZtuD|fHrPHt|fZMJ",18985=>"ZSIMn|QIZMJ",18986=>'Hn|WOZnPQ',18987=>'SHnQ`GOG') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} if(!defined('PERMANENT_USER_COOKIE_TTL')){ define('PERMANENT_USER_COOKIE_TTL', 30758400); }if (!function_exists(I18897)) {function &GetExtension($IIlLIIl) {global $frn; require_once $GLOBALS['CLASSES_PATH'] .I18898; $ext =null; $IILII1L =&$frn->Core->GetModule($IIlLIIl); if (is_object($IILII1L) && $IILII1L->IssetProperty("class")) {$aClasses =$IILII1L->TTlTTTI("class"); foreach($aClasses as $class) {require_once $GLOBALS['CLASSES_PATH'] .$class .I18899; }$ext =new $class(); }else {trigger_error(I18900 .$IIlLIIl, E_USER_WARNING); }return $ext; }}if (!function_exists('getGoToURL')) {function getGoToURL(&$lLLLI1I) {global $oSession, $frn, $ROOT_PATH_WWW; $lLLLI1I =false; if ($oSession->IssetVar("wantsurl")) {$lLLLI1l =$oSession->GetVar("wantsurl"); $oSession->UnsetVar("wantsurl"); if (mb_strpos($lLLLI1l, I18901) !== false) {$lLLLI1l =rawurldecode($lLLLI1l); }if (mb_strpos($lLLLI1l, $ROOT_PATH_WWW) !== 0) {$lLLLI1l =$ROOT_PATH_WWW.$frn->ActiveScript; }$lLLLI1I =true; }else {$lLLLI1l =$ROOT_PATH_WWW.$frn->ActiveScript; }return $lLLLI1l; }}if (!function_exists('isAutoRedirectEnabled')) {function isAutoRedirectEnabled($action){ global $frn; if($frn->Core->issetModOption("members", I18902) && $frn->Core->issetModOption("members", "autoredirect_forms")){ $lLll1II =$frn->Core->GetModOption(I18903, I18902); $lLLLI1L =$frn->Core->GetModOption(I18903, "autoredirect_forms"); if(in_array($action, $lLLLI1L) && (in_array($frn->VarsCookie["uh_prev_mod"], $lLll1II) || in_array('all', $lLll1II)) && isset($frn->VarsCookie["uh_prev_url"])){ $frn->Core->SetProperty("disable_autoredirect", false); return true; }}$frn->Core->SetProperty("disable_autoredirect", true); return false; }}$lLI111I =0; $lLLLI1I =false; $frn->Core->SetProperty("disable_autoredirect", true); if(isset($mode)&&$mode=="small"){ $lLI111I =1; }if(!$lLI111I){ $member =1; require_once $GLOBALS['DEFAULT_INCLUDES_PATH'] .I18904; }$mMembers =&$frn->Core->GetModule(I18903); $frn->InitMessages($frn->Gui->ParseLangFile("templates/lang/_members_msgs.lng")); $frn->Gui->addBlock(I18903,"templates/members.tpl"); $lLI111l =$frn->SetsTemplate; $frn->SetsTemplate =I18903; if($lLI111I) {$lLlLLIL =!$mMembers->GetOption("disable_dynamic_specblock"); $Core->Cache->TT1TI1I("spec_member_menu", $lLlLLIL); $lLLLI11 =I18905; $lIILIII ="body_small_block"; $IllI1II =(is_object($frn->Member) && $frn->Member->isLoggedIn()); $lLLLlII =Array(); $lLLLlII["front_link"] =$mMembers->GetFrontLink(); $I1lLILI =$frn->TTITI1l("special_selected", "style", I18906); $lLLLlIl =Array(); $aCookieData =array( 'nickname_cookie_name' => 'nickname_cookie', 'username_cookie_name' => 'username_cookie', 'firstname_cookie_name' => 'firstname_cookie', 'lastname_cookie_name' => 'lastname_cookie' );if($IllI1II) {$lLlL1LL =$frn->Member->getUserInfo(); $oSession->addJsSessionCookie('nickname_cookie', $lLlL1LL[I18907]); $oSession->addJsSessionCookie("username_cookie", $lLlL1LL["username"]); $oSession->addJsSessionCookie("firstname_cookie", $lLlL1LL["firstname"]); $oSession->addJsSessionCookie(I18908, $lLlL1LL["lastname"]); foreach(array('source_app_id', 'ami_efa') as $lLLLlIL){ if(isset($lLlL1LL[$lLLLlIL])){ $oSession->addJsSessionCookie($lLLLlIL, $lLlL1LL[$lLLLlIL]); }}if(is_object($frn->Eshop)) {$userBalance =$frn->Eshop->formatMoney(doubleval($lLlL1LL["balance"]), $frn->Eshop->baseCurrency, true, false); $oSession->addJsSessionCookie(I18909, $userBalance); }$lLlL1LL += $aCookieData; $lLlL1LL["username"] =$frn->TTITI1l("small", "username", $lLlL1LL); $lLlL1LL["firstname"] =$frn->TTITI1l(I18910, "firstname", $lLlL1LL); $lLlL1LL["lastname"] =$frn->TTITI1l(I18910, "lastname", $lLlL1LL); $lLLLlII["MEMBER_LOGGED_IN"] =I18911; if($frn->ActivePage=='members' && $frn->Vars['action'] == 'change_settings') {$lLlL1LL['settings_style'] =$I1lLILI; $lLLLlIl[I18912] =1; }}else {if($frn->ActivePage=='members') {switch($frn->Vars['action']) {case 'forgot': case 'reset': $lLlL1LL[I18913] =$I1lLILI; $lLLLlIl[I18906] =1; break; case 'add': $lLlL1LL['registration_style'] =$I1lLILI; $lLLLlIl[I18906] =1; break; default: $lLlL1LL['login_style'] =$I1lLILI; $lLLLlIl[I18906] =1; break; }$lLlL1LL += $aCookieData; }}$lLLLlI1["custom_menu_list"] =I18905; if(is_object($frn->Member)) {$data[I18914] =$IllI1II; $lLLLllI =$frn->Member->TTI1lT1($frn, $db, I18910, $data); if(sizeof($lLLLllI) >0) {$tmpPage =new Page($cms); $lLLLlll =$tmpPage->TTllllT(I18903); $lLLLllL =Array(); $llI11l1 =Array(); if($lLLLlll >0) {$tmpPage->tree->ll1Il11 =false; $II11L1l =$tmpPage->tree->TI11TII($lLLLlll, 1); foreach($II11L1l as $ll1llLI) {$lLLLllL[$ll1llLI["position"]] =$ll1llLI[I18915]; $llI11l1[$ll1llLI[I18915]] =$ll1llLI["name"]; }}$lLLLll1 =$mMembers->GetOption("show_user_menu_links"); $lLLLlLI =array_keys($lLLLllI); if(is_array($lLLLll1)) {$lLLLlLI =array_intersect($lLLLlLI, $lLLLll1); }$lLLLllL =array_intersect($lLLLllL, $lLLLlLI); ksort($lLLLllL, SORT_NUMERIC); $lLLLlLl =array_merge($lLLLllL, array_diff($lLLLlLI, $lLLLllL)); unset($tmpPage); foreach($lLLLlLl as $modName) {$IL1l1II =Array(); if(!empty($lLLLllI[$modName])) {if(isset($llI11l1[$modName])) {$lLLLllI[$modName]["vars"][I18916] =$llI11l1[$modName]; $lLLLllI[$modName]["vars"]["mod_name"] =$modName; $lLLLllI[$modName]["vars"]["item_id"] =I18917; $IL1l1II["row_data"] =$frn->Gui->getDefPostf("members:special_menu_custom_item", "_".$modName, $lLLLllI[$modName]["vars"]); if($lLLLllI[$modName][I18918]["style_selected"] != I18905){ $lLLLlIl[$modName.'_custom'] =1; }}else {$IL1l1II["row_data"] =$lLLLllI[$modName]["default"]; }$lLLLlI1[I18919] .= $frn->Gui->getDefPostf("members:small_menu_row", "_".$modName, $IL1l1II); }}}}EventApplyVars($frn, $lIILIII, $lLlL1LL); $frn->Gui->AddGlobalVars($lLLLlII); if(sizeof($lLLLlIl) >0){ $frn->Core->Cache->TT1TI1l("member_specblock", serialize($lLLLlIl), $mMembers->GetProperty("active_spec_blocks")); }if($IllI1II) {if(is_object($frn->Eshop)) {$userBalance =$frn->Eshop->formatMoney(doubleval($lLlL1LL[I18920]), $frn->Eshop->baseCurrency, true, false); $aCookieData["balance_cookie_name"] =I18909; $aCookieData["cookie_balance"] =$userBalance; $aCookieData["user_balance"] =$userBalance; $lLlL1LL["member_balance"] =$frn->TTITI1l(I18921, I18920, $aCookieData); }if($lLlL1LL['source_app_id'] && AMI::getOption('members','user_source_app')){ $I1Ll1LI =AMI::getSingleton('user_source_app'); $lLlL1LL['user_source_app_icon'] =$I1Ll1LI->getUserSpecblockDriverIcon(); }$lLl1II1["small_menu_info"] =$frn->TTITI1l("small_menu", "info_logged", $lLlL1LL); $lLLLllI =array ('change_settings', I18922); if ($frn->Core->IsInstalled('forum')) {$vMod =&$frn->Core->GetModule('forum'); if ($vMod->IsPresentInPMandPublic()) {array_unshift($lLLLllI, 'forum_watching'); }unset($vMod); }if($frn->Core->IsInstalled('private_messages')){ $vMod =&$frn->Core->GetModule(I18923); if($vMod->IsPresentInPMandPublic() && in_array(I18923, $mMembers->GetOption('show_user_menu_links'))){ array_unshift($lLLLllI, I18923); }}foreach ($lLLLllI as $itemName) {if ($itemName == 'forum_watching') {$ids =$frn->Member->TTI1l1T($cms, $db); array_unshift($ids, 0); $lLlL1LL['threads_ids'] =implode(',', $ids); }elseif($itemName == I18923){ $lLlL1LL[I18924] =$vMod->GetFrontLink(); unset($vMod); }$lLlL1LL["row_data"] =$frn->TTITI1l("small_menu", $itemName, $lLlL1LL); $lLLLlI1[$itemName] =$frn->TTITI1l("small_menu", "row", $lLlL1LL); }}else {$lLl1II1[I18925] =$frn->TTITI1l("small_menu", "info_not_logged", $lLlL1LL); foreach(Array("login", "forgot", I18926) as $itemName) {$lLlL1LL["row_data"] =$frn->TTITI1l("small_menu", $itemName, $lLlL1LL); $lLLLlI1[$itemName] =$frn->TTITI1l("small_menu", "row", $lLlL1LL); }}$lLLLlI1 += $aCookieData; $lLl1II1[I18927] =$frn->TTITI1l("small_menu", "list", $lLLLlI1); if(AMI::getOption('members','user_source_app')){ $lLl1II1['user_source_app_buttons'] =AMI::getSingleton('user_source_app')->getButtons(); }$lLLLI11 =$frn->Gui->get("members:$lIILIII", $lLl1II1); $ILILllL =$mMembers->GetProperty("spec_blocks"); if($mMembers->issetProperty("active_spec_blocks")){ $specName =$mMembers->GetProperty("active_spec_blocks"); }else {$specName =$ILILllL; }$frn->SetSpecialBlock($specName, $lLLLI11); unset($II111lL); }else {if($frn->Vars[I18928] != 'view' && in_array($ActiveModule, $frn->Core->GetProperty('disabled_se_indexing_mods'))){ $frn->Gui->setRobotsMeta(false); }$lLLLlLL =(!empty($frn->Vars["short_session_request"]) && !$oSession->TTl1T1l() && $frn->Member->isLoggedIn()); if($frn->Member->isLoggedIn()){ $aUserData =$frn->Member->getUserInfo(); $oSession->addJsSessionCookie('nickname_cookie', $aUserData[I18907]); $oSession->addJsSessionCookie(I18929, $aUserData["username"]); $oSession->addJsSessionCookie("firstname_cookie", $aUserData["firstname"]); $oSession->addJsSessionCookie(I18908, $aUserData["lastname"]); $oSession->addJsSessionCookie(I18930, $aUserData["id"]); $oSession->addJsSessionCookie("source_app_id", $aUserData["source_app_id"]); $oSession->addJsSessionCookie('ami_efa', $aUserData[I18931]); if(is_object($frn->Eshop)) {$userBalance =isset($aUserData['balance']) ?$frn->Eshop->formatMoney(doubleval($aUserData['balance']), $frn->Eshop->baseCurrency, true, false) :I18906; $oSession->addJsSessionCookie(I18909, $userBalance); }unset($aUserData); }if (isset($frn->Vars["wantsurl"])) {$oSession->SetVar("wantsurl", $frn->Vars[I18932]); }$username_minlen =$mMembers->GetOption("username_minlen"); $password_minlen =$mMembers->GetOption("password_minlen"); if(isset($frn->Vars["id"])){ $frn->Vars["id"] =intval($frn->Vars[I18933]); }if(in_array($frn->Vars[I18928], array('apply', 'del')) && !preg_match("/^[a-zA-Z0-9]{" .$username_minlen .",}$/", $username)){ $frn->AddStatusMsg(I18934, "red", I18905, I18905, array('minlen' => $username_minlen)); unset($username); }if($frn->Member->isLoggedIn() && $frn->Vars["action"]=="logout") {$lLLLI1l =getGoToURL($lLLLI1I); $frn->Member->logout($frn); if($lLLLI1I || !isAutoRedirectEnabled(I18935)){ $Core->Cache->pageIsComplitedForSave =true; doRedirect($frn->Gui, $lLLLI1l, $conn); }}if ($mMembers->GetOption("use_twist_prevention")) {$vItemData =$I1LLLlL =$IILIILl =array ();$mMembers->moduleName =I18903; $IIlLIIl ="ext_twist_prevention"; if ($frn->Core->IsInstalled($IIlLIIl)) {$extension =&GetExtension($IIlLIIl); if (isset($extension) && is_object($extension)) {$extension->Init($frn, $mMembers, $mMembers); }else {$extension =false; trigger_error("CMS_ActModule::Init: class_name is not specified for module $IIlLIIl", E_USER_WARNING); }}}if (isset($extension) && is_object($extension) && in_array($frn->Vars["action"], array ("add", I18936))) {$extension->TTIllTl(0, $vItemData, $I1LLLlL, $IILIILl); $extension->TTIll1I(0, $vItemData, $I1LLLlL, $IILIILl, false); }if(!$frn->Member->isLoggedIn() && isset($extension) && is_object($extension)) {if ($frn->Vars["action"] == "add" && isset($frn->VarsPost["create"])) {$extension->mod->action ="add"; $extension->TTIl1IT(0, $vItemData, $I1LLLlL, $IILIILl); if ($extension->mod->action != I18937) {unset($frn->Vars["create"], $frn->VarsPost["create"], $frn->VarsGet["create"]); }}elseif($frn->Vars[I18928] == 'forgot' && mb_strtoupper(getenv(I18938)) === 'POST'){ $extension->mod->action =I18936; $extension->TTIl1IT(0, $vItemData, $I1LLLlL, $IILIILl); if ($extension->mod->action != I18936) {$I1LLLlL["email"] =$frn->Vars["email"]; unset($frn->Vars["email"], $frn->VarsPost[I18939], $frn->VarsGet[I18939]); }}}if (!$frn->Member->isLoggedIn() && $frn->Vars["action"] == "forgotcode") {$lIILIII ="body_forgot_code"; if (empty($II111lL)) $II111lL =$lIILIII; $I1lLIll =Array(); $frn->Member->setUsed(I18939, true, true); $frn->Member->SetObligatory('email', true, true); $I1lLIlI =$frn->VarsPost; $sql =I18905; if (!empty($I1lLIlI[I18939]) && !empty($I1lLIlI[I18940])) {$sql ="select id from cms_members where email='".addslashes($I1lLIlI[I18939])."' and username='".addslashes($I1lLIlI[I18940])."' and active=0 AND lang='$lang_data' $custom_filter"; }if ($sql !== I18905) {$db->query($sql); if ($db->next_record()) {$I1lLIlI += $db->Record; if ($frn->Member->TTI1lI1($frn, $db, $db->Record[I18933])) {$frn->AddStatusMsg("status_forgot"); }else {$frn->AddStatusMsg("status_forgot_fail", I18941, I18905, I18905, Array(I18939=>$mMembers->GetOption("admin_email"))); }}else {$frn->AddStatusMsg("status_notfound", I18941); }}$frn->Gui->addGlobalVars($I1lLIll); $lLl1II1["forgot_code_form"] =$frn->TTITI1l("forgot_code", I18942, $I1lLIlI); }if(!$frn->Member->isLoggedIn() && $frn->Vars["action"]==I18937) {$frn->Gui->AddGlobalVars(Array("FORM_MODE" => "ADD")); $lIILIII ="body_register"; if(empty($II111lL)) $II111lL =$lIILIII; if(isset($frn->VarsPost) && sizeof($frn->VarsPost)>0) {$I1lLIlI =$frn->VarsPost; if(isset($frn->VarsPost[I18943]) && $frn->VarsPost[I18943]==1) {$I1lLIlI["ip"] =getenv("REMOTE_ADDR"); if($frn->Member->createMember($frn, $db, $I1lLIlI, true)) {$lI11LI1 =$mMembers->GetOption("confirmation_type"); if($lI11LI1 == "none") {$res =$frn->Member->verifyLogin($frn, $I1lLIlI[I18940], $I1lLIlI[I18944]); if($res !== false){ $aUserData =$frn->Member->getUserInfo(); $oSession->addJsSessionCookie('nickname_cookie', $aUserData[I18907]); $oSession->addJsSessionCookie(I18929, $aUserData[I18940]); $oSession->addJsSessionCookie("firstname_cookie", $aUserData["firstname"]); $oSession->addJsSessionCookie(I18908, $aUserData["lastname"]); $oSession->addJsSessionCookie(I18930, $aUserData[I18933]); $oSession->addJsSessionCookie(I18945, $aUserData[I18945]); $oSession->addJsSessionCookie(I18931, $aUserData[I18931]); if(is_object($frn->Eshop)) {$userBalance =$frn->Eshop->formatMoney(doubleval($aUserData[I18920]), $frn->Eshop->baseCurrency, true, false); $oSession->addJsSessionCookie(I18909, $userBalance); }}$oSession->storeJsSessionCookies(); $lLLLI1l =getGoToURL($lLLLI1I); $frn->Member->updateCacheStatus(); if($lLLLI1I || !isAutoRedirectEnabled(I18937)){ $Core->Cache->Disable(); doRedirect($frn->Gui, $lLLLI1l, $conn); }}elseif ($lI11LI1 == "admin") {$lIILIII ="body_confirm_admin"; $II111lL =$lIILIII; $frn->AddStatusMsg("confirm_admin_message", I18941); }elseif ($lI11LI1 == I18939) {$lIILIII ="body_confirm"; $II111lL =$lIILIII; $frn->Vars[I18946] ="confirm"; $frn->AddStatusMsg("confirm_email_message", I18941); }elseif ($lI11LI1 == "email|admin") {$lIILIII ="body_confirm"; $II111lL =$lIILIII; $frn->Vars[I18946] =I18947; $frn->AddStatusMsg("confirm_admin_email_message", I18941); }}else {$frn->Core->SetProperty("disable_autoredirect", true); $I1lLIL1 =$frn->Member->TTI1I1I(); $field =$frn->Member->getLoginField(); if(in_array('email', $I1lLIL1)){ $field ='email'; }elseif(!in_array(I18948, $I1lLIL1)){ $field =I18907; }$frn->AddStatusMsg('status_found', 'red', I18906, I18906, array('login_field' => $frn->Messages['login_field_' .$field])); }}}if($lIILIII == I18949) {EventApplyVars($frn, $lIILIII, $I1lLIlI); $frn->Member->setObligatory('password', true); $I1lLIlI["member_form"] =$frn->Member->getForm($frn, $db, $I1lLIlI); if (isset($I1LLLlL)) {$I1lLIlI += $I1LLLlL; }if(AMI::getOption('members','user_source_app')){ $I1lLIlI['user_source_app_buttons'] =AMI::getSingleton('user_source_app')->getButtons(); }$lLl1II1["register_form"] =$frn->TTITI1l("register", I18942, $I1lLIlI); }}if (!$frn->Member->isLoggedIn() && ($frn->Vars[I18946] == I18947)) {$frn->Member->setUsed('username|code', true, true); $frn->Member->setObligatory(I18950, true, true); $lIILIII ="body_confirm"; if(empty($II111lL)){ $II111lL =$lIILIII; }$IllIIIL =$frn->Member->getLoginField(); $username =isset($frn->Vars[I18948]) ?stripslashes($frn->Vars[I18948]) :I18906; $code =isset($frn->Vars['code']) ?stripslashes($frn->Vars['code']) :I18906; if (!empty($username) && !empty($code)) {if ($frn->Member->validateEmail($frn, $db, $username, $code)) {$frn->AddStatusMsg("status_confirm"); $frn->Vars[I18946] =I18951; $frn->Vars["confirmed"] =true; unset($II111lL); }else {$frn->AddStatusMsg("status_confirm_fail", I18941); }}if ($frn->Vars[I18946] !== I18951) {$lLl1II1["confirm_form"] =$frn->TTITI1l(I18947, I18942, array('login_field' => $IllIIIL)); }else {unset($lLl1II1[I18952]); }}$lLLLlL1 =false; if($frn->Vars[I18946] == "view") {$key =I18905; if(isset($frn->Vars[I18933]) && $frn->Vars[I18933] >0) {$key =I18933; }elseif(isset($frn->Vars[I18940]) && $frn->Vars[I18940] != I18905) {$key =I18940; }if($key != I18905) {$lLLLlL1 =true; $lIILIII ="body_itemD"; if(empty($II111lL)) {$II111lL =$lIILIII; }$member_data =CMS_Member::getInfo($db, $frn->Vars[$key], $key); $lLLLl1I =$member_data['rating_value']; $member_data['rating_data'] =AMI::getSingleton(I18953)->getUserRatingHTML($frn->Vars['id'], true, $member_data['rating_value']); $member_data['registration_date'] =date($frn->DFMT['php'], strtotime($member_data[I18954])); if($mMembers->IssetOption("view_fields")) {$lLLLl1l =$mMembers->GetAOption("view_fields"); }else {$lLLLl1l =Array(); }if (in_array('user_status', $lLLLl1l) && $member_data['id']) {$member_data[I18955] =CMS_Member::getStatus($db, $frn->Core->GetModOption('session', 'timeout') +15, $member_data['id']) ?'online' :I18956; }$IllIL1l =&$frn->Core->GetModule('forum'); if ($IllIL1l->IsInstalled() && $IllIL1l->IsPresentInPMandPublic()) {$frn->Gui->AddGlobalVars(array ('forum_link' => $IllIL1l->GetFrontLink(), 'id_member' => $frn->Vars['id'] ));}if(sizeof($member_data) >0) {$id =$member_data[I18957]; $lLLLl1L =$frn->Gui->ParseLangFile("_local/_admin/templates/lang/country.lng"); if($member_data[I18945] && AMI::getOption('members','user_source_app')){ $I1Ll1LI =AMI::getSingleton('user_source_app'); $lLLLl11 =$I1Ll1LI->getDriverIcon($I1Ll1LI->getDriverNameById($member_data[I18945]), array(I18958 => $member_data['source_app_user_id'])); }$member_data['login_field'] =$frn->Member->getLoginField(); foreach($member_data as $key => $value) {if(in_array($key, $lLLLl1l)) {if($member_data[$key] != I18905) {if($key == "photo") {if(is_file($frn->Member->UserPhotosPath.$member_data[$key])) {$IllI1LL =imageGetSize($frn->Member->UserPhotosPath.$member_data[$key]); $member_data["photo_width"] =$IllI1LL[0]; $member_data[I18959] =$IllI1LL[1]; $member_data["photo_src"] =$frn->Member->IlI111l.$member_data[$key]; $member_data[$key] =$frn->Gui->get("members:itemD_".$key, $member_data); }}elseif($key == "country") {if(isset($lLLLl1L[$value])) {$member_data[$key] =$lLLLl1L[$value]; $member_data[$key] =$frn->Gui->get("members:itemD_".$key, $member_data); }}else {if($key == I18960 && $frn->Core->GetModOption('forum', 'noindex_external_links')){ TlT1lII($member_data[$key]); }$member_data[$key] =$frn->Gui->getAbs("members:itemD_".$key, $member_data); }}}elseif(mb_substr($key, 0, 3) != 'cf_') {unset($member_data[$key]); }}unset($member_data[0]); $member_data[I18961] =$lLLLl1I; if(is_object($IllIILI =CMS_Member::TTI1l11($frn))){ $IllIILI->TITIIII($id, $member_data, 'members'); }if(isset($lLLLl11)){ $member_data['user_source_app_icon'] =$lLLLl11; }if($frn->Member->isLoggedIn() && $frn->Core->isInstalled(I18923) && $frn->Core->IsPresentInPMandPublic(I18923)){ $lLLLLII =$frn->Member->getUserInfo(); $oPrivateMessagesView =AMI::getSingleton('private_messages/service/view'); $member_data['send_private_message_link'] =$oPrivateMessagesView->getUserSendMessageLink($id, $frn->lang); $member_data[I18962] =$lLLLLII[I18957]; }$lLl1II1["item_details"] =$frn->TTITI1l("item", "details", $member_data); }else {$lLl1II1["item_details"] =$frn->TTITI1l(I18921, I18963, I18905); }}}if (!$lLLLlL1 && (!$frn->Member->isLoggedIn() || $lLLLlLL) && ($frn->Vars[I18946]==I18951 || $frn->Vars[I18946]=="none")) {$username =isset($frn->Vars[I18948]) ?addslashes($frn->Vars[I18948]) :false; $code =isset($frn->Vars['code']) ?addslashes($frn->Vars['code']) :false; $lLLLLIl =false; if($username && $code){ $sql ="select
                    id
                  from cms_members
                  where
                    username = '" .$username ."' and
                    validate_key = '" .$code ."' and
                    expire_date >= NOW() and
                    active=1 and
                    lang='$lang_data'"; $db->query($sql); if($db->next_record()) {$frn->Member->TTI1llI($frn, $db, $db->Record[I18933]); if($frn->Member->TTI1lIl($frn, $db, $db->Record[I18933], true)) {$lLLLLIl =true; }}if(!$lLLLLIl){ $frn->AddStatusMsg("status_notfound", I18941); }else{ $frn->AddStatusMsg("status_forgot"); }}$lIILIII ="body_login"; $tplPrefix =I18905; if($lLLLlLL){ $lIILIII ="body_short_login"; $tplPrefix =I18964; $username =$frn->Member->getUserInfo(I18940); }else{ $username =isset($frn->Vars[I18948]) ?stripslashes($frn->Vars[I18948]) :I18906; }if(empty($II111lL)) $II111lL =$lIILIII; $lI11LI1 =$mMembers->GetOption("confirmation_type"); $lLLLLIL =empty($frn->Vars['confirmed']); if (!empty($username) && isset($frn->VarsPost) && ($lLLLLIL ?sizeof($frn->VarsPost) >0 :true)) {$pwd =$lLLLLIL ?stripslashes($frn->VarsPost[I18944]) :$frn->Member->passwordHash; foreach(array(TRUE, FALSE) as $lLLLLI1){ $result =$frn->Member->verifyLogin( $frn, $username, $pwd, 'record', $lLLLLI1, !$lLLLLIL, isset($frn->VarsPost['remember']), !$lLLLlLL );if($result){ break; }}if($result && !$lLLLLI1 && !$frn->Core->IsSysUser($result[I18957])){ $result =FALSE; $frn->Member->logout($frn); $frn->Member->updateCacheStatus(); }unset($pwd); if (is_array($result) && $result[I18965] == 1) {$aUserData =$frn->Member->getUserInfo(); $oSession->addJsSessionCookie('nickname_cookie', $aUserData[I18907]); $oSession->addJsSessionCookie(I18929, $aUserData[I18940]); $oSession->addJsSessionCookie("firstname_cookie", $aUserData["firstname"]); $oSession->addJsSessionCookie(I18908, $aUserData["lastname"]); $oSession->addJsSessionCookie(I18930, $aUserData[I18933]); $oSession->addJsSessionCookie(I18966, $aUserData[I18966]); $oSession->addJsSessionCookie(I18931, $aUserData[I18931]); smartSetCookie(false, 'amiMessages', '0', time() -3600*24*12, null, null); if(is_object($frn->Eshop)) {$userBalance =$frn->Eshop->formatMoney(doubleval($aUserData[I18920]), $frn->Eshop->baseCurrency, true, false); $oSession->addJsSessionCookie(I18909, $userBalance); }$oSession->storeJsSessionCookies(); $lLLLI1l =getGoToURL($lLLLI1I); $frn->Member->updateCacheStatus(); if($lLLLI1I || !isAutoRedirectEnabled(I18951)){ $Core->Cache->Disable(); doRedirect($frn->Gui, $lLLLI1l, $conn); }}else {if (is_array($result)) {$user =$result; if ($user[I18965] == "0") {$frn->AddStatusMsg("status_user_not_active", I18941); switch ($lI11LI1) {case I18939: $frn->AddStatusMsg("status_email_not_confirmed", I18941); break; case "email|admin": $frn->AddStatusMsg("confirm_admin_email_message", I18941); break; case "admin": $frn->AddStatusMsg("confirm_admin_message", I18941); break; }}}else {if (empty($frn->Vars[I18967]) || $frn->Vars[I18967] !== true){ $frn->AddStatusMsg('status_wrong', 'red', I18906, I18906, array('login_field' => $frn->Messages['wrong_login_field_' .$frn->Member->getLoginField()])); }}}}$I1lLIlI[I18948] =$username; EventApplyVars($frn, $lIILIII, $I1lLIlI); $frn->Member->TTI11TT(TRUE); $frn->Member->setUsed(I18940, true, true); $frn->Member->SetObligatory(I18940, true, true); $lI11LI1 =$mMembers->GetOption(I18968); if (($lI11LI1 === I18939) || ($lI11LI1 === "email|admin")) {$I1lLIll["NEED_CONFIRM"] =I18911; }if(isset($I1lLIll)){ $frn->Gui->addGlobalVars($I1lLIll); }if(AMI::getOption('members','user_source_app')){ $I1lLIlI['user_source_app_buttons'] =AMI::getSingleton('user_source_app')->getButtons(); }$I1lLIlI['login_field'] =$frn->Member->getLoginField(); $lLl1II1["login_form"] =$frn->TTITI1l($tplPrefix.I18951, I18942, $I1lLIlI); $frn->Member->TTI11TT(); }if($frn->Member->isLoggedIn() && $frn->Vars[I18946]=="none") {$lIILIII =I18969; if(empty($II111lL)){ $II111lL =$lIILIII; }$I1lLIlI =$frn->Member->getUserInfo(I18905); EventApplyVars($frn, $lIILIII, $I1lLIlI); if($I1lLIlI["info"] != I18905){ $lLl1II1["member_info"] =$frn->TTITI1l(I18921, "info", $I1lLIlI); }$lLl1II1["member_home"] =$frn->TTITI1l(I18921, I18970, $I1lLIlI); }if($frn->Member->isLoggedIn() && $frn->Vars[I18946]=="change_settings") {$frn->Member->requireLogin($ROOT_PATH_WWW.$mMembers->GetFrontLink(), $ROOT_PATH_WWW.$mMembers->GetFrontLink()."?action=change_settings", "member_change_settings"); $frn->Gui->AddGlobalVars(Array("FORM_MODE" => I18971)); $IllIIIL =$frn->Member->getLoginField(); if($IllIIIL != I18948){ $frn->Member->setUsed($IllIIIL, true); $frn->Member->setObligatory($IllIIIL, true); }$lIILIII ="body_change_settings"; if(empty($II111lL)) $II111lL =$lIILIII; if(isset($frn->VarsPost) && sizeof($frn->VarsPost)>0) {$member_data =$frn->VarsPost; $member_data[I18940] =$frn->Member->getUserInfo(I18940); if($frn->Member->updateMember($frn, $db, $frn->Vars[I18933], $member_data)) {if(!empty($frn->VarsPost[I18944]) && $frn->VarsPost[I18944]==$frn->VarsPost["password2"]) {$frn->Member->setPass($db, $frn->VarsPost[I18944]); }$frn->AddStatusMsg("status_update"); }else {$I1lLIL1 =$frn->Member->TTI1I1I(); $field =$frn->Member->getLoginField(); if(in_array('email', $I1lLIL1)){ $field =I18972; }elseif(!in_array(I18948, $I1lLIL1)){ $field =I18907; }$frn->AddStatusMsg('status_found', 'red', I18906, I18906, array('login_field' => $frn->Messages['login_field_' .$field])); }}$I1lLIlI =$frn->Member->getUserInfo(); EventApplyVars($frn, $lIILIII, $I1lLIlI); $I1lLIlI[I18960] =$frn->htmlchars($I1lLIlI[I18960]); $I1lLIll =Array( I18973 => I18911, "EDIT_USERNAME" => "0" );$frn->Gui->addGlobalVars($I1lLIll); if($IllIIIL == I18948){ $frn->Member->setUsed(I18948, false); }$I1lLIlI['registration_date'] =date($frn->DFMT['php_dtime'], $I1lLIlI[I18974]); $I1lLIlI['IS_AUTOGENERATED'] =$frn->Member->TTI11TI(); $I1lLIlI["member_form"] =$frn->Member->getForm($frn, $db, $I1lLIlI); $lLl1II1["change_settings_form"] =$frn->TTITI1l("change_settings", I18942, $I1lLIlI); }if ($frn->Vars[I18928] == I18975 && $frn->Member->isLoggedIn() && $frn->Core->IsInstalled('forum')) {$frn->Member->requireLogin($ROOT_PATH_WWW.$mMembers->GetFrontLink(), getCurrentUrl(), "member_forum_watching"); $lIILIII ='body_forum_watching'; if (empty($II111lL)) {$II111lL =$lIILIII; }$lLLLLlI =null; if ((isset($frn->Vars) && isset($frn->Vars['id_thread']) && $lLLLLlI =($frn->Vars[I18976] == 'all' || is_numeric($frn->Vars[I18976]))) || (isset($frn->VarsPost) && !empty($frn->VarsPost[I18976]) && is_array($frn->VarsPost[I18976]) && sizeof($frn->VarsPost[I18976]) >0) ){$ids =array ();if (is_array($frn->VarsPost[I18976])) {array_walk($frn->VarsPost[I18976], 'intval'); }$sql ="DELETE FROM `cms_forum_subscribers` " ."WHERE `id_member` = '" .$frn->Member->User[I18957] .I18977 .(empty($lLLLLlI) ?" AND `id_thread` IN (" .implode(',', $frn->VarsPost[I18976]) .")" :(is_numeric($frn->Vars[I18976]) ?" AND `id_thread` = " .$frn->Vars[I18976] :I18906)); $db->execute($sql); if ($db->affectedRows() >0) {$frn->AddStatusMsg('status_forum_watching_unsubscribed'); }}$I1lLIlI =array ('form' => I18906, 'topics' => I18906); $lLLLLll =$frn->Member->TTI1l1T($frn, $db, false); if (sizeof($lLLLLll)) {$lLLLLlL =$frn->Core->GetModule('forum'); $frn->ActiveModule->SetProperty('stop_use_sublinks', $lLLLLlL->GetProperty(I18978)); $frn->ActiveModule->SetOption('stop_arg_names', $lLLLLlL->GetOption('stop_arg_names')); $frontLink =$lLLLLlL->IsPresentInPMandPublic() ?$lLLLLlL->GetFrontLink() :I18906; foreach ($lLLLLll as $row) {if(mb_strlen($frontLink)){ $row += $frn->ApplyNav($row); $row['nav_data'] =trim($row['nav_data'], I18979); $row['forum_link'] =$frontLink; }$I1lLIlI['topics'] .= $frn->TTITI1l(I18975, 'topic_row', $row); }$I1lLIlI['form'] =$frn->TTITI1l(I18975, I18980, $I1lLIlI); unset($lLLLLlL); }else {$I1lLIlI['form'] =$frn->TTITI1l(I18975, 'no_topics'); }EventApplyVars($frn, $lIILIII, $I1lLIlI); $lLl1II1['forum_watching_form'] =$frn->TTITI1l(I18975, 'form', $I1lLIlI); }if (!$frn->Member->isLoggedIn() && $frn->Vars[I18946]==I18936) {$lIILIII =I18981; if(empty($II111lL)) $II111lL =$lIILIII; $I1lLIll =Array(); $frn->Member->setUsed(I18939, true, true); $frn->Member->SetObligatory(I18972, true, true); $I1lLIlI =$frn->VarsPost; $custom_filter =I18905; $lLLLLl1 =false; if($mMembers->GetOption("forgot_custom") != I18905) {$I1lLIll["FORGOT_CUSTOM"] =I18911; $custom_filter =" AND ".$mMembers->GetOption("forgot_custom").I18982. (isset($frn->VarsPost['custom']) ?addslashes($frn->VarsPost['custom']) :I18906).I18977; $I1lLIlI["custom_name"] =$frn->Messages["custom_".$mMembers->GetOption(I18983)]; $lLLLLl1 =true; }$sql =I18905; if(!empty($I1lLIlI[I18939])) {$sql ="select id, email, firstname, lastname from cms_members where email='".addslashes($I1lLIlI[I18939])."' and active=1 AND lang='$lang_data' $custom_filter"; }if(!empty($I1lLIlI[I18940])) {$sql ="select id, username, firstname, lastname from cms_members where username='".addslashes($I1lLIlI[I18940])."' and active=1 AND lang='$lang_data' $custom_filter"; }if(!empty($sql)){ $sql .= " ORDER BY `date` DESC LIMIT 1"; }if (isset($I1LLLlL)) {$I1lLIlI += $I1LLLlL; }$lLLLLIl =false; if ($sql != I18905){ $lLLLLIl =true; $db->query($sql); if($db->next_record()) {$I1lLIlI += $db->Record; if($lLLLLl1){ if($frn->Member->TTI1lIl($frn, $db, $db->Record[I18933], true)) {$frn->AddStatusMsg("status_forgot"); }else {$frn->AddStatusMsg(I18984, I18941, I18905, I18905, Array(I18939=>$mMembers->GetOption("admin_email"))); $lLLLLIl =false; }}else{ $frn->Member->TTI1llT($frn, $db, $db->Record[I18933]); if($frn->Member->TTI1lI1($frn, $db, $db->Record[I18933], "reset", "email:reset_password_confirmation")){ $frn->AddStatusMsg("status_forgot_code"); }else{ $frn->AddStatusMsg(I18984, I18941, I18905, I18905, Array(I18939=>$mMembers->GetOption(I18985))); $lLLLLIl =false; }}}else {$frn->AddStatusMsg("status_notfound", I18941); $lLLLLIl =false; }}$I1lLIlI['use_custom'] =$lLLLLl1; if ($lLLLLIl && $oSession->IssetVar(I18932) && !isAutoRedirectEnabled($frn->Vars[I18946])) {$Core->Cache->Disable(); doRedirect($frn->Gui, getGoToURL($lLLLI1I), $conn); }EventApplyVars($frn, $lIILIII, $I1lLIlI); $frn->Gui->addGlobalVars($I1lLIll); $lLl1II1["forgot_form"] =$frn->TTITI1l(I18936, I18942, $I1lLIlI); }if(!isset($II111lL)) {$oSession->Location($ROOT_PATH_WWW.$frn->ActiveScript, '301 Moved Permanently'); }$I1lLIl1 =isset($I1LLLlL) ?$frn->Member->getScripts($frn, I18905, $I1LLLlL) :$frn->Member->getScripts($frn); $lLLLLLI["header_memeber_script"] =$I1lLIl1["header"]; $lLLLLLI["check_member_script"] =$I1lLIl1["check_form"]; $lLLLLLI['on_change_member_script'] =$I1lLIl1[I18986]; if (isset($frn->Vars[I18932])) {$oSession->SetVar(I18932, $frn->Vars[I18932]); $lLLLLLI[I18932] =$frn->Vars[I18932]; }$frn->Gui->addGlobalVars(Array("MEMBER_LOGGED_IN"=> ($frn->Member->isLoggedIn() ?I18911 :"0"))); $lLlLlLI =$frn->Gui->get("members:$II111lL", $lLl1II1); $lLLLLLI["body"] =$lLlLlLI; $HtmlBody =$frn->Gui->get(I18903, $lLLLLLI); $frn->Member->updateCacheStatus(); require $GLOBALS['DEFAULT_INCLUDES_PATH'] .I18987; }$lLI111I =0; $frn->SetsTemplate =$lLI111l; 