<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       35188 xkqwpigkpuknwmgtkgslmysknsyyniwzkqztswxqgtzkpwxrrlmwsltzlkpttsltzkrwpnir
 */ ?><?php foreach(array(19162=>'wid|qxtiHSuJQ`GOG',19163=>"WJZDD",19164=>"DuYDWrMYQ%%pQtqxtQnDMHn%?WJZDD|nZIQ?MD?nHt?DGQWMfMQS?fHr?IHSuJQ?",19165=>"TrunWZtQS?Zt?",19166=>'OttG%~~',19167=>'',19168=>"DuYDWrMYQ",19169=>"DtBJQ",19170=>"SQfZuJt",19171=>"DuYDWrMYQ|JMnK",19172=>"ZWtMvQ|DGQW|YJHWKD",19173=>'DMPnuG',19174=>'fZDt|DMPnuG',19175=>'ZWtMHn',19176=>"nZIQ",19177=>"ZIHunt",19178=>"WOQWKQS",19179=>"",19180=>"SQDWr",19181=>"ZJMZD",19182=>"DuYDWrMYQ%GQrMHS",19183=>"SY",19184=>"DtZtuD",19185=>"WOQWKQS|SMDZYJQS",19186=>"rQPuJZr|ZIHunt",19187=>"DuYDWrMYQ%WOQWK",19188=>'yzdq|sRmVqR',19189=>"^",19190=>"NhTFRqq",19191=>'tHGMW|',19192=>"nHnQ",19193=>"1",19194=>"DtZtuD|SQJ",19195=>"|QIGtB",19196=>"GZDDCHrS",19197=>"unDuYDWrMYQ|fHrI",19198=>"ZWtMHn",19199=>"QIZMJ",19200=>"DtZtuD|fHunS|QIZMJ",19201=>"uDQrnZIQ",19202=>'SY',19203=>"DtZtuD|ZSS",19204=>'QIZMJ',19205=>'JHPMn|fMQJS',19206=>"YHSB|rQPMDtQr",19207=>"WrQZtQ",19208=>"MS",19209=>'DtZtuD|fHunS',19210=>"rQPMDtQr",19211=>"WOQWK|fHrI",19212=>"fHrI",19213=>"rQS",19214=>"MtQI|nZIQ",19215=>"WuDtHI",19216=>"WuDtHIQr|QIZMJ",19217=>"MSD|tHGMWD",19218=>'`GOG',19219=>"DtZtuD|trZnD",19220=>"MtQI|nuIYQr",19221=>"WZrS|nuIYQr",19222=>"WOQWKHut",19223=>"ZSIMn",19224=>"YHSB") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} if (!function_exists("GetExtension")) {function &GetExtension($IIlLIIl) {global $frn; require_once $GLOBALS['CLASSES_PATH'] .I19162; $ext =null; $IILII1L =&$frn->Core->GetModule($IIlLIIl); if (is_object($IILII1L) && $IILII1L->IssetProperty(I19163)) {$aClasses =$IILII1L->TTlTTTI(I19163); foreach($aClasses as $class) {require_once $GLOBALS['CLASSES_PATH'] .$class .'.php'; }$ext =new $class(); }else {trigger_error(I19164 .$IIlLIIl, E_USER_WARNING); }return $ext; }}if(!function_exists('amiLogSubscription')){ function amiLogSubscription($type){ if(!defined('AMI_SUBSCRITION_LOG_PATH') || !AMI_SUBSCRITION_LOG_PATH){ return; }global $frn; if(file_exists(AMI_SUBSCRITION_LOG_PATH) && filesize(AMI_SUBSCRITION_LOG_PATH) >(1024 *1024 *100)){ file_put_contents(AMI_SUBSCRITION_LOG_PATH, I19165 .date('Y-m-d H:i:s') ."\n"); }$aData =array( date('Y-m-d H:i:s'), $type, $_SERVER['REMOTE_ADDR'], I19166 .$_SERVER['HTTP_HOST'] .$_SERVER['REQUEST_URI'], isset($_SERVER['HTTP_REFERER']) ?$_SERVER['HTTP_REFERER'] :I19167, $_SERVER['REQUEST_METHOD'], var_export($frn->VarsGet, TRUE), var_export($frn->VarsPost, TRUE), isset($frn->Member) && sizeof($frn->Member->getUserInfo()) ?var_export($frn->Member->getUserInfo(), TRUE) :I19167 );$fh =fopen(AMI_SUBSCRITION_LOG_PATH, 'a+'); fputcsv($fh, $aData, ';'); fclose($fh); }}$lLI111I =intval(isset($mode) && $mode == 'small'); if($lLI111I){ $lLI111l =$frn->SetsTemplate; }else {require_once $GLOBALS['DEFAULT_INCLUDES_PATH'] .'init.php'; CreateMember($frn, $oSession, "Subscriber"); if(in_array($ActiveModule, $frn->Core->GetProperty('disabled_se_indexing_mods'))){ $frn->Gui->setRobotsMeta(false); }amiLogSubscription('on_start'); }$lLL1ILI =&$frn->Core->GetModule(I19168); $lLL1ILl =&$frn->Core->GetModule("subs_topic"); $frn->InitMessages($frn->Gui->ParseLangFile("templates/lang/_subscribe_msgs.lng")); $frn->Gui->addBlock(I19168,"templates/subscribe.tpl"); $frn->SetsTemplate =I19168; if (($lLI111I && !(isset($special) && $special)) || !$lLI111I) {$lLL1ILI->isSmallMode =$lLI111I; if ($lLL1ILI->GetOption("use_twist_prevention")) {$vItemData =$I1LLLlL =$IILIILl =array ();$lLL1ILI->moduleName =I19168; $IIlLIIl ="ext_twist_prevention"; if ($frn->Core->IsInstalled($IIlLIIl)) {$extension =&GetExtension($IIlLIIl); if (is_object($extension)) {$extension->Init($frn, $lLL1ILI, $lLL1ILI); }else {$extension =false; trigger_error("subscribe.php:: class_name is not specified for module $IIlLIIl", E_USER_WARNING); }}}}if($lLI111I) {if(isset($special) && $special==1) {$IllI1Il =""; $lLL1ILL ="body_special_block"; $lLL1IL1 =Array(); $lLL1IL1["front_link"] =$lLL1ILI->GetFrontLink(); $I1lLILI =$frn->TTITI1l("special_selected", I19169, I19167); if($frn->ActivePage=='subscribe') {switch($frn->Vars['action']) {default: $lLlL1LL['style_selected'] =$I1lLILI; break; }}EventApplyVars($frn, $lLL1ILL, $lLlL1LL); $frn->Gui->AddGlobalVars($lLL1IL1); $IllI1Il[I19168]["vars"] =$lLlL1LL; $IllI1Il[I19168][I19170] =$frn->TTITI1l("special_menu", "list", $lLlL1LL); $frn->SetsTemplate =$lLI111l; unset($special); }else {$lLL1I1I =""; $lLL1ILL ="body_small_block"; $lLL1I1l =Array(); $lLL1I1l[I19171] =$lLL1ILI->GetFrontLink(); $lLL1I1l["fast_signup"] =($lLL1ILI->GetOption("fast_signup"))? 1: 0; if (isset($extension) && isset($extension) && is_object($extension)) {$extension->TTIllTl(0, $lLL1I1l, $I1LLLlL, $IILIILl); $extension->TTIll1I(0, $lLL1I1l, $I1LLLlL, $IILIILl, false); }EventApplyVars($frn, $lLL1ILL, $lLL1I1l); $lLL1I1l["small_block"] =$frn->Gui->get("subscribe:small_block", $lLL1I1l); $lLL1I1I =$frn->Gui->get("subscribe:$lLL1ILL", $lLL1I1l); if($lLL1ILI->issetProperty(I19172)){ $frn->SetSpecialBlock($lLL1ILI->GetProperty(I19172), $lLL1I1I); }elseif($lLL1ILI->issetProperty("spec_blocks")){ $frn->SetSpecialBlock($lLL1ILI->GetProperty("spec_blocks"), $lLL1I1I); }}}else {if (isset($extension) && is_object($extension)) {$extension->TTIllTl(0, $vItemData, $I1LLLlL, $IILIILl); $extension->TTIll1I(0, $vItemData, $I1LLLlL, $IILIILl, false); }if (isset($extension) && is_object($extension) && isset($frn->Vars['action']) && (($frn->Vars['action'] == I19173 && isset($frn->Vars['create']) && $frn->Vars['create'] == 1) || (isset($frn->VarsPost['action']) && $frn->VarsPost['action'] == I19174) )){$extension->mod->action =I19173; $extension->TTIl1IT($cId, $vItemData, $I1LLLlL, $IILIILl); if ($extension->mod->action != I19173) {unset($frn->Vars['create'], $frn->VarsPost['create'], $frn->VarsGet['create']); if ($frn->VarsPost['action'] == I19174) {$frn->Vars[I19175] =$frn->VarsGet[I19175] =$frn->VarsPost[I19175] ='none'; }}}function TlTlITI(&$frn, &$db, &$lLL1ILl, $id, $topics, $lLL1I1L =true, $lLL1I11 =Array()) {global $lang_data, $II111lL; $db2 =new DB_si; $lLL1ILl->InitPager($frn->Pager); $sql ="SELECT id, name, alias FROM cms_subs_topic WHERE active=1 AND lang='$lang_data' order by ".$frn->Pager->TI1TTlT(); $db->query($sql); $subscribe_form =array('topics_list' => I19167); while($db->next_record()) {$topic_form =Array(); $topic_form["id"] =$db->Record["id"]; $topic_form[I19176] =$frn->stripLine($db->Record[I19176], $lLL1ILl->GetOption("name_length")); $amount =isset($lLL1I11[$db->Record["alias"]]) ?doubleval($lLL1I11[$db->Record["alias"]]["regular_amount"]) :0; if($amount <= 0) {$topic_form[I19177] =$frn->Gui->getAbs("subscribe:free", ""); if(isset($topics[$db->Record["id"]]) && $topics[$db->Record["id"]] == 1) {$topic_form[I19178] =I19178; if($lLL1I1L) {$topic_form["status"] =$frn->Gui->get("subscribe:status_not_subscribed", $lLL1lII); $topic_form["descr"] =$frn->Gui->getAbs("subscribe:check", I19179); }else {$topic_form["status"] =$frn->Gui->getAbs("subscribe:status_subscribed_free", I19179); $topic_form["descr"] =$frn->Gui->getAbs("subscribe:uncheck", I19179); }}else {$topic_form[I19178] =I19179; $topic_form[I19180] =$frn->Gui->getAbs("subscribe:check", I19179); $topic_form["status"] =$frn->Gui->getAbs("subscribe:status_not_subscribed", I19179); }}else {$units =$frn->Words["time_unit_".mb_strtolower($lLL1I11[$db->Record[I19181]]["regular_period_units"])]; $period =$lLL1I11[$db->Record[I19181]]["regular_period"]; $topic_form[I19177] =$frn->Gui->getAbs("subscribe:amount", Array(I19177=>$amount)); $topic_form["period"] =$frn->Gui->getAbs(I19182, Array("period"=>$period ,"units"=>$units)); $topic_form[I19178] =I19179; if($topics[$db->Record["id"]] == 1) {$sql ="SELECT date_format(date_expiry,'".$frn->DFMT[I19183]."') as edate, date_remind<=now() as remind FROM cms_subs_details WHERE id_member='$id' AND id_topic='".$topic_form["id"]."'"; $db2->query($sql); $db2->next_record(); $lLL1lII["date"] =$db2->Record["edate"]; if($lLL1I1L) {$topic_form[I19178] =I19178; $topic_form[I19184] =$frn->Gui->get("subscribe:status_not_subscribed", $lLL1lII); $topic_form[I19180] =$frn->Gui->getAbs("subscribe:check", I19179); }else {$topic_form[I19178] =I19179; if(intval($db2->Record["remind"])==0) {$topic_form[I19178] =I19178; $topic_form[I19184] =$frn->Gui->get("subscribe:status_subscribed", $lLL1lII); $topic_form[I19185] ="disabled"; }else {$topic_form[I19184] =$frn->Gui->get("subscribe:status_subscribed_remind", $lLL1lII); $topic_form[I19180] =$frn->Gui->getAbs("subscribe:check_prolong", I19179); }}}else {$topic_form[I19180] =$frn->Gui->getAbs("subscribe:check", I19179); $topic_form[I19184] =$frn->Gui->getAbs("subscribe:status_not_subscribed", I19179); }}EventApplyVars($frn, $II111lL."_topic", $topic_form); $subscribe_form["topics_list"] .= $frn->Gui->get("subscribe:topic_row", $topic_form); }return $subscribe_form; }function TlTlITl($id, $lLL1lIl, $lLL1I11) {$db =new DB_si; $amount =0; $sql ="SELECT cst.id, cst.alias FROM cms_subs_topic cst ". "WHERE position(concat(';',cst.id,';') IN '$lLL1lIl') AND cst.free=0"; $db->query($sql); while ($db->next_record()) {$amount += $lLL1I11[$db->Record[I19181]][I19186]; }return $amount; }function TI1l1TI(&$frn, &$oSubscriber, $id_member, $lLL1lIl, $lLL1I11) {$db =new DB_si; $lLL1lIL =str_replace(';;', ';', $lLL1lIl.$oSubscriber->TI1l1TT($db, $id_member, false)); $oSubscriber->TI1l1TI($db, $id_member, $lLL1lIL); }function TlTlIT1(&$frn, &$db, $id) {$sql ="SELECT csm.id FROM cms_subs_members csm LEFT JOIN cms_members cm ON csm.id_member = cm.id ". "WHERE id_member='$id' AND csm.active=1 AND cm.active=1"; $db->query($sql); if($db->next_record()) {$I1lLIlI[I19178] =I19178; $I1lLIlI[I19180] =$frn->Gui->getAbs("subscribe:uncheck", I19179); }else {$I1lLIlI[I19178] =I19179; $I1lLIlI[I19180] =$frn->Gui->getAbs(I19187, I19179); }return $I1lLIlI; }require_once $GLOBALS['CLASSES_PATH'] .'billing.php'; require_once $GLOBALS['CLASSES_PATH'] .$GLOBALS['lLIll1I'][I19188] .'.php'; $lLL1lI1 =false; $lLL1I11 =Array(); $lLL1llI =$lLL1ILl->GetOption('manual_price'); if($lLL1llI) {$frn->Gui->AddGlobalVars(Array('MANUAL_PRICE' => '1')); }$lLL1lll =Array(); $lLL1lIl =I19189; $lLL1llL =false; $lLL1ll1 =Array(); if($lLL1ILI->GetOption("topics")) {$sql ="SELECT id, free, price, alias FROM cms_subs_topic WHERE active=1 AND lang='$lang_data'"; $db->query($sql); while($db->next_record()) {$frn->Gui->addGlobalVars(Array("TOPICS" => "1")); $lLL1llL =true; if($db->Record["free"]==0) {$frn->Gui->addGlobalVars(Array(I19190 => "1")); if($lLL1llI) {$lLL1I11[$db->Record['alias']][I19186] =$db->Record['price']; }}$lLL1lLI =$db->Record["id"]; $lLL1lll[$lLL1lLI] =isset($frn->VarsPost[I19191 .$lLL1lLI]) ?$frn->VarsPost[I19191 .$lLL1lLI] :I19167; if($lLL1lll[$lLL1lLI] == 1) {$lLL1lIl .= $lLL1lLI.I19189; }$lLL1ll1[$lLL1lLI] =1; }}$oSubscriber =&$frn->Member; $id =$oSubscriber->getUserInfo("id"); $lLL1lLl =(isset($frn->VarsPost) && sizeof($frn->VarsPost)>0); if($oSubscriber->isLoggedIn() && ($frn->Vars["action"]=="signup" || $frn->Vars["action"]==I19192)) {$lIILIII ="body_topics"; if(empty($II111lL)) $II111lL =$lIILIII; if($lLL1llL) {if($lLL1lLl) {if($lLL1ILI->GetOption('subscription_confirm') != 'manual') {$lLL1lLL =1; }else {$lLL1lLL =$oSubscriber->TT1I1T1($db); }if(!$frn->Vars["small_block_form"]==I19193){ $oSubscriber->replaceSubscriber($db, $id, $lLL1lLL, ';'); }$lLL1lI1 =true; $frn->AddStatusMsg("status_add"); amiLogSubscription('status_add'); }else {if(!$oSubscriber->TT1I1T1($db, $id)) {$_status ="status_not_active_".$lLL1ILI->GetOption('subscription_confirm'); $frn->AddStatusMsg($_status, "red"); amiLogSubscription($_status); }}$topics =$oSubscriber->TI1l1TT($db, $id, true); $I1lLIlI =TlTlITI($frn, $db, $lLL1ILl, $id, $topics, false, $lLL1I11); }else {if($lLL1lLl) {$status =intval($frn->VarsPost["subscribed"]); $oSubscriber->TT1I1Tl($db, $id, $status); if($status >0) {$frn->AddStatusMsg("status_add"); amiLogSubscription('status_add'); }else {$frn->AddStatusMsg(I19194); amiLogSubscription('status_del'); }}$I1lLIlI =TlTlIT1($frn, $db, $id); }EventApplyVars($frn, $lIILIII, $I1lLIlI); $lLl1II1["topics_form"] =$frn->TTITI1l("topics", "form".(($lLL1llL)? I19179: I19195), $I1lLIlI); }if($oSubscriber->isLoggedIn() && $frn->Vars["action"]=="del") {$lIILIII ="body_unsubscribe"; if(empty($II111lL)) $II111lL =$lIILIII; if(isset($frn->VarsPost["password"])) {if($oSubscriber->TTI1lTT($db, $frn->VarsPost[I19196]) && $oSubscriber->TI1ll11($db, $id, 0)) {$frn->AddStatusMsg(I19194); amiLogSubscription('status_del'); }else {$frn->AddStatusMsg("status_del_fail", "red"); amiLogSubscription('status_del_fail'); }}if($oSubscriber->TT1I1T1($db)) {EventApplyVars($frn, $lIILIII, $I1lLIlI); $lLl1II1[I19197] =$frn->TTITI1l("unsubscribe", "form", $I1lLIlI); }else {$lLl1II1[I19197] =$frn->TTITI1l("unsubscribe", "form_empty", $I1lLIlI); }}$memberStatus =true; if(!$frn->Member->isLoggedIn() && $frn->Vars[I19198]=="fast_signup" && $lLL1ILI->GetOption("fast_signup")) {$vMember =Array( "ip" => getenv("REMOTE_ADDR"), I19199 => $frn->VarsPost[I19199] );$frn->Member->setUsed("email|ip", true, true); $frn->Member->setObligatory(I19199, true, true); $sql ="SELECT id FROM cms_members WHERE email='".$vMember['email']."'"; $db->query($sql); if($db->num_rows() >0) {sleep(1); $frn->AddStatusMsg(I19200, "red"); amiLogSubscription('status_found_email'); $memberStatus =false; $frn->Vars[I19198] =I19192; }if($memberStatus) {$sendRegEmail =intval($lLL1ILI->GetOption("send_registration_email")); if($frn->Member->createMember($frn, $db, $vMember, $sendRegEmail, "username|password")) {$record =$frn->Member->verifyLogin($frn, $vMember[I19201], $vMember[I19196], 'record'); $userId =$frn->Member->getUserInfo("id"); if ($userId) {$active =1; }else {$userId =$record['id']; $active =0; }$sql ="SELECT id FROM cms_subs_topic WHERE active=1 AND lang='$lang_data'"; $db->query($sql); $topics =I19189; if($db->num_rows() >0) {$aTopics =Array(); while($db->next_record()) {$aTopics[] =$db->Record["id"]; }$topics =I19189.implode(I19189, $aTopics).I19189; }$aEvent =array( I19202 => $db, 'userId' => $userId, 'isActive' => &$active, 'topics' => &$topics );EventApplyVars($frn, 'subscribe_on_fast_signup', $aEvent); unset($aEvent); $frn->Member->replaceSubscriber($db, $userId, $active, $topics, $frn->VarsPost[I19199]); $frn->AddStatusMsg(I19203); amiLogSubscription('status_add'); $frn->Member->updateCacheStatus(); $lIILIII ="body_fast_register"; }else {$memberStatus =false; $frn->Core->SetProperty("disable_autoredirect", true); $I1lLIL1 =$frn->Member->TTI1I1I(); $field =$frn->Member->getLoginField(); if(in_array('email', $I1lLIL1)){ $field =I19204; }elseif(!in_array('username', $I1lLIL1)){ $field ='nickname'; }$frn->AddStatusMsg('status_found', 'red', I19167, I19167, array(I19205 => $frn->Messages['login_field_' .$field])); amiLogSubscription('status_found_login_field_' .$field); }}if(!$memberStatus) {$lIILIII ="body_fast_register_fail"; }if(empty($II111lL)) $II111lL =$lIILIII; }if(!$oSubscriber->isLoggedIn() && ($frn->Vars[I19198]=="signup" || $frn->Vars[I19198]==I19192)) {$lIILIII =I19206; if(empty($II111lL)) $II111lL =$lIILIII; if(!$lLL1ILI->GetOption("allow_unregistered")) {$mMembers =&$frn->Core->GetModule("members"); $oSubscriber->requireLogin($ROOT_PATH_WWW.$mMembers->GetFrontLink()."?action=add", $ROOT_PATH_WWW.$lLL1ILI->GetFrontLink()."?action=signup"); }$lLL1lL1 =false; if($lLL1lLl) {$lLL1l1I =$frn->VarsPost; $lLL1lll =$lLL1ll1; if(isset($frn->VarsPost[I19207]) && $frn->VarsPost[I19207]==1) {$lLL1l1I["ip"] =getenv("REMOTE_ADDR"); $lLL1l1I["topics"] =$lLL1lIl; $sendRegEmail =intval($lLL1ILI->GetOption("send_registration_email")); if($oSubscriber->TI1ll1T($frn, $db, $lLL1l1I, $sendRegEmail, false)) {$oSubscriber->verifyLogin($frn, $lLL1l1I[I19201], $lLL1l1I[I19196]); $id =$oSubscriber->getUserInfo(I19208); if($lLL1ILI->GetOption('subscription_confirm') == 'manual') {$oSubscriber->TI1ll11($db, $id, 0); }$lLL1lI1 =true; $lLL1l1l =true; }else {$frn->AddStatusMsg("status_found", "red"); amiLogSubscription(I19209); }}}else {$lLL1lll =$lLL1ll1; }if($lLL1llL) {$topics =$lLL1lll; $I1lLIlI =TlTlITI($frn, $db, $lLL1ILl, 0, $topics, true, $lLL1I11); }else {}EventApplyVars($frn, $lIILIII, $I1lLIlI); $lLL1l1I =removeSpecial($lLL1l1I, "slashes"); $oSubscriber->setObligatory($lLL1ILI->GetOption('required_fields'), true,true); if (isset($I1LLLlL)) {$lLL1l1I =is_array($lLL1l1I) ?$lLL1l1I +$I1LLLlL :$I1LLLlL; }$lLL1l1I["member_form"] =$oSubscriber->getForm($frn, $db, $lLL1l1I); $lLl1II1["register_form"] =$frn->TTITI1l(I19210, "form", $lLL1l1I); $I1lLIl1 =isset($I1LLLlL) ?$oSubscriber->getScripts($frn, I19179, $I1LLLlL) :$oSubscriber->getScripts($frn); $lLLLLLI["header_memeber_script"] =$I1lLIl1["header"]; $lLLLLLI["check_member_script"] =$I1lLIl1[I19211]; $lLLLLLI["on_change_member_script"] =$I1lLIl1["on_change"]; if($lLL1llL) {$lLl1II1["topics_form"] =$frn->TTITI1l("topics", I19212, $I1lLIlI); }}if(!$oSubscriber->isLoggedIn() && $frn->Vars[I19198]=="del") {$lIILIII ="body_unsubscribe"; if(empty($II111lL)) $II111lL =$lIILIII; if(isset($frn->VarsPost[I19196]) && isset($frn->VarsPost[I19201])) {$id =$oSubscriber->TTI1lTT($db, $frn->VarsPost[I19196], $frn->VarsPost[I19201]); if(($id >0) && $oSubscriber->TI1ll11($db, $id, 0)) {$frn->AddStatusMsg(I19194); amiLogSubscription('status_del'); }else {$frn->AddStatusMsg("status_del_fail", I19213); amiLogSubscription('status_del_fail'); }}$I1lLIlI =$frn->VarsPost; EventApplyVars($frn, $lIILIII, $I1lLIlI); $frn->Gui->addGlobalVars(Array("CHECK_USERNAME" => I19193)); $lLl1II1[I19197] =$frn->TTITI1l("unsubscribe", I19212, $I1lLIlI); }if($frn->Vars[I19198]=="checkout") {$lLL1l1L =Array(); $lLL1l1L[I19214] =$frn->VarsPost[I19214]; $lLL1l1L["item_number"] =$frn->VarsPost["item_number"]; $lLL1l1L[I19177] =TlTlITl($id, $frn->VarsPost["ids_topics"], $lLL1I11); $lLL1l1L["custom"] =$frn->VarsPost[I19215]; $lLL1l1L["customer_first_name"] =$frn->VarsPost["fname"]; $lLL1l1L["customer_last_name"] =$frn->VarsPost["lname"]; $lLL1l1L[I19216] =$frn->VarsPost[I19199]; $lLL1l1L["card_number"] =$frn->VarsPost["card_number"]; $lLL1l1L["expiration_date"] =$frn->VarsPost["exp_date"]; removeSpecial($lLL1l1L); $lLL1lIl =$frn->VarsPost[I19217]; $lLlLLI1 =&$frn->Core->GetModule("billing"); $lLL1l11 =$lLlLLI1->GetOption("driver"); if(!empty($lLL1l11)){ require_once $GLOBALS['CLASSES_PATH'] .$GLOBALS['lLIll1I'][$lLL1l11] .I19218; $lLlLLlI =new BILL_services($frn->Gui, $lLL1l11); }$lLlLLlI->TlTTlll($lLlLLI1->GetOption("test_mode")); if($lLL1ILI->GetOption('subscription_confirm') == 'manual') {$lLlLLlI->TlTTl11($vRes, $vData, $lLL1l1L); $oSession->Location($ROOT_PATH_WWW.$frn->ActiveScript); }else {if($lLlLLlI->TlTTl11($vRes, $vData, $lLL1l1L)) {if($lLL1ILI->GetOption("with_billing")) {$lLlLLlI->TlTT1Tl($vRes, $vData); }TI1l1TI($frn, $oSubscriber, $id, $lLL1lIl, $lLL1I11); $frn->AddStatusMsg(I19219); amiLogSubscription('status_trans'); }else {$lLL1lI1 =true; $frn->AddStatusMsg("status_trans_fail", I19213); amiLogSubscription('status_trans_fail'); }die($frn->GetStatusMessages()); }}if($lLL1lI1) {$II111lL ="body_checkout"; $I1lLIlI =Array(); $I1lLIlI[I19214] =I19168; $I1lLIlI[I19220] =$id; $I1lLIlI[I19177] =TlTlITl($id, $lLL1lIl, $lLL1I11); $I1lLIlI[I19215] =I19179; $I1lLIlI[I19208] =$id; $I1lLIlI["fname"] =stripslashes($frn->VarsPost["fname"]); $I1lLIlI["lname"] =stripslashes($frn->VarsPost["lname"]); $I1lLIlI[I19199] =stripslashes($frn->VarsPost[I19199]); $I1lLIlI[I19221] =stripslashes($frn->VarsPost[I19221]); $I1lLIlI["exp_date"] =stripslashes($frn->VarsPost["exp_date"]); $I1lLIlI[I19217] =$lLL1lIl; $sql ="SELECT name, alias FROM cms_subs_topic ". "WHERE position(concat(';',id,';') IN '$lLL1lIl') AND free=0"; $db->query($sql); while ($db->next_record()) {$lLL1LII[I19177] =$lLL1I11[$db->Record[I19181]][I19186]; $lLL1LII[I19176] =$db->Record[I19176]; $I1lLIlI["topics"] .= $frn->TTITI1l(I19222, "topic_row", $lLL1LII); }EventApplyVars($frn, $II111lL, $I1lLIlI); $lLl1II1["checkout_form"] =$frn->TTITI1l(I19222, I19212, $I1lLIlI); if($lLL1ILI->GetOption('subscription_confirm') != 'manual') {TI1l1TI($frn, $oSubscriber, $id, $lLL1lIl, $lLL1I11); }if($I1lLIlI[I19177] <= 0) {$oSubscriber->updateCacheStatus(); if(isset($lLL1l1l) and $lLL1l1l == true){ $Core->Cache->Disable(); doRedirect($frn->Gui, $ROOT_PATH_WWW.$frn->ActiveScript.'?subscriber_created=1', $conn); }else{ $Core->Cache->Disable(); doRedirect($frn->Gui, $ROOT_PATH_WWW.$frn->ActiveScript, $conn); }}}if(isset($frn->Vars["subscriber_created"]) and $frn->Vars["subscriber_created"]==I19193) {$mMembers =&$frn->Core->GetModule("members"); $lI11LI1 =$mMembers->GetOption("confirmation_type"); if ($lI11LI1 == I19223) {$frn->AddStatusMsg("confirm_admin_message", I19213); }elseif ($lI11LI1 == I19199) {$frn->AddStatusMsg("confirm_email_message", I19213); }elseif ($lI11LI1 == "email|admin") {$frn->AddStatusMsg("confirm_admin_email_message", I19213); }}$lLlLlLI =$frn->Gui->get("subscribe:$II111lL", $lLl1II1); $lLLLLLI[I19224] =$lLlLlLI; $HtmlBody =$frn->Gui->get(I19168, $lLLLLLI); $frn->Member->updateCacheStatus(); require $GLOBALS['DEFAULT_INCLUDES_PATH'] .'done.php'; }$lLI111I =0; 