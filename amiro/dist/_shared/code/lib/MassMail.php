<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       7452 xkqwkrwwstmpswmlnxsutuixgwkptyiztspkpxlziqswgzpiqqgruxwuunkirpumqkkspnir
 */ ?><?php foreach(array(19435=>'wjzddqd|gzTo',19436=>'iHSuJQoHDtTrZffMW`GOG',19437=>'iHSuJQoHDtUDQrD`GOG',19438=>'iHSuJQoHDtgZBIQntD`GOG',19439=>'iHSuJQoHDtgZBIQntDoMDtHrB`GOG',19440=>'tQIGJZtQD~IZDDIZMJ',19441=>'jhp',19442=>"funW|fHrIZt`GOG",19443=>'SHIZMn',19444=>'JZnP',19445=>'DuYLQWt',19446=>"iZMJQr`GOG",19447=>'Jj1mJm1',19448=>'MS|uDQr',19449=>'CA|OHDt|uDQrD',19450=>'nHtMfB|uDQrD',19451=>'C',19452=>'MnDtZJJQS|JZnPD',19453=>"IZDDIZMJ|",19454=>"\n\n",19455=>"shNq") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} require_once $GLOBALS['CLASSES_PATH'] .'CMS_Member.php'; require_once $GLOBALS[I19435] .'SiteManager.php'; require_once $GLOBALS[I19435] .I19436; require_once $GLOBALS[I19435] .I19437; require_once $GLOBALS[I19435] .I19438; require_once $GLOBALS[I19435] .I19439; require_once $GLOBALS[I19435] .'Mailer.php'; require_once $GLOBALS[I19435] .'WZDaemon.php'; define("LOG_TO_FILE",true); $lL1IL1l =I19440; function _error($msg,$type='WARN') {global $LOG_PATH,$adm; $str =DateTools::toMysqlDate(time()); $str .= " $type: $msg\n"; if(LOG_TO_FILE && ($f=@fopen($LOG_PATH."mass_mail.log","a"))) {fputs($f,$str); fclose($f); }echo $str; flush(); if($type=='FATAL') {exit; }}function _log($msg,$obj=false) {_error($msg,I19441); if($obj!==false) _d($obj); }function TITTll1(&$account,$type,$t,$date) {global $adm,$DFMT,$db,$ILLLlIl,$lL1IlIL; if ($account['status'] != 'active' && $type != 'delete'){ return; }require_once($GLOBALS["FUNC_INCLUDES_PATH"].I19442); $member =CMS_Member::TTTll11($account['domain'],$account['username']); TlIT111('close',$account['domain']); $III1LlI =array (I19443=>$account[I19443], 'curdate'=>date($DFMT,$t), 'note' => $account['note'] );$lILl11I =isset($member['lang']) ?$member[I19444] :'en'; $gui =&$adm->Gui; $tpl ='massmail_' .$lILl11I .':'; $III1LlL =$gui->get($tpl .$type .'_subject', $III1LlI); $III1LlI[I19445] =$III1LlL; $mbody =$gui->get($tpl .'header', $III1LlI); $mbody .= $gui->get($tpl .$type .'_body', $III1LlI); $mbody .= $gui->get($tpl .'footer', $III1LlI); require_once($GLOBALS["CLASSES_PATH"].I19446); $oMail =new Mailer(); $oMail->SenderAddress =$adm->Core->GetOption('company_email'); $oMail->SenderName =$adm->Core->GetOption("company_name"); $oMail->Subject =$III1LlL; $oMail->Body =$mbody; $oMail->BodyFormat ="html"; $oMail->Encoding ="UTF-8"; $oMail->Prepare(); if($GLOBALS[I19447]=='yes') {if(empty($member['email'])) {_error("Cannot get member email address for username=$account[username], userDB=$account[dbase]",'ERROR'); }else {$oMail->RecipientAddress =$member['email']; if(!$oMail->Send()) _error("sending email failed to '$oMail->RecipientAddress'"); }}if(!ModuleHostUsers::TT111Il($adm,$ILLLlIl,$account[I19448], array('recipient_addr'=>$member['email'],I19445=>"[MASSMAIL: $account[domain]] $III1LlL",'body'=>$mbody,I19444=>HOST_DOCS_LANG))) _error("sending email failed to $ILLLlIl"); }while(@ob_end_flush()); _log("START"); $ILLLlII =&$adm->Core->GetModule(I19449); $lL1IllI =&$adm->Core->GetModule('srv_host_payments_history'); $ILLLlIl =$ILLLlII->GetOption('bill_admin_email'); $ILLLl1L =$GLOBALS["LOG_PATH"].'mass_mail.lock'; $lL1IlI1 =$adm->VarsGet[I19450]; $lL1IlI1 =isset($lL1IlI1) && $lL1IlI1=='no' ?'no' :'yes'; if(empty($sid)) $sid =$adm->VarsGet['billing_sid']; $lL1IlL1 =$adm->VarsGet[I19443]; $lock =fopen($ILLLl1L,I19451); if(!$lock) _error("Cannot open lock file '$ILLLl1L' for writing",'FATAL'); if(!flock($lock,LOCK_EX|LOCK_NB)) _error("Billing daemon is already working",'FATAL'); $DFMT =$adm->DFMT['php']; $ILLLllL =new WZDaemonPool(); $adm->Gui->setForceReadFromDisk(TRUE); foreach($adm->Core->GetOption(I19452) as $ILLLLII){ $adm->Gui->addBlock(I19453 .$ILLLLII, $lL1IL1l ."_" .$ILLLLII .".tpl"); }$now =time(); $lL1Il1I =ModuleHostPayments::TTll1TT(0, true); _log("now=".DateTools::toMysqlDate($now)." accounts=".sizeof($lL1Il1I)); _log("User notification: $lL1IlI1"); if(!empty($lL1IlL1)) {_log("SPECIFIED domain='$lL1IlL1'"); }_log(I19454); $lL1IL1L =0; $lILILLI =0; while(list($lILI11l,)=each($lL1Il1I)) {$account =&$lL1Il1I[$lILI11l]; if(($account['id_node'] != 0) && ($account['id_node'] != 6)){ continue; }if(!empty($lL1IlL1) && $account[I19443]!=$lL1IlL1) {continue; }set_time_limit(50); $lL1IL11 += 1; _log("BEGIN domain=$account[domain]"); TITTll1($account,'massmail',$now); _log("Notification sent"); _log("END domain=$account[domain]"); }_log("TOTALS: accounts = $lL1IL11"); fclose($lock); _log(I19455); ?>