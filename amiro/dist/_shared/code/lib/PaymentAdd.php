<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       21624 xkqwtyqwszmxwgsllzzrkpzgiszxmgkgmgxiqmxtzrwmuzgmqpszqxrqpmrziqykiquypnir
 */ ?><?php foreach(array(19483=>'wjzddqd|gzTo',19484=>'iHSuJQoHDtTrZffMW`GOG',19485=>'iHSuJQoHDtUDQrD`GOG',19486=>'iHSuJQoHDtgZBIQntD`GOG',19487=>'iHSuJQoHDtgZBIQntDoMDtHrB`GOG',19488=>'iHSuJQoHDtgZBIQntDgrHGD`GOG',19489=>'iHSuJQoHDtgZBIQntDsHWD`GOG',19490=>"BQD",19491=>"Z",19492=>'ZIHunt',19493=>'GZBIQnt|nuI',19494=>'ZSIMn|DtZtuD',19495=>'MS|uDQr',19496=>'ZWtMHn',19497=>'YMJJMnP|SZQIHn',19498=>'BZnSQx`ru',19499=>"funW|fHrIZt`GOG",19500=>'HnJMnQ',19501=>'YZJZnWQ',19502=>'?руб`',19503=>'JZnP',19504=>'DuYLQWt',19505=>'zIMrH`wid',19506=>'did%',19507=>'OQZSQr',19508=>'WHIGZnB|QIZMJ',19509=>'QIZMJ',19510=>'CA|OHDt|uDQrD',19511=>'GOG',19512=>'MnDtZJJQS|JZnPD',19513=>"QDOHGmS",19514=>"HrSQrmS",19515=>'%%',19516=>"uDQrqIZMJ",19517=>'yMJJ?SQtQWtQS%?',19518=>'wZrSgZBIQnt',19519=>"GZBIQntiQtOHS",19520=>'MS|WHntrZWtHr',19521=>"GZBIQntmS",19522=>"nHtQ",19523=>"DMPn?MD?NhT?HK",19524=>"OQJJH?ci",19525=>"jim|dbd|mNVd|Nh",19526=>"jim|gzbqR|ci",19527=>"jim|gzbiqNT|sqdw",19528=>"fHunS?YMJJ%?",19529=>'MS',19530=>'GZBIQnt|tBGQ',19531=>'cQYIHnQB',19532=>"jim|ozdo",19533=>'JZYQJ',19534=>']',19535=>"WHSQGrH",19536=>"fZJDQ",19537=>'SZtQ',19538=>'nHtQ',19539=>'?',19540=>'SHW|nuI',19541=>"DOZ1|OZDO",19542=>"DtZtuD",19543=>"txn%",19544=>'1',19545=>"SZtQtMIQ",19546=>",=",19547=>'GZBGZJ',19548=>'zIMrHwid%?',19549=>'dbd|gzTo',19550=>"?",19551=>'?Uds?CMtO?rZtQ?',19552=>'rQDt') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} if(!defined('AMI_ENVIRONMENT')){header('HTTP/1.0 403 Forbidden');die('Forbidden, invalid URL! '.__FILE__.' at '.__LINE__);} error_reporting(E_ERROR); require_once $GLOBALS['CLASSES_PATH'] .'CMS_Member.php'; require_once $GLOBALS[I19483] .'SiteManager.php'; require_once $GLOBALS[I19483] .I19484; require_once $GLOBALS[I19483] .I19485; require_once $GLOBALS[I19483] .I19486; require_once $GLOBALS[I19483] .I19487; require_once $GLOBALS[I19483] .I19488; require_once $GLOBALS[I19483] .I19489; require_once $GLOBALS[I19483] .'Mailer.php'; require_once $GLOBALS[I19483] .'WZDaemon.php'; $GLOBALS["lL1IlI1"] =I19490; require_once 'mainsms.class.php'; define("LOG_TO_FILE",true); function _error($msg,$type='WARN') {global $LOG_PATH,$adm; $str =DateTools::toMysqlDate(time()); $str .= " $type: $msg\n"; if(LOG_TO_FILE && ($f=@fopen($LOG_PATH."add_payment.log",I19491))) {fputs($f,$str); fclose($f); }echo $str; flush(); if($type=='FATAL') {exit; }}function _log($msg,$obj=false) {_error($msg,'LOG'); if($obj!==false) _d($obj); }function TlTlI1T(){ global $account, $lL1ILII, $now, $lILlLII, $sid, $daemon, $_POST, $lL1I1II, $ILLLllL; $daz =ModuleHostPaymentsHistory::TII11Tl($lL1ILII, $lILlLII['id']); _log(DateTools::toMysqlDate($now)." addPaymentItem(".$lL1ILII[I19492].")=".DateTools::toMysqlDate($daz)); $account =ModuleHostPayments::TII1llI($lILlLII['id_user']); $account['balance'] =$account[I19492]; $account[I19492] =$lL1ILII[I19492]; $account['payment_type_word'] =$lL1I1II; $account[I19493] =$lL1ILII[I19493]; $account['note'] =$lL1ILII['note']; TITTll1($account,'payment',$now); _log("Notification sent"); if($account[I19494]=='suspend'){ _log('Admin panel status is suspended'); $daemon =&$ILLLllL->TlTTIlI($sid,$account['domain']); _log('AdmDaemon is ready'); if(ModuleHostUsers::TIlTTll($lILlLII[I19495], 'active', $daemon, 'billing_daemon', 'online payment')){ _log('Admin panel activated'); }else{ _log('Admin panel activation ERROR'); }}if($account['status']=='suspend'){ _log('Site status is suspended'); $daemon =&$ILLLllL->TlTTIlI($sid,$account['domain']); $dp =array(I19496=>'activate','domain'=>$account['domain'],'restart_httpd'=>0); if(!$daemon->TlTTITT($dp)) {_log('Site activation ERROR'); }else {_log('Site activated'); ModuleHostUsers::TIlTTl1($lILlLII[I19495],array( 'status'=>'suspend', 'changed_by'=>I19497, 'comment'=>'online payment')); }}}function TlTlI1I($lL1I1Il){ $lL1I1IL =Array('amiro.ru', 'webstolica.ru', I19498); $ret =array(); preg_match_all('/([A-z0-9\-\.]{1,}\.(ua|org|net|ru|com|biz|xn--p1ai|рф))/', $lL1I1Il, $ret); if(!in_array($ret[0][0], $lL1I1IL)){ return $ret[0][0]; }else{ return null; }}function TlTlI1l($lL1I1Il){ $ret =array(); preg_match_all('/(АМ|ам|AM|am)\-([0-9]{2,})/', $lL1I1Il, $ret); if(intval($ret[2][0])){ return 'АМ-'.$ret[2][0]; }else{ return false; }}function TITTll1(&$account,$type,$t,$date) {global $api,$adm,$DFMT,$db,$ILLLlIl, $lL1IlIL; require_once($GLOBALS["FUNC_INCLUDES_PATH"].I19499); $member =CMS_Member::getInfo($account['domain'],$account['username']); TlITllI('close',$account['domain']); $III1LlI =array (I19500=>'(online)', 'domain'=>$account['domain'], 'curdate'=>date($DFMT,$t), I19501=> $account[I19501], 'payment_type_word' => $account['payment_type_word'], I19493 => $account[I19493], 'note' => $account['note'], I19492=>FormatMoney($adm,$account[I19492] .I19502,$lL1IlIL,2,2,false,false), 'amount_num'=>FormatMoney($adm,$account[I19492],$lL1IlIL,2,2,false,false), 'amount_min'=>FormatMoney($adm,$account['amount_min'],$lL1IlIL,2,2,true,false), 'date'=>date($DFMT,$date) );$lILl11I =isset($member[I19503]) ?$member[I19503] :'en'; $gui =&$adm->Gui; $tpl ='mail_' .$lILl11I .':'; $III1LlL =$gui->get($tpl .$type .'_subject', $III1LlI); $III1LlI[I19504] =$III1LlL; $lILl11l =$account['ext_info']['mob_phone']; if($api && !empty($lILl11l)){ _log('tel_orig:'.$lILl11l); $lILl11l ='7'.preg_replace('/(\A8)?(\+7)?(\D)?/i', '', $lILl11l); _log('tel_formatted:'.$lILl11l); }if($api && !empty($lILl11l)){ $lILl11L =$gui->get($tpl .'sms_' .$type .'_body', $III1LlI); $price =$api->TlT1llI($lILl11l, $lILl11L );$lILl111 =$api->TlT1lll ($lILl11l );if( $lILl111 && ($price <2) ){$api->TlT1lIl($lILl11l ,$lILl11L, I19505); $response =$api->getResponse ();$result =$api->TTTII1T ($response ['messages_id' ]);foreach ($result as $lILLIII => $status ){$III1LlI["sms_status"] ="phone: ".$lILl11l." status: " .$status; _log(I19506.$III1LlI["sms_status"]); }}else{ _log('SMS NOT SENT ( tel_info:'.$lILl111.' price:'.$price.')'); }}$mbody =$gui->get($tpl .I19507, $III1LlI); $mbody .= $gui->get($tpl .$type .'_body', $III1LlI); $mbody .= $gui->get($tpl .'footer', $III1LlI); require_once($GLOBALS["CLASSES_PATH"]."Mailer.php"); $oMail =new Mailer(); $oMail->SenderAddress =$adm->Core->GetOption(I19508); $oMail->SenderName =$adm->Core->GetOption("company_name"); $oMail->Subject =$III1LlL; $oMail->Body =$mbody; $oMail->BodyFormat ="html"; $oMail->Prepare(); if($GLOBALS['lL1IlI1']=='yes') {if(empty($member[I19509])) {_error("Cannot get member email address for username=$account[username], userDB=$account[dbase]",'ERROR'); }else {$oMail->RecipientAddress =$member[I19509]; if(!$oMail->Send()) _error("sending email failed to '$oMail->RecipientAddress'"); }}if(!ModuleHostUsers::TIlTT1T($adm,$ILLLlIl,$account[I19495], array('recipient_addr'=>$member[I19509],I19504=>"[BILLING: $account[domain]] $III1LlL",'body'=>$mbody,I19503=>HOST_DOCS_LANG))) _error("sending email failed to $ILLLlIl"); }while(@ob_end_flush()); _log("START"); $ILLLlII =&$adm->Core->GetModule(I19510); $ILLLlIl =$ILLLlII->GetOption('bill_admin_email'); $ILLLlII =&$adm->Core->GetModule(I19510); $lL1IllI =&$adm->Core->GetModule('srv_host_payments_history'); $ILLLlIl =$ILLLlII->GetOption('bill_admin_email'); if(empty($sid)) $sid =$adm->VarsGet['billing_sid']; $DFMT =$adm->DFMT[I19511]; $ILLLllL =new WZDaemonPool(); foreach($adm->Core->GetOption(I19512) as $ILLLLII){ $adm->Gui->addBlock("mail_" .$ILLLLII, $GLOBALS['LOCAL_FILES_REL_PATH'] ."_admin/templates/letters/_billing_daemon_" .$ILLLLII .".tpl"); }$words =$adm->Gui->ParseLangFile("templates/lang/billing_daemon.lng"); $now =time(); $lL1I1I1 =Array(); ModuleHostPaymentsProps::TII111I($lL1I1I1, 0, 0); $api =new MainSMS (I19505, $lL1I1I1['mainsms_api_key'], true, false );_log(stripslashes(htmlspecialchars_decode($_GET["post"]))); $_POST =unserialize(stripslashes(htmlspecialchars_decode($_GET["post"]))); if(!empty($lL1I1I1['rbk_key']) && !empty($_POST[I19513]) && ($_POST["paymentStatus"]=='5')){ _log("hello RBK"); $str =$_POST[I19513].'::'.$_POST[I19514].'::'.$_POST["serviceName"].'::'.$_POST["eshopAccount"].I19515.$_POST["recipientAmount"].I19515.$_POST["recipientCurrency"].I19515.$_POST["paymentStatus"].I19515.$_POST["userName"].I19515.$_POST[I19516].I19515.$_POST["paymentData"].I19515.$lL1I1I1['rbk_key']; if(md5($str)==$_POST["hash"]){ $lL1I1lI =TlTlI1l($_POST["serviceName"]); if($lL1I1lI){ _log(I19517.$lL1I1lI); $lILlLII =ModuleHostPaymentsDocs::TII1l1I($lL1I1lI); if($lILlLII[id]){ if($lILlLII[tmp]=='1'){ _log("found bill: ".($lILlLII['doc_num'])); if(strpos($_POST["paymentMethod"], I19518) !== false){ $payment_type =3; }else if(strpos($_POST["paymentMethod"], 'Terminal') !== false){ $payment_type =7; }else if(strpos($_POST["paymentMethod"], 'inner') !== false){ $payment_type =8; }else if(strpos($_POST[I19519], 'prepaid') !== false){ $payment_type =9; }else{ $payment_type =0; }$lL1ILII =array( I19495=>$lILlLII[I19495], 'id_bill'=>$lILlLII['id'], 'date'=>DateTools::toMysqlDate($now), I19520=>$lL1I1I1['id'], I19492=>$_POST["recipientAmount"], 'rest' =>$_POST["recipientAmount"], I19493 => $_POST[I19521] .' от ' .$_POST["paymentData"], 'payment_type'=>$payment_type, 'note'=>$lILlLII[I19522], 'hidden_note'=>$_POST["serviceName"] );$lL1I1II ='РБК'; _log('try to add payment...'); TlTlI1T(); }else{ _log("bill is already paid: ".$lILlLII['doc_num']); }}else{ _log("bill not found: ".$lL1I1lI); }}else{ _log("bill not detected in: ".$_POST["serviceName"]); }}else{ _log(I19523); _log($_POST["hash"]."!=".md5($str)); }}if((!empty($lL1I1I1['wm_key']) && !empty($_POST["LMI_HASH"]))){ _log(I19524); $str =$_POST["LMI_PAYEE_PURSE"].$_POST["LMI_PAYMENT_AMOUNT"].$_POST["LMI_PAYMENT_NO"].$_POST["LMI_MODE"].$_POST[I19525].$_POST["LMI_SYS_TRANS_NO"].$_POST["LMI_SYS_TRANS_DATE"].$lL1I1I1['wm_key'].$_POST["LMI_PAYER_PURSE"].$_POST[I19526]; if((strtoupper(md5($str))==$_POST["LMI_HASH"])){ _log("sign is ok"); $lL1I1lI =TlTlI1l(iconv("Windows-1251", "UTF-8", $_POST[I19527]).' '.$_POST["userField_1"]); if($lL1I1lI){ _log('bill detected: '.$lL1I1lI); $lILlLII =ModuleHostPaymentsDocs::TII1l1I($lL1I1lI); if($lILlLII[id]){ if($lILlLII[tmp]=='1'){ _log(I19528.($lILlLII['doc_num'])); $payment_type =4; $lL1ILII =array( I19495=>$lILlLII[I19495], 'id_bill'=>$lILlLII['id'], 'date'=>DateTools::toMysqlDate($now), I19520=>$lL1I1I1[I19529], I19492=>$_POST["LMI_PAYMENT_AMOUNT"], 'rest' =>$_POST["LMI_PAYMENT_AMOUNT"], I19493 => $_POST["LMI_SYS_TRANS_DATE"], I19530=>$payment_type, 'note'=>$lILlLII[I19522], 'hidden_note'=>iconv("Windows-1251", "UTF-8", $_POST[I19527]) );$lL1I1II =I19531; _log('try to add payment...'); TlTlI1T(); }else{ _log("bill is already paid: ".$lILlLII['doc_num']); }}else{ _log("bill not found: ".$lL1I1lI); }}else{ _log("bill not detected in: ".iconv("Windows-1251", "UTF-8", $_POST[I19527]).' '.$_POST["userField_1"]); }}else{ _log(I19523); _log($_POST[I19532]."!=".strtoupper(md5($str))); }}if(!empty($lL1I1I1['yandex_key']) && ($_POST['notification_type']=='p2p-incoming') && !empty($_POST[I19533])){ _log("hello Yandex"); $str =$_POST["notification_type"].'&'.$_POST["operation_id"].I19534.$_POST["amount"].I19534.$_POST["currency"].I19534.$_POST["datetime"].I19534.$_POST["sender"].I19534.$_POST[I19535].I19534.$lL1I1I1['yandex_key'].I19534.$_POST["label"]; if((sha1($str)==$_POST["sha1_hash"])){ _log("sign is ok"); if($_POST[I19535]==I19536){ $lL1I1lI =TlTlI1l($_POST["label"]); if($lL1I1lI){ _log(I19517.$lL1I1lI); $lILlLII =ModuleHostPaymentsDocs::TII1l1I($lL1I1lI); if($lILlLII[id]){ if($lILlLII[tmp]=='1'){ _log(I19528.($lILlLII['doc_num'])); $payment_type =5; $lL1ILII =array( I19495=>$lILlLII[I19495], 'id_bill'=>$lILlLII[I19529], I19537=>DateTools::toMysqlDate($now), I19520=>$lL1I1I1[I19529], I19492=>$_POST["amount"], 'rest' =>$_POST["amount"], I19493 => $_POST["datetime"], I19530=>$payment_type, I19538=>$lILlLII[I19522], 'hidden_note'=>$_POST["operation_id"].' от '.$_POST["sender"].I19539.$_POST["label"] );$lL1I1II ='Яндекс.Деньги'; _log('try to add payment...'); TlTlI1T(); }else{ _log("bill is already paid: ".$lILlLII[I19540]); }}else{ _log("bill not found: ".$lL1I1lI); }}else{ _log("bill not detected in: ".$_POST["label"]); }}else{ _log("Code protection used"); }}else{ _log(I19523); _log($_POST[I19541]."!=".sha1($str)); }}if(!empty($lL1I1I1['qiwi_key']) && !empty($_POST['login']) && !empty($_POST['txn']) && ($_POST[I19542]=="60")){ _log("hello QIWI"); $str =strtoupper(md5($_POST['txn'].strtoupper($lL1I1I1['qiwi_key']))); _log(I19543.$_POST['txn']); if(($str==$_POST["password"])){ _log("sign is ok"); $lL1I1lI =TlTlI1l($_POST['txn']); if($lL1I1lI){ _log(I19517.$lL1I1lI); $lILlLII =ModuleHostPaymentsDocs::TII1l1I($lL1I1lI); if($lILlLII[id]){ if($lILlLII[tmp]==I19544){ _log(I19528.($lILlLII[I19540])); $payment_type =10; $lL1ILII =array( I19495=>$lILlLII[I19495], 'id_bill'=>$lILlLII[I19529], I19537=>DateTools::toMysqlDate($now), I19520=>$lL1I1I1[I19529], I19492=>$lILlLII["amount"], 'rest' =>$lILlLII["amount"], I19493 => $_POST[I19545], I19530=>$payment_type, I19538=>$lILlLII[I19522], 'hidden_note'=>'' );$lL1I1II ='QIWI'; _log('try to add payment...'); TlTlI1T(); }else{ _log("bill is already paid: ".$lILlLII[I19540]); }}else{ _log("bill not found: ".$lL1I1lI); }}else{ _log("bill not detected in: ".$_POST["txn"]); }}else{ _log(I19523); _log($_POST["password"].I19546.$str); }}_log("PayPal check for _POST:\n" .var_export($_POST) ."\n---\n"); $aRequest =$_POST; if(isset($aRequest['amiPaymentMethod'])){ switch($aRequest['amiPaymentMethod']){ case I19547: _log('hello PayPal'); if( !isset($aRequest['payment_status']) || 'Completed' !== $aRequest['payment_status'] ){_log("ERR: passed payment status ('" .$aRequest['payment_status'] ."') !== 'Completed'"); break; }if( !isset($aRequest['item_name']) || 0 !== mb_strpos($aRequest['item_name'], I19548, 0, 'ASCII') ){_log("ERR: missing 'item_name' argument"); break; }$lILlll1 =TlTlI1l($aRequest['item_name']); if($lILlll1){ _log(I19517 .$lILlll1); $lILlLII =ModuleHostPaymentsDocs::TII1l1I($lILlll1); if($lILlLII[id]){ if($lILlLII[tmp]==I19544){ _log(I19528.($lILlLII[I19540])); $payment_type =11; $amount =$aRequest['payment_gross']; $rate =(float)@file_get_contents($GLOBALS[I19549] .'currencyRate.USD.RUB.txt'); if(!$rate){ $sql ="SELECT `babk_info` " ."FROM `cms_host_payments_props` " ."WHERE `id_user` = " .(int)$adm->Core->GetUserId() .I19550 ."LIMIT 1"; $lL1I1ll =unserialize( AMI::getSingleton('db') ->fetchValue($sql) );$rate =$lL1I1ll['paypal_usd_rate']; }if(abs($amount *$rate -$lILlLII[I19492]) >($lILlLII[I19492] /10)){ trigger_error( 'PayPal hoosting payment autoconfirmation: returned amount ' .$amount .I19551 .$rate .' (' .($amount *$rate) .') gross than 10% from original sum ' .$lILlLII[I19492] .' RUB', E_USER_WARNING );}$lL1ILII =array( I19495 => $lILlLII[I19495], 'id_bill' => $lILlLII[I19529], I19537 => DateTools::toMysqlDate($now), I19520 => $lL1I1I1[I19529], I19492 => $lILlLII[I19492], I19552 => $lILlLII[I19492], I19493 => $amount *$rate, I19530 => $payment_type, I19538 => $lILlLII[I19538], 'hidden_note' => '' );$lL1I1II ='PayPal'; _log('try to add payment...'); TlTlI1T(); }else{ _log("bill is already paid: " .$lILlLII[I19540]); }}else{ _log('bill not found: ' .$lILlll1); }}else{ _log("bill not detected in: " .$aRequest['item_name']); }break; }}_log("END"); 