<?php foreach(array(20010=>'1`2`7',20011=>'',20012=>'oTTg|ohdT',20013=>'rQEuQDt|urM',20014=>'SQYuP',20015=>'RqeUqdT|URm',20016=>'WOZrDQt',20017=>'DHWKQt|tMIQHut',20018=>'MPnHrQ|WZDQ',20019=>'fMJQ|PQt|WHntQntD',20020=>'pqT',20021=>'OttG%~~',20022=>'DHWKQt',20023=>'rY',20024=>'#',20025=>'Нет?файла?',20026=>'FzTzj?qRRhR%',20027=>'||MPnHrQ|WZDQ||',20028=>' ',20029=>'dzgq|wJMQnt?gog',20030=>'MD|YJHWK|JMnKD',20031=>'nHf|HYJMPZtHrB',20032=>'"?nHf|SMDGJ="',20033=>'"@',20034=>'YJHWK|HrMQntZtMHn',20035=>')OQZSQr(',20036=>')MtQI(',20037=>'YJHWK|CMStO',20038=>')',20039=>'ZD|YJHWK',20040=>'~',20041=>'||DZGQ|SQJMIMtQr||',20042=>'||DZGQ|nQC|urJ||',20043=>'||DZGQ|YJHWK|tGJ||',20044=>'YQfHrQYJHWK',20045=>'||DZGQ|YJHWK|MnD|',20046=>'tQxtZrQZ',20047=>'nHDWrMGt',20048=>']ZIG^',20049=>'\'',20050=>'5`4`0',20051=>'?',20052=>'HGQn?tZP',20053=>'\$',20054=>'$',20055=>'#~DZGQ|MnSQx@',20056=>'OHDt',20057=>'MnSQx',20058=>'ZnnHunWQIQntD',20059=>'MIZPQD',20060=>'`ZrtMWJQ`SY',20061=>'SZtQ|uGSZtQS',20062=>'tQIGJZtQ|MS',20063=>'MIZPQ',20064=>'IMIQ',20065=>'(',20066=>'tQIGJZtQD',20067=>'GZtO',20068=>'WHSQ',20069=>'Qxt|JMnKD|ZJJHCQS',20070=>'N',20071=>'~ uDQr=',20072=>']rtBGQ=') as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} class SAPE_base {var $_version =I20010; var $_verbose =false; var $_charset =''; var $_sape_charset =''; var $_server_list =array('dispenser-01.saperu.net', 'dispenser-02.saperu.net'); var $_cache_lifetime =3600; var $_cache_reloadtime =600; var $_errors =array(); var $_host =I20011; var $_request_uri =I20011; var $_multi_site =false; var $_fetch_remote_type =I20011; var $_socket_timeout =6; var $_force_show_code =false; var $_is_our_bot =false; var $_debug =false; var $_ignore_case =false; var $_db_file =I20011; var $_use_server_array =false; var $_show_counter_separately =false; var $_force_update_db =false; var $_user_agent =I20011; function SAPE_base($options =null) {$host =I20011; if (is_array($options)) {if (isset($options['host'])) {$host =$options['host']; }}elseif (strlen($options)) {$host =$options; $options =array(); }else {$options =array(); }if (isset($options['use_server_array']) && $options['use_server_array'] == true) {$this->_use_server_array =true; }if (strlen($host)) {$this->_host =$host; }else {$this->_host =$_SERVER[I20012]; }$this->_host =preg_replace('/^http:\/\//', I20011, $this->_host); $this->_host =preg_replace('/^www\./', I20011, $this->_host); if (isset($options['request_uri']) && strlen($options['request_uri'])) {$this->_request_uri =$options[I20013]; }elseif ($this->_use_server_array === false) {$this->_request_uri =getenv('REQUEST_URI'); }if (strlen($this->_request_uri) == 0) {$this->_request_uri =$_SERVER['REQUEST_URI']; }if (isset($options['multi_site']) && $options['multi_site'] == true) {$this->_multi_site =true; }if (isset($options[I20014]) && $options[I20014] == true) {$this->_debug =true; }if (isset($_COOKIE['sape_cookie']) && ($_COOKIE['sape_cookie'] == _SAPE_USER)) {$this->_is_our_bot =true; if (isset($_COOKIE['sape_debug']) && ($_COOKIE['sape_debug'] == 1)) {$this->_debug =true; $this->_options =$options; $this->_server_request_uri =$_SERVER[I20015]; $this->_getenv_request_uri =getenv(I20015); $this->_SAPE_USER =_SAPE_USER; }if (isset($_COOKIE['sape_updatedb']) && ($_COOKIE['sape_updatedb'] == 1)) {$this->_force_update_db =true; }}else {$this->_is_our_bot =false; }if (isset($options['verbose']) && $options['verbose'] == true || $this->_debug) {$this->_verbose =true; }if (isset($options[I20016]) && strlen($options[I20016])) {$this->_charset =$options[I20016]; }else {$this->_charset ='windows-1251'; }if (isset($options['fetch_remote_type']) && strlen($options['fetch_remote_type'])) {$this->_fetch_remote_type =$options['fetch_remote_type']; }if (isset($options[I20017]) && is_numeric($options[I20017]) && $options[I20017] >0) {$this->_socket_timeout =$options[I20017]; }if (isset($options['force_show_code']) && $options['force_show_code'] == true) {$this->_force_show_code =true; }if (!defined('_SAPE_USER')) {return $this->raise_error('Не задана константа _SAPE_USER'); }if (isset($options[I20018]) && $options[I20018] == true) {$this->_ignore_case =true; $this->_request_uri =strtolower($this->_request_uri); }if (isset($options['show_counter_separately'])) {$this->_show_counter_separately =(bool)$options['show_counter_separately']; }}function _get_full_user_agent_string() {return $this->_user_agent .' ' .$this->_version; }function _debug_output($data) {$data ='<!-- <sape_debug_info>' .@base64_encode(serialize($data)) .'</sape_debug_info> -->'; return $data; }function fetch_remote_file($host, $path, $specifyCharset =false) {$user_agent =$this->_get_full_user_agent_string(); @ini_set('allow_url_fopen', 1); @ini_set('default_socket_timeout', $this->_socket_timeout); @ini_set('user_agent', $user_agent); if ($this->_fetch_remote_type == 'file_get_contents' || ($this->_fetch_remote_type == I20011 && function_exists(I20019) && ini_get('allow_url_fopen') == 1 )){$this->_fetch_remote_type =I20019; if ($specifyCharset && function_exists('stream_context_create')) {$opts =array( 'http' => array( 'method' => I20020, 'header' => 'Accept-Charset: ' .$this->_charset ."\r\n" ));$context =@stream_context_create($opts); if ($data =@file_get_contents('http://' .$host .$path, null, $context)) {return $data; }}else {if ($data =@file_get_contents(I20021 .$host .$path)) {return $data; }}}elseif ($this->_fetch_remote_type == 'curl' || ($this->_fetch_remote_type == I20011 && function_exists('curl_init') )){$this->_fetch_remote_type ='curl'; if ($ch =@curl_init()) {@curl_setopt($ch, CURLOPT_URL, I20021 .$host .$path); @curl_setopt($ch, CURLOPT_HEADER, false); @curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); @curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $this->_socket_timeout); @curl_setopt($ch, CURLOPT_USERAGENT, $user_agent); if ($specifyCharset) {@curl_setopt($ch, CURLOPT_HTTPHEADER, array('Accept-Charset: ' .$this->_charset)); }$data =@curl_exec($ch); @curl_close($ch); if ($data) {return $data; }}}else {$this->_fetch_remote_type =I20022; $buff =I20011; $fp =@fsockopen($host, 80, $errno, $errstr, $this->_socket_timeout); if ($fp) {@fputs($fp, "GET {$path} HTTP/1.0\r\nHost: {$host}\r\n"); if ($specifyCharset) {@fputs($fp, "Accept-Charset: {$this->_charset}\r\n"); }@fputs($fp, "User-Agent: {$user_agent}\r\n\r\n"); while (!@feof($fp)) {$buff .= @fgets($fp, 128); }@fclose($fp); $page =explode("\r\n\r\n", $buff); unset($page[0]); return implode("\r\n\r\n", $page); }}return $this->raise_error('Не могу подключиться к серверу: ' .$host .$path .', type: ' .$this->_fetch_remote_type); }function _read($filename) {$fp =@fopen($filename, I20023); @flock($fp, LOCK_SH); if ($fp) {clearstatcache(); $length =@filesize($filename); if (version_compare(PHP_VERSION, '5.3.0', '<')) {$mqr =@get_magic_quotes_runtime(); @set_magic_quotes_runtime(0); }if ($length) {$data =@fread($fp, $length); }else {$data =I20011; }if (version_compare(PHP_VERSION, '5.3.0', '<')) {@set_magic_quotes_runtime($mqr); }@flock($fp, LOCK_UN); @fclose($fp); return $data; }return $this->raise_error('Не могу считать данные из файла: ' .$filename); }function _write($filename, $data) {$fp =@fopen($filename, 'ab'); if ($fp) {if (flock($fp, LOCK_EX |LOCK_NB)) {ftruncate($fp, 0); if (version_compare(PHP_VERSION, '5.3.0', '<')) {$mqr =@get_magic_quotes_runtime(); @set_magic_quotes_runtime(0); }@fwrite($fp, $data); if (version_compare(PHP_VERSION, '5.3.0', I20024)) {@set_magic_quotes_runtime($mqr); }@flock($fp, LOCK_UN); @fclose($fp); if (md5($this->_read($filename)) != md5($data)) {@unlink($filename); return $this->raise_error('Нарушена целостность данных при записи в файл: ' .$filename); }}else {return false; }return true; }return $this->raise_error('Не могу записать данные в файл: ' .$filename); }function raise_error($e) {$this->_errors[] =$e; if ($this->_verbose == true) {print '<p style="color: red; font-weight: bold;">SAPE ERROR: ' .$e .'</p>'; }return false; }function _get_db_file() {return I20011; }function _get_dispenser_path() {return I20011; }function set_data($data) {}function load_data() {$this->_db_file =$this->_get_db_file(); if (!is_file($this->_db_file)) {if (@touch($this->_db_file)) {@chmod($this->_db_file, 0666); }else {return $this->raise_error(I20025 .$this->_db_file .'. Создать не удалось. Выставите права 777 на папку.'); }}if (!is_writable($this->_db_file)) {return $this->raise_error('Нет доступа на запись к файлу: ' .$this->_db_file .'! Выставите права 777 на папку.'); }@clearstatcache(); $data =$this->_read($this->_db_file); if ($this->_force_update_db || (!$this->_is_our_bot && (filemtime($this->_db_file) <(time() -$this->_cache_lifetime) || filesize($this->_db_file) == 0 || @unserialize($data) == false ))){@touch($this->_db_file, (time() -$this->_cache_lifetime +$this->_cache_reloadtime)); $path =$this->_get_dispenser_path(); if (strlen($this->_charset)) {$path .= '&charset=' .$this->_charset; }foreach ($this->_server_list as $server) {if ($data =$this->fetch_remote_file($server, $path)) {if (substr($data, 0, 12) == I20026) {$this->raise_error($data); }else {$hash =@unserialize($data); if ($hash != false) {$hash['__sape_charset__'] =$this->_charset; $hash['__last_update__'] =time(); $hash['__multi_site__'] =$this->_multi_site; $hash['__fetch_remote_type__'] =$this->_fetch_remote_type; $hash[I20027] =$this->_ignore_case; $hash['__php_version__'] =phpversion(); $hash['__server_software__'] =$_SERVER['SERVER_SOFTWARE']; $data_new =@serialize($hash); if ($data_new) {$data =$data_new; }$this->_write($this->_db_file, $data); break; }}}}}if (strlen(session_id())) {$session =session_name() .'=' .session_id(); $this->_request_uri =str_replace(array(I20028 .$session, '&' .$session), I20011, $this->_request_uri); }$this->set_data(@unserialize($data)); return true; }function _return_obligatory_page_content() {$s_globals =new SAPE_globals(); $html =I20011; if (isset($this->_page_obligatory_output) && !empty($this->_page_obligatory_output) && false == $s_globals->page_obligatory_output_shown() ){$s_globals->page_obligatory_output_shown(true); $html =$this->_page_obligatory_output; }return $html; }function return_counter() {if (false == $this->_show_counter_separately) {$this->_show_counter_separately =true; }return $this->_return_obligatory_page_content(); }}class SAPE_globals {function _get_toggle_flag($name, $toggle =false) {static $flags =array(); if (!isset($flags[$name])) {$flags[$name] =false; }if ($toggle) {$flags[$name] =true; }return $flags[$name]; }function block_css_shown($toggle =false) {return $this->_get_toggle_flag('block_css_shown', $toggle); }function block_ins_beforeall_shown($toggle =false) {return $this->_get_toggle_flag('block_ins_beforeall_shown', $toggle); }function page_obligatory_output_shown($toggle =false) {return $this->_get_toggle_flag('page_obligatory_output_shown', $toggle); }}class SAPE_client extends SAPE_base {var $_links_delimiter =I20011; var $_links =array(); var $_links_page =array(); var $_user_agent =I20029; var $_show_only_block =false; var $_block_tpl =I20011; var $_block_tpl_options =array(); var $_block_uri_idna =array(); function SAPE_client($options =null) {parent::SAPE_base($options); $this->load_data(); }function _return_array_links_html($html, $options =null) {if (empty($options)) {$options =array(); }if (strlen($this->_charset) >0 && strlen($this->_sape_charset) >0 && $this->_sape_charset != $this->_charset && function_exists('iconv') ){$new_html =@iconv($this->_sape_charset, $this->_charset, $html); if ($new_html) {$html =$new_html; }}if ($this->_is_our_bot) {$html ='<sape_noindex>' .$html .'</sape_noindex>'; if (isset($options['is_block_links']) && true == $options[I20030]) {if (!isset($options['nof_links_requested'])) {$options['nof_links_requested'] =0; }if (!isset($options['nof_links_displayed'])) {$options['nof_links_displayed'] =0; }if (!isset($options[I20031])) {$options[I20031] =0; }if (!isset($options['nof_conditional'])) {$options['nof_conditional'] =0; }$html ='<sape_block nof_req="' .$options['nof_links_requested'] .I20032 .$options['nof_links_displayed'] .'" nof_oblig="' .$options[I20031] .'" nof_cond="' .$options['nof_conditional'] .I20033 .$html .'</sape_block>'; }}return $html; }function _return_html($html) {if (false == $this->_show_counter_separately) {$html =$this->_return_obligatory_page_content() .$html; }if ($this->_debug) {$user_agent =$this->_get_full_user_agent_string(); $html .= $this->_debug_output($user_agent); $html .= $this->_debug_output($this); }return $html; }function return_block_links($n =null, $options =null) {$numargs =func_num_args(); $args =func_get_args(); if (2 == $numargs) {if (!is_array($args[1])) {$options =null; }}elseif (2 <$numargs) {if (!is_array($options)) {$options =$args[2]; }}if (empty($options)) {$options =array(); }$defaults =array(); $defaults['block_no_css'] =false; $defaults['block_orientation'] =1; $defaults['block_width'] =I20011; $ext_options =array(); if (isset($this->_block_tpl_options) && is_array($this->_block_tpl_options)) {$ext_options =$this->_block_tpl_options; }$options =array_merge($defaults, $ext_options, $options); if (!is_array($this->_links_page)) {$html =$this->_return_array_links_html(I20011, array(I20030 => true)); return $this->_return_html($this->_links_page .$html); }elseif (!isset($this->_block_tpl)) {return $this->_return_html(I20011); }$total_page_links =count($this->_links_page); $need_show_obligatory_block =false; $need_show_conditional_block =false; $n_requested =0; if (isset($this->_block_ins_itemobligatory)) {$need_show_obligatory_block =true; }if (is_numeric($n) && $n >= $total_page_links) {$n_requested =$n; if (isset($this->_block_ins_itemconditional)) {$need_show_conditional_block =true; }}if (!is_numeric($n) || $n >$total_page_links) {$n =$total_page_links; }$links =array(); for ($i =1; $i <= $n; $i++) {$links[] =array_shift($this->_links_page); }$html =I20011; $nof_conditional =0; if (count($links) <$n_requested && true == $need_show_conditional_block) {$nof_conditional =$n_requested -count($links); }if (empty($links) && $need_show_obligatory_block == false && $nof_conditional == 0) {$return_links_options =array( I20030 => true, 'nof_links_requested' => $n_requested, 'nof_links_displayed' => 0, I20031 => 0, 'nof_conditional' => 0 );$html =$this->_return_array_links_html($html, $return_links_options); return $this->_return_html($html); }$s_globals =new SAPE_globals(); if (!$s_globals->block_css_shown() && false == $options['block_no_css']) {$html .= $this->_block_tpl['css']; $s_globals->block_css_shown(true); }if (isset($this->_block_ins_beforeall) && !$s_globals->block_ins_beforeall_shown()) {$html .= $this->_block_ins_beforeall; $s_globals->block_ins_beforeall_shown(true); }unset($s_globals); if (isset($this->_block_ins_beforeblock)) {$html .= $this->_block_ins_beforeblock; }$block_tpl_parts =$this->_block_tpl[$options[I20034]]; $block_tpl =$block_tpl_parts['block']; $item_tpl =$block_tpl_parts['item']; $item_container_tpl =$block_tpl_parts['item_container']; $item_tpl_full =str_replace('{item}', $item_tpl, $item_container_tpl); $items =I20011; $nof_items_total =count($links); foreach ($links as $link) {$l1IIlIL =preg_match('#<a href="(https?://([^"/]+)[^"]*)"[^>]*>[\s]*([^<]+)</a>#i', $link, $link_item); if (!$l1IIlIL) {preg_match('#<a href="(https?://([^"/]+)[^"]*)"[^>]*><img.*?alt="(.*?)".*?></a>#i', $link, $link_item); }if (function_exists('mb_strtoupper') && strlen($this->_sape_charset) >0) {$header_rest =mb_substr($link_item[3], 1, mb_strlen($link_item[3], $this->_sape_charset) -1, $this->_sape_charset); $header_first_letter =mb_strtoupper(mb_substr($link_item[3], 0, 1, $this->_sape_charset), $this->_sape_charset); $link_item[3] =$header_first_letter .$header_rest; }elseif (function_exists('ucfirst') && (strlen($this->_sape_charset) == 0 || strpos($this->_sape_charset, '1251') !== false)) {$link_item[3][0] =ucfirst($link_item[3][0]); }if (isset($this->_block_uri_idna) && isset($this->_block_uri_idna[$link_item[2]])) {$link_item[2] =$this->_block_uri_idna[$link_item[2]]; }$item =$item_tpl_full; $item =str_replace(I20035, $link_item[3], $item); $item =str_replace('{text}', trim($link), $item); $item =str_replace('{url}', $link_item[2], $item); $item =str_replace('{link}', $link_item[1], $item); $items .= $item; }if (true == $need_show_obligatory_block) {$items .= str_replace('{item}', $this->_block_ins_itemobligatory, $item_container_tpl); $nof_items_total += 1; }if ($need_show_conditional_block == true && $nof_conditional >0) {for ($i =0; $i <$nof_conditional; $i++) {$items .= str_replace(I20036, $this->_block_ins_itemconditional, $item_container_tpl); }$nof_items_total += $nof_conditional; }if ($items != I20011) {$html .= str_replace('{items}', $items, $block_tpl); if ($nof_items_total >0) {$html =str_replace('{td_width}', round(100 /$nof_items_total), $html); }else {$html =str_replace('{td_width}', 0, $html); }if (isset($options['block_width']) && !empty($options[I20037])) {$html =str_replace('{block_style_custom}', 'style="width: ' .$options[I20037] .'!important;"', $html); }}unset($block_tpl_parts, $block_tpl, $items, $item, $item_tpl, $item_container_tpl); if (isset($this->_block_ins_afterblock)) {$html .= $this->_block_ins_afterblock; }unset($options['block_no_css'], $options[I20034], $options[I20037]); $tpl_modifiers =array_keys($options); foreach ($tpl_modifiers as $k => $m) {$tpl_modifiers[$k] =I20038 .$m .'}'; }unset($m, $k); $tpl_modifiers_values =array_values($options); $html =str_replace($tpl_modifiers, $tpl_modifiers_values, $html); unset($tpl_modifiers, $tpl_modifiers_values); $clear_modifiers_regexp ='#\{[a-z\d_\-]+\}#'; $html =preg_replace($clear_modifiers_regexp, ' ', $html); $return_links_options =array( I20030 => true, 'nof_links_requested' => $n_requested, 'nof_links_displayed' => $n, I20031 => ($need_show_obligatory_block == true ?1 :0), 'nof_conditional' => $nof_conditional );$html =$this->_return_array_links_html($html, $return_links_options); return $this->_return_html($html); }function return_links($n =null, $options =null) {if ($this->_debug) {if (function_exists('debug_backtrace')) {$this->_return_links_calls[] =debug_backtrace(); }else {$this->_return_links_calls ="(function_exists('debug_backtrace')==false"; }}$numargs =func_num_args(); $args =func_get_args(); if (2 == $numargs) {if (!is_array($args[1])) {$options =null; }}elseif (2 <$numargs) {if (!is_array($options)) {$options =$args[2]; }}$as_block =$this->_show_only_block; if (is_array($options) && isset($options['as_block']) && false == $as_block) {$as_block =$options[I20039]; }if (true == $as_block && isset($this->_block_tpl)) {return $this->return_block_links($n, $options); }if (is_array($this->_links_page)) {$total_page_links =count($this->_links_page); if (!is_numeric($n) || $n >$total_page_links) {$n =$total_page_links; }$links =array(); for ($i =1; $i <= $n; $i++) {$links[] =array_shift($this->_links_page); }$html =join($this->_links_delimiter, $links); if (strlen($this->_charset) >0 && strlen($this->_sape_charset) >0 && $this->_sape_charset != $this->_charset && function_exists('iconv') ){$new_html =@iconv($this->_sape_charset, $this->_charset, $html); if ($new_html) {$html =$new_html; }}if ($this->_is_our_bot) {$html ='<sape_noindex>' .$html .'</sape_noindex>'; }}else {$html =$this->_links_page; if ($this->_is_our_bot) {$html .= '<sape_noindex></sape_noindex>'; }}$html =$this->_return_html($html); return $html; }function _get_db_file() {if ($this->_multi_site) {return dirname(__FILE__) .I20040 .$this->_host .'.links.db'; }else {return dirname(__FILE__) .'/links.db'; }}function _get_dispenser_path() {return '/code.php?user=' ._SAPE_USER .'&host=' .$this->_host; }function set_data($data) {if ($this->_ignore_case) {$this->_links =array_change_key_case($data); }else {$this->_links =$data; }if (isset($this->_links[I20041])) {$this->_links_delimiter =$this->_links[I20041]; }if (isset($this->_links['__sape_charset__'])) {$this->_sape_charset =$this->_links['__sape_charset__']; }else {$this->_sape_charset =I20011; }if (@array_key_exists($this->_request_uri, $this->_links) && is_array($this->_links[$this->_request_uri])) {$this->_links_page =$this->_links[$this->_request_uri]; }else {if (isset($this->_links['__sape_new_url__']) && strlen($this->_links['__sape_new_url__'])) {if ($this->_is_our_bot || $this->_force_show_code) {$this->_links_page =$this->_links[I20042]; }}}if (isset($this->_links['__sape_page_obligatory_output__'])) {$this->_page_obligatory_output =$this->_links['__sape_page_obligatory_output__']; }if (isset($this->_links['__sape_show_only_block__'])) {$this->_show_only_block =$this->_links['__sape_show_only_block__']; }else {$this->_show_only_block =false; }if (isset($this->_links[I20043]) && !empty($this->_links[I20043]) && is_array($this->_links[I20043]) ){$this->_block_tpl =$this->_links[I20043]; }if (isset($this->_links['__sape_block_tpl_options__']) && !empty($this->_links['__sape_block_tpl_options__']) && is_array($this->_links['__sape_block_tpl_options__']) ){$this->_block_tpl_options =$this->_links['__sape_block_tpl_options__']; }if (isset($this->_links['__sape_block_uri_idna__']) && !empty($this->_links['__sape_block_uri_idna__']) && is_array($this->_links['__sape_block_uri_idna__']) ){$this->_block_uri_idna =$this->_links['__sape_block_uri_idna__']; }$check_blocks =array( 'beforeall', I20044, 'afterblock', 'itemobligatory', 'itemconditional', 'afterall' );foreach ($check_blocks as $block_name) {$var_name =I20045 .$block_name .'__'; $prop_name ='_block_ins_' .$block_name; if (isset($this->_links[$var_name]) && strlen($this->_links[$var_name]) >0) {$this->$prop_name =$this->_links[$var_name]; }}}}class SAPE_context extends SAPE_base {var $_words =array(); var $_words_page =array(); var $_user_agent ='SAPE_Context PHP'; var $_filter_tags =array('a', I20046, 'select', 'script', 'style', 'label', I20047, 'noindex', 'button'); var $_debug_actions =array(); function SAPE_context($options =null) {parent::SAPE_base($options); $this->load_data(); }function _debug_action_start() {if (!$this->_debug) {return; }$this->_debug_actions =array(); $this->_debug_actions[] =$this->_get_full_user_agent_string(); }function _debug_action_append($data, $key =I20011) {if (!$this->_debug) {return; }if (!empty($key)) {$this->_debug_actions[] =array($key => $data); }else {$this->_debug_actions[] =$data; }}function _debug_action_output() {if (!$this->_debug || empty($this->_debug_actions)) {return I20011; }$debug_info =$this->_debug_output($this->_debug_actions); $this->_debug_actions =array(); return $debug_info; }function replace_in_text_segment($text) {$this->_debug_action_start(); $this->_debug_action_append('START: replace_in_text_segment()'); $this->_debug_action_append($text, 'argument for replace_in_text_segment'); if (count($this->_words_page) >0) {$source_sentences =array(); foreach ($this->_words_page as $n => $sentence) {$special_chars =array( I20048 => '&', '&quot;' => '"', '&#039;' => I20049, '&lt;' => I20024, '&gt;' => '>' );$sentence =strip_tags($sentence); $sentence =strip_tags($sentence); $sentence =str_replace(array_keys($special_chars), array_values($special_chars), $sentence); $htsc_charset =empty($this->_charset) ?'windows-1251' :$this->_charset; $quote_style =ENT_COMPAT; if (version_compare(PHP_VERSION, I20050) >= 0) {$quote_style =ENT_COMPAT |ENT_HTML401; }$sentence =htmlspecialchars($sentence, $quote_style, $htsc_charset); $sentence =preg_quote($sentence, I20040); $replace_array =array(); if (preg_match_all('/(&[#a-zA-Z0-9]{2,6};)/isU', $sentence, $out)) {for ($i =0; $i <count($out[1]); $i++) {$unspec =$special_chars[$out[1][$i]]; $real =$out[1][$i]; $replace_array[$unspec] =$real; }}foreach ($replace_array as $unspec => $real) {$sentence =str_replace($real, '((' .$real .')|(' .$unspec .'))', $sentence); }$source_sentences[$n] =str_replace(I20051, '((\s)|(&nbsp;))+', $sentence); }$this->_debug_action_append($source_sentences, 'sentences for replace'); $first_part =true; if (count($source_sentences) >0) {$content =I20011; $open_tags =array(); $close_tag =I20011; $part =strtok(I20051 .$text, I20024); while ($part !== false) {if (preg_match('/(?si)^(\/?[a-z0-9]+)/', $part, $matches)) {$tag_name =strtolower($matches[1]); if (substr($tag_name, 0, 1) == I20040) {$close_tag =substr($tag_name, 1); $this->_debug_action_append($close_tag, 'close tag'); }else {$close_tag =I20011; $this->_debug_action_append($tag_name, I20052); }$cnt_tags =count($open_tags); if (($cnt_tags >0) && ($open_tags[$cnt_tags -1] == $close_tag)) {array_pop($open_tags); $this->_debug_action_append($tag_name, 'deleted from open_tags'); if ($cnt_tags -1 == 0) {$this->_debug_action_append('start replacement'); }}if (count($open_tags) == 0) {if (!in_array($tag_name, $this->_filter_tags)) {$split_parts =explode('>', $part, 2); if (count($split_parts) == 2) {foreach ($source_sentences as $n => $sentence) {if (preg_match(I20040 .$sentence .I20040, $split_parts[1]) == 1) {$split_parts[1] =preg_replace(I20040 .$sentence .I20040, str_replace('$', I20053, $this->_words_page[$n]), $split_parts[1], 1); $this->_debug_action_append($sentence .' --- ' .$this->_words_page[$n], 'replaced'); unset($source_sentences[$n]); unset($this->_words_page[$n]); }}$part =$split_parts[0] .'>' .$split_parts[1]; unset($split_parts); }}else {$open_tags[] =$tag_name; $this->_debug_action_append($tag_name, 'added to open_tags, stop replacement'); }}}else {foreach ($source_sentences as $n => $sentence) {if (preg_match(I20040 .$sentence .I20040, $part) == 1) {$part =preg_replace(I20040 .$sentence .I20040, str_replace(I20054, I20053, $this->_words_page[$n]), $part, 1); $this->_debug_action_append($sentence .' --- ' .$this->_words_page[$n], 'replaced'); unset($source_sentences[$n]); unset($this->_words_page[$n]); }}}if ($first_part) {$content .= $part; $first_part =false; }else {$content .= I20024 .$part; }unset($part); $part =strtok(I20024); }$text =ltrim($content); unset($content); }}else {$this->_debug_action_append('No word\'s for page'); }if ($this->_is_our_bot || $this->_force_show_code || $this->_debug) {$text ='<sape_index>' .$text .I20055; if (isset($this->_words[I20042]) && strlen($this->_words[I20042])) {$text .= $this->_words[I20042]; }}if (count($this->_words_page) >0) {$this->_debug_action_append($this->_words_page, 'Not replaced'); }$this->_debug_action_append('END: replace_in_text_segment()'); $text .= $this->_debug_action_output(); return $text; }function replace_in_page(&$buffer) {$this->_debug_action_start(); $this->_debug_action_append('START: replace_in_page()'); $s_globals =new SAPE_globals(); if (!$s_globals->page_obligatory_output_shown() && isset($this->_page_obligatory_output) && !empty($this->_page_obligatory_output) ){$split_content =preg_split('/(?smi)(<\/?body[^>]*>)/', $buffer, -1, PREG_SPLIT_DELIM_CAPTURE); if (count($split_content) == 5) {$buffer =$split_content[0] .$split_content[1] .$split_content[2] .(false == $this->_show_counter_separately ?$this->_return_obligatory_page_content() :I20011) .$split_content[3] .$split_content[4]; unset($split_content); $s_globals->page_obligatory_output_shown(true); }}if (count($this->_words_page) >0) {$split_content =preg_split('/(?smi)(<\/?sape_index>)/', $buffer, -1); $cnt_parts =count($split_content); if ($cnt_parts >1) {if ($cnt_parts >= 3) {for ($i =1; $i <$cnt_parts; $i =$i +2) {$split_content[$i] =$this->replace_in_text_segment($split_content[$i]); }}$buffer =implode(I20011, $split_content); $this->_debug_action_append($cnt_parts, 'Split by Sape_index cnt_parts='); }else {$split_content =preg_split('/(?smi)(<\/?body[^>]*>)/', $buffer, -1, PREG_SPLIT_DELIM_CAPTURE); if (count($split_content) == 5) {$split_content[0] =$split_content[0] .$split_content[1]; $split_content[1] =$this->replace_in_text_segment($split_content[2]); $split_content[2] =$split_content[3] .$split_content[4]; unset($split_content[3]); unset($split_content[4]); $buffer =$split_content[0] .$split_content[1] .$split_content[2]; $this->_debug_action_append('Split by BODY'); }else {$this->_debug_action_append('Cannot split by BODY'); }}}else {if (!$this->_is_our_bot && !$this->_force_show_code && !$this->_debug) {$buffer =preg_replace('/(?smi)(<\/?sape_index>)/', I20011, $buffer); }else {if (isset($this->_words[I20042]) && strlen($this->_words[I20042])) {$buffer .= $this->_words[I20042]; }}$this->_debug_action_append('No word\'s for page'); }$this->_debug_action_append('STOP: replace_in_page()'); $buffer .= $this->_debug_action_output(); return $buffer; }function _get_db_file() {if ($this->_multi_site) {return dirname(__FILE__) .I20040 .$this->_host .'.words.db'; }else {return dirname(__FILE__) .'/words.db'; }}function _get_dispenser_path() {return '/code_context.php?user=' ._SAPE_USER .'&host=' .$this->_host; }function set_data($data) {$this->_words =$data; if (@array_key_exists($this->_request_uri, $this->_words) && is_array($this->_words[$this->_request_uri])) {$this->_words_page =$this->_words[$this->_request_uri]; }if (isset($this->_words['__sape_page_obligatory_output__'])) {$this->_page_obligatory_output =$this->_words['__sape_page_obligatory_output__']; }}}class SAPE_articles extends SAPE_base {var $_request_mode; var $_server_list =array('dispenser.articles.sape.ru'); var $_data =array(); var $_article_id; var $_save_file_name; var $_announcements_delimiter =I20011; var $_images_path; var $_template_error =false; var $_noindex_code ='<!--sape_noindex-->'; var $_headers_enabled =false; var $_mask_code; var $_real_host; var $_user_agent ='SAPE_Articles_Client PHP'; function SAPE_articles($options =null) {parent::SAPE_base($options); if (is_array($options) && isset($options['headers_enabled'])) {$this->_headers_enabled =$options['headers_enabled']; }if (isset($options[I20016]) && strlen($options[I20016])) {$this->_charset =$options[I20016]; }else {$this->_charset =I20011; }$this->_get_index(); if (!empty($this->_data['index']['announcements_delimiter'])) {$this->_announcements_delimiter =$this->_data['index']['announcements_delimiter']; }if (!empty($this->_data['index'][I20016]) and !(isset($options[I20016]) && strlen($options[I20016])) ){$this->_charset =$this->_data['index'][I20016]; }if (is_array($options)) {if (isset($options[I20056])) {$host =$options[I20056]; }}elseif (strlen($options)) {$host =$options; $options =array(); }if (isset($host) && strlen($host)) {$this->_real_host =$host; }else {$this->_real_host =$_SERVER[I20012]; }if (!isset($this->_data['index']['announcements'][$this->_request_uri])) {$this->_correct_uri(); }}function _correct_uri() {if (substr($this->_request_uri, -1) == I20040) {$new_uri =substr($this->_request_uri, 0, -1); }else {$new_uri =$this->_request_uri .I20040; }if (isset($this->_data['index']['announcements'][$new_uri])) {$this->_request_uri =$new_uri; }}function return_announcements($n =null, $offset =0) {$output =I20011; if ($this->_force_show_code || $this->_is_our_bot) {if (isset($this->_data[I20057]['checkCode'])) {$output .= $this->_data[I20057]['checkCode']; }}if (false == $this->_show_counter_separately) {$output .= $this->_return_obligatory_page_content(); }if (isset($this->_data[I20057]['announcements'][$this->_request_uri])) {$total_page_links =count($this->_data[I20057]['announcements'][$this->_request_uri]); if (!is_numeric($n) || $n >$total_page_links) {$n =$total_page_links; }$links =array(); for ($i =1; $i <= $n; $i++) {if ($offset >0 && $i <= $offset) {array_shift($this->_data[I20057][I20058][$this->_request_uri]); }else {$links[] =array_shift($this->_data[I20057][I20058][$this->_request_uri]); }}$html =join($this->_announcements_delimiter, $links); if ($this->_is_our_bot) {$html ='<sape_noindex>' .$html .'</sape_noindex>'; }$output .= $html; }return $output; }function _get_index() {$this->_set_request_mode(I20057); $this->_save_file_name ='articles.db'; $this->load_data(); }function process_request() {if (!empty($this->_data[I20057]) and isset($this->_data[I20057]['articles'][$this->_request_uri])) {return $this->_return_article(); }elseif (!empty($this->_data[I20057]) and isset($this->_data[I20057][I20059][$this->_request_uri])) {return $this->_return_image(); }else {if ($this->_is_our_bot) {return $this->_return_html($this->_data[I20057]['checkCode'] .$this->_noindex_code); }else {return $this->_return_not_found(); }}}function _return_article() {$this->_set_request_mode('article'); $article_meta =$this->_data[I20057]['articles'][$this->_request_uri]; $this->_save_file_name =$article_meta['id'] .I20060; $this->_article_id =$article_meta['id']; $this->load_data(); if (false == $this->_show_counter_separately) {$this->_data[$this->_request_mode]['body'] =$this->_return_obligatory_page_content() .$this->_data[$this->_request_mode]['body']; }if (!isset($this->_data['article'][I20061]) OR $this->_data['article'][I20061] <$article_meta[I20061]) {unlink($this->_get_db_file()); $this->load_data(); }$template =$this->_get_template($this->_data[I20057]['templates'][$article_meta['template_id']]['url'], $article_meta[I20062]); $article_html =$this->_fetch_article($template); if ($this->_is_our_bot) {$article_html .= $this->_noindex_code; }return $this->_return_html($article_html); }function _prepare_path_to_images() {$this->_images_path =dirname(__FILE__) .'/images/'; if (!is_dir($this->_images_path)) {if (@mkdir($this->_images_path)) {@chmod($this->_images_path, 0777); }else {return $this->raise_error('Нет папки ' .$this->_images_path .'. Создать не удалось. Выставите права 777 на папку.'); }}if ($this->_multi_site) {$this->_images_path .= $this->_host .'.'; }return true; }function _return_image() {$this->_set_request_mode(I20063); $this->_prepare_path_to_images(); $image_meta =$this->_data[I20057][I20059][$this->_request_uri]; $image_path =$this->_images_path .$image_meta['id'] .'.' .$image_meta['ext']; if (!is_file($image_path) or filemtime($image_path) >$image_meta[I20061]) {@touch($image_path, $image_meta[I20061]); $path =$image_meta['dispenser_path']; foreach ($this->_server_list as $server) {if ($data =$this->fetch_remote_file($server, $path)) {if (substr($data, 0, 12) == I20026) {$this->raise_error($data); }else {if (strlen($data) >0) {$this->_write($image_path, $data); break; }}}}}unset($data); if (!is_file($image_path)) {return $this->_return_not_found(); }$image_file_meta =@getimagesize($image_path); $content_type =isset($image_file_meta[I20064]) ?$image_file_meta[I20064] :I20063; if ($this->_headers_enabled) {header('Content-Type: ' .$content_type); }return $this->_read($image_path); }function _fetch_article($template) {if (strlen($this->_charset)) {$template =str_replace('{meta_charset}', $this->_charset, $template); }foreach ($this->_data[I20057]['template_fields'] as $field) {if (isset($this->_data['article'][$field])) {$template =str_replace(I20038 .$field .I20065, $this->_data['article'][$field], $template); }else {$template =str_replace(I20038 .$field .I20065, I20011, $template); }}return ($template); }function _get_template($template_url, $templateId) {$this->_save_file_name ='tpl.articles.db'; $index_file =$this->_get_db_file(); if (file_exists($index_file)) {$this->_data['templates'] =unserialize($this->_read($index_file)); }if (!isset($this->_data['templates'][$template_url]) or (time() -$this->_data[I20066][$template_url][I20061]) >$this->_data[I20057][I20066][$templateId]['lifetime'] ){$this->_refresh_template($template_url, $index_file); }if (!isset($this->_data[I20066][$template_url])) {if ($this->_template_error) {return $this->raise_error($this->_template_error); }return $this->raise_error('Не найден шаблон для статьи'); }return $this->_data[I20066][$template_url]['body']; }function _refresh_template($template_url, $index_file) {$parseUrl =parse_url($template_url); $download_url =I20011; if ($parseUrl['path']) {$download_url .= $parseUrl[I20067]; }if (isset($parseUrl['query'])) {$download_url .= I20028 .$parseUrl['query']; }$template_body =$this->fetch_remote_file($this->_real_host, $download_url, true); if (!$this->_is_valid_template($template_body)) {return false; }$template_body =$this->_cut_template_links($template_body); $this->_data[I20066][$template_url] =array('body' => $template_body, I20061 => time()); $this->_write($index_file, serialize($this->_data[I20066])); return true; }function _fill_mask($data) {global $unnecessary; $len =strlen($data[0]); $mask =str_repeat($this->_mask_code, $len); $unnecessary[$this->_mask_code][] =array( 'mask' => $mask, I20068 => $data[0], 'len' => $len );return $mask; }function _cut_unnecessary(&$contents, $code, $mask) {global $unnecessary; $this->_mask_code =$code; $_unnecessary[$this->_mask_code] =array(); $contents =preg_replace_callback($mask, array($this, '_fill_mask'), $contents); }function _restore_unnecessary(&$contents, $code) {global $unnecessary; $offset =0; if (!empty($unnecessary[$code])) {foreach ($unnecessary[$code] as $meta) {$offset =strpos($contents, $meta['mask'], $offset); $contents =substr($contents, 0, $offset) .$meta[I20068] .substr($contents, $offset +$meta['len']); }}}function _cut_template_links($template_body) {if (function_exists('mb_internal_encoding') && strlen($this->_charset) >0) {mb_internal_encoding($this->_charset); }$link_pattern ='~(\<a [^\>]*?href[^\>]*?\=["\']{0,1}http[^\>]*?\>.*?\</a[^\>]*?\>|\<a [^\>]*?href[^\>]*?\=["\']{0,1}http[^\>]*?\>|\<area [^\>]*?href[^\>]*?\=["\']{0,1}http[^\>]*?\>)~si'; $link_subpattern ='~\<a |\<area ~si'; $rel_pattern ='~[\s]{1}rel\=["\']{1}[^ "\'\>]*?["\']{1}| rel\=[^ "\'\>]*?[\s]{1}~si'; $href_pattern ='~[\s]{1}href\=["\']{0,1}(http[^ "\'\>]*)?["\']{0,1} {0,1}~si'; $allowed_domains =$this->_data[I20057][I20069]; $allowed_domains[] =$this->_host; $allowed_domains[] ='www.' .$this->_host; $this->_cut_unnecessary($template_body, 'C', '|<!--(.*?)-->|smi'); $this->_cut_unnecessary($template_body, 'S', '|<script[^>]*>.*?</script>|si'); $this->_cut_unnecessary($template_body, 'N', '|<noindex[^>]*>.*?</noindex>|si'); $slices =preg_split($link_pattern, $template_body, -1, PREG_SPLIT_DELIM_CAPTURE); if (is_array($slices)) {foreach ($slices as $id => $link) {if ($id %2 == 0) {continue; }if (preg_match($href_pattern, $link, $urls)) {$parsed_url =@parse_url($urls[1]); $host =isset($parsed_url[I20056]) ?$parsed_url[I20056] :false; if (!in_array($host, $allowed_domains) || !$host) {$slices[$id] ='<noindex>' .$slices[$id] .'</noindex>'; }}}$template_body =implode(I20011, $slices); }$this->_restore_unnecessary($template_body, I20070); $slices =preg_split($link_pattern, $template_body, -1, PREG_SPLIT_DELIM_CAPTURE); if (is_array($slices)) {foreach ($slices as $id => $link) {if ($id %2 == 0) {continue; }if (preg_match($href_pattern, $link, $urls)) {$parsed_url =@parse_url($urls[1]); $host =isset($parsed_url[I20056]) ?$parsed_url[I20056] :false; if (!in_array($host, $allowed_domains) || !$host) {$slices[$id] =preg_replace($rel_pattern, I20011, $link); $slices[$id] =preg_replace($link_subpattern, '$0rel="nofollow" ', $slices[$id]); }}}$template_body =implode(I20011, $slices); }$this->_restore_unnecessary($template_body, 'S'); $this->_restore_unnecessary($template_body, 'C'); return $template_body; }function _is_valid_template($template_body) {foreach ($this->_data[I20057]['template_required_fields'] as $field) {if (strpos($template_body, I20038 .$field .I20065) === false) {$this->_template_error ='В шаблоне не хватает поля ' .$field .'.'; return false; }}return true; }function _return_html($html) {if ($this->_headers_enabled) {header('HTTP/1.x 200 OK'); if (!empty($this->_charset)) {header('Content-Type: text/html; charset=' .$this->_charset); }}return $html; }function _return_not_found() {header('HTTP/1.x 404 Not Found'); }function _get_dispenser_path() {switch ($this->_request_mode) {case I20057: return I20071 ._SAPE_USER .'&host=' .$this->_host .'&rtype=' .$this->_request_mode; break; case 'article': return I20071 ._SAPE_USER .'&host=' .$this->_host .I20072 .$this->_request_mode .'&artid=' .$this->_article_id; break; case I20063: return $this->image_url; break; }}function _set_request_mode($mode) {$this->_request_mode =$mode; }function _get_db_file() {if ($this->_multi_site) {return dirname(__FILE__) .I20040 .$this->_host .'.' .$this->_save_file_name; }else {return dirname(__FILE__) .I20040 .$this->_save_file_name; }}function set_data($data) {$this->_data[$this->_request_mode] =$data; if (isset($data['__sape_page_obligatory_output__'])) {$this->_page_obligatory_output =$data['__sape_page_obligatory_output__']; }}}