function getButtonByName(editor, name, getEl){
    buttons = editor.buttons,
    toolbarObj = editor.theme.panel.find('toolbar *'),
    un = 'undefined';
    if(typeof buttons[name] === un)
        return false;
    var settings = buttons[name], result = false, length = 0;
    tinymce.each(settings, function(v, k){
        length++;
    });
    tinymce.each(toolbarObj, function(v, k) {
        if (v.type !== 'button' || typeof v.settings === un)
            return;
        var i = 0;
        tinymce.each(v.settings, function (v, k) {
            if(settings[k] === v)
                i++;
        });
        if(i !== length)
            return;
        result = v;
        if(getEl !== false)
            result = v.getEl();
        return false;
    });
    return result;
}

tinymce.PluginManager.add(
    "amiro.code",
    function(e){        
        function o(){            
            var ccaContainer = e.contentAreaContainer;
            var textarea = $('#' + e.id);
            $(ccaContainer).append(textarea);
            e.codeMode = (typeof(e.codeMode) !== 'undefined') ? !e.codeMode : true;
            var buttons = ['amiro.code', "bold", "italic", "removeformat", "outdent", "indent", "alignleft", "aligncenter", "alignright", "alignjustify", "bullist", "numlist", "formatselect", "styleselect"];
            var path = $(e.contentAreaContainer).parent().find('.mce-path');
            if(e.codeMode){
                e.lastPath = path.html();
                textarea.height($(ccaContainer).height());
                $(ccaContainer).find('iframe').hide();
                path.html('&nbsp;');
                textarea.attr('wrap', 'hard');
                textarea.addClass('mce-sourcecode');
                textarea.show();   

                // Switch of Image
                var btnImg = getButtonByName(e, 'amiro.image', false);
                if(btnImg){
                    btnImg.active(false);
                    var imgSettings = $(ccaContainer).find('.mce-image-settings');
                    imgSettings.remove();
                    e.imagePanelOn = false;
                }
                
                for(var i = 0; i < buttons.length; i++){
                    var  item = buttons[i];
                    var  butt = getButtonByName(e, item, false);
                    if(butt){
                        if(item !== 'amiro.code'){
                            butt.disabled(true);
                        }else{
                            butt.active(true);
                        }
                    }
                }
                e.theme.panel._items[0]._items[0]._items[5]._items[0].disabled(true);
                e.theme.panel._items[0]._items[0]._items[6]._items[0].disabled(true);
                e.theme.panel._items[0]._items[0]._items[7]._items[0].disabled(true);
            }else{
                if(textarea.val() === ''){
                    e.lastPath = '&nbsp;';
                    path.css('visibility', 'hidden');
                }
                path.html(e.lastPath ? e.lastPath : '&nbsp;');
                e.load();
                textarea.hide();
                textarea.removeClass('mce-sourcecode');
                $(ccaContainer).find('iframe').show();
                for(var i = 0; i < buttons.length; i++){
                    var  item = buttons[i];
                    var  butt = getButtonByName(e, item, false);
                    if(butt){
                        if(item !== 'amiro.code'){
                            butt.disabled(false);
                        }else{
                            butt.active(false);
                        }
                    }
                }
                e.theme.panel._items[0]._items[0]._items[5]._items[0].disabled(false);
                e.theme.panel._items[0]._items[0]._items[6]._items[0].disabled(false);
                e.theme.panel._items[0]._items[0]._items[7]._items[0].disabled(false);
            }
        };
        e.addCommand("mceCodeEditor",o);
        e.addButton("amiro.code",{
            icon:"code",
            tooltip:"Source code",
            onclick:o
        });
        e.addMenuItem("amiro.code",{icon:"code",text:"Source code",context:"tools",onclick:o});
        
        // Remove p/div in empty editor
        e.on('SaveContent', function(ed){
            return function(e){
                setTimeout(function(){
                    var textarea = $('#' + ed.id);
                    var path = $(ed.contentAreaContainer).parent().find('.mce-path');
                    if(textarea.val() === ''){
                        path.html('&nbsp;');
                        path.css('visibility', 'hidden');
                    }else{
                        path.css('visibility', 'visible');
                    }
                }, 1);
            };
        }(e));
    }
);