tinymce.PluginManager.add('amiro.specblock', function(editor) {

    var specblockClass = 'mce-amiro-specblock',
        specblockHtml = '##spec_num##';

    var specblockRegExp = new RegExp('##spec_(.*?)##', 'gi');

    var specblockHolderHtml = '<nobr title="$1" contenteditable="false" class="' + specblockClass +
    '" data-mce-specblock="$1" data-mce-resize="false">$1</nobr>';

    editor.on('ResolveName', function(e) {
        if (e.target.nodeName == 'NOBR' && editor.dom.hasClass(e.target, specblockClass)) {
            e.name = 'specblock';
        }
    });

    editor.on('click', function(e) {
        e = e.target;
        if (e.nodeName === 'NOBR' && editor.dom.hasClass(e, specblockClass)) {
            editor.selection.select(e);
        }
    });

    editor.on('BeforeSetContent', function(e) {
        if(typeof(e.content) != 'undefined'){
            e.content = e.content.toString().replace(specblockRegExp, specblockHolderHtml);
        }
    });

    editor.on('PreInit', function() {
        editor.serializer.addNodeFilter('nobr', function(nodes) {
            var i = nodes.length, node, className;

            while (i--) {
                node = nodes[i];
                className = node.attr('class');
                if (className && className.indexOf(specblockClass) !== -1) {
                    node.type = 3;
                    node.value = specblockHtml.replace('num', node.attr('data-mce-specblock'));
                    node.raw = true;
                }
            }
        });
    });
});
