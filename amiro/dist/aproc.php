<?php /**
 * @copyright  2000-2016 Amiro.CMS. All rights reserved. 
 * @version    $Id$ 
 * @size       44041 xkqwsypliwxntpwtpmwmxxitpkuwmyskgrnsqlxtpsuumxngnxqyitpstysstnkkwnyxpnir
 */ ?><?php foreach(array(124=>"",125=>"127`0`0`1",126=>"|JHP",127=>"RhhT|gzTo",128=>"DQJQWt?WHntQnt?frHI?WID|IHSuJQD|tQIGJZtQD?COQrQ?GZtO='tQIGJZtQD~'?ZnS?nZIQ='ZSv|GJZWQD|WHIIHn`tGJ'",129=>"QxtSQY",130=>"tQIGJZtQD~",131=>'MS|ZSvQrtMDQr',132=>'whNFmp|mNm',133=>"dqT?Nziqd?utf8",134=>"YDtZt",135=>"'?ZnS?W`MS='",136=>"_",137=>"!?MS|WZIGZMPn=",138=>"'!?OHDt='",139=>"'",140=>'^',141=>"WHntQnt",142=>'!',143=>"uDQS",144=>"GJZWQ",145=>"b+I+S?o%M%D",146=>"!?SZB='",147=>"'!?uWJMWK='",148=>'~;OttGD %\~\~~M',149=>"rQfQrQr",150=>'_',151=>"j",152=>'zsVqRTmdqR|Fmqjs',153=>"DQJQWt?MS!?IHSuJQ|nZIQ!?YrHCDQ|IHSQ!?DOHC|unMEuQ!?WJMWK|unMEuQ!?uDQ|DtZtMDtMWD?frHI?WID|ZSv|GJZWQD?COQrQ?MS?Mn}",154=>"{?ZnS?DHurWQ|tBGQ='IHSuJQ'?ZnS?GuYJMW=1",155=>"MS",156=>"WHnS",157=>"IHSuJQ|nZIQ",158=>"^",159=>"^SQtZMJD^",160=>"GJZWQmS",161=>"WJMWK|unMEuQ",162=>'uDQ|DtZtMDtMWD',163=>"MnDQrt?SQJZBQS?MntH?WID|ZSv|IHSuJQD|DtZtD|tIG?DQt?IHS|nZIQ='",164=>"'!?MS|MtQI='",165=>"'!?OHur|HnJB='",166=>"YHSBTBGQ",167=>"Wnt",168=>"s",169=>"|",170=>"MG",171=>"Wur|WHDt|vMQC",172=>"WHDt|vMQC",173=>"\"?}",174=>"WHDt|WJMWK",175=>"GZMS|WHDt|WJMWK",176=>"Wur|WHDt|WJMWK",177=>"IZx|vMQCD",178=>"QnS|SZtQ",179=>"?hR?",180=>"{?hR?",181=>"{#Nhc}{{",182=>"JZnP",183=>"QxGMrQS",184=>"GJZWQ|tBGQ",185=>"MD|tHGJMnQ",186=>"WOZMn|HrMP",187=>"GJZWQ|CMStO",188=>"DOHC|SQfZuJt",189=>"Y`WHntQnt",190=>"CMStO",191=>"OQMPOt",192=>"?",193=>"ZnS?W`MS?Mn?}",194=>"tZrPQtMnP|WHIGMJQS",195=>"{^",196=>"tBGQ",197=>"urJ",198=>"MS|WZIGZMPn",199=>"WJMWK|urJ",200=>"ZnS?Y`CMStO=",201=>"HrSQr?YB?RzNs}{",202=>"truQ",203=>"OttG%~~",204=>"]rQfQrQr=",205=>"'!?uvMQC='",206=>"|tQxt",207=>"|tHGJMnQ",208=>"\r",209=>'\\"',210=>"==",211=>'"{^',212=>"{") as $i1=>$i2){$i3=strrev("rtrts");define("I".$i1,$i3($i2,'abcdeghijklmopqswyz ~`!@#%^&*()_-+|{}[];:<>,./?ABCDEGHIJKLMOPQSWYZ','ZYWSQPOMLKJIHGEDCBA?/.,><:;][}{|+-_)(*&^%#@!`~ zywsqpomlkjihgedcba'));} $l1L1LIl =I124; if(!function_exists("_d")){ function _d($data){ if($_SERVER["REMOTE_ADDR"] == "81.1.214.71" || $_SERVER["REMOTE_ADDR"] == I125 || $_SERVER["REMOTE_ADDR"] == "192.168.2.110"){ print "<pre>"; print_r($data); print "</pre>"; }}}if(!function_exists(I126)){ function _log($data){ if($hFile =fopen("adv.txt", "a")){ fwrite($hFile, $data."\n"); fclose($hFile); }}}$aSets =null; function TlIII11(){ global $lLII1L1; $res =I124; if(defined("TEMPLATES_FROM_DISK")) $res =file_get_contents($GLOBALS[I127]."templates/adv_places_common.tpl"); else{ $sql =I128; $res =mysql_query($sql, $lLII1L1); if($data =mysql_fetch_array($res, MYSQL_ASSOC)) $res =&$data["content"]; }return $res; }function getSet($setName, $l1L1LIL){ global $aSets; if(is_null($aSets)){ $aSets =array(); $l1L1LI1 =TlIII11(); if(!empty($l1L1LI1)){ $l1L1LI1 =preg_replace('/##--.*?--##/s', '', $l1L1LI1); if(preg_match_all('/<!--#set\s+var="(.*?)"\s+value="(.*?)"-->/si', $l1L1LI1, $matches)){ $l1L1LlI =sizeof($matches[0]); for($i =0; $i <$l1L1LlI; $i++){ foreach(explode(';', $matches[1][$i]) as $l1L1Lll){ $l1L1Lll =trim($l1L1Lll); if(!empty($l1L1Lll)) $aSets[$l1L1Lll] =$matches[2][$i]; }}}}}$res =I124; if(isset($aSets[$setName])){ $aSetParts =explode("##", $aSets[$setName]); for($i =0; $i <sizeof($aSetParts); $i++){ if($i %2 != 0){ if(isset($l1L1LIL[$aSetParts[$i]])) $res .= $l1L1LIL[$aSetParts[$i]]; }else{ $res .= $aSetParts[$i]; }}}return $res; }$SKIP_CONST =TRUE; require 'cm_ini.php'; if($sys["err"][I129] >0 && $sys["err"]["read_templates_from_disk"]) define('TEMPLATES_FROM_DISK', true); $CONFIG_PATH =$ROOT_PATH."/_local/"; $TEMPLATES_PATH =$ROOT_PATH.I130; $CLASSES_PATH =$HOST_PATH."_shared/code/classes/"; $l1L1LlL =parse_ini_file($CONFIG_PATH."config_adv.php"); if(!is_array($l1L1LlL)) exit; if(!isset($l1L1LlL['ADVERTISER_FIELD']) || $l1L1LlL['ADVERTISER_FIELD'] != I131 && $l1L1LlL['ADVERTISER_FIELD'] != 'id_owner'){ $l1L1LlL['ADVERTISER_FIELD'] ='id_owner'; }if(!($lLII1L1 =mysql_connect( DB_Host, DB_User, DB_Password, FALSE, $GLOBALS[I132]['dbaccess']['DB_ClientFlags'] ))){exit; }if(!mysql_select_db(DB_Database, $lLII1L1)){ exit; }$ver =@mysql_get_server_info($lLII1L1); $ver =preg_match('/^(\d+)\.(\d+)\.(\d+)/', $ver, $m) ?intval(sprintf("%d%02d%02d",$m[1],$m[2],$m[3])) :0; if ($ver >= 40100) {$sql =I133; mysql_query($sql, $lLII1L1); }$referer =(isset($_GET["referer"]) ?stripslashes($_GET["referer"]) :I124); switch($_GET["action"]){ case "lclick": exit; case I134: $l1L1Ll1 =0; $l1L1LLI =explode(';', $_GET["data"]); shuffle($l1L1LLI); foreach($l1L1LLI as $l1L1LLl){ $l1L1LLL =explode(',', $l1L1LLl); $idPlace =intval($l1L1LLL[0]); $l1L1LL1 =intval($l1L1LLL[1]); $l1L1L1I =intval($l1L1LLL[2]); if($idPlace >0 && $l1L1LL1 >0 && $l1L1L1I >0){ $sql ="select p.show_unique, p.use_statistics from cms_adv_banners b left join cms_adv_campaigns c ON POSITION(CONCAT(';', c.id,';') in b.id_campaign)>0 left join cms_adv_places p ON POSITION(CONCAT(';', p.id,';') in c.ids_places)>0 WHERE b.public=1 and c.public=1 and c.status='active' and p.public=1 and b.id='".$l1L1L1I.I135.$l1L1LL1."' and p.id='".$idPlace."' limit 1"; $res =mysql_query($sql, $lLII1L1); if($resData =mysql_fetch_array($res)){ if($resData["use_statistics"] && (!$resData["show_unique"] || TlIIlT1(1, $idPlace.I136.$l1L1LL1.I136.$l1L1L1I))){ $dateTime =time(); $l1L1L1l =array(date("Y-m-d H:i:s", $dateTime), date("Y-m-d", $dateTime), date("G", $dateTime)); $sql ="insert DELAYED into cms_adv_stats_tmp set type='view', id_place=".$idPlace.I137.$l1L1LL1.", id_banner=".$l1L1L1I.", day='".$l1L1L1l[0]."', date_only='".$l1L1L1l[1]."', hour_only='".$l1L1L1l[2].I138.addslashes($referer)."', user_ip='".$_SERVER["REMOTE_ADDR"]."', uview='".$resData["show_unique"].I139; mysql_query($sql, $lLII1L1); }}}}exit; break; case "showall": TlIIlTI($_GET["places"]); $l1L1L1L =''; $l1L1L11 =''; $l1L1Ll1 =0; foreach(explode(I140, $_GET["places"]) as $placeId){ if(($l1L11II =mb_strpos($placeId, "_")) !== false){ $l1L1Ll1 =mb_substr($placeId, $l1L11II+1)-1; $placeId =mb_substr($placeId, 0, $l1L11II); }$placeId =intval($placeId); if($placeId >0){ $l1L1Ll1++; $l1L1LLl =TlIIlTl($placeId, $_GET["curl"], $l1L1L1L, $_GET["rs"]); if(!empty($l1L1LLl[I141])){ $l1L1L11 .= getSet("banners_page_script", array_merge($l1L1LLl, array("cnt" => $l1L1Ll1))); $l1L1L1L .= ','.$l1L1LLl["id"].I142; }}}print $l1L1L11; exit; break; case "view": TlIIlTI($_GET["place"]); $l1L1LLl =TlIIlTl(intval($_GET["place"]), $_GET["curl"], $_GET[I143], $_GET["rs"]); if(!empty($l1L1LLl[I141])) print getSet("banner_script", $l1L1LLl); exit; break; case "click": TlIIlTI($_GET["place"]); $idPlace =intval($_GET[I144]); $I1lL1LI =intval($_GET["cmpg"]); $l1L1L1I =intval($_GET["id"]); $referer =(isset($_GET["referer"]) ?stripslashes($_GET["referer"]) :I124); $l1L11Il =false; $l1L11IL =true; $sql ="select p.click_unique, p.use_statistics from cms_adv_banners b left join cms_adv_campaigns c ON POSITION(CONCAT(';', c.id,';') in b.id_campaign)>0 left join cms_adv_places p ON POSITION(CONCAT(';', p.id,';') in c.ids_places)>0 WHERE b.public=1 and c.public=1 and c.status='active' and p.public=1 and b.id='".$l1L1L1I.I135.$I1lL1LI."' and p.id='".$idPlace."' limit 1"; $res =mysql_query($sql, $lLII1L1); if($resData =mysql_fetch_array($res)){ $l1L11Il =$resData["use_statistics"]; $l1L11IL =$resData["click_unique"]; if(!$l1L11IL || TlIIlT1(2, $idPlace.I136.$I1lL1LI.I136.$l1L1L1I)){ if($l1L11Il){ $dateTime =time(); $l1L1L1l =array(date(I145, $dateTime), date("Y-m-d", $dateTime), date("G", $dateTime)); $sql ="insert DELAYED into cms_adv_stats_tmp set type='click', id_place=".$idPlace.I137.$I1lL1LI.", id_banner=".$l1L1L1I.I146.$l1L1L1l[0]."', date_only='".$l1L1L1l[1]."', hour_only='".$l1L1L1l[2].I138.addslashes($referrer)."', user_ip='".$_SERVER["REMOTE_ADDR"].I147.$l1L11IL.I139; mysql_query($sql, $lLII1L1); }if($I1lL1LI >0){ $sql ="update LOW_PRIORITY cms_adv_campaigns set cur_clicks=cur_clicks+1, cur_cost_click=cur_cost_click+cost_click where id=".$I1lL1LI; mysql_query($sql, $lLII1L1); }}}$sql ="select url from cms_adv_banners where id=".$l1L1L1I." and type=3"; $res =mysql_query($sql, $lLII1L1); if($lIl1LLI =mysql_fetch_array($res, MYSQL_ASSOC)){ $l1L11I1 =$lIl1LLI["url"]; if(!preg_match(I148, $l1L11I1)) $l1L11I1 ="http://".$l1L11I1; echo "<script type=\"text/javascript\">document.location.href='".addslashes($l1L11I1)."'</script>"; }exit; break; case "modview": $referer =(isset($_GET[I149]) ?stripslashes($_GET[I149]) :I124); $procData =array(); $l1L11lI =array(); $l1L11ll =array("cond" => array()); foreach(explode(";", stripslashes($_GET["data"])) as $l1L11lL){ if(preg_match('/^(.*?)=(.*?)$/i', $l1L11lL, $matches)){ if(!empty($matches[1])){ foreach(explode(I150, $matches[2]) as $itemData){ if(!empty($itemData)){ $aData =explode(I142, $itemData); $aData[1] =intval($aData[1]); $aData[2] =intval($aData[2]); $l1L11lI[] =$aData[1]; $procData[$matches[1]][] =array( "itemId" => intval(mb_substr($aData[0], 1)), "bodyType" => $itemData[0] == "D" ?"D" :I151, "placeId" => intval($aData[1]), "ownerId" => intval($aData[2]) );$l1L11ll["cond"][] ="(" .$l1L1LlL[I152] ."='".$aData[2]."' AND POSITION(';".$aData[1].";' in ids_places )>0)"; }}}}}$l1L11lI =array_unique($l1L11lI); $l1L11l1 =TlIIlTI(implode(";", $l1L11lI)); $l1L11LI =array(); if(count($l1L11lI) >0){ $sql =I153.implode(I142, $l1L11lI).I154; $res =mysql_query($sql, $lLII1L1); while($ll1llLI =mysql_fetch_array($res, MYSQL_ASSOC)){ $l1L11LI[$ll1llLI[I155]] =$ll1llLI; }}if(sizeof($l1L11ll["cond"]) >0){ $sql ="select id, ids_places, " .$l1L1LlL[I152] ." from cms_adv_campaigns where (".implode(" OR ", $l1L11ll[I156]).")"; $res =mysql_query($sql, $lLII1L1); while($cData =mysql_fetch_array($res, MYSQL_ASSOC)){ $l1L11Ll =intval(str_replace(";", I124, $cData["ids_places"]))."_".$cData[$l1L1LlL[I152]]; $l1L11ll[$l1L11Ll][I155] =$cData[I155]; }}unset($l1L11ll[I156]); foreach($procData as $modName => $modData){ $l1L11LL =0; if(($l1L11LL =sizeof($modData)) >0 && preg_match('/^[A-Za-z0-9\-\_]+$/i', $modName)){ for($i =0; $i <$l1L11LL; $i++){ if($modData[$i]["itemId"] >0 && $modData[$i]["placeId"] >0){ if(mb_strpos($l1L11LI[$modData[$i]["placeId"]][I157], ";".$modName.I158) !== false && ($modData[$i]["bodyType"] == "D" && mb_strpos($l1L11LI[$modData[$i]["placeId"]]["browse_mode"], I159) !== false || $modData[$i]["bodyType"] == I151 && (mb_strpos($l1L11LI[$modData[$i]["placeId"]]["browse_mode"], ";list;") !== false || mb_strpos($l1L11LI[$modData[$i][I160]]["browse_mode"], ";specblock;") !== false))){ $l1L11L1 =true; if($modData[$i]["bodyType"] == "D" && $l1L11LI[$modData[$i][I160]][I161] || $modData[$i]["bodyType"] == I151 && $l1L11LI[$modData[$i][I160]]["show_unique"]) $l1L11L1 =TlIIlT1(3, $modName.I136.$modData[$i]["bodyType"].I136.$modData[$i]["itemId"]); if($l1L11L1){ if($l1L11LI[$modData[$i][I160]][I162]){ $dateTime =time(); $l1L1L1l =array(date(I145, $dateTime), date("Y-m-d", $dateTime), date("G", $dateTime)); $sql =I163.$modName."', body_type='".$modData[$i]["bodyType"].I164.$modData[$i]["itemId"]."', id_place='".$modData[$i][I160]."', day='".$l1L1L1l[0]."', date_only='".$l1L1L1l[1].I165.$l1L1L1l[2].I138.addslashes($referrer).I139; mysql_query($sql, $lLII1L1); }if(isset($l1L11ll[$modData[$i][I160]."_".$modData[$i]["ownerId"]])) $l1L11ll[$modData[$i][I160]."_".$modData[$i]["ownerId"]][$modData[$i][I166]]["cnt"] ++; }}}}}}foreach($l1L11ll as $null => $l1L11ll){ if($l1L11ll[I155] >0){ if($l1L11ll[I151]["cnt"] >0){ $l1L11ll[I151]["cnt"] =intval($l1L11ll[I151]["cnt"]); $sql ="update LOW_PRIORITY cms_adv_campaigns set cur_views=cur_views+".$l1L11ll[I151]["cnt"].", cur_views_day=cur_views_day+".$l1L11ll[I151]["cnt"].", cur_views_last_day=NOW(), cur_cost_view=cur_cost_view+cost_view*".$l1L11ll[I151][I167]." where id=".intval($l1L11ll[I155]); mysql_query($sql, $lLII1L1); }if($l1L11ll["D"][I167] >0){ $l1L11ll["D"][I167] =intval($l1L11ll["D"][I167]); $sql ="update LOW_PRIORITY cms_adv_campaigns set cur_views=cur_views+".$l1L11ll["D"][I167].", cur_views_day=cur_views_day+".$l1L11ll["D"][I167].", cur_views_last_day=NOW(), cur_cost_view=cur_cost_view+cost_view*".$l1L11ll[I168][I167]." where id=".intval($l1L11ll[I155]); mysql_query($sql, $lLII1L1); }}}exit; break; default: exit; }function TlIIlTT($l1L1LL1, $l1L111I, $IlLllLL, $I1lLILl, $description){ global $lLII1L1; global $l1L1LIl; if($I1lLILl >0 && $IlLllLL >0){ $sql ="SELECT balance, balance_history FROM cms_members WHERE id=".intval($IlLllLL); $res =mysql_query($sql, $lLII1L1); if($lIl1LLI =mysql_fetch_array($res)){ $IlllIII =floatval($lIl1LLI["balance"]); $history =unserialize($lIl1LLI["balance_history"]); $aHistory =(is_array($history))? $history: Array(); $IlllIIL =$IlllIII -$I1lLILl; $key =time(); for($i =0; $i <1000; $i++) if(!isset($aHistory[$key.($i >0 ?I169.$i :I124)])){ $key .= ($i >0 ?I169.$i :I124); break; }$aHistory[$key] =Array("type"=>"auto", "balance"=>$IlllIIL, "currency"=>$l1L1LIl, I170=>getenv("REMOTE_ADDR"), "description" => $description); $sql ="UPDATE LOW_PRIORITY cms_members SET balance='$IlllIIL', balance_history='".addslashes(serialize($aHistory))."' WHERE id='$IlLllLL'"; mysql_query($sql, $lLII1L1); $sql ="INSERT DELAYED into cms_adv_cash SET id_campaign='$l1L1LL1', lang='$l1L111I', id_member='$IlLllLL', price='$I1lLILl', description='".addslashes($description)."', date=NOW()"; mysql_query($sql, $lLII1L1); }}}function TlIIlTI($l1L111l){ global $lLII1L1; global $l1L1LlL; $l1L11l1 =array(); $l1L111L =array(); foreach(explode(I140, $l1L111l) as $placeId){ if(($l1L11II =mb_strpos($placeId, I169)) !== false) $placeId =mb_substr($placeId, 0, $l1L11II); $placeId =intval($placeId); if($placeId >0) $l1L111L[] ="position(';".$placeId.";' IN ids_places)>0"; }if(count($l1L111L) >0){ $l1L1111 =array(); $l11IIII =array(); $IIIlLIl =0; $sql ="SELECT id, lang, name, " .$l1L1LlL[I152] .", start_date, end_date, max_cost_view, max_cost_click, cur_cost_view, cur_cost_click, paid_cost_view, paid_cost_click, cost_view, cost_click FROM cms_adv_campaigns WHERE (".implode(" OR ", $l1L111L).") AND status='active' and public=1 AND ". "((start_date!=end_date AND end_date<NOW()) ". "OR (max_views>0 AND cur_views>max_views) ". "OR (max_clicks>0 AND cur_clicks>max_clicks) ". "OR (max_cost_view>0 AND (cur_cost_view+cost_view)>max_cost_view) ". "OR (max_cost_click>0 AND (cur_cost_click+cost_click)>max_cost_click))"; $res =mysql_query($sql, $lLII1L1); while($lIl1LLI =mysql_fetch_array($res, MYSQL_ASSOC)){ $l11IIIl =false; if($lIl1LLI[$l1L1LlL[I152]] >0 && $lIl1LLI[I171]-$lIl1LLI["paid_cost_view"] >0){ $l11IIIl =true; $num ="?"; if($lIl1LLI["cost_view"] >0) $num =ceil(($lIl1LLI[I171]-$lIl1LLI["paid_cost_view"])/$lIl1LLI[I172]); TlIIlTT($lIl1LLI[I155], $lIl1LLI["lang"], $lIl1LLI[$l1L1LlL[I152]], $lIl1LLI[I171]-$lIl1LLI["paid_cost_view"], "%%hist_balance_campaign_view%% \"".$lIl1LLI["name"].I173.$num.")"); }if($lIl1LLI[$l1L1LlL[I152]] >0 && $lIl1LLI["cur_cost_click"]-$lIl1LLI["paid_cost_click"] >0){ $l11IIIl =true; $num ="?"; if($lIl1LLI[I174] >0) $num =ceil(($lIl1LLI["cur_cost_click"]-$lIl1LLI["paid_cost_click"])/$lIl1LLI[I174]); TlIIlTT($lIl1LLI[I155], $lIl1LLI["lang"], $lIl1LLI[$l1L1LlL[I152]], $lIl1LLI["cur_cost_click"]-$lIl1LLI[I175], "%%hist_balance_campaign_click%% \"".$lIl1LLI["name"].I173.$num.")"); }$l11IIIL =I124; if($lIl1LLI["max_cost_click"]>0 && $lIl1LLI[I176]+$lIl1LLI[I174] >$lIl1LLI["max_cost_click"]) $l11IIIL =", status_comment='%%stat_finished_max_cost_click%%'"; else if($lIl1LLI["max_cost_view"]>0 && $lIl1LLI[I171]+$lIl1LLI[I172] >$lIl1LLI["max_cost_view"]) $l11IIIL =", status_comment='%%stat_finished_max_cost_view%%'"; else if($lIl1LLI["max_clicks"]>0 && $lIl1LLI["cur_clicks"] >$lIl1LLI["max_clicks"]) $l11IIIL =", status_comment='%%stat_finished_max_clicks%%'"; else if($lIl1LLI[I177]>0 && $lIl1LLI["cur_views"] >$lIl1LLI[I177]) $l11IIIL =", status_comment='%%stat_finished_max_views%%'"; else if($lIl1LLI["start_date"]!=$lIl1LLI["end_date"] && $lIl1LLI[I178]<date(I145)) $l11IIIL .= ", status_comment='%%stat_finished_date%%'"; if($l11IIIl) $l11IIIL .= ", paid_cost_view=cur_cost_view, paid_cost_click=cur_cost_click"; $sql ="update LOW_PRIORITY cms_adv_campaigns set status='finished'".$l11IIIL.", paid_last_time=NOW() where id='".$lIl1LLI[I155].I139; mysql_query($sql, $lLII1L1); $IIIlLIl++; $l1L11l1[] =$lIl1LLI[I155]; }if($IIIlLIl <$l1L1LlL["PROCESS_ONE_EXECUTION"]){ $sql ="SELECT id, lang, name, " .$l1L1LlL[I152] .", cur_cost_view, cur_cost_click, paid_cost_view, paid_cost_click, cost_view, cost_click, IF(DATE_ADD(paid_last_time, INTERVAL ".$l1L1LlL["BALANCE_PERIOD_TIME"].")<NOW(), 1, 0) as expired FROM cms_adv_campaigns WHERE (".implode(I179, $l1L111L).") AND status='active' and public=1 AND ". "(cost_view > 0 OR cost_click>0) AND (cur_cost_view>paid_cost_view OR cur_cost_click>paid_cost_click) AND ". "((cur_cost_view>=paid_cost_view+cost_view*".$l1L1LlL["BALANCE_PERIOD_SHOW"].I180. "(cur_cost_click>=paid_cost_click+cost_click*".$l1L1LlL["BALANCE_PERIOD_CLICK"].I180. "DATE_ADD(paid_last_time, INTERVAL ".$l1L1LlL["BALANCE_PERIOD_TIME"].I181; $res =mysql_query($sql, $lLII1L1); while($lIl1LLI =mysql_fetch_array($res, MYSQL_ASSOC)){ $l11IIIl =false; $l11III1 =floatval($lIl1LLI[I171]-$lIl1LLI["paid_cost_view"]); $l11IIlI =floatval($lIl1LLI[I176]-$lIl1LLI[I175]); if($lIl1LLI[$l1L1LlL[I152]] >0 && ($l11III1>=$lIl1LLI[I172]*$l1L1LlL["BALANCE_PERIOD_SHOW"] || $lIl1LLI["expired"] && $l11III1>0)){ $l11IIIl =true; $num ="?"; if($lIl1LLI[I172] >0) $num =ceil($l11III1/$lIl1LLI[I172]); TlIIlTT($lIl1LLI[I155], $lIl1LLI[I182], $lIl1LLI[$l1L1LlL[I152]], $l11III1, "%%hist_balance_campaign_view%% \"".$lIl1LLI["name"].I173.$num.")"); }else $l11III1 =0; if($lIl1LLI[$l1L1LlL[I152]] >0 && ($l11IIlI>=$lIl1LLI[I174]*$l1L1LlL["BALANCE_PERIOD_CLICK"] || $lIl1LLI[I183] && $l11IIlI>0)){ $l11IIIl =true; $num ="?"; if($lIl1LLI[I174] >0) $num =ceil($l11IIlI/$lIl1LLI[I174]); TlIIlTT($lIl1LLI[I155], $lIl1LLI[I182], $lIl1LLI[$l1L1LlL[I152]], $l11IIlI, "%%hist_balance_campaign_click%%: \"".$lIl1LLI["name"].I173.$num.")"); }else $l11IIlI =0; if($l11IIIl){ $sql ="update LOW_PRIORITY cms_adv_campaigns set paid_cost_view=paid_cost_view+'".$l11III1."', paid_cost_click=paid_cost_click+".$l11IIlI.", paid_last_time=NOW() where id='".$lIl1LLI[I155].I139; mysql_query($sql, $lLII1L1); $IIIlLIl++; }if($IIIlLIl >= $l1L1LlL["PROCESS_ONE_EXECUTION"]) break; }}}return $l1L11l1; }function TlIIlTl($idPlace, $l11IIll, $l11IIlL, $l11IIl1){ global $lLII1L1; $l11IILI =false; $sql ="select p.show_default, p.place_type, p.place_width, p.place_height, p.is_topline, p.source_type, p.chain, c.id as cmpg_id, c.priority ". "from cms_adv_places p left join cms_adv_campaigns c ON POSITION(CONCAT(';',p.id,';') IN c.ids_places)>0 ". "where p.public=1 and (p.is_used=1 and p.source_type='banner' OR p.source_type='modbanner') and c.id>0 and c.public=1 and c.status='active' ". "and (c.start_date!='0000-00-00 00:00:00' and c.start_date=c.end_date OR c.start_date<=NOW() and c.end_date>=NOW()) ". "and (c.max_views=0 OR c.cur_views<c.max_views) ". "and (c.max_clicks=0 OR c.cur_clicks<c.max_clicks) ". "and (c.max_views_day=0 OR (c.cur_views_day<c.max_views_day and c.cur_views_last_day=NOW() OR c.cur_views_last_day!=NOW())) ". "and p.id=".$idPlace; $res =mysql_query($sql, $lLII1L1); $l11IILl =array(); $l11IILL =array(); $l11IIL1 =array(); while($lIl1LLI =mysql_fetch_array($res, MYSQL_ASSOC)){ $l11IILl[] =$lIl1LLI["cmpg_id"]; if(!isset($l11IILL["type"])){ $l11IILL["type"] =$lIl1LLI[I184]; $l11IILL["width"] =$lIl1LLI["place_width"]; $l11IILL["height"] =$lIl1LLI["place_height"]; $l11IILL[I185] =$lIl1LLI[I185]; $l11IILL["source_type"] =$lIl1LLI["source_type"]; $l11IILL["show_default"] =$lIl1LLI["show_default"]; $l11IILL[I186] =$l11IILL["chain"] =$lIl1LLI["chain"]; foreach(explode(I158, $lIl1LLI["chain"]) as $l11II1I){ $l11II1I =intval($l11II1I); if($l11II1I >0){ if(isset($l11IIL1[$l11II1I])) $l11IIL1[$l11II1I] += 1; else $l11IIL1[$l11II1I] =1; }}}}if(count($l11IILl) == 0){ $sql ="select p.show_default, p.place_type, p.place_width, p.place_height, p.is_topline, p.source_type, p.chain ". "from cms_adv_places p left join cms_adv_banners b ON POSITION(CONCAT(';',p.id,';') IN b.def_places)>0 ". "where p.public=1 and (p.is_used=1 and p.source_type='banner' OR p.source_type='modbanner') and b.id>0 and b.public=1 and b.status=2 and b.is_default=1 ". "and p.id=".$idPlace; $res =mysql_query($sql, $lLII1L1) or die(mysql_error()); if($lIl1LLI =mysql_fetch_array($res, MYSQL_ASSOC)){ $l11IILI =true; $l11IILL["type"] =$lIl1LLI[I184]; $l11IILL["width"] =$lIl1LLI[I187]; $l11IILL["height"] =$lIl1LLI["place_height"]; $l11IILL[I185] =$lIl1LLI[I185]; $l11IILL["source_type"] =$lIl1LLI["source_type"]; $l11IILL[I188] =$lIl1LLI[I188]; $l11IILL[I186] =$l11IILL["chain"] =$lIl1LLI["chain"]; foreach(explode(I158, $lIl1LLI["chain"]) as $l11II1I){ $l11II1I =intval($l11II1I); if($l11II1I >0){ if(isset($l11IIL1[$l11II1I])) $l11IIL1[$l11II1I] += 1; else $l11IIL1[$l11II1I] =1; }}}}if(count($l11IILl) == 0 && !$l11IILI) return array(); $l1L1LLl =array(); $l11II1l =array(); $l11II1L =array(); if(!$l11IILI){ $II11LII =($l11IILL["type"] == 1 ?I189 :"b.file, b.width, b.height").($l11IILL["type"] == 0 ?", b.content" :I124); $sql ="select b.id, b.type, c.id as id_campaign, ".$II11LII.", b.url, b.shown, b.targeting_compiled, c.priority+1 as priority ". "from cms_adv_banners b left join cms_adv_campaigns c ON POSITION(CONCAT(';',c.id,';') IN b.id_campaign)>0 ". "where b.public=1 and b.status=2 and b.is_default!=1 ". ($l11IILL["type"] == 0 ?"and (b.type!=1 ". ($l11IILL[I190] >0 ?"and b.width=".$l11IILL[I190]." " :I124). ($l11IILL["height"] >0 ?"and b.height=".$l11IILL[I191]." " :I124). " OR b.type=1) " :"and b.type=".intval($l11IILL["type"]).I192). (($l11IILL["type"] != 1 && $l11IILL["type"] != 0) ?($l11IILL[I190] >0 ?"and b.width=".$l11IILL[I190].I192 :I124). ($l11IILL[I191] >0 ?"and b.height=".$l11IILL[I191].I192 :I124) :I124). I193.implode(",", $l11IILl).") ". "group by b.id ". "order by RAND()"; $res =mysql_query($sql, $lLII1L1); while($lIl1LLI =mysql_fetch_array($res, MYSQL_ASSOC)){ $l11II11 =&$lIl1LLI[I194]; if(!empty($l11II11) && $l11II11 != "true"){ $l11II11 =str_replace('$this->', '', $l11II11); $tmpRes =true; @eval("\$tmpRes=(".$l11II11.I195); if(!$tmpRes) continue; }$l11II1L[] =$lIl1LLI; if(!isset($l11IIL1[$lIl1LLI[I155]]) || $l11IIL1[$lIl1LLI[I155]] <$lIl1LLI["priority"]){ $l11II1l[] =$lIl1LLI; }}}if(count($l11II1L) >0 && count($l11II1l) == 0){ $l11IILL["chain"] =I124; $l11II1l =&$l11II1L; }foreach($l11II1l as $lIl1LLI){ if(mb_strpos($l11IIlL, ",".$lIl1LLI[I155].",") === false){ $l1L1LLl =$lIl1LLI; if($l1L1LLl[I196] != 1) unset($l1L1LLl[I141]); $l1L1LLl["id_place"] =$idPlace; if(!preg_match(I148, $l1L1LLl["url"])) $l1L1LLl["url"] ="http://".$l1L1LLl[I197]; list($usec, $sec) =explode(' ', microtime()); mt_srand((float)$sec +((float)$usec*100000)); $l1L1LLl["click_url"] =$l11IIll."aproc.php?action=click&place=".$idPlace."&cmpg=".$l1L1LLl[I198]."&id=".$l1L1LLl[I155]."&referer=".rawurlencode($referer)."&rs=".time().mt_rand(1, 100000); $l1L1LLl["click_url_encoded"] =rawurlencode($l1L1LLl[I199]); $l1L1LLl[I199] =addslashes($l1L1LLl[I199]); }}$l11IlII =false; if($l11IILL[I188] == 1 && count($l1L1LLl) == 0){ $II11LII =($l11IILL[I196] == 1 ?I189 :"b.file, b.width, b.height").($l11IILL[I196] == 0 ?", b.content" :I124); $sql ="select 0 as id_campaign, b.id, b.type, ".$II11LII.", b.url, b.shown, b.targeting_compiled ". "from cms_adv_banners b ". "where b.public=1 and b.status=2 ". "and b.is_default=1 and POSITION(';".$idPlace.";' IN b.def_places)>0 ". ($l11IILL[I196] == 0 ?"and (b.type!=1 ". ($l11IILL[I190] >0 ?I200.$l11IILL[I190].I192 :I124). ($l11IILL[I191] >0 ?"and b.height=".$l11IILL[I191].I192 :I124). " OR b.type=1) " :"and b.type=".intval($l11IILL[I196]).I192). (($l11IILL[I196] != 1 && $l11IILL[I196] != 0) ?($l11IILL[I190] >0 ?I200.$l11IILL[I190].I192 :I124). ($l11IILL[I191] >0 ?"and b.height=".$l11IILL[I191].I192 :I124) :I124). I201; $res =mysql_query($sql, $lLII1L1); $l11II1L =array(); $l11II1l =array(); while($lIl1LLI =mysql_fetch_array($res, MYSQL_ASSOC)){ $l11II1L[] =$lIl1LLI; if(!isset($l11IIL1[$lIl1LLI[I155]])) $l11II1l[] =$lIl1LLI; }if(count($l11II1L) >0 && count($l11II1l) == 0){ $l11IILL["chain"] =I124; $l11II1l =&$l11II1L; }else $l11IILL["chain"] =$l11IILL[I186]; foreach($l11II1l as $lIl1LLI){ if(mb_strpos($l11IIlL, ",".$lIl1LLI[I155].",") === false){ $l11II11 =&$lIl1LLI[I194]; if(!empty($l11II11) && $l11II11 != I202){ $l11II11 =str_replace('$this->', '', $l11II11); $tmpRes =true; @eval("\$tmpRes=(".$l11II11.I195); if(!$tmpRes) continue; }$l1L1LLl =$lIl1LLI; if($l1L1LLl[I196] != 1) unset($l1L1LLl[I141]); $l1L1LLl["id_place"] =$idPlace; if(!preg_match(I148, $l1L1LLl[I197])) $l1L1LLl[I197] =I203.$l1L1LLl[I197]; list($usec, $sec) =explode(' ', microtime()); mt_srand((float)$sec +((float)$usec*100000)); $l1L1LLl[I199] =$l11IIll."aproc.php?action=click&place=".$idPlace."&cmpg=".$l1L1LLl[I198]."&id=".$l1L1LLl[I155].I204.rawurlencode($referer)."&rs=".time().mt_rand(1, 100000); $l1L1LLl["click_url_encoded"] =rawurlencode($l1L1LLl[I199]); $l1L1LLl[I199] =addslashes($l1L1LLl[I199]); $l11IlII =true; }}}if(count($l1L1LLl) >0){ $l11IILL["chain"] .= (empty($l11IILL["chain"]) ?I158 :I124).$l1L1LLl[I155].I158; $sql ="update LOW_PRIORITY cms_adv_places set chain='".$l11IILL["chain"]."' where id=".$idPlace; mysql_query($sql, $lLII1L1); if(!$l11IlII){ $sql ="update LOW_PRIORITY cms_adv_campaigns set cur_views=cur_views+1, cur_views_day=cur_views_day+1, cur_views_last_day=NOW(), cur_cost_view=cur_cost_view+cost_view where id=".intval($l1L1LLl[I198]); mysql_query($sql, $lLII1L1); }$sql ="update LOW_PRIORITY cms_adv_banners set shown=shown+1 where id=".intval($l1L1LLl[I155]); mysql_query($sql, $lLII1L1); $l1L11Il =false; $sql ="select show_unique, use_statistics from cms_adv_places where id='".$idPlace.I139; $res =mysql_query($sql, $lLII1L1); if($resData =mysql_fetch_array($res)){ $l1L11IL =$resData["show_unique"]; $l1L11Il =$resData["use_statistics"]; }if($l1L11Il && (!$l1L11IL || TlIIlT1(1, $idPlace.I136.intval($l1L1LLl[I198]).I136.intval($l1L1LLl[I155])))){ $dateTime =time(); $l1L1L1l =array(date(I145, $dateTime), date("Y-m-d", $dateTime), date("G", $dateTime)); $sql ="insert DELAYED into cms_adv_stats_tmp set type='view', id_place=".$idPlace.I137.intval($l1L1LLl[I198]).", id_banner=".intval($l1L1LLl[I155]).I146.$l1L1L1l[0]."', date_only='".$l1L1L1l[1].I165.$l1L1L1l[2].I138.addslashes($referer)."', user_ip='".$_SERVER["REMOTE_ADDR"].I205.$l1L11IL.I139; mysql_query($sql, $lLII1L1); }$l1L1LLl["img"] =$l11IIll.$l1L1LLl["file"]; if(isset($l1L1LLl[I141])){ $arr =unserialize($l1L1LLl[I141]); $l1L1LLl[I141] =I124; for($i =0; $i <count($arr); $i++){ if(!empty($arr[$i])){ $IIlLLLL =array_merge($l1L1LLl, array(I141 => stripslashes($arr[$i]))); $l1L1LLl[I141] .= getSet("banner_text_".$i, $IIlLLLL); }}}switch($l1L1LLl[I196]){ case 1: $l1L1LLl[I141] =getSet($l11IILL["source_type"].I206, $l1L1LLl); break; case 2: $l1L1LLl[I141] =getSet($l11IILL["source_type"].($l11IILL[I185] ?"_topline" :I124)."_img", $l1L1LLl); break; case 3: $l1L1LLl[I141] =getSet($l11IILL["source_type"].($l11IILL[I185] ?I207 :I124)."_flash", $l1L1LLl); break; default: $l1L1LLl[I141] =I124; }$l1L1LLl[I141] =preg_replace('/^[\r\n\t ]*(.*?)[\r\n\t ]*$/s', '\1', $l1L1LLl[I141]); $l1L1LLl[I141] =str_replace(array("\\", I208, "\n", '"'), array("\\\\", I124, "\\n", I209), $l1L1LLl[I141]); return $l1L1LLl; }else return array(); return array(); }function cmplValWeek($cond, $data){ if(!is_array($data)) return true; $res =($data[date("w")] == "1"); return ($cond == "==" ?$res :!$res); }function cmplValTime($cond, $data){ if(!is_array($data)) return true; $res =in_array(date("G"), $data); return ($cond == I210 ?$res :!$res); }function cmplValDate($cond, $data){ $res =true; @eval('$res = ("'.date("Y-m-d").'" '.$cond.' "'.$data.I211); return $res; }function cmplValRefr($cond, $data){ global $referer; if(empty($data)) $res =empty($referer); else $res =(stristr($referer, $data) !== false); return ($cond == I210 ?$res :!$res); }$l11IlIl =null; function TlIIlT1($l11IlIL, $l11IlI1){ global $lLII1L1; global $l11IlIl; $l11IllI =$_SERVER["REMOTE_ADDR"]; if(is_null($l11IlIl)){ $l11IlIl =array(); if(!empty($l11IllI)) $l11IlIl[] ="user_ip='".$l11IllI.I139; $sql ="delete from cms_adv_sess where date<DATE_ADD(NOW(), INTERVAL -1 hour)"; mysql_query($sql, $lLII1L1); }if(count($l11IlIl) >0) $sql ="select count(*) as count from cms_adv_sess where (".implode(I179, $l11IlIl).I212; else $sql ="select count(*) as count from cms_adv_sess where user_ip=''"; $l11IlIL =intval($l11IlIL); if($l11IlIL >0) $sql .= " AND adv_type=".$l11IlIL; if(!empty($l11IlI1)) $sql .= " AND adv_param='".addslashes($l11IlI1).I139; $res =mysql_query($sql, $lLII1L1); $data =mysql_fetch_array($res); $res =($data["count"] <= 0); if($res) $sql ="insert DELAYED into cms_adv_sess set adv_type='".$l11IlIL."', adv_param='".addslashes($l11IlI1)."', user_ip='".$l11IllI."', date=NOW()"; mysql_query($sql, $lLII1L1); return $res; }