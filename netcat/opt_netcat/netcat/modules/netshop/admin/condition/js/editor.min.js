function nc_netshop_condition_editor(f){this.init(f)}
(function(f){function u(a){return"and"===a.type||"or"===a.type}var h=nc_netshop_condition_editor,d=h.prototype,c=nc_netshop_condition_messages,z=h.adminFilesPath=NETCAT_PATH+"admin/",n=h.filesPath=NETCAT_PATH+"modules/netshop/admin/condition/",k=h.dataPath=n+"data/";h.dataCache={};h.urls={SelectComponentList:k+"json/component_list.php",ObjectName:k+"json/object_name.php",SelectSubdivisionList:k+"json/subdivision_list.php?site_id=%siteId%",SelectItemPropertyList:k+"json/component_field_list.php",SelectFromClassifierList:k+
"json/classifier_values.php",UserName:k+"json/user_name.php",SelectUserGroupList:k+"json/user_group_list.php",SelectUserPropertyList:k+"json/user_field_list.php",SelectOrderStatusList:k+"json/order_status_list.php",SelectOrderPropertyList:k+"json/order_field_list.php?site_id=%siteId%",SelectDeliveryMethodList:k+"json/order_delivery_method_list.php?site_id=%siteId%",SelectPaymentMethodList:k+"json/order_payment_method_list.php?site_id=%siteId%"};h.loadingInProgress={};d.siteId=null;d.root=null;d.inputField=
null;d.isInitializing=!1;d.defaultChosenParams={disable_search_threshold:10,no_results_text:c.SEARCH_NO_RESULTS};d.conditionGroupsToShow=[];d.conditionGroupsToExclude=[];d.conditionsToExclude=[];d.itemProperties={};d.userProperties={};d.orderProperties={};var l=h.opEqNe={name:"op",type:"SimpleSelect",values:{eq:c.EQUALS,ne:c.NOT_EQUALS}},A=h.opContains={name:"op",type:"SimpleSelect",values:{contains:c.CONTAINS,notcontains:c.NOT_CONTAINS}},v=h.opString={name:"op",type:"SimpleSelect",values:{eq:c.EQUALS,
ne:c.NOT_EQUALS,contains:c.CONTAINS,notcontains:c.NOT_CONTAINS,begins:c.BEGINS_WITH}},g=h.opNumber={name:"op",type:"SimpleSelect",values:{ge:c.GREATER_OR_EQUALS,gt:c.GREATER_THAN,le:c.LESS_OR_EQUALS,lt:c.LESS_THAN,eq:c.EQUALS,ne:c.NOT_EQUALS}},w=h.opDateTime=g,k=h.opAll=f.extend({},v);f.extend(k.values,g.values);var q=h.makeSubdivisionField=function(a){return{name:a||"value",type:"SelectFromJson",source:h.urls.SelectSubdivisionList,placeholder:c.SELECT_SUBDIVISION}},t=h.makeComponentField=function(a){return{name:a||
"value",type:"SelectFromJson",source:h.urls.SelectComponentList,placeholder:c.SELECT_COMPONENT}};d.conditionTypes={item_component:{group:"GROUP_GOODS",label:"TYPE_COMPONENT",params:[c.TYPE_COMPONENT,l,t("value")]},item_sub:{group:"GROUP_GOODS",label:"TYPE_SUBDIVISION",params:[c.TYPE_SUBDIVISION,l,q("value")]},item_parentsub:{group:"GROUP_GOODS",label:"TYPE_SUBDIVISION_DESCENDANTS",params:[c.TYPE_SUBDIVISION_DESCENDANTS,l,q("value")]},item:{group:"GROUP_GOODS",label:"TYPE_ITEM",params:[c.TYPE_ITEM,
l,{name:"value",type:"SelectItem"}]},item_property:{group:"GROUP_GOODS",label:"TYPE_ITEM_FIELD",params:[c.TYPE_ITEM_FIELD,{name:"field",type:"SelectItemProperty"},{type:"ItemPropertyOptions"}]},user_group:{group:"GROUP_USER",label:"TYPE_USER_GROUP",params:[c.TYPE_USER_GROUP,l,{name:"value",type:"SelectFromJson",source:h.urls.SelectUserGroupList,placeholder:c.SELECT_USER_GROUP}]},user:{group:"GROUP_USER",label:"TYPE_USER",params:[c.TYPE_USER,l,{name:"value",type:"SelectUser"}]},user_created:{group:"GROUP_USER",
label:"TYPE_USER_CREATED",params:[c.TYPE_USER_CREATED,w,{name:"value",type:"DateTimeInput"}]},user_property:{group:"GROUP_USER",label:"TYPE_USER_FIELD",params:[c.TYPE_USER_FIELD,{name:"field",type:"SelectUserProperty"},{type:"UserPropertyOptions"}]},cart_totalprice:{group:"GROUP_CART",label:"TYPE_CART_SUM_WITH_ITEM_DISCOUNTS",params:[c.TYPE_CART_SUM_WITH_ITEM_DISCOUNTS,g,{name:"value",type:"Input",inputType:"number"}]},cart_sum:{group:"GROUP_CART",label:"TYPE_CART_SUM",params:[c.TYPE_CART_SUM,g,{name:"value",
type:"Input",inputType:"number"}]},cart_count:{group:"GROUP_CART",label:"TYPE_CART_POSITION_COUNT",params:[c.CART_POSITION_COUNT,g,{name:"value",type:"Input",inputType:"number"}]},cart_itemcomponent:{group:"GROUP_CART",label:"TYPE_CART_ITEM_COMPONENT",params:[c.CART_CONTAINS,g,{name:"qty",type:"Input",inputType:"number",value:1},c.CART_PIECES_OF_COMPONENT,t("component")]},cart_itemsub:{group:"GROUP_CART",label:"TYPE_CART_ITEM_SUBDIVISION",params:[c.CART_CONTAINS,g,{name:"qty",type:"Input",inputType:"number",
value:1},c.CART_PIECES_OF_ITEMS_FROM_SUBDIVISION,q("subdivision")]},cart_itemparentsub:{group:"GROUP_CART",label:"TYPE_CART_ITEM_SUBDIVISION_DESCENDANTS",params:[c.CART_CONTAINS,g,{name:"qty",type:"Input",inputType:"number",value:1},c.CART_PIECES_OF_ITEMS_FROM_SUBDIVISION_DESCENDANTS,q("subdivision")]},cart_item:{group:"GROUP_CART",label:"TYPE_CART_ITEM_COUNT",params:[c.CART_CONTAINS,g,{name:"qty",type:"Input",inputType:"number",value:1},c.CART_PIECES_OF,{name:"item",type:"SelectItem"}]},cart_itemproperty:{group:"GROUP_CART",
label:"TYPE_CART_ITEM_FIELD",params:[c.CART_CONTAINS,f.extend({},g,{name:"qty_op"}),{name:"qty",type:"Input",inputType:"number",value:1},c.CART_ITEM_FIELD,{name:"field",type:"SelectItemProperty"},{type:"ItemPropertyOptions"}]},cart_propertysum:{group:"GROUP_CART",label:"TYPE_CART_FIELD_SUM",params:[c.CART_FIELD_SUM,{name:"field",type:"SelectItemProperty"},g,{name:"value",type:"Input",inputType:"number"}]},cart_propertymin:{group:"GROUP_CART",label:"TYPE_CART_FIELD_MIN",params:[c.CART_FIELD_MIN,{name:"field",
type:"SelectItemProperty"},g,{name:"value",type:"Input",inputType:"number"}]},cart_propertymax:{group:"GROUP_CART",label:"TYPE_CART_FIELD_MAX",params:[c.CART_FIELD_MAX,{name:"field",type:"SelectItemProperty"},g,{name:"value",type:"Input",inputType:"number"}]},order_status:{group:"GROUP_ORDER",label:"TYPE_ORDER_STATUS",params:[c.TYPE_ORDER_STATUS,l,{name:"value",type:"SelectFromJson",source:h.urls.SelectOrderStatusList,placeholder:c.SELECT_ORDER_STATUS}]},order_property:{group:"GROUP_ORDER",label:"TYPE_ORDER_FIELD",
params:[c.TYPE_ORDER_FIELD,{name:"field",type:"SelectOrderProperty"},{type:"OrderPropertyOptions"}]},order_deliverymethod:{group:"GROUP_ORDER",label:"TYPE_ORDER_DELIVERY_METHOD",params:[c.TYPE_ORDER_DELIVERY_METHOD,l,{name:"value",type:"SelectFromJson",source:h.urls.SelectDeliveryMethodList,placeholder:c.SELECT_DELIVERY_METHOD}]},order_paymentmethod:{group:"GROUP_ORDER",label:"TYPE_ORDER_PAYMENT_METHOD",params:[c.TYPE_ORDER_PAYMENT_METHOD,l,{name:"value",type:"SelectFromJson",source:h.urls.SelectPaymentMethodList,
placeholder:c.SELECT_PAYMENT_METHOD}]},orders_sum:{group:"GROUP_ORDERS",label:"TYPE_ORDER_SUM_ALL_TIME",params:[c.TYPE_ORDER_SUM_ALL_TIME,g,{name:"value",type:"Input",inputType:"number"}]},orders_sumperiod:{group:"GROUP_ORDERS",label:"TYPE_ORDER_SUM_PERIOD",params:[c.ORDER_SUM_FOR_LAST,{name:"period_value",type:"Input",inputType:"number"},{name:"period_type",type:"SimpleSelect",values:{day:c.LAST_X_DAYS,week:c.LAST_X_WEEKS,month:c.LAST_X_MONTHS,year:c.LAST_X_YEARS}},g,{name:"value",type:"Input",inputType:"number"}]},
orders_sumdates:{group:"GROUP_ORDERS",label:"TYPE_ORDER_SUM_DATES",params:[c.ORDER_SUM_DATE_FROM,{name:"date_from",type:"DateTimeInput"},c.ORDER_SUM_DATE_TO,{name:"date_to",type:"DateTimeInput"},g,{name:"value",type:"Input",inputType:"number"}]},orders_count:{group:"GROUP_ORDERS",label:"TYPE_ORDER_COUNT",params:[c.TYPE_ORDER_COUNT,g,{name:"value",type:"Input",inputType:"number"}]},orders_component:{group:"GROUP_ORDERS",label:"TYPE_ORDERS_CONTAIN_COMPONENT",params:[c.TYPE_ORDERS_CONTAIN_COMPONENT,
t("value")]},orders_item:{group:"GROUP_ORDERS",label:"TYPE_ORDERS_CONTAIN_ITEM",params:[c.TYPE_ORDERS_CONTAIN_ITEM,{name:"value",type:"SelectItem"}]},datetime_dateinterval:{group:"GROUP_DATETIME",label:"TYPE_DATE_INTERVAL",params:[c.DATE_FROM,{name:"date_from",type:"DateTimeInput"},c.DATE_TO,{name:"date_to",type:"DateTimeInput"}]},datetime_dayofweek:{group:"GROUP_DATETIME",label:"TYPE_DAY_OF_WEEK",params:[c.DAY_OF_WEEK,l,{name:"value",type:"SimpleSelect",values:{1:c.MONDAY,2:c.TUESDAY,3:c.WEDNESDAY,
4:c.THURSDAY,5:c.FRIDAY,6:c.SATURDAY,7:c.SUNDAY}}]},datetime_timeinterval:{group:"GROUP_DATETIME",label:"TYPE_TIME_INTERVAL",params:[c.TIME_FROM,{name:"time_from",type:"Input",inputType:"time"},c.TIME_TO,{name:"time_to",type:"Input",inputType:"time"}]},valueof_cookie:{group:"GROUP_VALUEOF",label:"TYPE_COOKIE_VALUE",params:["$_COOKIE[&quot;",{name:"key",type:"Input"},"&quot;]",k,{name:"value",type:"Input"}]},valueof_session:{group:"GROUP_VALUEOF",label:"TYPE_SESSION_VALUE",params:["$_SESSION[&quot;",
{name:"key",type:"Input"},"&quot;]",k,{name:"value",type:"Input"}]},extension_function:{group:"GROUP_EXTENSION",label:"TYPE_USER_FUNCTION",params:[c.FUNCTION_CALL,{name:"function",type:"Input"},c.FUNCTION_RETURNS_TRUE]}};var x=function(a){if(!a.getBoundingClientRect)return f(a).offset();var b=document.body,e=document.documentElement,c=window.pageYOffset||e.scrollTop||b.scrollTop,b=e.clientTop||b.clientTop||0;return Math.round(a.getBoundingClientRect().top+c-b)},B=function(a){return(a.closest(".condition").data("initialValues")||
{})[a.attr("name")]},y=function(a,b){var e=b.chosen;setTimeout(function(){var a=e.dropdown,a=x(a[0])+a.outerHeight(),b=f("body, html"),c=b.scrollTop()+f(window).height(),c=a-c;0<c&&(c=Math.min(b.scrollTop()+c,x(e.container[0])),b.animate({scrollTop:c},400),b.css("height",a+"px"))},100)};d.init=function(a){this.loadStylesIn(window);this.siteId=a.site_id;this.root=$nc(a.container).addClass("nc-netshop-condition-editor");this.inputField=$nc("<input type='hidden' name='"+a.input_name+"'/>").appendTo(this.root);
var b=a.conditions;b&&!$nc.isEmptyObject(b)&&this.inputField.val(JSON.stringify(b));this.conditionGroupsToShow=a.groups_to_show||[];this.conditionGroupsToExclude=a.groups_to_exclude||[];this.conditionsToExclude=a.conditions_to_exclude||[];this.load(b);$nc(window).resize($nc.proxy(this,"updateAllConditionLabelPositions"))};d.load=function(a){this.isInitializing=!0;var b=a||{};"string"==typeof a&&(b=JSON&&JSON.parse?JSON.parse(a):eval("("+a+")"));this.root.find(".condition-group").first().remove();
this.addGroup(this.root,b);this.isInitializing=!1;var e=this;f(window).load(function(){e.updateAllConditionLabelPositions();e.root.addClass("enable-transitions")})};d.save=function(){var a=this.root.children(".condition-group"),b=(a=this.getGroupData(a))?JSON.stringify(a):"";this.inputField.val(b);return a};d.onFormSubmit=function(){return this.checkConditions()?(this.save(),!0):!1};d.getGroupData=function(a){var b={type:a.find(".operator-cell select").val(),conditions:[]};a=a.find(".condition-cell").first().children(".condition, .condition-group");
var e=this;if(0==a.length)return null;a.each(function(){var a=f(this);(a=a.hasClass("condition-group")?e.getGroupData(a):e.getConditionData(a))&&b.conditions.push(a)});return b};d.getConditionData=function(a){var b=a.data("initialValues"),e=!1;a.find(".condition-param-value").not(".condition-param-value-initializing").each(function(){var a=f(this),c=a.val();if(""==c||null==c)return console&&console.warn("Condition parameter %s has no value, the condition is ignored (type=%s)",this.name,b.type),e=
!0,!1;a.hasClass("condition-param-value-date")&&a.datepicker&&(c=a.datepicker("getISODate")||c);b[this.name]=c;return!0});b.type=a.data("conditionType");return e?null:b};d.checkConditions=function(){var a=!0;this.root.find(".condition-param-value").not(".condition-param-value-initializing").each(function(){var b=f(this),e=b.val();if(""==e||null==e)return a=!1,e=b.closest(".condition").find(".condition-string").first().text(),alert(c.VALUE_REQUIRED.replace("%s",e)),b.is("select")?b.data("chosen").selected_item.focus():
b.is("input:hidden")?b.siblings("a.condition-param-popup").focus():b.focus(),!1});return a};d.loadStylesIn=function(a){0==a.$nc("#nc_condition_editor_stylesheet").length&&a.$nc("head").append('<link rel="stylesheet" id="nc_condition_editor_stylesheet" type="text/css" href="'+n+'css/editor.css"><link rel="stylesheet" id="nc_condition_editor_stylesheet" type="text/css" href="'+z+'js/datepicker/datepicker.css">')};d.addGroup=function(a,b){var e=this,m=f("<div class='condition-group'><div class='condition-group-container'><div class='operator-cell'><div class='operator-label nc-label nc--blue'>"+
c.AND+"</div><select class='operator-type'><option value='and'>"+c.AND_DESCRIPTION+"</option><option value='or'>"+c.OR_DESCRIPTION+"</option></select><a class='nc-icon-s nc--remove remove-group-button'></a></div><div class='condition-cell'></div><div class='buttons-cell'><a class='add-condition-button'>"+c.ADD+"</a></div></div></div>"),d=m.find(".condition-cell"),p=m.find("select");m.find(".add-condition-button").click(function(){e.showAddConditionDialog(d)});m.find(".remove-group-button").click(function(){e.removeGroup(m)}).attr("title",
c.REMOVE_GROUP);m.find(".operator-type").change(function(){e.updateConditionLabelText(f(this))});m.find(".operator-label").click(function(){e.changeOperator(f(this))});var h=a.parents(".condition-group"),g=!h.length;g&&m.addClass("root");h.length%2&&m.find(".condition-group-container").addClass("even-level");a.append(m);p.chosen(this.defaultChosenParams);if(f.isEmptyObject(b))g&&m.find(".operator-cell").hide();else{p.val(b.type).change().trigger("chosen:updated");for(var p=0,k=b.conditions.length;p<
k;p++){var r=b.conditions[p];u(r)?this.addGroup(d,r):this.addCondition(r.type,d,r)}g&&1===k&&!u(b.conditions[0])&&m.find(".operator-cell").hide()}this.updateOperatorLabelPosition(h.first())};d.showAddConditionDialog=function(a){var b=["<option></option>","<option value='addGroup' class='create-group-option'>"+c.ADD_GROUP+"</option>"],e=null,m;for(m in this.conditionTypes){var d=this.conditionTypes[m],h=this.conditionGroupsToShow;h.length&&-1==f.inArray(d.group,h)||-1!=f.inArray(d.group,this.conditionGroupsToExclude)||
-1!=f.inArray(m,this.conditionsToExclude)||(e!=d.group&&(null!=e&&b.push("</optgroup>"),b.push('<optgroup label="'+c[d.group]+'">'),e=d.group),b.push('<option value="'+m+'">'+c[d.label]+"</option>"))}b.push("</optgroup>");var g=f('<select data-placeholder="'+c.SELECT_CONDITION_TYPE+'">'+b.join("")+"</select>"),k=f('<div class="add-condition-type-select"></div>').append(g).appendTo(a),l=this;g.chosen(this.defaultChosenParams).on("chosen:hiding_dropdown",function(){var a=g.val(),b=g.closest(".condition-cell");
g.parents(".add-condition-type-select").remove();"addGroup"==a?l.addGroup(b,null):a&&l.addCondition(a,b,{})}).on("chosen:showing_dropdown",y);setTimeout(function(){k.find(".chosen-container").trigger("mousedown")},1)};d.updateAllConditionLabelPositions=function(){var a=this;this.root.find(".condition-group").each(function(){a.updateOperatorLabelPosition(f(this))})};d.updateOperatorLabelPosition=function(a){if(!this.isInitializing){var b=a.find(".condition-cell").first().children(".condition, .condition-group"),
e=a.find(".operator-cell").first(),c=e.find(".operator-label");if(1<b.length)if(a.is(".root")&&!e.is(":visible"))e.slideDown(400,f.proxy(this,"updateAllConditionLabelPositions")).show();else{a=c.hasClass("visible");var e=b.first(),d=e.position().top,b=b.last(),h=b.position().top,g=d+27+.5*(h-d-c.height());e.is(".condition-group")&&(g+=12);b.is(".condition-group")&&(g+=12);g=Math.min(d+f(window).height()-100,Math.round(g))+"px";c.addClass("visible");a?setTimeout(function(){c.css("top",g)},1):c.css("top",
g)}else c.removeClass("visible"),a.is(".root")&&e.is(":visible")&&e.slideUp(400,f.proxy(this,"updateAllConditionLabelPositions"))}};d.updateConditionLabelText=function(a){a.closest(".operator-cell").find(".operator-label").html(c[a.val().toUpperCase()])};d.changeOperator=function(a){a=a.closest(".operator-cell").find(".operator-type");a.val("and"==a.val()?"or":"and").change().trigger("chosen:updated")};d.addCondition=function(a,b,e){var d=this.conditionTypes[a];a=f("<div />",{"class":"condition condition-"+
a,data:{conditionType:a,initialValues:e}}).appendTo(b);var h=this;this.addFields(a,d.params,e);f("<a class='nc-icon-s nc--remove remove-condition-button'></a>").click(function(){h.removeCondition(f(this).closest(".condition"))}).attr("title",c.REMOVE_CONDITION).appendTo(a);this.updateOperatorLabelPosition(b.closest(".condition-group"));this.isInitializing||a.find("input, select").not(":hidden").first().focus()};d.addFields=function(a,b,e){for(var c=this,d=e&&!f.isEmptyObject(e),g=0,k=b.length;g<k;g++){var l=
b[g];if("string"==typeof l)a.append("<span class='condition-string'>"+l+"</span>");else{var n="append"+l.type+"Field";void 0===this[n]?console&&console.warn("Incorrect field type '%s': no %s method",l.type,n):this[n](a,l,d?e[l.name]:l.value).wrap(f("<span/>",{"class":"condition-param"}))}}a.find("select").chosen(this.defaultChosenParams).on("chosen:showing_dropdown",y).each(function(){var a=f(this);if(a.data("loadData")){var b=a.data("fieldParams")||{},e=f.proxy(c,"on"+b.type+"ListReady"),b=c.makeFullUrl(b.source||
h.urls[b.type+"List"],b.requestParams);c.loadData(b,e,a.data("callbackParams"))}});a.find("input.condition-param-value-date").datepicker()};d.removeGroup=function(a){var b=0<a.find(".condition").length,e=a.hasClass("root")?c.REMOVE_ALL_CONFIRMATION:c.REMOVE_GROUP_CONFIRMATION;if(!b||confirm(e))a.remove(),this.root.find(".condition-group").length?this.updateAllConditionLabelPositions():this.addGroup(this.root,null)};d.removeCondition=function(a){var b=!1;a.find(".condition-param-value").not(".condition-param-value-initializing").each(function(){var a=
f(this).val();if(""==a||null==a)return b=!0,!1});var e=[];a.find(".condition-string, .condition-param-value:not([type=hidden]), .essence-caption").each(function(){var a=f(this);a.is(".condition-string, .essence-caption")?e.push(a.text()):a.is("select")?e.push("["+f.trim(a.find("option:selected").text())+"]"):e.push(a.val())});if(b||confirm(c.REMOVE_CONDITION_CONFIRMATION.replace("%s",e.join(" "))))a.remove(),this.updateAllConditionLabelPositions()};d.appendSimpleSelectField=function(a,b,e){var c=
['<select name="'+b.name+'">'],d;for(d in b.values)c.push('<option value="'+d+'">'+b.values[d]+"</option>");c.push("</select>");b=f(c.join("")).addClass("condition-param-value");(e||0===e)&&b.val(e);return b.appendTo(a)};d.appendSelectItemField=function(a,b,e){var c=f("<span />"),d=f("<input />",{type:"hidden",name:b.name,value:e,"class":"condition-param-value"}).data("fieldParams",b).appendTo(c),g=f("<a/>",{href:"#","class":"condition-param-popup"}).appendTo(c),h=this;g.click(function(a){h.showItemSelectionDialog(d,
g);a.preventDefault()});this.loadComponentName(e,g);return c.appendTo(a)};d.createListSelectField=function(a,b,e){return f("<select />",{name:a.name,"class":"condition-param-value condition-param-value-initializing condition-param-"+a.type}).data({loadData:!0,fieldParams:a}).attr("data-placeholder",e)};d.appendSelectItemPropertyField=function(a,b,e){return this.createListSelectField(b,e,c.SELECT_ITEM_FIELD).appendTo(a)};d.appendSelectFromClassifierField=function(a,b,e){var d=b.requestParams.classifier;
return this.createListSelectField(b,e,c.SELECT_VALUE).data("callbackParams",{classifier:d}).addClass("condition-param-SelectFromClassifier-"+d).appendTo(a)};d.appendItemPropertyOptionsField=function(a,b,e){return f("<span class='condition-itemproperty-variable-part' />").appendTo(a)};d.appendInputField=function(a,b,e){return f("<input />",{type:b.inputType||"text",name:b.name,value:e,autocomplete:"off","class":"condition-param-value"+(b["class"]?" "+b["class"]:"")}).appendTo(a)};d.appendDateTimeInputField=
function(a,b,e){return f("<input />",{type:"text",name:b.name,value:e,"class":"condition-param-value condition-param-value-date"}).appendTo(a)};d.appendSelectUserField=function(a,b,e){var c=f("<span />"),d=f("<input />",{type:"hidden",name:b.name,value:e,"class":"condition-param-value"}).appendTo(c),g=f("<a/>",{href:"#","class":"condition-param-popup"}).appendTo(c),h=this;g.click(function(a){h.showUserSelectionDialog(d,g);a.preventDefault()});this.loadUserName(e,g);return c.appendTo(a)};d.appendSelectUserPropertyField=
function(a,b,e){return this.createListSelectField(b,e,c.SELECT_USER_PROPERTY).appendTo(a)};d.appendUserPropertyOptionsField=function(a,b,c){return f("<span class='condition-userproperty-variable-part' />").appendTo(a)};d.appendSelectOrderPropertyField=function(a,b,e){return this.createListSelectField(b,e,c.SELECT_ORDER_PROPERTY).appendTo(a)};d.getSelectFromJsonClass=function(a){for(var b=0,c=0,d=a.length;c<d;c++)b=(b<<5)-b+a.charCodeAt(c),b&=b;b=b.toString(36).replace("-","N");return"condition-param-SelectFromJson-"+
b};d.appendSelectFromJsonField=function(a,b,c){var d=this.makeFullUrl(b.source,b.requestParams);return this.createListSelectField(b,c,b.placeholder).addClass(this.getSelectFromJsonClass(d)).appendTo(a)};d.appendOrderPropertyOptionsField=function(a,b,c){return f("<span class='condition-orderproperty-variable-part' />").appendTo(a)};d.showItemSelectionDialog=function(a,b){nc.load_dialog(n+"dialogs/select_item_dialog.php?site_id="+this.siteId).set_options({condition_dialog_target_input:a,condition_dialog_target_caption:b})};
d.showUserSelectionDialog=function(a,b){nc.load_dialog(n+"dialogs/select_user_dialog.php?site_id="+this.siteId).set_options({condition_dialog_target_input:a,condition_dialog_target_caption:b})};d.loadData=function(a,b,c){b||(b=f.noop);h.loadingInProgress[a]||("undefined"==typeof h.dataCache[a]?(h.loadingInProgress[a]=!0,f.getJSON(a,function(d){h.dataCache[a]=d;b(d,a,c);h.loadingInProgress[a]=!1})):b(h.dataCache[a],a,c))};d.makeFullUrl=function(a,b){var c=a;b&&(c+=(0<=c.indexOf("?")?"&":"?")+f.param(b));
return c.replace("%siteId%",this.siteId)};d.fillSelectsWithOptions=function(a,b){var c=this.root.find(a);if(0<c.length){var d=["<option></option>"];if(f.isArray(b))for(var g=0,h=b.length;g<h;g++)d.push('<option value="'+b[g].key+'">'+b[g].value+"</option>");c.append(d.join(""));this.reinitializeChosenSelects(c)}};d.reinitializeChosenSelects=function(a){a.each(function(){var a=f(this),c=a.data("chosen");a.data("hadFocus",c?c.container.hasClass("chosen-container-active"):a.is(":focus"));a.val(B(a)).removeClass("condition-param-value-initializing")}).chosen("destroy").chosen(this.defaultChosenParams).each(function(){var a=
f(this);a.data("hadFocus")&&a.data("chosen").selected_item.focus();a.removeData("hadFocus")})};d.onSelectFromClassifierListReady=function(a,b,c){this.fillSelectsWithOptions("select.condition-param-SelectFromClassifier-"+c.classifier+":empty",a)};d.onSelectItemPropertyListReady=function(a,b,c){this.itemProperties=a;b=["<option></option>"];for(var d in a){b.push('<optgroup label="'+d+'">');c=0;for(var g=a[d].length;c<g;c++){var h=a[d][c];b.push("<option value='"+h.id+"'>"+h.description+"</option>")}b.push("</optgroup>")}a=
this.root.find("select.condition-param-SelectItemProperty:empty");a.append(b.join("")).change(f.proxy(this,"onItemPropertySelect"));this.reinitializeChosenSelects(a);a.trigger("change")};d.generatePropertyFieldConfiguration=function(a){var b=[];switch(a.type){case "string":case "text":b.push(v,{name:"value",type:"Input"});break;case "integer":b.push(g,{name:"value",type:"Input",inputType:"number"});break;case "float":b.push(g,{name:"value",type:"Input"});break;case "select":case "multiselect":b.push("multiselect"==
a.type?A:l,{name:"value",type:"SelectFromClassifier",requestParams:{classifier:a.classifier}});break;case "boolean":b.push('<input type="hidden" name="op" value="eq" class="condition-param-value">'+c.EQUALS,{name:"value",type:"SimpleSelect",values:{1:c.TRUE,0:c.FALSE}});break;case "datetime":b.push(w,{name:"value",type:"DateTimeInput"})}return b};d.onItemPropertySelect=function(a){var b=f(a.target);if(a=this.getItemPropertyData(b.val())){var c=b.closest(".condition"),b=c.find(".condition-itemproperty-variable-part"),
c=c.data("initialValues");a=this.generatePropertyFieldConfiguration(a);b.html("");this.addFields(b,a,c)}};d.getItemPropertyData=function(a){var b=this.itemProperties,c;for(c in b)for(var d=0,f=b[c].length;d<f;d++){var g=b[c][d];if(g.id==a)return g}return null};d.onSelectFromJsonListReady=function(a,b,c){b=this.getSelectFromJsonClass(b);this.fillSelectsWithOptions("select."+b+":empty",a)};d.onSelectUserPropertyListReady=function(a,b,c){this.userProperties=a;b=["<option></option>"];for(var d in a)b.push("<option value='"+
d+"'>"+a[d].description+"</option>");a=this.root.find("select.condition-param-SelectUserProperty:empty");a.append(b.join("")).change(f.proxy(this,"onUserPropertySelect"));this.reinitializeChosenSelects(a);a.trigger("change")};d.onUserPropertySelect=function(a){var b=f(a.target);if(a=this.userProperties[b.val()]){var c=b.closest(".condition"),b=c.find(".condition-userproperty-variable-part"),c=c.data("initialValues");a=this.generatePropertyFieldConfiguration(a);b.html("");this.addFields(b,a,c)}};d.onSelectOrderPropertyListReady=
function(a,b,c){this.orderProperties=a;b=["<option></option>"];for(var d in a)b.push("<option value='"+d+"'>"+a[d].description+"</option>");a=this.root.find("select.condition-param-SelectOrderProperty:empty");a.append(b.join("")).change(f.proxy(this,"onOrderPropertySelect"));this.reinitializeChosenSelects(a);a.trigger("change")};d.onOrderPropertySelect=function(a){var b=f(a.target);if(a=this.orderProperties[b.val()]){var c=b.closest(".condition"),b=c.find(".condition-orderproperty-variable-part"),
c=c.data("initialValues");a=this.generatePropertyFieldConfiguration(a);b.html("");this.addFields(b,a,c)}};d.loadComponentName=function(a,b){/^\d+:\d+$/.test(a)?f.getJSON(h.urls.ObjectName,{object:a},function(a){var d=c.NONEXISTENT_ITEM;a&&a.Message_ID&&(d="<span class='essence-id'>"+a.Message_ID+"</span>. <span class='essence-caption'>"+(a.FullName||c.ITEM_WITHOUT_NAME)+"</span>");b.html(d)}):b.html("<span class='not-selected'>"+c.SELECT_ITEM+"</span>")};d.loadUserName=function(a,b){/^\d+$/.test(a)?
f.getJSON(h.urls.UserName,{user_id:a},function(a){var d=c.NONEXISTENT_USER;a&&a.User_ID&&(d="<span class='essence-id'>"+a.User_ID+"</span>. <span class='essence-caption'>"+a.Name+"</span>");b.html(d)}):b.html("<span class='not-selected'>"+c.SELECT_USER+"</span>")}})($nc);
